

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pipeline with Conda &mdash; Pipeline 
 (2026.0.0.0) 2026.0.0.0+511-gef6c047d8e documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="_static/custom_theme.css?v=872f755e" />

  
    <link rel="shortcut icon" href="_static/favicon-16x16.png"/>
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5c5df773"></script>
      <script src="_static/doctools.js?v=fd6eb6e6"></script>
      <script src="_static/sphinx_highlight.js?v=6ffebe34"></script>
      <script src="_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="_static/copybutton.js?v=0729d509"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Pipeline testing" href="develdocmd/pipeline_tests.html" />
    <link rel="prev" title="Building the pipeline" href="develdocmd/building_the_pipeline.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="index.html" class="icon icon-home">
            Pipeline 
 (2026.0.0.0)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="interface.html">Interface Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeline.html">Roadmap &amp; Branching Strategy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pipeline with Conda</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#setup-step-by-step">Setup - step-by-step</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-pipeline">Run Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#serial">Serial</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parallel">Parallel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#useful-shorthand">Useful shorthand</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/context.html">Pipeline Context and Domain Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Pipeline 
 (2026.0.0.0)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Pipeline with Conda</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/modular.rst" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pipeline-with-conda">
<h1>Pipeline with Conda<a class="headerlink" href="#pipeline-with-conda" title="Link to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Running and developing the pipeline from a Conda environment is not officially supported or validated for observatory operation, and the information provided here is for demonstration purposes only.</p>
</div>
<nav class="contents local" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#setup-step-by-step" id="id1">Setup - step-by-step</a></p></li>
<li><p><a class="reference internal" href="#run-pipeline" id="id2">Run Pipeline</a></p>
<ul>
<li><p><a class="reference internal" href="#serial" id="id3">Serial</a></p></li>
<li><p><a class="reference internal" href="#parallel" id="id4">Parallel</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#useful-shorthand" id="id5">Useful shorthand</a></p></li>
</ul>
</nav>
<section id="setup-step-by-step">
<h2><a class="toc-backref" href="#id1" role="doc-backlink">Setup - step-by-step</a><a class="headerlink" href="#setup-step-by-step" title="Link to this heading"></a></h2>
<ul>
<li><p>Install <a class="reference external" href="https://github.com/conda-forge/miniforge">Miniforge</a> or <a class="reference external" href="https://micromamba.readthedocs.io/en/latest/">Micromamba</a>: below we use <a class="reference external" href="https://github.com/conda-forge/miniforge/releases">miniforge3</a> installer as examples, which only includes the <a class="reference external" href="https://conda-forge.org">conda-forge</a> channel by default.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1"># 1. Detect OS and Architecture</span>
<span class="nv">OS</span><span class="o">=</span><span class="k">$(</span>uname<span class="w"> </span>-s<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span><span class="s1">&#39;s/Darwin/MacOSX/&#39;</span><span class="k">)</span>
<span class="nv">ARCH</span><span class="o">=</span><span class="k">$(</span>uname<span class="w"> </span>-m<span class="k">)</span>

<span class="c1"># 2. Construct the download URL</span>
<span class="nv">URL</span><span class="o">=</span><span class="s2">&quot;https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-</span><span class="si">${</span><span class="nv">OS</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">.sh&quot;</span>

<span class="c1"># 3. Download the installer</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Downloading Miniforge for </span><span class="si">${</span><span class="nv">OS</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">...&quot;</span>
curl<span class="w"> </span>-L<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$URL</span><span class="s2">&quot;</span><span class="w"> </span>-o<span class="w"> </span>miniforge.sh

<span class="c1"># 4. Run the installer (adjust the installation path as needed)</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Installing to /opt/miniforge3...&quot;</span>
bash<span class="w"> </span>miniforge.sh<span class="w"> </span>-b<span class="w"> </span>-f<span class="w"> </span>-p<span class="w"> </span>/opt/miniforge3

<span class="c1"># 5. Update and Cleanup</span>
conda<span class="w"> </span>update<span class="w"> </span>--all
conda<span class="w"> </span>clean<span class="w"> </span>-a<span class="w"> </span>-y
rm<span class="w"> </span>miniforge.sh
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Installation complete.&quot;</span>
</pre></div>
</div>
</li>
<li><p>Reproduce a Python environment with modular <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> components and the dependency libraries required by them and Pipeline, e.g., <a class="reference external" href="https://www.open-mpi.org">openmpi</a>.</p>
<ul>
<li><p>Fetch source code:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://open-bitbucket.nrao.edu/scm/pipe/pipeline.git
<span class="nb">cd</span><span class="w"> </span>pipeline
</pre></div>
</div>
</li>
<li><p>Recreate the Conda environment with all <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> components for <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> execution and development:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PIP_VERBOSE</span><span class="o">=</span><span class="m">3</span><span class="w"> </span>conda<span class="w"> </span>env<span class="w"> </span>update<span class="w"> </span>--name<span class="w"> </span>pipeline<span class="w"> </span>--file<span class="o">=</span>environment.yml<span class="w"> </span>-vv
</pre></div>
</div>
<p>or just simply run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>update
</pre></div>
</div>
<p>This will create or update a Conda environment named 'pipeline'.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Occasionally, you might also update, clean up, or remove a pre-existing environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>update<span class="w"> </span>--name<span class="w"> </span>pipeline<span class="w"> </span>--file<span class="o">=</span>environment.yml<span class="w"> </span><span class="c1"># Update an existing environment</span>
conda<span class="w"> </span>env<span class="w"> </span>update<span class="w"> </span>--name<span class="w"> </span>pipeline<span class="w"> </span>--file<span class="o">=</span>environment.yml<span class="w"> </span>--prune<span class="w"> </span><span class="c1"># Remove packages not in the environment file</span>
conda<span class="w"> </span>env<span class="w"> </span>remove<span class="w"> </span>--name<span class="w"> </span>pipeline<span class="w"> </span><span class="c1"># Remove the entire environment</span>
</pre></div>
</div>
</div>
</li>
</ul>
</li>
<li><p>Activate the environment and verify the <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> software stack installation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>pipeline
<span class="c1"># Create the default CASA data directory if it doesn&#39;t exist (can be customized later)</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>~/.casa/data
<span class="c1"># Verify casatools installation/functionality; CASA data could be fetched from internet if not present locally by casaconfig</span>
<span class="c1"># Also see: https://casadocs.readthedocs.io/en/stable/api/casaconfig.html</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import casatools; print(&#39;casatools version:&#39;, casatools.version_string())&quot;</span>
</pre></div>
</div>
</li>
<li><p>Install <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>.
</pre></div>
</div>
<p>To install <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> along with optional dependencies for developmental and experimental purposes in editable mode, try:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="o">[</span>dev,docs<span class="o">]</span>
</pre></div>
</div>
<p>Our <cite>ReadtheDocs</cite> setup of <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> uses this approach for documentation builds (see <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/.readthedocs.yaml">.readthedocs.yaml</a>)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/environment.yml">environment.yml</a>, <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/pyproject.toml">pyproject.toml</a>, and <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/requirements.txt">requirements.txt</a></p>
<ul class="simple">
<li><p>The scope of <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/environment.yml">environment.yml</a> (Conda environment definition) is to create a monolithic-<a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a>-like self-contained Python environment with all <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> components and dependencies required by <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> installed.</p></li>
<li><p><a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/pyproject.toml">pyproject.toml</a> handles <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> packaging and build system requirements.</p></li>
<li><p>A separate <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/requirements.txt">requirements.txt</a> (which is referenced in both <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/environment.yml">environment.yml</a> and <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/browse/pyproject.toml">pyproject.toml</a>) handles <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> core/functional dependencies. The separation is intentional for balancing different needs / use cases, e.g. monolithic and modular <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> builds, developer/testing installation setups, etc.</p></li>
</ul>
</div>
</li>
</ul>
</section>
<section id="run-pipeline">
<h2>Run <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a><a class="headerlink" href="#run-pipeline" title="Link to this heading"></a></h2>
<p>Typical use patterns of <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> include running within a headless environment, or on a workstation interactively, either in CASA serial or parallel mode:</p>
<p>For an interactive use case, one could simply run this to start a <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a> session:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>pipeline
python<span class="w"> </span>-m<span class="w"> </span>casashell
</pre></div>
</div>
<p>For headless sessions to execute automated <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a> data processing:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>pipeline
xvfb-run<span class="w"> </span>-a<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>casashell<span class="w"> </span>--nologger<span class="w"> </span>--log2term<span class="w"> </span>--agg<span class="w"> </span>-c<span class="w"> </span>run_pipeline.py
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">run_pipeline.py</span></code> is a Python script. Example content could be:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline.recipereducer</span><span class="o">,</span><span class="w"> </span><span class="nn">os</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">recipereducer</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;../rawdata/uid___A002_Xc46ab2_X15ae_repSPW_spw16_17_small.ms&#39;</span><span class="p">],</span>
                              <span class="n">procedure</span><span class="o">=</span><span class="s1">&#39;procedure_hifa_calimage.xml&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or alternatively:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline</span>
<span class="n">pipeline</span><span class="o">.</span><span class="n">initcli</span><span class="p">()</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">h_init</span><span class="p">()</span>
<span class="n">context</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s1">&#39;ProjectStructure&#39;</span><span class="p">,</span> <span class="s1">&#39;recipe_name&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_calimage&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">hifa_importdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid___A002_Xc46ab2_X15ae_repSPW_spw16_17_small.ms&#39;</span><span class="p">],</span> <span class="n">session</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span> <span class="n">dbservice</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hifa_flagdata</span><span class="p">()</span>
    <span class="n">hifa_fluxcalflag</span><span class="p">()</span>
    <span class="n">hif_rawflagchans</span><span class="p">()</span>
    <span class="n">hif_refant</span><span class="p">()</span>
    <span class="n">h_tsyscal</span><span class="p">()</span>
    <span class="n">hifa_tsysflag</span><span class="p">()</span>
    <span class="n">hifa_tsysflagcontamination</span><span class="p">()</span>
    <span class="n">hifa_antpos</span><span class="p">()</span>
    <span class="n">hifa_wvrgcalflag</span><span class="p">()</span>
    <span class="n">hif_lowgainflag</span><span class="p">()</span>
    <span class="n">hif_setmodels</span><span class="p">()</span>
    <span class="n">hifa_bandpassflag</span><span class="p">()</span>
    <span class="n">hifa_bandpass</span><span class="p">()</span>
    <span class="n">hifa_spwphaseup</span><span class="p">()</span>
    <span class="n">hifa_gfluxscaleflag</span><span class="p">()</span>
    <span class="n">hifa_gfluxscale</span><span class="p">()</span>
    <span class="n">hifa_timegaincal</span><span class="p">()</span>
    <span class="n">hifa_renorm</span><span class="p">(</span><span class="n">createcaltable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">atm_auto_exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hifa_targetflag</span><span class="p">()</span>
    <span class="n">hif_applycal</span><span class="p">()</span>
    <span class="n">hif_makeimlist</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;PHASE,BANDPASS,AMPLITUDE&#39;</span><span class="p">)</span>
    <span class="n">hif_makeimages</span><span class="p">()</span>
    <span class="n">hif_makeimlist</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="n">per_eb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hif_makeimages</span><span class="p">()</span>
    <span class="n">hifa_imageprecheck</span><span class="p">()</span>
    <span class="n">hif_checkproductsize</span><span class="p">(</span><span class="n">maxcubesize</span><span class="o">=</span><span class="mf">40.0</span><span class="p">,</span> <span class="n">maxcubelimit</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span> <span class="n">maxproductsize</span><span class="o">=</span><span class="mf">500.0</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">h_save</span><span class="p">()</span>
</pre></div>
</div>
<p>Below are some examples of more detailed managed ways to run the <a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE">Pipeline</a>.</p>
<section id="serial">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Serial</a><a class="headerlink" href="#serial" title="Link to this heading"></a></h3>
<ul>
<li><p>A plain Python session without invoking <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONNOUSERSITE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">4</span><span class="w"> </span>xvfb-run<span class="w"> </span>-a<span class="w"> </span>python<span class="w"> </span>../scripts/run_pipeline.py
</pre></div>
</div>
<p>Here we isolate the user site-packages by setting the <code class="docutils literal notranslate"><span class="pre">PYTHONNOUSERSITE</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">1</span></code> to avoid potential package conflicts.
We also set <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS</span></code> and <code class="docutils literal notranslate"><span class="pre">OPENBLAS_NUM_THREADS</span></code> to control the number of threads used by OpenMP/OpenBlas-enabled libraries
(e.g., <code class="docutils literal notranslate"><span class="pre">numpy</span></code>, <code class="docutils literal notranslate"><span class="pre">scipy</span></code>, <code class="docutils literal notranslate"><span class="pre">casatools</span></code>, etc.) during the Pipeline processing.</p>
</li>
<li><p>A session via <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a>, with <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> logging and plotting enabled:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONNOUSERSITE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">4</span><span class="w"> </span><span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">4</span><span class="w"> </span>xvfb-run<span class="w"> </span>-a<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python<span class="w"> </span>-m<span class="w"> </span>casashell<span class="w"> </span>--nologger<span class="w"> </span>--log2term<span class="w"> </span>--agg<span class="w"> </span>-c<span class="w"> </span>../scripts/run_pipeline.py
</pre></div>
</div>
</li>
</ul>
</section>
<section id="parallel">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Parallel</a><a class="headerlink" href="#parallel" title="Link to this heading"></a></h3>
<ul>
<li><p>A standard Python session with <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a> invoked:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONNOUSERSITE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OPENBLAS_NUM_THREADS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>mpirun<span class="w"> </span>--mca<span class="w"> </span>btl_vader_single_copy_mechanism<span class="w"> </span>none<span class="w"> </span>-x<span class="w"> </span>OMP_NUM_THREADS<span class="w"> </span>-x<span class="w"> </span>OPENBLAS_NUM_THREADS<span class="w"> </span>-x<span class="w"> </span>PRTE_MCA_quiet<span class="w"> </span>-np<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import casampi.private.start_mpi; exec(open(&#39;run_pipeline.py&#39;).read())&quot;</span>
</pre></div>
</div>
<div class="admonition-casampi-private-start-mpi admonition">
<p class="admonition-title"><cite>casampi.private.start_mpi</cite></p>
<p>As discussed/examined in <a class="reference external" href="https://open-jira.nrao.edu/browse/CAS-14037">CAS-14037</a>, <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a> include some configuration-dependent
(modular vs. monolithic) environment initialization to help <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/notebooks/parallel-processing.html#Advanced:-Interface-Framework">casampi</a> set up the client and server roles for different openmpi processes
while avoid circular imports during the <cite>casampi</cite> process initialization. Without <cite>casashell</cite> involvement, you need to execute <cite>casampi.private.start_mpi</cite>
outside the scope of <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casatasks.html">casatasks</a> (<a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a> implicitly import <cite>casatasks</cite> in monolithic casa distributions). As a workaround, include the
following boilerplate command at the beginning of your workflow script.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">casampi.private.start_mpi</span>  <span class="c1"># assign the client and server roles</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">casatasks</span>                  <span class="c1"># ensure the time-based logfile name</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">RuntimeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">error</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div></blockquote>
<p>Alternatively, as the above example shows, prepend them into a one-liner command with the <code class="docutils literal notranslate"><span class="pre">-c</span></code> option of the <code class="docutils literal notranslate"><span class="pre">python</span></code> executable.
If you run a parallel CASA session without going through <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a> (e.g., <code class="docutils literal notranslate"><span class="pre">`mpirun</span> <span class="pre">-n</span> <span class="pre">4</span> <span class="pre">python</span> <span class="pre">run_script.py`</span></code>), place the code snippet above at the beginning of your Python script before any <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casatasks.html">casatasks</a> import actions to avoid deadlocks.</p>
<p>The consequence of not doing so is that all openmpi processes will be initialized in the same way and instructed to execute the content of your script concurrently, without the expected <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">x</span> <span class="pre">mpiclient</span> <span class="pre">+</span> <span class="pre">(nproc-1)</span> <span class="pre">x</span> <span class="pre">mpiserver</span></code> configuration.</p>
</div>
</li>
<li><p>A session via <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a>, with <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/">CASA6</a> logging and plotting enabled:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">PYTHONNOUSERSITE</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>xvfb-run<span class="w"> </span>-a<span class="w"> </span><span class="se">\</span>
mpirun<span class="w"> </span>-display-allocation<span class="w"> </span>-display-map<span class="w"> </span>-oversubscribe<span class="w"> </span>--mca<span class="w"> </span>btl_vader_single_copy_mechanism<span class="w"> </span>none<span class="w"> </span>-x<span class="w"> </span>OMP_NUM_THREADS<span class="w"> </span>-n<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">        </span>python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import casampi.private.start_mpi; import casashell.__main__&quot;</span><span class="w"> </span>--nologger<span class="w"> </span>--log2term<span class="w"> </span>--agg<span class="w"> </span>-c<span class="w"> </span>../scripts/run_pipeline.py
</pre></div>
</div>
<p>If you run a parallel CASA session with <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casashell.html">casashell</a>, you need to add the code snippet inside <code class="docutils literal notranslate"><span class="pre">~/.casa/config.py</span></code>. Failure to do so will result in a deadlock the first time <cite>casatasks</cite> is imported. Note that we use <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-c</span> <span class="pre">&quot;import</span> <span class="pre">casampi.private.start_mpi;</span> <span class="pre">import</span> <span class="pre">casashell.__main__&quot;</span></code> instead of <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">-m</span> <span class="pre">casashell</span></code> so that <cite>start_mpi</cite> runs before <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casatasks.html">casatasks</a> is imported.
the first time <a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/casatasks.html">casatasks</a> is imported in a MPI server process, it will attempt to start a new MPI environment, leading to a deadlock situation.</p>
</li>
</ul>
<div class="admonition-running-a-parallel-casa-session-from-macos admonition">
<p class="admonition-title">Running a parallel CASA session from macOS</p>
<ul>
<li><p>A parallel Pipeline data processing session might hang on macOS at the completion of the job due to lingering <cite>casaplotms.app</cite> sub-processes.
This behavior appears to be different from Linux, potentially caused by the fact that each <code class="docutils literal notranslate"><span class="pre">casaplotms</span></code> process spawned from a MPIserver process runs as a macOS &quot;app&quot;.
Although this doesn’t affect the data processing, to ensure a clean exit, one might need to use the following snippet at the end of your Python job script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">close_plotms_on_mpiservers</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">casampi.MPIEnvironment</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPIEnvironment</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">casampi.MPICommandClient</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPICommandClient</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">MPICommandClient</span><span class="p">()</span>
        <span class="n">mpi_server_list</span> <span class="o">=</span> <span class="n">MPIEnvironment</span><span class="o">.</span><span class="n">mpi_server_rank_list</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">push_command_request</span><span class="p">(</span><span class="s1">&#39;from casaplotms import plotmstool&#39;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">target_server</span><span class="o">=</span><span class="n">mpi_server_list</span><span class="p">)</span>
        <span class="n">rs_list</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">push_command_request</span><span class="p">(</span><span class="s1">&#39;plotmstool.__proc!=None&#39;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">target_server</span><span class="o">=</span><span class="n">mpi_server_list</span><span class="p">)</span>
        <span class="n">servers_with_active_plotms</span> <span class="o">=</span> <span class="p">[</span><span class="n">rs</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rs</span> <span class="ow">in</span> <span class="n">rs_list</span> <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">servers_with_active_plotms</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;servers with active plotms instances: </span><span class="si">{</span><span class="n">servers_with_active_plotms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">client</span><span class="o">.</span><span class="n">push_command_request</span><span class="p">(</span><span class="s1">&#39;plotmstool.__proc.kill()&#39;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">target_server</span><span class="o">=</span><span class="n">servers_with_active_plotms</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="n">close_plotms_on_mpiservers</span><span class="p">()</span>
</pre></div>
</div>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">xvfb-run</span></code> is not available on macOS, even if xvfb/X11 is installed; therefore, you may not be able to use it for headless sessions.
Additionally, to complete a Pipeline processing session requiring <code class="docutils literal notranslate"><span class="pre">casaplotms</span></code>, one must log in remotely with GUI access. The <code class="docutils literal notranslate"><span class="pre">casaplotms</span></code> GUI will appear in the desktop environment but cannot be forwarded via X11.</p>
</li>
</ul>
</div>
</section>
</section>
<section id="useful-shorthand">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">Useful shorthand</a><a class="headerlink" href="#useful-shorthand" title="Link to this heading"></a></h2>
<p>Useful aliases/shortcuts to emulate monolithic CASA executables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>pipeline

<span class="nb">export</span><span class="w"> </span><span class="nv">casa_omp_num_threads</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">casa_mpi_nproc</span><span class="o">=</span><span class="m">4</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">TMPDIR</span><span class="o">=</span>/tmp

<span class="nb">export</span><span class="w"> </span><span class="nv">casa6_opts_custom</span><span class="o">=</span><span class="s1">&#39;--nologger --log2term --agg&#39;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">mpirun_custom</span><span class="o">=</span><span class="s1">&#39;mpirun -display-allocation -display-map -oversubscribe --mca btl_vader_single_copy_mechanism none --mca btl ^openib -x OMP_NUM_THREADS -x PYTHONNOUSERSITE&#39;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">xvfb_run_auto</span><span class="o">=</span><span class="s1">&#39;xvfb-run -a&#39;</span><span class="w"> </span><span class="c1"># Debian, Ubuntu, RedHat8, etc.</span>

<span class="nb">alias</span><span class="w"> </span><span class="nv">casa6</span><span class="o">=</span><span class="s1">&#39;PYTHONNOUSERSITE=1 OMP_NUM_THREADS=${casa_omp_num_threads} python -m casashell&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">casa6mpi</span><span class="o">=</span><span class="s1">&#39;PYTHONNOUSERSITE=1 OMP_NUM_THREADS=1 ${mpirun_custom} -n ${casa_mpi_nproc} python -c &quot;import casampi.private.start_mpi; import casashell.__main__&quot;&#39;</span>

<span class="c1"># For Linux only, not applicable on macOS</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">casa6_xvfb</span><span class="o">=</span><span class="s1">&#39;PYTHONNOUSERSITE=1 OMP_NUM_THREADS=${casa_omp_num_threads} ${xvfb_run_auto} python -m casashell&#39;</span>
<span class="nb">alias</span><span class="w"> </span><span class="nv">casa6mpi_xvfb</span><span class="o">=</span><span class="s1">&#39;PYTHONNOUSERSITE=1 OMP_NUM_THREADS=1 ${xvfb_run_auto} ${mpirun_custom} -n ${casa_mpi_nproc} python -c &quot;import casampi.private.start_mpi; import casashell.__main__&quot;&#39;</span>
</pre></div>
</div>
<p>For executing a headless parallel Pipeline processing session on Linux, one could try:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>casa6mpi_xvfb<span class="w"> </span><span class="si">${</span><span class="nv">casa6_opts_custom</span><span class="si">}</span><span class="w"> </span>-c<span class="w"> </span>../scripts/run_pltest.py
</pre></div>
</div>
<p>If you prefer running with an 8-core mpicasa session (1 client + 7 servers), you could do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">casa_mpi_nproc</span><span class="o">=</span><span class="m">8</span><span class="w"> </span>casa6mpi_xvfb<span class="w"> </span><span class="si">${</span><span class="nv">casa6_opts_custom</span><span class="si">}</span><span class="w"> </span>-c<span class="w"> </span>../scripts/run_pltest.py
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="develdocmd/building_the_pipeline.html" class="btn btn-neutral float-left" title="Building the pipeline" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="develdocmd/pipeline_tests.html" class="btn btn-neutral float-right" title="Pipeline testing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2026, Pipeline Dev. Team, build: 2026.0.0.0+511-gef6c047d8e.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>