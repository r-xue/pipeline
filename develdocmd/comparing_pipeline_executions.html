

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Comparing pipeline executions &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/custom_theme.css?v=678032d9" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Building the pipeline" href="building_the_pipeline.html" />
    <link rel="prev" title="Ways to run the Pipeline" href="ways_to_run_the_pipeline.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Comparing pipeline executions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ordered-pipeline-execution-logs">Ordered pipeline execution logs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#log-all-casa-task-calls">Log all CASA task calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-all-casa-tool-calls">Log all CASA tool calls</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#restricting-log-output">Restricting log output</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Comparing pipeline executions</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/develdocmd/comparing_pipeline_executions.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="comparing-pipeline-executions">
<h1>Comparing pipeline executions<a class="headerlink" href="#comparing-pipeline-executions" title="Link to this heading"></a></h1>
<p>When refactoring pipeline code, it is common to want to restructure and
modify the code but leave the overall behaviour unchanged. The pipeline does
not have automated unit tests or regression tests, so it falls to the
developer to manually verify that the pipeline behaviour has not changed.</p>
<p>There are three general ways to compare pipeline executions and determine
whether pipeline behaviour has changed:</p>
<ol class="simple">
<li><p>Check whether the same CASA tasks are called in the same sequence and with
the same arguments;</p></li>
<li><p>In addition to the above, check whether the same sequence of CASA tool
commands is invoked;</p></li>
<li><p>Check whether the output data are identical (within limits).</p></li>
</ol>
<p>This note describes ways the pipeline can assist in scenarios #1 and #2. The
comparison of output caltables and images is considered out of scope for this
document.</p>
<section id="ordered-pipeline-execution-logs">
<h2>Ordered pipeline execution logs<a class="headerlink" href="#ordered-pipeline-execution-logs" title="Link to this heading"></a></h2>
<p>In short, to compare two pipeline runs, it is simplest to diff the log files
for each run. However, the standard CASA command log (casa_commands.log) is of
limited use due to the number of false positives raised with diff; there are
several unordered task arguments (spw, flag commands, output directories,
etc.) which can vary from run to run but actually result in identical data on
disk.</p>
<p>The pipeline has a debug mode to facilitate the comparison of pipeline runs.
Lowering the log threshold from INFO results enables a debug mode which
processes all CASA task calls and CASA tool calls and logs them to a file. The
log records are processed to give a stable output; arguments are sorted and
variable arguments replaced (UUIDs, directory paths, etc.) so that no/minimal
false positives are raised.</p>
<p>The filename of the processed execution log is of the format
<code class="docutils literal notranslate"><span class="pre">casacalls-&lt;HOSTNAME&gt;.txt</span></code>. The hostname is included so that the output of
each MPI client can be determined for HPC executions.</p>
<section id="log-all-casa-task-calls">
<h3>Log all CASA task calls<a class="headerlink" href="#log-all-casa-task-calls" title="Link to this heading"></a></h3>
<p>To log all CASA tasks to a file suitable for diff, use a log level of DEBUG, e.g.,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">h_init</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or if you are using recipereducer,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">recipereducer</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid___A002_X30a93d_X43e&#39;</span><span class="p">],</span> <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="log-all-casa-tool-calls">
<h3>Log all CASA tool calls<a class="headerlink" href="#log-all-casa-tool-calls" title="Link to this heading"></a></h3>
<p>To record all CASA task and CASA tool invocations, use a log level of TRACE,
e.g.,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">h_init</span><span class="p">(</span><span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>or if you are using recipereducer,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pipeline</span><span class="o">.</span><span class="n">recipereducer</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uid___A002_X30a93d_X43e&#39;</span><span class="p">],</span> <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;trace&#39;</span><span class="p">)</span>
</pre></div>
</div>
<section id="restricting-log-output">
<h4>Restricting log output<a class="headerlink" href="#restricting-log-output" title="Link to this heading"></a></h4>
<p>Lowering the log level to TRACE will log all tool calls - including tools such
as CASA quanta and measures. Records from these tools may be considered noise;
you may prefer to leave the log level at DEBUG and selectively enable output
for certain tools by editing <code class="docutils literal notranslate"><span class="pre">pipeline/infrastructure/casa_tools.py</span></code>. For
example, to enable logging of calls the imager tool alone, edit <code class="docutils literal notranslate"><span class="pre">casa_tools.py</span></code>
and change the definition of the imager tool from</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imager</span> <span class="o">=</span> <span class="n">create_logging_class</span><span class="p">(</span><span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="p">)</span>
</pre></div>
</div>
<p>to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imager</span> <span class="o">=</span> <span class="n">create_logging_class</span><span class="p">(</span><span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
</pre></div>
</div>
<p>To omit log records entirely, remove the <code class="docutils literal notranslate"><span class="pre">log_tool_invocations</span></code> decorating
call, e.g.,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">imager</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h2>
<p>Scenario: two branches have different code but should result in identical CASA
calls. This can be tested by running an execution for both branches, keeping the:</p>
<ol class="simple">
<li><p>same CASA version</p></li>
<li><p>same data</p></li>
<li><p>same pipeline recipe</p></li>
</ol>
<p>From an initial root directory, run the pipeline procedure for the main trunk with</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir trunk</span>
<span class="go">casa --agg</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/path/to/Pipeline-maintrunk.egg&#39;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="kn">import</span> <span class="nn">pipeline</span>
<span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">recipereducer</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/rawdata/uid___A002_X30a93d_X43e&#39;</span><span class="p">],</span>
                                  <span class="n">procedure</span><span class="o">=</span><span class="s1">&#39;hifacal.xml&#39;</span><span class="p">,</span>
                                  <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>From the same initial root directory, run the pipeline procedure for the branch with</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">mkdir branch</span>
<span class="go">casa --agg</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;/path/to/Pipeline-branch.egg&#39;</span><span class="p">)</span>
<span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span> <span class="kn">import</span> <span class="nn">pipeline</span>
<span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">recipereducer</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/rawdata/uid___A002_X30a93d_X43e&#39;</span><span class="p">],</span>
                                  <span class="n">procedure</span><span class="o">=</span><span class="s1">&#39;hifacal.xml&#39;</span><span class="p">,</span>
                                  <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>You can now diff the output with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">diff trunk/casacalls-&lt;hostname&gt;.txt branch/casacalls-&lt;hostname&gt;.txt</span>
</pre></div>
</div>
<p><strong>Note</strong>: The main trunk does not have an updated build procedure that
generates an egg. For the moment, you will have to either run <code class="docutils literal notranslate"><span class="pre">casa</span> <span class="pre">--pipeline</span></code> to use the pipeline packaged with CASA (=pipeline main trunk for
CASA 5.3 prereleases) or add your working directory to the CASA <code class="docutils literal notranslate"><span class="pre">sys.path</span></code>
using your usual procedure.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ways_to_run_the_pipeline.html" class="btn btn-neutral float-left" title="Ways to run the Pipeline" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="building_the_pipeline.html" class="btn btn-neutral float-right" title="Building the pipeline" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>