

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pipeline developer documentation &mdash; Pipeline 
 (2025.1.1.52) 2025.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../_static/custom_theme.css?v=047bd54c" />

  
    <link rel="shortcut icon" href="../_static/favicon-16x16.png"/>
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=e72a64b0"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=0729d509"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python 3 conversion notes" href="python3_conversion_notes.html" />
    <link rel="prev" title="Pipeline Quality Assurance (QA) Score Class Design" href="QA_scores.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="../index.html" class="icon icon-home">
            Pipeline 
 (2025.1.1.52)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeline.html">Roadmap &amp; Branching Strategy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Pipeline developer documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#pipeline-context-and-domain-objects">Pipeline Context and domain objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview-of-context">Overview of Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overview-of-domain-objects">Overview of domain objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-pipeline-context">Using the pipeline context</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-pipeline-context-via-task-interface">Accessing the pipeline context via task interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-pipeline-context-using-python-classes-directly">Accessing the pipeline context using Python classes directly</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example-interactions-with-the-pipeline-context-and-its-domain-objects">Example interactions with the Pipeline context and its domain objects</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#context-queries-info-about-pipeline-run-results">Context queries: info about pipeline run, results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#context-queries-measurement-sets">Context queries: measurement sets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#context-queries-virtual-spectral-windows">Context queries: virtual spectral windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurementset-queries-spectral-windows">MeasurementSet queries: spectral windows</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurementset-queries-fields">MeasurementSet queries: fields</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurementset-queries-scans">MeasurementSet queries: scans</a></li>
<li class="toctree-l4"><a class="reference internal" href="#measurementset-queries-data-descriptions">MeasurementSet queries: data descriptions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#retrieving-spectral-windows-for-an-ms">Retrieving spectral windows for an MS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#log-files-for-individual-tasks">Log files for individual tasks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#log-handling-for-attention-warning-and-error-notifications-in-weblog">Log handling for attention, warning, and error notifications in weblog</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#weblog-rendering">Weblog rendering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#single-vis-multi-vis-and-session-aware-tasks">Single-vis, multi-vis, and session-aware tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stage-numbers-in-filenames">Stage numbers in filenames</a></li>
<li class="toctree-l2"><a class="reference internal" href="#reference-antenna-updates">Reference antenna updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spectralspec-handling-in-tasks">SpectralSpec handling in tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#spectral-windows-in-pipeline">Spectral Windows in Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#science-spectral-windows">Science spectral windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tsys-spectral-windows">Tsys spectral windows</a></li>
<li class="toctree-l3"><a class="reference internal" href="#diffgain-reference-and-diffgain-on-source-spectral-windows">Diffgain reference and diffgain on-source spectral windows</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#spectral-window-mapping-in-pipeline">Spectral Window mapping in Pipeline</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tsys-spw-to-target-spw-mapping">Tsys SpW to target SpW mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#phase-offset-gaincal-calibrator-spw-to-target-spw-mapping">Phase-offset gaincal calibrator SpW to target SpW mapping</a></li>
<li class="toctree-l3"><a class="reference internal" href="#diffgain-reference-spw-to-diffgain-on-source-spw-mapping">Diffgain reference SpW to diffgain on-source SpW mapping</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/context.html">Pipeline Context and Domain Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Pipeline 
 (2025.1.1.52)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Pipeline developer documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/develdocmd/DeveloperDocumentation.md" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="pipeline-developer-documentation">
<h1>Pipeline developer documentation<a class="headerlink" href="#pipeline-developer-documentation" title="Link to this heading"></a></h1>
<p>This is to be populated, as time permits, with information that may be useful for other pipeline developer team members.</p>
<p>Think of it as a place for a new team member to look for useful bits of information, as a refresher for experienced team members, or as a reference for a developer unfamiliar with certain areas of the pipeline.</p>
<section id="pipeline-context-and-domain-objects">
<h2>Pipeline Context and domain objects<a class="headerlink" href="#pipeline-context-and-domain-objects" title="Link to this heading"></a></h2>
<p>The Pipeline Context is the Pipeline’s record of state, used to:</p>
<ul class="simple">
<li><p>Transfer state from task to task</p></li>
<li><p>Quickly access (cached) info about the dataset without expensive I/O to disk</p></li>
<li><p>Save the state of a pipeline run to disk to be able to restore/resume from disk in a future session</p></li>
</ul>
<p>The domain objects are logical representations of real-world concepts in the radio interferometry domain, and form
the core building blocks for the Pipeline application.</p>
<section id="overview-of-context">
<h3>Overview of Context<a class="headerlink" href="#overview-of-context" title="Link to this heading"></a></h3>
<p>The following is a brief overview of contents in the Pipeline context, not expected to be comprehensive:</p>
<ul class="simple">
<li><p>Metadata about the Pipeline run (stage counter, output dir)</p></li>
<li><p>Metadata describing the MeasurementSet(s), represented by Domain objects (e.g. antenna, spectral windows, fields, scans…)</p>
<ul>
<li><p>Originally implemented at a time that the CASA <code class="docutils literal notranslate"><span class="pre">msmd</span></code> tool was not yet available, so this was necessary to access
metadata quickly. Since the introduction of <code class="docutils literal notranslate"><span class="pre">msmd</span></code>, most elements in Pipeline domain objects are now populated
using <code class="docutils literal notranslate"><span class="pre">msmd</span></code> (see usage of <code class="docutils literal notranslate"><span class="pre">infrastructure.casa_tools.MSMDReader</span></code> and <code class="docutils literal notranslate"><span class="pre">infrastructure.tablereader</span></code>).</p></li>
</ul>
</li>
<li><p>Calibration state (callibrary)</p></li>
<li><p>Results from completed stages (just as reference to results stored on disk)</p></li>
<li><p>Cached data from stage(s) required as input in subsequent stage(s), e.g.:</p>
<ul>
<li><p>Spectral window maps</p></li>
<li><p>Mapping of phase calibrator to target/check fields</p></li>
<li><p>Lists of images to be produced by imaging stage(s)</p></li>
<li><p>Self-cal targets</p></li>
</ul>
</li>
</ul>
<p>Note: The Pipeline context is not a formally agreed user interface. Interface changes happen regularly during
development of each release, and the Pipeline is not guaranteed to be backwards compatible with context pickles
created by previous releases.</p>
<p>Context key properties:</p>
<ul class="simple">
<li><p>output_dir, report_dir, products_dir: directories to store Pipeline output</p></li>
<li><p>logs: filenames for log/script outputs</p></li>
<li><p>results: list of references to task results (stored on disk)</p></li>
<li><p>callibrary: Pipeline Calibration State</p></li>
<li><p>project_[summary|structure|performance_parameters]: information about the observing project</p></li>
<li><p>processing_intents: list of processing intents</p></li>
<li><p>observing_run: metadata about the observing run that is (being) processed</p></li>
<li><p>calimlist, sciimlist, rmsimlist, subimlist: lists of images that have been computed in (calibrator, science, RMS, cutout) imaging stages</p></li>
<li><p>contfile, linesfile, clean_list_info, imaging_mode, imaging_mode, imaging_parameters, etc: Parameters / info used in imaging stages</p></li>
</ul>
<p>Context key functions:</p>
<ul class="simple">
<li><p>get_oussid(): returns the parent OUS “ousstatus” name</p></li>
<li><p>get_recipe_name(): returns the recipe name from the project structure</p></li>
<li><p>set_state(): internal function to set project structure, recipe name, proc title</p></li>
<li><p>save(filename=None): saves a copy of the context to disk</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">observing_run</span></code> key properties:</p>
<ul class="simple">
<li><p>measurement_sets: list of MS domain objects</p></li>
<li><p>virtual_science_spw_[ids|names|shortnames]: info on virtual spectral windows across observing run</p></li>
<li><p>start_[time|datetime], end_[time|datetime]: start/end time (and date) for run (based on first/last MS)</p></li>
<li><p>project_ids, schedblock_ids, execblockids, observers: return set of unique project / scheduling block / execution block IDs or observers for given run</p></li>
<li><p>ms_datatable_name, ms_reduction_group, org_directions: parameters / info used in ALMA Single-Dish stages</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">observing_run</span></code> key functions:</p>
<ul class="simple">
<li><p>add_measurement_set(ms): register MS object with run</p></li>
<li><p>get_ms(name, intent): retrieve MS by name (or intent)</p></li>
<li><p>get_measurement_sets(names, intents, fields): retrieve MSes filtered by names, fields, intents</p></li>
<li><p>get_measurement_sets_of_type(dtypes, msonly, source, spw, vis): retrieve MSes filtered by name, data type, source name, spw</p></li>
<li><p>get_real_spw_id_by_name(spw_name, target_ms): translate spw name to real spw ID for given MS</p></li>
<li><p>get_virtual_spw_id_by_name(spw_name): translate spw name to virtual spw ID for run</p></li>
<li><p>[virtual2real|real2virtual]_spw_id(spw_id, target_ms): translate spw ID from virtual to real / real to virtual for given MS</p></li>
<li><p>real2real_spw_id(spw_id, source_ms, target_ms): translate a real spw ID from one MS to another MS.</p></li>
</ul>
</section>
<section id="overview-of-domain-objects">
<h3>Overview of domain objects<a class="headerlink" href="#overview-of-domain-objects" title="Link to this heading"></a></h3>
<p>Pipeline includes the following domain objects:</p>
<ul class="simple">
<li><p>ObservingRun: Representation of the observing run that is processed</p></li>
<li><p>MeasurementSet: Representation of the MeasurementSet: AntennaArray, Fields, Sources, Scans, DataDescription, SpWs, Pol, States (Intents), FluxMeasurements, DataType.</p></li>
<li><p>Also stores PL derived MS-specific properties used in subsequent stages.</p></li>
<li><p>AntennaArray: Representation of the antenna array (name, antennas, baselines, location, centre, …)</p></li>
<li><p>Antenna: Representation of a single antenna (name, ID, long/lat/height, diameter, direction)</p></li>
<li><p>Field: Representation of a field (name, ID, associated source ID, times, intents, states, valid SpWs, flux dens.)</p></li>
<li><p>Source: Representation of a source (name, ID, associated field IDs, direction, proper motion, ephemeris info)</p></li>
<li><p>Scan: Representation of a single scan (antennas, intents, fields, states, data_descriptions, scan times)</p></li>
<li><p>DataDescription: Representation of the DATA_DESCRIPTION table of an MS (data description IDs, SpW IDs, Pol IDs)</p></li>
<li><p>SpectralWindow: Representation of a single SpW (name, ID, type, receiver, band, baseband, sideband, bandwidth, LO freqs, mean freq, ref freq, intents, list of Channels (themselves representations of each channel), …)</p></li>
<li><p>Polarization: Representation of a polarization (ID, # of correlations, correlation type, correlation products)</p></li>
<li><p>State: Representation of the STATE table in the MS, mapping “obs_mode” to pipeline “intents”</p></li>
<li><p>FluxMeasurement: Representation of a flux measurement (SpW ID, I, Q, U, V, spix, uv min/max, origin, age, query date)</p></li>
<li><p>DataType: Defines different types of data (raw, calibration, after spectral bl subtraction, …)</p></li>
<li><p>datatable: Contains classes to hold metadata for scan table in memory, mapping between serial row indices and per-MS row indices, etc…</p></li>
<li><p>measures: Defines commonly used measures and their units  (angles, distance, flux, frequency, velocity, file size,</p></li>
<li><p>unitformat: Defines format for units of magnitude (e.g. Kilobyte, millimeter, GHz, …)</p></li>
<li><p>singledish: Defines classes to represent a MS Reduction Group, and individual MS Reduction Group Members.</p></li>
</ul>
</section>
<section id="using-the-pipeline-context">
<h3>Using the pipeline context<a class="headerlink" href="#using-the-pipeline-context" title="Link to this heading"></a></h3>
<p>A new Context is created with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">h_init</span><span class="p">()</span>
</pre></div>
</div>
<p>In this case, the Pipeline context becomes a hidden global variable in the CASA session.</p>
<p>Contexts can be saved to and restored from disk:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Save context to disk.</span>
<span class="n">h_save</span><span class="p">()</span>
<span class="c1"># Restore context from disk.</span>
<span class="n">h_resume</span><span class="p">()</span>
</pre></div>
</div>
<p>At the end of a Pipeline run, the final state of the Pipeline Context is written to the working directory.</p>
<p>Depending on the <code class="docutils literal notranslate"><span class="pre">loglevel</span></code> of the Pipeline run, per-staged pickled Contexts can be found in the <code class="docutils literal notranslate"><span class="pre">saved_stage</span></code> folder.</p>
</section>
<section id="accessing-the-pipeline-context-via-task-interface">
<h3>Accessing the pipeline context via task interface<a class="headerlink" href="#accessing-the-pipeline-context-via-task-interface" title="Link to this heading"></a></h3>
<p>Upon initializing a new context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">h_init</span><span class="p">()</span>
</pre></div>
</div>
<p>Upon resuming the most recent context found in working directory:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">h_resume</span><span class="p">()</span>

<span class="c1"># Note, this is equivalent to using:</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">h_resume</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="c1"># where &#39;last&#39; is a special case &quot;filename&quot; interpreted to load the context with</span>
<span class="c1"># the most recent timestamp.</span>
</pre></div>
</div>
<p>Upon resuming a user-specified context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">context</span> <span class="o">=</span> <span class="n">h_resume</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;pipeline-procedure_hifa_cal.context&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>In case a Pipeline context was initialized or resumed without capturing the returned reference:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Context gets initialized but the returned context is not captured:</span>
<span class="n">h_init</span><span class="p">()</span>
</pre></div>
</div>
<p>then this can still be retrieved with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Later in the session, you can get a reference to the context in the current CASA session with:</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pipeline.h.cli</span><span class="w"> </span><span class="kn">import</span> <span class="n">cli</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">cli</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cli</span><span class="o">.</span><span class="n">PIPELINE_NAME</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="accessing-the-pipeline-context-using-python-classes-directly">
<h3>Accessing the pipeline context using Python classes directly<a class="headerlink" href="#accessing-the-pipeline-context-using-python-classes-directly" title="Link to this heading"></a></h3>
<p>Initializing a new run / context and saving to disk:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">()</span><span class="o">.</span><span class="n">context</span>
<span class="n">context</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>Resuming previous run / context:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">context</span>
</pre></div>
</div>
</section>
<section id="example-interactions-with-the-pipeline-context-and-its-domain-objects">
<h3>Example interactions with the Pipeline context and its domain objects<a class="headerlink" href="#example-interactions-with-the-pipeline-context-and-its-domain-objects" title="Link to this heading"></a></h3>
<section id="context-queries-info-about-pipeline-run-results">
<h4>Context queries: info about pipeline run, results<a class="headerlink" href="#context-queries-info-about-pipeline-run-results" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Resume a context:</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">h_resume</span><span class="p">()</span>

<span class="c1"># Display recipe name and Observing Unit Set Status ID:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get_recipe_name</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">get_oussid</span><span class="p">())</span>

<span class="c1"># Display various information about the observing run:</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">project_ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">schedblock_ids</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">execblock_ids</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">observers</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">start_datetime</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">end_datetime</span><span class="p">)</span>

<span class="c1"># Get stage number and name for all task results:</span>
<span class="k">for</span> <span class="n">results_proxy</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">results_proxy</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># this reads the result back in from disk</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">stage_number</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">results</span><span class="o">.</span><span class="n">taskname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Show specific result, and corresponding task inputs.</span>
<span class="n">task_result_list</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># Reading results from stage 15 (stage numbers are 1-indexed)</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pprint</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">task_result_list</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="context-queries-measurement-sets">
<h4>Context queries: measurement sets<a class="headerlink" href="#context-queries-measurement-sets" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get names of MeasurementSets in current run.</span>
<span class="n">msnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets</span><span class="p">()]</span>

<span class="c1"># Get MeasurementSet by name.</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;uid___A002_X1181695_X1c6a4_8ant.ms&quot;</span><span class="p">)</span>

<span class="c1"># Get MeasurementSets filtered by given names &amp; intents.</span>
<span class="n">mslist</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets</span><span class="p">(</span><span class="n">names</span><span class="o">=</span><span class="n">vislist</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="s2">&quot;BANDPASS,PHASE&quot;</span><span class="p">)</span>

<span class="c1"># Get MeasurementSets matching given DataType.</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pipeline.domain.datatype</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataType</span>
<span class="n">mslist</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">DataType</span><span class="o">.</span><span class="n">REGCAL_CONTLINE_ALL</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">REGCAL_CONTLINE_SCIENCE</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="context-queries-virtual-spectral-windows">
<h4>Context queries: virtual spectral windows<a class="headerlink" href="#context-queries-virtual-spectral-windows" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Full/short names for all virtual SpWs in the observing run.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_shortnames</span><span class="p">)</span>

<span class="c1"># Convert virtual SpW ID to real one for given MS.</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">virt_spwid</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">real_spwid</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">virt_spwid</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>

<span class="c1"># Convert real SpW ID for given MS to virtual SpW ID.</span>
<span class="n">virtual_spwid</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="mi">22</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="measurementset-queries-spectral-windows">
<h4>MeasurementSet queries: spectral windows<a class="headerlink" href="#measurementset-queries-spectral-windows" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>

<span class="c1"># Get all Spectral Windows.</span>
<span class="n">all_spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Get frame for specific SpW.</span>
<span class="n">frame</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">frame</span>

<span class="c1"># Get all &quot;Differential Gain Reference&quot; spectral windows, filtered by requested IDs.</span>
<span class="n">dgref_spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="s2">&quot;16,18,20,22&quot;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s2">&quot;DIFFGAINREF&quot;</span><span class="p">)</span>

<span class="c1"># Get SpW IDs for science SpWs (default), filtered by band and number of channels.</span>
<span class="n">scispw_ids_sel</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">==</span> <span class="s2">&quot;ALMA Band 3&quot;</span> <span class="ow">and</span> <span class="n">spw</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="measurementset-queries-fields">
<h4>MeasurementSet queries: fields<a class="headerlink" href="#measurementset-queries-fields" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>

<span class="c1"># Get names for all fields in the MS.</span>
<span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">()]</span>

<span class="c1"># Get unique intents covered by fields for given field argument.</span>
<span class="n">field_intents</span> <span class="o">=</span> <span class="p">{</span><span class="n">intent</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="s2">&quot;J1851+0035,W43-MM1&quot;</span><span class="p">)</span>
                 <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">}</span>

<span class="c1"># Get field ID for all fields matching science target intent.</span>
<span class="n">fieldlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s2">&quot;TARGET&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="measurementset-queries-scans">
<h4>MeasurementSet queries: scans<a class="headerlink" href="#measurementset-queries-scans" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get IDs of all scans.</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
<span class="n">scan_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">()]</span>

<span class="c1"># Get time on source for scans with PHASE intent for selected fields.</span>
<span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">time_on_source</span>
         <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="s2">&quot;J1851+0035,W43-MM1&quot;</span><span class="p">,</span> <span class="n">scan_intent</span><span class="o">=</span><span class="s2">&quot;PHASE&quot;</span><span class="p">)]</span>
</pre></div>
</div>
</section>
<section id="measurementset-queries-data-descriptions">
<h4>MeasurementSet queries: data descriptions<a class="headerlink" href="#measurementset-queries-data-descriptions" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get polarization ID for given MS, SpW ID, and correlation type.</span>
<span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
<span class="n">datadesc</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">pol_id</span> <span class="o">=</span> <span class="n">datadesc</span><span class="o">.</span><span class="n">get_polarization_id</span><span class="p">(</span><span class="s2">&quot;XY&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="retrieving-spectral-windows-for-an-ms">
<h4>Retrieving spectral windows for an MS<a class="headerlink" href="#retrieving-spectral-windows-for-an-ms" title="Link to this heading"></a></h4>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Restore latest context from disk.</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pipeline</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">Pipeline</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">context</span>

<span class="c1"># Retrieve measurement set domain object.</span>
<span class="n">vis</span> <span class="o">=</span> <span class="s1">&#39;myvis.ms&#39;</span>
<span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>

<span class="c1"># Get a list of spectral windows in the MS.</span>
<span class="n">spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Link to this heading"></a></h2>
<section id="log-files-for-individual-tasks">
<h3>Log files for individual tasks<a class="headerlink" href="#log-files-for-individual-tasks" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">casapy.log</span></code> that gets linked from the task page is generated upon pickling a
task result after execution. The contents of this log file are taken from the
temporary <code class="docutils literal notranslate"><span class="pre">result.casalog</span></code> property that is populated by the <code class="docutils literal notranslate"><span class="pre">capture_log</span></code>
decorator. This temporary property is deleted as soon as the stage log is written
to disk, to reduce the size of the final result pickle that is serialized to disk.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">capture_log</span></code> decorator is only appropriate for (and used around) the
<code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.StandardTaskTemplate.execute</span></code> method, and so it currently
can only ever capture what happens during execution of the main task heuristics
(primarily its <code class="docutils literal notranslate"><span class="pre">prepare</span></code> and <code class="docutils literal notranslate"><span class="pre">analyse</span></code> methods) but not what occurs during QA or
weblog generation.</p>
<p>At present, the QA heuristic evaluation and weblog generation are kicked off as part
of accepting a task result (from a task that finished execution) into the Pipeline
context, in <code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.Result.accept</span></code> that is invoked by
<code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.Executor.execute</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">capture_log</span></code> decorator operates directly on the CASA log file (and CASA’s <code class="docutils literal notranslate"><span class="pre">casalog</span></code>),
bypassing the <code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.logging</span></code> that is used throughout pipeline
to handle logging.</p>
</section>
<section id="log-handling-for-attention-warning-and-error-notifications-in-weblog">
<h3>Log handling for attention, warning, and error notifications in weblog<a class="headerlink" href="#log-handling-for-attention-warning-and-error-notifications-in-weblog" title="Link to this heading"></a></h3>
<p>Separate from <code class="docutils literal notranslate"><span class="pre">result.casalog</span></code>, there also exists a <code class="docutils literal notranslate"><span class="pre">result.logrecords</span></code> property.
This is initially populated by <code class="docutils literal notranslate"><span class="pre">basetask.StandardTaskTemplate.execute</span></code> itself
(rather than a decorator for <code class="docutils literal notranslate"><span class="pre">result.casalog</span></code>) and later further appended to by
<code class="docutils literal notranslate"><span class="pre">pipelineqa.QARegistry.do_qa</span></code>.</p>
<p>Both at the init and append steps, the logging handlers only intend to capture
errors, warnings, and attention level messages, as <code class="docutils literal notranslate"><span class="pre">result.logrecords</span></code> is only
ever used by the weblog renderer, for the purpose of generating
warning/error/attention notifications and corresponding badges.</p>
<p>Over the years, a couple of exceptional cases were introduced with the aim of
capturing these kinds of notifications when they occur during weblog generation.
To this end, in the weblog renderer module of a couple of tasks, a logging
handler has been wrapped around a particular rendering step (e.g. creating some
plot) to capture any error/warning/attention messages from there, and add those
to <code class="docutils literal notranslate"><span class="pre">result.logrecords</span></code> as well. Since these are still messages that occur
during weblog generation, added to <code class="docutils literal notranslate"><span class="pre">result.logrecords</span></code>, these messages will only
show up as notifications in the weblog (banner at top of page), but not in the
task-specific <code class="docutils literal notranslate"><span class="pre">casapy.log</span></code>.</p>
</section>
</section>
<section id="weblog-rendering">
<h2>Weblog rendering<a class="headerlink" href="#weblog-rendering" title="Link to this heading"></a></h2>
<p>The pipeline weblog generator is implemented in <code class="docutils literal notranslate"><span class="pre">infrastructure.renderer.htmlrenderer.WebLogGenerator</span></code>.</p>
<p>The weblog rendering is always executed on the “pipeline context”, not on an
individual task result. As such, the weblog generator cannot render results that
have not (yet) been accepted into the context.</p>
<p>During a pipeline run, weblog rendering is triggered as a step after execution of
the main task heuristics, during the step where the task <code class="docutils literal notranslate"><span class="pre">Results</span></code> are accepted
into the Pipeline context, as implemented in <code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.Results.accept</span></code>.</p>
<p>Weblog generation can be disabled with the module-level variable
<code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.DISABLE_WEBLOG</span></code>, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline.infrastructure.basetask</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">basetask</span>
<span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1"># continue with execution of Pipeline stages, recipereducer, or executeppr...</span>
</pre></div>
</div>
<p>or at time of Pipeline initialisation with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">h_init</span><span class="p">(</span><span class="n">weblog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Weblog generation can also be triggered after a Pipeline run has completed, with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pipeline.infrastructure.renderer.htmlrenderer</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">htmlrenderer</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">h_resume</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;last&#39;</span><span class="p">)</span>
<span class="n">htmlrenderer</span><span class="o">.</span><span class="n">WebLogGenerator</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>However, at present, there are various pipeline stages where the weblog rendering
will include steps that create statistics (e.g. flagging summary) or plots based on the
state that the Measurement Set is left in at the end of the pipeline stage.
As such, decoupling weblog rendering from task execution is possible, but running
weblog generation for the first time at the end of the pipeline run would currently
lead to the weblog of several stages looking different, because the measurement set
will have been changed in subsequent stages (typically updates to flagging,
corrected amplitude, and/or model data columns).</p>
<p>There are already a couple of tasks that need to create plots during execution of
the task heuristics, because those plots need to reflect the temporary state of the
measurement set during the task. Examples include: <code class="docutils literal notranslate"><span class="pre">hifa_bandpassflag</span></code>,
<code class="docutils literal notranslate"><span class="pre">hifa_gfluxscaleflag</span></code>, <code class="docutils literal notranslate"><span class="pre">hifa_targetflag</span></code>, <code class="docutils literal notranslate"><span class="pre">hifa_polcalflag</span></code>, which all use a mid-task
temporary applycal.</p>
</section>
<section id="single-vis-multi-vis-and-session-aware-tasks">
<h2>Single-vis, multi-vis, and session-aware tasks<a class="headerlink" href="#single-vis-multi-vis-and-session-aware-tasks" title="Link to this heading"></a></h2>
<p>By default, each pipeline task is considered a single-vis task, which means that
if invoked on a list of measurement sets, the task will automatically be executed
separately for each measurement set, with the <code class="docutils literal notranslate"><span class="pre">Results</span></code> object from each execution
aggregated into a <code class="docutils literal notranslate"><span class="pre">ResultsList</span></code> that is returned by the single-vis task. This handling
is implemented in <code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.StandardTaskTemplate.execute</span></code>.</p>
<p>A task can declare itself to be multi-vis with the <code class="docutils literal notranslate"><span class="pre">is_multi_vis_task</span></code> class
property. Examples include the <code class="docutils literal notranslate"><span class="pre">exportdata</span></code> and <code class="docutils literal notranslate"><span class="pre">restoredata</span></code> tasks, and many
tasks in the “imaging” pipeline. A multi-vis task is not necessarily a
session-aware task. Many multi-vis tasks merely process all input measurement sets
at once, without regard of what session each measurement set belongs to.</p>
<p>Session-aware tasks were first foreseen as necessary for the future implementation
of “group processing”: processing a group of measurement sets that were observed
as part of a “session”, where certain measurement sets no longer contain all required
calibrator intents themselves but instead need to be calibrated using calibration
scans from a different measurement set in the same session.</p>
<p>Initial updates to the pipeline framework to support sessions were introduced in
<a class="reference external" href="https://open-jira.nrao.edu/browse/CAS-10781">CAS-10781</a> around Fall 2017 for the Cycle 6 release, see commit
<a class="reference external" href="https://open-bitbucket.nrao.edu/projects/PIPE/repos/pipeline/commits/0a23bd5b85154118371d3bfedf9fbc7a50bb4bfc">0a23bd5b</a>.</p>
<p>As part of CAS-10781, prototype of 2 session-aware tasks were introduced:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">session_bandpass</span></code> task defined in <code class="docutils literal notranslate"><span class="pre">hifa.tasks.bandpass.almaphcorbandpass.SessionALMAPhcorBandpass</span></code> is a prototype of bandpass task that would process a session of MSes where one or more MSes might miss a bandpass calibrator; for those MSes without a bandpass, it would take a bandpass scan from another MS that is closest in time.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">session_gfluxscale</span></code> task defined in <code class="docutils literal notranslate"><span class="pre">hifa.tasks.fluxscale.gcorfluxscale.SessionGcorFluxscale</span></code> is a prototype that would process a session of MSes, adopting flux calibrations from one MS to another MS if the latter were to be missing a flux calibrator</p></li>
</ul>
<p>Note: as of September 2025, these tasks are still prototypes that are not validated,
have never been used in recipes / production, and are not actively maintained. To
avoid ongoing maintenance, these tasks could be commented out or removed from their module.</p>
<p>A task is session-aware when it acts separately on each session and its corresponding list of MSes.</p>
<p>As of September 2025, the following Pipeline tasks are session aware, as
indicated by their use of <code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.sessionutils.group_vislist_into_sessions</span></code>:</p>
<ul class="simple">
<li><p>hifa_session_refant:</p>
<ul>
<li><p>used in ALMA IF polarization calibration cal recipes.</p></li>
<li><p>considers all MSes within a session to assess the best single common reference antenna list.</p></li>
</ul>
</li>
<li><p>hifa_polcal:</p>
<ul>
<li><p>used in ALMA IF polarization calibration cal recipes.</p></li>
<li><p>performs polarization calibration separately for each session, combining measurement sets within each session.</p></li>
</ul>
</li>
<li><p>hif_makeimlist:</p>
<ul>
<li><p>used in numerous ALMA IF and VLA (imaging) recipes</p></li>
<li><p>if called with <code class="docutils literal notranslate"><span class="pre">inputs.per_session=True</span></code> (default: False), <code class="docutils literal notranslate"><span class="pre">hif_makeimlist</span></code> will create an image target per session.</p></li>
</ul>
</li>
</ul>
</section>
<section id="stage-numbers-in-filenames">
<h2>Stage numbers in filenames<a class="headerlink" href="#stage-numbers-in-filenames" title="Link to this heading"></a></h2>
<p>The pipeline stage number that is used in pipeline products () is composed of two elements:</p>
<ul class="simple">
<li><p>the task counter: incremented in StandardTaskTemplate.execute when the task-to-be-executed is the top-level task.</p></li>
<li><p>the sub-task counter: incremented in StandardTaskTemplate.execute when the task-to-be-executed is not the top-level task.</p></li>
</ul>
<p>This stage number, e.g. “s17.3”, is included in the filenames of intermediate Pipeline products (such as caltables, plots)
that are all stored in the same common ‘working’ directory, to ensure these products have unique filenames, even if a
task re-runs a gaincal step multiple times (different sub-tasks) or a pipeline task is run multiple times in a recipe.</p>
<p>The stage number is added to a task result as <code class="docutils literal notranslate"><span class="pre">result.stage_number</span></code> by <code class="docutils literal notranslate"><span class="pre">infrastructure.basetask.result_finaliser</span></code>.</p>
</section>
<section id="reference-antenna-updates">
<h2>Reference antenna updates<a class="headerlink" href="#reference-antenna-updates" title="Link to this heading"></a></h2>
<p>ALMA interferometry recipes typically include the <code class="docutils literal notranslate"><span class="pre">hif_refant</span></code> task that creates
a list of antennas ranked according to a flagging score and geometric score.</p>
<p>Upon acceptance of the Results from the <code class="docutils literal notranslate"><span class="pre">hif_refant</span></code> task, this refant list is
stored in the <code class="docutils literal notranslate"><span class="pre">reference_antenna</span></code> property of the MeasurementSet object in the
context and used in subsequent stages.</p>
<p>There are a number of ALMA IF calibration stages that can update the reference
antenna list to either a.) remove an antenna from the list, or
b.) demote an antenna to the end of the list (lowest priority):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_bandpassflag</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hif_lowgainflag</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_polcalflag</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">h*_tsysflag</span></code></p></li>
</ul>
<p>Note: <a class="reference external" href="https://open-jira.nrao.edu/browse/PIPE-1664">PIPE-1664</a> proposes to add a “refant list update” step to <code class="docutils literal notranslate"><span class="pre">hifa_gfluxscaleflag</span></code>.</p>
<p>A couple of reference antenna utility functions are bundled in
<code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.refantflag</span></code> (introduced in PIPE-1759):</p>
<ul class="simple">
<li><p>identifying fully flagged antennas from flagging view or from flagging commands</p></li>
<li><p>marking antennas for refant update</p></li>
<li><p>aggregating and formatting fully flagged antenna notifications</p></li>
</ul>
</section>
<section id="spectralspec-handling-in-tasks">
<h2>SpectralSpec handling in tasks<a class="headerlink" href="#spectralspec-handling-in-tasks" title="Link to this heading"></a></h2>
<p>A “SpectralSpec”, also known as spectral setup, is a term used by the OT and SSR to refer to a tuning, which is a
collection of spectral windows that can be observed simultaneously (i.e. in the same subscan).</p>
<p>SpectralSpec was introduced in Pipeline as part of <a class="reference external" href="https://open-jira.nrao.edu/browse/PIPE-316">PIPE-316 (2019, Cycle 7)</a>,
to assign a SpectralSpec ID to each Spectral Window, and to allow for heuristics that e.g.:</p>
<ul class="simple">
<li><p>require that a SpW is only mapped to another SpW within the same SpectralSpec</p></li>
<li><p>evaluate a heuristic separately for each SpectralSpec, aka each group of SpWs that share the same SpectralSpec ID.</p></li>
</ul>
<p>As of September 2025, the following Pipeline tasks include steps based on SpectralSpec (aka spectral tuning):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_flagdata</span></code>: considers SpectralSpec in step to flag ACA FDM spectral window edges (PIPE-1991).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_bandpass</span></code>: considers SpectralSpec during determination of optimal phase-up solint (and combine).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_gfluxscaleflag</span></code>: creates separate phase-up caltables for each SpectralSpec.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_spwphaseup</span></code>:</p>
<ul>
<li><p>the gaincal step in this task creates separate gaincal jobs for each SpectralSpec.</p></li>
<li><p>SpectralSpec is considered in the step to determine the optimal phase-up solint.</p></li>
<li><p>In phase decoherence step, considers SpectralSpec in selecting what SpWs to analyse (PIPE-1871).</p></li>
<li><p>SNR based narrow-to-wide spw map considers SpectralSpec for find matching spw for each science spw.</p></li>
<li><p>the science spw combination map considers SpectralSpec to set which SpWs can be combined.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_polcalflag</span></code>: the gaincal step in this task creates separate gaincal jobs for each SpectralSpec.</p></li>
<li><p>SD common raster utility <code class="docutils literal notranslate"><span class="pre">flag_raster_map</span></code> consolidates its results per SpectralSpec and field (PIPE-1990)</p></li>
<li><p>SpW ID vs. Frequency plot in MS-summary page uses a different colour coding per SpectralSpec.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_timegaincal</span></code>: the steps computing phase solutions for phase calibrators and for the target will create separate
solutions for each SpectralSpec in case of spw combination (PIPE-390)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">hifa_tsysflagcontamination</span></code>: uses SpectralSpec to determine if a dataset is multi-tuning and multi-source (which gets
its own dedicated “unprocessable” score).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tsysspwmap</span></code> heuristic module:</p>
<ul>
<li><p>Creates a Tsys SpW map where science SpW and Tsys SpW need to have matching SpectralSpec.</p></li>
<li><p>This tsysspwmap heuristic is used in both <code class="docutils literal notranslate"><span class="pre">h_tsyscal</span></code> and in <code class="docutils literal notranslate"><span class="pre">AtmHeuristics</span></code> (itself used in <code class="docutils literal notranslate"><span class="pre">hifa_wvrgcal</span></code> and <code class="docutils literal notranslate"><span class="pre">phasemetrics</span></code>).</p></li>
</ul>
</li>
</ul>
</section>
<section id="spectral-windows-in-pipeline">
<h2>Spectral Windows in Pipeline<a class="headerlink" href="#spectral-windows-in-pipeline" title="Link to this heading"></a></h2>
<p>The Pipeline has defined the <code class="docutils literal notranslate"><span class="pre">domain.spectralwindow.SpectralWindow</span></code> domain class to represent spectral windows,
and these get generated during the importdata stage by
<code class="docutils literal notranslate"><span class="pre">infrastructure.tablereader.SpectralWindowTable.get_spectral_windows</span></code> and added to the <code class="docutils literal notranslate"><span class="pre">MeasurementSet</span></code> object
(<code class="docutils literal notranslate"><span class="pre">ms.spectral_windows</span></code>) in <code class="docutils literal notranslate"><span class="pre">infrastructure.tablereader.MeasurementSetReader.get_measurement_set</span></code>.</p>
<p>Throughout all Pipeline tasks, it is a common pattern to retrieve information about spectral windows via the
<code class="docutils literal notranslate"><span class="pre">MeasurementSet.get_spectral_windows</span></code> method.</p>
<p>The Pipeline heuristics distinguish a number of different kinds of spectral windows, such as:</p>
<ul class="simple">
<li><p>“science” spectral windows</p></li>
<li><p>Tsys spectral windows</p></li>
<li><p>Diffgain reference spectral windows</p></li>
<li><p>Diffgain on-source spectral windows</p></li>
</ul>
<p>Here, it should be noted that this “kind” of spectral window is <em>not</em> the same as its “type”. The “type” of a
spectral window is recorded as the <code class="docutils literal notranslate"><span class="pre">type</span></code> property of the <code class="docutils literal notranslate"><span class="pre">SpectralWindow</span></code> domain class, and covers e.g. WVR,
CHANAVG, FDM, TDM; for reference, see this description in CASA docs:
<a class="reference external" href="https://casadocs.readthedocs.io/en/stable/api/tt/casatools.msmetadata.html#casatools.msmetadata.msmetadata.almaspwse">https://casadocs.readthedocs.io/en/stable/api/tt/casatools.msmetadata.html#casatools.msmetadata.msmetadata.almaspwse</a> description of almaspw</p>
<p>The above-mentioned “kinds” of spectral windows are not recorded as a property in <code class="docutils literal notranslate"><span class="pre">SpectralWindow</span></code> and instead are
determined in different manners for the different kinds. Moreover, these “kinds” are local definitions used by Pipeline
that may not be recognized by other ALMA subsystems.</p>
<section id="science-spectral-windows">
<h3>Science spectral windows<a class="headerlink" href="#science-spectral-windows" title="Link to this heading"></a></h3>
<p>The definition of “science” spectral windows is implemented in the <code class="docutils literal notranslate"><span class="pre">MeasurementSet.get_spectral_windows</span></code> method,
and depends on whether the MS is from ALMA, VLA, or NRO. For ALMA, a science spectral window is a spectral window
that:</p>
<ul class="simple">
<li><p>covers one of the “science” intents; currently: ‘TARGET’, ‘PHASE’, ‘BANDPASS’, ‘AMPLITUDE’, ‘POLARIZATION’,
‘POLANGLE’, ‘POLLEAKAGE’,‘CHECK’, ‘DIFFGAINREF’, ‘DIFFGAINSRC’</p></li>
<li><p>has a number of channels that is not 1 or 4 (specifically: not in <code class="docutils literal notranslate"><span class="pre">MeasurementSet.exclude_num_chans</span></code>)</p></li>
</ul>
<p>By this definition, the science spectral windows exclude for example:</p>
<ul class="simple">
<li><p>1-channel wide CHANAVG</p></li>
<li><p>1-channel wide SQLD</p></li>
<li><p>4-channel wide WVR</p></li>
<li><p>spectral windows used for scans that only cover POINTING and WVR intents</p></li>
</ul>
<p>Conceptually, the science spectral windows are the main spectral windows used to observe the astronomical targets,
and the majority of ALMA Pipeline tasks and heuristics typically only work on the science spectral windows.
As such, it is even the default behaviour of the <code class="docutils literal notranslate"><span class="pre">MeasurementSet.get_spectral_windows</span></code> method to return only the
science spectral windows. If a task does need all spectral windows, they can override this behaviour with:
<code class="docutils literal notranslate"><span class="pre">all_spws</span> <span class="pre">=</span> <span class="pre">ms.get_spectral_windows(science_windows_only=False)</span></code>.</p>
</section>
<section id="tsys-spectral-windows">
<h3>Tsys spectral windows<a class="headerlink" href="#tsys-spectral-windows" title="Link to this heading"></a></h3>
<p>Tsys spectral windows are used to measure the system temperature, and used during Tsys calibration scans that
cover the “ATMOSPHERE” intent.</p>
<p>Depending on how the observation is set up, the Tsys SpWs can be the same as the science SpWs or they can be defined
as separate dedicated SpWs. The latter can occur for example when the science scans use high spectral resolution
(FDM mode) spectral windows while the Tsys scans are normally performed with lower resolution (TDM mode)
spectral windows.</p>
<p>Identifying a Tsys spectral window is defined in <code class="docutils literal notranslate"><span class="pre">h.heuristics.tsysspwmap</span></code> as either:</p>
<ul class="simple">
<li><p>spectral windows that are present in a Tsys solutions caltable created by CASA, or</p></li>
<li><p>spectral windows in MS that cover ‘ATMOSPHERE’ intent and whose type is ‘TDM’</p></li>
</ul>
</section>
<section id="diffgain-reference-and-diffgain-on-source-spectral-windows">
<h3>Diffgain reference and diffgain on-source spectral windows<a class="headerlink" href="#diffgain-reference-and-diffgain-on-source-spectral-windows" title="Link to this heading"></a></h3>
<p>The concept of “diffgain reference” and “diffgain on-source” spectral windows was introduced in PL2024 as part of adding
support for calibration band-to-band observations that use a differential gain calibrator. Relevant tickets:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://open-jira.nrao.edu/browse/PIPE-2079">PIPE-2079</a></p></li>
<li><p><a class="reference external" href="https://open-jira.nrao.edu/browse/PIPE-2145">PIPE-2145</a></p></li>
</ul>
<p>Within Pipeline, these two kinds are identified as science spectral windows that cover either the <code class="docutils literal notranslate"><span class="pre">DIFFGAINREF</span></code> or
the <code class="docutils literal notranslate"><span class="pre">DIFFGAINSRC</span></code> intent, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dg_refspws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">)</span>
<span class="n">dg_srcspws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="spectral-window-mapping-in-pipeline">
<h2>Spectral Window mapping in Pipeline<a class="headerlink" href="#spectral-window-mapping-in-pipeline" title="Link to this heading"></a></h2>
<p>Various calibration heuristics in Pipeline require spectral window mapping, as supported by the <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> parameter in
various CASA tasks such as <code class="docutils literal notranslate"><span class="pre">applycal</span></code>, <code class="docutils literal notranslate"><span class="pre">gaincal</span></code>, <code class="docutils literal notranslate"><span class="pre">bandpass</span></code>, <code class="docutils literal notranslate"><span class="pre">polcal</span></code>. Here, the <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> is a simple list of integers,
where the index of the list corresponds to the target SpW ID in the MeasurementSet (i.e. the SpW you want to calibrate)
and the value in the list corresponds to the SpW ID in the calibration table whose solution should be applied to that
target SpW ID.</p>
<p>If spwmap is unspecified or an empty list, it signifies that each SpW ID is mapped to itself, i.e. no SpW re-mapping or
combination.</p>
<p>In some cases, typically when a calibrator has low SNR in one or more SpWs, the Pipeline can derive a SpW re-mapping
to map the calibration from a higher SNR SpW to the target SpWs where the calibrator had low SNR. In cases where a
calibrator has too low SNR in all SpWs, the Pipeline can decide to use spectral window combination instead, whereby
the SpWs-to-combine are all re-mapped to the lowest SpW ID among the SpWs-to-combine, and the CASA task using this
spwmap should be passed <code class="docutils literal notranslate"><span class="pre">combine=True</span></code> (which is otherwise False by default).</p>
<p>Pipeline has implemented SpW-to-SpW mapping heuristics for a number of distinct use-cases:</p>
<ul class="simple">
<li><p>Tsys-SpW to target SpW mapping</p></li>
<li><p>Phase-offset gaincal calibrator SpW to target SpW mapping</p></li>
<li><p>Diffgain reference SpW to diffgain on-source SpW mapping</p></li>
</ul>
<section id="tsys-spw-to-target-spw-mapping">
<h3>Tsys SpW to target SpW mapping<a class="headerlink" href="#tsys-spw-to-target-spw-mapping" title="Link to this heading"></a></h3>
<p>The Tsys spectral window to target (science) spectral window mapping is defined in <code class="docutils literal notranslate"><span class="pre">h.heuristics.tsysspwmap.tsysspwmap</span></code>.</p>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> is primarily used in the <code class="docutils literal notranslate"><span class="pre">h_tsyscal</span></code> task that creates and registers the Tsys calibration.
This task first creates the Tsys caltable and then creates the <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> that maps each target SpW to its appropriate Tsys
SpW. This <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> is then used in the step that creates the <code class="docutils literal notranslate"><span class="pre">CalApplications</span></code> that will register (in the callibrary)
how the Tsys caltable should be applied to the measurement set. Any subsequent task downstream that needs to (pre-)apply
the calibrations (e.g. <code class="docutils literal notranslate"><span class="pre">gaincal</span></code>, <code class="docutils literal notranslate"><span class="pre">applycal</span></code>) would then apply this Tsys caltable with the correct value of <code class="docutils literal notranslate"><span class="pre">spwmap</span></code>.</p>
<p>Note: a secondary use of <code class="docutils literal notranslate"><span class="pre">h.heuristics.tsysspwmap.tsysspwmap</span></code> occurs in
<code class="docutils literal notranslate"><span class="pre">hifa.heuristics.atm.AtmHeuristics._calculate_median_tsys</span></code>, used only
locally to compute median Tsys per science SpW.</p>
</section>
<section id="phase-offset-gaincal-calibrator-spw-to-target-spw-mapping">
<h3>Phase-offset gaincal calibrator SpW to target SpW mapping<a class="headerlink" href="#phase-offset-gaincal-calibrator-spw-to-target-spw-mapping" title="Link to this heading"></a></h3>
<p>Various stages in ALMA calibration pipeline compute a phase-offset gain calibration table, in many cases even
just a temporary one that is only pre-applied during certain steps in the task without being registered to the
top-level Pipeline context.</p>
<p>To enable consistency in how those phase-offset gain calibrations are applied across various tasks,
ALMA IF calibration pipeline recipes include the <code class="docutils literal notranslate"><span class="pre">hifa_spwphaseup</span></code> stage. This stage evaluates for a number of
calibrator intents (‘AMPLITUDE,BANDPASS,CHECK,DIFFGAINREF,DIFFGAINSRC,PHASE’) and each of their corresponding fields,
what the optimal SpW maps are, based by default on calibrator SNR. See implementation details in
<code class="docutils literal notranslate"><span class="pre">hifa.tasks.spwphaseup.spwphaseup.SpwPhaseup._derive_spwmaps</span></code>, which invokes the <code class="docutils literal notranslate"><span class="pre">hifa.heuristics.phasespwmap</span></code>
to generate the <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> lists for the case of narrow-to-wide (low-to-high-SNR) SpW mapping, or SpW-combination mapping.</p>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> lists are combined into a <code class="docutils literal notranslate"><span class="pre">SpwMapping</span></code> object together with:</p>
<ul class="simple">
<li><p>other recommended values to use: <code class="docutils literal notranslate"><span class="pre">combine</span></code>, <code class="docutils literal notranslate"><span class="pre">solint</span></code>, <code class="docutils literal notranslate"><span class="pre">gaintype</span></code></p></li>
<li><p>extra info such as SNR info / thresholds used in the SpW map derivation</p></li>
</ul>
<p>The primary use-case is <code class="docutils literal notranslate"><span class="pre">combine</span></code>, i.e. whether or not to use SpW combination, which is currently not part of the
<code class="docutils literal notranslate"><span class="pre">CalApplication</span></code>. This is denoted with <code class="docutils literal notranslate"><span class="pre">combine=True</span></code> though in downstream tasks this gets converted to <code class="docutils literal notranslate"><span class="pre">combine='spw'</span></code>
before passing to a CASA task.</p>
<p>These <code class="docutils literal notranslate"><span class="pre">SpwMapping</span></code> are created for each combination of <code class="docutils literal notranslate"><span class="pre">intent,</span> <span class="pre">field</span></code> and stored by that key in a dictionary in the
context (<code class="docutils literal notranslate"><span class="pre">MeasurementSet.spwmaps</span></code>).</p>
<p>Downstream tasks that make use of this <code class="docutils literal notranslate"><span class="pre">SpwMapping</span></code> information include:</p>
<ul class="simple">
<li><p>hifa_gfluxscale: <code class="docutils literal notranslate"><span class="pre">hifa.tasks.fluxscale.gcorfluxscale.SerialGcorFluxscale._get_phasecal_params</span></code></p></li>
<li><p>hifa_gfluxscaleflag: <code class="docutils literal notranslate"><span class="pre">hifa.tasks.gfluxscaleflag.gfluxscaleflag.SerialGfluxscaleflag._get_phasecal_params</span></code></p></li>
<li><p>hifa_timegaincal: <code class="docutils literal notranslate"><span class="pre">hifa.tasks.gainal.timegaincal.SerialTimeGaincal._get_phasecal_params</span></code></p></li>
<li><p>hifa_diffgaincal: <code class="docutils literal notranslate"><span class="pre">hifa.tasks.diffgaincal.diffgaincal._assess_spw_combine_based_on_spwmapping_and_snr</span></code></p></li>
</ul>
<p>Note: each of these tasks may have their own task-specific heuristic for which values from the <code class="docutils literal notranslate"><span class="pre">SpwMapping</span></code>
to adopt.</p>
</section>
<section id="diffgain-reference-spw-to-diffgain-on-source-spw-mapping">
<h3>Diffgain reference SpW to diffgain on-source SpW mapping<a class="headerlink" href="#diffgain-reference-spw-to-diffgain-on-source-spw-mapping" title="Link to this heading"></a></h3>
<p>For band-to-band calibrations, the phase SpW-to-Spw mapping derived in <code class="docutils literal notranslate"><span class="pre">hifa_spwphaseup</span></code> for the <code class="docutils literal notranslate"><span class="pre">PHASE</span></code> calibrator
requires an adjustment to ensure that diffgain on-source SpWs are remapped to an associated diffgain reference SpW.
This kind of diffgain-specific <code class="docutils literal notranslate"><span class="pre">spwmap</span></code> adjustment is implemented in
<code class="docutils literal notranslate"><span class="pre">hifa.heuristics.phasespwmap.update_spwmap_for_band_to_band</span></code>, and is used in <code class="docutils literal notranslate"><span class="pre">hifa_spwphaseup</span></code> and
<code class="docutils literal notranslate"><span class="pre">hifa_diffgaincal</span></code>.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="QA_scores.html" class="btn btn-neutral float-left" title="Pipeline Quality Assurance (QA) Score Class Design" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="python3_conversion_notes.html" class="btn btn-neutral float-right" title="Python 3 conversion notes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2025, Pipeline Dev. Team, build: 2025.1.1.52+248-g7936218f8a-update-docs-build-and-packaging-setup.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>