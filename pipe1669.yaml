############################################################################
#
# setup:
#
#   Install Miniforge3: the recommended minimal Conda installer
#     https://github.com/conda-forge/miniforge
#
#   Step-by-step to reproduce the Pipeline/CASA environment
#     $ git clone https://open-bitbucket.nrao.edu/scm/pipe/pipeline.git --branch PIPE-1669-run-dev-pipeline-with-modular-casa6
#     $ cd pipeline
#     $ mamba env create -f pipe1669.yaml
#
#   Update:
#     $ mamba update -n pipe1669 --all
#     $ mamba env update -f pipe1669.yaml
#
#   Remove:
#     $ mamba env remove -n pipe1669
#     $ mamba remove -n pipe1669 mpi4py
#
# execute:
#     $ mamba activate pipe1669
#     $ xvfb-run -a python run_pipeline.py
#     $ xvfb-run -a mpirun -n 4 python run_pipeline.py
#
# workaround of CAS-14037 (may be out-of-date)
#     put `import casampi.private.start_mpi` into ~/.casa/config.py
#
# aliases:
#     $ export casa_omp_num_threads=8
#     $ export casa_mpi_nproc=8
#     $ alias mcasa='PYTHONNOUSERSITE=1 OMP_NUM_THREADS=${casa_omp_num_threads} python -m casashell --nologger --log2term --nogui --agg'
#     $ alias casampi='PYTHONNOUSERSITE=1 mpirun -n ${casa_mpi_nproc} python -m casashell --nologger --log2term --nogui --agg'
#
# notes for macOS (including M1):
#     * An environment variable (SYSTEM_VERSION_COMPAT=0) might be needed 
#       as the current casatools wheels are built by old macOS SDKs.
#       * https://github.com/microsoft/onnxruntime/issues/17166#issuecomment-1693938597
#     * Because the casatools whl is still being built from the x86 platform, the conda 
#       install architecture needs to be x86_64 (not the arm64). In addition, the Rosetta 2 
#       emulation layer is needed for Apple silicon machines.
#
############################################################################

name: pipe1669

channels:
  - conda-forge
  - defaults

dependencies:
  - conda-ecosystem-user-package-isolation
  - git
  - python=3.8
  - ipython
  - pip
  - numpy
  - matplotlib
  - scipy
  - openmpi
  - mpi4py
  - certifi
  - protobuf=3.20 # casatplotms requires ver<=3.20 at this moment
  - python-casacore # if you want a different I/O option.
  - poppler # required for PL
  - imagemagick # required for PL
  - pip:
    - --extra-index-url https://casa-pip.nrao.edu/repository/pypi-group/simple
    - casatools==6.6.1.8
    - casatasks==6.6.1.8
    - casashell==6.6.1.8
    - casadata
    - casampi
    - almatasks
    - casaplotms
    - -r requirements.txt
    - .