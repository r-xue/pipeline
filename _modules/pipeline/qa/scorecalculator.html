

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.qa.scorecalculator &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.qa.scorecalculator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.qa.scorecalculator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on 9 Jan 2014</span>

<span class="sd">@author: sjw</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Do not evaluate type annotations at definition time.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">erf</span>

<span class="kn">import</span> <span class="nn">pipeline.domain</span> <span class="k">as</span> <span class="nn">domain</span>
<span class="kn">import</span> <span class="nn">pipeline.domain.measures</span> <span class="k">as</span> <span class="nn">measures</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.logging</span> <span class="k">as</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.pipelineqa</span> <span class="k">as</span> <span class="nn">pqa</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.renderer.rendererutils</span> <span class="k">as</span> <span class="nn">rutils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.qa.checksource</span> <span class="k">as</span> <span class="nn">checksource</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.datatable</span> <span class="kn">import</span> <span class="n">OnlineFlagIndex</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.measurementset</span> <span class="kn">import</span> <span class="n">MeasurementSet</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.heuristics.rasterscan</span> <span class="kn">import</span> <span class="n">RasterScanHeuristicsResult</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.imaging.resultobjects</span> <span class="kn">import</span> <span class="n">SDImagingResultItem</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.importdata.importdata</span> <span class="kn">import</span> <span class="n">SDImportDataResults</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pipeline.domain.singledish</span> <span class="kn">import</span> <span class="n">MSReductionGroupMember</span>
    <span class="kn">from</span> <span class="nn">pipeline.hif.tasks.gaincal.common</span> <span class="kn">import</span> <span class="n">GaincalResults</span>
    <span class="kn">from</span> <span class="nn">pipeline.hif.tasks.polcal.polcalworker</span> <span class="kn">import</span> <span class="n">PolcalWorkerResults</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.baseline.baseline</span> <span class="kn">import</span> <span class="n">SDBaselineResults</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.imaging.resultobjects</span> <span class="kn">import</span> <span class="n">SDImagingResultItem</span>
    <span class="kn">from</span> <span class="nn">pipeline.infrastructure.launcher</span> <span class="kn">import</span> <span class="n">Context</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>                                <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_bands&#39;</span><span class="p">,</span>                                     <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_science_spw_names&#39;</span><span class="p">,</span>                         <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_tsysspwmap&#39;</span><span class="p">,</span>                                <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_number_antenna_offsets&#39;</span><span class="p">,</span>                    <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_missing_derived_fluxes&#39;</span><span class="p">,</span>                    <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_derived_fluxes_snr&#39;</span><span class="p">,</span>                        <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_phaseup_spw_median_snr_for_phase&#39;</span><span class="p">,</span>          <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_phaseup_spw_median_snr_for_check&#39;</span><span class="p">,</span>          <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_decoherence_assessment&#39;</span><span class="p">,</span>                    <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_refspw_mapping_fraction&#39;</span><span class="p">,</span>                   <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_missing_phaseup_snrs&#39;</span><span class="p">,</span>                      <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_missing_bandpass_snrs&#39;</span><span class="p">,</span>                     <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_poor_phaseup_solutions&#39;</span><span class="p">,</span>                    <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_poor_bandpass_solutions&#39;</span><span class="p">,</span>                   <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_missing_phase_snrs&#39;</span><span class="p">,</span>                        <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_poor_phase_snrs&#39;</span><span class="p">,</span>                           <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_flagging_view_exists&#39;</span><span class="p">,</span>                      <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_checksources&#39;</span><span class="p">,</span>                              <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_gfluxscale_k_spw&#39;</span><span class="p">,</span>                          <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_fluxservice&#39;</span><span class="p">,</span>                               <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_observing_modes&#39;</span><span class="p">,</span>                           <span class="c1"># ALMA specific</span>
           <span class="s1">&#39;score_renorm&#39;</span><span class="p">,</span>                                    <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_polcal_gain_ratio&#39;</span><span class="p">,</span>                         <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_polcal_gain_ratio_rms&#39;</span><span class="p">,</span>                     <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_polcal_leakage&#39;</span><span class="p">,</span>                            <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_polcal_residual_pol&#39;</span><span class="p">,</span>                       <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_polcal_results&#39;</span><span class="p">,</span>                            <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_file_exists&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_path_exists&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_flags_exist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_mses_exist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_applycmds_exist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_caltables_exist&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_setjy_measurements&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_missing_intents&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_ephemeris_coordinates&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_online_shadow_template_agents&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_lowtrans_flagcmds&#39;</span><span class="p">,</span>                         <span class="c1"># ALMA IF specific</span>
           <span class="s1">&#39;score_applycal_agents&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_vla_agents&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_total_data_flagged&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_total_data_flagged_vla&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_total_data_flagged_vla_bandpass&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_flagged_vla_baddef&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_total_data_vla_delay&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_vla_flux_residual_rms&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_ms_model_data_column_present&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_ms_history_entries_present&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_contiguous_session&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_multiply&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_mom8_fc_image&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_iersstate&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_tsysflagcontamination_contamination_flagged&#39;</span><span class="p">,</span>
           <span class="s1">&#39;score_tsysflagcontamination_external_heuristic&#39;</span><span class="p">]</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># - utility functions --------------------------------------------------------------------------------------------------</span>

<span class="k">def</span> <span class="nf">log_qa</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator that logs QA evaluations as they return with a log level of</span>
<span class="sd">    INFO for scores between perfect and &#39;slightly suboptimal&#39; scores and</span>
<span class="sd">    WARNING for any other level. These messages are meant for pipeline runs</span>
<span class="sd">    without a weblog output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># get the size of the CASA log before task execution</span>
        <span class="n">qascore</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">infrastructure</span><span class="o">.</span><span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">qascore</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">_qascore</span> <span class="o">=</span> <span class="n">qascore</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_qascore</span> <span class="o">=</span> <span class="n">qascore</span>
            <span class="k">if</span> <span class="n">_qascore</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_qascore</span><span class="o">.</span><span class="n">longmsg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_qascore</span><span class="o">.</span><span class="n">longmsg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">qascore</span>

    <span class="k">return</span> <span class="n">f</span>


<span class="c1"># struct to hold flagging statistics</span>
<span class="n">AgentStats</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;AgentStats&quot;</span><span class="p">,</span> <span class="s2">&quot;name flagged total&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">calc_flags_per_agent</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate flagging statistics per agents. If scanids are provided,</span>
<span class="sd">    restrict statistics to just those scans.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flagsum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Go through summary for each agent.</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">summary</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">summaries</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scanids</span><span class="p">:</span>
            <span class="c1"># Add up flagged and total for specified scans.</span>
            <span class="n">flagcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">totalcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">scanid</span> <span class="ow">in</span> <span class="n">scanids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scanid</span> <span class="ow">in</span> <span class="n">summary</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]:</span>
                    <span class="n">flagcount</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">scanid</span><span class="p">][</span><span class="s1">&#39;flagged&#39;</span><span class="p">])</span>
                    <span class="n">totalcount</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">scanid</span><span class="p">][</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add up flagged and total for all data.</span>
            <span class="n">flagcount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;flagged&#39;</span><span class="p">])</span>
            <span class="n">totalcount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">])</span>

        <span class="c1"># From the second summary onwards, subtract counts from the previous</span>
        <span class="c1"># one.</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flagcount</span> <span class="o">-=</span> <span class="n">flagsum</span>

        <span class="c1"># Create agent stats object, append to output.</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">AgentStats</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">summary</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                          <span class="n">flagged</span><span class="o">=</span><span class="n">flagcount</span><span class="p">,</span>
                          <span class="n">total</span><span class="o">=</span><span class="n">totalcount</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>

        <span class="c1"># Keep count of total number of flags found in summaries, for</span>
        <span class="c1"># subsequent summaries.</span>
        <span class="n">flagsum</span> <span class="o">+=</span> <span class="n">flagcount</span>

    <span class="k">return</span> <span class="n">stats</span>


<span class="k">def</span> <span class="nf">calc_frac_total_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total fraction of data that is flagged. If agents are provided,</span>
<span class="sd">    then restrict to statistics for those agents. If scanids are provided,</span>
<span class="sd">    then restrict to statistics for those scans.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">agent_stats</span> <span class="o">=</span> <span class="n">calc_flags_per_agent</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># sum the number of flagged rows for the selected agents</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
        <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">flagged</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">agent_stats</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">agents</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">frac_flagged</span>


<span class="k">def</span> <span class="nf">calc_vla_science_frac_total_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate total fraction of vla science data that is flagged. If agents are provided,</span>
<span class="sd">    then restrict to statistics for those agents. If scanids are provided,</span>
<span class="sd">    then restrict to statistics for those scans.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">agent_stats</span> <span class="o">=</span> <span class="n">calc_flags_per_agent</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># remove the non-sciece vis flagged from the science total</span>
    <span class="k">if</span> <span class="n">agent_stats</span><span class="p">:</span>
        <span class="n">science_total</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">,</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">flagged</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">agent_stats</span>
                                                        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;anos&#39;</span><span class="p">,</span> <span class="s1">&#39;intents&#39;</span><span class="p">,</span>
                                                                      <span class="s1">&#39;shadow&#39;</span><span class="p">)],</span> <span class="n">agent_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>

    <span class="c1"># once we have the new science total, replace it for those agents</span>
    <span class="c1"># and create a new list that only includes &#39;science&#39; agents</span>
    <span class="n">science_agents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">agent_stats</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;anos&#39;</span><span class="p">,</span> <span class="s1">&#39;intents&#39;</span><span class="p">,</span> <span class="s1">&#39;shadow&#39;</span><span class="p">):</span>
            <span class="n">science_agents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AgentStats</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                             <span class="n">flagged</span><span class="o">=</span><span class="n">stat</span><span class="o">.</span><span class="n">flagged</span><span class="p">,</span>
                                             <span class="n">total</span><span class="o">=</span><span class="n">science_total</span><span class="p">))</span>

    <span class="c1"># sum the number of flagged rows for the selected agents</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">flagged</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">science_agents</span>
                                                   <span class="k">if</span> <span class="ow">not</span> <span class="n">agents</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">frac_flagged</span>


<span class="k">def</span> <span class="nf">calc_frac_newly_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fraction of data that is newly flagged, i.e. exclude pre-existing</span>
<span class="sd">    flags (assumed to be represented in first summary). If agents are provided,</span>
<span class="sd">    then restrict to statistics for those agents. If scanids are provided,</span>
<span class="sd">    then restrict to statistics for those scans.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agent_stats</span> <span class="o">=</span> <span class="n">calc_flags_per_agent</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># sum the number of flagged rows for the selected agents</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
        <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">flagged</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">.</span><span class="n">total</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">agent_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">agents</span> <span class="ow">or</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">agents</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">frac_flagged</span>


<span class="k">def</span> <span class="nf">linear_score</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the score for the given data value, assuming the</span>
<span class="sd">    score follows a linear gradient between the low and high values.</span>

<span class="sd">    x values will be clipped to lie within the range x1-&gt;x2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span>

    <span class="n">clipped_x</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x2</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">x2</span><span class="o">-</span><span class="n">x1</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">-</span> <span class="n">m</span><span class="o">*</span><span class="n">x1</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">*</span><span class="n">clipped_x</span> <span class="o">+</span> <span class="n">c</span>


<span class="k">def</span> <span class="nf">score_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">min_frac</span><span class="p">,</span> <span class="n">max_frac</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the agentflagger summaries based on the fraction of</span>
<span class="sd">    data flagged by certain flagging agents. If intents are provided, then</span>
<span class="sd">    restrict scoring to the scans that match one or more of these intents.</span>

<span class="sd">    min_frac &lt; flagged &lt; max_frac maps to score of 1-0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If intents are provided, identify which scans to calculate flagging</span>
    <span class="c1"># fraction for.</span>
    <span class="k">if</span> <span class="n">intents</span><span class="p">:</span>
        <span class="n">scanids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">intents</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">scan_intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scanids</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot restrict QA score to intent(s) </span><span class="si">{}</span><span class="s2">, since no matching scans were found.&quot;</span>
                        <span class="s2">&quot; Score will be based on scans for all intents.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scanids</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_total_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="n">agents</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="n">min_frac</span><span class="p">,</span> <span class="n">max_frac</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">{:.2f}% d</span><span class="s2">ata in </span><span class="si">{}</span><span class="s2"> flagged&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">agents</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">+=</span> <span class="s2">&quot; by </span><span class="si">{}</span><span class="s2"> flagging agents&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">intents</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">+=</span> <span class="s1">&#39; for intent(s): </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_data_flagged_by_agents&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">score_vla_science_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">min_frac</span><span class="p">,</span> <span class="n">max_frac</span><span class="p">,</span> <span class="n">agents</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the agentflagger summaries based on the fraction of</span>
<span class="sd">    VLA science data flagged by certain flagging agents. If intents are provided, then</span>
<span class="sd">    restrict scoring to the scans that match one or more of these intents.</span>

<span class="sd">    min_frac &lt; flagged &lt; max_frac maps to score of 1-0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If intents are provided, identify which scans to calculate flagging</span>
    <span class="c1"># fraction for.</span>
    <span class="k">if</span> <span class="n">intents</span><span class="p">:</span>
        <span class="n">scanids</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">intents</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">scan_intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scanids</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot restrict QA score to intent(s) </span><span class="si">{}</span><span class="s2">, since no matching scans were found.&quot;</span>
                        <span class="s2">&quot; Score will be based on scans for all intents.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scanids</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_vla_science_frac_total_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="n">agents</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="n">min_frac</span><span class="p">,</span> <span class="n">max_frac</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data in </span><span class="si">%s</span><span class="s1"> flagged by </span><span class="si">%s</span><span class="s1"> flagging agents&#39;</span>
               <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">intents</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">+=</span> <span class="s1">&#39; for intent(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_vla_science_data_flagged_by_agents&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

<span class="c1"># - exported scoring functions -----------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="score_ms_model_data_column_present">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_ms_model_data_column_present">[docs]</a>
<span class="k">def</span> <span class="nf">score_ms_model_data_column_present</span><span class="p">(</span><span class="n">all_mses</span><span class="p">,</span> <span class="n">mses_with_column</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give a score for a group of mses based on the number with modeldata</span>
<span class="sd">    columns present.</span>
<span class="sd">    None with modeldata - 100% with modeldata = 1.0 -&gt; 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_with</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses_with_column</span><span class="p">)</span>
    <span class="n">num_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_mses</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_all</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;No MSes were imported&#39;</span><span class="p">,</span> <span class="s1">&#39;No MSes imported&#39;</span><span class="p">)</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_with</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_all</span>

    <span class="k">if</span> <span class="n">mses_with_column</span><span class="p">:</span>
        <span class="c1"># log a message like &#39;No model columns found in a.ms, b.ms or c.ms&#39;</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses_with_column</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">basenames</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Model data column found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> have MODELDATA&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_with</span><span class="p">,</span> <span class="n">num_all</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># log a message like &#39;Model data column was found in a.ms and b.ms&#39;</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">all_mses</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">basenames</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conjunction</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No model data column found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;MODELDATA empty&#39;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_ms_model_data_column_present&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of MSes with modeldata columns present&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_ms_history_entries_present">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_ms_history_entries_present">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_ms_history_entries_present</span><span class="p">(</span><span class="n">all_mses</span><span class="p">,</span> <span class="n">mses_with_history</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give a score for a group of mses based on the number with history</span>
<span class="sd">    entries present.</span>
<span class="sd">    None with history - 100% with history = 1.0 -&gt; 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_with</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses_with_history</span><span class="p">)</span>
    <span class="n">num_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_mses</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">num_all</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;No MSes were imported&#39;</span><span class="p">,</span> <span class="s1">&#39;No MSes imported&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mses_with_history</span><span class="p">:</span>
        <span class="c1"># log a message like &#39;Entries were found in the HISTORY table for</span>
        <span class="c1"># a.ms and b.ms&#39;</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses_with_history</span><span class="p">],</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses_with_history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unexpected entries were found in the HISTORY table of </span><span class="si">%s</span><span class="s1">. &#39;</span>
                       <span class="s1">&#39;This measurement set may already be processed.&#39;</span> <span class="o">%</span> <span class="n">basenames</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Unexpected entries were found in the HISTORY tables of </span><span class="si">%s</span><span class="s1">. &#39;</span>
                       <span class="s1">&#39;These measurement sets may already be processed.&#39;</span> <span class="o">%</span> <span class="n">basenames</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> have HISTORY&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_with</span><span class="p">,</span> <span class="n">num_all</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># log a message like &#39;No history entries were found in a.ms or b.ms&#39;</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">all_mses</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">basenames</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">conjunction</span><span class="o">=</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No HISTORY entries found in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">s</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No HISTORY entries&#39;</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_with</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_all</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_ms_history_entries_present&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of MSes with HISTORY&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_observing_modes">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_observing_modes">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_observing_modes</span><span class="p">(</span><span class="n">mses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">MeasurementSet</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This QA heuristic evaluates a list of measurement sets, creating a QA score</span>
<span class="sd">    for each MS, and returning the aggregate list of QA scores for all MSes.</span>
<span class="sd">    Each MS is scored based on consistency checks between their registered</span>
<span class="sd">    Observing Mode(s) and e.g. the presence of differential gain SpWs / fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        mses: list of measurement sets to score.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of QA scores.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create separate score for each MS.</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="c1"># If the Observing Modes include &quot;band to band&quot;, perform a few validity</span>
        <span class="c1"># checks w.r.t. the presence of DIFFGAIN* fields and diffgain SpW setup:</span>
        <span class="k">if</span> <span class="s1">&#39;BandToBand Interferometry&#39;</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_diffgain_mode</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;B2B&#39;</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Incorrect Observing Mode&#39;</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Incorrect BandToBand Observing Mode, </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1"> does not contain a DIFFGAIN* intent&#39;</span> \
                          <span class="sa">f</span><span class="s1">&#39; and/or SpW setup consistent with band-to-band.&#39;</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s2">&quot;DIFFGAINREF,DIFFGAINSRC&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Too many DIFFGAIN* fields&#39;</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unable to process BandToBand dataset </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, found more than 1 DIFFGAIN* field&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;BandToBand mode used&#39;</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BandToBand mode used in </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># If the Observing Modes do not include &quot;band to band&quot;, but the MS</span>
        <span class="c1"># contains a DIFFGAIN* intent and a SpW setup consistent with</span>
        <span class="c1"># band-to-band, then lower the score.</span>
        <span class="k">elif</span> <span class="s1">&#39;BandToBand Interferometry&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span> <span class="ow">and</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_diffgain_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;B2B&#39;</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Incorrect Observing Mode&#39;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Incorrect Observing Mode, unexpectedly found a BandToBand DIFFGAIN* intent in </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># If the Observing Modes include &quot;bandwidth switching&quot;, then lower the</span>
        <span class="c1"># score, since processing these data has not yet been validated.</span>
        <span class="k">elif</span> <span class="s1">&#39;BandwidthSwitching Interferometry&#39;</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;BandwidthSwitching mode used&#39;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;BandwidthSwitching mode used in </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># If all validity checks are passed, score the MS as ok.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Observing mode(s) ok.&#39;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Observing mode(s) ok for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># Append score for current MS.</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_observing_modes&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on the observing modes&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span></div>



<div class="viewcode-block" id="score_bands">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_bands">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_bands</span><span class="p">(</span><span class="n">mses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a MeasurementSet object based on the presence of</span>
<span class="sd">    ALMA bands with calibration issues.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># ALMA receiver bands. Warnings will be raised for any</span>
    <span class="c1"># measurement sets containing the following bands.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">score_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;9&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                 <span class="s1">&#39;10&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">}</span>

    <span class="n">unsupported</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">num_mses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses</span><span class="p">)</span>
    <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">complaints</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># analyse each MS</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="n">msbands</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">bandnum</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">msbands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bandnum</span><span class="p">)</span>
        <span class="n">msbands</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">msbands</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">unsupported</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">msbands</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">overlap</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">score_map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_mses</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> contains band </span><span class="si">%s</span><span class="s1"> data&#39;</span>
                   <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">overlap</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
        <span class="n">complaints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longmsg</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_ok</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;No high frequency </span><span class="si">%s</span><span class="s1"> band data were found in </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unsupported</span><span class="p">),</span>
                   <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">],</span> <span class="kc">False</span><span class="p">)))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No high frequency band data found&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">complaints</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;High frequency band data found&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_bands&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of high-frequency data&#39;</span><span class="p">)</span>

    <span class="c1"># Make score linear</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_parallactic_range</span><span class="p">(</span>
        <span class="n">pol_intents_present</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coverage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a session based on parallactic angle coverage.</span>

<span class="sd">    Issues a warning if the parallactic coverage &lt; threshold. See PIPE-597</span>
<span class="sd">    for full spec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># holds the final list of QA scores</span>
    <span class="n">scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># are polarisation intents expected? true if pol recipe, false if not</span>
    <span class="c1"># Polcal detected in session (this function was called!) but this is not a</span>
    <span class="c1"># polcal recipe, hence nothing to check</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pol_intents_present</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No polarisation intents detected. No parallactic angle coverage check required for session &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Parallactic angle&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span>
            <span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;ScoreParallacticAngle&#39;</span><span class="p">,</span>
            <span class="n">metric_score</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span>
        <span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                            <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span>
                            <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="n">session_name</span><span class="p">}))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">score</span><span class="p">]</span>

    <span class="c1"># accordion message if coverage is adequate</span>
    <span class="k">if</span> <span class="n">coverage</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Sufficient parallactic angle coverage (</span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\u00B0</span><span class="s1"> &gt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\u00B0</span><span class="s1">) for &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;polarisation calibrator </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1"> in session </span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Parallactic angle&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span>
            <span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;ScoreParallacticAngle&#39;</span><span class="p">,</span>
            <span class="n">metric_score</span><span class="o">=</span><span class="n">coverage</span><span class="p">,</span>
            <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span>
        <span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                            <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span>
                            <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="n">session_name</span><span class="p">}))</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># complain with a banner message if coverage is insufficient</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Insufficient parallactic angle coverage (</span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\u00B0</span><span class="s1"> &lt; </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\u00B0</span><span class="s1">) for &#39;</span>
                   <span class="sa">f</span><span class="s1">&#39;polarisation calibrator </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1"> in session </span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Parallactic angle&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span>
            <span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;ScoreParallacticAngle&#39;</span><span class="p">,</span>
            <span class="n">metric_score</span><span class="o">=</span><span class="n">coverage</span><span class="p">,</span>
            <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span>
        <span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                            <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">BANNER</span><span class="p">,</span>
                            <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="p">{</span><span class="n">session_name</span><span class="p">}))</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>


<div class="viewcode-block" id="score_polintents">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polintents">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polintents</span><span class="p">(</span><span class="n">recipe_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a MeasurementSet object based on the presence of</span>
<span class="sd">    polarization intents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pol_intents</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">}</span>
    <span class="c1"># these recipes are allowed to process polarisation data</span>
    <span class="n">pol_recipes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hifa_polcal&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_polcalimage&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_polcal_renorm&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_polcalimage_renorm&#39;</span><span class="p">}</span>

    <span class="c1"># Sort to ensure presentation consistency</span>
    <span class="n">mses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

    <span class="c1"># are polarisation intents expected? true if pol recipe, false if not</span>
    <span class="n">pol_intents_expected</span> <span class="o">=</span> <span class="n">recipe_name</span> <span class="ow">in</span> <span class="n">pol_recipes</span>

    <span class="c1"># holds the final list of QA scores</span>
    <span class="n">scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Spec from PIPE-606:</span>
    <span class="c1">#</span>
    <span class="c1"># Currently, hifa_importdata sets the score of that stage to 0 if a</span>
    <span class="c1"># polarization calibrator is found (in qa/scorecalculator.py). This score</span>
    <span class="c1"># should now become 1 if one of these recipes is being run, or 0.5 if any</span>
    <span class="c1"># other recipe is being run.</span>

    <span class="c1"># analyse each MS, recording an accordion warning if there&#39;s an unexpected</span>
    <span class="c1"># pol calibrator</span>

    <span class="k">if</span> <span class="n">pol_intents_expected</span><span class="p">:</span>
        <span class="n">pol_intents_present</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">pol_intents</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">])</span>

        <span class="n">ms_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">}</span>
        <span class="n">mses_for_msg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ms_names</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># and an &#39;all OK&#39; accordion message if pol scans were expected and found</span>
        <span class="k">if</span> <span class="n">pol_intents_present</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Polarization calibrations expected and found: </span><span class="si">{</span><span class="n">mses_for_msg</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Polarization calibrators&#39;</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of polarisation data&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                                <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span>
                                <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">ms_names</span><span class="p">))</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="c1"># and complain with a banner message if they weren&#39;t. Perhaps this</span>
        <span class="c1"># should be part of score_missing_intents?</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Expected polarization calibrations not found in </span><span class="si">{</span><span class="n">mses_for_msg</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Polarization calibrators&#39;</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of polarisation data&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                                <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">BANNER</span><span class="p">,</span>
                                <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">ms_names</span><span class="p">))</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scores</span>

    <span class="c1"># so, pol data not expected. Find any problem scans and record an accordion warning</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="n">pol_intents_in_ms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pol_intents</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">intents</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">pol_intents_in_ms</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1"> contains polarization calibrations: </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">pol_intents_in_ms</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Polarization intents&#39;</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of polarisation data&#39;</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                                <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span>
                                <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># if there are accordion warnings, summarise them in a banner warning too</span>
    <span class="k">if</span> <span class="n">scores</span><span class="p">:</span>
        <span class="n">affected_mses</span> <span class="o">=</span> <span class="p">{</span><span class="n">score</span><span class="o">.</span><span class="n">applies_to</span><span class="o">.</span><span class="n">vis</span> <span class="k">for</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">scores</span><span class="p">}</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Unexpected polarization calibrations in </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">affected_mses</span><span class="p">,</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Polarization intents&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of polarisation data&#39;</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                            <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">BANNER</span><span class="p">,</span>
                            <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">affected_mses</span><span class="p">))</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># Add an &#39;all OK&#39; accordion message if no unexpected intents detected</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scores</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pol_intents_expected</span><span class="p">:</span>
        <span class="n">ms_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">}</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No polarization calibrations found: </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ms_names</span><span class="p">),</span><span class="w"> </span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No polarization calibrators&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polintents&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;MS score based on presence of polarisation data&#39;</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                            <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span>
                            <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">ms_names</span><span class="p">))</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_samecalobjects</span><span class="p">(</span><span class="n">recipe_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if BP/Phcal/Ampcal are all the same object and score appropriately</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alma_recipes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;hifa_cal&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_calimage&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_calsurvey&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa&quot;image&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_polcal&#39;</span><span class="p">,</span> <span class="s1">&#39;hifa_polcalimage&#39;</span><span class="p">}</span>

    <span class="c1"># Sort to ensure presentation consistency</span>
    <span class="n">mses</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

    <span class="c1"># We are just considering ALMA recipes.   True if an ALMA recipe, false if not</span>
    <span class="n">alma_recipes_expected</span> <span class="o">=</span> <span class="n">recipe_name</span> <span class="ow">in</span> <span class="n">alma_recipes</span>

    <span class="c1"># holds the final list of QA scores</span>
    <span class="n">scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">alma_recipes_expected</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
            <span class="c1"># Get list of calibrator names</span>
            <span class="n">calfields</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE,PHASE,BANDPASS&#39;</span><span class="p">)</span>
            <span class="n">calfieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">calfields</span><span class="p">]</span>

            <span class="c1"># Check for any duplicate names in the list of calibrator field names</span>
            <span class="c1"># samefieldnames = all(element == calfieldnames[0] for element in calfieldnames)</span>
            <span class="n">samefieldnames</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">calfieldnames</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">calfieldnames</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">samefieldnames</span><span class="p">:</span>
                <span class="n">scorevalue</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Some calibrators are the same object.&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scorevalue</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Calibrators are different objects.&quot;</span>

            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_samecalobjects&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="n">scorevalue</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;samecalobjects&#39;</span><span class="p">)</span>

            <span class="n">score</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">scorevalue</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

            <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>


<div class="viewcode-block" id="score_missing_intents">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_missing_intents">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_missing_intents</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">array_type</span><span class="o">=</span><span class="s1">&#39;ALMA_12m&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a MeasurementSet object based on the presence of certain</span>
<span class="sd">    observing intents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Required calibration intents. Warnings will be raised for any</span>
    <span class="c1"># measurement sets missing these intents</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">array_type</span> <span class="o">==</span> <span class="s1">&#39;ALMA_TP&#39;</span><span class="p">:</span>
        <span class="n">score_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">array_type</span> <span class="o">==</span> <span class="s1">&#39;VLA&#39;</span><span class="p">:</span>
        <span class="n">score_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PHASE&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="c1"># &#39;FLUX&#39;: -1.0,</span>
            <span class="c1"># CALIBRATE_FLUX and CALIBRATE_AMPLITUDE are both associated to &#39;AMPLITUDE&#39;</span>
            <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;PHASE&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="s1">&#39;BANDPASS&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.7</span>
        <span class="p">}</span>

    <span class="n">required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">score_map</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">num_mses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses</span><span class="p">)</span>
    <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">complaints</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># hold names of MSes this QA will be applicable to</span>
    <span class="n">applies_to</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># analyse each MS</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="c1"># do we have the necessary calibrators?</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">intents</span><span class="p">):</span>
            <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="n">score_map</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_mses</span><span class="p">)</span>

            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is missing </span><span class="si">%s</span><span class="s1"> calibration intents&#39;</span>
                       <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">missing</span><span class="p">,</span> <span class="kc">False</span><span class="p">)))</span>
            <span class="n">complaints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longmsg</span><span class="p">)</span>

            <span class="n">applies_to</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_ok</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;All required calibration intents were found in &#39;</span>
                   <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;All calibrators found&#39;</span>
        <span class="n">applies_to</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">complaints</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Calibrators missing&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_intents&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Score based on missing calibration intents&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="score_ephemeris_coordinates">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_ephemeris_coordinates">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_ephemeris_coordinates</span><span class="p">(</span><span class="n">mses</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a MeasurementSet object based on the presence of possible</span>
<span class="sd">    ephemeris coordinates.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">num_mses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses</span><span class="p">)</span>
    <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">complaints</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">zero_direction</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="s1">&#39;j2000&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0deg&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0deg&#39;</span><span class="p">)</span>
    <span class="n">zero_ra</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">formxxx</span><span class="p">(</span><span class="n">zero_direction</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;hms&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">zero_dec</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">formxxx</span><span class="p">(</span><span class="n">zero_direction</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;dms&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># analyse each MS</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="c1"># Examine each source</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">ra</span> <span class="o">==</span> <span class="n">zero_ra</span> <span class="ow">and</span> <span class="n">source</span><span class="o">.</span><span class="n">dec</span> <span class="o">==</span> <span class="n">zero_dec</span><span class="p">:</span>
                <span class="n">all_ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">score</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_mses</span><span class="p">)</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Suspicious source coordinates for  </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">. Check whether position of &#39;</span>
                           <span class="s1">&#39;00:00:00.0+00:00:00.0 is valid.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">complaints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">longmsg</span><span class="p">)</span>
                <span class="n">applies_to</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">all_ok</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;All source coordinates OK in &#39;</span>
                   <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;All source coordinates OK&#39;</span>
        <span class="n">applies_to</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">complaints</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Suspicious source coordinates&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_ephemeris_coordinates&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Score based on presence of ephemeris coordinates&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
        <span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">score</span><span class="p">),</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="score_online_shadow_template_agents">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_online_shadow_template_agents">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_online_shadow_template_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a score for the fraction of data flagged by online, shadow, and template agents.</span>

<span class="sd">    0 &lt; score &lt; 1 === 60% &lt; frac_flagged &lt; 5%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span>
                                         <span class="n">agents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="s1">&#39;shadow&#39;</span><span class="p">,</span> <span class="s1">&#39;qa0&#39;</span><span class="p">,</span> <span class="s1">&#39;qa2&#39;</span><span class="p">,</span> <span class="s1">&#39;before&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">])</span>

    <span class="n">new_origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_online_shadow_template_agents&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">metric_score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged by online, shadow, and template agents&#39;</span><span class="p">)</span>
    <span class="n">score</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">new_origin</span>

    <span class="k">return</span> <span class="n">score</span></div>



<div class="viewcode-block" id="score_lowtrans_flagcmds">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_lowtrans_flagcmds">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_lowtrans_flagcmds</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a score for data flagged by the low transmission agent.</span>

<span class="sd">    Heuristic from PIPE-624: search for SpW(s) flagged for low transmission,</span>
<span class="sd">    and set score to:</span>
<span class="sd">    * 1 if no SpWs are flagged.</span>
<span class="sd">    * red warning threshold if the representative SpW is flagged, or otherwise,</span>
<span class="sd">    * blue suboptimal threshold if any non-representative SpW is flagged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search in flag commands for SpW(s) flagged for low transmission.</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flagcmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">flagcmds</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;low_transmission&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">flagcmd</span> <span class="ow">in</span> <span class="n">flagcmds</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;spw=&#39;(\d*)&#39;&quot;</span><span class="p">,</span> <span class="n">flagcmd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># If successful in finding SpWs that were flagged for low transmission,</span>
    <span class="c1"># then create a score that depends on whether the representative SpW was</span>
    <span class="c1"># among those flagged.</span>
    <span class="k">if</span> <span class="n">spws</span><span class="p">:</span>
        <span class="c1"># Get representative SpW for MS.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">rspw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_representative_source_spw</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rspw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_ERROR</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Representative SpW </span><span class="si">{</span><span class="n">rspw</span><span class="si">}</span><span class="s2"> flagged for low transmission&quot;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Representative SpW flagged for low transmission&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Non-representative SpW(s) </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">spws</span><span class="p">)</span><span class="si">}</span><span class="s2"> flagged for low transmission&quot;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Non-representative SpW(s) flagged for low transmission&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;No SpW(s) flagged for low transmission&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;No SpW(s) flagged for low transmission&quot;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_lowtrans&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;SpW(s) flagged by low transmission agent.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_vla_agents">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_vla_agents">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_vla_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a score for the fraction of data flagged by online, shadow, and template agents.</span>

<span class="sd">    0 &lt; score &lt; 1 === 60% &lt; frac_flagged &lt; 5%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score_vla_science_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="s1">&#39;online&#39;</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;autocorr&#39;</span><span class="p">,</span> <span class="s1">&#39;edgespw&#39;</span><span class="p">,</span>
                                                      <span class="s1">&#39;clip&#39;</span><span class="p">,</span> <span class="s1">&#39;quack&#39;</span><span class="p">,</span> <span class="s1">&#39;baseband&#39;</span><span class="p">])</span>

    <span class="n">new_origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_vla_agents&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">metric_score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged by online, shadow, and template agents&#39;</span><span class="p">)</span>
    <span class="n">score</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">new_origin</span>

    <span class="k">return</span> <span class="n">score</span></div>



<div class="viewcode-block" id="score_applycal_agents">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_applycal_agents">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_applycal_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a score for the fraction of data flagged by applycal agents.</span>

<span class="sd">    0 &lt; score &lt; 1 === 60% &lt; frac_flagged &lt; 5%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agents</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;applycal&#39;</span><span class="p">]</span>
    <span class="n">intents</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">]</span>

    <span class="c1"># Get score for &#39;applycal&#39; agent and &#39;TARGET&#39; intent.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">score_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="n">agents</span><span class="o">=</span><span class="n">agents</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="n">intents</span><span class="p">)</span>
    <span class="n">perc_flagged</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">score</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">metric_score</span>

    <span class="c1"># Get score for all agents (total) for &#39;TARGET&#39; intent.</span>
    <span class="n">dummy_score</span> <span class="o">=</span> <span class="n">score_data_flagged_by_agents</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TARGET&#39;</span><span class="p">])</span>
    <span class="n">total_perc_flagged</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">dummy_score</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>

    <span class="c1"># Recreate the long message from the applycal score to also mention the total</span>
    <span class="c1"># percentage flagged.</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;For </span><span class="si">{}</span><span class="s2">, intent(s): </span><span class="si">{}</span><span class="s2">, </span><span class="si">{:.2f}% o</span><span class="s2">f the data was newly flagged by </span><span class="si">{}</span><span class="s2"> flagging agents, for a total of&quot;</span>
               <span class="s2">&quot; </span><span class="si">{:.2f}% f</span><span class="s2">lagged.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">perc_flagged</span><span class="p">,</span>
                                          <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">agents</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">total_perc_flagged</span><span class="p">))</span>
    <span class="n">score</span><span class="o">.</span><span class="n">longmsg</span> <span class="o">=</span> <span class="n">longmsg</span>

    <span class="c1"># Update origin.</span>
    <span class="n">new_origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_applycal_agents&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">metric_score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="n">score</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">metric_units</span><span class="p">)</span>
    <span class="n">score</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">new_origin</span>

    <span class="k">return</span> <span class="n">score</span></div>



<div class="viewcode-block" id="score_total_data_flagged">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_total_data_flagged">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_total_data_flagged</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">summaries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the total fraction of</span>
<span class="sd">    data flagged.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-50% flagged  -&gt; 0.5</span>
<span class="sd">    50-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_total_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_total_data_flagged&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Total fraction of data that is flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_total_data_flagged_vla">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_total_data_flagged_vla">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_total_data_flagged_vla</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">summaries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the total fraction of</span>
<span class="sd">    data flagged.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-60% flagged  -&gt; 1 to 0</span>
<span class="sd">    60-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_newly_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_total_data_flagged_vla&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Total fraction of VLA data that is flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_total_data_flagged_vla_bandpass">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_total_data_flagged_vla_bandpass">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_total_data_flagged_vla_bandpass</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">frac_flagged</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the data flagged in the bandpass table.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-60% flagged  -&gt; 1 to 0</span>
<span class="sd">    60-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_total_data_flagged_vla_bandpass&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Total fraction of VLA data that is flagged in the caltable&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_flagged_vla_baddef">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_flagged_vla_baddef">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_flagged_vla_baddef</span><span class="p">(</span><span class="n">amp_collection</span><span class="p">,</span> <span class="n">phase_collection</span><span class="p">,</span> <span class="n">num_antennas</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the number of antennas flagged.</span>

<span class="sd">    0% flagged   -&gt; 1</span>
<span class="sd">    0%-30% flagged  -&gt; 1 to 0</span>
<span class="sd">    30%-100% flagged -&gt; 0</span>

<span class="sd">    frac_flagged -- fraction of antennas flagged</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">amp_antennas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">amp_collection</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">phase_antennas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">phase_collection</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">affected_antennas</span> <span class="o">=</span> <span class="n">amp_antennas</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">phase_antennas</span><span class="p">)</span>
    <span class="n">num_affected_antennas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">affected_antennas</span><span class="p">)</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">num_affected_antennas</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_antennas</span><span class="p">)</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_flagged_vla_baddef&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of VLA antennas flagged by hifv_flagbaddef&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">==</span> <span class="n">frac_flagged</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="s1">&#39;No antennas flagged&#39;</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="s1">&#39;No antennas flagged&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Convert fraction of flagged data into a score.</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># Set score messages and origin.</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2"> of </span><span class="si">{:d}</span><span class="s2"> (</span><span class="si">{:0.2f}</span><span class="s2">%) antennas affected and some of their spws are flagged&quot;</span> \
                  <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_affected_antennas</span><span class="p">,</span> <span class="n">num_antennas</span><span class="p">,</span> <span class="n">percent</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{:0.2f}% a</span><span class="s2">ntennas affected&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">countbaddelays</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">delaytable</span><span class="p">,</span> <span class="n">delaymax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Args:</span>
<span class="sd">        m: measurement set object</span>
<span class="sd">        delaytable: Delay caltable</span>
<span class="sd">        delaymax: units of ns.  If delay is over this value, it could be added to the dictionary</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with antenna name as key</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">delaydict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">delaytable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ispw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
            <span class="c1"># byspw table must be written to disk in outer layer to avoid &#39;Table does not exist&#39; error</span>
            <span class="n">tbspw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s1">&#39;SPECTRAL_WINDOW_ID==&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ispw</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;byspw&#39;</span><span class="p">)</span>
            <span class="n">ants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tbspw</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">iant</span> <span class="ow">in</span> <span class="n">ants</span><span class="p">:</span>
                <span class="n">tbant</span> <span class="o">=</span> <span class="n">tbspw</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">query</span><span class="o">=</span><span class="s1">&#39;ANTENNA1==&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iant</span><span class="p">))</span>
                <span class="n">absdel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">tbant</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FPARAM&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">absdel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">delaymax</span><span class="p">:</span>
                    <span class="n">antname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">iant</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">delaydict</span><span class="p">[</span><span class="n">antname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">absdel</span> <span class="o">&gt;</span> <span class="n">delaymax</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Spw=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ispw</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Ant=&#39;</span> <span class="o">+</span> <span class="n">antname</span>
                             <span class="o">+</span> <span class="s1">&#39;  Delays greater than 200 ns =&#39;</span>
                             <span class="o">+</span> <span class="nb">str</span><span class="p">((</span><span class="n">absdel</span> <span class="o">&gt;</span> <span class="n">delaymax</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
                <span class="n">tbant</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">tbspw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># clean up byspw table after each iteration</span>
            <span class="n">byspw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;/byspw&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">byspw</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">byspw</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">delaydict</span>


<div class="viewcode-block" id="score_total_data_vla_delay">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_total_data_vla_delay">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_total_data_vla_delay</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use a filename of a delay (K-type) calibration table</span>
<span class="sd">    Calculate a score for antennas with a delay &gt; 200 ns</span>
<span class="sd">    For each antenna with delays &gt; 200 ns, reduce score by 0.1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
        <span class="n">fpar</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FPARAM&#39;</span><span class="p">)</span>
        <span class="n">delays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fpar</span><span class="p">)</span>  <span class="c1"># Units of nanoseconds</span>
        <span class="n">maxdelay</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delays</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">maxdelay</span> <span class="o">&lt;</span> <span class="mf">200.0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For each antenna with a delay &gt; 200.0 ns, deduct 0.1 from the score</span>
        <span class="n">delaydict</span> <span class="o">=</span> <span class="n">countbaddelays</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">)</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">delaydict</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">count</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Set score message and origin</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Max delay is </span><span class="si">{!s}</span><span class="s1"> ns&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">maxdelay</span><span class="p">))</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="n">longmsg</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_total_data_vla_delay&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Delays that exceed 200 ns&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_vla_flux_residual_rms">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_vla_flux_residual_rms">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_vla_flux_residual_rms</span><span class="p">(</span><span class="n">fractional_residuals</span><span class="p">,</span> <span class="n">num_spws</span><span class="p">,</span> <span class="n">spixl</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    score_vla_flux_residual_rms: calculates the score for pipeline task hifv_fluxboot</span>

<span class="sd">    output: returns QAscore</span>
<span class="sd">    --------- parameter descriptions ---------------------------------------------</span>
<span class="sd">    fractional_residuals: Take the RMS values of the residuals.</span>
<span class="sd">    nums_spws: number of spws</span>
<span class="sd">    spixl: list of a spectral index</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># PIPE-119, part a</span>
    <span class="n">max_res</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">fractional_residuals</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_res</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">max_res</span>

    <span class="c1"># PIPE-119 part b</span>
    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">fractional_residuals</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res</span><span class="p">))</span><span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Fractional residuals are &gt; 0.3&quot;</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="c1"># PIPE-119 part c</span>
    <span class="n">bool_spix</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span> <span class="k">if</span> <span class="nb">eval</span><span class="p">(</span><span class="n">spix</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">3</span> <span class="ow">or</span> <span class="nb">eval</span><span class="p">(</span><span class="n">spix</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">spix</span> <span class="ow">in</span> <span class="n">spixl</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">num_spws</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">bool_spix</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;spix for a band/s is &lt;-3 or &gt;2, reducing score by 0.5&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># Set score message and origin</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Max rms of the residuals is </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_res</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No max rms.&#39;</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="n">longmsg</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_vla_flux_residual_rms&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;rms values that exceed 0.01&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_fraction_newly_flagged</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the fraction of</span>
<span class="sd">    data newly flagged.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-50% flagged  -&gt; 0.5</span>
<span class="sd">    50-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_newly_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was newly flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fraction_newly_flagged&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data that is newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">linear_score_fraction_newly_flagged</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the fraction of</span>
<span class="sd">    data newly flagged.</span>

<span class="sd">    fraction flagged   -&gt; score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate fraction of flagged data.</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_newly_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="c1"># Convert fraction of flagged data into a score.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_flagged</span>

    <span class="c1"># Set score messages and origin.</span>
    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was newly flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;linear_score_fraction_newly_flagged&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data that is newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">linear_score_fraction_unflagged_newly_flagged_for_intent</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">summaries</span><span class="p">,</span> <span class="n">intent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the fraction of unflagged</span>
<span class="sd">    data for scans belonging to specified intent that got newly flagged.</span>

<span class="sd">    If no unflagged data was found in the before summary, then return a score</span>
<span class="sd">    of 0.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Identify scan IDs belonging to intent.</span>
    <span class="n">scanids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">scan_intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)]</span>

    <span class="c1"># Calculate flags for scans belonging to intent.</span>
    <span class="n">agent_stats</span> <span class="o">=</span> <span class="n">calc_flags_per_agent</span><span class="p">(</span><span class="n">summaries</span><span class="p">,</span> <span class="n">scanids</span><span class="o">=</span><span class="n">scanids</span><span class="p">)</span>

    <span class="c1"># Calculate counts of unflagged data.</span>
    <span class="n">unflaggedcount</span> <span class="o">=</span> <span class="n">agent_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">total</span> <span class="o">-</span> <span class="n">agent_stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flagged</span>

    <span class="c1"># If the &quot;before&quot; summary had unflagged data, then proceed to compute</span>
    <span class="c1"># the fraction fo unflagged data that got newly flagged.</span>
    <span class="k">if</span> <span class="n">unflaggedcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
                                        <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">flagged</span><span class="p">)</span><span class="o">/</span><span class="n">unflaggedcount</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">agent_stats</span><span class="p">[</span><span class="mi">1</span><span class="p">:]],</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_flagged</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.2f}% o</span><span class="s1">f unflagged data with intent </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1"> was newly &#39;</span> \
                  <span class="s1">&#39;flagged.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.2f}% u</span><span class="s1">nflagged data flagged.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;linear_score_fraction_unflagged_newly_flagged_for_intent&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of unflagged data for intent &#39;</span>
                                           <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> that is newly flagged&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intent</span><span class="p">))</span>
    <span class="c1"># If no unflagged data was found at the start, return score of 0.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No unflagged data with intent </span><span class="si">{}</span><span class="s1"> found in </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No unflagged data.&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;linear_score_fraction_unflagged_newly_flagged_for_intent&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Presence of unflagged data.&#39;</span><span class="p">)</span>

    <span class="c1"># Append extra warning to QA message if score falls at-or-below the &quot;warning&quot; threshold.</span>
    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_WARNING</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">+=</span> <span class="s1">&#39; Please investigate!&#39;</span>
        <span class="n">shortmsg</span> <span class="o">+=</span> <span class="s1">&#39; Please investigate!&#39;</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<div class="viewcode-block" id="score_contiguous_session">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_contiguous_session">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_contiguous_session</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether measurement sets are contiguous in time.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># only need to check when given multiple measurement sets</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mses</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_contiguous_session&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Non-contiguous measurement sets present&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                           <span class="n">longmsg</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> forms one continuous observing session.&#39;</span> <span class="o">%</span> <span class="n">mses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                           <span class="n">shortmsg</span><span class="o">=</span><span class="s1">&#39;Unbroken observing session&#39;</span><span class="p">,</span>
                           <span class="n">vis</span><span class="o">=</span><span class="n">mses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                           <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># reorder MSes by start time</span>
    <span class="n">by_start</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>

    <span class="c1"># create an interval for each one, including our tolerance</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">by_start</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">TimeInterval</span><span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">end</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">)</span>
        <span class="n">intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>

    <span class="c1"># check whether the intervals overlap</span>
    <span class="n">bad_mses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">interval1</span><span class="p">,</span> <span class="n">interval2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">interval1</span><span class="o">.</span><span class="n">overlaps</span><span class="p">(</span><span class="n">interval2</span><span class="p">):</span>
            <span class="n">bad_mses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">by_start</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                           <span class="n">by_start</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">bad_mses</span><span class="p">:</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">bad_mses</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Measurement sets </span><span class="si">%s</span><span class="s1"> are not contiguous. They may be &#39;</span>
                   <span class="s1">&#39;miscalibrated as a result.&#39;</span> <span class="o">%</span> <span class="n">basenames</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Gaps between observations&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">basenames</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">])</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Measurement sets </span><span class="si">%s</span><span class="s1"> are contiguous.&#39;</span> <span class="o">%</span> <span class="n">basenames</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Unbroken observing session&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_contiguous_session&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">bad_mses</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Non-contiguous measurement sets present&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_wvrgcal</span><span class="p">(</span><span class="n">ms_name</span><span class="p">,</span> <span class="n">dataresult</span><span class="p">):</span>

    <span class="n">wvr_score</span> <span class="o">=</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">qa_wvr</span><span class="o">.</span><span class="n">overall_score</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">wvr_score</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># create lists for disc, rms, and flagged antennas checks</span>
    <span class="n">disc_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">rms_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">flagant_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">WVRinfo</span> <span class="ow">in</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">wvr_infos</span><span class="p">:</span>
        <span class="n">disc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WVRinfo</span><span class="o">.</span><span class="n">disc</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">rms_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WVRinfo</span><span class="o">.</span><span class="n">rms</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">WVRinfo</span><span class="o">.</span><span class="n">flag</span><span class="p">:</span>
            <span class="n">flagant_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WVRinfo</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span>

    <span class="c1"># limits for disc and rms triggers -</span>
    <span class="c1"># same as hard coded in wvrg_qa to make the remcloud</span>
    <span class="c1"># trigger result object boolean</span>
    <span class="n">disc_max</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># in um</span>
    <span class="n">rms_max</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># in um</span>
    <span class="c1"># subset lists for ants exceeding the limits</span>
    <span class="n">disc_limit</span><span class="o">=</span><span class="p">[</span><span class="n">dval</span> <span class="k">for</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">disc_list</span> <span class="k">if</span> <span class="n">dval</span> <span class="o">&gt;</span> <span class="n">disc_max</span><span class="p">]</span>
    <span class="n">rms_limit</span><span class="o">=</span><span class="p">[</span><span class="n">rval</span> <span class="k">for</span> <span class="n">rval</span> <span class="ow">in</span> <span class="n">rms_list</span> <span class="k">if</span> <span class="n">rval</span> <span class="o">&gt;</span> <span class="n">rms_max</span><span class="p">]</span>

    <span class="n">qa_messages</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># check the booleans that pass important information</span>
    <span class="k">if</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">PHnoisy</span><span class="p">:</span>
        <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Only Bandpass used for WVR improvement assessment&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">suggest_remcloud</span><span class="p">:</span>
        <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Remcloud suggested&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="c1"># if nothing else score passes will be &gt;1.0</span>
        <span class="c1"># truncate to 1.0 - ratio_score now holding improvement</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">PHnoisy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>  <span class="c1"># i.e. to blue as a maximum value</span>
            <span class="c1"># now adjust 0.1 per bad entry</span>
            <span class="n">reduceBy</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
            <span class="n">reduceBy</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
            <span class="n">reduceBy</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">-</span> <span class="n">reduceBy</span>
            <span class="c1"># Crude check for the message - check if flag or disc/rms</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Flagged antenna(s)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Elevated disc value(s)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Elevated rms value(s)&#39;</span><span class="p">)</span>
            <span class="c1"># before making the score check if noisy BP was triggered</span>
            <span class="k">if</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">BPnoisy</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.66</span>  <span class="c1"># downgrade to yellow to trigger a warning</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Atmospheric phases appear unstable&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                    <span class="c1"># inherit previous reduceBy values</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">-</span> <span class="n">reduceBy</span>
                <span class="c1"># new linear score for yellow truncation</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                <span class="c1"># i.e. inputs will be truncated to between 0.0 and 0.9, linfited to be then between 0.67 and 0.9 - blue</span>

    <span class="c1"># now for scores &lt; 1.0</span>
    <span class="k">elif</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;No WVR improvement&#39;</span><span class="p">)</span>  <span class="c1"># PIPE-1837 message changed, now below</span>

        <span class="c1"># presuming disc list and rms list are all filled</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">disc_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">disc_max</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">rms_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rms_max</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.33</span>
            <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Elevated disc/rms value(s) - Check atmospheric phase stability&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reduceBy</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Flagged antenna(s)&#39;</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">-</span> <span class="n">reduceBy</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">)</span>
            <span class="c1"># i.e. inputs will be truncated to between 0.0 and 0.33, linfited to be then between 0.0 and 0.33 RED</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.66</span>
            <span class="n">reduceBy</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># initiate due to PIPE-1837 if/else loops</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="c1"># now adjust 0.1 per bad entry</span>
                <span class="n">reduceBy</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
                <span class="n">reduceBy</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
                <span class="n">reduceBy</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">score</span> <span class="o">-</span> <span class="n">reduceBy</span>
                <span class="c1"># Crude check for the message - check if flag or disc/rms</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagant_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Flagged antenna(s)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Elevated disc value(s)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Elevated rms value(s)&#39;</span><span class="p">)</span>

            <span class="c1"># PIPE-1837 before final yellow scoring we assess if the</span>
            <span class="c1"># phase rms from wvrg_qa was &#39;good&#39; i.e. &lt;1 radian</span>
            <span class="c1"># but only when there are no other WVR soln issues, i.e.</span>
            <span class="c1"># disc or rms are below the fixed limits - note</span>
            <span class="c1"># message changes explicitly if only BP is &#39;good&#39; or both BP and Phase</span>
            <span class="c1"># technically the phase can be noisy due to SNR, not atmospheric variations</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disc_limit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_limit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># here we would check if initscore &gt; 0.X: &quot;limit&#39;</span>
                <span class="k">if</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">BPgood</span><span class="p">:</span>
                    <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Bandpass &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;and Phase &#39;</span> <span class="k">if</span> <span class="n">dataresult</span><span class="o">.</span><span class="n">PHgood</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="s1">&#39;calibrator atmospheric phase stability appears to be good&#39;</span><span class="p">)</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">-</span> <span class="n">reduceBy</span>  <span class="c1"># still account for flagged antennas</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we don&#39;t modify from the previous assessment - i.e. data seem ok, no poor rms or disc,</span>
                    <span class="c1"># but the phase RMS is not explicitly reported as good - I suspect some LB and HF might come here</span>
                    <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Check atmospheric phase stability&#39;</span><span class="p">)</span>
                    <span class="c1"># if disc and rms didn&#39;t trigger but phase stability not reported as good - still yellow</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">)</span>

            <span class="c1"># Otherwise now we are back to yellow when disc or rms also triggered on any ant and append message now</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qa_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Check atmospheric phase stability&#39;</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">)</span>
                <span class="c1"># i.e. inputs will be truncated to between 0.0 and 0.66, linfited to be then between 0.34 and 0.66</span>

    <span class="c1"># join the short messages for the QA score (are these stored?? )</span>
    <span class="n">qa_mesg</span> <span class="o">=</span> <span class="s1">&#39; - &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qa_messages</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">qa_mesg</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;phase RMS improvement was </span><span class="si">%0.2f</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wvr_score</span><span class="p">,</span> <span class="n">ms_name</span><span class="p">,</span> <span class="n">qa_mesg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;phase RMS improvement was </span><span class="si">%0.2f</span><span class="s1"> for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wvr_score</span><span class="p">,</span> <span class="n">ms_name</span><span class="p">)</span>

    <span class="c1"># should be made always</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1">x improvement&#39;</span> <span class="o">%</span> <span class="n">wvr_score</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_wvrgcal&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">wvr_score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Phase RMS improvement after applying WVR correction&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_name</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sdtotal_data_flagged</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">frac_flagged</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the total fraction of</span>
<span class="sd">    data flagged.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-50% flagged  -&gt; 0.5</span>
<span class="sd">    50-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> was newly flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sdtotal_data_flagged&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sdtotal_data_flagged_old</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">frac_flagged</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the flagging task based on the total fraction of</span>
<span class="sd">    data flagged.</span>

<span class="sd">    0%-5% flagged   -&gt; 1</span>
<span class="sd">    5%-50% flagged  -&gt; 0.5</span>
<span class="sd">    50-100% flagged -&gt; 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">frac_flagged</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="n">frac_flagged</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="n">percent</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">frac_flagged</span>
    <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> (Ant=</span><span class="si">%s</span><span class="s1">, SPW=</span><span class="si">%d</span><span class="s1">, Pol=</span><span class="si">%d</span><span class="s1">) was flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> of data in </span><span class="si">%s</span><span class="s1"> (Ant=</span><span class="si">%s</span><span class="s1">, Field=</span><span class="si">%s</span><span class="s1">, SPW=</span><span class="si">%d</span><span class="s1">, Pol=</span><span class="si">%s</span><span class="s1">) was &#39;</span>
                   <span class="s1">&#39;flagged&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percent</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f%%</span><span class="s1"> data flagged&#39;</span> <span class="o">%</span> <span class="n">percent</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sdtotal_data_flagged_old&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of data newly flagged&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<div class="viewcode-block" id="score_tsysspwmap">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_tsysspwmap">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_tsysspwmap</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">unmappedspws</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is equal to the fraction of unmapped windows</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmappedspws</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Tsys spw map is complete for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Tsys spw map is complete&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nscispws</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">nscispws</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nscispws</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmappedspws</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nscispws</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Tsys spw map is incomplete for </span><span class="si">%s</span><span class="s1"> science window</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                                                           <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">unmappedspws</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Tsys spw map is incomplete&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_tsysspwmap&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of unmapped Tsys windows&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_setjy_measurements">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_setjy_measurements">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_setjy_measurements</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">reqfields</span><span class="p">,</span> <span class="n">reqintents</span><span class="p">,</span> <span class="n">reqspws</span><span class="p">,</span> <span class="n">measurements</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is equal to the ratio of the number of actual flux</span>
<span class="sd">    measurements to expected number of flux measurements</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Expected fields</span>
    <span class="n">scifields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">reqfields</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">reqintents</span><span class="p">)}</span>

    <span class="c1"># Expected science windows</span>
    <span class="n">scispws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">reqspws</span><span class="p">,</span> <span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>

    <span class="c1"># Loop over the expected fields</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">scifield</span> <span class="ow">in</span> <span class="n">scifields</span><span class="p">:</span>
        <span class="n">validspws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scifield</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">}</span>
        <span class="n">nexpected</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">validspws</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">scispws</span><span class="p">))</span>

    <span class="c1"># Loop over the measurements</span>
    <span class="n">nmeasured</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1"># Loop over the flux measurements</span>
        <span class="n">nmeasured</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Compute score</span>
    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No flux calibrators for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No flux calibrators&#39;</span>
    <span class="k">elif</span> <span class="n">nmeasured</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No flux measurements for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No flux measurements&#39;</span>
    <span class="k">elif</span> <span class="n">nexpected</span> <span class="o">==</span> <span class="n">nmeasured</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;All expected flux calibrator measurements present for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;All expected flux calibrator measurements present&#39;</span>
    <span class="k">elif</span> <span class="n">nmeasured</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nmeasured</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing flux calibrator measurements for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">nmeasured</span><span class="p">,</span> <span class="n">nexpected</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing flux calibrator measurements&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Too many flux calibrator measurements for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">nmeasured</span><span class="p">,</span> <span class="n">nexpected</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Too many flux measurements&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_setjy_measurements&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Ratio of number of flux measurements to number expected&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_number_antenna_offsets">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_number_antenna_offsets">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_number_antenna_offsets</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">offsets</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is 1.0 if no antenna needed a position offset correction, and</span>
<span class="sd">    set to the &quot;suboptimal&quot; threshold if at least one antenna needed a</span>
<span class="sd">    correction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nant_with_offsets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">offsets</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span>

    <span class="k">if</span> <span class="n">nant_with_offsets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No antenna position offsets for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No antenna position offsets&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># CAS-8877: if at least 1 antenna needed correction, then set the score</span>
        <span class="c1"># to the &quot;suboptimal&quot; threshold.</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> nonzero antenna position offsets for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nant_with_offsets</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Nonzero antenna position offsets&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_number_antenna_offsets&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">nant_with_offsets</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of antennas requiring position offset correction&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_missing_derived_fluxes">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_missing_derived_fluxes">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_missing_derived_fluxes</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">reqfields</span><span class="p">,</span> <span class="n">reqintents</span><span class="p">,</span> <span class="n">measurements</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is equal to the ratio of actual flux</span>
<span class="sd">    measurement to expected flux measurements</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Expected fields</span>
    <span class="n">scifields</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">reqfields</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">reqintents</span><span class="p">)}</span>

    <span class="c1"># Expected science windows</span>
    <span class="n">scispws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>

    <span class="c1"># Loop over the expected fields</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">scifield</span> <span class="ow">in</span> <span class="n">scifields</span><span class="p">:</span>
        <span class="n">validspws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scifield</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">}</span>
        <span class="n">nexpected</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">validspws</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">scispws</span><span class="p">))</span>

    <span class="c1"># Loop over measurements</span>
    <span class="n">nmeasured</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Loop over the flux measurements</span>
        <span class="k">for</span> <span class="n">flux</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">fluxjy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FluxDensityUnits</span><span class="o">.</span><span class="n">JANSKY</span><span class="p">)</span>
            <span class="n">uncjy</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FluxDensityUnits</span><span class="o">.</span><span class="n">JANSKY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fluxjy</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">uncjy</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">nmeasured</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Compute score</span>
    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No secondary calibrators for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No secondary calibrators&#39;</span>
    <span class="k">elif</span> <span class="n">nmeasured</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No derived fluxes for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No derived fluxes&#39;</span>
    <span class="k">elif</span> <span class="n">nexpected</span> <span class="o">==</span> <span class="n">nmeasured</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;All expected derived fluxes present for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;All expected derived fluxes present&#39;</span>
    <span class="k">elif</span> <span class="n">nmeasured</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nmeasured</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing derived fluxes for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">nmeasured</span><span class="p">,</span> <span class="n">nexpected</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing derived fluxes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Extra derived fluxes for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">nmeasured</span><span class="p">,</span> <span class="n">nexpected</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Extra derived fluxes&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_derived_fluxes&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Ratio of number of flux measurements to number expected&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_refspw_mapping_fraction">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_refspw_mapping_fraction">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_refspw_mapping_fraction</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">ref_spwmap</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the fraction of science spws that have not been</span>
<span class="sd">    mapped to other windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ref_spwmap</span> <span class="o">==</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No mapped science spws for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No mapped science spws&#39;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_refspw_mapping_fraction&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of unmapped science spws&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Expected science windows</span>
        <span class="n">scispws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
        <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scispws</span><span class="p">)</span>

        <span class="n">nunmapped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">scispws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spwid</span> <span class="o">==</span> <span class="n">ref_spwmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]:</span>
                <span class="n">nunmapped</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">nunmapped</span> <span class="o">&gt;=</span> <span class="n">nexpected</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No mapped science spws for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No mapped science spws&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Replace the previous score with a warning</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_WARNING</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;There are </span><span class="si">%d</span><span class="s1"> mapped science spws for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">nunmapped</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;There are mapped science spws&#39;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_refspw_mapping_fraction&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">nunmapped</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of unmapped science spws&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_combine_spwmapping</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwmapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate whether or not a spw mapping is using combine.</span>
<span class="sd">    If not, then set score to 1. If so, then set score to the sub-optimal</span>
<span class="sd">    threshold (for blue info message).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">spwmapping</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Using combined spw mapping for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Using combined spw mapping&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No combined spw mapping for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No combined spw mapping&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_check_phaseup_combine_mapping&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">spwmapping</span><span class="o">.</span><span class="n">combine</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Using combined spw mapping&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="n">intent</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_phaseup_mapping_fraction</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwmapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the fraction of science spws that have not been</span>
<span class="sd">    mapped to other probably wider windows.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">spwmapping</span><span class="o">.</span><span class="n">spwmap</span><span class="p">:</span>
        <span class="n">nunmapped</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)])</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No spw mapping for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No spw mapping&#39;</span>
    <span class="k">elif</span> <span class="n">spwmapping</span><span class="o">.</span><span class="n">combine</span><span class="p">:</span>
        <span class="n">nunmapped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_WARNING</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Combined spw mapping for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Combined spw mapping&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Expected science windows</span>
        <span class="n">scispws</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">scispwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scispwids</span><span class="p">)</span>

        <span class="n">nunmapped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">samesideband</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">scispw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scispwids</span><span class="p">,</span> <span class="n">scispws</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">spwid</span> <span class="o">==</span> <span class="n">spwmapping</span><span class="o">.</span><span class="n">spwmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]:</span>
                <span class="n">nunmapped</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scispw</span><span class="o">.</span><span class="n">sideband</span> <span class="o">!=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spwmapping</span><span class="o">.</span><span class="n">spwmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">])</span><span class="o">.</span><span class="n">sideband</span><span class="p">:</span>
                    <span class="n">samesideband</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">nunmapped</span> <span class="o">&gt;=</span> <span class="n">nexpected</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No spw mapping for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No spw mapping&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Replace the previous score with a warning</span>
            <span class="k">if</span> <span class="n">samesideband</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Spw mapping within sidebands for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Spw mapping within sidebands&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_WARNING</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Spw mapping across sidebands required for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, intent=</span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Spw mapping across sidebands&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_phaseup_mapping_fraction&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">nunmapped</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of unmapped science spws&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="n">intent</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span>


<div class="viewcode-block" id="score_phaseup_spw_median_snr_for_phase">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_phaseup_spw_median_snr_for_phase">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_phaseup_spw_median_snr_for_phase</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">median_snr</span><span class="p">,</span> <span class="n">snr_threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the median achieved SNR for a given phase calibrator field and SpW.</span>
<span class="sd">    Introduced for hifa_spwphaseup (PIPE-665).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_ERROR</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=PHASE), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 30% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">elif</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_WARNING</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=PHASE), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 50% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">elif</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=PHASE), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 75% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Median SNR is ok&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=PHASE), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &gt; 75% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_phaseup_spw_median_snr&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">median_snr</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Median SNR&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spw</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_decoherence_assessment">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_decoherence_assessment">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_decoherence_assessment</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">,</span> <span class="n">phaserms_results</span><span class="p">,</span> <span class="n">outlier_antennas</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assess the cycle time phase RMS value, which is important as everything longer than a cycle time</span>
<span class="sd">    is corrected by phase referencing (in terms of atmospheric phase variations).</span>

<span class="sd">    Also checks the outlier antennas and the 80th percentile baseline with and without flagged antennas.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">phasermscycle_p80</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">phaserms_results</span><span class="p">[</span><span class="s1">&#39;phasermscycleP80&#39;</span><span class="p">]</span>
        <span class="n">bl_p80</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">phaserms_results</span><span class="p">[</span><span class="s1">&#39;blP80&#39;</span><span class="p">]</span>
        <span class="n">bl_p80_orig</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">phaserms_results</span><span class="p">[</span><span class="s1">&#39;blP80orig&#39;</span><span class="p">]</span>

        <span class="n">initial_score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">phasermscycle_p80</span><span class="o">/</span><span class="mf">100.0</span>
        <span class="n">RMSstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">phasermscycle_p80</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;For </span><span class="si">{0}</span><span class="s2">, the Phase RMS calculated over the cycle time for the unflagged baselines longer than 80th percentile is </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    deg&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">RMSstring</span><span class="p">))</span>

        <span class="c1"># Stable Phases, &lt; 30 deg phaseRMS</span>
        <span class="k">if</span> <span class="n">initial_score</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="n">base_score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Excellent stability Phase RMS (&lt;30deg).&quot;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{0}</span><span class="s2">, excellent stability: The baseline-based median phase RMS for baselines longer than P80 is </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        deg over the cycle time.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">RMSstring</span><span class="p">)</span>

            <span class="c1"># Check for problem antennas and update the score if needed.</span>
            <span class="c1"># these are outliers &gt;100 deg, or those beyond &quot;outlier_limit&quot; in SSFherusitics (6 MAD)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlier_antennas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.9</span>

        <span class="k">elif</span> <span class="n">initial_score</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">initial_score</span> <span class="o">&lt;=</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="c1"># 30 to 50 deg phase RMS: not really a problem just informative</span>
            <span class="c1"># that the phase noise is elevated - no &#39;need&#39; to look</span>
            <span class="c1"># as 50 deg phase RMS can still cause ~30% decoherence</span>
            <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Stable conditions phase RMS (30-50deg).&quot;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{0}</span><span class="s2">, good stability: The baseline-based median phase RMS for baselines longer than P80 is </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                            deg over the cycle time.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">RMSstring</span><span class="p">)</span>

        <span class="c1"># These are high phase noise -</span>
        <span class="c1"># outliers have already been clipped past 100 degrees</span>
        <span class="c1"># and those &gt;4 MAD above the P80 phase RMS value</span>
        <span class="c1"># so, if we still get here, the phases were poor/v.bad - or there</span>
        <span class="c1"># were too many antennas classed as bad in the analysis function</span>
        <span class="k">elif</span> <span class="n">initial_score</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">initial_score</span> <span class="o">&gt;</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="c1"># 50 - 70 deg phase RMS, i.e. 30-50% lost due to decoherence</span>
            <span class="c1"># The initial score is representative</span>
            <span class="n">base_score</span> <span class="o">=</span> <span class="n">initial_score</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Elevated Phase RMS (50-70deg) exceeds stable parameters.&quot;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{0}</span><span class="s2">, elevated phase instability: The baseline-based median phase RMS for baselines longer than P80 is </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                            deg over the cycle time. Some image artifacts/defects may occur.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">RMSstring</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">initial_score</span> <span class="o">&lt;=</span> <span class="mf">0.3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">initial_score</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">base_score</span> <span class="o">=</span> <span class="n">initial_score</span>

            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;High Phase RMS (&gt;70deg) exceeds limit for poor stability&quot;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{0}</span><span class="s2">, very poor phase stability: The baseline-based median phase RMS for baselines longer than P80 is </span><span class="si">{1}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        deg over the cycle time. Significant image artifacts/defects may be present.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">RMSstring</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># This should never happen</span>
            <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;The phase RMS could not be assessed.&quot;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{}</span><span class="s2">, the spatial structure function could not be assessed&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Append antenna outlier information to longmsg if present</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlier_antennas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outlier_antennas</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> has higher phase RMS.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">outlier_antennas</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> </span><span class="si">{1}</span><span class="s2"> have higher phase RMS&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">outlier_antennas</span><span class="p">)</span>

        <span class="c1"># The P80 is shorter than the P80 of all data due to notable baseline flagging</span>
        <span class="c1">#       tbd but if the P80 is 10-15% lower than expected - i.e. can later impact QA2</span>
        <span class="c1">#       as the longer baselines have maybe been flagged out</span>
        <span class="k">if</span> <span class="n">bl_p80</span> <span class="o">&lt;</span> <span class="n">bl_p80_orig</span> <span class="o">*</span> <span class="mf">0.85</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;P80 of unflagged data is more than 15</span><span class="si">% s</span><span class="s2">horter than P80 of all baselines due to baseline and antennas flags&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">base_score</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> P80 of unflagged data is more than 15</span><span class="si">% s</span><span class="s2">horter than P80 of all baselines&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">longmsg</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># For any error in the above:</span>
        <span class="n">base_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">phasermscycle_p80</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;The phase RMS could not be assessed.&quot;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;For </span><span class="si">{}</span><span class="s2">, the spatial structure function could not be assessed.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

    <span class="c1"># Create metric origin</span>
    <span class="n">phase_stability_origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;Phase stability&#39;</span><span class="p">,</span>
                                          <span class="n">metric_score</span><span class="o">=</span><span class="n">phasermscycle_p80</span><span class="p">,</span>
                                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Degrees&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">base_score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">phase_stability_origin</span><span class="p">,</span>
                       <span class="n">weblog_location</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_phaseup_spw_median_snr_for_check">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_phaseup_spw_median_snr_for_check">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_phaseup_spw_median_snr_for_check</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">median_snr</span><span class="p">,</span> <span class="n">snr_threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the median achieved SNR for a given check source field and SpW.</span>
<span class="sd">    Introduced for hifa_spwphaseup (PIPE-665).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.7</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=CHECK), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 30% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">elif</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=CHECK), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 50% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">elif</span> <span class="n">median_snr</span> <span class="o">&lt;=</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="n">snr_threshold</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low median SNR&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=CHECK), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &lt;= 75% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Median SNR is ok&#39;</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> (intent=CHECK), SpW=</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, the median achieved SNR&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="n">median_snr</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">) is &gt; 75% of the phase SNR threshold (</span><span class="si">{</span><span class="n">snr_threshold</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">).&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_phaseup_spw_median_snr&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">median_snr</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Median SNR&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spw</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_missing_phaseup_snrs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_missing_phaseup_snrs">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_missing_phaseup_snrs</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">phsolints</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with phaseup SNR estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the number of expected and missing SNR measurements</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">missing_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phsolints</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">missing_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nmissing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No phaseup SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No phaseup SNR estimates&#39;</span>
    <span class="k">elif</span> <span class="n">nmissing</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing phaseup SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing phaseup SNR estimates&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">nmissing</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing phaseup SNR estimates for spws </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">missing_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing phaseup SNR estimates&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_phaseup_snrs&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">nmissing</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of spws with missing SNR measurements&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spwid</span> <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_poor_phaseup_solutions">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_poor_phaseup_solutions">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_poor_phaseup_solutions</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">nphsolutions</span><span class="p">,</span> <span class="n">min_nsolutions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with poor phaseup solutions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the number of expected and poor SNR measurements</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">poor_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nphsolutions</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nphsolutions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_nsolutions</span><span class="p">:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">npoor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poor_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No phaseup solutions for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No phaseup solutions&#39;</span>
    <span class="k">elif</span> <span class="n">npoor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No poorly determined phaseup solutions for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No poorly determined phaseup solutions&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">npoor</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Poorly determined phaseup solutions for spws </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">poor_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Poorly determined phaseup solutions&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_poor_phaseup_solutions&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">npoor</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of poor phaseup solutions&#39;</span><span class="p">)</span>

    <span class="n">applies_to</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spwid</span> <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">applies_to</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_missing_bandpass_snrs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_missing_bandpass_snrs">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_missing_bandpass_snrs</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">bpsolints</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with bandpass SNR estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Compute the number of expected and missing SNR measurements</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">missing_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bpsolints</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">missing_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nmissing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No bandpass SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No bandpass SNR estimates&#39;</span>
    <span class="k">elif</span> <span class="n">nmissing</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing bandpass SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing bandpass SNR estimates&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">nmissing</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing bandpass SNR estimates for spws </span><span class="si">%s</span><span class="s1"> in</span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">missing_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing bandpass SNR estimates&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_bandpass_snrs&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">nmissing</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing bandpass SNR estimates&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_poor_bandpass_solutions">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_poor_bandpass_solutions">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_poor_bandpass_solutions</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">nbpsolutions</span><span class="p">,</span> <span class="n">min_nsolutions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with poor bandpass solutions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the number of expected and poor solutions</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">poor_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nbpsolutions</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">nbpsolutions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_nsolutions</span><span class="p">:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">npoor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poor_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No bandpass solutions for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No bandpass solutions&#39;</span>
    <span class="k">elif</span> <span class="n">npoor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No poorly determined bandpass solutions for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No poorly determined bandpass solutions&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">npoor</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Poorly determined bandpass solutions for spws </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">poor_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Poorly determined bandpass solutions&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_bandpass_snrs&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">npoor</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of poor bandpass solutions&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_missing_phase_snrs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_missing_phase_snrs">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_missing_phase_snrs</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">snrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with SNR estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the number of expected and missing SNR measurements</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">missing_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snrs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">missing_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">nmissing</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No gaincal SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No gaincal SNR estimates&#39;</span>
    <span class="k">elif</span> <span class="n">nmissing</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing gaincal SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing gaincal SNR estimates&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">nmissing</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing gaincal SNR estimates for spws </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">missing_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing gaincal SNR estimates&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_missing_phase_snrs&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">nmissing</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing phase SNR estimates&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_poor_phase_snrs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_poor_phase_snrs">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_poor_phase_snrs</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">,</span> <span class="n">minsnr</span><span class="p">,</span> <span class="n">snrs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score is the fraction of spws with poor snr estimates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Compute the number of expected and poor solutions</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)</span>
    <span class="n">poor_spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwids</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">snrs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">snrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minsnr</span><span class="p">:</span>
            <span class="n">poor_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">npoor</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">poor_spws</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nexpected</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No gaincal SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No gaincal SNR estimates&#39;</span>
    <span class="k">elif</span> <span class="n">npoor</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No low gaincal SNR estimates for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No low gaincal SNR estimates&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span> <span class="o">-</span> <span class="n">npoor</span><span class="p">)</span> <span class="o">/</span> <span class="n">nexpected</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Low gaincal SNR estimates for spws </span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> \
            <span class="p">(</span><span class="n">poor_spws</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Low gaincal SNR estimates&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_poor_phase_snrs&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">npoor</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of poor phase SNR estimates&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_derived_fluxes_snr">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_derived_fluxes_snr">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_derived_fluxes_snr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">measurements</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the SNR of the derived flux measurements.</span>

<span class="sd">    See PIPE-644 for latest description.</span>

<span class="sd">    Linearly scale QA score based on SNR value, where</span>
<span class="sd">      QA = 1.0 if SNR &gt;= 26.25</span>
<span class="sd">      QA = 0.66 if SNR &lt; 5.0</span>
<span class="sd">    and QA linearly scales from 0.66 to 1.0 between SNR 5 to 26.25.</span>

<span class="sd">    These QA and SNR threshold were chosen such that SNR values in the range of</span>
<span class="sd">    5-20 should map to QA scores in the range that will show as a blue</span>
<span class="sd">    &quot;suboptimal&quot; level QA message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Loop over measurements</span>
    <span class="n">nmeasured</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">minscore</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">minsnr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">snr_thresh</span> <span class="o">=</span> <span class="mf">26.25</span>
    <span class="n">low_snr_flux</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">field_measurements</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Loop over the flux measurements</span>
        <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="n">field_measurements</span><span class="p">:</span>
            <span class="n">fluxjy</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FluxDensityUnits</span><span class="o">.</span><span class="n">JANSKY</span><span class="p">)</span>
            <span class="n">uncjy</span> <span class="o">=</span> <span class="n">measurement</span><span class="o">.</span><span class="n">uncertainty</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FluxDensityUnits</span><span class="o">.</span><span class="n">JANSKY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fluxjy</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">uncjy</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="n">fluxjy</span> <span class="o">/</span> <span class="n">uncjy</span>
            <span class="n">minsnr</span> <span class="o">=</span> <span class="n">snr</span> <span class="k">if</span> <span class="n">minsnr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">minsnr</span><span class="p">,</span> <span class="n">snr</span><span class="p">)</span>
            <span class="n">nmeasured</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">score1</span> <span class="o">=</span> <span class="n">linear_score</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">snr_thresh</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">minscore</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minscore</span><span class="p">,</span> <span class="n">score1</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">score1</span>
            <span class="k">if</span> <span class="n">score1</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">low_snr_flux</span><span class="p">[</span><span class="n">fieldid</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">spw_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nmeasured</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">/=</span> <span class="n">nmeasured</span>

    <span class="k">if</span> <span class="n">nmeasured</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No derived fluxes for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No derived fluxes&#39;</span>
    <span class="k">elif</span> <span class="n">minscore</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No low SNR derived fluxes for </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No low SNR derived fluxes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Report which field(s) and SpW(s) had low SNR.</span>
        <span class="n">fld_summaries</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;field </span><span class="si">{</span><span class="n">fid</span><span class="si">}</span><span class="s1">, SpW(s) </span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">))</span><span class="si">}</span><span class="s1">&#39;</span>
                         <span class="k">for</span> <span class="n">fid</span><span class="p">,</span> <span class="n">spwids</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">low_snr_flux</span><span class="o">.</span><span class="n">items</span><span class="p">())]</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;For </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">, the fractional uncertainty in the derived scaling factor is large&#39;</span> \
                  <span class="sa">f</span><span class="s1">&#39; (&gt; </span><span class="si">{</span><span class="mi">100</span><span class="o">/</span><span class="n">snr_thresh</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%) for </span><span class="si">{</span><span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fld_summaries</span><span class="p">)</span><span class="si">}</span><span class="s1">. The calibrator may be too faint.&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Uncertainty in some of the derived fluxes&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_derived_fluxes_snr&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">minsnr</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Minimum SNR of derived flux measurement&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_path_exists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_path_exists">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_path_exists</span><span class="p">(</span><span class="n">mspath</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">pathtype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of the path</span>
<span class="sd">        1.0 if it exist</span>
<span class="sd">        0.0 if it does not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> was created&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathtype</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mspath</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file was created&#39;</span> <span class="o">%</span> <span class="n">pathtype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file </span><span class="si">%s</span><span class="s1"> for </span><span class="si">%s</span><span class="s1"> was not created&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathtype</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mspath</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file was not created&#39;</span> <span class="o">%</span> <span class="n">pathtype</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_path_exists&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Path exists on disk&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_file_exists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_file_exists">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_file_exists</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">filetype</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of a products file</span>
<span class="sd">        1.0 if it exists</span>
<span class="sd">        0.0 if it does not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file is undefined&#39;</span> <span class="o">%</span> <span class="n">filetype</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file is undefined&#39;</span> <span class="o">%</span> <span class="n">filetype</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_file_exists&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1"> file to check&#39;</span> <span class="o">%</span> <span class="n">filetype</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file has been exported&#39;</span> <span class="o">%</span> <span class="n">filetype</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file has been exported&#39;</span> <span class="o">%</span> <span class="n">filetype</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filetype</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;The </span><span class="si">%s</span><span class="s1"> file does not exist&#39;</span> <span class="o">%</span> <span class="n">filetype</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_file_exists&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;File exists on disk&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_mses_exist">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_mses_exist">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_mses_exist</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">visdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of the flagging products files</span>
<span class="sd">        1.0 if they all exist</span>
<span class="sd">        n / nexpected if some of them exist</span>
<span class="sd">        0.0 if none exist</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">visdict</span><span class="p">)</span>
    <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">visname</span> <span class="ow">in</span> <span class="n">visdict</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">nfiles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final ms files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final ms files&#39;</span>
    <span class="k">elif</span> <span class="n">nfiles</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final ms files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final ms files&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final ms  files&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final ms files&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_mses_exist&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing ms product files&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_flags_exist">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_flags_exist">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_flags_exist</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">visdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of the flagging products files</span>
<span class="sd">        1.0 if they all exist</span>
<span class="sd">        n / nexpected if some of them exist</span>
<span class="sd">        0.0 if none exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">visdict</span><span class="p">)</span>
    <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">visname</span> <span class="ow">in</span> <span class="n">visdict</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">nfiles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final flag version files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final flags version files&#39;</span>
    <span class="k">elif</span> <span class="n">nfiles</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final flag version files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final flags version files&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final flag version files&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final flags version files&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_flags_exist&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing flagging product files&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_flagging_view_exists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_flagging_view_exists">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_flagging_view_exists</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assign a score of zero if the flagging view cannot be computed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># By default, assume no flagging views were found.</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No flagging views for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No flagging views&#39;</span>

    <span class="c1"># Check if this is a flagging result for a single metric, where</span>
    <span class="c1"># the flagging view is stored directly in the result.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">view</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">view</span>
        <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Flagging views exist for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Flagging views exist&#39;</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Check if this flagging results contains multiple metrics,</span>
    <span class="c1"># and look for flagging views among components.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Set score to 1 as soon as a single metric contains a</span>
        <span class="c1"># valid flagging view.</span>
        <span class="k">for</span> <span class="n">metricresult</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">view</span> <span class="o">=</span> <span class="n">metricresult</span><span class="o">.</span><span class="n">view</span>
            <span class="k">if</span> <span class="n">view</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Flagging views exist for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Flagging views exist&#39;</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_flagging_view_exists&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">score</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Presence of flagging view&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_applycmds_exist">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_applycmds_exist">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_applycmds_exist</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">visdict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of the apply commands products files</span>
<span class="sd">        1.0 if they all exist</span>
<span class="sd">        n / nexpected if some of them exist</span>
<span class="sd">        0.0 if none exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">visdict</span><span class="p">)</span>
    <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">visname</span> <span class="ow">in</span> <span class="n">visdict</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">visdict</span><span class="p">[</span><span class="n">visname</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">nfiles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final apply commands files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final apply commands files&#39;</span>
    <span class="k">elif</span> <span class="n">nfiles</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Final apply commands files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing final apply commands files&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final apply commands files&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing final apply commands files&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_applycmds_exist&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing apply command files&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_caltables_exist">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_caltables_exist">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_caltables_exist</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">sessiondict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score the existence of the caltables products files</span>
<span class="sd">        1.0 if theu all exist</span>
<span class="sd">        n / nexpected if some of them exist</span>
<span class="sd">        0.0 if none exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nexpected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sessiondict</span><span class="p">)</span>
    <span class="n">nfiles</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">sessionname</span> <span class="ow">in</span> <span class="n">sessiondict</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filedir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sessiondict</span><span class="p">[</span><span class="n">sessionname</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
            <span class="n">nfiles</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sessiondict</span><span class="p">[</span><span class="n">sessionname</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">nfiles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Caltables files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing caltables files&#39;</span>
    <span class="k">elif</span> <span class="n">nfiles</span> <span class="o">&lt;</span> <span class="n">nexpected</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nfiles</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nexpected</span><span class="p">)</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Caltables files </span><span class="si">%s</span><span class="s1"> are missing&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Missing caltables files&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing caltables files&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No missing caltables files&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_caltables_exist&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of missing caltables&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_images_exist</span><span class="p">(</span><span class="n">filesdir</span><span class="p">,</span> <span class="n">imaging_products_only</span><span class="p">,</span> <span class="n">calimages</span><span class="p">,</span> <span class="n">targetimages</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">imaging_products_only</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No target images were exported&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No target images exported&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">)</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> target images were exported&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">))</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Target images exported&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">calimages</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No images were exported&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No images exported&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">calimages</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">)</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> images were exported&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">calimages</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">targetimages</span><span class="p">))</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Images exported&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_images_exist&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of exported images&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_line_ranges</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get valid line ranges from list of line properties.</span>

<span class="sd">    Args:</span>
<span class="sd">        lines: List of lines. Each line is expressed as at least three</span>
<span class="sd">               values, [center, width, validity_flag], where the line</span>
<span class="sd">               is regarded as valid if validity_flag is True.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of (start, end) channels for valid lines</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line_ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">is_valid</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_valid</span><span class="p">:</span>
            <span class="n">chan_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">center</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">chan_right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="n">line_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chan_left</span><span class="p">,</span> <span class="n">chan_right</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">line_ranges</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">examine_sd_edge_lines</span><span class="p">(</span><span class="n">line_ranges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">nchan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Examine the existence of lines at edge channels.</span>

<span class="sd">    This function checks if there are lines that spans edge channels.</span>
<span class="sd">    Excluded channels via edge parameter are taken into account.</span>

<span class="sd">    Args:</span>
<span class="sd">        line_ranges: List of line ranges</span>
<span class="sd">        nchan: Number of channels</span>
<span class="sd">        edge: Number of edge channels excluded from both sides</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if there are lines that satisfy the condition above.</span>
<span class="sd">        Otherwise, False.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chan_leftmost</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_ranges</span><span class="p">)</span>
    <span class="n">chan_rightmost</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_ranges</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s1">&#39;leftmost </span><span class="si">%s</span><span class="s1">, rightmost </span><span class="si">%s</span><span class="s1">, nchan </span><span class="si">%s</span><span class="s1">, edge (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
        <span class="n">chan_leftmost</span><span class="p">,</span> <span class="n">chan_rightmost</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">chan_leftmost</span> <span class="o">&lt;=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chan_rightmost</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">examine_sd_wide_lines</span><span class="p">(</span><span class="n">line_ranges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">nchan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Examine the existence of wide lines.</span>

<span class="sd">    This function returns True if there is a line with the width</span>
<span class="sd">    exceeding 1/3 of spw bandwidth. If there are multiple lines</span>
<span class="sd">    and their coverage exceeds the criterion *in total*, the</span>
<span class="sd">    function also returns True. Otherwise, it returns False.</span>
<span class="sd">    Excluded channels via edge parameter are taken into account.</span>

<span class="sd">    Args:</span>
<span class="sd">        line_ranges: List of line ranges</span>
<span class="sd">        nchan: Number of channels</span>
<span class="sd">        edge: Number of edge channels excluded from both sides</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if wide line exists. Otherwise, Flase. Please see</span>
<span class="sd">        the above description on more detailed explanation of</span>
<span class="sd">        return value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># see PIPEREQ-304 for the origin of the value</span>
    <span class="n">fraction</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">line_ranges</span><span class="p">:</span>
        <span class="n">ch_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">ch_start</span><span class="p">:</span><span class="n">ch_end</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">effective_nchan</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
    <span class="n">line_coverage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">line_coverage</span> <span class="o">&gt;</span> <span class="n">effective_nchan</span> <span class="o">*</span> <span class="n">fraction</span>


<span class="k">def</span> <span class="nf">select_deviation_masks</span><span class="p">(</span><span class="n">deviation_masks</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">reduction_group_member</span><span class="p">:</span> <span class="s1">&#39;MSReductionGroupMember&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Select deviation masks that belongs to given reduction group member.</span>

<span class="sd">    Args:</span>
<span class="sd">        deviation_masks: List of all deviation masks</span>
<span class="sd">        reduction_group_member: Reduction group member instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of (start, end) channels for selected deviation masks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ms_name</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
    <span class="n">field_id</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">field_id</span>
    <span class="n">spw_id</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">spw_id</span>
    <span class="n">antenna_id</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">antenna_id</span>
    <span class="k">return</span> <span class="n">deviation_masks</span><span class="p">[</span><span class="n">ms_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">field_id</span><span class="p">,</span> <span class="n">antenna_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">),</span> <span class="p">[])</span>


<span class="k">def</span> <span class="nf">channel_ranges_for_image</span><span class="p">(</span><span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">nchan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sideband</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ranges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert channel ranges in MS coordinate to those in image coordinate.</span>

<span class="sd">    Frequency coordinates are different between MS and image product.</span>
<span class="sd">    This method converts channel ranges in MS coordinate into the ranges</span>
<span class="sd">    in image coordinate. The conversion includes the following operations.</span>

<span class="sd">        - to reverse channels if spw is LSB</span>
<span class="sd">        - to shift channels by the amount specified by edge parameter</span>

<span class="sd">    Args:</span>
<span class="sd">        edge: Number of edge channels excluded</span>
<span class="sd">        nchan: Number of channels</span>
<span class="sd">        sideband: 1 for USB, -1 for LSB</span>
<span class="sd">        ranges: List of two tuples representing channel ranges</span>

<span class="sd">    Returns:</span>
<span class="sd">        Converted channel ranges</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edge_left</span><span class="p">,</span> <span class="n">edge_right</span> <span class="o">=</span> <span class="n">edge</span>

    <span class="k">if</span> <span class="n">sideband</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># LSB</span>
        <span class="n">chan_offset</span> <span class="o">=</span> <span class="n">edge_right</span>

        <span class="k">def</span> <span class="nf">_reverse_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span>

        <span class="n">_ranges_image</span> <span class="o">=</span> <span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_reverse_range</span><span class="p">,</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># USB</span>
        <span class="n">chan_offset</span> <span class="o">=</span> <span class="n">edge_left</span>

        <span class="n">_ranges_image</span> <span class="o">=</span> <span class="n">ranges</span>

    <span class="c1"># offset channel ranges</span>
    <span class="k">def</span> <span class="nf">_offset_range</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">-</span> <span class="n">chan_offset</span>

    <span class="n">_ranges_image</span> <span class="o">=</span> <span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_offset_range</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_ranges_image</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_ranges_image</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sd_line_detection</span><span class="p">(</span><span class="n">reduction_group</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="s1">&#39;SDBaselineResults&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute QA score based on the line detection result.</span>

<span class="sd">    QA scores are evaluated based on the line detection result for</span>
<span class="sd">    each combination of spw and field individually. Scoring scheme of</span>
<span class="sd">    individual results are as follows:</span>

<span class="sd">        - skip scoring if no lines were detected (no QAScore object)</span>
<span class="sd">        - 0.55 if there are lines extends to edge channels</span>
<span class="sd">        - 0.6 if there are lines that covers more than 1/3 of spw</span>
<span class="sd">          bandwidth in total</span>
<span class="sd">        - 1.0 otherwise</span>

<span class="sd">    If no lines were detected in any spws/fields so that no QAScore</span>
<span class="sd">    objects were created, this function creates QAScore object with</span>
<span class="sd">    the score of 0.8 and the message indicating that no lines were</span>
<span class="sd">    detected. Therefore, returned list should contain at least one</span>
<span class="sd">    QAScore object.</span>

<span class="sd">    In addition to the detected lines, deviation masks are also</span>
<span class="sd">    examined. Score will be 0.65 if deviation masks with any widths</span>
<span class="sd">    exist. Returned QAScore objects are the collection of scores from</span>
<span class="sd">    both spectral lines and deviation masks but they can be</span>
<span class="sd">    differentiated by the associated messages and/or metric units.</span>

<span class="sd">    Relevant JIRA tickets:</span>
<span class="sd">        PIPE-2136</span>
<span class="sd">        PIPEREQ-304</span>

<span class="sd">    Args:</span>
<span class="sd">        reduction_group: Reduction group</span>
<span class="sd">        result: Result object generated by hsd_baseline stage</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of QAScore objects derived from line detection results</span>
<span class="sd">        and/or deviation masks</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line_detection_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># deviation_mask_qa_data collects set of (spw_id, antenna_id, masked_ranges)</span>
    <span class="c1"># data per field per EB</span>
    <span class="n">deviation_mask_qa_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">deviation_mask_all</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;deviation_mask&#39;</span><span class="p">]</span>

    <span class="c1"># edge parameter</span>
    <span class="c1"># channels specified by edge will be excluded from resulting images</span>
    <span class="n">_edge</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>
    <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">_edge</span><span class="p">,</span> <span class="n">_edge</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_edge</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">_edge</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">bl</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;baselined&#39;</span><span class="p">]:</span>
        <span class="n">reduction_group_id</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;group_id&#39;</span><span class="p">]</span>
        <span class="n">reduction_group_desc</span> <span class="o">=</span> <span class="n">reduction_group</span><span class="p">[</span><span class="n">reduction_group_id</span><span class="p">]</span>
        <span class="n">member_list</span> <span class="o">=</span> <span class="n">bl</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">reduction_group_desc</span><span class="o">.</span><span class="n">field_name</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">reduction_group_desc</span><span class="p">[</span><span class="n">member_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">spw</span>
        <span class="c1"># sideband is 1 for USB, -1 for LSB</span>
        <span class="n">sideband</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">sideband</span><span class="p">)</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">reduction_group_desc</span><span class="o">.</span><span class="n">nchan</span>

        <span class="c1"># deviation mask</span>
        <span class="k">for</span> <span class="n">member_id</span> <span class="ow">in</span> <span class="n">member_list</span><span class="p">:</span>
            <span class="n">reduction_group_member</span> <span class="o">=</span> <span class="n">reduction_group_desc</span><span class="p">[</span><span class="n">member_id</span><span class="p">]</span>
            <span class="n">deviation_masks</span> <span class="o">=</span> <span class="n">select_deviation_masks</span><span class="p">(</span>
                <span class="n">deviation_mask_all</span><span class="p">,</span> <span class="n">reduction_group_member</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">deviation_masks</span><span class="p">:</span>
                <span class="n">data_per_field</span> <span class="o">=</span> <span class="n">deviation_mask_qa_data</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>
                <span class="n">spw_id</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">spw_id</span>
                <span class="n">ms_name</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span>
                <span class="n">antenna_name</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">antenna_name</span>
                <span class="n">data_per_field</span><span class="p">[</span><span class="n">ms_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">antenna_name</span><span class="p">,</span> <span class="n">deviation_masks</span><span class="p">))</span>

        <span class="c1"># spectral lines</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">get_line_ranges</span><span class="p">(</span><span class="n">bl</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># sort lines by left channel</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="n">is_edge_line</span> <span class="o">=</span> <span class="n">examine_sd_edge_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
            <span class="n">is_wide_line</span> <span class="o">=</span> <span class="n">examine_sd_wide_lines</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">is_edge_line</span> <span class="ow">and</span> <span class="n">is_wide_line</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.55</span>  <span class="c1"># min(0.55, 0.6)</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Edge and wide lines were detected&#39;</span>
            <span class="k">elif</span> <span class="n">is_edge_line</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.55</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Edge line was detected&#39;</span>
            <span class="k">elif</span> <span class="n">is_wide_line</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.6</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Wide line was detected&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># detected lines do not harm baseline subtraction</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Line ranges were detected&#39;</span>

            <span class="n">spw_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">reduction_group_desc</span><span class="p">[</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">spw_id</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">member_list</span><span class="p">)</span>
            <span class="n">spw_desc</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">spw_ids</span><span class="p">))</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1"> in Field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">, Spw </span><span class="si">{</span><span class="n">spw_desc</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">lines_image</span> <span class="o">=</span> <span class="n">channel_ranges_for_image</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">sideband</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
            <span class="n">metric_value</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="n">lines_image</span><span class="p">])</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sd_line_detection&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="n">metric_value</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Channel range(s) of detected lines&#39;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">spw_desc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)),</span>
                                                <span class="n">field</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">field_name</span><span class="p">]),</span>
                                                <span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">})</span>
            <span class="n">line_detection_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_detection_scores</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># add new entry with score of 0.8 if no spectral lines</span>
        <span class="c1"># were detected in any spws/fields</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.8</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;No line ranges were detected in all SPWs.&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No line ranges were detected in all SPWs.&#39;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sd_line_detection&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="s1">&#39;N/A&#39;</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Channel range(s) of detected lines&#39;</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">})</span>
        <span class="n">line_detection_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
                <span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">selection</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># dictionary for spw setup</span>
    <span class="n">spw_config_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">reduction_group_desc</span> <span class="ow">in</span> <span class="n">reduction_group</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">reduction_group_member</span> <span class="ow">in</span> <span class="n">reduction_group_desc</span><span class="p">:</span>
            <span class="n">ms_name</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">reduction_group_member</span><span class="o">.</span><span class="n">spw</span>
            <span class="n">spw_id</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">num_channels</span>
            <span class="n">sideband</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">sideband</span><span class="p">)</span>
            <span class="n">dict_for_ms</span> <span class="o">=</span> <span class="n">spw_config_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ms_name</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">dict_for_spw</span> <span class="o">=</span> <span class="n">dict_for_ms</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">spw_id</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">dict_for_spw</span><span class="p">[</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchan</span>
            <span class="n">dict_for_spw</span><span class="p">[</span><span class="s1">&#39;sideband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sideband</span>

    <span class="c1"># generate deviation mask QA scores with merged spws and antennas</span>
    <span class="n">deviation_mask_scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">data_per_ms</span> <span class="ow">in</span> <span class="n">deviation_mask_qa_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">ms_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_per_ms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">spw_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>
            <span class="n">antenna_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">}</span>

            <span class="c1"># score is fixed to 0.65. See PIPE-2136 and PIPEREQ-304.</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.65</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Deviation mask was triggered&#39;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">spw_string</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spw_ids</span><span class="p">)))</span>
            <span class="n">antenna_string</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">antenna_names</span><span class="p">))</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1"> in EB </span><span class="si">{</span><span class="n">ms_name</span><span class="si">}</span><span class="s1">, Field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1">, Spw </span><span class="si">{</span><span class="n">spw_string</span><span class="si">}</span><span class="s1">, Antenna </span><span class="si">{</span><span class="n">antenna_string</span><span class="si">}</span><span class="s1">.&#39;</span>

            <span class="c1"># get list of unique mask ranges per spw</span>
            <span class="n">deviation_masks_per_spw</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">deviation_mask</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">deviation_masks_per_spw</span><span class="p">[</span><span class="n">spw_id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">deviation_mask</span><span class="p">))</span>

            <span class="c1"># metric value format: spw0:c0~c1:c2~c3,spw1:c4~c5</span>
            <span class="n">deviation_masks_for_image</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">deviation_masks</span> <span class="ow">in</span> <span class="n">deviation_masks_per_spw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">spw_config</span> <span class="o">=</span> <span class="n">spw_config_dict</span><span class="p">[</span><span class="n">ms_name</span><span class="p">][</span><span class="n">spw_id</span><span class="p">]</span>
                <span class="n">nchan</span> <span class="o">=</span> <span class="n">spw_config</span><span class="p">[</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span>
                <span class="n">sideband</span> <span class="o">=</span> <span class="n">spw_config</span><span class="p">[</span><span class="s1">&#39;sideband&#39;</span><span class="p">]</span>
                <span class="n">devmasks_image</span> <span class="o">=</span> <span class="n">channel_ranges_for_image</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">sideband</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deviation_masks</span><span class="p">))</span>
                <span class="n">deviation_masks_for_image</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">devmasks_image</span><span class="p">))</span>

            <span class="n">metric_value</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">spw_id</span><span class="si">}</span><span class="s1">:&#39;</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">left</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">right</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">deviation_masks</span><span class="p">)])</span>
                <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">deviation_masks</span> <span class="ow">in</span> <span class="n">deviation_masks_for_image</span>
            <span class="p">])</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sd_line_detection&#39;</span><span class="p">,</span>
                                  <span class="n">metric_score</span><span class="o">=</span><span class="n">metric_value</span><span class="p">,</span>
                                  <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Channel range(s) possibly affected by instrumental instabilities&#39;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">ms_name</span><span class="p">]),</span>
                                                <span class="n">spw</span><span class="o">=</span><span class="n">spw_ids</span><span class="p">,</span>
                                                <span class="n">field</span><span class="o">=</span><span class="nb">set</span><span class="p">([</span><span class="n">field_name</span><span class="p">]),</span>
                                                <span class="n">ant</span><span class="o">=</span><span class="n">antenna_names</span><span class="p">,</span>
                                                <span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">})</span>
            <span class="n">deviation_mask_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">applies_to</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="n">line_detection_scores</span> <span class="o">+</span> <span class="n">deviation_mask_scores</span>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sd_baseline_quality</span><span class="p">(</span><span class="n">vis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ant</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vspw</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">pol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stat</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">tuple</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return Pipeline QA score of baseline quality.</span>

<span class="sd">    Args:</span>
<span class="sd">        vis: MS name</span>
<span class="sd">        source: source name</span>
<span class="sd">        ant: antenna name</span>
<span class="sd">        vspw: virtual spw ID</span>
<span class="sd">        pol: polarization</span>
<span class="sd">        stat: a list of binned statistics</span>

<span class="sd">    Returns:</span>
<span class="sd">        Pipeline QA score of baseline quality.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Statistics of </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">ant</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">vspw</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">pol</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># See PIPEREQ-168 for details of QA metrics.</span>
    <span class="c1"># The values of bin_diff_ratio at the edges of ramp</span>
    <span class="n">ramp_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.8</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">)</span>
    <span class="c1"># The scores at the corresponding edges of ramp. These values are also</span>
    <span class="c1"># adopted in extrapolation beyond ramp_range.</span>
    <span class="n">score_range</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.33</span><span class="p">)</span>
    <span class="n">metric_func</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">ramp_range</span><span class="p">,</span> <span class="n">score_range</span><span class="p">,</span>
                                       <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">fill_value</span><span class="o">=</span><span class="n">score_range</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">:</span>
        <span class="n">diff_score</span> <span class="o">=</span>  <span class="n">metric_func</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">bin_diff_ratio</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff_score</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;rdiff = </span><span class="si">{</span><span class="n">s</span><span class="o">.</span><span class="n">bin_diff_ratio</span><span class="si">}</span><span class="s1"> -&gt; score = </span><span class="si">{</span><span class="n">diff_score</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">final_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="s1">&#39;Good&#39;</span>
    <span class="k">if</span> <span class="n">final_score</span> <span class="o">&lt;=</span> <span class="mf">0.66</span><span class="p">:</span>
        <span class="n">quality</span><span class="o">=</span><span class="s1">&#39;Poor&#39;</span>
    <span class="k">elif</span> <span class="n">final_score</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
        <span class="n">quality</span><span class="o">=</span><span class="s1">&#39;Moderate&#39;</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quality</span><span class="si">}</span><span class="s1"> baseline flatness&#39;</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">quality</span><span class="si">}</span><span class="s1"> baseline flatness in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">ant</span><span class="si">}</span><span class="s1">, virtual spw </span><span class="si">{</span><span class="n">vspw</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">pol</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_sd_baseline_quality&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Statistics of binned spectra&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">final_score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<div class="viewcode-block" id="score_checksources">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_checksources">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_checksources</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">gfluxscale</span><span class="p">,</span> <span class="n">gfluxscale_err</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Score a single field image of a point source by comparing the source</span>
<span class="sd">    reference position to the fitted position and the source reference flux</span>
<span class="sd">    to the fitted flux.</span>

<span class="sd">    The source is assumed to be near the center of the image.</span>
<span class="sd">    The fit is performed using pixels in a circular regions</span>
<span class="sd">    around the center of the image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>

    <span class="c1"># Get the reference direction of the check source field</span>
    <span class="c1">#    There is at least one field with check source intent</span>
    <span class="c1">#    Protect against the same source having multiple fields</span>
    <span class="c1">#    with different intent.</span>
    <span class="c1">#    Assume that the same field as defined by its field name</span>
    <span class="c1">#    has the same direction in all the mses that contributed</span>
    <span class="c1">#    to the input image. Loop through the ms(s) and find the</span>
    <span class="c1">#    first occurrence of the specified field. Convert the</span>
    <span class="c1">#    direction to ICRS to match the default image coordinate</span>
    <span class="c1">#    system</span>

    <span class="n">refdirection</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">fieldname</span><span class="p">)</span>
        <span class="c1"># No fields with the check source name. Should be</span>
        <span class="c1"># impossible at this point but check just in case</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Find check field for that ms</span>
        <span class="n">chkfield</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fielditem</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;CHECK&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fielditem</span><span class="o">.</span><span class="n">intents</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">chkfield</span> <span class="o">=</span> <span class="n">fielditem</span>
            <span class="k">break</span>
        <span class="c1"># No matching check field for that ms, next ms</span>
        <span class="k">if</span> <span class="n">chkfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Found field, get reference direction in ICRS coordinates</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using field name </span><span class="si">%s</span><span class="s1"> id </span><span class="si">%s</span><span class="s1"> to determine check source reference direction&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">chkfield</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chkfield</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>
        <span class="n">refdirection</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">chkfield</span><span class="o">.</span><span class="n">mdirection</span><span class="p">,</span> <span class="s1">&#39;ICRS&#39;</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="c1"># Get the reference flux of the check source field</span>
    <span class="c1">#    Loop over all the ms(s) extracting the derived flux</span>
    <span class="c1">#    values for the specified field and spw. Set the reference</span>
    <span class="c1">#    flux to the maximum of these values.</span>
    <span class="n">reffluxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ms</span><span class="o">.</span><span class="n">derived_fluxes</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">field_arg</span><span class="p">,</span> <span class="n">measurements</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">derived_fluxes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mfield</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_arg</span><span class="p">)</span>
            <span class="n">chkfield</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">mfielditem</span> <span class="ow">in</span> <span class="n">mfield</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mfielditem</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">fieldname</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s1">&#39;CHECK&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mfielditem</span><span class="o">.</span><span class="n">intents</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">chkfield</span> <span class="o">=</span> <span class="n">mfielditem</span>
                <span class="k">break</span>
            <span class="c1"># No matching check field for this ms</span>
            <span class="k">if</span> <span class="n">chkfield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using field name </span><span class="si">%s</span><span class="s1"> id </span><span class="si">%s</span><span class="s1"> to identify check source flux densities&#39;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">chkfield</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chkfield</span><span class="o">.</span><span class="n">id</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">measurements</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">spw_id</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">measurement</span><span class="o">.</span><span class="n">spw_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">spwid</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">stokes</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">flux</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">stokes</span><span class="p">)</span>
                        <span class="n">flux_jy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FluxDensityUnits</span><span class="o">.</span><span class="n">JANSKY</span><span class="p">))</span>
                        <span class="n">reffluxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flux_jy</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

    <span class="c1"># Use the maximum reference flux</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">reffluxes</span><span class="p">:</span>
        <span class="n">refflux</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">median_flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">reffluxes</span><span class="p">))</span>
        <span class="n">refflux</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">median_flux</span><span class="p">,</span> <span class="s1">&#39;Jy&#39;</span><span class="p">)</span>

    <span class="c1"># Do the fit and compute positions offsets and flux ratios</span>
    <span class="n">fitdict</span> <span class="o">=</span> <span class="n">checksource</span><span class="o">.</span><span class="n">checkimage</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">refdirection</span><span class="p">,</span> <span class="n">refflux</span><span class="p">)</span>

    <span class="n">msnames</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">remove_trailing_string</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;.ms&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">)</span>

    <span class="c1"># Compute the scores the default score is the geometric mean of</span>
    <span class="c1"># the position and flux scores if both are available.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitdict</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">offset_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">beams_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fitflux</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fitflux_err</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fitpeak</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.34</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Check source fit failed for </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1"> spwid </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msnames</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Check source fit failed&#39;</span>
        <span class="n">metric_score</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">metric_units</span> <span class="o">=</span> <span class="s1">&#39;Check source fit failed&#39;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;positionoffset&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="n">offset_err</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;positionoffset_err&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span>
        <span class="n">beams</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;beamoffset&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">beams_err</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;beamoffset_err&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">fitflux</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;fitflux&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">fitflux_err</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;fitflux_err&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">fitpeak</span> <span class="o">=</span> <span class="n">fitdict</span><span class="p">[</span><span class="s1">&#39;fitpeak&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Check source fit successful&#39;</span>

        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">offset_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">offset_metric</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">offset_unit</span> <span class="o">=</span> <span class="s1">&#39;beams&#39;</span>
        <span class="k">if</span> <span class="n">beams</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unfitted offset&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">beams</span><span class="p">))</span>
            <span class="n">offset_metric</span> <span class="o">=</span> <span class="n">beams</span>
            <span class="k">if</span> <span class="n">beams</span> <span class="o">&gt;</span> <span class="mf">0.30</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;large fitted offset of </span><span class="si">%.2f</span><span class="s1"> marcsec and </span><span class="si">%.2f</span><span class="s1"> synth beam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">beams</span><span class="p">))</span>

        <span class="n">fitflux_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fitflux_metric</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">fitflux_unit</span> <span class="o">=</span> <span class="s1">&#39;fitflux/refflux&#39;</span>
        <span class="k">if</span> <span class="n">gfluxscale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;undefined gfluxscale result&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">gfluxscale</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gfluxscale value of 0.0 mJy&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chk_fitflux_gfluxscale_ratio</span> <span class="o">=</span> <span class="n">fitflux</span> <span class="o">*</span> <span class="mf">1000.</span> <span class="o">/</span> <span class="n">gfluxscale</span>
            <span class="n">fitflux_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">chk_fitflux_gfluxscale_ratio</span><span class="p">))</span>
            <span class="n">fitflux_metric</span> <span class="o">=</span> <span class="n">chk_fitflux_gfluxscale_ratio</span>
            <span class="k">if</span> <span class="n">chk_fitflux_gfluxscale_ratio</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;low [Fitted / gfluxscale] Flux Density Ratio of </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chk_fitflux_gfluxscale_ratio</span><span class="p">))</span>

        <span class="n">fitpeak_score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fitpeak_metric</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">fitpeak_unit</span> <span class="o">=</span> <span class="s1">&#39;fitpeak/fitflux&#39;</span>
        <span class="k">if</span> <span class="n">fitflux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;undefined check fit result&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fitflux</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Fitted Flux Density value of 0.0 mJy&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chk_fitpeak_fitflux_ratio</span> <span class="o">=</span> <span class="n">fitpeak</span> <span class="o">/</span> <span class="n">fitflux</span>
            <span class="n">fitpeak_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.33</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">chk_fitpeak_fitflux_ratio</span><span class="p">)))</span>
            <span class="n">fitpeak_metric</span> <span class="o">=</span> <span class="n">chk_fitpeak_fitflux_ratio</span>
            <span class="k">if</span> <span class="n">chk_fitpeak_fitflux_ratio</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;low Fitted [Peak Intensity / Flux Density] Ratio of </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chk_fitpeak_fitflux_ratio</span><span class="p">))</span>

        <span class="n">snr_msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">gfluxscale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">gfluxscale_err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">gfluxscale_err</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">chk_gfluxscale_snr</span> <span class="o">=</span> <span class="n">gfluxscale</span> <span class="o">/</span> <span class="n">gfluxscale_err</span>
                <span class="k">if</span> <span class="n">chk_gfluxscale_snr</span> <span class="o">&lt;</span> <span class="mf">20.</span><span class="p">:</span>
                    <span class="n">snr_msg</span> <span class="o">=</span> <span class="s1">&#39;, however, the S/N of the gfluxscale measurement is low&#39;</span>

        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offset_score</span><span class="p">,</span> <span class="n">fitflux_score</span><span class="p">,</span> <span class="n">fitpeak_score</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">offset_score</span> <span class="o">*</span> <span class="n">fitflux_score</span> <span class="o">*</span> <span class="n">fitpeak_score</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">offset_score</span> <span class="o">*</span> <span class="n">fitflux_score</span> <span class="o">*</span> <span class="n">fitpeak_score</span>
        <span class="n">metric_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">offset_metric</span><span class="p">,</span> <span class="n">fitflux_metric</span><span class="p">,</span> <span class="n">fitpeak_metric</span><span class="p">]</span>
        <span class="n">metric_units</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">offset_unit</span><span class="p">,</span> <span class="n">fitflux_unit</span><span class="p">,</span> <span class="n">fitpeak_unit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">warnings</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;EB </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1"> spwid </span><span class="si">%d</span><span class="s1">: has a </span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msnames</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="s1">&#39; and a &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">warnings</span><span class="p">),</span> <span class="n">snr_msg</span><span class="p">)</span>
            <span class="c1"># Log warnings only if they would not be logged by the QA system (score &lt;= 0.66)</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="mf">0.66</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">longmsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;EB </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1"> spwid </span><span class="si">%d</span><span class="s1">: Check source fit not optimal&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msnames</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;EB </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1"> spwid </span><span class="si">%d</span><span class="s1">: Check source fit successful&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msnames</span><span class="p">,</span> <span class="n">fieldname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;=</span> <span class="mf">0.9</span><span class="p">:</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Check source fit not optimal&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;ScoreChecksources&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">metric_score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="n">metric_units</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset_err</span><span class="p">,</span> <span class="n">beams</span><span class="p">,</span> <span class="n">beams_err</span><span class="p">,</span> <span class="n">fitflux</span><span class="p">,</span> <span class="n">fitflux_err</span><span class="p">,</span> <span class="n">fitpeak</span></div>



<div class="viewcode-block" id="score_multiply">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_multiply">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_multiply</span><span class="p">(</span><span class="n">scores_list</span><span class="p">):</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">scores_list</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Multiplication of scores.&#39;</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Multiplication of scores.&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_multiply&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">scores_list</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of multiplied scores.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sd_skycal_elevation_difference</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">resultdict</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resultdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">metric_score</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">el_threshold</span> <span class="o">=</span> <span class="n">threshold</span>
    <span class="n">lmsg_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">:</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">field_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resultdict</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">eldiffant</span> <span class="o">=</span> <span class="n">resultdict</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span>
        <span class="n">warned_antennas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">antenna_id</span><span class="p">,</span> <span class="n">eldiff</span> <span class="ow">in</span> <span class="n">eldiffant</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">eld</span> <span class="ow">in</span> <span class="n">eldiff</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">preceding</span> <span class="o">=</span> <span class="n">eld</span><span class="o">.</span><span class="n">eldiff0</span>
                <span class="n">subsequent</span> <span class="o">=</span> <span class="n">eld</span><span class="o">.</span><span class="n">eldiff1</span>
                <span class="c1"># LOG.info(&#39;field {} antenna {} spw {} preceding={}&#39;.format(field_id, antenna_id, spw_id, preceding))</span>
                <span class="c1"># LOG.info(&#39;field {} antenna {} spw {} subsequent={}&#39;.format(field_id, antenna_id, spw_id, subsequent))</span>
                <span class="n">max_pred</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">max_subq</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">preceding</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">max_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">preceding</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">metric_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_pred</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">max_pred</span> <span class="o">&gt;=</span> <span class="n">el_threshold</span><span class="p">:</span>
                        <span class="n">warned_antennas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">antenna_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subsequent</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">max_subq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">subsequent</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                    <span class="n">metric_score</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_subq</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">max_subq</span> <span class="o">&gt;=</span> <span class="n">el_threshold</span><span class="p">:</span>
                        <span class="n">warned_antennas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">antenna_id</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;field </span><span class="si">{}</span><span class="s1"> antenna </span><span class="si">{}</span><span class="s1"> spw </span><span class="si">{}</span><span class="s1"> metric_score </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field_id</span><span class="p">,</span> <span class="n">antenna_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">metric_score</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warned_antennas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">antenna_names</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">warned_antennas</span><span class="p">])</span>
            <span class="n">lmsg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="s1">&#39;field </span><span class="si">{}</span><span class="s1"> (antennas </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lmsg_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Elevation difference between ON and OFF exceeds threshold (</span><span class="si">{}</span><span class="s1">deg) for </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">el_threshold</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
            <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lmsg_list</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Elevation difference between ON and OFF is below threshold (</span><span class="si">{}</span><span class="s1">deg) for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">el_threshold</span><span class="p">,</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span>
        <span class="p">)</span>

    <span class="c1"># CAS-11054: it is decided that we do not calculate QA score based on elevation difference for Cycle 6</span>
    <span class="c1"># PIPE-246: we implement QA score based on elevation difference for Cycle 7.</span>
    <span class="c1">#           requirement is that score is 0.8 if elevation difference is larger than 3deg.</span>
    <span class="c1"># make sure threshold is 3deg</span>
    <span class="k">assert</span> <span class="n">el_threshold</span> <span class="o">==</span> <span class="mf">3.0</span>
    <span class="n">max_metric_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">metric_score</span><span class="p">)</span>
    <span class="c1"># lower the score if elevation difference exceeds 3deg</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="k">if</span> <span class="n">max_metric_score</span> <span class="o">&lt;</span> <span class="n">el_threshold</span> <span class="k">else</span> <span class="mf">0.8</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;OnOffElevationDifference&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">max_metric_score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Elevation difference between ON and OFF exceeds </span><span class="si">{}</span><span class="s1">deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el_threshold</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Elevation difference between ON and OFF is below </span><span class="si">{}</span><span class="s1">deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">el_threshold</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_metric_mask</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate boolean mask array for metric calculation in</span>
<span class="sd">    score_sdimage_masked_pixels. If image pixel contains</span>
<span class="sd">    observed points, mask will be True. Otherwise, mask is</span>
<span class="sd">    False.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        context {Context} -- Pipeline context</span>
<span class="sd">        result {SDImagingResultItem} -- result item created by</span>
<span class="sd">                                        hsd_imaging</span>
<span class="sd">        cs {coordsys} -- CASA coordsys tool</span>
<span class="sd">        mask {bool array} -- image mask</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool array -- metric mask (True: valid, False: invalid)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">outcome</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span>
    <span class="n">org_direction</span> <span class="o">=</span> <span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">org_direction</span>
    <span class="n">imshape</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">file_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;file_index&#39;</span><span class="p">])</span>
    <span class="n">antenna_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_antennas&#39;</span><span class="p">])</span>
    <span class="n">field_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_fields&#39;</span><span class="p">])</span>
    <span class="n">vspw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_spws&#39;</span><span class="p">])</span>

    <span class="n">mses</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span>
    <span class="n">ms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">file_index</span><span class="p">]</span>
    <span class="n">spw_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vspw_list</span><span class="p">,</span> <span class="n">ms_list</span><span class="p">)])</span>

    <span class="n">ra</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ofs_ra</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ofs_dec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">online_flag</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms_list</span><span class="p">)):</span>
        <span class="n">origin_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="n">datatable_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">ms_datatable_name</span><span class="p">,</span> <span class="n">origin_basename</span><span class="p">)</span>
        <span class="n">rotable_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datatable_name</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">)</span>
        <span class="n">rwtable_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datatable_name</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">)</span>
        <span class="n">_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">file_index</span> <span class="o">==</span> <span class="n">file_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">_antlist</span> <span class="o">=</span> <span class="n">antenna_list</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_fieldlist</span> <span class="o">=</span> <span class="n">field_list</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>
        <span class="n">_spwlist</span> <span class="o">=</span> <span class="n">spw_list</span><span class="p">[</span><span class="n">_index</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">rotable_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">unit_ra</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;OFS_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
            <span class="n">unit_dec</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;OFS_DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
            <span class="n">tsel</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SRCTYPE==0&amp;&amp;ANTENNA IN </span><span class="si">{}</span><span class="s1">&amp;&amp;FIELD_ID IN </span><span class="si">{}</span><span class="s1">&amp;&amp;IF IN </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">_antlist</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">_fieldlist</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">_spwlist</span><span class="p">)))</span>
            <span class="n">ofs_ra</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;OFS_RA&#39;</span><span class="p">))</span>
            <span class="n">ofs_dec</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;OFS_DEC&#39;</span><span class="p">))</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">rownumbers</span><span class="p">()</span>
            <span class="n">tsel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">rwtable_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">permanent_flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">online_flag</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">permanent_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">OnlineFlagIndex</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">org_direction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ofs_ra</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ofs_dec</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">rr</span><span class="p">,</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ofs_ra</span><span class="p">,</span> <span class="n">ofs_dec</span><span class="p">):</span>
            <span class="n">shift_ra</span><span class="p">,</span> <span class="n">shift_dec</span> <span class="o">=</span> <span class="n">direction_recover</span><span class="p">(</span> <span class="n">rr</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">org_direction</span> <span class="p">)</span>
            <span class="n">ra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_ra</span><span class="p">)</span>
            <span class="n">dec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shift_dec</span><span class="p">)</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">online_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">online_flag</span><span class="p">)</span>

    <span class="k">del</span> <span class="n">ofs_ra</span><span class="p">,</span> <span class="n">ofs_dec</span>

    <span class="n">metric_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">imshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">metric_mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

    <span class="c1"># template measure for world-pixel conversion</span>
    <span class="c1"># 2019/06/03 TN</span>
    <span class="c1"># Workaround for memory consumption issue (PIPE-362)</span>
    <span class="c1"># cs.topixel consumes some amount of memory and it accumulates,</span>
    <span class="c1"># too many call of cs.topixel results in unexpectedly large amount of</span>
    <span class="c1"># memory usage. To avoid cs.topixel, approximate mapping to pixel</span>
    <span class="c1"># coordinate is done manually.</span>
    <span class="n">blc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">toworld</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">brc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">toworld</span><span class="p">([</span><span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">tlc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">toworld</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="n">trc</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">toworld</span><span class="p">([</span><span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">)</span>
    <span class="c1">#print(&#39;blc {} {}&#39;.format(blc[&#39;quantity&#39;][&#39;*1&#39;], blc[&#39;quantity&#39;][&#39;*2&#39;]))</span>
    <span class="c1">#print(&#39;brc {} {}&#39;.format(brc[&#39;quantity&#39;][&#39;*1&#39;], brc[&#39;quantity&#39;][&#39;*2&#39;]))</span>
    <span class="c1">#print(&#39;tlc {} {}&#39;.format(tlc[&#39;quantity&#39;][&#39;*1&#39;], tlc[&#39;quantity&#39;][&#39;*2&#39;]))</span>
    <span class="c1">#print(&#39;trc {} {}&#39;.format(trc[&#39;quantity&#39;][&#39;*1&#39;], trc[&#39;quantity&#39;][&#39;*2&#39;]))</span>
    <span class="c1">#print(&#39;cen {} {}&#39;.format(cen[&#39;quantity&#39;][&#39;*1&#39;], cen[&#39;quantity&#39;][&#39;*2&#39;]))</span>
    <span class="n">cpi</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">s0</span> <span class="o">=</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tlc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> \
        <span class="o">/</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tlc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="p">((</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">cpi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">cpi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">cpi</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">trc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">brc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> \
        <span class="o">/</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">trc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">brc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="p">((</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">brc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*1&#39;</span><span class="p">],</span> <span class="n">unit_ra</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">cpi</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">cpi</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">cpi</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">tlc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">trc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">brc</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">][</span><span class="s1">&#39;*2&#39;</span><span class="p">],</span> <span class="n">unit_dec</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#print(&#39;s0 {} t0 {} s1 {} t1 {}&#39;.format(s0, t0, s1, t1))</span>
    <span class="c1">#print(&#39;ymax {} ymin {} dy {}&#39;.format(ymax, ymin, dy))</span>
    <span class="c1">#world = cs.toworld([0, 0, 0, 0], format=&#39;m&#39;)</span>
    <span class="n">px</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">py</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">px</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">py</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">online_flag</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># PIPE-439 flagged pointing data are not taken into account</span>
            <span class="k">continue</span>

        <span class="c1">#world[&#39;measure&#39;][&#39;direction&#39;][&#39;m0&#39;][&#39;value&#39;] = qa.quantity(x, unit_ra)</span>
        <span class="c1">#world[&#39;measure&#39;][&#39;direction&#39;][&#39;m1&#39;][&#39;value&#39;] = qa.quantity(y, unit_dec)</span>
        <span class="c1">#p = cs.topixel(world)</span>
        <span class="c1">#px[i] = p[&#39;numeric&#39;][0]</span>
        <span class="c1">#py[i] = p[&#39;numeric&#39;][1]</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">+</span> <span class="n">t0</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">+</span> <span class="n">t1</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#print(&#39;xmin {} xmax {} dx {}&#39;.format(xmin, xmax, dx))</span>
        <span class="c1">#print(&#39;x {} y {}&#39;.format(x, y))</span>
        <span class="n">py</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="n">dy</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">px</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="n">dx</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="c1">#print(&#39;WORLD {} {} &lt;-&gt; PIXEL {} {}&#39;.format(x, y, px[i], py[i]))</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">px</span><span class="p">)),</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">py</span><span class="p">))):</span>
        <span class="c1">#print(x, y)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="n">imshape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">metric_mask</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># exclude edge channels</span>
    <span class="n">edge_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imshape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;edge channels: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">edge_channels</span><span class="p">))</span>
    <span class="n">metric_mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">edge_channels</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">metric_mask</span>


<span class="k">def</span> <span class="nf">direction_recover</span><span class="p">(</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">org_direction</span> <span class="p">):</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
    <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

    <span class="n">direction</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span> <span class="n">org_direction</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">],</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;deg&#39;</span> <span class="p">)</span>
    <span class="n">zero_direction</span>  <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span> <span class="n">org_direction</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">],</span> <span class="s1">&#39;0deg&#39;</span><span class="p">,</span> <span class="s1">&#39;0deg&#39;</span> <span class="p">)</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span> <span class="n">zero_direction</span><span class="p">,</span> <span class="n">direction</span> <span class="p">)</span>
    <span class="n">posang</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">posangle</span><span class="p">(</span> <span class="n">zero_direction</span><span class="p">,</span> <span class="n">direction</span> <span class="p">)</span>
    <span class="n">new_direction</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span> <span class="n">org_direction</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="n">posang</span> <span class="p">)</span>
    <span class="n">new_ra</span>  <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span> <span class="n">new_direction</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="s1">&#39;deg&#39;</span> <span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">new_dec</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span> <span class="n">new_direction</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="s1">&#39;deg&#39;</span> <span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">new_ra</span><span class="p">,</span> <span class="n">new_dec</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sdimage_masked_pixels</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate QA score based on the fraction of masked pixels in image.</span>


<span class="sd">    Requirements (PIPE-249):</span>
<span class="sd">        - calculate the number of masked pixels in image</span>
<span class="sd">        - search area should be the extent of pointing direction</span>
<span class="sd">        - QA score should be</span>
<span class="sd">            1.0 (if the nuber of masked pixel == 0)</span>
<span class="sd">            0.5 (if any of the pixel in pointing area is masked)</span>
<span class="sd">            0.0 (if 10% of the pixels in pointing area are masked)</span>
<span class="sd">            *linearly interpolate between 0.5 and 0.0</span>

<span class="sd">    Arguments:</span>
<span class="sd">        context {Context} -- Pipeline context</span>
<span class="sd">        result {SDImagingResultItem} -- Imaging result instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        QAScore -- QAScore instance holding the score based on number of</span>
<span class="sd">                   masked pixels in image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># metric score is a fraction of masked pixels</span>
    <span class="n">result_item</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span>
    <span class="n">image_item</span> <span class="o">=</span> <span class="n">result_item</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
    <span class="n">imagename</span> <span class="o">=</span> <span class="n">image_item</span><span class="o">.</span><span class="n">imagename</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;imagename = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imagename</span><span class="p">))</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
        <span class="c1"># get mask</span>
        <span class="c1"># Mask Definition: True is valid, False is invalid.</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">imageshape</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>

        <span class="c1"># cs represents coordinate system of the image</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>

    <span class="c1"># image shape: (lon, lat, stokes, freq)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;image shape: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">imageshape</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># metric_mask is boolean array that defines the region to be excluded</span>
        <span class="c1">#    True: included in the metric calculation</span>
        <span class="c1">#   False: excluded from the metric calculation</span>
        <span class="c1"># TODO: decide if any margin is necessary</span>
        <span class="n">metric_mask</span> <span class="o">=</span> <span class="n">generate_metric_mask</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># done using coordsys tool</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="c1"># calculate metric_score</span>
    <span class="n">total_pixels</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">metric_mask</span><span class="p">]</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Total number of pixels to be included in: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total_pixels</span><span class="p">)))</span>
    <span class="n">masked_pixels</span> <span class="o">=</span> <span class="n">total_pixels</span><span class="p">[</span><span class="n">total_pixels</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">total_pixels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No pixels associated with pointing data exist. QA score will be zero.&#39;</span><span class="p">)</span>
        <span class="n">metric_score</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">masked_fraction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masked_pixels</span><span class="p">))</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">total_pixels</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Number of masked pixels: </span><span class="si">{}</span><span class="s1"> fraction </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masked_pixels</span><span class="p">),</span> <span class="n">masked_fraction</span><span class="p">))</span>
        <span class="n">metric_score</span> <span class="o">=</span> <span class="n">masked_fraction</span>

    <span class="c1"># score should be evaluated from metric score</span>
    <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">metric_score_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">metric_score_max</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">metric_score_min</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># convert score and threshold for logging purpose</span>
    <span class="n">frac2percentage</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{:.4g}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">imbasename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">imagename</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">metric_score</span> <span class="o">&gt;</span> <span class="n">metric_score_max</span><span class="p">:</span>
        <span class="c1"># metric_score should not exceed 1.0. something wrong.</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">frac2percentage</span><span class="p">(</span><span class="n">metric_score_max</span><span class="p">)</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: fraction of number of masked pixels should not exceed </span><span class="si">{}</span><span class="s1">. something went wrong.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imbasename</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;metric value out of range.&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="n">metric_score</span> <span class="o">&lt;</span> <span class="n">metric_score_min</span><span class="p">:</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: No pixels associated with pointing data exist. something went wrong.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imbasename</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;metric value out of range.&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="n">metric_score</span> <span class="o">==</span> <span class="n">metric_score_min</span><span class="p">:</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;All examined pixels in image </span><span class="si">{}</span><span class="s1"> are valid.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imbasename</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;All examined pixels are valid.&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">metric_score</span> <span class="o">&gt;</span> <span class="n">metric_score_threshold</span><span class="p">:</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">frac2percentage</span><span class="p">(</span><span class="n">metric_score_threshold</span><span class="p">)</span>
        <span class="n">_y</span> <span class="o">=</span> <span class="n">frac2percentage</span><span class="p">(</span><span class="n">metric_score</span><span class="p">)</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;Fraction of masked pixels in image </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">, exceeding threshold value (</span><span class="si">{}</span><span class="s1">).&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imbasename</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;More than </span><span class="si">{}</span><span class="s1"> of image pixels are masked.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># interpolate between 0.5 and 0.0</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">frac2percentage</span><span class="p">(</span><span class="n">metric_score</span><span class="p">)</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="s1">&#39;Fraction of masked pixels in image </span><span class="si">{}</span><span class="s1"> is </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">imbasename</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> of image pixels are masked.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span>
        <span class="n">smax</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">mmax</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">smin</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">mmin</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">score</span> <span class="o">=</span> <span class="p">(</span><span class="n">smax</span> <span class="o">-</span> <span class="n">smin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">mmax</span> <span class="o">-</span> <span class="n">mmin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">metric_score</span> <span class="o">-</span> <span class="n">mmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">smin</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;SingleDishImageMaskedPixels&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">metric_score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of masked pixels in image&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span>
                       <span class="n">longmsg</span><span class="o">=</span><span class="n">lmsg</span><span class="p">,</span>
                       <span class="n">shortmsg</span><span class="o">=</span><span class="n">smsg</span><span class="p">,</span>
                       <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_sdimage_contamination</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="s1">&#39;SDImagingResultItem&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate QA score based on the absorption feature in the image.</span>

<span class="sd">    If there is an emission at OFF_SOURCE position (contamination),</span>
<span class="sd">    it is emerged as an absorption feature in the calibrated spectra.</span>
<span class="sd">    Therefore, this QA score utilizes any significant absorption</span>
<span class="sd">    features as an indicator of potential contamination.</span>

<span class="sd">    Requirements (PIPE-2066):</span>
<span class="sd">        - QA score should be</span>
<span class="sd">          - 0.65 if absorption feature exists</span>
<span class="sd">          - 1.0 if absorption feature does not exist</span>

<span class="sd">    Args:</span>
<span class="sd">        context: Pipeline context</span>
<span class="sd">        result: Imaging result instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        QAScore -- QAScore instance holding the score based on the</span>
<span class="sd">                   existence of the absorption feature in the image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contaminated</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contaminated&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">imageitem</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">imageitem</span><span class="o">.</span><span class="n">sourcename</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">imageitem</span><span class="o">.</span><span class="n">spwlist</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">contaminated</span><span class="p">:</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> Spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">: &#39;</span>
                <span class="s1">&#39;Possible astronomical line contamination was detected. &#39;</span>
                <span class="s1">&#39;Please check the contamination plots.&#39;</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;Possible astronomical line contamination was detected.&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.65</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> Spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">: &#39;</span>
                <span class="s1">&#39;No astronomical line contamintaion was detected.&#39;</span><span class="p">)</span>
        <span class="n">smsg</span> <span class="o">=</span> <span class="s1">&#39;No astronomical line contamination was detected.&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;SingleDishImageContamination&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">contaminated</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Sign of possible line contamination&#39;</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_spws&#39;</span><span class="p">]),</span>
                                        <span class="n">field</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_fields&#39;</span><span class="p">]),</span>
                                        <span class="n">intent</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">},</span>
                                        <span class="n">pol</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span>
                       <span class="n">longmsg</span><span class="o">=</span><span class="n">lmsg</span><span class="p">,</span>
                       <span class="n">shortmsg</span><span class="o">=</span><span class="n">smsg</span><span class="p">,</span>
                       <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
                       <span class="n">applies_to</span><span class="o">=</span><span class="n">selection</span><span class="p">)</span>


<div class="viewcode-block" id="score_gfluxscale_k_spw">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_gfluxscale_k_spw">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_gfluxscale_k_spw</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">k_spw</span><span class="p">,</span> <span class="n">ref_spw</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert internal spw_id-spw_id consistency ratio to a QA score.</span>

<span class="sd">    See CAS-10792 for full specification.</span>
<span class="sd">    See PIPE-644 for update to restrict range of scores.</span>

<span class="sd">    k_spw is equal to the ratio:</span>

<span class="sd">                       calibrated visibility flux / catalogue flux</span>
<span class="sd">    k_spw = --------------------------------------------------------------------</span>
<span class="sd">            (calibrated visibility flux / catalogue flux) for highest SNR window</span>

<span class="sd">    Q_spw = abs(1 - k_spw)</span>

<span class="sd">    If        Q_spw &lt; 0.1 then QA score = 1.0  (green)</span>
<span class="sd">    If 0.1 &lt;= Q_spw &lt; 0.2 then QA score = 0.75 (Blue/below standard)</span>
<span class="sd">    If 0.2 &lt;= Q_spw       then QA score = 0.5  (Yellow/warning)</span>

<span class="sd">    :param k_spw: numeric k_spw ratio, as per spec</span>
<span class="sd">    :param vis: name of measurement set to which k_spw applies</span>
<span class="sd">    :param field: field domain object to which k_spw applies</span>
<span class="sd">    :param spw_id: name of spectral window to which k_spw applies</span>
<span class="sd">    :return: QA score</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q_spw</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">k_spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">q_spw</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="n">q_spw</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.75</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Ratio of &lt;i&gt;S&lt;/i&gt;&lt;sub&gt;calibrated&lt;/sub&gt;/&lt;i&gt;S&lt;/i&gt;&lt;sub&gt;catalogue&lt;/sub&gt; for </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) spw </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1"> differs by&#39;</span>
               <span class="s1">&#39; </span><span class="si">{:.0%}</span><span class="s1"> from the ratio for the highest SNR spw (</span><span class="si">{}</span><span class="s1">)&#39;</span>
               <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">),</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">q_spw</span><span class="p">,</span> <span class="n">ref_spw</span><span class="p">))</span>
    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Internal spw-spw consistency&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_gfluxscale_k_spw&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">k_spw</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Number of spws with missing SNR measurements&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_science_spw_names">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_science_spw_names">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_science_spw_names</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">virtual_science_spw_names</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that all MSs have the same set of spw names. If this is</span>
<span class="sd">    not the case, the virtual spw mapping will not work.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">msgs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">:</span>
        <span class="n">spw_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">virtual_science_spw_names</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">spw_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> (ID </span><span class="si">{1}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">spw_msgs</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Science spw names </span><span class="si">{0}</span><span class="s1"> of EB </span><span class="si">{1}</span><span class="s1"> do not match spw names of first EB.&#39;</span>
                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spw_msgs</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">msgs</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;Science spw names match virtual spw lookup table&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Science spw names match&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> Virtual spw ID mapping will not work.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msgs</span><span class="p">))</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Science spw names do not match&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_spwnames&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;spw names match virtual spw name lookup table&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_renorm">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_renorm">[docs]</a>
<span class="k">def</span> <span class="nf">score_renorm</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">renorm_applied</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Restore successful with renormalization applied&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">rutils</span><span class="o">.</span><span class="n">SCORE_THRESHOLD_SUBOPTIMAL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Restore successful&#39;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_renormalize&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_polcal_gain_ratio">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polcal_gain_ratio">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polcal_gain_ratio</span><span class="p">(</span><span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ant_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">xyratio_result</span><span class="p">:</span> <span class="n">GaincalResults</span><span class="p">,</span>
                            <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This QA heuristic inspects the gain ratios in an X/Y gain ratio caltable</span>
<span class="sd">    and creates a score based on how large the deviation from one is.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_name: name of session being evaluated.</span>
<span class="sd">        ant_names: dictionary mapping antenna IDs to names.</span>
<span class="sd">        xyratio_result: Gaincal task result object containing the</span>
<span class="sd">            CalApplication for the caltable to analyze.</span>
<span class="sd">        threshold: threshold used to determine whether the gain ratio deviates</span>
<span class="sd">            too much from 1 (resulting in a lowered score).</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of QAScore objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Score each caltable in result.</span>
    <span class="k">for</span> <span class="n">calapp</span> <span class="ow">in</span> <span class="n">xyratio_result</span><span class="o">.</span><span class="n">final</span><span class="p">:</span>
        <span class="c1"># Retrieve data from caltable.</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">gains</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">))</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">ants</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>

        <span class="c1"># Score each SpW separately.</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spws</span><span class="p">)):</span>
            <span class="n">ind_spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spws</span> <span class="o">==</span> <span class="n">spwid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gains</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ind_spw</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">gains</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">ind_spw</span><span class="p">])</span>
            <span class="n">ind_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ratios</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_bad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.65</span>
                <span class="n">ant_str</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ant_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2"> (#</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ants</span><span class="p">[</span><span class="n">ind_bad</span><span class="p">]],</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has gain ratios deviate from 1 by more than </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> for SpW&quot;</span> \
                          <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s2">, antenna(s) </span><span class="si">{</span><span class="n">ant_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Large gain ratio deviation&quot;</span>
                <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_gain_ratio&#39;</span><span class="p">,</span>
                                      <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                                      <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;gain ratio&#39;</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="c1"># If no large deviations in gain ratio are found, then create a good score.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scores</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has gain ratios with deviations from 1 &lt;= the threshold of </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span> \
                  <span class="sa">f</span><span class="s2">&quot; for all SpWs and all antennas.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Gain ratio&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_gain_ratio&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;gain ratio&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span></div>



<div class="viewcode-block" id="score_polcal_gain_ratio_rms">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polcal_gain_ratio_rms">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polcal_gain_ratio_rms</span><span class="p">(</span><span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gain_ratio_rms</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">List</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This QA heuristic receives gain ratio RMS corresponding to scan IDs, and</span>
<span class="sd">    scores outliers beyond the threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_name: name of session being evaluated.</span>
<span class="sd">        gain_ratio_rms: tuple containing a list of scan IDs and a list of</span>
<span class="sd">            corresponding gain ratio RMS.</span>
<span class="sd">        threshold: threshold used to determine whether the gain ratio RMS is</span>
<span class="sd">            high enough to return a lowered score.</span>

<span class="sd">    Returns:</span>
<span class="sd">        QAScore object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Retrieve the gain ratio RMS and scan IDs.</span>
    <span class="n">scanids</span><span class="p">,</span> <span class="n">ratio_rms</span> <span class="o">=</span> <span class="n">gain_ratio_rms</span>

    <span class="c1"># Identify outlier gain ratio RMS</span>
    <span class="n">ind_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ratio_rms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_bad</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.6</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has gain ratio RMS greater than </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> in scan(s)&quot;</span> \
                  <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">scanids</span><span class="p">)[</span><span class="n">ind_bad</span><span class="p">]],</span><span class="w"> </span><span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;High gain ratio RMS&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has gain ratio RMS &lt;= the threshold of </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> for all scans.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Gain ratio RMS&quot;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_gain_ratio_rms&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;gain ratio rms&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_polcal_leakage">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polcal_leakage">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polcal_leakage</span><span class="p">(</span><span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ant_names</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">leakage_result</span><span class="p">:</span> <span class="n">PolcalWorkerResults</span><span class="p">,</span> <span class="n">th_poor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.10</span><span class="p">,</span>
                         <span class="n">th_bad</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This heuristic inspects the polarization calibrator leakage (D-terms)</span>
<span class="sd">    solutions caltable and create a score based on how large the deviation from</span>
<span class="sd">    zero is.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_name: name of session being evaluated.</span>
<span class="sd">        ant_names: dictionary mapping antenna IDs to names.</span>
<span class="sd">        leakage_result: PolcalWorker task result object containing the</span>
<span class="sd">            CalApplication for the leakage caltable to analyze.</span>
<span class="sd">        th_poor: threshold used to declare that leakage solutions are poor.</span>
<span class="sd">        th_bad: threshold used to declare that leakage solutions are bad.</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of QAScore objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Score each caltable in result.</span>
    <span class="k">for</span> <span class="n">calapp</span> <span class="ow">in</span> <span class="n">leakage_result</span><span class="o">.</span><span class="n">final</span><span class="p">:</span>
        <span class="c1"># Retrieve data from leakage solutions caltable.</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="c1"># Retrieve unique SpWs and antennas.</span>
            <span class="n">uniq_spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)))</span>
            <span class="n">uniq_ants</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)))</span>

            <span class="c1"># Score each SpW separately.</span>
            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">uniq_spws</span><span class="p">:</span>
                <span class="c1"># Retrieve D-terms for current SpW.</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPECTRAL_WINDOW_ID==</span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>
                <span class="n">dterms</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>

                <span class="c1"># For each antenna, check if the D-terms solutions exceed the</span>
                <span class="c1"># threshold.</span>
                <span class="n">bad_antids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">poor_antids</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">antid</span> <span class="ow">in</span> <span class="n">uniq_ants</span><span class="p">:</span>
                    <span class="n">pol1</span> <span class="o">=</span> <span class="n">dterms</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="n">antid</span><span class="p">]</span>
                    <span class="n">pol2</span> <span class="o">=</span> <span class="n">dterms</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">antid</span><span class="p">]</span>

                    <span class="n">rpol1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_bad</span>
                    <span class="n">ipol1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_bad</span>
                    <span class="n">rpol2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pol2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_bad</span>
                    <span class="n">ipol2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pol2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_bad</span>

                    <span class="k">if</span> <span class="n">rpol1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ipol1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">rpol2</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ipol2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">bad_antids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antid</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="n">rpol1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_poor</span>
                    <span class="n">ipol1</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pol1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_poor</span>
                    <span class="n">rpol2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">pol2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_poor</span>
                    <span class="n">ipol2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">pol2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">th_poor</span>

                    <span class="k">if</span> <span class="n">rpol1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ipol1</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">rpol2</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">ipol2</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">poor_antids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antid</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">poor_antids</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.75</span>
                    <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has D-terms solutions that deviate by </span><span class="si">{</span><span class="n">th_poor</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">th_bad</span><span class="si">}</span><span class="s2"> for&quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot; SpW </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s2">, antenna(s)&quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ant_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">poor_antids</span><span class="p">],</span><span class="w"> </span><span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Large deviation D-terms solutions&quot;</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_leakage&#39;</span><span class="p">,</span>
                                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;D-terms solutions deviation&#39;</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">bad_antids</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.55</span>
                    <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has D-terms solutions that deviate by more than </span><span class="si">{</span><span class="n">th_bad</span><span class="si">}</span><span class="s2"> for&quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot; SpW </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s2">, antenna(s)&quot;</span> \
                              <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">([</span><span class="n">ant_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">bad_antids</span><span class="p">],</span><span class="w"> </span><span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Very large deviation D-terms solutions&quot;</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_leakage&#39;</span><span class="p">,</span>
                                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;D-terms solutions deviation&#39;</span><span class="p">)</span>
                    <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="c1"># If no poor D-terms solutions are found, then create a good score.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">scores</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has D-terms solutions &lt;= the threshold of </span><span class="si">{</span><span class="n">th_poor</span><span class="si">}</span><span class="s2"> for all SpWs and&quot;</span> \
                  <span class="sa">f</span><span class="s2">&quot; antennas.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;D-terms solutions&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_leakage&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;D-terms solutions deviation&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span></div>



<div class="viewcode-block" id="score_polcal_residual_pol">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polcal_residual_pol">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polcal_residual_pol</span><span class="p">(</span><span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pfg_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This heuristic inspects the dictionary returned by CASA&#39;s polfromgain and</span>
<span class="sd">    scores the residual polarization in Q and U, compared to a threshold.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_name: name of session being evaluated.</span>
<span class="sd">        pfg_result: dictionary of results produced by polfromgain</span>
<span class="sd">        threshold: threshold for residual polarization, above which the score</span>
<span class="sd">            should be lowered.</span>
<span class="sd">    Returns:</span>
<span class="sd">        List of QAScore objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Create score for each field.</span>
    <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_result</span> <span class="ow">in</span> <span class="n">pfg_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Check residual polarization for each SpW.</span>
        <span class="n">bad_spwids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">spw_result</span> <span class="ow">in</span> <span class="n">field_result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Skip the result for &quot;Average SpW&quot;.</span>
            <span class="k">if</span> <span class="s1">&#39;Ave&#39;</span> <span class="ow">in</span> <span class="n">spwid</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># The SpW result is a list of [I, Q, U, V], check whether Q or U</span>
            <span class="c1"># exceed threshold.</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spw_result</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">spw_result</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">bad_spwids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

        <span class="c1"># Create a score depending on whether any SpW had too high residual</span>
        <span class="c1"># polarization.</span>
        <span class="k">if</span> <span class="n">bad_spwids</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; has residual polarization greater than </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> in SpW(s)&quot;</span> \
                      <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">bad_spwids</span><span class="p">,</span><span class="w"> </span><span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;High residual polarization&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39; residual polarization &lt;= the threshold of </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Residual polarization&quot;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_residual_pol&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;residual polarization&#39;</span><span class="p">)</span>
        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span></div>



<div class="viewcode-block" id="score_polcal_results">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_polcal_results">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_polcal_results</span><span class="p">(</span><span class="n">session_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caltables</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This heuristic tests whether calibrations were derived for a polcal session.</span>

<span class="sd">    Args:</span>
<span class="sd">        session_name: name of session being evaluated.</span>
<span class="sd">        caltables: list of calibration tables derived for session.</span>

<span class="sd">    Returns:</span>
<span class="sd">        QAScore object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">caltables</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;No polarisation calibration derived for session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;No polarisation calibration for session&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Polarisation calibration derived for session &#39;</span><span class="si">{</span><span class="n">session_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Polarisation calibration derived for session&quot;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_polcal_results&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;polarisation caltables&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<div class="viewcode-block" id="score_fluxservice">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_fluxservice">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_fluxservice</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If the primary FS query fails and the backup is invoked,</span>
<span class="sd">    the severity level should be BLUE (below standard; numerically, on its own, 0.9).</span>
<span class="sd">    If the backup FS query also fails, the warning should be YELLOW (WARNING; numerically, on its own, 0.6).</span>
<span class="sd">    But it should keep running as it currently does.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Flux catalog service not used.&quot;</span>
        <span class="k">for</span> <span class="n">setjy_result</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">setjy_results</span><span class="p">:</span>
            <span class="n">measurements</span> <span class="o">=</span> <span class="n">setjy_result</span><span class="o">.</span><span class="n">measurements</span>
            <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fluxorigin</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">origin</span>
                    <span class="k">if</span> <span class="n">fluxorigin</span> <span class="o">==</span> <span class="s1">&#39;Source.xml&#39;</span><span class="p">:</span>
                        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.3</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Flux catalog service not used.  Source.xml is the origin.&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skip since there is not a flux measurement&quot;</span><span class="p">)</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fluxservice&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;flux service&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fluxservice</span> <span class="o">==</span> <span class="s1">&#39;FIRSTURL&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Flux catalog service used.  &quot;</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">fluxservice</span> <span class="o">==</span> <span class="s1">&#39;BACKUPURL&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Backup flux catalog service used.  &quot;</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">fluxservice</span> <span class="o">==</span> <span class="s1">&#39;FAIL&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Neither primary or backup flux service could be queried.  ASDM values used.&quot;</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.3</span>

        <span class="n">agecounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">fluxservice</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;FIRSTURL&#39;</span><span class="p">,</span> <span class="s1">&#39;BACKUPURL&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">setjy_result</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">setjy_results</span><span class="p">:</span>
                <span class="n">measurements</span> <span class="o">=</span> <span class="n">setjy_result</span><span class="o">.</span><span class="n">measurements</span>
                <span class="k">for</span> <span class="n">measurement</span> <span class="ow">in</span> <span class="n">measurements</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">mses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fieldobjs</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">)</span>
                        <span class="n">intentlist</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">fieldobj</span> <span class="ow">in</span> <span class="n">fieldobjs</span><span class="p">:</span>
                            <span class="n">intentlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>

                        <span class="c1"># PIPE-1124.  Only determine QA age scoring if &#39;AMPLITUDE&#39; intent is present for a source.</span>
                        <span class="k">if</span> <span class="s1">&#39;AMPLTIUDE&#39;</span> <span class="ow">in</span> <span class="n">intentlist</span><span class="p">:</span>
                            <span class="n">age</span> <span class="o">=</span> <span class="n">measurement</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">age</span>  <span class="c1"># second element of a tuple, first element of list of flux objects</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">age</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">:</span>
                                <span class="n">agecounter</span> <span class="o">=</span> <span class="n">agecounter</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Skip since there is no age present&quot;</span><span class="p">)</span>

            <span class="c1"># Any sources with age of nearest monitoring point greater than 14 days?</span>
            <span class="k">if</span> <span class="n">agecounter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;Age of nearest monitor point is greater than 14 days.&quot;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fluxservice&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;flux service&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_fluxservicemessages</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Report any flux service messaging and status codes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;Flux catalog service not used.  No warning messages reported.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="n">longmsg</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;No warning messages from the flux catalog service.&quot;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="n">longmsg</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">qastatus</span><span class="p">:</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">qacode</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">qastatus</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;clarification&#39;</span><span class="p">]:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>
                    <span class="c1"># Queries a per source, so there may be more than one message returned.</span>
                    <span class="n">longmsg</span> <span class="o">+=</span> <span class="s2">&quot;Source: </span><span class="si">{!s}</span><span class="s2">,  Status code: </span><span class="si">{!s}</span><span class="s2">,     Message: </span><span class="si">{!s}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">],</span>
                                                                                            <span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">],</span>
                                                                                            <span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;clarification&#39;</span><span class="p">])</span>
                    <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;Flux service returned warning messages.&quot;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fluxservice_messaging&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;flux service messaging&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_fluxservicestatuscodes</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Report any flux service codes for status_code &gt; 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Flux catalog service not used.  No status codes to report.&quot;</span>
    <span class="k">elif</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;dbservice&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Flux catalog service status queries returned code 0 or 1.&quot;</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">qastatus</span><span class="p">:</span>
            <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">qacode</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">qastatus</span><span class="p">:</span>
                <span class="c1"># Status code can be 0,1,2,3</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="mf">0.3</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;A query of the flux catalog service returned a status code: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">qacode</span><span class="p">[</span><span class="s1">&#39;status_code&#39;</span><span class="p">]))</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fluxservice_statuscode&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;flux service status code&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_fluxcsv</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check for existence of flux.csv file on import</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;flux.csv&#39;</span><span class="p">):</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;flux.csv exists on disk&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;flux.csv does not exist&quot;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_fluxcsv&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;flux csv&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<div class="viewcode-block" id="score_mom8_fc_image">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_mom8_fc_image">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_mom8_fc_image</span><span class="p">(</span><span class="n">mom8_fc_name</span><span class="p">,</span> <span class="n">mom8_fc_peak_snr</span><span class="p">,</span> <span class="n">mom8_10_fc_histogram_asymmetry</span><span class="p">,</span> <span class="n">mom8_fc_max_segment_beams</span><span class="p">,</span> <span class="n">mom8_fc_frac_max_segment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the MOM8 FC image for outliers above a given SNR threshold. The score</span>
<span class="sd">    can vary between 0.33 and 1.0 depending on the fraction of outlier pixels.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mom8_fc_outlier_threshold1</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="n">mom8_fc_outlier_threshold2</span> <span class="o">=</span> <span class="mf">3.5</span>
    <span class="n">mom8_fc_histogram_asymmetry_threshold1</span> <span class="o">=</span> <span class="mf">0.20</span>
    <span class="n">mom8_fc_histogram_asymmetry_threshold2</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">mom8_fc_max_segment_beams_threshold</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">mom8_fc_score_min</span> <span class="o">=</span> <span class="mf">0.33</span>
    <span class="n">mom8_fc_score_max</span> <span class="o">=</span> <span class="mf">1.00</span>
    <span class="n">mom8_fc_metric_scale</span> <span class="o">=</span> <span class="mf">100.0</span>
    <span class="k">if</span> <span class="n">mom8_fc_frac_max_segment</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">mom8_fc_score</span> <span class="o">=</span> <span class="n">mom8_fc_score_min</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">mom8_fc_score_max</span> <span class="o">-</span> <span class="n">mom8_fc_score_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">erf</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mom8_fc_metric_scale</span> <span class="o">*</span> <span class="n">mom8_fc_frac_max_segment</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mom8_fc_score</span> <span class="o">=</span> <span class="n">mom8_fc_score_max</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">mom8_fc_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">miscinfo</span><span class="p">()</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;virtspw&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mom8_fc_peak_snr</span> <span class="o">&gt;</span> <span class="n">mom8_fc_outlier_threshold1</span> <span class="ow">and</span> <span class="n">mom8_10_fc_histogram_asymmetry</span> <span class="o">&gt;</span> <span class="n">mom8_fc_histogram_asymmetry_threshold1</span><span class="p">)</span> <span class="ow">or</span> \
       <span class="p">(</span><span class="n">mom8_fc_peak_snr</span> <span class="o">&gt;</span> <span class="n">mom8_fc_outlier_threshold2</span> <span class="ow">and</span> <span class="n">mom8_10_fc_histogram_asymmetry</span> <span class="o">&gt;</span> <span class="n">mom8_fc_histogram_asymmetry_threshold2</span> <span class="ow">and</span> <span class="n">mom8_fc_max_segment_beams</span> <span class="o">&gt;</span> <span class="n">mom8_fc_max_segment_beams_threshold</span><span class="p">):</span>
        <span class="n">mom8_fc_final_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mom8_fc_score</span><span class="p">,</span> <span class="mf">0.65</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mom8_fc_final_score</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mom8_fc_score</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">)</span>

    <span class="k">if</span> <span class="mf">0.33</span> <span class="o">&lt;=</span> <span class="n">mom8_fc_final_score</span> <span class="o">&lt;</span> <span class="mf">0.66</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;MOM8 FC image for field </span><span class="si">{:s}</span><span class="s1"> virtspw </span><span class="si">{:s}</span><span class="s1"> with a peak SNR of </span><span class="si">{:#.5g}</span><span class="s1"> and a flux histogram asymmetry which indicate that there may be residual line emission in the findcont channels.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">mom8_fc_peak_snr</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;MOM8 FC image indicates residual line emission&#39;</span>
        <span class="n">weblog_location</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">UNSET</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="s1">&#39;MOM8 FC image for field </span><span class="si">{:s}</span><span class="s1"> virtspw </span><span class="si">{:s}</span><span class="s1"> has a peak SNR of </span><span class="si">{:#.5g}</span><span class="s1"> and no significant flux histogram asymmetry.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">mom8_fc_peak_snr</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;MOM8 FC peak SNR and flux histogram&#39;</span>
        <span class="n">weblog_location</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_mom8_fc_image&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="p">(</span><span class="n">mom8_fc_peak_snr</span><span class="p">,</span> <span class="n">mom8_10_fc_histogram_asymmetry</span><span class="p">,</span> <span class="n">mom8_fc_max_segment_beams</span><span class="p">,</span> <span class="n">mom8_fc_frac_max_segment</span><span class="p">),</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Peak SNR / Histogram asymmetry, Max. segment size in beams, Max. segment fraction&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">mom8_fc_final_score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">weblog_location</span><span class="o">=</span><span class="n">weblog_location</span><span class="p">)</span></div>



<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_rasterscan_correctness_direction_domain_rasterscan_fail</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">SDImportDataResults</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate QAScore of direction-domain raster scan heuristics analysis failure in importdata.</span>

<span class="sd">    Args:</span>
<span class="sd">        result (SDImportDataResults): instance of SDImportDataResults</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[pqa.QAScore]: list of QAScores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Direction-domain raster scan analysis failed, fallback to time-domain analysis&#39;</span>
    <span class="k">return</span> <span class="n">_score_rasterscan_correctness</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_direction</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_rasterscan_correctness_time_domain_rasterscan_fail</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">SDImportDataResults</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate QAScore of time-domain raster scan heuristics analysis failure in importdata.</span>

<span class="sd">    Args:</span>
<span class="sd">        result (SDImportDataResults): instance of SDImportDataResults</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[pqa.QAScore]: list of QAScores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Time-domain raster scan analysis issue detected. Failed to identify gap between raster map iteration&#39;</span>
    <span class="k">return</span> <span class="n">_score_rasterscan_correctness</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_time</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_rasterscan_correctness_imaging_raster_gap</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">SDImagingResultItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate QAScore of gap existence in raster pattern of imaging.</span>

<span class="sd">    Args:</span>
<span class="sd">        result (SDImagingResultItem): instance of SDImagingResultItem</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[pqa.QAScore]: list of QAScores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Unable to identify gap between raster map iteration&#39;</span>
    <span class="k">return</span> <span class="n">_score_rasterscan_correctness</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_rgap</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_rasterscan_correctness_imaging_raster_analysis_incomplete</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="n">SDImagingResultItem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate QAScore when raster scan analysis was incomplete in imaging.</span>

<span class="sd">    Args:</span>
<span class="sd">        result (SDImagingResultItem): instance of SDImagingResultItem</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[pqa.QAScore]: list of QAScores</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Raster scan analysis incomplete. Skipping calculation of theoretical image RMS&#39;</span>
    <span class="k">return</span> <span class="n">_score_rasterscan_correctness</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_incomp</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_score_rasterscan_correctness</span><span class="p">(</span><span class="n">rasterscan_heuristics_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">RasterScanHeuristicsResult</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate score of raster scan correctness of importdata or imaging.</span>

<span class="sd">    Args:</span>
<span class="sd">        rasterscan_heuristics_results (Dict[str, RasterScanHeuristicsResult]): Dictionary of raster heuristics result objects</span>
<span class="sd">            treats QAScore of raster scan analysis.</span>
<span class="sd">        msg (str): short message for QA</span>

<span class="sd">    Returns:</span>
<span class="sd">        List[pqa.QAScore]: lists contains QAScore objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">qa_scores</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [pqa.QAScore]</span>

    <span class="c1"># converting rasterscan_heuristics_results to QA score</span>
    <span class="k">for</span> <span class="n">_execblock_id</span><span class="p">,</span> <span class="n">_rasterscan_heuristics_results_list</span> <span class="ow">in</span> <span class="n">rasterscan_heuristics_results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">_results_list</span> <span class="ow">in</span> <span class="n">_rasterscan_heuristics_results_list</span><span class="p">:</span>
            <span class="n">_failed_ants</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_results_list</span><span class="o">.</span><span class="n">get_antennas_rasterscan_failed</span><span class="p">())</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_failed_ants</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qa_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rasterscan_failed_per_eb</span><span class="p">(</span><span class="n">_execblock_id</span><span class="p">,</span> <span class="n">_failed_ants</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">qa_scores</span>


<span class="k">def</span> <span class="nf">_rasterscan_failed_per_eb</span><span class="p">(</span><span class="n">execblock_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">failed_ants</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;pqa.QAScore&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an object which has FAILED information in raster scan analysis.</span>

<span class="sd">    Args:</span>
<span class="sd">        execblock_id (str): Execute Block ID</span>
<span class="sd">        failed_ants (list[str]): List of antenna names</span>
<span class="sd">        msg: short message for QA</span>

<span class="sd">    Returns:</span>
<span class="sd">        pqa.QAScore: QA score object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SCORE_FAIL</span> <span class="o">=</span> <span class="mf">0.8</span>
    <span class="n">longmsg</span> <span class="o">=</span> <span class="n">msg</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39; : EB:</span><span class="si">{</span><span class="n">execblock_id</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">failed_ants</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_rasterscan_correctness&#39;</span><span class="p">,</span>
                        <span class="n">metric_score</span><span class="o">=</span><span class="n">SCORE_FAIL</span><span class="p">,</span>
                        <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;raster scan correctness&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">SCORE_FAIL</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>


<div class="viewcode-block" id="score_tsysflagcontamination_contamination_flagged">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_tsysflagcontamination_contamination_flagged">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_tsysflagcontamination_contamination_flagged</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">summaries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate a score for the hifa_tsysflagcontamination task based on whether</span>
<span class="sd">    any line contamination was flagged.</span>

<span class="sd">    0% flagged  -&gt; 1</span>
<span class="sd">    &gt;0% flagged -&gt; 0.9</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">calc_frac_newly_flagged</span><span class="p">(</span><span class="n">summaries</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frac_flagged</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Tsys line contamination detected in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;Tsys contamination flagged&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No Tsys line contamination detected in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1">.&#39;</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s1">&#39;No Tsys line contamination&#39;</span>

    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_tsys_line_contamination_flagged&#39;</span><span class="p">,</span>
                          <span class="n">metric_score</span><span class="o">=</span><span class="n">frac_flagged</span><span class="p">,</span>
                          <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;Fraction of Tsys data that was identified as line contamination and flagged&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
        <span class="n">score</span><span class="p">,</span>
        <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span>
        <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span>
        <span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span>
        <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span>
        <span class="n">applies_to</span><span class="o">=</span><span class="n">pqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">vis</span><span class="p">})</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="score_tsysflagcontamination_external_heuristic">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_tsysflagcontamination_external_heuristic">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_tsysflagcontamination_external_heuristic</span><span class="p">(</span><span class="n">foreign_qascores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adopt QA scores that originate from the Tsysflag line contamination</span>
<span class="sd">    heuristic.</span>

<span class="sd">    The QA scores are generated in an external heuristic. This metric</span>
<span class="sd">    is here mainly to log the QA scores to console for non-weblog runs</span>
<span class="sd">    via the @log_qa decorator.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span>
        <span class="n">metric_name</span><span class="o">=</span><span class="s2">&quot;score_tsysflagcontamination_external_heuristic&quot;</span><span class="p">,</span>
        <span class="n">metric_score</span><span class="o">=</span><span class="s2">&quot;N/A&quot;</span><span class="p">,</span>
        <span class="n">metric_units</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">qascores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fq</span> <span class="ow">in</span> <span class="n">foreign_qascores</span><span class="p">:</span>
        <span class="n">adopted_qascore</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
            <span class="n">score</span><span class="o">=</span><span class="n">fq</span><span class="o">.</span><span class="n">score</span><span class="p">,</span>
            <span class="n">shortmsg</span><span class="o">=</span><span class="n">fq</span><span class="o">.</span><span class="n">shortmsg</span><span class="p">,</span>
            <span class="n">longmsg</span><span class="o">=</span><span class="n">fq</span><span class="o">.</span><span class="n">longmsg</span><span class="p">,</span>
            <span class="n">applies_to</span><span class="o">=</span><span class="n">fq</span><span class="o">.</span><span class="n">applies_to</span><span class="p">,</span>
            <span class="n">origin</span><span class="o">=</span><span class="n">origin</span>
        <span class="p">)</span>
        <span class="n">qascores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">adopted_qascore</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qascores</span></div>



<div class="viewcode-block" id="score_iersstate">
<a class="viewcode-back" href="../../../_apidoc/pipeline.qa.html#pipeline.qa.scorecalculator.score_iersstate">[docs]</a>
<span class="nd">@log_qa</span>
<span class="k">def</span> <span class="nf">score_iersstate</span><span class="p">(</span><span class="n">mses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check state of IERS tables relative to observation date</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">iers_info</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">IERSInfo</span><span class="p">()</span>
    <span class="c1"># reorder MSes by start time</span>
    <span class="n">by_start</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span>
                      <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>

    <span class="c1"># create an interval for each one, including our tolerance</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">by_start</span><span class="p">:</span>
        <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dates for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2"> fully covered by IERSeop2000.&quot;</span><span class="p">)</span>
        <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;MS dates fully covered by IERSeop2000.&quot;</span>
        <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">iers_info</span><span class="o">.</span><span class="n">validate_date</span><span class="p">(</span><span class="n">time_end</span><span class="p">):</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">iers_info</span><span class="o">.</span><span class="n">date_message_type</span><span class="p">(</span><span class="n">time_end</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;INFO&quot;</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.9</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dates for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2"> not fully covered by IERSeop2000. CASA will use IERSpredict.&quot;</span><span class="p">)</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;MS dates not fully covered by IERSeop2000. CASA will use IERSpredict.&quot;</span>
        <span class="k">elif</span> <span class="n">iers_info</span><span class="o">.</span><span class="n">date_message_type</span><span class="p">(</span><span class="n">time_end</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;WARN&quot;</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dates for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2"> not fully covered by IERSeop2000. CASA will use IERSpredict.&quot;</span><span class="p">)</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;MS dates not fully covered by IERSeop2000. CASA will use IERSpredict.&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">longmsg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dates for </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2"> not fully covered by IERSeop2000. Please update your data repository.&quot;</span><span class="p">)</span>
            <span class="n">shortmsg</span> <span class="o">=</span> <span class="s2">&quot;MS dates not fully covered by IERSpredict. Please update your data repository.&quot;</span>

        <span class="n">origin</span> <span class="o">=</span> <span class="n">pqa</span><span class="o">.</span><span class="n">QAOrigin</span><span class="p">(</span><span class="n">metric_name</span><span class="o">=</span><span class="s1">&#39;score_iersstate&#39;</span><span class="p">,</span>
                              <span class="n">metric_score</span><span class="o">=</span><span class="n">score</span><span class="p">,</span>
                              <span class="n">metric_units</span><span class="o">=</span><span class="s1">&#39;state of IERS tables relative to observation date&#39;</span><span class="p">)</span>

        <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">longmsg</span><span class="o">=</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">shortmsg</span><span class="o">=</span><span class="n">shortmsg</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">scores</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>