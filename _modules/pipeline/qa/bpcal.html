

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.qa.bpcal &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.qa.bpcal</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.qa.bpcal</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Subsystem module ICD</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># bpcal.py</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This module runs the bandpass calibration statistics subsystem of the QA</span>
<span class="c1"># system.</span>

<span class="c1"># TBD:</span>
<span class="c1"># ----</span>
<span class="c1"># * Make bpcal_putFitRow() a more generic function.</span>

<span class="c1"># User Functions (subsystem and component level):</span>
<span class="c1"># -----------------------------------------------</span>
<span class="c1"># bpcal       - This function runs the bandpass calibration statistics subsystem</span>
<span class="c1">#               of the QA system.</span>
<span class="c1">#</span>
<span class="c1"># bpcal_calc  - This function calculates the bandpass calibration statistics.</span>
<span class="c1"># bpcal_write - This function writes the bandpass calibration statistics to a</span>
<span class="c1">#               CASA table.</span>

<span class="c1"># Non-user functions (unit level):</span>
<span class="c1"># --------------------------------</span>
<span class="c1"># bpcal_putFitRow     - This function puts a row of data into the output table.</span>
<span class="c1">#</span>
<span class="c1"># bpcal_desc          - This function returns the place holder data description</span>
<span class="c1">#                       dictionary.</span>
<span class="c1"># bpcal_desc_st       - This function creates the bandpass calibration subtable</span>
<span class="c1">#                       data description dictionary.</span>
<span class="c1">#</span>
<span class="c1"># bpcal_chanRangeList - This function returns the trimmed channel range.</span>
<span class="c1"># bpcal_spwChanString - This function converts spectral window and channel range</span>
<span class="c1">#                       lists to a CASA selection string.</span>
<span class="c1">#</span>
<span class="c1"># bpcal_score         - This function calculates the score to prioritize the</span>
<span class="c1">#                       plots on the HTML page.</span>
<span class="c1"># bpcal_score_flag    - This function calculates the flag score for a given</span>
<span class="c1">#                       iteration.</span>
<span class="c1"># bpcal_score_RMS     - This function calculates the RMS score for a given</span>
<span class="c1">#                       iteration.</span>
<span class="c1"># bpcal_score_delay   - This function calculates the delay score for a given</span>
<span class="c1">#                       iteration.</span>
<span class="c1">#</span>
<span class="c1"># bpcal_plot          - This function is the top-level interface to other</span>
<span class="c1">#                       functions that create bandpass calibration plots.</span>
<span class="c1"># bpcal_plot1         - This function creates a single bandpass statistics plot</span>
<span class="c1">#                       and saves it to disk.</span>
<span class="c1"># bpcal_plot_hist     - This function plots the histograms of either number of</span>
<span class="c1">#                       flagged data, RMSes, or absolute value of delays, color</span>
<span class="c1">#                       coded by spectral window.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2011 May 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version created with functions bpcal(), bpcal_calc(),</span>
<span class="c1">#               and bpcal_write().</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               Functions bpcal_desc() and bpcal_desc_st() added.</span>
<span class="c1"># 2012 Mar 16 - Nick Elias, NRAO</span>
<span class="c1">#               Function bpcal_putFitRow() added.</span>
<span class="c1"># 2012 May 11 - Nick Elias, NRAO</span>
<span class="c1">#               Major revison using new version of calibration analysis tool.</span>
<span class="c1"># 2012 May 15 - Nick Elias, NRAO</span>
<span class="c1">#               Functions bpcal_chanRangeList() and bpcal_spwChanString() added.</span>
<span class="c1"># 2012 Jun 20 - Nick Elias, NRAO</span>
<span class="c1">#               Functions bpcal_plot(), bpcal_plot1(), and bpcal_plot_hist()</span>
<span class="c1">#               added.</span>
<span class="c1"># 2012 Jun 23 - Nick Elias, NRAO</span>
<span class="c1">#               Functions bpcal_html() and bpcal_score() added.</span>
<span class="c1"># 2012 Aug 01 - Nick Elias, NRAO</span>
<span class="c1">#               Tool calls modified to new format.</span>
<span class="c1"># 2012 Aug 20 - Nick Elias, NRAO</span>
<span class="c1">#               Functions bpcal_score_flag(), bpcal_score_RMS(), and</span>
<span class="c1">#               bpcal_score_delay() added.</span>
<span class="c1"># 2012 Aug 21 - Nick Elias, NRAO</span>
<span class="c1">#               Function bpcal_html() removed.</span>

<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Imports</span>
<span class="c1"># -------</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="k">as</span> <span class="nn">ma</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">scipy.stats.mstats</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.logging</span> <span class="k">as</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">pipeline.qa.utility.logs</span> <span class="k">as</span> <span class="nn">logs</span>
<span class="kn">import</span> <span class="nn">pipeline.qa.utility.scorers</span> <span class="k">as</span> <span class="nn">scorers</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="rms">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.rms.html#pipeline.qa.bpcal.rms">[docs]</a>
<span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Subsystem user function and ICD</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># bpcal</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function runs the bandpass calibration statistics subsystem of the QA</span>
<span class="c1"># system.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># in_table - This python string contains the name of the input bandpass</span>
<span class="c1">#            calibration table.</span>
<span class="c1"># out_dir  - This python string contains the output directory.</span>
<span class="c1"># logobj   - This python variable contains the logging object information</span>
<span class="c1">#            (&#39;PYTHON&#39; creates a local python Logger class, &#39;CASA&#39; creates a</span>
<span class="c1">#            local python logger, &lt;python&gt; and &lt;casa&gt; are actual instances of</span>
<span class="c1">#            the logger classes; default = &#39;PYTHON&#39;).</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># If the function finishes successfully, a tuple containing the bandpass</span>
<span class="c1"># statistics, scores, and plots dictionaries is returned via the function value.</span>
<span class="c1"># If the function does not finish successfully, it throws an exception.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2011 May 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2011 Jun 13 - Nick Elias, NRAO</span>
<span class="c1">#               Improved error handling.</span>
<span class="c1"># 2011 Jun 20 - Nick Elias, NRAO</span>
<span class="c1">#               Raise an exception if the output table already exists.</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               The logobj input parameter and logging code has been added.</span>
<span class="c1"># 2012 Mar 15 - Nick Elias, NRAO</span>
<span class="c1">#               Added the spw_in input parameter.</span>
<span class="c1"># 2012 May 09 - Nick Elias, NRAO</span>
<span class="c1">#               Removed the spw_in input parameter.</span>
<span class="c1"># 2012 Jun 22 - Nick Elias, NRAO</span>
<span class="c1">#               Added call to bpcal_plot() function.</span>
<span class="c1"># 2012 Aug 21 - Nick Elias, NRAO</span>
<span class="c1">#               Added call to bpcal_score() function.  Return value changed to</span>
<span class="c1">#               a three-element tuple containing the bandpass statistics,</span>
<span class="c1">#               scores, and plots dictionaries.</span>
<span class="c1"># 2013 Dec 17 - Dirk Muders, MPIfR</span>
<span class="c1">#               Made plotting optional.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal.html#pipeline.qa.bpcal.bpcal">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">logobj</span><span class="o">=</span><span class="s1">&#39;PYTHON&#39;</span><span class="p">,</span> <span class="n">create_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Initialize the logger</span>
    <span class="n">root</span> <span class="o">=</span> <span class="s1">&#39;bpcal.bpcal&#39;</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">INFO</span>

    <span class="n">log_local</span><span class="p">,</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">logs</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">logobj</span><span class="p">)</span>

    <span class="c1"># Print the first log message</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass statistics started for &#39;</span> <span class="o">+</span> <span class="n">in_table</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># Check to see if the output file already exists</span>
    <span class="n">out_table_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">in_table</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">out_table</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">out_table_root</span> <span class="o">+</span> <span class="s1">&#39;.bpcal.stats&#39;</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_table</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Output table &#39;</span> <span class="o">+</span> <span class="n">out_table</span> <span class="o">+</span> <span class="s1">&#39; already exists ...</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="c1"># Calculate the bandpass calibration statistics</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">bpcal_stats</span> <span class="o">=</span> <span class="n">bpcal_calc</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass statistics of &#39;</span> <span class="o">+</span> <span class="n">in_table</span> <span class="o">+</span> <span class="s1">&#39; calculated ...&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># Write the bandpass calibration statistics to the table</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">bpcal_write</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">,</span> <span class="n">out_table</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass statistics written in &#39;</span> <span class="o">+</span> <span class="n">out_table</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># Calculate the bandpass calibration scores</span>
    <span class="n">bpcal_scores</span> <span class="o">=</span> <span class="n">bpcal_score</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass scores of &#39;</span> <span class="o">+</span> <span class="n">in_table</span> <span class="o">+</span> <span class="s1">&#39; calculated ...&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

    <span class="c1"># Create the bandpass calibration statistics plots</span>
    <span class="k">if</span> <span class="n">create_plots</span><span class="p">:</span>
        <span class="n">bpcal_plots</span> <span class="o">=</span> <span class="n">bpcal_plot</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">bpcal_stats</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass calibration statistics plots created in &#39;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39; ...&#39;</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bpcal_plots</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Print the last log message</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Bandpass calibration statistics finished for &#39;</span>
    <span class="n">msg</span> <span class="o">+=</span> <span class="n">in_table</span> <span class="o">+</span> <span class="s1">&#39; ...</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">root</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="n">msg</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span> <span class="p">)</span>

    <span class="c1"># Delete the logger, if it was created locally</span>
    <span class="k">if</span> <span class="n">log_local</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">logger</span>

    <span class="c1"># Return the dictionary containing the bandpass statistics, scores, and</span>
    <span class="c1"># plots dictionaries</span>
    <span class="n">bpcal_qa</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;QANUMBERS&#39;</span><span class="p">:</span> <span class="n">bpcal_stats</span><span class="p">,</span>
                <span class="s1">&#39;QASCORES&#39;</span><span class="p">:</span> <span class="n">bpcal_scores</span><span class="p">,</span>
                <span class="s1">&#39;QAPLOTS&#39;</span><span class="p">:</span> <span class="n">bpcal_plots</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">bpcal_qa</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Component user functions and ICDs</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># bpcal_calc</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the bandpass calibration statistics versus frequency</span>
<span class="c1"># for each time stamp and spectral window.</span>

<span class="c1"># TB: If the calibration analysis tool eventually has a mode where the spectral</span>
<span class="c1"># window can be an iteration axis, the spw and channel range elements of the</span>
<span class="c1"># output dictionary can be removed.</span>

<span class="c1"># NB: This function calculates amplitude and phase linear unweighted</span>
<span class="c1"># least-squares fits along the frequency axis for all spectral windows for each</span>
<span class="c1"># unique (field,antenna1,antenna2) for selected times.</span>
<span class="c1"># NB: About 10% of the edge channels are trimmed first.</span>
<span class="c1"># NB: The amplitudes are normalized to the maximum channel separately for each</span>
<span class="c1"># time stamp.</span>
<span class="c1"># NB: The phases are unwrapped across the channels separately for each time</span>
<span class="c1"># stamp.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># in_table - This python string contains the name of the input bandpass</span>
<span class="c1">#            calibration table.</span>
<span class="c1"># logger   - This python variable contains the logging object information</span>
<span class="c1">#            (&lt;python&gt; and &lt;casa&gt; are actual instances of the logger classes).</span>
<span class="c1">#            The default is &#39;&#39;, which means that the log information is either</span>
<span class="c1">#            sent to stdout or raised.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The dictionary containing the bandpass calibration statistics, returned via</span>
<span class="c1"># the function value.  If the function does not finish successfully, an</span>
<span class="c1"># exception is raised.</span>

<span class="c1"># The keys:</span>
<span class="c1"># &#39;AMPLITUDE_FIT&#39; - The python dictionary containing the amplitude fit</span>
<span class="c1">#                   statistics.</span>
<span class="c1"># &#39;PHASE_FIT&#39;     - The python dictionary containing the phase fit statistics.</span>

<span class="c1"># The &#39;AMPLITUDE_FIT&#39; and &#39;PHASE_FIT&#39; python dictionaries mentioned above have</span>
<span class="c1"># the same format and point to the following key:</span>
<span class="c1"># &#39;&lt;spw index #&gt;&#39; - The python dictionary containing the spectral window index.</span>

<span class="c1"># The &#39;&lt;spw index#&gt;&#39; python dictionaries mentioned above have the same format</span>
<span class="c1"># and point to the following keys:</span>
<span class="c1"># &#39;&lt;iter#&gt;&#39;     - The python string containing the iteration number.  Each</span>
<span class="c1">#                 iteration contains a fit for a specific field, antenna 1,</span>
<span class="c1">#                 antenna 2, feed, and time.</span>
<span class="c1"># &#39;&lt;spw#&gt;&#39;      - The spectral window number for all corresponding iterations.</span>
<span class="c1"># &#39;&lt;chanRange&gt;&#39; - The channel range [start,stop] for all corresponding</span>
<span class="c1">#                 iterations.</span>

<span class="c1"># The &lt;&#39;iter#&#39;&gt; python dictionary mentioned above have the same format and point</span>
<span class="c1"># to the following keys:</span>
<span class="c1"># &#39;abscissa&#39;  - The python string containing the type of abscissa data (here, it</span>
<span class="c1">#               is always &#39;frequency&#39;).</span>
<span class="c1"># &#39;antenna1&#39;  - The python string containing the antenna 1 number.</span>
<span class="c1"># &#39;antenna2&#39;  - The python string containing the antenna 2 number.</span>
<span class="c1"># &#39;covars&#39;    - The numpy array of doubles containing the fit covariances (empty</span>
<span class="c1">#               for an average fit; covar(0,1) for a linear fit; and covar(0,1),</span>
<span class="c1">#               covar(0,2), covar(1,2) for a quadratic fit).</span>
<span class="c1"># &#39;field&#39;     - The python string containing the field number.</span>
<span class="c1"># &#39;feed&#39;      - The python string containing the feed ID (&#39;R&#39; or &#39;L&#39; for</span>
<span class="c1">#               circular feeds, &#39;X&#39; or &#39;Y&#39; for linear feeds).</span>
<span class="c1"># &#39;flag&#39;      - The numpy array of booleans containing the value flags (True =</span>
<span class="c1">#               flagged, False = unflagged).</span>
<span class="c1"># &#39;frequency&#39; - The numpy array of doubles containing the frequency abscissae</span>
<span class="c1">#               used in the fit.</span>
<span class="c1"># &#39;model&#39;     - The numpy array of doubles containing the fit model calculated</span>
<span class="c1">#               from the abscissae and fit parameters. It includes flagged data.</span>
<span class="c1"># &#39;order&#39;     - The python string containing the fit order (always &#39;LINEAR&#39;).</span>
<span class="c1"># &#39;pars&#39;      - The numpy array of doubles containing the fit parameters (y</span>
<span class="c1">#               intercept and slope).</span>
<span class="c1"># &#39;redChi2&#39;   - The python double containing the reduced chi2 (it is equal to</span>
<span class="c1">#               1.0 when the fit is unweighted).</span>
<span class="c1"># &#39;res&#39;       - The numpy array of doubles containing the fit residuals</span>
<span class="c1">#               calculated from the values minus the model.  It includes flagged</span>
<span class="c1">#               data.</span>
<span class="c1"># &#39;resMean&#39;   - The python double containing the mean of the residuals.</span>
<span class="c1"># &#39;resVar&#39;    - The python double containing the variance of the residuals.</span>
<span class="c1"># &#39;spw&#39;       - The numpy array of strings containing the spectral window</span>
<span class="c1">#               numbers.</span>
<span class="c1"># &#39;startChan&#39; - The numpy array of integers containing the start channels for</span>
<span class="c1">#               each spectral window.</span>
<span class="c1"># &#39;stopChan&#39;  - The numpy array of integers containing the stop channels for</span>
<span class="c1">#               each spectral window.</span>
<span class="c1"># &#39;time&#39;      - The numpy array of doubles (one element only) containing the</span>
<span class="c1">#               time stamp used in the fit.</span>
<span class="c1"># &#39;type&#39;      - The python string containing the fit type (always &#39;LSQ&#39;).</span>
<span class="c1"># &#39;validFit&#39;  - The python boolean containing the fit success flag (True = OK,</span>
<span class="c1">#               False = not OK).</span>
<span class="c1"># &#39;value&#39;     - The numpy array of doubles containing the values used in the</span>
<span class="c1">#               fit.</span>
<span class="c1"># &#39;valueErr&#39;  - The numpy array of doubles containing the value errors used in</span>
<span class="c1">#               the fit (unused here since the fit is unweighted).</span>
<span class="c1"># &#39;vars&#39;      - The numpy array of doubles containing the fit variances (the</span>
<span class="c1">#               y intercept and slope).</span>
<span class="c1"># &#39;weight&#39;    - The python boolean containing the weight flag (always False =</span>
<span class="c1">#               unweighted).</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2011 May 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version (stub).</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               First working version.  Some of the code in the function will be</span>
<span class="c1">#               eliminated when calibration selection and defaults are</span>
<span class="c1">#               implemented.  The logger input parameter and logging code has</span>
<span class="c1">#               been added.</span>
<span class="c1"># 2012 Mar 15 - Nick Elias, NRAO</span>
<span class="c1">#               Added the spw_in input parameter.</span>
<span class="c1"># 2012 May 09 - Nick Elias, NRAO</span>
<span class="c1">#               spw_in input parameter removed.  The ca tool now has the</span>
<span class="c1">#               capability of parsing inputs, so that code has been removed</span>
<span class="c1">#               from this function.</span>
<span class="c1"># 2013        - Dirk Muders, MPIfR</span>
<span class="c1">#               Added AMPLITUDE_SN.</span>
<span class="c1"># 2013 Jul 23 - Dirk Muders, MPIfR</span>
<span class="c1">#               Added AMPLITUDE.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_calc">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_calc.html#pipeline.qa.bpcal.bpcal_calc">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_calc</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

    <span class="c1"># Get the list of spw ids actually in the caltable</span>
    <span class="c1">#    Should be handled by calanalysis tool meta data</span>
    <span class="c1">#    fetchers but is not.</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">in_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
        <span class="n">spwidList</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="c1"># Create the local instance of the calibration analysis tool and open</span>
    <span class="c1"># the bandpass caltable</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">CalAnalysis</span><span class="p">(</span><span class="n">in_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">caLoc</span><span class="p">:</span>

        <span class="c1"># Get the spw ids and corresponding number of channels in the</span>
        <span class="c1">#    caltable meta data and remove values that are not represented</span>
        <span class="c1">#    in the caltable.</span>
        <span class="n">full_spwList</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">spw</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">full_numchanList</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">numchannel</span><span class="p">()</span>
        <span class="n">spwList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">numchanList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">numchan</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">full_spwList</span><span class="p">,</span> <span class="n">full_numchanList</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spwidList</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">spwList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
            <span class="n">numchanList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numchan</span><span class="p">)</span>

        <span class="c1"># Initialize the bandpass calibration statistics dictionary</span>
        <span class="n">bpcal_stats</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># Get the amplitude fit statistics for each spectral window and time.</span>
        <span class="c1"># The spectral window and channel range elements are appended to the</span>
        <span class="c1"># result from ca.fit().  Effectively, the spectral window is another</span>
        <span class="c1"># iteration axis.</span>
        <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_FIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwList</span><span class="p">)):</span>
                <span class="n">chanRange</span> <span class="o">=</span> <span class="n">bpcal_chanRangeList</span><span class="p">(</span><span class="n">numchanList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">chanRange</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">continue</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">bpcal_spwChanString</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">chanRange</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                              <span class="n">norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;LINEAR&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;LSQ&#39;</span><span class="p">,</span>
                              <span class="n">weight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanRange</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_FIT&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">f</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;bpcal.bpcal_calc&#39;</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Get the phase fit statistics for each spectral window and time.  The</span>
        <span class="c1"># spectral window and channel range elements are appended to the result</span>
        <span class="c1"># from ca.fit().</span>
        <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE_FIT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># TODO: Use spwList directly, using &quot;range&quot; seems wrong.</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwList</span><span class="p">)):</span>
                <span class="n">chanRange</span> <span class="o">=</span> <span class="n">bpcal_chanRangeList</span><span class="p">(</span><span class="n">numchanList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">chanRange</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">continue</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">bpcal_spwChanString</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">],</span> <span class="n">chanRange</span><span class="p">)</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span>
                              <span class="n">unwrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">jumpmax</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;LINEAR&#39;</span><span class="p">,</span>
                              <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;LSQ&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">f</span><span class="p">[</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanRange</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE_FIT&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="n">f</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;bpcal.bpcal_calc&#39;</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Get the amplitudes and phases and calculate signal-to-noise ratios</span>
        <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwList</span><span class="p">)):</span>
                <span class="n">chanRange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">numchanList</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="c1"># Consider full channel range. Any roll-off should be flagged</span>
                <span class="c1"># already.</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>

                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanRange</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanRange</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">])</span>
                <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanRange</span>

                <span class="c1"># Amplitude</span>
                <span class="n">bp_data</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">bp_data</span><span class="p">:</span>
                    <span class="n">amp_values</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bp_data</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">bp_data</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
                    <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_values</span>
                    <span class="n">amp_mean</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="n">pol</span><span class="p">])</span>
                    <span class="n">amp_rms</span> <span class="o">=</span> <span class="n">rms</span><span class="p">(</span><span class="n">amp_values</span><span class="o">-</span><span class="n">amp_mean</span><span class="p">)</span>
                    <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">amp_mean</span> <span class="o">/</span> <span class="n">amp_rms</span>

                <span class="c1"># Phase</span>
                <span class="n">bp_data</span> <span class="o">=</span> <span class="n">caLoc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">bp_data</span><span class="p">:</span>
                    <span class="n">phase_values</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bp_data</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">bp_data</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
                    <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">spwList</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="n">pol</span><span class="p">]</span> <span class="o">=</span> <span class="n">phase_values</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;bpcal.bpcal_calc&#39;</span>
            <span class="k">if</span> <span class="n">logger</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Return the dictionary containing the bandpass calibration statistics</span>
    <span class="k">return</span> <span class="n">bpcal_stats</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_write</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function writes the bandpass calibration statistics to a CASA table.</span>

<span class="c1"># NB: Because of the constant changes between integer and string variables, it</span>
<span class="c1"># was difficult to implement a generic field loop when writing the data.  For</span>
<span class="c1"># now, I&#39;m use a brute-force kludge when I write each column manually.  Also, I</span>
<span class="c1"># may use the same routine(s) for other types of caltables.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># bpcal_stats - This python dictionary contains the bandpass calibation</span>
<span class="c1">#               statistics.</span>
<span class="c1"># out_table   - This python string contains the output table name.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The bandpass calibration statistics table is created in the output directory.</span>
<span class="c1"># If the function finishes successfully, True is returned via the function</span>
<span class="c1"># value.  If the function does not finish successfully, it throws an exception.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2011 May 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version (stub).</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               First working version.</span>
<span class="c1"># 2012 Mar 14 - Nick Elias, NRAO</span>
<span class="c1">#               Used brute-force kludge to write columns, may change later.</span>
<span class="c1"># 2012 Mar 16 - Nick Elias, NRAO</span>
<span class="c1">#               Modified to handle different spectral window configurations.</span>
<span class="c1"># 2012 May 09 - Nick Elias, NRAO</span>
<span class="c1">#               Reverted to writing one spectral window at a time.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_write">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_write.html#pipeline.qa.bpcal.bpcal_write">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_write</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">,</span> <span class="n">out_table</span><span class="p">):</span>

    <span class="c1"># Create the local instance of the table tool, create the output main</span>
    <span class="c1"># table with a place holder data description, and close the table</span>
    <span class="n">tbLoc</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">table</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">out_table</span><span class="p">,</span> <span class="n">bpcal_desc</span><span class="p">())</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">addrows</span><span class="p">()</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s1">&#39;place_holder&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Get the list of subtables and create them (AMPLITUDE and PHASE)</span>
    <span class="n">subtables</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">subtables</span><span class="p">:</span>
        <span class="n">out_subtable</span> <span class="o">=</span> <span class="n">out_table</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">st</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">tbLoc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">out_subtable</span><span class="p">,</span> <span class="n">bpcal_desc_st</span><span class="p">())</span>
        <span class="n">tbLoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Put the data into the subtables</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">subtables</span><span class="p">:</span>

        <span class="c1"># Cannot write AMPLITUDE_SNR data yet.</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;FIT&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out_subtable</span> <span class="o">=</span> <span class="n">out_table</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">st</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">tbLoc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_subtable</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">dictST</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="n">st</span><span class="p">]</span>
            <span class="n">spwGroup</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dictST</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spwGroup</span><span class="p">:</span>
                <span class="n">dictSPW</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="n">st</span><span class="p">][</span><span class="n">s</span><span class="p">]</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">dictSPW</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
                <span class="n">chanRange</span> <span class="o">=</span> <span class="n">dictSPW</span><span class="p">[</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">tbLoc</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dictSPW</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># -2: spw &amp; chanRange</span>
                    <span class="n">dictRow</span> <span class="o">=</span> <span class="n">dictSPW</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
                    <span class="n">tbLoc</span><span class="o">.</span><span class="n">addrows</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">bpcal_putFitRow</span><span class="p">(</span><span class="n">tbLoc</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">,</span> <span class="n">row</span><span class="o">+</span><span class="n">r</span><span class="p">)</span>

            <span class="n">tbLoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Link the output subtables to the output main table using keywords,</span>
    <span class="c1"># close the main table, and delete the local table tool</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_table</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">subtables</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;Table: &#39;</span> <span class="o">+</span> <span class="n">out_table</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">keyword</span>
        <span class="n">tbLoc</span><span class="o">.</span><span class="n">putkeyword</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">del</span> <span class="n">tbLoc</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Unit functions and ICDs</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="c1"># bpcal_putFitRow</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function puts a row of data into the output table.</span>

<span class="c1"># NB: An instance of the table tool must already be created, the output table</span>
<span class="c1"># must be open, the output table must have a sufficient number of rows, and the</span>
<span class="c1"># output table must be closed elsewhere.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># tbLoc     - This python instance contains the table tool which is opened to</span>
<span class="c1">#             the output table.</span>
<span class="c1"># spw       - This python integer contains the spectral window number.</span>
<span class="c1"># chanRange - This two-element python list of integers contains the start and</span>
<span class="c1">#             stop channels.</span>
<span class="c1"># dictRow   - This python dictionary contains the fit information for a row.</span>
<span class="c1"># row       - This python int contains the row number in the output table.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python boolean true, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Mar 16 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2012 May 11 - Nick Elias, NRAO</span>
<span class="c1">#               Input parameters spw and chanRange added.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_putFitRow">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_putFitRow.html#pipeline.qa.bpcal.bpcal_putFitRow">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_putFitRow</span><span class="p">(</span><span class="n">tbLoc</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>

    <span class="c1"># Put the columns in the desired row using the putcell method of the</span>
    <span class="c1"># table tool</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;field&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]))</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;antenna1&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;antenna1&#39;</span><span class="p">]))</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;antenna2&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;antenna2&#39;</span><span class="p">]))</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;chanRange&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">)</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">])</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;abscissa&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;abscissa&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;valueErr&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;valueErr&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">])</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;validFit&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;validFit&#39;</span><span class="p">])</span>

    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;pars&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;pars&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;vars&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;covars&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;covars&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;redChi2&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;redChi2&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;resVar&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;resVar&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;resMean&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;resMean&#39;</span><span class="p">])</span>
    <span class="n">tbLoc</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">dictRow</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_desc</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function returns the place holder data description dictionary.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># None.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python dictionary containing the place holder data description dictionary,</span>
<span class="c1"># returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_desc">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_desc.html#pipeline.qa.bpcal.bpcal_desc">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_desc</span><span class="p">():</span>

    <span class="c1"># Create the data description dictionary</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;place_holder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Place holder&#39;</span><span class="p">,</span>
         <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
         <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
         <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
         <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span>
    <span class="p">}</span>

    <span class="c1"># Return the data description dictionary</span>
    <span class="k">return</span> <span class="n">desc</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_desc_st</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function creates the bandpass calibration subtable data description</span>
<span class="c1"># dictionary.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># None.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python dictionary containing the bandpass calibration subtable data</span>
<span class="c1"># description dictionary, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Mar 09 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2012 May 09 - Nick Elias, NRAO</span>
<span class="c1">#               Made the spectral window cells scalar and removed the start and</span>
<span class="c1">#               stop channel columns.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_desc_st">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_desc_st.html#pipeline.qa.bpcal.bpcal_desc_st">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_desc_st</span><span class="p">():</span>
    <span class="c1"># Create the bandpass calibration subtable data description dictionary</span>

    <span class="n">desc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Field number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;antenna1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Antenna 1 number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;antenna2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Antenna 2 number&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Spectral window&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Start and stop channels&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Feed&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;abscissa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Abscissa&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Times&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Frequencies&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Values&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;valueErr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Value errors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Flags&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;SSM&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit order&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit Weight&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;validFit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit valid boolean&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;pars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit parameters&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit variances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;covars&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit covariances&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;redChi2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit chi-squared&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit residuals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;resVar&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Variance of residuals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;resMean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Mean of residuals&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="s1">&#39;Fit model&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;ndim&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="s1">&#39;double&#39;</span>
    <span class="p">}</span>

    <span class="c1"># Return the data description dictionary</span>
    <span class="k">return</span> <span class="n">desc</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_chanRangeList</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function returns the trimmed channel range.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># 1. Start channel:</span>
<span class="c1">#    a. Multiply the number of channels by the trim parameter.</span>
<span class="c1">#    b. Subtract 0.5.</span>
<span class="c1">#    c. Round and int the result.</span>
<span class="c1"># 2. Stop channel:</span>
<span class="c1">#    a. Multiply the number of channels by 1.0 minus the trim parameter.</span>
<span class="c1">#    b. Subtract 0.5.</span>
<span class="c1">#    c. Round and int the result.</span>
<span class="c1"># 3. These values maximize the number of kept channels.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># numchan - This python integer contains the number of channels.</span>
<span class="c1"># trim    - This python float contains the fraction of trimmed channels from</span>
<span class="c1">#           each side of the spectral window.  The default is 0.1.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python list of integers (two elements) containing the start and stop</span>
<span class="c1"># channels, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 May 15 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_chanRangeList">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_chanRangeList.html#pipeline.qa.bpcal.bpcal_chanRangeList">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_chanRangeList</span><span class="p">(</span><span class="n">numchan</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>

    <span class="c1"># If the spectral window has no channels, return []</span>
    <span class="k">if</span> <span class="n">numchan</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Calculate the start and stop channels and return them</span>
    <span class="n">startChan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">trim</span><span class="o">*</span><span class="n">numchan</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>
    <span class="n">stopChan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">((</span><span class="mf">1.0</span><span class="o">-</span><span class="n">trim</span><span class="p">)</span><span class="o">*</span><span class="n">numchan</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">startChan</span><span class="p">,</span> <span class="n">stopChan</span><span class="p">]</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_spwChanString</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function converts spectral window and channel range lists to a CASA</span>
<span class="c1"># selection string.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># spw    - This python integer contains the spectral window number.</span>
<span class="c1"># sschan - This python list of integers (two elements) contains the start and</span>
<span class="c1">#          stop channels.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The string containing the CASA spectral window selection string, returned via</span>
<span class="c1"># the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 May 15 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_spwChanString">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_spwChanString.html#pipeline.qa.bpcal.bpcal_spwChanString">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_spwChanString</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">sschan</span><span class="p">):</span>

    <span class="c1"># Form the spectral window string and return it</span>
    <span class="n">spwS</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sschan</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sschan</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">spwS</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the score to prioritize the plots on the HTML page.</span>

<span class="c1"># NB: I make the distinction between amplitude and phase flags because the</span>
<span class="c1"># underlying C++ code of the calibration analysis tool performs various checks.</span>

<span class="c1"># NB: The maximum cutoff in the bpcal_score_RMS() call (0.1 for normalized</span>
<span class="c1"># amplitude, 0.2 radians for phase) can be changed here, if desired.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># bpcal_stats - This python dictionary contains the bandpass calibation</span>
<span class="c1">#               statistics.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The dictionary containing the bandpass scores dictionary, returned via the</span>
<span class="c1"># function value.</span>

<span class="c1"># The keys:</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_FLAG&#39;  - The python dictionary containing the amplitude flag</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_RMS&#39;   - The python dictionary containing the amplitude RMS</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_SNR&#39;   - The python dictionary containing the amplitude signal</span>
<span class="c1">#                           to noise scores.</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_FN&#39;    - The python dictionary containing the amplitude flatness</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_DD&#39;    - The python dictionary containing the amplitude derivative</span>
<span class="c1">#                           deviation scores.</span>
<span class="c1"># &#39;AMPLITUDE_SCORE_TOTAL&#39; - The python dictionary containing the amplitude total</span>
<span class="c1">#                           (flag plus RMS) scores.</span>
<span class="c1"># &#39;PHASE_SCORE_FLAG&#39;      - The python dictionary containing the phase flag</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;PHASE_SCORE_RMS&#39;       - The python dictionary containing the phase RMS</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;PHASE_SCORE_FN&#39;        - The python dictionary containing the phase flatness</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;PHASE_SCORE_DD&#39;        - The python dictionary containing the phase derivative</span>
<span class="c1">#                           deviation scores.</span>
<span class="c1"># &#39;PHASE_SCORE_DELAY&#39;     - The python dictionary containing the phase delay</span>
<span class="c1">#                           scores.</span>
<span class="c1"># &#39;PHASE_SCORE_TOTAL&#39;     - The python dictionary containing the phase total</span>
<span class="c1">#                           (flag plus RMS plus delay) scores.</span>

<span class="c1"># All of the python dictionaries mentioned above have the same format and point</span>
<span class="c1"># to the same key:</span>
<span class="c1"># &#39;&lt;spw index #&gt;&#39; - The python dictionary containing the spectral window index.</span>

<span class="c1"># The &#39;&lt;spw index#&gt;&#39; python dictionaries mentioned above have the same format</span>
<span class="c1"># and point to the following element:</span>
<span class="c1"># &#39;&lt;iter#&gt;&#39;     - The python string containing the iteration number.  It points</span>
<span class="c1">#                 to a python float containing the score for a field, antenna</span>
<span class="c1">#                 1, antenna 2, feed, and time.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Jun 23 - Nick Elias, NRAO</span>
<span class="c1">#               Initial stub version created.</span>
<span class="c1"># 2012 Jul 13 - Nick Elias, NRAO</span>
<span class="c1">#               Calls to score functions added and results saved to score</span>
<span class="c1">#               dictionary.</span>
<span class="c1"># 2013        - Dirk Muders, MPIfR</span>
<span class="c1">#               Added amplitude signal to noise scoring</span>
<span class="c1"># 2013 Jul 22 - Dirk Muders, MPIfR</span>
<span class="c1">#               Added amplitude shape scoring</span>
<span class="c1"># 2013 Aug 06 - Dirk Muders, MPIfR</span>
<span class="c1">#               Renamed SHAPE to FLATNESS (FN)</span>
<span class="c1">#               Added derivative deviation scoring</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score.html#pipeline.qa.bpcal.bpcal_score">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">):</span>

    <span class="c1"># Initialize the score dictionary</span>
    <span class="n">bpcal_scores</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FLAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_RMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_DD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_TOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FLAG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_RMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DELAY&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_TOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># Calculate all of the amplitude (flag, RMS, total) scores for each</span>
    <span class="c1"># spectral window and save them to the score dictionary.  The keys are</span>
    <span class="c1"># antenna1, antenna2, and feed (hopefully, field and time have only one</span>
    <span class="c1"># value).</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_FIT&#39;</span><span class="p">]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">:</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">spwNum</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>

        <span class="n">chanRange</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;chanRange&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_SNR&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FN&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_DD&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_TOTAL&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pars&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_flag</span><span class="p">(</span><span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span> <span class="n">chanRange</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_RMS</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;resVar&#39;</span><span class="p">]),</span> <span class="mf">0.1</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_SNR&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_SNR</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SNR&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FN&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_flatness</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_DD&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_derivative_deviation</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_TOTAL&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> \
                <span class="o">*</span> <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

    <span class="c1"># Calculate all of the phase scores (flag, RMS, delay, total) for each</span>
    <span class="c1"># spectral window and save them to the score dictionary.  The keys are</span>
    <span class="c1"># antenna1, antenna2, and feed (hopefully, field and time have only one</span>
    <span class="c1"># value).</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE_FIT&#39;</span><span class="p">]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">:</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="n">spwNum</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>

        <span class="n">chanRange</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;chanRange&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FN&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DD&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DELAY&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_TOTAL&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pars&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_flag</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span> <span class="n">chanRange</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_RMS</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;resVar&#39;</span><span class="p">]),</span> <span class="mf">0.05</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FN&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_flatness</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DD&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_derivative_deviation</span><span class="p">(</span><span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="s1">&#39;phase&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DELAY&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_score_delay</span><span class="p">(</span>
                    <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;pars&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                    <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;frequency&#39;</span><span class="p">],</span> <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span>
                    <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;flag&#39;</span><span class="p">],</span> <span class="n">chanRange</span><span class="p">)</span>

            <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_TOTAL&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_FLAG&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> \
                <span class="o">*</span> <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_RMS&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> \
                <span class="o">*</span> <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;PHASE_SCORE_DELAY&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

        <span class="c1"># Calculate grand total score</span>
        <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;TOTAL&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_SNR&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
                          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">bpcal_scores</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_SCORE_SNR&#39;</span><span class="p">]])</span>

    <span class="c1"># Return the bandpass score dictionary</span>
    <span class="k">return</span> <span class="n">bpcal_scores</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_flag</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the flag score for a given iteration.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># * Calculate the percentage of flagged data.</span>
<span class="c1"># * Calculate 1.0 minus percentage of flagged data, which is the percentage of</span>
<span class="c1">#   good data and the score.</span>
<span class="c1"># * Data not included in the channel range, e.g. edge channels, are not included</span>
<span class="c1">#   in the calculation.</span>
<span class="c1"># * This algorithm is very simple, but it can be refined, if necessary.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># flags     - This numpy array of booleans contains the flags for a given</span>
<span class="c1">#             iteration.</span>
<span class="c1"># chanRange - This python list of two integers contains the start and stop</span>
<span class="c1">#             channels (in order to exclude the edge channels).</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python float containing the flag score, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Aug 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score_flag">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_flag.html#pipeline.qa.bpcal.bpcal_score_flag">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_flag</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">):</span>

    <span class="c1"># Calculate and return the flag score for this iteration</span>
    <span class="n">flagsTemp</span> <span class="o">=</span> <span class="n">flags</span><span class="p">[</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">nData</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagsTemp</span><span class="p">)</span>
    <span class="n">nFlag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flagsTemp</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span>
    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nFlag</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nData</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">score</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_RMS</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the RMS score for a given iteration.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># * Determine if the RMS is larger than the cutoff maximum RMS.  If so, set the</span>
<span class="c1">#   RMS to the maximum value.</span>
<span class="c1"># * Divide the RMS by the cutoff maximum RMS.</span>
<span class="c1"># * Calculate 1.0 minus the previous fraction, which is the score.</span>
<span class="c1"># * This algorithm is very simple, but it can be refined, if necessary.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># RMS    - This python float contains the RMS.</span>
<span class="c1"># RMSMax - This python float contains the cutoff maximum RMS.  If the RMS is</span>
<span class="c1">#          larger than this value, the RMS is set to this value.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python float containing the RMS score, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Aug 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score_RMS">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_RMS.html#pipeline.qa.bpcal.bpcal_score_RMS">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_RMS</span><span class="p">(</span><span class="n">RMS</span><span class="p">,</span> <span class="n">RMSMax</span><span class="p">):</span>

    <span class="c1"># Calculate and return the RMS score for this iteration</span>
    <span class="k">if</span> <span class="n">RMS</span> <span class="o">&lt;=</span> <span class="n">RMSMax</span><span class="p">:</span>
        <span class="n">RMSTemp</span> <span class="o">=</span> <span class="n">RMS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">RMSTemp</span> <span class="o">=</span> <span class="n">RMSMax</span>

    <span class="k">if</span> <span class="n">RMSTemp</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">RMSMax</span> <span class="o">/</span> <span class="n">RMSTemp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
            <span class="c1"># work around scipy bug triggered with certain values, such as when</span>
            <span class="c1"># SNR=37.5922006575. The bug is supposed to be fixed in scipy 0.12.0,</span>
            <span class="c1"># so detect which version of scipy we&#39;re running under and try the</span>
            <span class="c1"># operation again if this version is known to be affected.</span>
            <span class="c1">#</span>
            <span class="c1"># We can safely ignore the exception as it is only thrown when the</span>
            <span class="c1"># error function return value is so close to -1 or 1 that the lack of</span>
            <span class="c1"># precision makes no practical difference.</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">under_orig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;under&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                    <span class="n">score</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">RMSMax</span> <span class="o">/</span> <span class="n">RMSTemp</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RMSMax</span> <span class="o">/</span> <span class="n">RMSTemp</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="n">under_orig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">RMSMax</span> <span class="o">/</span> <span class="n">RMSTemp</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">score</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_SNR</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the signal-to-noise score.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># Use error function to evaluate validity of a given sigma.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2013 Jan 22 - Dirk Muders, MPIfR</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score_SNR">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_SNR.html#pipeline.qa.bpcal.bpcal_score_SNR">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_SNR</span><span class="p">(</span><span class="n">SNR</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">SNR</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
        <span class="c1"># work around scipy bug triggered with certain values, such as when</span>
        <span class="c1"># SNR=37.5922006575. The bug is supposed to be fixed in scipy 0.12.0,</span>
        <span class="c1"># so detect which version of scipy we&#39;re running under and try the</span>
        <span class="c1"># operation again if this version is known to be affected.</span>
        <span class="c1">#</span>
        <span class="c1"># We can safely ignore the exception as it is only thrown when the</span>
        <span class="c1"># error function return value is so close to -1 or 1 that the lack of</span>
        <span class="c1"># precision makes no practical difference.</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
            <span class="n">under_orig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;under&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                <span class="n">score</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">SNR</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="n">SNR</span>
                <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="n">under_orig</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="n">SNR</span>
            <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">score</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_flatness</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the flatness score.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># * Calculate the Wiener Entropy of amplitude values vs. frequency</span>
<span class="c1"># * A result of 1.0 means the shape is perfectly flat</span>
<span class="c1"># * Determine score by evaluating the deviation of the Wiener</span>
<span class="c1">#   Entropy from 1.0</span>
<span class="c1"># * The Wiener Entropy can only be calculated for positive values.</span>
<span class="c1">#   When encountering any negative ones, the algorithm shiftst the</span>
<span class="c1">#   spectrum up to slightly positive values.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># values    - Values</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python float containing the flatness score.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2013 Jul 22 - Dirk Muders, MPIfR</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2013 Aug 05 - Dirk Muders, MPIfR</span>
<span class="c1">#               Weight Wiener entropy with error function</span>
<span class="c1">#               to create sharper fall-off.</span>
<span class="c1"># 2023 Dec 13 - Dirk Muders, MPIfR</span>
<span class="c1">#               Avoid NaNs when part of the spectrum is negative.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score_flatness">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_flatness.html#pipeline.qa.bpcal.bpcal_score_flatness">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_flatness</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">values</span><span class="p">)):</span>
        <span class="n">wEntropy</span> <span class="o">=</span> <span class="mf">1.0e10</span>
    <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="c1"># Need to avoid zero mean as it would cause a division exception</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">wEntropy</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wEntropy</span> <span class="o">=</span> <span class="mf">1.0e10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Geometrical mean can not be calculated for vectors &lt;= 0.0 for any</span>
        <span class="c1"># elements.</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="c1"># All negative -&gt; just invert the spectrum to estimate the flatness</span>
            <span class="n">wEntropy</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">gmean</span><span class="p">(</span><span class="o">-</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">values</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="c1"># Some negative, some positive values (like in a phase spectrum)</span>
            <span class="c1"># -&gt; push to slightly positive numbers. Since gmean returns 0.0 if</span>
            <span class="c1"># at least one value of the spectrum is 0.0, we offset with the</span>
            <span class="c1"># minimum plus a small positive number.</span>
            <span class="n">wEntropy</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">gmean</span><span class="p">(</span><span class="n">values</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wEntropy</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">mstats</span><span class="o">.</span><span class="n">gmean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">/</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">wEntropy</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="n">flatnessScore</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">flatnessScore</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="mf">0.001</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">wEntropy</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
            <span class="c1"># work around scipy bug triggered with certain values, such as when</span>
            <span class="c1"># SNR=37.5922006575. The bug is supposed to be fixed in scipy 0.12.0,</span>
            <span class="c1"># so detect which version of scipy we&#39;re running under and try the</span>
            <span class="c1"># operation again if this version is known to be affected.</span>
            <span class="c1">#</span>
            <span class="c1"># We can safely ignore the exception as it is only thrown when the</span>
            <span class="c1"># error function return value is so close to -1 or 1 that the lack of</span>
            <span class="c1"># precision makes no practical difference.</span>
            <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                <span class="n">under_orig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;under&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                    <span class="n">flatnessScore</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="mf">0.001</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">wEntropy</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">wEntropy</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="n">under_orig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.001</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">wEntropy</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">flatnessScore</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># TODO: Use usual MAD function from pipeline.</span>

<div class="viewcode-block" id="MAD">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.MAD.html#pipeline.qa.bpcal.MAD">[docs]</a>
<span class="nd">@numpy</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">MAD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">0.6745</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Median Absolute Deviation along given axis of an array:</span>

<span class="sd">    median(abs(a - median(a))) / c</span>

<span class="sd">    c = 0.6745 is the constant to convert from MAD to std; it is used by</span>
<span class="sd">    default</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="c1"># I don&#39;t want the array to change so I have to copy it?</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aswp</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">aswp</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">aswp</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m</span></div>



<div class="viewcode-block" id="nanmedian">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.nanmedian.html#pipeline.qa.bpcal.nanmedian">[docs]</a>
<span class="k">def</span> <span class="nf">nanmedian</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns median ignoring NAN</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">arr</span> <span class="o">!=</span> <span class="n">arr</span><span class="p">,</span> <span class="n">arr</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_derivative_deviation</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the derivative deviation score.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># * Calculate the 1-channel derivative of the values and determine</span>
<span class="c1">#   the fraction of channels whose absolute value deviates by more</span>
<span class="c1">#   than 5*MAD. Score this fraction against the tolerated fraction</span>
<span class="c1">#   using the error function.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># values    - Values</span>
<span class="c1"># data_type - (optional) amp or phase</span>
<span class="c1"># spw       - (optional) spw ID</span>
<span class="c1"># index     - (optional) bpcal table index</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python float containing the derivative deviation score.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2013 Aug 06 - Dirk Muders, MPIfR</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2022 Jul 22 - Dirk Muders, MPIfR</span>
<span class="c1">#               Re-map scores to piecewise linear sections (PIPE-1515).</span>
<div class="viewcode-block" id="bpcal_score_derivative_deviation">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_derivative_deviation.html#pipeline.qa.bpcal.bpcal_score_derivative_deviation">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_derivative_deviation</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">data_type</span><span class="o">=</span><span class="s1">&#39;UNKNOWN&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="s1">&#39;UNKNONWN&#39;</span><span class="p">):</span>

    <span class="c1"># Avoid scoring numerical inaccuracies for the reference antenna phase</span>
    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
        <span class="n">ddScore</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mappedDDScore</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bpcal derivative deviation scorer for data type </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> SPW </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> table index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: low data variation, erf based score = 1.0, piecewise linear mapped score = 1.0&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">derivative</span> <span class="o">=</span> <span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">derivativeMAD</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">derivative</span><span class="p">)</span>
        <span class="n">numOutliers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">derivative</span> <span class="o">&gt;</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">derivativeMAD</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">numOutliers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ddScore</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">mappedDDScore</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bpcal derivative deviation scorer for data type </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> SPW </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> table index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: no outliers, erf based score = 1.0, piecewise linear mapped score = 1.0&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outliersFraction</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">numOutliers</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
            <span class="n">toleratedFraction</span> <span class="o">=</span> <span class="mf">0.01</span>
            <span class="n">fractionRatio</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">toleratedFraction</span> <span class="o">/</span> <span class="n">outliersFraction</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ddScore</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">fractionRatio</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">minor_version</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">short_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">minor_version</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">under_orig</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">geterr</span><span class="p">()[</span><span class="s1">&#39;under&#39;</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>
                        <span class="n">ddScore</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erf</span><span class="p">(</span><span class="n">fractionRatio</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="n">fractionRatio</span>
                        <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">under</span><span class="o">=</span><span class="n">under_orig</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Error calling scipy.special.erf(</span><span class="si">%s</span><span class="s1">/math.sqrt(2.0))&#39;</span> <span class="o">%</span> <span class="n">fractionRatio</span>
                    <span class="k">raise</span> <span class="ne">FloatingPointError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">ddScore</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
                <span class="n">mappedDDScore</span> <span class="o">=</span> <span class="n">scorers</span><span class="o">.</span><span class="n">linScorer</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">toleratedFraction</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.34</span><span class="p">,</span> <span class="mf">0.66</span><span class="p">)(</span><span class="n">ddScore</span><span class="p">)</span>
            <span class="k">elif</span> <span class="mf">0.2</span> <span class="o">&lt;=</span> <span class="n">ddScore</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                <span class="n">mappedDDScore</span> <span class="o">=</span> <span class="n">scorers</span><span class="o">.</span><span class="n">linScorer</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.67</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)(</span><span class="n">ddScore</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mappedDDScore</span> <span class="o">=</span> <span class="n">scorers</span><span class="o">.</span><span class="n">linScorer</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.91</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)(</span><span class="n">ddScore</span><span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;bpcal derivative deviation scorer for data type </span><span class="si">{</span><span class="n">data_type</span><span class="si">}</span><span class="s2"> SPW </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> table index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">: fractionRatio = </span><span class="si">{</span><span class="n">fractionRatio</span><span class="si">}</span><span class="s2">, erf based score = </span><span class="si">{</span><span class="n">ddScore</span><span class="si">}</span><span class="s2">, piecewise linear mapped score = </span><span class="si">{</span><span class="n">mappedDDScore</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mappedDDScore</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_score_delay</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function calculates the delay score for a given iteration.</span>

<span class="c1"># Algorithm:</span>
<span class="c1"># ----------</span>
<span class="c1"># * Determine is the delay is less than three times the delay error.  If so,</span>
<span class="c1">#   return a score of 1.0.</span>
<span class="c1"># * Determine which two near central channels to use.  If there are issues,</span>
<span class="c1">#   return a score of 0.0.</span>
<span class="c1"># * Calculate the frequency and phase difference between the two near central</span>
<span class="c1">#   channels.</span>
<span class="c1"># * Calculate the cutoff maximum delay.</span>
<span class="c1"># * Determine if the delay is larger than the cutoff maximum delay.  If so, set</span>
<span class="c1">#   the delay to the maximum value.</span>
<span class="c1"># * Divide the delay by the cutoff maximum delay.</span>
<span class="c1"># * Calculate 1.0 minus the previous fraction, which is the score.</span>
<span class="c1"># * This algorithm is very simple, but it can be refined, if necessary.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># delay     - This python float contains the delay.</span>
<span class="c1"># delayErr  - This python float contains the delay error.</span>
<span class="c1"># freqs     - This numpy float array contains the frequencies.</span>
<span class="c1"># phases    - This numpy float array contains the phases.</span>
<span class="c1"># flags     - This numpy array of booleans contains the flags for a given</span>
<span class="c1">#             iteration.</span>
<span class="c1"># chanRange - This python list of two integers contains the start and stop</span>
<span class="c1">#             channels (in order to exclude the edge channels).</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python float containing the delay score, returned via the function value.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Aug 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_score_delay">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_score_delay.html#pipeline.qa.bpcal.bpcal_score_delay">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_score_delay</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">delayErr</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">phases</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">):</span>

    <span class="c1"># Calculate and return the delay score for this iteration</span>
    <span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;=</span> <span class="mf">3.0</span><span class="o">*</span><span class="n">delayErr</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="n">chanMiddle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">chanRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">chanMiddle</span> <span class="o">&lt;=</span> <span class="n">chanRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">chanMiddle</span> <span class="o">&gt;=</span> <span class="n">chanRange</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="n">chanMiddle</span><span class="p">]</span> <span class="ow">or</span> <span class="n">flags</span><span class="p">[</span><span class="n">chanMiddle</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">dFreq</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="n">chanMiddle</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freqs</span><span class="p">[</span><span class="n">chanMiddle</span><span class="p">])</span>
    <span class="n">dPhase</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">phases</span><span class="p">[</span><span class="n">chanMiddle</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phases</span><span class="p">[</span><span class="n">chanMiddle</span><span class="p">])</span>

    <span class="n">delayMax</span> <span class="o">=</span> <span class="n">dPhase</span> <span class="o">/</span> <span class="p">((</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="n">dFreq</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">delay</span> <span class="o">&lt;=</span> <span class="n">delayMax</span><span class="p">:</span>
        <span class="n">delayTemp</span> <span class="o">=</span> <span class="n">delay</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">delayTemp</span> <span class="o">=</span> <span class="n">delayMax</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">delayTemp</span><span class="o">/</span><span class="n">delayMax</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">score</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_plot</span>

<span class="c1"># Directory:</span>
<span class="c1"># ----------</span>
<span class="c1"># This function is the top-level interface to other functions that create</span>
<span class="c1"># bandpass calibration plots.</span>

<span class="c1"># NB: The input caltable is used only for its name, which is used as the prefix</span>
<span class="c1"># for plot names.</span>

<span class="c1"># NB: This function assumes that only a single field will be used for a bandpass</span>
<span class="c1"># calibration.  If multiple fields appear in the bandpass statistics dictionary,</span>
<span class="c1"># the plot file names will have to take it into account.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># in_table    - This python string contains the name of the input bandpass</span>
<span class="c1">#               calibration table.</span>
<span class="c1"># out_dir     - This python string contains the output directory.</span>
<span class="c1"># bpcal_stats - This python dictionary contains the bandpass calibation</span>
<span class="c1">#               statistics.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The dictionary containing the bandpass plot names, returned via the function</span>
<span class="c1"># value.  If the function does not finish successfully, an exception is raised.</span>

<span class="c1"># The keys:</span>
<span class="c1"># &#39;AMPLITUDE_PLOT&#39; - The python dictionary containing the amplitude plots.</span>
<span class="c1"># &#39;PHASE_PLOT&#39;     - The python dictionary containing the phase plots.</span>

<span class="c1"># The &#39;AMPLITUDE_PLOT&#39; and &#39;PHASE_PLOT&#39; python dictionaries mentioned above have</span>
<span class="c1"># the same format and point to the following key:</span>
<span class="c1"># &#39;&lt;spw index #&gt;&#39; - The python dictionary containing the spectral window index.</span>

<span class="c1"># The &#39;&lt;spw index#&gt;&#39; python dictionaries mentioned above have the same format</span>
<span class="c1"># and point to the following dictionary:</span>
<span class="c1"># &#39;&lt;iter#&gt;&#39;     - The python string containing the iteration number.  It points</span>
<span class="c1">#                 to a python float containing the score for a field, antenna</span>
<span class="c1">#                 1, antenna2, feed, and time.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Jun 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># 2012 Jun 20 - Nick Elias, NRAO</span>
<span class="c1">#               Added calls to bpcal_plot_hist() for histograms of number of</span>
<span class="c1">#               flagged data, RMSes, and absolute value of delays.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_plot">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_plot.html#pipeline.qa.bpcal.bpcal_plot">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_plot</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">bpcal_stats</span><span class="p">):</span>

    <span class="c1"># Initialize the plot names dictionary</span>
    <span class="n">bpcal_plots</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># Create all amplitude plots for all keys for each spectral window.  The</span>
    <span class="c1"># keys are antenna1, antenna2, and feed (hopefully, field and time are</span>
    <span class="c1"># have only one value).</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_FIT&#39;</span><span class="p">]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">amp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_PLOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">:</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>
        <span class="n">chanRange</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">];</span> <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;chanRange&#39;</span><span class="p">)</span>

        <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_PLOT&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;AMPLITUDE_PLOT&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpcal_plot1</span><span class="p">(</span>
                <span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">)</span>

    <span class="c1"># Create the amplitude histograms for the number of flagged data and the</span>
    <span class="c1"># absolute value of the delay</span>
    <span class="n">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
    <span class="n">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;RMS&#39;</span><span class="p">)</span>

    <span class="c1"># Create all phase plots for all keys for each spectral window.  The</span>
    <span class="c1"># keys are antenna1, antenna2, and feed (hopefully, field and time are</span>
    <span class="c1"># have only one value).</span>
    <span class="n">phase</span> <span class="o">=</span> <span class="n">bpcal_stats</span><span class="p">[</span><span class="s1">&#39;PHASE_FIT&#39;</span><span class="p">]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;PHASE_PLOT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>
        <span class="n">chanRange</span> <span class="o">=</span> <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;chanRange&#39;</span><span class="p">]</span>

        <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s1">&#39;chanRange&#39;</span><span class="p">)</span>

        <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;PHASE_PLOT&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">bpcal_plots</span><span class="p">[</span><span class="s1">&#39;PHASE_PLOT&#39;</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpcal_plot1</span><span class="p">(</span>
                <span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">phase</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">s</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">)</span>

    <span class="c1"># Create the phase histograms for the number of flagged data, the</span>
    <span class="c1"># RMS, and the absolute value of the delay</span>
    <span class="n">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
    <span class="n">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;RMS&#39;</span><span class="p">)</span>
    <span class="n">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;DELAY&#39;</span><span class="p">)</span>

    <span class="c1"># Return the plot names dictionary</span>
    <span class="k">return</span> <span class="n">bpcal_plots</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_plot1</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function creates a single bandpass statistics plot and saves it to disk.</span>

<span class="c1"># NB: The plot file name is the prefix of the input table name plus</span>
<span class="c1"># &#39;.bpcal.stats&#39; plus &#39;amp&#39; or &#39;phase&#39; plus the spectral window number plus</span>
<span class="c1"># the antenna1 number plus the antenna2 number plus &#39;.png&#39;.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>
<span class="c1"># in_table   - This python string contains the name of the input bandpass</span>
<span class="c1">#              calibration table.</span>
<span class="c1"># out_dir    - This python string contains the output directory.</span>
<span class="c1"># stats_dict - The python dictionary that contains the bandpass calibration</span>
<span class="c1">#              statistics versus baseline (it is the &#39;iter#&#39; element of the</span>
<span class="c1">#              &#39;AMPLITUDE_FIT/PHASE_FIT&#39; element of the dictionary returned by</span>
<span class="c1">#              the bpcal_calc() function).</span>
<span class="c1"># spw        - The python string containing the spectral window number.</span>
<span class="c1"># chanRange  - The python list of integers containing the start and stop channel</span>
<span class="c1">#              used in the bandpass fit.  NB: This list should have only two</span>
<span class="c1">#              elements.</span>
<span class="c1"># iteration  - The python string containing the iteration number.</span>
<span class="c1"># ap         - The python string containing either &#39;AMPLITUDE&#39; or &#39;PHASE&#39;.  Only</span>
<span class="c1">#              the first letter is required, and it does not need to be</span>
<span class="c1">#              capitalized.</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>
<span class="c1"># The python string containing the bandpass plot name, returned via the function</span>
<span class="c1"># value.</span>
<span class="c1"># The bandpass statistics plot, saved to disk.</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Jun 20 - Nick Elias, NRAO</span>
<span class="c1">#               Initial version.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_plot1">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_plot1.html#pipeline.qa.bpcal.bpcal_plot1">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_plot1</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">stats_dict</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chanRange</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">ap</span><span class="p">):</span>

    <span class="c1"># Determine and check amplitude &#39;A&#39; or phase &#39;P&#39;</span>
    <span class="n">apTemp</span> <span class="o">=</span> <span class="n">ap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">apTemp</span> <span class="o">!=</span> <span class="s1">&#39;A&#39;</span> <span class="ow">and</span> <span class="n">apTemp</span> <span class="o">!=</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get and check the frequencies</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Get the bandpass calibration values and their errors</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">valueErr</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;valueErr&#39;</span><span class="p">]</span>

    <span class="c1"># Plot the bandpass calibration values and their errors with green</span>
    <span class="c1"># symbols.  Overwrite flagged data with red symbols.</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">valueErr</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;go&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;good&#39;</span><span class="p">)</span>

    <span class="n">flag</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">valueErr</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;ro&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;flagged&#39;</span><span class="p">)</span>

    <span class="c1"># Add the title to the plot, which contains the spectral window, feed,</span>
    <span class="c1"># antenna1, antenna2, and time</span>

    <span class="n">feed</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;feed&#39;</span><span class="p">]</span>
    <span class="n">ant1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;antenna1&#39;</span><span class="p">])</span>
    <span class="n">ant2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;antenna2&#39;</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>

    <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;SPW = &#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">chanRange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Feed = &#39;</span> <span class="o">+</span> <span class="n">feed</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Baseline = &#39;</span> <span class="o">+</span> <span class="n">ant1</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="n">ant2</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>
    <span class="n">title</span> <span class="o">+=</span> <span class="s1">&#39;Time = &#39;</span> <span class="o">+</span> <span class="n">time</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

    <span class="c1"># Add the x and y labels</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apTemp</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Bandpass Amplitude&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Unwrapped Bandpass Phase&#39;</span><span class="p">)</span>

    <span class="c1"># If there is a valid model, add it as a line</span>
    <span class="k">if</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;validFit&#39;</span><span class="p">]:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;b-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>

    <span class="c1"># Add the legen for all points plotted</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Add annotations (RMS for amplitude and phase plots, delay for phase</span>
    <span class="c1"># plots)</span>
    <span class="n">RMS</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;resVar&#39;</span><span class="p">])</span>
    <span class="n">RMSS</span> <span class="o">=</span> <span class="s1">&#39;Fit RMS = </span><span class="si">%.3e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">RMS</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">RMSS</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;figure fraction&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">apTemp</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;validFit&#39;</span><span class="p">]:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;pars&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">delayErr</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stats_dict</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">delayS</span> <span class="o">=</span> <span class="s1">&#39;Delay = </span><span class="si">%.3e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">delay</span>
        <span class="n">delayS</span> <span class="o">+=</span> <span class="s1">&#39; +/- </span><span class="si">%.3e</span><span class="s1"> ns&#39;</span> <span class="o">%</span> <span class="n">delayErr</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">delayS</span><span class="p">,</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;figure fraction&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">))</span>

    <span class="c1"># Create the bandpass plot name based on amp/phase, spectral window</span>
    <span class="c1"># number, feed, antenna1, and antenna2</span>
    <span class="n">noExt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">in_table</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out_plot_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">noExt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">apTemp</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.amp&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.phase&#39;</span>

    <span class="n">out_plot</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">out_plot_root</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.bpcal.stats&#39;</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">spw</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">feed</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ant1</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">ant2</span>
    <span class="n">out_plot</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>

    <span class="c1"># Save the plot to disk and clear</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_plot</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="c1"># Return the bandpass plot name</span>
    <span class="k">return</span> <span class="n">out_plot</span></div>



<span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># bpcal_plot_hist</span>

<span class="c1"># Description:</span>
<span class="c1"># ------------</span>
<span class="c1"># This function plots the histograms of either number of flagged data, RMSes,</span>
<span class="c1"># or absolute value of delays, color coded by spectral window.</span>

<span class="c1"># Inputs:</span>
<span class="c1"># -------</span>

<span class="c1"># Outputs:</span>
<span class="c1"># --------</span>

<span class="c1"># Modification history:</span>
<span class="c1"># ---------------------</span>
<span class="c1"># 2012 Jun 22 - Nick Elias, NRAO</span>
<span class="c1">#               Initial stub version created.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="bpcal_plot_hist">
<a class="viewcode-back" href="../../../_autosummary/pipeline.qa.bpcal.bpcal_plot_hist.html#pipeline.qa.bpcal.bpcal_plot_hist">[docs]</a>
<span class="k">def</span> <span class="nf">bpcal_plot_hist</span><span class="p">(</span><span class="n">in_table</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="n">ap</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="n">hist</span><span class="o">=</span><span class="s1">&#39;FLAG&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>