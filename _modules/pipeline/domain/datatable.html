

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.domain.datatable &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.domain.datatable</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.domain.datatable</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># ALMA - Atacama Large Milliiter Array (c) European Southern Observatory, 2002</span>
<span class="c1"># Copyright by ESO (in the framework of the ALMA collaboration), All rights</span>
<span class="c1"># reserved</span>
<span class="c1">#</span>
<span class="c1"># This library is free software; you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="c1"># Software Foundation; either version 2.1 of the License, or (at your option)</span>
<span class="c1"># any later version.</span>
<span class="c1">#</span>
<span class="c1"># This library is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="c1"># FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more</span>
<span class="c1"># details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License</span>
<span class="c1"># along with this library; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>

<span class="c1">#</span>
<span class="c1"># $Revision: 1.1.2.6 $</span>
<span class="c1"># $Date: 2013/03/01 05:07:45 $</span>
<span class="c1"># $Author: tnakazat $</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="c1"># import memory_profiler</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="kn">import</span> <span class="n">absolute_path</span><span class="p">,</span> <span class="n">list_to_str</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">__coldesc</span><span class="p">(</span><span class="n">vtype</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">comment</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dataManagerGroup&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
         <span class="s1">&#39;dataManagerType&#39;</span><span class="p">:</span> <span class="s1">&#39;StandardStMan&#39;</span><span class="p">,</span>
         <span class="s1">&#39;valueType&#39;</span><span class="p">:</span> <span class="n">vtype</span><span class="p">,</span>
         <span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="n">option</span><span class="p">,</span>
         <span class="s1">&#39;maxlen&#39;</span><span class="p">:</span> <span class="n">maxlen</span><span class="p">,</span>
         <span class="s1">&#39;comment&#39;</span><span class="p">:</span> <span class="n">comment</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndim</span>
    <span class="k">if</span> <span class="n">unit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;UNIT&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="c1"># Description for data table columns as dictionary.</span>
<span class="c1"># Each value is a tuple containing:</span>
<span class="c1">#</span>
<span class="c1">#    (valueType,option,maxlen,ndim,comment[,unit])</span>
<span class="c1">#</span>
<span class="c1"># dataManagerGroup and dataManagerType is always &#39;StandardStMan&#39;.</span>
<span class="c1">#</span>
<span class="c1"># 2018/07/31 HE : added SHIFT_RA, SHIFT_DEC for CAS-11674</span>
<span class="c1"># 2019/05/23 HE : added OFS_RA, OFS_DEC for PIPE-220</span>
<span class="k">def</span> <span class="nf">__tabledescro</span><span class="p">():</span>
    <span class="n">TD_DESC_RO</span> <span class="o">=</span> <span class="p">[</span>
        <span class="c1">#    __coldesc(&#39;integer&#39;, 0, 0, -1, &#39;Primary key&#39;),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Row number&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Scan number&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;IF number&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Number of Polarizations&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Beam number&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Date&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Time in MJD&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Elapsed time since first scan&#39;</span> <span class="s1">&#39;d&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Exposure time&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Right Ascension&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Declination&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Shifted Right Ascension&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Shifted Declination&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Offset Right Ascension&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Offset Declination&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Number of channels&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Tsys&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Target name&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Antenna index&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Source type enum&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Field ID&#39;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;ROW&#39;</span><span class="p">,</span> <span class="s1">&#39;SCAN&#39;</span><span class="p">,</span> <span class="s1">&#39;IF&#39;</span><span class="p">,</span> <span class="s1">&#39;NPOL&#39;</span><span class="p">,</span> <span class="s1">&#39;BEAM&#39;</span><span class="p">,</span> <span class="s1">&#39;DATE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;ELAPSED&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;DEC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SHIFT_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;SHIFT_DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;OFS_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;OFS_DEC&#39;</span><span class="p">,</span>
        <span class="s1">&#39;AZ&#39;</span><span class="p">,</span> <span class="s1">&#39;EL&#39;</span><span class="p">,</span> <span class="s1">&#39;NCHAN&#39;</span><span class="p">,</span> <span class="s1">&#39;TSYS&#39;</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;ANTENNA&#39;</span><span class="p">,</span>
        <span class="s1">&#39;SRCTYPE&#39;</span><span class="p">,</span> <span class="s1">&#39;FIELD_ID&#39;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">TD_DESC_RO</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">__tabledescrw</span><span class="p">():</span>
    <span class="n">TD_DESC_RW</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Statistics&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Flgas&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Permanent flags&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Actual flag&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Number of mask regions&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;List of mask ranges&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Unchanged row or not&#39;</span><span class="p">),</span>
        <span class="n">__coldesc</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Position group id&#39;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span>
        <span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">,</span> <span class="s1">&#39;NMASK&#39;</span><span class="p">,</span> <span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="s1">&#39;NOCHANGE&#39;</span><span class="p">,</span>
        <span class="s1">&#39;POSGRP&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">TD_DESC_RW</span><span class="p">))</span>


<span class="n">TABLEDESC_RO</span> <span class="o">=</span> <span class="n">__tabledescro</span><span class="p">()</span>
<span class="n">TABLEDESC_RW</span> <span class="o">=</span> <span class="n">__tabledescrw</span><span class="p">()</span>


<div class="viewcode-block" id="create_table">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.create_table.html#pipeline.domain.create_table">[docs]</a>
<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">memtype</span><span class="o">=</span><span class="s1">&#39;plain&#39;</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">memtype</span><span class="o">=</span><span class="n">memtype</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">nrow</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">_colname</span><span class="p">,</span> <span class="n">_coldesc</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;keywords&#39;</span> <span class="ow">in</span> <span class="n">_coldesc</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">putcolkeywords</span><span class="p">(</span><span class="n">_colname</span><span class="p">,</span> <span class="n">_coldesc</span><span class="p">[</span><span class="s1">&#39;keywords&#39;</span><span class="p">])</span></div>



<span class="c1"># FLAG_PERMANENT Layout</span>
<span class="n">WeatherFlagIndex</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">TsysFlagIndex</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">UserFlagIndex</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">OnlineFlagIndex</span> <span class="o">=</span> <span class="mi">3</span>


<div class="viewcode-block" id="timetable_key">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.timetable_key.html#pipeline.domain.timetable_key">[docs]</a>
<span class="k">def</span> <span class="nf">timetable_key</span><span class="p">(</span><span class="n">table_type</span><span class="p">,</span> <span class="n">antenna</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">polarization</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;TIMETABLE_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">table_type</span>
    <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">field_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_FIELD</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field_id</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_ANT</span><span class="si">%s</span><span class="s1">_SPW</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">polarization</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;_POL</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">polarization</span>
    <span class="k">return</span> <span class="n">key</span></div>



<div class="viewcode-block" id="DataTableIndexer">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableIndexer.html#pipeline.domain.DataTableIndexer">[docs]</a>
<span class="k">class</span> <span class="nc">DataTableIndexer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map between serial indices and per-MS row indices.</span>

<span class="sd">    DataTableIndexer is responsible for mapping between classical</span>
<span class="sd">    (serial) row indices (unique row IDs throughout all origin MSes)</span>
<span class="sd">    and per-MS row indices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">origin_mses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__origin_mses</span>

    <span class="nd">@origin_mses</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">origin_mses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set an attribute, origin_ms.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__origin_mses</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize DataTable Indexer class.</span>

<span class="sd">        Args:</span>
<span class="sd">            context: Pipeline context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_mses</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span>
                            <span class="k">if</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">origin_ms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_mses</span><span class="p">:</span>
            <span class="n">ro_table_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">ms_datatable_name</span><span class="p">,</span> <span class="n">origin_ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ro_table_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_mses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">)</span>

<div class="viewcode-block" id="DataTableIndexer.serial2perms">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableIndexer.html#pipeline.domain.DataTableIndexer.serial2perms">[docs]</a>
    <span class="k">def</span> <span class="nf">serial2perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return basename of origin MS and per-MS row id of a given serial index.</span>

<span class="sd">        Args:</span>
<span class="sd">            i: serial index</span>

<span class="sd">        Returns:</span>
<span class="sd">            The basename of origin MS and the row index of the datatable for</span>
<span class="sd">            that MS corresponding to a given serial index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_mses</span><span class="p">):</span>
            <span class="n">past_base</span> <span class="o">=</span> <span class="n">base</span>
            <span class="n">base</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">base</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_mses</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">past_base</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Internal Consistency Error. &#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataTableIndexer.perms2serial">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableIndexer.html#pipeline.domain.DataTableIndexer.perms2serial">[docs]</a>
    <span class="k">def</span> <span class="nf">perms2serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return serial index.</span>

<span class="sd">        Args:</span>
<span class="sd">            vis: Name of an MS</span>
<span class="sd">            i: per-MS DataTable row index</span>

<span class="sd">        Returns:</span>
<span class="sd">            A specified index in serial mode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_mses</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_mses</span>
        <span class="k">assert</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>

        <span class="n">base</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">[:</span><span class="n">j</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span></div>


    <span class="k">def</span> <span class="nf">per_ms_index_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">index_list</span><span class="p">):</span>
        <span class="n">origin_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_mses</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">[:</span><span class="n">j</span><span class="p">])</span>
        <span class="n">length</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow_per_ms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">perms_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">index_list</span> <span class="o">&gt;=</span> <span class="n">base</span><span class="p">,</span>
                                             <span class="n">index_list</span> <span class="o">&lt;</span> <span class="n">base</span> <span class="o">+</span> <span class="n">length</span><span class="p">),</span> <span class="n">index_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">perms_list</span> <span class="o">-</span> <span class="n">base</span></div>



<div class="viewcode-block" id="DataTableImpl">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl">[docs]</a>
<span class="k">class</span> <span class="nc">DataTableImpl</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataTable is an object to hold meta data of scantable on memory.</span>

<span class="sd">    row layout: [Row, Scan, IF, Pol, Beam, Date, Time, ElapsedTime,</span>
<span class="sd">                   0,    1,  2,   3,    4,    5,    6,            7,</span>
<span class="sd">                 Exptime, RA, DEC, Az, El, nchan, Tsys, TargetName,</span>
<span class="sd">                       8,  9,  10, 11, 12,    13,   14,         15,</span>
<span class="sd">                 Statistics, Flags, PermanentFlags, SummaryFlag, Nmask, MaskList, NoChange, Ant]</span>
<span class="sd">                         16,    17,             18,          19,    20,       21,       22,  23</span>
<span class="sd">    Statistics: DataTable[ID][16] =</span>
<span class="sd">                [LowFreqRMS, NewRMS, OldRMS, NewRMSdiff, OldRMSdiff, ExpectedRMS, ExpectedRMS]</span>
<span class="sd">                          0,      1,      2,          3,          4,           5,           6</span>
<span class="sd">    Flags: DataTable[ID][17] =</span>
<span class="sd">                [LowFrRMSFlag, PostFitRMSFlag, PreFitRMSFlag, PostFitRMSdiff, PreFitRMSdiff, PostFitExpRMSFlag, PreFitExpRMSFlag]</span>
<span class="sd">                            0,              1,             2,              3,             4,                 5,                6</span>
<span class="sd">    PermanentFlags: DataTable[ID][18] =</span>
<span class="sd">                [WeatherFlag, TsysFlag, UserFlag]</span>
<span class="sd">                           0,        1,        2</span>
<span class="sd">    Note for Flags: 1 is valid, 0 is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_rotable_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">datatable_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datatable_name</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_rwtable_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">datatable_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datatable_name</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">)</span>

    <span class="n">REFKEY</span> <span class="o">=</span> <span class="s1">&#39;DIRECTION_REF&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name (optional) -- name of DataTable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># unique memory table name</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memtable1</span> <span class="o">=</span> <span class="s1">&#39;DataTableImplRO</span><span class="si">%s</span><span class="s1">.MemoryTable&#39;</span> <span class="o">%</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memtable2</span> <span class="o">=</span> <span class="s1">&#39;DataTableImplRW</span><span class="si">%s</span><span class="s1">.MemoryTable&#39;</span> <span class="o">%</span> <span class="n">timestamp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># New table class instances are required to avoid accidental closure of</span>
        <span class="c1"># the global table tool instance, casa_tools.table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">_logging_table_cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">_logging_table_cls</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">readonly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">readonly</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">readonly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">readonly</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">readonly</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">readonly</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">importdata2</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make sure that table is closed</span>
        <span class="c1"># LOG.debug(&#39;__del__ close CASA table...&#39;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nrow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">position_group_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;POSGRP_REP&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">haskeyword</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_group_id_small</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_time_group_id</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_group_id_large</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_time_group_id</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">REFKEY</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REFKEY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@direction_ref</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">direction_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># value must be string</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="c1"># set value only if it is not yet registered to table</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">REFKEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">putkeyword</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">REFKEY</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_time_group_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">small</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">small</span><span class="p">:</span>
            <span class="n">subkey</span> <span class="o">=</span> <span class="s1">&#39;SMALL&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subkey</span> <span class="o">=</span> <span class="s1">&#39;LARGE&#39;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^TIMETABLE_</span><span class="si">%s</span><span class="s1">_.*&#39;</span> <span class="o">%</span> <span class="n">subkey</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">()),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)):</span>
            <span class="n">group_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">max_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="n">key</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">group_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">group_id</span><span class="p">,</span> <span class="n">max_id</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">group_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">haskeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">addrows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nrow</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">addrows</span><span class="p">(</span><span class="n">nrow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">addrows</span><span class="p">(</span><span class="n">nrow</span><span class="p">)</span>

        <span class="c1"># reset self.plaintable since memory table and corresponding</span>
        <span class="c1"># plain table have different nrows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">getcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

<div class="viewcode-block" id="DataTableImpl.putcell">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.putcell">[docs]</a>
    <span class="k">def</span> <span class="nf">putcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- column name</span>
<span class="sd">        idx -- row index</span>
<span class="sd">        val -- value to be put</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">getcolslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">getcolslice</span><span class="p">(</span><span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcolslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">putcolslice</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcellslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">getcellslice</span><span class="p">(</span><span class="n">rownr</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcellslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">putcellslice</span><span class="p">(</span><span class="n">rownr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcolkeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columnname</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">columnname</span> <span class="ow">in</span> <span class="n">TABLEDESC_RO</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="n">columnname</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="n">columnname</span><span class="p">,</span> <span class="n">keyword</span><span class="p">)</span>

<div class="viewcode-block" id="DataTableImpl.putkeyword">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.putkeyword">[docs]</a>
    <span class="k">def</span> <span class="nf">putkeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- keyword name</span>
<span class="sd">        val -- keyword value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_val</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">putkeyword</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_val</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataTableImpl.getkeyword">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.getkeyword">[docs]</a>
    <span class="k">def</span> <span class="nf">getkeyword</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- keyword name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span></div>


<div class="viewcode-block" id="DataTableImpl.keywordnames">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.keywordnames">[docs]</a>
    <span class="k">def</span> <span class="nf">keywordnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        return table keyword names</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataTableImpl.importdata">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.importdata">[docs]</a>
    <span class="k">def</span> <span class="nf">importdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- name of DataTable to be imported</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Importing DataTable from </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># copy input table to memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyfrom</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_cols</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataTableImpl.importdata2">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.importdata2">[docs]</a>
    <span class="k">def</span> <span class="nf">importdata2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- name of DataTable to be imported</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Importing DataTable from </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># copy input table to memory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copyfrom2</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_cols</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataTableImpl.sync">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.sync">[docs]</a>
    <span class="k">def</span> <span class="nf">sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sync with DataTable on disk.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">importdata</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="n">minimal</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataTableImpl.exportdata">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.exportdata">[docs]</a>
    <span class="k">def</span> <span class="nf">exportdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        name -- name of exported DataTable</span>
<span class="sd">        overwrite -- overwrite existing DataTable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;You have to specify name of export table&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Exporting DataTable to </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="c1"># overwrite check</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">abspath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">abspath</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Overwrite existing DataTable </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="c1"># os.system( &#39;rm -rf %s/*&#39;%(abspath) )</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;The file </span><span class="si">%s</span><span class="s1"> exists.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># save</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">)):</span>
            <span class="c1"># LOG.trace(&#39;Exporting RO table&#39;)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">name</span><span class="p">()):</span>
                <span class="c1"># self.tb1 seems to be plain table, nothing to be done</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># tb1 is memory table</span>
                <span class="n">tbloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">),</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tbloc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># LOG.trace(&#39;Exporting RW table&#39;)</span>
        <span class="n">tbloc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">abspath</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">),</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tbloc</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span> <span class="o">=</span> <span class="n">abspath</span></div>


    <span class="c1"># FIXME: this unused method contains bugs to fix.</span>
<div class="viewcode-block" id="DataTableImpl.export_rwtable_exclusive">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableImpl.html#pipeline.domain.DataTableImpl.export_rwtable_exclusive">[docs]</a>
    <span class="k">def</span> <span class="nf">export_rwtable_exclusive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dirty_rows</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export &quot;on-memory&quot; RW table to the one on disk.</span>

<span class="sd">        To support parallel operation, the method will acquire a lock for RW table</span>
<span class="sd">        to ensure the operation in one process doesn&#39;t overwrite the changes made by</span>
<span class="sd">        other processes.</span>

<span class="sd">        dirty_rows -- list of row numbers that are updated. If None, everything</span>
<span class="sd">                      including unchanged rows will be flushed. Default is None.</span>
<span class="sd">        cols -- list of columns that are updated. If None, all rows will be flushed.</span>
<span class="sd">                default is None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># RW table name</span>
        <span class="n">rwtable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rwtable_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span><span class="p">)</span>

        <span class="c1"># list of ordinary columns</span>
        <span class="n">ordinary_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">,</span> <span class="s1">&#39;NMASK&#39;</span><span class="p">,</span> <span class="s1">&#39;POSGRP&#39;</span><span class="p">}</span>
        <span class="n">intersects</span> <span class="o">=</span> <span class="n">ordinary_cols</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>

        <span class="c1"># columns with special care</span>
        <span class="n">with_masklist</span> <span class="o">=</span> <span class="s1">&#39;MASKLIST&#39;</span> <span class="ow">in</span> <span class="n">cols</span>
        <span class="n">with_nochange</span> <span class="o">=</span> <span class="s1">&#39;NOCHANGE&#39;</span> <span class="ow">in</span> <span class="n">cols</span>

        <span class="c1"># open table</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">rwtable</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">lockoptions</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;option&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">})</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="c1"># lock table</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">lock</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process </span><span class="si">{0}</span><span class="s1"> have acquired a lock for RW table&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

            <span class="k">if</span> <span class="n">dirty_rows</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># process all rows</span>
                <span class="c1"># FIXME: built-in range (or list) does not support .min(), .max(); should this be a numpy range?</span>
                <span class="n">dirty_rows</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">nrow_chunk</span> <span class="o">=</span> <span class="mi">2000</span>
                <span class="c1"># compute number of chunks</span>
                <span class="n">nrow</span> <span class="o">=</span> <span class="n">dirty_rows</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">dirty_rows</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">nchunk</span> <span class="o">=</span> <span class="n">nrow</span> <span class="o">//</span> <span class="n">nrow_chunk</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">nrow</span> <span class="o">%</span> <span class="n">nrow_chunk</span>
                <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">nrow_chunk</span><span class="p">]</span> <span class="o">*</span> <span class="n">nchunk</span> <span class="o">+</span> <span class="p">[</span><span class="n">mod</span><span class="p">]</span>
                <span class="c1"># LOG.info(&#39;chunks={0} (nrow {1})&#39;.format(chunks, nrow))</span>
                <span class="c1"># for each column</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">intersects</span><span class="p">:</span>
                    <span class="n">start_row</span> <span class="o">=</span> <span class="n">dirty_rows</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">size_chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                        <span class="c1"># LOG.info(&#39;start_row {0}, size_chunk {1}&#39;.format(start_row, size_chunk))</span>
                        <span class="c1"># read chunk</span>
                        <span class="n">chunk_src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">start_row</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">size_chunk</span><span class="p">)</span>
                        <span class="n">chunk_dst</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">start_row</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">size_chunk</span><span class="p">)</span>

                        <span class="c1"># update chunk</span>
                        <span class="n">chunk_min</span> <span class="o">=</span> <span class="n">start_row</span>
                        <span class="n">chunk_max</span> <span class="o">=</span> <span class="n">start_row</span> <span class="o">+</span> <span class="n">size_chunk</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">target_rows</span> <span class="o">=</span> <span class="n">dirty_rows</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">chunk_min</span> <span class="o">&lt;=</span> <span class="n">dirty_rows</span><span class="p">,</span>
                                                                <span class="n">dirty_rows</span> <span class="o">&lt;=</span> <span class="n">chunk_max</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">target_rows</span><span class="p">:</span>
                            <span class="n">chunk_index</span> <span class="o">=</span> <span class="n">row</span> <span class="o">-</span> <span class="n">start_row</span>
                            <span class="c1"># LOG.info(&#39;row {0}, chunk_index {1}&#39;.format(row, chunk_index))</span>
                            <span class="n">chunk_dst</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">chunk_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk_src</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">chunk_index</span><span class="p">]</span>

                        <span class="c1"># flush chunk</span>
                        <span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">chunk_dst</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">start_row</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="n">size_chunk</span><span class="p">)</span>

                        <span class="c1"># increment start_row</span>
                        <span class="n">start_row</span> <span class="o">+=</span> <span class="n">size_chunk</span>

                <span class="c1"># merge MASKLIST if necessary</span>
                <span class="k">if</span> <span class="n">with_masklist</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">]</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">DataTableColumnMaskList</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dirty_rows</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">with_nochange</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">src</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;NOCHANGE&#39;</span><span class="p">]</span>
                    <span class="n">dst</span> <span class="o">=</span> <span class="n">DataTableColumnNoChange</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dirty_rows</span><span class="p">):</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                        <span class="n">dst</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># the table lock must eventually be released</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Process </span><span class="si">{0}</span><span class="s1"> is going to release a lock for RW table&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>
                <span class="n">tb</span><span class="o">.</span><span class="n">unlock</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
        <span class="n">create_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memtable1</span><span class="p">,</span> <span class="n">TABLEDESC_RO</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="n">create_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">memtable2</span><span class="p">,</span> <span class="n">TABLEDESC_RW</span><span class="p">,</span> <span class="s1">&#39;memory&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__init_cols</span><span class="p">(</span><span class="n">readonly</span><span class="o">=</span><span class="n">readonly</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init_cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
            <span class="n">RO_COLUMN</span> <span class="o">=</span> <span class="n">RODataTableColumn</span>
            <span class="n">RW_COLUMN</span> <span class="o">=</span> <span class="n">RWDataTableColumn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RO_COLUMN</span> <span class="o">=</span> <span class="n">RWDataTableColumn</span>
            <span class="n">RW_COLUMN</span> <span class="o">=</span> <span class="n">RWDataTableColumn</span>
        <span class="n">type_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;integer&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="s1">&#39;double&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                    <span class="s1">&#39;string&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">}</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">desc</span><span class="p">:</span> <span class="nb">list</span> <span class="k">if</span> <span class="s1">&#39;ndim&#39;</span> <span class="ow">in</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">desc</span><span class="p">[</span><span class="s1">&#39;ndim&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">type_map</span><span class="p">[</span><span class="n">desc</span><span class="p">[</span><span class="s1">&#39;valueType&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TABLEDESC_RO</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">RO_COLUMN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">datatype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">TABLEDESC_RW</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;MASKLIST&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataTableColumnMaskList</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;NOCHANGE&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataTableColumnNoChange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">RW_COLUMN</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">datatype</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_copyfrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">or</span> <span class="n">abspath</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memtable1</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memorytable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memtable2</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memorytable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_copyfrom2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">minimal</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close</span><span class="p">()</span>
        <span class="n">abspath</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">minimal</span> <span class="ow">or</span> <span class="n">abspath</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plaintable</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;RO&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memtable1</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memorytable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;RW&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memtable2</span><span class="p">,</span> <span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">valuecopy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">memorytable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">returnobject</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isopened</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">get_posdict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">):</span>
        <span class="n">posgrp_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;POSGRP_LIST&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mygrp</span> <span class="o">=</span> <span class="n">posgrp_list</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ant</span><span class="p">)][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)][</span><span class="nb">str</span><span class="p">(</span><span class="n">pol</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1"> not in reduction group list&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>

        <span class="n">posgrp_rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;POSGRP_REP&#39;</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">)</span>
        <span class="n">posgrp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;POSGRP&#39;</span><span class="p">)</span>
        <span class="n">posdict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">posgrp_rep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mygrp</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">posdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posgrp</span><span class="p">)):</span>
            <span class="n">grp</span> <span class="o">=</span> <span class="n">posgrp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">grp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mygrp</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">rep</span> <span class="o">=</span> <span class="n">posgrp_rep</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">grp</span><span class="p">)]</span>
            <span class="n">key</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">rep</span><span class="p">]</span>
            <span class="n">posdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">posdict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">posdict</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">],</span> <span class="p">[</span><span class="n">rep</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">posdict</span>

    <span class="k">def</span> <span class="nf">set_timetable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">mygrp</span><span class="p">,</span> <span class="n">timegrp_s</span><span class="p">,</span> <span class="n">timegrp_l</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># time table format</span>
        <span class="c1"># TimeTable: [TimeTableSmallGap, TimeTableLargeGap]</span>
        <span class="c1"># TimeTableXXXGap: [[[row0, row1, ...], [idx0, idx1, ...]], ...]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set_timetable start&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">mygrp_s</span> <span class="o">=</span> <span class="n">mygrp</span><span class="p">[</span><span class="s1">&#39;small&#39;</span><span class="p">]</span>
        <span class="n">mygrp_l</span> <span class="o">=</span> <span class="n">mygrp</span><span class="p">[</span><span class="s1">&#39;large&#39;</span><span class="p">]</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">)</span>

        <span class="n">timedic_s</span> <span class="o">=</span> <span class="n">construct_timegroup</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">mygrp_s</span><span class="p">),</span> <span class="n">timegrp_s</span><span class="p">)</span>
        <span class="n">timedic_l</span> <span class="o">=</span> <span class="n">construct_timegroup</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">mygrp_l</span><span class="p">),</span> <span class="n">timegrp_l</span><span class="p">)</span>
        <span class="n">timetable_s</span> <span class="o">=</span> <span class="p">[</span><span class="n">timedic_s</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mygrp_s</span><span class="p">]</span>
        <span class="n">timetable_l</span> <span class="o">=</span> <span class="p">[</span><span class="n">timedic_l</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mygrp_l</span><span class="p">]</span>
        <span class="n">timetable</span> <span class="o">=</span> <span class="p">[</span><span class="n">timetable_s</span><span class="p">,</span> <span class="n">timetable_l</span><span class="p">]</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;construct timetable: Elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;timetable=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">timetable</span><span class="p">)</span>

        <span class="c1"># put time table to table keyword</span>
        <span class="n">start_time2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">key_small</span> <span class="o">=</span> <span class="n">timetable_key</span><span class="p">(</span><span class="s1">&#39;SMALL&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">field_id</span><span class="p">)</span>
        <span class="n">key_large</span> <span class="o">=</span> <span class="n">timetable_key</span><span class="p">(</span><span class="s1">&#39;LARGE&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">field_id</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;add time table: keys for small gap </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> large gap </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_small</span><span class="p">,</span> <span class="n">key_large</span><span class="p">))</span>
        <span class="n">dictify</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">dict</span><span class="p">([(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">key_small</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">or</span> <span class="n">key_large</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putkeyword</span><span class="p">(</span><span class="n">key_small</span><span class="p">,</span> <span class="n">dictify</span><span class="p">(</span><span class="n">timetable</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putkeyword</span><span class="p">(</span><span class="n">key_large</span><span class="p">,</span> <span class="n">dictify</span><span class="p">(</span><span class="n">timetable</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;put timetable: Elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time2</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;set get_timetable end: Elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_timetable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;new get_timetable start&#39;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">key_small</span> <span class="o">=</span> <span class="n">timetable_key</span><span class="p">(</span><span class="s1">&#39;SMALL&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">field_id</span><span class="p">)</span>
        <span class="n">key_large</span> <span class="o">=</span> <span class="n">timetable_key</span><span class="p">(</span><span class="s1">&#39;LARGE&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">field_id</span><span class="p">)</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">keywordnames</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get time table: keys for small gap </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> large gap </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_small</span><span class="p">,</span> <span class="n">key_large</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key_small</span> <span class="ow">in</span> <span class="n">keys</span> <span class="ow">and</span> <span class="n">key_large</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">ttdict_small</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="n">key_small</span><span class="p">)</span>
            <span class="n">ttdict_large</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="n">key_large</span><span class="p">)</span>
            <span class="n">timetable_small</span> <span class="o">=</span> <span class="p">[</span><span class="n">ttdict_small</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ttdict_small</span><span class="p">))]</span>
            <span class="n">timetable_large</span> <span class="o">=</span> <span class="p">[</span><span class="n">ttdict_large</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ttdict_large</span><span class="p">))]</span>
            <span class="n">timetable</span> <span class="o">=</span> <span class="p">[</span><span class="n">timetable_small</span><span class="p">,</span> <span class="n">timetable_large</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;time table for Antenna </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1"> is not configured properly&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;new get_timetable end: Elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">timetable</span>

    <span class="k">def</span> <span class="nf">get_timegap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">asrow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">timegap_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;TIMEGAP_S&#39;</span><span class="p">)</span>
        <span class="n">timegap_l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;TIMEGAP_L&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mygap_s</span> <span class="o">=</span> <span class="n">timegap_s</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span>
                <span class="n">mygap_l</span> <span class="o">=</span> <span class="n">timegap_l</span><span class="p">[</span><span class="n">ant</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1"> not in reduction group list&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mygap_s</span> <span class="o">=</span> <span class="n">timegap_s</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)][</span><span class="n">ant</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="n">field_id</span><span class="p">]</span>
                <span class="n">mygap_l</span> <span class="o">=</span> <span class="n">timegap_l</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)][</span><span class="n">ant</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="n">field_id</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="s1">&#39;ms </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> not in reduction group list&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">field_id</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">if</span> <span class="n">asrow</span><span class="p">:</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">)</span>
            <span class="n">timegap</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">[]]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mygap_s</span><span class="p">:</span>
                <span class="n">timegap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">mygap_l</span><span class="p">:</span>
                <span class="n">timegap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timegap</span> <span class="o">=</span> <span class="p">[</span><span class="n">mygap_s</span><span class="p">,</span> <span class="n">mygap_l</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">timegap</span>

    <span class="k">def</span> <span class="nf">_update_tsys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">infile</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwmap</span><span class="p">,</span> <span class="n">to_fieldid</span><span class="p">,</span> <span class="n">gainfield</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transfer Tsys values in a Tsys calibration table and fill Tsys</span>
<span class="sd">        values in DataTable.</span>
<span class="sd">        Tsys in cal table are averaged by channels taking into account</span>
<span class="sd">        of FLAG and linearly interpolated in time to derive values which</span>
<span class="sd">        corresponds to TIME in DataTable.</span>

<span class="sd">        Arguments</span>
<span class="sd">            context: pipeline context</span>
<span class="sd">            infile: the name of input MS</span>
<span class="sd">            tsystable: the name of Tsys calibration table</span>
<span class="sd">            spwmap: the list of SPW mapping</span>
<span class="sd">            to_fieldid: FIELD_ID of data table to which Tsys is transferred</span>
<span class="sd">            gainfield: how to find FIELD form which Tsys is extracted in cal table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">msobj</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">to_antids</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">msobj</span><span class="o">.</span><span class="n">antennas</span><span class="p">]</span>
        <span class="n">from_fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">gainfield</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;NEAREST&#39;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;to_fieldid=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_fieldid</span><span class="p">))</span>
            <span class="n">to_field</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">to_fieldid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;ATMOSPHERE&#39;</span> <span class="ow">in</span> <span class="n">to_field</span><span class="o">.</span><span class="n">intents</span><span class="p">:</span>
                <span class="c1"># if target field has ATMOSPHERE intent, use it</span>
                <span class="n">from_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">to_fieldid</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atm_fields</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">)</span>
                <span class="c1"># absolute OFF</span>
                <span class="n">test_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_OFF_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_field</span><span class="o">.</span><span class="n">clean_name</span><span class="p">)</span>
                <span class="c1">#LOG.info(&#39;test_prefix {}, atm_fields {}&#39;.format(test_prefix, [a.clean_name for a in atm_fields]))</span>
                <span class="n">nearest_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">clean_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">test_prefix</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">atm_fields</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#LOG.info(&#39;nearest_id = {}&#39;.format(nearest_id))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nearest_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">from_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">atm_fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nearest_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># more generic case that requires to search nearest field by separation</span>
                    <span class="n">rmin</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">180.0</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span>
                    <span class="n">origin</span> <span class="o">=</span> <span class="n">to_field</span><span class="o">.</span><span class="n">mdirection</span>
                    <span class="n">nearest_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">atm_fields</span><span class="p">:</span>
                        <span class="n">r</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">mdirection</span><span class="p">)</span>
                        <span class="c1">#LOG.info(&#39;before test: rmin {} r {} nearest_id {}&#39;.format(rmin[&#39;value&#39;], r[&#39;value&#39;], nearest_id))</span>
                        <span class="c1"># quanta.le is equivalent to &lt;=</span>
                        <span class="k">if</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rmin</span><span class="p">):</span>
                            <span class="n">rmin</span> <span class="o">=</span> <span class="n">r</span>
                            <span class="n">nearest_id</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span>
                        <span class="c1">#LOG.info(&#39;after test: rmin {} r {} nearest_id {}&#39;.format(rmin[&#39;value&#39;], r[&#39;value&#39;], nearest_id))</span>
                    <span class="k">if</span> <span class="n">nearest_id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">from_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">nearest_id</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No nearest field for Tsys update.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">from_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">gainfield</span><span class="p">)]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;from_fields = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">from_fields</span><span class="p">))</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">tsystable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">tsel</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;FIELD_ID IN </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">from_fields</span><span class="p">)))</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="c1">#fieldids = tsel.getcol(&#39;FIELD_ID&#39;)</span>
            <span class="n">antids</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
            <span class="n">tsys_masked</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tsel</span><span class="o">.</span><span class="n">nrows</span><span class="p">()):</span>
                <span class="n">tsys</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FPARAM&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">tsys_masked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">tsys</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">flag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">))</span>
            <span class="n">tsel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1">#LOG.info(&#39;tsys={}&#39;.format(tsys_masked))</span>

        <span class="k">def</span> <span class="nf">map_spwchans</span><span class="p">(</span><span class="n">atm_spw</span><span class="p">,</span> <span class="n">science_spw</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Map the channel ID ranges of ATMCal spw that covers frequency range of a science spw</span>
<span class="sd">            Arguments: spw object of ATMCal and science spws</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">atm_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atm_spw</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_freqs</span><span class="p">)</span>
            <span class="n">min_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">atm_freqs</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">atm_freqs</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">))))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">max_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">atm_freqs</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="nb">min</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">atm_freqs</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">science_spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">))))[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">start_atmchan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_chan</span><span class="p">,</span> <span class="n">max_chan</span><span class="p">)</span>
            <span class="n">end_atmchan</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_chan</span><span class="p">,</span> <span class="n">max_chan</span><span class="p">)</span>
            <span class="c1"># LOG.trace(&#39;calculate_average_tsys:   satrt_atmchan == %d&#39; % start_atmchan)</span>
            <span class="c1"># LOG.trace(&#39;calculate_average_tsys:   end_atmchan == %d&#39; % end_atmchan)</span>
            <span class="k">if</span> <span class="n">end_atmchan</span> <span class="o">==</span> <span class="n">start_atmchan</span><span class="p">:</span>
                <span class="n">end_atmchan</span> <span class="o">=</span> <span class="n">start_atmchan</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">start_atmchan</span><span class="p">,</span> <span class="n">end_atmchan</span>

        <span class="n">_dt_antenna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA&#39;</span><span class="p">)</span>
        <span class="n">_dt_spw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;IF&#39;</span><span class="p">)</span>
        <span class="n">dt_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FIELD_ID&#39;</span><span class="p">)</span>
        <span class="n">field_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dt_field</span> <span class="o">==</span> <span class="n">to_fieldid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dt_antenna</span> <span class="o">=</span> <span class="n">_dt_antenna</span><span class="p">[</span><span class="n">field_sel</span><span class="p">]</span>
        <span class="n">dt_spw</span> <span class="o">=</span> <span class="n">_dt_spw</span><span class="p">[</span><span class="n">field_sel</span><span class="p">]</span>
        <span class="n">atm_spws</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span>
        <span class="n">science_spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">spw_to</span><span class="p">,</span> <span class="n">spw_from</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spwmap</span><span class="p">):</span>
            <span class="c1"># only process atm spws</span>
            <span class="k">if</span> <span class="n">spw_from</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atm_spws</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># only process science spws</span>
            <span class="k">if</span> <span class="n">spw_to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">atm_spw</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spw_from</span><span class="p">)</span>
            <span class="n">science_spw</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spw_to</span><span class="p">)</span>
            <span class="n">science_dd</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">science_spw</span><span class="p">)</span>
            <span class="n">corr_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">science_dd</span><span class="o">.</span><span class="n">get_polarization_id</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="k">for</span> <span class="n">corr</span> <span class="ow">in</span> <span class="n">science_dd</span><span class="o">.</span><span class="n">corr_axis</span><span class="p">]</span>
            <span class="n">start_atmchan</span><span class="p">,</span> <span class="n">end_atmchan</span> <span class="o">=</span> <span class="n">map_spwchans</span><span class="p">(</span><span class="n">atm_spw</span><span class="p">,</span> <span class="n">science_spw</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Transfer Tsys from spw </span><span class="si">{}</span><span class="s1"> (chans: </span><span class="si">{}</span><span class="s1">~</span><span class="si">{}</span><span class="s1">) to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spw_from</span><span class="p">,</span> <span class="n">start_atmchan</span><span class="p">,</span> <span class="n">end_atmchan</span><span class="p">,</span> <span class="n">spw_to</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">ant_to</span> <span class="ow">in</span> <span class="n">to_antids</span><span class="p">:</span>
                <span class="c1"># select caltable row id by SPW and ANT</span>
                <span class="n">cal_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">spws</span> <span class="o">==</span> <span class="n">spw_from</span><span class="p">,</span> <span class="n">antids</span> <span class="o">==</span> <span class="n">ant_to</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cal_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># atsys.shape = (nrow, npol)</span>
                <span class="n">atsys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">tsys_masked</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">corr_index</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:,</span> <span class="n">start_atmchan</span><span class="p">:</span><span class="n">end_atmchan</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cal_idxs</span><span class="p">])</span>
                <span class="n">dtrows</span> <span class="o">=</span> <span class="n">field_sel</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">dt_antenna</span> <span class="o">==</span> <span class="n">ant_to</span><span class="p">,</span> <span class="n">dt_spw</span> <span class="o">==</span> <span class="n">spw_to</span><span class="p">))[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="c1">#LOG.info(&#39;ant {} spw {} dtrows {}&#39;.format(ant_to, spw_to, len(dtrows)))</span>
                <span class="n">time_sel</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">cal_idxs</span><span class="p">)</span>  <span class="c1"># in sec</span>
                <span class="k">for</span> <span class="n">dt_id</span> <span class="ow">in</span> <span class="n">dtrows</span><span class="p">:</span>
                    <span class="c1">#LOG.info(&#39;ant {} spw {} field {}&#39;.format(self.getcell(&#39;ANTENNA&#39;, dt_id),</span>
                    <span class="c1">#                                         self.getcell(&#39;IF&#39;, dt_id),</span>
                    <span class="c1">#                                         self.getcell(&#39;FIELD_ID&#39;, dt_id)))</span>
                    <span class="n">tref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86400</span>  <span class="c1"># day-&gt;sec</span>
                    <span class="c1"># LOG.trace(&quot;cal_field_ids=%s&quot; % cal_field_idxs)</span>
                    <span class="c1"># LOG.trace(&#39;atsys = %s&#39; % str(atsys))</span>
                    <span class="k">if</span> <span class="n">atsys</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># only one Tsys measurement selected</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;TSYS&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">,</span> <span class="n">atsys</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">itsys</span> <span class="o">=</span> <span class="n">_interpolate</span><span class="p">(</span><span class="n">atsys</span><span class="p">,</span> <span class="n">time_sel</span><span class="p">,</span> <span class="n">tref</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;TSYS&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">,</span> <span class="n">itsys</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;_update_tsys: elapsed </span><span class="si">{}</span><span class="s1"> sec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>

    <span class="c1"># @memory_profiler.profile</span>
    <span class="k">def</span> <span class="nf">_update_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read MS and update online flag status of DataTable.</span>
<span class="sd">        Arguments:</span>
<span class="sd">            context: pipeline context instance</span>
<span class="sd">            infile: the name of MS to transfer flag from</span>
<span class="sd">        NOTE this method should be called before applying the other flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating online flag for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">infile</span><span class="p">)))</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;FILENAME&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># back to previous impl. with reduced memory usage</span>
        <span class="c1"># (performance degraded)</span>
        <span class="n">ms_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">)</span>
        <span class="n">tmp_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="c1"># for dt_row in index[0]:</span>
            <span class="k">for</span> <span class="n">dt_row</span><span class="p">,</span> <span class="n">ms_row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ms_rows</span><span class="p">):</span>
                <span class="c1"># ms_row = rows[dt_row]</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ms_row</span><span class="p">)</span>
                <span class="n">rowflag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_ROW&#39;</span><span class="p">,</span> <span class="n">ms_row</span><span class="p">)</span>
                <span class="c1"># irow += 1</span>
                <span class="n">npol</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1">#online_flag = np.empty((npol, 1,), dtype=np.int32)</span>
                <span class="n">online_flag</span> <span class="o">=</span> <span class="n">tmp_array</span><span class="p">[:</span><span class="n">npol</span><span class="p">,</span> <span class="p">:]</span>
                <span class="k">if</span> <span class="n">rowflag</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">online_flag</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
                        <span class="n">online_flag</span><span class="p">[</span><span class="n">ipol</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">flag</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">putcellslice</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">dt_row</span><span class="p">),</span> <span class="n">online_flag</span><span class="p">,</span>
                                  <span class="n">blc</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">OnlineFlagIndex</span><span class="p">],</span> <span class="n">trc</span><span class="o">=</span><span class="p">[</span><span class="n">npol</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">OnlineFlagIndex</span><span class="p">],</span>
                                  <span class="n">incr</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="RODataTableColumn">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.RODataTableColumn.html#pipeline.domain.RODataTableColumn">[docs]</a>
<span class="k">class</span> <span class="nc">RODataTableColumn</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caster_get</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">(&quot;</span><span class="si">%s</span><span class="s1">&quot;,&quot;</span><span class="si">%s</span><span class="s1">&quot;)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">caster_get</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcellslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">getcellslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcolslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">getcolslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">putcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">putcellslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">putcolslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__raise</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__raise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;column </span><span class="si">%s</span><span class="s1"> is read-only&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>



<div class="viewcode-block" id="RWDataTableColumn">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.RWDataTableColumn.html#pipeline.domain.RWDataTableColumn">[docs]</a>
<span class="k">class</span> <span class="nc">RWDataTableColumn</span><span class="p">(</span><span class="n">RODataTableColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RWDataTableColumn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caster_put</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caster_put</span> <span class="o">=</span> <span class="n">dtype</span>

    <span class="k">def</span> <span class="nf">putcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">caster_put</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">putcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">startrow</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">nrow</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rowincr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">putcellslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcellslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rownr</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcolslice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcolslice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">incr</span><span class="p">,</span> <span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataTableColumnNoChange">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableColumnNoChange.html#pipeline.domain.DataTableColumnNoChange">[docs]</a>
<span class="k">class</span> <span class="nc">DataTableColumnNoChange</span><span class="p">(</span><span class="n">RWDataTableColumn</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RWDataTableColumn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;NOCHANGE&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">putcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">))</span></div>



<div class="viewcode-block" id="DataTableColumnMaskList">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableColumnMaskList.html#pipeline.domain.DataTableColumnMaskList">[docs]</a>
<span class="k">class</span> <span class="nc">DataTableColumnMaskList</span><span class="p">(</span><span class="n">RWDataTableColumn</span><span class="p">):</span>
    <span class="n">NoMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># [[-1,-1]]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RWDataTableColumn</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s2">&quot;MASKLIST&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">v</span>

<div class="viewcode-block" id="DataTableColumnMaskList.getcol">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableColumnMaskList.html#pipeline.domain.DataTableColumnMaskList.getcol">[docs]</a>
    <span class="k">def</span> <span class="nf">getcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: returned array has shape (nrow,nmask), in</span>
<span class="sd">              contrast to (nmask,nrow) for return value of</span>
<span class="sd">              tb.getcol().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nrow</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">):</span>
            <span class="n">tMASKLIST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tMASKLIST</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tMASKLIST</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> \
                    <span class="n">tMASKLIST</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ret</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tMASKLIST</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">ret</span></div>


    <span class="k">def</span> <span class="nf">putcell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NoMask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<div class="viewcode-block" id="DataTableColumnMaskList.putcol">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.DataTableColumnMaskList.html#pipeline.domain.DataTableColumnMaskList.putcol">[docs]</a>
    <span class="k">def</span> <span class="nf">putcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowincr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note: input array should have shape (nrow,nmask), in</span>
<span class="sd">              contrast to (nmask,nrow) for tb.putcol()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nrow</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">startrow</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span> <span class="n">rowincr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">startrow</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">rowincr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">val</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span></div>
</div>



<span class="k">def</span> <span class="nf">_interpolate</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">):</span>
    <span class="c1"># bisect.bisect_left(a, x)</span>
    <span class="c1"># bisect_left returns an insertion point of x in a.</span>
    <span class="c1"># if x matches any value in a, bisect_left returns its index.</span>
    <span class="c1"># (bisect_right and bisect returns index next to the matched value)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect_left</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">tref</span><span class="p">)</span>
    <span class="c1">#LOG.info(&#39;len(t) = {}, idx = {}&#39;.format(len(t), idx))</span>
    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">tref</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">tref</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="n">t0</span> <span class="o">+</span> <span class="n">v</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


<div class="viewcode-block" id="construct_timegroup">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.datatable.construct_timegroup.html#pipeline.domain.construct_timegroup">[docs]</a>
<span class="k">def</span> <span class="nf">construct_timegroup</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">group_id_list</span><span class="p">,</span> <span class="n">group_association_list</span><span class="p">):</span>
    <span class="n">timetable_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span> <span class="p">[[],</span> <span class="p">[]]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">group_id_list</span><span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">group_id</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_association_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">group_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_id_list</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">timetable_dict</span><span class="p">[</span><span class="n">group_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">timetable_dict</span><span class="p">[</span><span class="n">group_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timetable_dict</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>