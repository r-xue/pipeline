

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.extern.tsys_contamination &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.extern.tsys_contamination</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.extern.tsys_contamination</h1><div class="highlight"><pre>
<span></span><span class="c1"># 19-04-2023. Version 1.0.</span>
<span class="c1"># 20-04-2023. Version 2.0. Different functions to determine contamination intervals.</span>
<span class="c1"># 30-04-2023. Version 2.1. Correct intent per scan for mosaics. Phasecal intents in Tsys.</span>
<span class="c1"># 02-05-2023. Version 2.2. Decrease puffing. Remove flag for empty spw field. Decrease SNR detection limit for large number of channels to 6 sigma.</span>
<span class="c1"># 03-05-2023. Version 2.3. Fix positive_line_intervals. difference_tolerance_ratio 0.5-&gt;0.67 in find_repeated_peaks. Fix filter atm_residual_intervals.</span>
<span class="c1">#                          1 channel tolerance for telluric identification.</span>
<span class="c1"># 08-05-2023. Version 2.4. Display science spws in Tsys plots and exclude line contamination flagging from regions outside the science spw. Several changes</span>
<span class="c1">#                          to the TsysData objects and other functions.</span>
<span class="c1"># 10-05-2023. Version 3.0. Fix the image sideband ATM model for HF. Fix common_peaks. Fix model_break.</span>
<span class="c1"># 20-05-2023. Version 3.1. Include dt/Tsys criterion (2% default) detection threshold. Change reason string. Improvements to plots and html log.</span>
<span class="c1"># 30-05-2023. Version 3.2. Convex hull on model_break. Fixing model_break.</span>
<span class="c1"># 11-07-2023. Version 3.3. Changes to find_repeated peaks. Filter on prominence over 5. Making the large contamination warning on full spw.</span>
<span class="c1">#                          Channel avoidance in puff.</span>
<span class="c1"># 25-09-2023. Version 3.4. Subtracting a cubic fitting to detect peaks in the bandpass.</span>
<span class="kn">from</span> <span class="nn">..infrastructure.renderer</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">pllogger</span>

<span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;3.5&quot;</span>

<span class="kn">import</span> <span class="nn">bz2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy2</span><span class="p">,</span> <span class="n">copytree</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.transforms</span> <span class="k">as</span> <span class="nn">transforms</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.constants</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">label</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">Bounds</span><span class="p">,</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span><span class="p">,</span> <span class="n">peak_prominences</span><span class="p">,</span> <span class="n">peak_widths</span><span class="p">,</span> <span class="n">savgol_filter</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">legendre</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure.logging</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.pipelineqa</span> <span class="k">as</span> <span class="nn">pipelineqa</span>

<span class="kn">from</span> <span class="nn">.TsysDataClassFile</span> <span class="kn">import</span> <span class="n">TsysData</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">infrastructure</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># QA score for alerts issues by this heuristic. The intent is that this score</span>
<span class="c1"># direct the EB to QA slow lane for further analysis, which currently applies</span>
<span class="c1"># to anything with a QA score of &lt;0.66,</span>
<span class="n">WARNINGS_QA_SCORE</span> <span class="o">=</span> <span class="mf">0.6</span>


<span class="c1"># PREQ 232 in JAOPOST</span>
<span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
    <span class="c1"># ALMA Bands  0       1     2    3    4     5     6     7     8    9    10</span>
    <span class="n">usePWV</span> <span class="o">=</span> <span class="p">[</span>
        <span class="mf">99.0</span><span class="p">,</span>
        <span class="mf">5.186</span><span class="p">,</span>
        <span class="mf">5.186</span><span class="p">,</span>
        <span class="mf">2.748</span><span class="p">,</span>
        <span class="mf">2.748</span><span class="p">,</span>
        <span class="mf">1.796</span><span class="p">,</span>
        <span class="mf">1.262</span><span class="p">,</span>
        <span class="mf">0.913</span><span class="p">,</span>
        <span class="mf">0.658</span><span class="p">,</span>
        <span class="mf">0.472</span><span class="p">,</span>
        <span class="mf">0.472</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">CO_LINES_MHZ</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;C18O_1-0&quot;</span><span class="p">:</span> <span class="mf">109782.17340</span><span class="p">,</span>
        <span class="s2">&quot;13CO_1-0&quot;</span><span class="p">:</span> <span class="mf">110201.35430</span><span class="p">,</span>
        <span class="s2">&quot;CO_1-0&quot;</span><span class="p">:</span> <span class="mf">115271.20180</span><span class="p">,</span>
        <span class="s2">&quot;C18O_2-1&quot;</span><span class="p">:</span> <span class="mf">219560.35410</span><span class="p">,</span>
        <span class="s2">&quot;13CO_2-1&quot;</span><span class="p">:</span> <span class="mf">220398.68420</span><span class="p">,</span>
        <span class="s2">&quot;CO_2-1&quot;</span><span class="p">:</span> <span class="mf">230538.00000</span><span class="p">,</span>
        <span class="s2">&quot;C18O_3-2&quot;</span><span class="p">:</span> <span class="mf">329330.55250</span><span class="p">,</span>
        <span class="s2">&quot;13CO_3-2&quot;</span><span class="p">:</span> <span class="mf">330587.96530</span><span class="p">,</span>
        <span class="s2">&quot;CO_3-2&quot;</span><span class="p">:</span> <span class="mf">345795.98990</span><span class="p">,</span>
        <span class="s2">&quot;C18O_4-3&quot;</span><span class="p">:</span> <span class="mf">439088.76580</span><span class="p">,</span>
        <span class="s2">&quot;13CO_4-3&quot;</span><span class="p">:</span> <span class="mf">440765.17350</span><span class="p">,</span>
        <span class="s2">&quot;CO_4-3&quot;</span><span class="p">:</span> <span class="mf">461040.76820</span><span class="p">,</span>
        <span class="s2">&quot;C18O_6-5&quot;</span><span class="p">:</span> <span class="mf">658553.27820</span><span class="p">,</span>
        <span class="s2">&quot;13CO_6-5&quot;</span><span class="p">:</span> <span class="mf">661067.27660</span><span class="p">,</span>
        <span class="s2">&quot;CO_6-5&quot;</span><span class="p">:</span> <span class="mf">691473.07630</span><span class="p">,</span>
        <span class="s2">&quot;CO_7-6&quot;</span><span class="p">:</span> <span class="mf">806651.80600</span><span class="p">,</span>
        <span class="s2">&quot;C18O_8-7&quot;</span><span class="p">:</span> <span class="mf">877921.95530</span><span class="p">,</span>
        <span class="s2">&quot;13CO_8-7&quot;</span><span class="p">:</span> <span class="mf">881272.80800</span><span class="p">,</span>
        <span class="s2">&quot;CO_8-7&quot;</span><span class="p">:</span> <span class="mf">921799.70000</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">LINES_12C16O</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CO_LINES_MHZ</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CO_\d\-\d&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">MAX_VELOCITY_WIDTH</span> <span class="o">=</span> <span class="mi">520</span>  <span class="c1"># km/s, based on Dame&#39;s CO 1-0 Galaxy map</span>
    <span class="n">WEATHER_DATA_GROUPING</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 5 s grouping</span>

    <span class="c1"># preq232 @ jupyterif True:</span>
<div class="viewcode-block" id="gline_and_baseline">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.gline_and_baseline">[docs]</a>
    <span class="k">def</span> <span class="nf">gline_and_baseline</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># peak, location, fwhm, a, b (a+bx baseline)</span>
        <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">4</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">pars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                    <span class="o">-</span><span class="mi">4</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                    <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">pars</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span> <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
                <span class="o">+</span> <span class="n">pars</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="gaussian_line_fit">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.gaussian_line_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">gaussian_line_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># (peak,x0,fwhm)=pars</span>
        <span class="n">xi2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pars</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">no_nans</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">gline_and_baseline</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">chan_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">pars0</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">y</span><span class="p">[</span><span class="n">chan_max</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
            <span class="n">chan_max</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">chan_max</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># 4 channels initial parameter fwhm</span>

        <span class="c1"># print(pars0)</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pars0</span><span class="p">))]</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pars0</span><span class="p">))]</span>
        <span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">lb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">xi2</span><span class="p">,</span> <span class="n">pars0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Bounds</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;fun&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
            <span class="c1"># print(&quot;trying more&quot;)</span>
            <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">lb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                    <span class="n">ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="n">xi2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pars</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">no_nans</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">gline_and_baseline</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">deg</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">fwhm_ratio</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">]:</span>
                    <span class="n">pars0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">chan_max</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">fwhm_ratio</span>
                    <span class="p">)</span>
                    <span class="n">resaux</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                        <span class="n">xi2</span><span class="p">,</span>
                        <span class="n">pars0</span> <span class="o">+</span> <span class="p">([]</span> <span class="k">if</span> <span class="n">deg</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="n">Bounds</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">),</span>
                    <span class="p">)</span>
                    <span class="c1"># print(f&quot;--{resaux[&#39;fun&#39;]}&quot;)</span>
                    <span class="k">if</span> <span class="n">resaux</span><span class="p">[</span><span class="s2">&quot;fun&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">resaux</span><span class="p">[</span><span class="s2">&quot;fun&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">res</span><span class="p">[</span>
                        <span class="s2">&quot;fun&quot;</span>
                    <span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">resaux</span>
                        <span class="n">degree</span> <span class="o">=</span> <span class="n">deg</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">gline_and_baseline</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span></div>


<div class="viewcode-block" id="width_fit_filter">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.width_fit_filter">[docs]</a>
    <span class="k">def</span> <span class="nf">width_fit_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">peaks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fwhm_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">window</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">peaks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">half_window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">window</span> <span class="o">-</span> <span class="n">window</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">half_window_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">half_window_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">]</span>
        <span class="c1"># widths = []</span>
        <span class="n">filtered_peaks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks</span> <span class="o">+</span> <span class="n">half_window_size</span><span class="p">:</span>
            <span class="n">gpars</span><span class="p">,</span> <span class="n">gline</span> <span class="o">=</span> <span class="n">gaussian_line_fit</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">half_window_size</span><span class="p">,</span> <span class="n">half_window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">y</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="n">half_window_size</span> <span class="p">:</span> <span class="n">p</span> <span class="o">+</span> <span class="n">half_window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">fwhm</span> <span class="o">=</span> <span class="n">gpars</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">fwhm_limit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">filtered_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">half_window_size</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">fwhm_limit</span> <span class="o">&gt;</span> <span class="n">fwhm</span><span class="p">:</span>
                <span class="n">filtered_peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">half_window_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">filtered_peaks</span><span class="p">)</span></div>


<div class="viewcode-block" id="linear_trend">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.linear_trend">[docs]</a>
    <span class="k">def</span> <span class="nf">linear_trend</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="s2">&quot;abs&quot;</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s2">&quot;abs&quot;</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">no_nans</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">no_nans</span><span class="p">((</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">var0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="find_repeated_peaks">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.find_repeated_peaks">[docs]</a>
    <span class="k">def</span> <span class="nf">find_repeated_peaks</span><span class="p">(</span>
        <span class="n">data1</span><span class="p">,</span>
        <span class="n">data2</span><span class="p">,</span>
        <span class="n">prominence</span><span class="p">,</span>
        <span class="n">prominence_limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># v3.3</span>
        <span class="n">difference_tolerance_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">distance_from_peak</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># v2.5</span>
        <span class="c1"># assert False, prominence</span>
        <span class="c1"># tolerance_chan = int((np.log(len(data1))/np.log(2)-7)*3/5) # 0 tolerance for 128, 3 channels for 4096. v3.1</span>

        <span class="n">data1</span> <span class="o">=</span> <span class="n">data1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data2</span> <span class="o">=</span> <span class="n">data2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">data1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">no_nans</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>
                    <span class="o">+</span> <span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>
                    <span class="o">+</span> <span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="o">+</span> <span class="n">var</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="o">-</span> <span class="p">((</span><span class="n">data1</span> <span class="o">+</span> <span class="n">data2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">var0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">((</span><span class="n">data1</span> <span class="o">+</span> <span class="n">data2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">var0</span><span class="p">)</span>
        <span class="n">mod3</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># linear_approximation = linear_trend((data1+data2)/2)</span>
        <span class="n">_mod3_1</span> <span class="o">=</span> <span class="n">mod3</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">_mod3_2</span> <span class="o">=</span> <span class="n">mod3</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">data1</span> <span class="o">-=</span> <span class="n">_mod3_1</span>
        <span class="n">data2</span> <span class="o">-=</span> <span class="n">_mod3_2</span>
        <span class="c1"># plt.plot(data1);plt.plot(data2);plt.show(); input();</span>

        <span class="n">p1</span><span class="p">,</span> <span class="n">prominence_dictionary1</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence</span><span class="p">)</span>
        <span class="c1"># print(f&quot;find_repeated_peaks: p1={p1}, prominence_dictionary1={prominence_dictionary1}&quot;)</span>
        <span class="n">p2</span><span class="p">,</span> <span class="n">prominence_dictionary2</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence</span><span class="p">)</span>
        <span class="c1"># print(p2, prominence_dictionary2); #assert False,&quot;&quot;</span>
        <span class="n">repeated_peak_channels1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">repeated_peak_channels2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_p1</span><span class="p">,</span> <span class="n">_pp1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">prominence_dictionary1</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">]):</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">_pp1</span> <span class="o">/</span> <span class="n">prominence</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">))</span>
            <span class="c1"># print(_p1,_pp1, tol)</span>
            <span class="n">_p2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[[</span><span class="n">_p1</span> <span class="o">+</span> <span class="n">delta</span> <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span> <span class="n">tol</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p2</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_p2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">repeated_peak_channels1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_p1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_p2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">repeated_peak_channels2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">_p2</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_p2</span><span class="p">)</span>
                <span class="n">_pp2</span> <span class="o">=</span> <span class="n">prominence_dictionary2</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">_p2</span><span class="p">)),</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="c1"># print(np.argmin(np.abs(_pp2-_pp1)))</span>
                <span class="n">_selp2</span> <span class="o">=</span> <span class="n">_p2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_pp2</span> <span class="o">-</span> <span class="n">_pp1</span><span class="p">))]</span>
                <span class="n">repeated_peak_channels2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_selp2</span><span class="p">)</span>
        <span class="c1"># assert False, (np.array(repeated_peak_channels1),np.array(repeated_peak_channels2))</span>
        <span class="n">auxi1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxi2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dd1</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prominences&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;left_bases&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;right_bases&quot;</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># v3.4</span>
        <span class="n">dd2</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;prominences&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;left_bases&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;right_bases&quot;</span><span class="p">:</span> <span class="p">[]}</span>  <span class="c1"># v3.4</span>
        <span class="k">for</span> <span class="n">rp1</span><span class="p">,</span> <span class="n">rp2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">repeated_peak_channels1</span><span class="p">,</span> <span class="n">repeated_peak_channels2</span><span class="p">):</span>
            <span class="n">width_rp1</span> <span class="o">=</span> <span class="n">peak_widths</span><span class="p">(</span>
                <span class="n">data1</span><span class="p">,</span>
                <span class="n">p1</span><span class="p">[</span><span class="n">p1</span> <span class="o">==</span> <span class="n">rp1</span><span class="p">],</span>
                <span class="n">rel_height</span><span class="o">=</span><span class="n">distance_from_peak</span>
                <span class="o">/</span> <span class="n">prominence_dictionary1</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span><span class="n">p1</span> <span class="o">==</span> <span class="n">rp1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">width_rp2</span> <span class="o">=</span> <span class="n">peak_widths</span><span class="p">(</span>
                <span class="n">data2</span><span class="p">,</span>
                <span class="n">p2</span><span class="p">[</span><span class="n">p2</span> <span class="o">==</span> <span class="n">rp2</span><span class="p">],</span>
                <span class="n">rel_height</span><span class="o">=</span><span class="n">distance_from_peak</span>
                <span class="o">/</span> <span class="n">prominence_dictionary2</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span><span class="n">p2</span> <span class="o">==</span> <span class="n">rp2</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">width_rp1</span> <span class="o">&lt;=</span> <span class="n">width</span> <span class="ow">and</span> <span class="n">width_rp2</span> <span class="o">&lt;=</span> <span class="n">width</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">difference_tolerance_ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">_prom1</span> <span class="o">=</span> <span class="n">prominence_dictionary1</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span><span class="n">p1</span> <span class="o">==</span> <span class="n">rp1</span><span class="p">]</span>
                <span class="n">_prom2</span> <span class="o">=</span> <span class="n">prominence_dictionary2</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span><span class="n">p2</span> <span class="o">==</span> <span class="n">rp2</span><span class="p">]</span>

                <span class="n">comparison_ratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">_prom1</span> <span class="o">-</span> <span class="n">_prom2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">_prom1</span> <span class="o">+</span> <span class="n">_prom2</span><span class="p">)</span>
                <span class="p">)</span>  <span class="c1"># change formula in v3.3</span>

                <span class="k">if</span> <span class="n">comparison_ratio</span> <span class="o">&gt;=</span> <span class="n">difference_tolerance_ratio</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">_prom1</span> <span class="o">&gt;</span> <span class="n">prominence_limit</span> <span class="ow">and</span> <span class="n">_prom2</span> <span class="o">&gt;</span> <span class="n">prominence_limit</span><span class="p">:</span>
                    <span class="c1"># print(rp1,_prom1)</span>
                    <span class="n">auxi1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rp1</span><span class="p">)</span>
                    <span class="n">dd1</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prom1</span><span class="p">)</span>  <span class="c1"># v3.4</span>
                    <span class="n">dd1</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">prominence_dictionary1</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">][</span><span class="n">p1</span> <span class="o">==</span> <span class="n">rp1</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># v3.4</span>
                    <span class="n">dd1</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">prominence_dictionary1</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">][</span><span class="n">p1</span> <span class="o">==</span> <span class="n">rp1</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">auxi2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rp2</span><span class="p">)</span>
                    <span class="n">dd2</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prom2</span><span class="p">)</span>  <span class="c1"># v3.4</span>
                    <span class="n">dd2</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">prominence_dictionary2</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">][</span><span class="n">p2</span> <span class="o">==</span> <span class="n">rp2</span><span class="p">]</span>
                    <span class="p">)</span>  <span class="c1"># v3.4</span>
                    <span class="n">dd2</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">prominence_dictionary2</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">][</span><span class="n">p2</span> <span class="o">==</span> <span class="n">rp2</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxi1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxi2</span><span class="p">),</span> <span class="p">[</span><span class="n">dd1</span><span class="p">,</span> <span class="n">dd2</span><span class="p">]</span>  <span class="c1"># v3.4</span></div>


<div class="viewcode-block" id="exp_rescale">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.exp_rescale">[docs]</a>
    <span class="k">def</span> <span class="nf">exp_rescale</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">maximum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">maximum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;exp_rescale_1: maximum=</span><span class="si">{</span><span class="n">maximum</span><span class="si">}</span><span class="s2"> &lt;= 0 cannot rescale.&quot;</span>
        <span class="n">nn</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">maximum</span>
        <span class="c1"># assert False, f&quot;{nn} {scale}&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span> <span class="o">*</span> <span class="n">nn</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">maximum</span></div>


<div class="viewcode-block" id="model_break">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.model_break">[docs]</a>
    <span class="k">def</span> <span class="nf">model_break</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>  <span class="c1"># v3.5</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">peaks</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">peaks</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xp</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">xp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">model</span><span class="p">[</span><span class="n">xp</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">window_length</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">window_length</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="p">(</span><span class="n">atm_1</span><span class="p">,</span> <span class="n">atm_2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">savgol_filter</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">window_length</span><span class="p">,</span> <span class="n">deriv</span><span class="o">=</span><span class="n">dd</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">model</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">atm_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">atm_1</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">atm_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">atm_2</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">peaks</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">model</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">atm_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">atm_1</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">atm_2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">atm_2</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">peaks</span><span class="p">,</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="c1"># assert False, peaks</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">xp</span><span class="p">,</span> <span class="n">lower_hug</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># v2.5</span>
        <span class="n">_auxp</span><span class="p">,</span> <span class="n">_auxpp</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">prominence</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;prominences&quot;</span><span class="p">])[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">),</span>
        <span class="p">)</span>  <span class="c1"># v2.5 # v3.2</span>
        <span class="n">crossings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">_auxpp</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">],</span> <span class="n">_auxpp</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">]])))</span>
        <span class="p">)</span>  <span class="c1"># v2.5</span>
        <span class="c1"># print(f&#39;peaks={peaks} _auxp={_auxp}, crossings={crossings}&#39;)</span>
        <span class="c1"># crossings = np.where((atm_1[1:] &gt; 0) * (atm_1[:-1] &lt;= 0))[0]</span>
        <span class="c1"># assert np.all(atm_2[crossings]&gt;0), &quot;not all crossings correspond to local minima&quot;</span>
        <span class="c1"># assert False, crossings</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">newcross</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">peaks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">peak0</span><span class="p">,</span> <span class="n">peak1</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">peaks</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">_ccs</span> <span class="o">=</span> <span class="n">crossings</span><span class="p">[(</span><span class="n">peak0</span> <span class="o">&lt;</span> <span class="n">crossings</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">crossings</span> <span class="o">&lt;</span> <span class="n">peak1</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_ccs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">newcross</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_ccs</span><span class="p">[</span><span class="n">model</span><span class="p">[</span><span class="n">_ccs</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">_ccs</span><span class="p">])][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">crossings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newcross</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
                <span class="p">[]</span> <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">peaks</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">crossings</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">([]</span> <span class="k">if</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">peaks</span> <span class="k">else</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># print(f&#39;xp={xp}&#39;)</span>
        <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">xp</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="n">xp</span><span class="p">])</span>
        <span class="n">xp_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xp</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">xp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xp_intervals</span><span class="p">:</span>
            <span class="n">baseline</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lower_hug</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">xp_intervals</span><span class="p">,</span> <span class="n">baseline</span></div>


<div class="viewcode-block" id="lower_hug">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.lower_hug">[docs]</a>
    <span class="k">def</span> <span class="nf">lower_hug</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span>
        <span class="n">hull</span> <span class="o">=</span> <span class="n">ConvexHull</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="c1"># plt.plot(y);print(hull.simplices)</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hull</span><span class="o">.</span><span class="n">simplices</span><span class="o">.</span><span class="n">flatten</span><span class="p">())):</span>
            <span class="n">nodes</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">hull</span><span class="o">.</span><span class="n">simplices</span><span class="p">[</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hull</span><span class="o">.</span><span class="n">simplices</span> <span class="o">==</span> <span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">v</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">node0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">direction_slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1">##</span>
        <span class="n">node1</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">direction_slope</span><span class="p">)]</span>
        <span class="n">lower</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node1</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">node1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">node1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">node0</span><span class="p">])</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;lower_hug: bad node construction.</span><span class="se">\n</span><span class="s2">nodes=</span><span class="si">{</span><span class="n">nodes</span><span class="si">}</span><span class="se">\n</span><span class="s2">node0=</span><span class="si">{</span><span class="n">node0</span><span class="si">}</span><span class="se">\n</span><span class="s2">node1=</span><span class="si">{</span><span class="n">node1</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">node0</span> <span class="o">=</span> <span class="n">node1</span>
            <span class="n">node1</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>
            <span class="n">lower</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node1</span><span class="p">)</span>
        <span class="c1"># assert False, lower</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lower</span><span class="p">))))</span>
        <span class="c1"># print(lower);plt.plot(y);plt.plot(lower,y[lower]); assert False,&quot;&quot;</span>
        <span class="c1"># assert False, lower</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">lower</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">lower</span><span class="p">])</span></div>


<div class="viewcode-block" id="modified_atmospheric_profile">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.modified_atmospheric_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">modified_atmospheric_profile</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">baseline</span><span class="p">,</span>
        <span class="n">degree_baseline</span><span class="p">,</span>
        <span class="n">scales</span><span class="p">,</span>
        <span class="n">coefficients</span><span class="p">,</span>
        <span class="n">segments</span><span class="p">,</span>
        <span class="n">x_coordinates</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># plt.plot(model);plt.plot(baseline); assert False, segments</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">x_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="n">segments_resc</span> <span class="o">=</span> <span class="n">segments</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">seg_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">segments</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">seg_lim_resc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">segments_resc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">segments_resc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
        <span class="c1"># assert False, segments_resc</span>
        <span class="c1"># p_interp_baseline = baseline # np.polynomial.Polynomial.fit(seg_lim_resc,model[seg_lim],deg = len(seg_lim)-1)</span>

        <span class="n">model_mod</span> <span class="o">=</span> <span class="n">model</span> <span class="o">-</span> <span class="n">baseline</span>  <span class="c1"># p_interp_baseline(x_coordinates) # v3.2</span>

        <span class="n">n_scales</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="mi">1</span> <span class="p">:</span> <span class="n">degree_baseline</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">x_coordinatessum</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">x_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">degree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
            <span class="n">x_coordinatessum</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">degree</span><span class="p">]</span> <span class="o">*</span> <span class="n">legendre</span><span class="p">(</span><span class="n">degree</span><span class="p">)(</span><span class="n">x_coordinates</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">nseg</span><span class="p">,</span> <span class="n">seg_resc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">segments_resc</span><span class="p">)):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">nseg</span> <span class="o">*</span> <span class="n">n_scales</span>
                <span class="o">+</span> <span class="n">degree_baseline</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nseg</span> <span class="o">*</span> <span class="n">n_scales</span>
                <span class="o">+</span> <span class="n">degree_baseline</span>
                <span class="o">+</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">n_scales</span>
            <span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span>
                <span class="mi">2</span> <span class="o">*</span> <span class="n">nseg</span> <span class="o">*</span> <span class="n">n_scales</span>
                <span class="o">+</span> <span class="n">degree_baseline</span>
                <span class="o">+</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="n">n_scales</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">nseg</span> <span class="o">*</span> <span class="n">n_scales</span>
                <span class="o">+</span> <span class="n">degree_baseline</span>
                <span class="o">+</span> <span class="mi">2</span>
                <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_scales</span>
            <span class="p">]</span>
            <span class="c1"># print(f&quot;---{a}--{b}&quot;)</span>
            <span class="k">if</span> <span class="n">n_scales</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scales</span><span class="p">):</span>
                    <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">nseg</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">segments</span><span class="p">[</span><span class="n">nseg</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">modified</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp_rescale</span><span class="p">(</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">model_mod</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span>
                        <span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">*</span> <span class="n">exp_rescale</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">model_mod</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="p">],</span> <span class="n">scale</span><span class="o">=-</span><span class="n">scale</span><span class="p">)</span>
                <span class="n">modified</span> <span class="o">=</span> <span class="n">modified</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">split</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x_coordinatessum</span> <span class="o">+</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">modified</span>
        <span class="k">return</span> <span class="n">x_coordinatessum</span> <span class="o">+</span> <span class="n">baseline</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="n">model</span> <span class="o">+</span> <span class="n">modified</span><span class="p">)</span></div>


<div class="viewcode-block" id="cross_model">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.cross_model">[docs]</a>
    <span class="k">def</span> <span class="nf">cross_model</span><span class="p">(</span><span class="n">data_a</span><span class="p">,</span> <span class="n">data_b</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">asym_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pp</span><span class="p">:</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">data_b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_b</span><span class="p">))</span>
        <span class="n">dif2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">no_nans</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">_</span> <span class="k">if</span> <span class="n">_</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">asym_factor</span> <span class="o">*</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">data_a</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">pp</span><span class="p">)])</span>
            <span class="p">)</span>
            <span class="o">**</span> <span class="mi">2</span>
        <span class="p">)</span>
        <span class="c1"># chi2 = lambda pp: np.sum(no_nans(pp[0]+pp[1]*data_b-data_a)**2)</span>
        <span class="n">pp0</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_a</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_b</span><span class="p">),</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">dif2</span><span class="p">,</span> <span class="n">pp0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="max_without_outliers">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.max_without_outliers">[docs]</a>
    <span class="k">def</span> <span class="nf">max_without_outliers</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">_x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">outliers</span><span class="p">):</span>
            <span class="c1"># print(_x)</span>
            <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">median_abs_deviation</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sigma</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_x</span> <span class="o">-</span> <span class="n">med</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">no_nans</span><span class="p">(</span><span class="n">_x</span><span class="p">)))</span>
            <span class="p">)</span>
            <span class="c1"># print(med,sigma,outliers)</span>
            <span class="n">_x</span> <span class="o">=</span> <span class="n">_x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">outliers</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span></div>


<div class="viewcode-block" id="positive_line_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.positive_line_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">positive_line_intervals</span><span class="p">(</span>
        <span class="n">normalized_data</span><span class="p">,</span> <span class="n">detection_limit</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">base_detection</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized_data</span><span class="p">)</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
        <span class="n">_norm</span> <span class="o">=</span> <span class="n">normalized_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chans</span> <span class="o">-</span> <span class="n">nchan</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">edge</span><span class="p">)</span> <span class="o">*</span> <span class="n">nchan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">peaks0</span><span class="p">,</span> <span class="n">peaks_dict0</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span>
            <span class="p">(</span><span class="n">_norm</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">_norm</span> <span class="o">&gt;</span> <span class="n">base_detection</span><span class="p">),</span>
            <span class="n">height</span><span class="o">=</span><span class="n">detection_limit</span><span class="p">,</span>
            <span class="n">prominence</span><span class="o">=</span><span class="n">detection_limit</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;peak_heights&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">base_detection</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;positive_line_intervals: peaks0, peaks_dict0 = </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">peaks0</span><span class="p">,</span> <span class="n">peaks_dict0</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normalized_data</span><span class="p">)</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">],</span> <span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">]]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">normalized_data</span><span class="p">[</span><span class="n">_</span><span class="p">],</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peaks0</span><span class="p">,</span> <span class="n">normalized_data</span><span class="p">[</span><span class="n">peaks0</span><span class="p">],</span> <span class="s2">&quot;x&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">base_detection</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_data</span><span class="p">)),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">detection_limit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">normalized_data</span><span class="p">)),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">peaks0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="nb">input</span><span class="p">()</span>

        <span class="n">lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span>
                        <span class="nb">list</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;left_bases&quot;</span><span class="p">],</span> <span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;right_bases&quot;</span><span class="p">]]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># v3.3</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="n">lims</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lims</span><span class="p">[</span><span class="n">lims</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="p">])]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks0</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># merge_intervals(_) # v3.3</span>
        <span class="c1"># print(f&quot;positive_line_intervals:\n\tintervals={intervals}&quot;)</span>
        <span class="c1"># assert False, f&#39;{peaks0} {peaks_dict0}&#39;</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span>  <span class="c1"># v3.3</span>
        <span class="c1"># print(f&quot;positive_line_intervals:\n\tmerged intervals={intervals}&quot;);input()</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">peaks_intervals</span><span class="p">,</span> <span class="n">heights</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">peaks0</span> <span class="o">&gt;=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peaks0</span> <span class="o">&lt;=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">inside_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span>
                <span class="n">peaks0</span><span class="p">[</span><span class="n">_</span><span class="p">],</span> <span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;peak_heights&quot;</span><span class="p">][</span><span class="n">_</span><span class="p">],</span> <span class="n">peaks_dict0</span><span class="p">[</span><span class="s2">&quot;prominences&quot;</span><span class="p">][</span><span class="n">_</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">inside_peaks</span> <span class="o">=</span> <span class="n">inside_peaks</span><span class="p">[(</span><span class="o">-</span><span class="n">inside_peaks</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;positive_line_intervals:</span><span class="se">\n\t\t</span><span class="s2">inside_peaks=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">inside_peaks</span><span class="p">)</span>
            <span class="c1"># input()</span>
            <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inside_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">peaks_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">heights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">inside_peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)])</span>
        <span class="c1"># if verbose: print(peaks_intervals)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>  <span class="c1"># v2.3</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peaks_intervals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">heights</span><span class="p">),</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="refitting_intervals_bp_to_source">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.refitting_intervals_bp_to_source">[docs]</a>
    <span class="k">def</span> <span class="nf">refitting_intervals_bp_to_source</span><span class="p">(</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">bp</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
        <span class="n">normalized_data</span><span class="p">,</span>
        <span class="n">detection_limit</span><span class="p">,</span>
        <span class="n">edge</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
        <span class="n">base_detection</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">intervals</span><span class="p">,</span> <span class="n">heights</span> <span class="o">=</span> <span class="n">positive_line_intervals</span><span class="p">(</span>
            <span class="n">normalized_data</span><span class="o">=</span><span class="n">normalized_data</span><span class="p">,</span>
            <span class="n">edge</span><span class="o">=</span><span class="n">edge</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">detection_limit</span><span class="o">=</span><span class="n">detection_limit</span><span class="p">,</span>
            <span class="n">base_detection</span><span class="o">=</span><span class="n">base_detection</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;refitting_intervals_bp_to_source:</span><span class="se">\n\t</span><span class="s2">--First version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intervals</span><span class="p">)</span>
        <span class="n">final_peaks</span><span class="p">,</span> <span class="n">final_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">shift_bp_to_source</span><span class="p">(</span>
                <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span> <span class="n">bp</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span>
            <span class="p">)</span>
            <span class="c1"># print(intervals, shift)</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ch0</span><span class="p">,</span> <span class="n">ch1</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">peaks1</span><span class="p">,</span> <span class="n">intervals1</span><span class="p">,</span> <span class="n">heights1</span> <span class="o">=</span> <span class="n">positive_line_intervals</span><span class="p">(</span>
                <span class="n">normalized_data</span><span class="o">=</span><span class="p">((</span><span class="n">source</span> <span class="o">-</span> <span class="n">bp</span> <span class="o">-</span> <span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)[</span><span class="n">ch0</span> <span class="p">:</span> <span class="n">ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">edge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">detection_limit</span><span class="o">=</span><span class="n">detection_limit</span><span class="p">,</span>
                <span class="n">base_detection</span><span class="o">=</span><span class="n">base_detection</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># plt.plot(((source-bp-shift)/sigma)[ch0:ch1+1]); plt.show();input()</span>

            <span class="n">peaks1</span> <span class="o">+=</span> <span class="n">ch0</span>
            <span class="n">intervals1</span> <span class="o">+=</span> <span class="n">ch0</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;refitting_intervals_bp_to_source:</span><span class="se">\n\t</span><span class="s2">--Second version: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">intervals1</span>
            <span class="p">)</span>
            <span class="n">final_peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">final_peaks</span><span class="p">,</span> <span class="n">peaks1</span><span class="p">]</span>
            <span class="n">final_intervals</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">intervals1</span>
                <span class="k">if</span> <span class="n">final_intervals</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">final_intervals</span><span class="p">,</span> <span class="n">intervals1</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="c1"># assert False, &#39;&#39;</span>
        <span class="k">return</span> <span class="n">final_peaks</span><span class="p">,</span> <span class="n">final_intervals</span></div>


<div class="viewcode-block" id="below_fit">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.below_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">below_fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">start_asym_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">meanmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">asym_factor</span> <span class="o">=</span> <span class="n">start_asym_factor</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>  <span class="c1"># v3.5</span>
            <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>

                <span class="c1"># print(f&quot;i={i}, model={model}\ndata={data}&quot;)</span>
                <span class="n">dif</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">no_nans</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                                <span class="p">[</span>
                                    <span class="n">_</span> <span class="k">if</span> <span class="n">_</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">asym_factor</span> <span class="o">*</span> <span class="n">_</span>
                                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_data</span> <span class="o">-</span> <span class="n">model</span> <span class="o">-</span> <span class="n">pp</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">meandata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
                <span class="n">pars0</span> <span class="o">=</span> <span class="n">meandata</span> <span class="o">-</span> <span class="n">meanmodel</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">dif</span><span class="p">,</span> <span class="n">pars0</span><span class="p">)</span>
                <span class="c1"># print(f&quot;clip={clip}&quot;);</span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span> <span class="o">+</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="nb">input</span><span class="p">()</span>
                <span class="n">_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_data</span> <span class="o">-</span> <span class="n">model</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">_data</span> <span class="o">==</span> <span class="n">_data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># assert False, f&quot;_data={_data}, mu={res[&#39;x&#39;][0]}&quot;</span>
                <span class="n">asym_factor</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># aca explota, hay que arreglarlo</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="shift_bp_to_source">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.shift_bp_to_source">[docs]</a>
    <span class="k">def</span> <span class="nf">shift_bp_to_source</span><span class="p">(</span>
        <span class="n">interval</span><span class="p">,</span>
        <span class="n">source</span><span class="p">,</span>
        <span class="n">bp</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
        <span class="n">clip_snr</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">asym_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># v3.5</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
        <span class="n">interval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">search_expanded_interval</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">bp</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
            <span class="n">limit_sigma</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ch0</span><span class="p">,</span> <span class="n">ch1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;shift_bp_to_source </span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ch0</span><span class="p">,</span> <span class="n">ch1</span><span class="p">)</span>

        <span class="n">shift</span> <span class="o">=</span> <span class="n">below_fit</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">source</span><span class="p">)[</span><span class="n">ch0</span> <span class="p">:</span> <span class="n">ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">model</span><span class="o">=</span><span class="p">(</span><span class="n">bp</span><span class="p">)[</span><span class="n">ch0</span> <span class="p">:</span> <span class="n">ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">iterations</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span>
            <span class="n">clip</span><span class="o">=</span><span class="n">clip_snr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>
            <span class="n">start_asym_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># asym_factor)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="n">ch0</span> <span class="p">:</span> <span class="n">ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">shift</span> <span class="o">+</span> <span class="n">bp</span><span class="p">[</span><span class="n">ch0</span> <span class="p">:</span> <span class="n">ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="nb">input</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;shift=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">shift</span></div>


<div class="viewcode-block" id="search_expanded_interval">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.search_expanded_interval">[docs]</a>
    <span class="k">def</span> <span class="nf">search_expanded_interval</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">limit_sigma</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;---initial interval=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
        <span class="n">ch0</span><span class="p">,</span> <span class="n">ch1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">delta0</span> <span class="o">=</span> <span class="n">ch1</span> <span class="o">-</span> <span class="n">ch0</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">delta_return</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">3</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">_ch0</span><span class="p">,</span> <span class="n">_ch1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ch0</span> <span class="o">-</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">ch1</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">_ch0</span><span class="p">,</span> <span class="n">_ch1</span><span class="p">,</span> <span class="n">_ch1</span> <span class="o">-</span> <span class="n">_ch0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">_ch0</span> <span class="p">:</span> <span class="n">_ch1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="c1"># print(x.shape,y.shape)</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">reduced_chi_square</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">no_nans</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">_ch1</span> <span class="o">-</span> <span class="n">_ch0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">reduced_chi_square</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">limit_sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">_ch1</span> <span class="o">-</span> <span class="n">_ch0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;---redchi-sq = </span><span class="si">%s</span><span class="s2">, delta_return = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">reduced_chi_square</span><span class="p">,</span>
                    <span class="n">delta_return</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">delta_return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta_return</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;---redchi-sq = </span><span class="si">%s</span><span class="s2">, delta_return = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reduced_chi_square</span><span class="p">,</span> <span class="n">delta_return</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">delta_return</span></div>


<div class="viewcode-block" id="basic_atm_asymmetric_fit">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.basic_atm_asymmetric_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">basic_atm_asymmetric_fit</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">transmission</span><span class="p">,</span> <span class="n">iterations</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">asym_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">xvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">transmission</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">model</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">pp</span><span class="p">:</span> <span class="n">pp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">transmission</span><span class="p">)</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">xvec</span> <span class="o">+</span> <span class="n">pp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># include base in v3.3</span>
        <span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">dif2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pp</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">no_nans</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">_</span> <span class="k">if</span> <span class="n">_</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">asym_factor</span> <span class="o">*</span> <span class="n">_</span>
                                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_data</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">pp</span><span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">meantsys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">pars0</span> <span class="o">=</span> <span class="p">[</span><span class="n">meantsys</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">transmission</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meantsys</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">transmission</span><span class="p">))</span>
            <span class="c1"># print(pars0)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
                <span class="n">dif2</span><span class="p">,</span> <span class="n">pars0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">_</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">_</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">_data</span><span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_data</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]))</span>
                <span class="o">&gt;</span> <span class="n">clip</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_data</span> <span class="o">-</span> <span class="n">model</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])))</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span></div>


<div class="viewcode-block" id="smoother_sigma">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.smoother_sigma">[docs]</a>
    <span class="k">def</span> <span class="nf">smoother_sigma</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">clip_level</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s2">&quot;sg&quot;</span><span class="p">):</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">sub</span><span class="p">,</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">smoother</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="n">stype</span><span class="p">)</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">median_abs_deviation</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;omit&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;smoother_sigma:</span><span class="se">\n\t</span><span class="s2">sub=</span><span class="si">%s</span><span class="se">\n\t</span><span class="s2">sigma=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">clip_level</span> <span class="o">*</span> <span class="n">sigma</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
                <span class="n">vv</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">sigma</span></div>


<div class="viewcode-block" id="no_nans">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.no_nans">[docs]</a>
    <span class="k">def</span> <span class="nf">no_nans</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span></div>


<div class="viewcode-block" id="smoother">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.smoother">[docs]</a>
    <span class="k">def</span> <span class="nf">smoother</span><span class="p">(</span>
        <span class="n">vector_for_smoothing</span><span class="p">,</span>
        <span class="n">vector_to_subtract_from</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">window_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">stype</span><span class="o">=</span><span class="s2">&quot;sg&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">vector_for_smoothing</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">int</span><span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="n">nchan</span><span class="p">))</span> <span class="k">if</span> <span class="n">window_size</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">window_size</span>
        <span class="p">)</span>
        <span class="n">window_size</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">stype</span> <span class="o">=</span> <span class="s2">&quot;constant&quot;</span> <span class="k">if</span> <span class="n">stype</span> <span class="o">!=</span> <span class="s2">&quot;sg&quot;</span> <span class="k">else</span> <span class="s2">&quot;sg&quot;</span>
        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;sg&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span><span class="n">vector_for_smoothing</span><span class="p">,</span> <span class="n">window_size</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;constant&quot;</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vector_for_smoothing</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vector_for_smoothing</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">vector_to_subtract_from</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vector_to_subtract_from</span> <span class="o">=</span> <span class="n">vector_for_smoothing</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">subtracted</span> <span class="o">=</span> <span class="n">vector_to_subtract_from</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">-</span> <span class="n">s</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">subtracted</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_contains_nan</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;propagate&quot;</span><span class="p">,</span> <span class="n">use_sumodelation</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">policies</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;propagate&quot;</span><span class="p">,</span> <span class="s2">&quot;raise&quot;</span><span class="p">,</span> <span class="s2">&quot;omit&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nan_policy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;nan_policy must be one of {</span><span class="si">%s</span><span class="s2">}&quot;</span>
                <span class="o">%</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">policies</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># The sumodelation method avoids creating a (potentially huge) array.</span>
            <span class="c1"># But, it will set contains_nan to True for (e.g.) [-inf, ..., +inf].</span>
            <span class="c1"># If this is undesirable, set use_sumodelation to False instead.</span>
            <span class="k">if</span> <span class="n">use_sumodelation</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">over</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                    <span class="n">contains_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contains_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># This can happen when attempting to sum things which are not</span>
            <span class="c1"># numbers (e.g. as in the function `mode`). Try an alternative method:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">contains_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Don&#39;t know what to do. Fall back to omitting nan values and</span>
                <span class="c1"># issue a warning.</span>
                <span class="n">contains_nan</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">nan_policy</span> <span class="o">=</span> <span class="s2">&quot;omit&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;The input array could not be properly &quot;</span>
                    <span class="s2">&quot;checked for nan values. nan values &quot;</span>
                    <span class="s2">&quot;will be ignored.&quot;</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">contains_nan</span> <span class="ow">and</span> <span class="n">nan_policy</span> <span class="o">==</span> <span class="s2">&quot;raise&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The input contains nan values&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">contains_nan</span><span class="p">,</span> <span class="n">nan_policy</span>

<div class="viewcode-block" id="median_abs_deviation">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.median_abs_deviation">[docs]</a>
    <span class="k">def</span> <span class="nf">median_abs_deviation</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;propagate&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the median absolute deviation of the data along the given axis.</span>
<span class="sd">        The median absolute deviation (MAD, [1]_) computes the median over the</span>
<span class="sd">        absolute deviations from the median. It is a measure of dispersion</span>
<span class="sd">        similar to the standard deviation but more robust to outliers [2]_.</span>
<span class="sd">        The MAD of an empty array is ``np.nan``.</span>
<span class="sd">        .. versionadded:: 1.5.0</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array_like</span>
<span class="sd">            Input array or object that can be converted to an array.</span>
<span class="sd">        axis : int or None, optional</span>
<span class="sd">            Axis along which the range is computed. Default is 0. If None, compute</span>
<span class="sd">            the MAD over the entire array.</span>
<span class="sd">        center : callable, optional</span>
<span class="sd">            A function that will return the central value. The default is to use</span>
<span class="sd">            np.median. Any user defined function used will need to have the</span>
<span class="sd">            function signature ``func(arr, axis)``.</span>
<span class="sd">        scale : scalar or str, optional</span>
<span class="sd">            The numerical value of scale will be divided out of the final</span>
<span class="sd">            result. The default is 1.0. The string &quot;normal&quot; is also accepted,</span>
<span class="sd">            and results in `scale` being the inverse of the standard normal</span>
<span class="sd">            quantile function at 0.75, which is approximately 0.67449.</span>
<span class="sd">            Array-like scale is also allowed, as long as it broadcasts correctly</span>
<span class="sd">            to the output such that ``out / scale`` is a valid operation. The</span>
<span class="sd">            output dimensions depend on the input array, `x`, and the `axis`</span>
<span class="sd">            argument.</span>
<span class="sd">        nan_policy : {&#39;propagate&#39;, &#39;raise&#39;, &#39;omit&#39;}, optional</span>
<span class="sd">            Defines how to handle when input contains nan.</span>
<span class="sd">            The following options are available (default is &#39;propagate&#39;):</span>
<span class="sd">            * &#39;propagate&#39;: returns nan</span>
<span class="sd">            * &#39;raise&#39;: throws an error</span>
<span class="sd">            * &#39;omit&#39;: performs the calculations ignoring nan values</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mad : scalar or ndarray</span>
<span class="sd">            If ``axis=None``, a scalar is returned. If the input contains</span>
<span class="sd">            integers or floats of smaller precision than ``np.float64``, then the</span>
<span class="sd">            output data-type is ``np.float64``. Otherwise, the output data-type is</span>
<span class="sd">            the same as that of the input.</span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        numpy.std, numpy.var, numpy.median, scipy.stats.iqr, scipy.stats.tmean,</span>
<span class="sd">        scipy.stats.tstd, scipy.stats.tvar</span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `center` argument only affects the calculation of the central value</span>
<span class="sd">        around which the MAD is calculated. That is, passing in ``center=np.mean``</span>
<span class="sd">        will calculate the MAD around the mean - it will not calculate the *mean*</span>
<span class="sd">        absolute deviation.</span>
<span class="sd">        The input array may contain `inf`, but if `center` returns `inf`, the</span>
<span class="sd">        corresponding MAD for that data will be `nan`.</span>
<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [1] &quot;Median absolute deviation&quot;,</span>
<span class="sd">               https://en.wikipedia.org/wiki/Median_absolute_deviation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">center</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;The argument &#39;center&#39; must be callable. The given &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;value </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">center</span><span class="p">)</span><span class="si">}</span><span class="s2"> is not callable.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># An error may be raised here, so fail-fast, before doing lengthy</span>
        <span class="c1"># computations, even though `scale` is not used until later</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">scale</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.6744897501960817</span>  <span class="c1"># special.ndtri(0.75)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scale</span><span class="si">}</span><span class="s2"> is not a valid scale value.&quot;</span><span class="p">)</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># Consistent with `np.var` and `np.std`.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">nan_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nan_shape</span> <span class="o">==</span> <span class="p">():</span>
                <span class="c1"># Return nan, not array(nan)</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">nan_shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="c1"># print(&quot;ccc&quot;,x)</span>
        <span class="n">contains_nan</span><span class="p">,</span> <span class="n">nan_policy</span> <span class="o">=</span> <span class="n">_contains_nan</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nan_policy</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">contains_nan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mad</span> <span class="o">=</span> <span class="n">_mad_1d</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">center</span><span class="p">,</span> <span class="n">nan_policy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">_mad_1d</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">nan_policy</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">med</span> <span class="o">=</span> <span class="n">center</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">med</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Wrap the call to center() in expand_dims() so it acts like</span>
                <span class="c1"># keepdims=True was used.</span>
                <span class="n">med</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">center</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">),</span> <span class="n">axis</span><span class="p">)</span>
                <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">med</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mad</span> <span class="o">/</span> <span class="n">scale</span></div>


    <span class="k">def</span> <span class="nf">_mad_1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">nan_policy</span><span class="p">):</span>
        <span class="c1"># Median absolute deviation for 1-d array x.</span>
        <span class="c1"># This is a helper function for `median_abs_deviation`; it assumes its</span>
        <span class="c1"># arguments have been validated already.  In particular,  x must be a</span>
        <span class="c1"># 1-d numpy array, center must be callable, and if nan_policy is not</span>
        <span class="c1"># &#39;propagate&#39;, it is assumed to be &#39;omit&#39;, because &#39;raise&#39; is handled</span>
        <span class="c1"># in `median_abs_deviation`.</span>
        <span class="c1"># No warning is generated if x is empty or all nan.</span>
        <span class="n">isnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isnan</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">nan_policy</span> <span class="o">==</span> <span class="s2">&quot;propagate&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">isnan</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># MAD of an empty array is nan.</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># Edge cases have been handled, so do the basic MAD calculation.</span>
        <span class="n">med</span> <span class="o">=</span> <span class="n">center</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">med</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">mad</span>

<div class="viewcode-block" id="plot_source_bp_normalized_residuals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.plot_source_bp_normalized_residuals">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_source_bp_normalized_residuals</span><span class="p">(</span>
        <span class="n">source_tsys</span><span class="p">,</span>
        <span class="n">bandpass_tsys</span><span class="p">,</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">frequencies</span><span class="p">,</span>
        <span class="n">normalized_residuals</span><span class="p">,</span>
        <span class="n">sigma</span><span class="p">,</span>
        <span class="n">tsys_contamination_intervals</span><span class="p">,</span>
        <span class="n">label_source</span><span class="o">=</span><span class="s2">&quot;science&quot;</span><span class="p">,</span>
        <span class="n">default_label</span><span class="o">=</span><span class="s2">&quot;Tsys contamination&quot;</span><span class="p">,</span>
        <span class="n">default_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
        <span class="n">first_plot_title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">other_emphasized_intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">savefigfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">sci_spw_intervals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">nchan</span> <span class="o">=</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>
        <span class="n">_nu_function</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">ch</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ch</span>
        <span class="p">)</span>
        <span class="n">_channel_function</span> <span class="o">=</span> <span class="p">(</span>
            <span class="k">lambda</span> <span class="n">nu</span><span class="p">:</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># v3.3</span>
            <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="n">background</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)]</span>  <span class="c1"># v3.3</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">source_tsys</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tsys_contamination_intervals</span><span class="p">):</span>
            <span class="n">_chsel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="c1"># print(_chsel)</span>
            <span class="n">_</span><span class="p">[</span><span class="n">_chsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">_chsel</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">_chsel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">+</span> <span class="n">_chsel</span> <span class="o">+</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">_chsel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="c1"># print(_chsel)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_chsel</span><span class="p">,</span> <span class="n">source_tsys</span><span class="p">[</span><span class="n">_chsel</span><span class="p">],</span> <span class="s2">&quot;.-&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="p">[</span><span class="n">_chsel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_chsel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                <span class="n">source_tsys</span><span class="p">[[</span><span class="n">_chsel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_chsel</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]],</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_source</span><span class="p">)</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">source_tsys</span> <span class="o">-</span> <span class="n">bandpass_tsys</span>
        <span class="n">_</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">source_tsys</span><span class="p">,</span> <span class="n">bandpass_tsys</span><span class="p">])</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">bandpass_tsys</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;bandpass&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dif</span> <span class="o">+</span> <span class="n">_</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;difference&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># v2.5</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">model</span> <span class="o">+</span> <span class="n">_</span><span class="p">,</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">source_tsys</span><span class="p">,</span> <span class="n">bandpass_tsys</span><span class="p">,</span> <span class="n">dif</span> <span class="o">+</span> <span class="n">_</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">source_tsys</span><span class="p">,</span> <span class="n">bandpass_tsys</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="c1"># _t = _min*.995-(trans_b)*(_min*.995-_max*1.005)</span>
        <span class="c1"># ax0.plot(chans,_t, label=&#39;ATM&#39;)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">_min</span> <span class="o">-</span> <span class="p">(</span><span class="n">_max</span> <span class="o">-</span> <span class="n">_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="n">_max</span> <span class="o">+</span> <span class="p">(</span><span class="n">_max</span> <span class="o">-</span> <span class="n">_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">first_plot_title</span><span class="p">)</span>
        <span class="c1"># ax0.set_xlabel(&#39;Frequency (MHz)&#39;);</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Tsys (K)&quot;</span><span class="p">)</span>

        <span class="n">put_legend_in_second_plot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tsys_contamination_intervals</span><span class="p">)):</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_max</span><span class="p">]),</span>
                <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">))]),</span>
                <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="n">default_label</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">put_legend_in_second_plot</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">sci_spw_intervals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span> <span class="k">if</span> <span class="n">sci_spw_intervals</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">sci_spw_intervals</span>
        <span class="k">for</span> <span class="n">spw</span><span class="p">,</span> <span class="n">spw_interval</span> <span class="ow">in</span> <span class="n">sci_spw_intervals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span><span class="n">ax0</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">ax0</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                <span class="n">Rectangle</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">spw_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.04</span><span class="p">),</span>
                    <span class="n">spw_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spw_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
                    <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">ax0</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">spw_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.015</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">ma</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">)</span>
            <span class="c1"># print(f&#39;ax0.add_patch(Rectangle(({spw_interval[0]},{_min}),{spw_interval[1]-spw_interval[0]},1))&#39;)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">other_emphasized_intervals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;alpha&quot;</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">else</span> <span class="mf">0.2</span>
            <span class="n">hatch</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;hatch&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;hatch&quot;</span> <span class="ow">in</span> <span class="n">info</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;intervals&quot;</span><span class="p">])):</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span> <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">color</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                    <span class="n">Rectangle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span>
                        <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="mf">1.1</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">trans</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">hatch</span><span class="o">=</span><span class="n">hatch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="n">trans1</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">blended_transform_factory</span><span class="p">(</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">transData</span><span class="p">,</span> <span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span>
                <span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span>
                    <span class="n">Rectangle</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">),</span>
                        <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="mf">1.1</span><span class="p">,</span>
                        <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                        <span class="n">transform</span><span class="o">=</span><span class="n">trans1</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">hatch</span><span class="o">=</span><span class="n">hatch</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">put_legend_in_second_plot</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">_min</span><span class="p">,</span> <span class="n">_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">normalized_residuals</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">_min</span> <span class="o">-</span> <span class="p">(</span><span class="n">_max</span> <span class="o">-</span> <span class="n">_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="n">_max</span> <span class="o">+</span> <span class="p">(</span><span class="n">_max</span> <span class="o">-</span> <span class="n">_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">15</span><span class="p">)</span>

        <span class="n">ax0</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
        <span class="n">ax0</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">put_legend_in_second_plot</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">secondary_xaxis</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="n">_nu_function</span><span class="p">,</span> <span class="n">_channel_function</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ax0</span><span class="p">,</span> <span class="n">ax1</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ax1_kelvin</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">secondary_yaxis</span><span class="p">(</span>
            <span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">functions</span><span class="o">=</span><span class="p">(</span><span class="k">lambda</span> <span class="n">nt</span><span class="p">:</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">nt</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ax1_kelvin</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[K]&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">normalized_residuals</span><span class="p">,</span> <span class="s2">&quot;.-&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l0</span><span class="p">,</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">level</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">l0</span> <span class="o">=</span> <span class="n">level</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">l0</span> <span class="o">=</span> <span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">l1</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">l0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax0</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">))</span> <span class="o">*</span> <span class="n">l0</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chans</span><span class="p">))</span> <span class="o">*</span> <span class="n">l1</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savefigfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="nb">input</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">savefigfile</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


    <span class="c1">## Integer Intervals manipulation</span>
<div class="viewcode-block" id="puff">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.puff">[docs]</a>
    <span class="k">def</span> <span class="nf">puff</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">chan_avoidance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">puffed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">pufflim0</span><span class="p">,</span> <span class="n">pufflim1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">delta</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">chan_avoidance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pufflim0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">chan_avoidance</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">pufflim0</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">pufflim1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">chan_avoidance</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">pufflim1</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">puffed</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pufflim0</span><span class="p">,</span> <span class="n">pufflim1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">puffed</span><span class="p">)</span></div>


<div class="viewcode-block" id="merge_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.merge_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_intervals</span><span class="p">(</span><span class="n">intervals</span><span class="p">):</span>
        <span class="c1"># Normalize to sorted non-overlaping intervals. Aimilar idea as in</span>
        <span class="c1"># https://www.geeksforgeeks.org/merging-intervals/</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">intervals</span>
        <span class="c1"># print(f&quot;merge_intervals: {intervals} {len(intervals)}&quot;)</span>
        <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">intervals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">intervals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;merge_intervals: intervals not well defined. intervals=</span><span class="si">{</span><span class="n">intervals</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">intervals</span>
        <span class="n">intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># insert first interval into stack</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="c1"># Check for overlapping interval,</span>
            <span class="c1"># if interval overlap</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span></div>


<div class="viewcode-block" id="union_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.union_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">union_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">])</span></div>


<div class="viewcode-block" id="complement_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.complement_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">complement_intervals</span><span class="p">(</span>
        <span class="n">a</span><span class="p">,</span>
    <span class="p">):</span>  <span class="c1"># This is the key function. Needs to work with infinities and empty sets.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>
        <span class="n">a_normalized</span> <span class="o">=</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">result0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">a_normalized</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">result1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">a_normalized</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
        <span class="n">non_empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">result0</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">result1</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">result0</span><span class="p">[</span><span class="n">non_empty</span><span class="p">],</span> <span class="n">result1</span><span class="p">[</span><span class="n">non_empty</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div>


<div class="viewcode-block" id="intersection_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.intersection_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">intersection_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">union_of_complements</span> <span class="o">=</span> <span class="n">union_intervals</span><span class="p">(</span>
            <span class="n">complement_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">complement_intervals</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">complement_intervals</span><span class="p">(</span><span class="n">union_of_complements</span><span class="p">)</span></div>


<div class="viewcode-block" id="difference_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.difference_intervals">[docs]</a>
    <span class="k">def</span> <span class="nf">difference_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">intersection_intervals</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">complement_intervals</span><span class="p">(</span><span class="n">b</span><span class="p">))</span></div>



<div class="viewcode-block" id="save_tsysdata">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.save_tsysdata">[docs]</a>
<span class="k">def</span> <span class="nf">save_tsysdata</span><span class="p">(</span><span class="n">tsysdata</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tsysdata</span><span class="o">.</span><span class="n">tsystable</span><span class="si">}</span><span class="s2">.tsysdata.pbz2&quot;</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;VERSION&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">VERSION</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]),</span>
        <span class="s2">&quot;tsystable&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">tsystable</span><span class="p">,</span>
        <span class="s2">&quot;msfile&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">msfile</span><span class="p">,</span>
        <span class="s2">&quot;tsysfields&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">tsysfields</span><span class="p">,</span>
        <span class="s2">&quot;tsysdata&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">tsysdata</span><span class="p">,</span>
        <span class="s2">&quot;specfields&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">specfields</span><span class="p">,</span>
        <span class="s2">&quot;specdata&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">specdata</span><span class="p">,</span>
        <span class="s2">&quot;absorptionfields&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">absorptionfields</span><span class="p">,</span>
        <span class="s2">&quot;absorptiondata&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">absorptiondata</span><span class="p">,</span>
        <span class="s2">&quot;inversetsysmap&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">inversetsysmap</span><span class="p">,</span>
        <span class="s2">&quot;ch_frq&quot;</span><span class="p">:</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">ch_frq</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">with</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span></div>



<div class="viewcode-block" id="find_prominent_peaks_in_atm">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.find_prominent_peaks_in_atm">[docs]</a>
<span class="k">def</span> <span class="nf">find_prominent_peaks_in_atm</span><span class="p">(</span>
    <span class="n">n_sigma_atm</span><span class="p">,</span> <span class="n">atm_model</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">frequencies</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="c1"># Identify prominent peaks in the atmospheric profile. Ignore CO as a prominent peak.</span>
    <span class="c1"># n_sigma_atm = n_sigma_atm_prominent_peak</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">atm_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">frequencies</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">frequencies</span>
    <span class="n">atm_peak_centers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">atm_model</span><span class="p">)</span>
    <span class="n">newpeaks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">atm_peak_centers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LINES_12C16O</span> <span class="o">-</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
            <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frequencies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequencies</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">newpeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">atm_peak_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newpeaks</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">atm_peak_centers_freq</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">atm_peak_centers</span><span class="p">]</span>
    <span class="n">prominent_peaks_in_atm</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">peak_prominences</span><span class="p">(</span><span class="n">atm_model</span><span class="p">,</span> <span class="n">atm_peak_centers</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">_</span> <span class="o">&gt;</span> <span class="n">n_sigma_atm</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temperature</span><span class="p">)):</span>
        <span class="n">prominent_peaks_in_atm</span> <span class="o">=</span> <span class="n">atm_peak_centers</span><span class="p">[</span>
            <span class="n">_</span> <span class="o">&gt;</span> <span class="n">n_sigma_atm</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Prominent peak at chans </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">prominent_peaks_in_atm</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No prominent peaks in the ATM profile.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prominent_peaks_in_atm</span></div>



<div class="viewcode-block" id="detect_tsys_contamination">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.detect_tsys_contamination">[docs]</a>
<span class="k">def</span> <span class="nf">detect_tsys_contamination</span><span class="p">(</span>
    <span class="n">bandpass</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">atm</span><span class="p">,</span> <span class="n">n_sigma_atm_prominent_peak</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">n_sigma_detection_limit</span><span class="o">=</span><span class="mi">7</span>
<span class="p">):</span>

    <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># avoid mutability.</span>
    <span class="n">bandpass</span> <span class="o">=</span> <span class="n">bandpass</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># subtract_linear_trend</span>
    <span class="n">linear_approximation</span> <span class="o">=</span> <span class="n">linear_trend</span><span class="p">((</span><span class="n">source</span> <span class="o">+</span> <span class="n">bandpass</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">_lin_delta_s</span> <span class="o">=</span> <span class="n">linear_approximation</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">_lin_delta_b</span> <span class="o">=</span> <span class="n">linear_approximation</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bandpass</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">source</span> <span class="o">-=</span> <span class="n">_lin_delta_s</span>
    <span class="n">bandpass</span> <span class="o">-=</span> <span class="n">_lin_delta_b</span>

    <span class="c1"># Estimate some simple noise figures</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">source</span> <span class="o">-</span> <span class="n">bandpass</span>
    <span class="n">sigma_smooth</span> <span class="o">=</span> <span class="n">smoother_sigma</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>
    <span class="c1"># print(f&quot;sigma_smooth={sigma_smooth}&quot;);assert False, &quot;&quot;</span>
    <span class="c1"># Simple ATM model to start with. Obtain t0 and a slope for the dif</span>
    <span class="n">t0</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">base</span> <span class="o">=</span> <span class="n">basic_atm_asymmetric_fit</span><span class="p">(</span>
        <span class="n">dif</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dif</span><span class="p">),</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">atm</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span>
    <span class="p">)</span>  <span class="c1"># v3.3 set min of dif to zero. Include base.</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;t0 = </span><span class="si">%s</span><span class="s2">, slope=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t0</span><span class="p">,</span> <span class="n">slope</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>
    <span class="n">simplemm</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">t0</span> <span class="o">*</span> <span class="n">atm</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span> <span class="o">+</span> <span class="n">base</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">dif</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># v3.3</span>
    <span class="n">channel_percentage_within_simple_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dif</span> <span class="o">-</span> <span class="n">simplemm</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">sigma_smooth</span><span class="p">)</span> <span class="o">/</span> <span class="n">nchan</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;channel percentage within n-sigmas: </span><span class="si">%s%%</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">channel_percentage_within_simple_model</span>
    <span class="p">)</span>

    <span class="c1"># Identify prominent peaks in the atmospheric profile. Ignore CO as a prominent peak.</span>
    <span class="c1"># plt.plot(source,&#39;.-&#39;);#plt.plot(dif);print(sigma_smooth);input()</span>
    <span class="n">prominent_peaks_in_atm</span> <span class="o">=</span> <span class="n">find_prominent_peaks_in_atm</span><span class="p">(</span>
        <span class="n">atm_model</span><span class="o">=</span><span class="n">atm</span><span class="p">,</span>  <span class="c1"># frequencies = freqs_b,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="n">t0</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_smooth</span><span class="p">,</span>
        <span class="n">n_sigma_atm</span><span class="o">=</span><span class="n">n_sigma_atm_prominent_peak</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># First version of residuals</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_smooth</span>
    <span class="n">normres</span> <span class="o">=</span> <span class="p">(</span><span class="n">dif</span> <span class="o">-</span> <span class="n">mm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_smooth</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prominent_peaks_in_atm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">channel_percentage_within_simple_model</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Not simple&quot;</span><span class="p">)</span>
            <span class="n">dega</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">prominent_peaks_in_atm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>  <span class="c1"># v3.5</span>
            <span class="n">dega</span> <span class="o">+=</span> <span class="n">k</span>
            <span class="n">deg_baseline</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">xp_mod</span><span class="p">,</span> <span class="n">baseline_mod</span> <span class="o">=</span> <span class="n">model_break</span><span class="p">(</span>
                <span class="n">atm</span><span class="p">,</span> <span class="n">prominent_peaks_in_atm</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">nchan</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">_dif</span> <span class="o">=</span> <span class="n">dif</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">chi2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                    <span class="n">no_nans</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">_dif</span>
                            <span class="o">-</span> <span class="n">modified_atmospheric_profile</span><span class="p">(</span>
                                <span class="n">model</span><span class="o">=</span><span class="n">atm</span><span class="p">,</span>
                                <span class="n">degree_baseline</span><span class="o">=</span><span class="n">deg_baseline</span><span class="p">,</span>
                                <span class="n">baseline</span><span class="o">=</span><span class="n">baseline_mod</span><span class="p">,</span>
                                <span class="n">scales</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dega</span><span class="p">)),</span>
                                <span class="n">coefficients</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                                <span class="n">segments</span><span class="o">=</span><span class="n">xp_mod</span><span class="p">,</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="o">**</span> <span class="mi">2</span>
                    <span class="o">/</span> <span class="n">sigma_smooth</span><span class="o">**</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">var0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
                        <span class="n">t0</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">deg_baseline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">dega</span> <span class="o">*</span> <span class="n">xp_mod</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">var0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">slope</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">var0</span><span class="p">]</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">var0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">dif</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">dif</span><span class="p">)]))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># lb[1] = 0 if np.sign(np.nanmean(dif))&gt;0 else -np.inf</span>
                    <span class="c1"># ub[1] = 0 if np.sign(np.nanmean(dif))&lt;0 else np.inf</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">deg_baseline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">var0</span><span class="p">)):</span>
                        <span class="n">lb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># if np.sign(np.nanmean(dif))&gt;0 else -np.inf</span>
                        <span class="c1"># ub[i] = 0 if np.sign(np.nanmean(dif))&lt;0 else np.inf</span>
                <span class="k">if</span> <span class="n">prominent_peaks_in_atm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">t0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">t0</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.9</span> <span class="o">*</span> <span class="n">t0</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">t0</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span> <span class="n">var0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">Bounds</span><span class="p">(</span><span class="n">lb</span><span class="o">=</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="o">=</span><span class="n">ub</span><span class="p">))</span>
                <span class="n">baseline</span><span class="p">,</span> <span class="n">modline</span> <span class="o">=</span> <span class="n">modified_atmospheric_profile</span><span class="p">(</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">atm</span><span class="p">,</span>
                    <span class="n">degree_baseline</span><span class="o">=</span><span class="n">deg_baseline</span><span class="p">,</span>
                    <span class="n">baseline</span><span class="o">=</span><span class="n">baseline_mod</span><span class="p">,</span>
                    <span class="n">scales</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dega</span><span class="p">)),</span>
                    <span class="n">coefficients</span><span class="o">=</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span>
                    <span class="n">segments</span><span class="o">=</span><span class="n">xp_mod</span><span class="p">[</span><span class="mi">0</span><span class="p">:],</span>
                    <span class="n">split</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mm</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">+</span> <span class="n">modline</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma_smooth</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">dif</span> <span class="o">*</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">normres</span> <span class="o">=</span> <span class="p">(</span><span class="n">dif</span> <span class="o">-</span> <span class="n">mm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normres</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">_dif</span><span class="p">[</span><span class="n">normres</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">_normres</span> <span class="o">=</span> <span class="n">normres</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_normres</span><span class="p">[</span><span class="n">normres</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">rescale_smooth_sigma_factor</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">smoother_sigma</span><span class="p">(</span><span class="n">_normres</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">),</span> <span class="mf">0.5</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">normres</span><span class="p">[</span><span class="n">prominent_peaks_in_atm</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">n_sigma_detection_limit</span><span class="p">):</span>
            <span class="c1"># print(&quot;**&quot;,normres[prominent_peaks_in_atm])</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;detect_tsys_contamination: re-iterating ATM fitting with higher order.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># print(np.nanmedian(np.abs(dif-mm-np.nanmedian(dif-mm))))</span>

    <span class="n">prominent_peaks_in_atm</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">[]</span> <span class="k">if</span> <span class="n">prominent_peaks_in_atm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">prominent_peaks_in_atm</span>
    <span class="p">)</span>

    <span class="c1"># plt.plot(dif-mm-np.nanmedian(dif-mm)); input();</span>
    <span class="n">normres</span> <span class="o">/=</span> <span class="n">rescale_smooth_sigma_factor</span>
    <span class="n">sigma</span> <span class="o">*=</span> <span class="n">rescale_smooth_sigma_factor</span>

    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">normres</span><span class="p">)</span>
        <span class="nb">input</span><span class="p">()</span>
    <span class="c1"># print(f&quot;spw={spw} medianMin={np.nanmedian(min_science[key])} sigma={sigma} {relative_detection_factor*np.nanmedian(min_science[key]/sigma)}&quot;)</span>
    <span class="c1"># assert False, &quot;&quot;</span>

    <span class="c1"># n_ave = np.sum(intents==intent_dict[field])/len(set(list(spws))) - 2*remove_n_extreme</span>
    <span class="c1"># n_sigma_detection_limit = n_sigma_detection_limit # max(n_sigma_detection_limit, np.nanmedian(delta_tsys_detection_level/sigma)) # v3.1</span>
    <span class="n">pcline_peak_chans</span><span class="p">,</span> <span class="n">pcline_intervals</span> <span class="o">=</span> <span class="n">refitting_intervals_bp_to_source</span><span class="p">(</span>
        <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">bp</span><span class="o">=</span><span class="n">bandpass</span><span class="p">,</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span>
        <span class="n">normalized_data</span><span class="o">=</span><span class="n">normres</span><span class="p">,</span>
        <span class="n">detection_limit</span><span class="o">=</span><span class="n">n_sigma_detection_limit</span><span class="p">,</span>
        <span class="n">base_detection</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># plt.plot(dif);plt.plot(mm);input()</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;contamination_peaks&quot;</span><span class="p">:</span> <span class="n">pcline_peak_chans</span><span class="p">,</span>
        <span class="s2">&quot;contamination_intervals&quot;</span><span class="p">:</span> <span class="n">pcline_intervals</span><span class="p">,</span>
        <span class="s2">&quot;normalized_residuals&quot;</span><span class="p">:</span> <span class="n">normres</span><span class="p">,</span>
        <span class="s2">&quot;sigma&quot;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span>
        <span class="s2">&quot;prominent_atmospheric_peaks_location&quot;</span><span class="p">:</span> <span class="n">prominent_peaks_in_atm</span><span class="p">,</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">mm</span> <span class="o">-</span> <span class="n">_lin_delta_b</span> <span class="o">+</span> <span class="n">_lin_delta_s</span><span class="p">,</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="co_telluric_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.co_telluric_intervals">[docs]</a>
<span class="k">def</span> <span class="nf">co_telluric_intervals</span><span class="p">(</span><span class="n">normalized_spectrum</span><span class="p">,</span> <span class="n">frequencies_mhz</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">normalized_spectrum</span><span class="p">)</span>
    <span class="n">nu0</span><span class="p">,</span> <span class="n">nu1</span><span class="p">,</span> <span class="n">dnu</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frequencies_mhz</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frequencies_mhz</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frequencies_mhz</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">frequencies_mhz</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
    <span class="p">)</span>
    <span class="n">line_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">line_frequencies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CO_LINES_MHZ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">nu0</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">nu1</span><span class="p">:</span>
            <span class="n">line_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">line_frequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_names</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="n">line_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line_frequencies</span><span class="p">)</span>
    <span class="n">peaks</span><span class="p">,</span> <span class="n">prominence_dictionary</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">normalized_spectrum</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frequencies_mhz</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">-</span> <span class="n">line_frequencies</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dnu</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">peaks</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="c1"># assert False, [selection, line_frequencies, np.min(np.abs(frequencies_mhz[np.array(peaks[1])]-line_frequencies)),dnu]</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="n">widths</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">left_ipss</span><span class="p">,</span> <span class="n">right_ipss</span> <span class="o">=</span> <span class="n">peak_widths</span><span class="p">(</span>
        <span class="n">normalized_spectrum</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">rel_height</span><span class="o">=</span><span class="mf">0.5</span>
    <span class="p">)</span>
    <span class="c1"># assert False, peaks</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;co_lines&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;co_line_frequencies&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;ranges&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">left_ips</span><span class="p">,</span> <span class="n">right_ips</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">heights</span><span class="p">,</span> <span class="n">left_ipss</span><span class="p">,</span> <span class="n">right_ipss</span>
    <span class="p">):</span>
        <span class="n">frequency_of_peak</span> <span class="o">=</span> <span class="n">frequencies_mhz</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">CO_LINES_MHZ</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frequency_of_peak</span> <span class="o">-</span> <span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">dnu</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;co_lines&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;co_line_frequencies&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.35</span> <span class="o">*</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.35</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)]</span>
                <span class="p">)</span>
                <span class="k">break</span>
    <span class="n">results</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>



<div class="viewcode-block" id="get_tsys_contaminated_intervals">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.get_tsys_contaminated_intervals">[docs]</a>
<span class="k">def</span> <span class="nf">get_tsys_contaminated_intervals</span><span class="p">(</span>
    <span class="n">tsysdata</span><span class="p">,</span>
    <span class="n">spwlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fieldlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">large_interval_warning_limit</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>  <span class="c1"># % of spectral window covered by line for warning</span>
    <span class="n">n_sigma_atm_prominent_peak</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">savefigfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">remove_n_extreme</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">relative_detection_factor</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>  <span class="c1"># v3.1</span>
    <span class="n">n_sigma_detection_limit</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># START - new function variables introduced for PIPE-2009</span>
    <span class="n">plot_wrappers</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list to hold pipeline plot wrappers.</span>
    <span class="n">qascores</span> <span class="o">=</span> <span class="p">[]</span>       <span class="c1"># list to hold QAScores created alongside warning messages</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">msfile</span>  <span class="c1"># short alias to MS name. new variable added in PIPE-2009.</span>
    <span class="c1"># END - new function variables introduced for PIPE-2009</span>

    <span class="n">warnings_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tsys</span> <span class="o">=</span> <span class="n">tsysdata</span>  <span class="c1">###</span>

    <span class="n">_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tsys</span><span class="o">.</span><span class="n">specdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">specfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;spw&quot;</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="n">spwlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
    <span class="n">spwlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get_tsys_contaminated_intervals. Warning: no spwlist -&gt; no output.&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tsys</span><span class="o">.</span><span class="n">tsysdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">tsysfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="n">fieldlist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fieldlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
    <span class="n">fieldlist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fieldlist</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fieldlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;get_tsys_contaminated_intervals. Warning: no fieldlist -&gt; no output.&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Mean of empty slice&quot;</span><span class="p">)</span>
        <span class="n">average_difference</span><span class="p">,</span> <span class="n">average_science</span><span class="p">,</span> <span class="n">average_bp</span><span class="p">,</span> <span class="n">average_antenna</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">tsys</span><span class="o">.</span><span class="n">filter_statistics_and_dif</span><span class="p">(</span>
                <span class="n">statistics</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">,</span> <span class="n">remove_n_extreme</span><span class="o">=</span><span class="n">remove_n_extreme</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">min_difference</span><span class="p">,</span> <span class="n">min_science</span><span class="p">,</span> <span class="n">min_bp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">filter_statistics_and_dif</span><span class="p">(</span>
            <span class="n">statistics</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">,</span> <span class="n">remove_n_extreme</span><span class="o">=</span><span class="n">remove_n_extreme</span>
        <span class="p">)</span>

    <span class="n">spws</span><span class="p">,</span> <span class="n">intents</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">tsys</span><span class="o">.</span><span class="n">tsysdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">tsysfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spw&quot;</span><span class="p">,</span> <span class="s2">&quot;intent&quot;</span><span class="p">,</span> <span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="n">_</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">intent_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">_</span><span class="p">))</span>

    <span class="n">all_freqs_mhz</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">specdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">specfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;freq_mhz&quot;</span><span class="p">)]</span>
    <span class="n">all_absorption_curves</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">absorptiondata</span><span class="p">[</span>
        <span class="n">tsys</span><span class="o">.</span><span class="n">absorptionfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;absorption&quot;</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">result</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">large_residual</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># assert False, average_science.values()</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">average_science</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">spw</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">spwlist</span><span class="p">,</span> <span class="n">fieldlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scans</span><span class="p">[(</span><span class="n">intents</span> <span class="o">==</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">spws</span> <span class="o">==</span> <span class="n">spw</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">assert</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">),</span> <span class="s2">&quot;get_tsys_contaminated_intervals: more than 1 BP scan per spw in EB!&quot;</span>
        <span class="n">scan_b</span> <span class="o">=</span> <span class="n">_</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">freqs_mhz</span> <span class="o">=</span> <span class="n">all_freqs_mhz</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tsys</span><span class="o">.</span><span class="n">specdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">specfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;spw&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">freqs_b</span> <span class="o">=</span> <span class="n">freqs_mhz</span>  <span class="c1">###</span>

        <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsys</span><span class="o">.</span><span class="n">absorptiondata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">absorptionfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;scan&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">scan_b</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">tsys</span><span class="o">.</span><span class="n">absorptiondata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">absorptionfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;spw&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">spw</span>
        <span class="p">)</span>
        <span class="n">trans_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">all_absorption_curves</span><span class="p">[</span><span class="n">_</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># removes 1 dimension</span>

        <span class="n">nchan</span> <span class="o">=</span> <span class="n">freqs_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chansize_mhz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freqs_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">freqs_b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">n_sigma_detection_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span>  <span class="c1">#### v2.2</span>
        <span class="n">chans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>

        <span class="n">spec_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">average_bp</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">corr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">spec_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">average_science</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">corr</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">_</span> <span class="o">=</span> <span class="n">detect_tsys_contamination</span><span class="p">(</span>
            <span class="n">bandpass</span><span class="o">=</span><span class="n">spec_b</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">spec_s</span><span class="p">,</span>
            <span class="n">atm</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trans_b</span><span class="p">,</span>
            <span class="n">n_sigma_detection_limit</span><span class="o">=</span><span class="n">n_sigma_detection_limit</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">pcline_intervals</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;contamination_intervals&quot;</span><span class="p">]</span>
        <span class="n">pcline_peak_chans</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;contamination_peaks&quot;</span><span class="p">]</span>
        <span class="n">normres</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;normalized_residuals&quot;</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span>
        <span class="n">prominent_peaks_in_atm</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;prominent_atmospheric_peaks_location&quot;</span><span class="p">]</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span>
        <span class="n">dif</span> <span class="o">=</span> <span class="n">spec_s</span> <span class="o">-</span> <span class="n">spec_b</span>

        <span class="c1"># plt.plot(dif);plt.plot(mm);input()</span>

        <span class="n">large_baseline_residual</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sigma_smooth_bp</span><span class="p">,</span> <span class="n">sigma_smooth_s</span> <span class="o">=</span> <span class="n">smoother_sigma</span><span class="p">(</span><span class="n">spec_b</span><span class="p">),</span> <span class="n">smoother_sigma</span><span class="p">(</span><span class="n">spec_s</span><span class="p">)</span>
        <span class="n">sigma_mad_dif</span> <span class="o">=</span> <span class="n">median_abs_deviation</span><span class="p">(</span>
            <span class="n">dif</span> <span class="o">-</span> <span class="n">mm</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span>
        <span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;large_baseline_residual *** </span><span class="se">\n\t</span><span class="s2">sigma_mad_dif,sigma_smooth_bp,sigma_smooth_s,prominent_peaks_in_atm = </span><span class="si">%.2g</span><span class="s2">,</span><span class="si">%.2g</span><span class="s2">,</span><span class="si">%.2g</span><span class="s2">,</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">sigma_mad_dif</span><span class="p">,</span>
            <span class="n">sigma_smooth_bp</span><span class="p">,</span>
            <span class="n">sigma_smooth_s</span><span class="p">,</span>
            <span class="n">prominent_peaks_in_atm</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">chans over 5sigma = </span><span class="si">%s</span><span class="s2">, nchan=</span><span class="si">%s</span><span class="s2">, nchan/4=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">dif</span><span class="o">-</span><span class="n">mm</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">5</span><span class="o">*</span><span class="n">sigma_smooth_bp</span><span class="p">),</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">4</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">dif</span> <span class="o">-</span> <span class="n">mm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_smooth_bp</span><span class="p">)</span>
            <span class="nb">input</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">sigma_mad_dif</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">sigma_smooth_bp</span>
            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">dif</span> <span class="o">-</span> <span class="n">mm</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma_smooth_bp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">nchan</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prominent_peaks_in_atm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">):</span>  <span class="c1"># v3.4</span>
            <span class="n">large_baseline_residual</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">large_residual</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># v3.4</span>
            <span class="n">warning</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Large residuals&quot;</span>
            <span class="n">msg_spw</span><span class="p">,</span> <span class="n">msg_field</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Large residuals detected in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s2">, spw </span><span class="si">{</span><span class="n">msg_spw</span><span class="si">}</span><span class="s2">, field </span><span class="si">{</span><span class="n">msg_field</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">warning</span><span class="p">,</span> <span class="n">message</span><span class="p">])</span>
            <span class="n">qascores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
                    <span class="n">score</span><span class="o">=</span><span class="n">WARNINGS_QA_SCORE</span><span class="p">,</span>
                    <span class="n">shortmsg</span><span class="o">=</span><span class="n">warning</span><span class="p">,</span>
                    <span class="n">longmsg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">applies_to</span><span class="o">=</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">vis</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">msg_spw</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">msg_field</span><span class="p">})</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Large residual detected in </span><span class="si">%s</span><span class="s2"> spw </span><span class="si">%s</span><span class="s2"> field </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">msg_spw</span><span class="p">,</span> <span class="n">msg_field</span><span class="p">)</span>
        <span class="c1"># print(f&quot; sigma_mad_dif={sigma_mad_dif} sigma_smooth_bp = {sigma_smooth_bp} sigma_quot={sigma_smooth_s/sigma_smooth_bp}&quot;)</span>

        <span class="n">co_telluric</span> <span class="o">=</span> <span class="n">co_telluric_intervals</span><span class="p">(</span><span class="n">spec_b</span> <span class="o">/</span> <span class="n">sigma_smooth_bp</span><span class="p">,</span> <span class="n">freqs_b</span><span class="p">)</span>

        <span class="n">speaks</span><span class="p">,</span> <span class="n">prominence_dictionary_source_peaks</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span>
            <span class="n">spec_s</span> <span class="o">/</span> <span class="n">sigma_smooth_s</span><span class="p">,</span>
            <span class="n">prominence</span><span class="o">=</span><span class="n">n_sigma_detection_limit</span>
            <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1920</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">speaks</span> <span class="o">=</span> <span class="n">width_fit_filter</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">spec_s</span> <span class="o">/</span> <span class="n">sigma_smooth_s</span><span class="p">,</span>
            <span class="n">peaks</span><span class="o">=</span><span class="n">speaks</span><span class="p">,</span>
            <span class="n">fwhm_limit</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1920</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="p">(</span><span class="mi">200</span> <span class="o">-</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1920</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">common_peaks1</span><span class="p">,</span> <span class="n">common_peaks2</span><span class="p">,</span> <span class="n">more_info_common_peaks</span> <span class="o">=</span> <span class="n">find_repeated_peaks</span><span class="p">(</span>
            <span class="n">data1</span><span class="o">=</span><span class="n">spec_s</span> <span class="o">/</span> <span class="n">sigma_smooth_s</span><span class="p">,</span>
            <span class="n">data2</span><span class="o">=</span><span class="n">spec_b</span> <span class="o">/</span> <span class="n">sigma_smooth_bp</span><span class="p">,</span>
            <span class="n">prominence</span><span class="o">=</span><span class="n">n_sigma_detection_limit</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="n">width</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">nchan</span> <span class="o">/</span> <span class="mi">64</span><span class="p">),</span>
        <span class="p">)</span>  <span class="c1">#</span>
        <span class="c1"># assert False, more_info_common_peaks</span>
        <span class="c1"># change above difference_tolerance_ratio treatment in v3.3</span>
        <span class="n">delta_tsys_detection_level</span> <span class="o">=</span> <span class="n">relative_detection_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
            <span class="n">min_science</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">corr</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># v3.1</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;common_peaks1=</span><span class="si">%s</span><span class="s2">, common_peaks2=</span><span class="si">%s</span><span class="s2">, pcline_peak_chans=</span><span class="si">%s</span><span class="s2">, pcline_intervals=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">common_peaks1</span><span class="p">,</span>
            <span class="n">common_peaks2</span><span class="p">,</span>
            <span class="n">pcline_peak_chans</span><span class="p">,</span>
            <span class="n">pcline_intervals</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># print(f&quot;speaks={speaks}, prominence_dictionary_source_peaks={prominence_dictionary_source_peaks}&quot;)</span>
        <span class="c1"># plt.plot(spec_s/sigma_smooth_s,&#39;-&#39;);plt.plot(speaks,(spec_s/sigma_smooth_s)[speaks],&#39;.&#39;);input()</span>

        <span class="n">line_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">common_feature_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">possible_line_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">telluric_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atm_residual_intervals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">low_tsys_contamination</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">interval_range_limit</span> <span class="o">=</span> <span class="mf">0.4</span>
        <span class="n">concommitant_peak_max_distance</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2048</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span>
        <span class="k">for</span> <span class="n">pcli</span><span class="p">,</span> <span class="n">pclp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pcline_intervals</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">pcline_peak_chans</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pcli=%s, pclp=%s&quot;</span><span class="p">,</span> <span class="n">pcli</span><span class="p">,</span> <span class="n">pclp</span><span class="p">)</span>
            <span class="n">delta_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">spec_s</span><span class="p">[</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># v3.1</span>
            <span class="n">delta_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">spec_b</span><span class="p">[</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>  <span class="c1"># v3.1</span>
            <span class="n">delta_dif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span>
                <span class="n">spec_s</span><span class="p">[</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">spec_b</span><span class="p">[</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="n">interval_comparison</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delta_s</span><span class="p">,</span> <span class="n">delta_b</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">delta_s</span><span class="p">,</span> <span class="n">delta_b</span><span class="p">)</span>  <span class="c1"># v3.1</span>
            <span class="c1"># assert False, interval_comparison, delta_dif ,delta_tsys_detection_level</span>
            <span class="c1"># v2.3 1 channel tolerance telluric. # v2.5 more tolerance, nchan dependance</span>
            <span class="n">telluric_channel_tolerance</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">telluric_channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span>
                <span class="p">[</span>
                    <span class="n">common_peaks1</span> <span class="o">+</span> <span class="n">_</span>
                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                        <span class="o">-</span><span class="n">telluric_channel_tolerance</span><span class="p">,</span> <span class="n">telluric_channel_tolerance</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="c1"># assert False, (pclp in telluric_channels, pclp, telluric_channels, interval_comparison)</span>
            <span class="c1"># concommitant_peak =</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">pclp</span> <span class="ow">in</span> <span class="n">telluric_channels</span> <span class="ow">and</span> <span class="n">interval_comparison</span> <span class="o">&gt;</span> <span class="n">interval_range_limit</span>
            <span class="p">):</span>  <span class="c1"># v3.1</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freqs_b</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pclp</span><span class="p">)]</span> <span class="o">-</span> <span class="n">LINES_12C16O</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">chansize_mhz</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">interval_comparison</span> <span class="o">&lt;</span> <span class="mf">0.7</span><span class="p">:</span>
                        <span class="n">warning</span> <span class="o">=</span> <span class="s2">&quot;Telluric residuals&quot;</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Large difference between CO Line </span><span class="si">{</span><span class="n">LINES_12C16O</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freqs_b</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pclp</span><span class="p">)]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">LINES_12C16O</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">chansize_mhz</span><span class="p">]</span><span class="si">}</span><span class="s2"> MHz in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s2"> spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">, comparing field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> and bandpass.&quot;</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                        <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">warning</span><span class="p">,</span> <span class="n">message</span><span class="p">])</span>
                        <span class="n">qascores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
                                    <span class="n">score</span><span class="o">=</span><span class="n">WARNINGS_QA_SCORE</span><span class="p">,</span>
                                    <span class="n">shortmsg</span><span class="o">=</span><span class="n">warning</span><span class="p">,</span>
                                    <span class="n">longmsg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Large difference between the bandpass telluric line and field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1"> spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">applies_to</span><span class="o">=</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">vis</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spw</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">})</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">telluric_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">pcli</span> <span class="o">-</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">prominent_peaks_in_atm</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                <span class="p">):</span>
                    <span class="n">atm_residual_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">common_feature_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">pcli</span> <span class="o">-</span> <span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">prominent_peaks_in_atm</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span>
            <span class="p">):</span>  <span class="c1"># v2.3</span>
                <span class="n">atm_residual_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">delta_dif</span> <span class="o">&lt;</span> <span class="n">delta_tsys_detection_level</span><span class="p">:</span>
                <span class="n">low_tsys_contamination</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([(</span><span class="n">sp</span> <span class="o">&lt;=</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">sp</span> <span class="o">&gt;=</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">speaks</span><span class="p">]):</span>
                <span class="n">gaussian_check</span><span class="p">,</span> <span class="n">gaussian_plus_baseline_model</span> <span class="o">=</span> <span class="n">gaussian_line_fit</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                    <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">spec_s</span> <span class="o">/</span> <span class="n">sigma_smooth_s</span><span class="p">)[</span><span class="nb">int</span><span class="p">(</span><span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">_auxipeak</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">gaussian_plus_baseline_model</span><span class="p">)</span>
                <span class="c1"># print(&quot;##&quot;,gaussian_check[0]&lt; n_sigma_detection_limit*((1-0.5)/1920*(nchan-128)+0.5) , not np.any((pcli[1]&gt;_auxipeak)*(_auxipeak &gt; pcli[0])))</span>
                <span class="k">if</span> <span class="n">gaussian_check</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_sigma_detection_limit</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>
                <span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">pcli</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pcli</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_auxipeak</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">_auxipeak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; possible (failed concommitant peak gaussian check)&quot;</span><span class="p">,</span> <span class="n">pcli</span>
                    <span class="p">)</span>
                    <span class="n">possible_line_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> -&gt; recovered peak in gaussian check&quot;</span><span class="p">,</span> <span class="n">pcli</span><span class="p">)</span>
                    <span class="n">line_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;-- pcli=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pcli</span><span class="p">)</span>
                <span class="n">line_intervals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pcli</span><span class="p">)</span>

        <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">line_intervals</span><span class="p">)</span>

        <span class="n">possible_line_intervals</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">possible_line_intervals</span><span class="p">),</span> <span class="n">line_intervals</span>
        <span class="p">)</span>
        <span class="c1"># telluric_intervals = difference_intervals(np.array(telluric_intervals),line_intervals) # commented in v3.3</span>
        <span class="n">telluric_intervals</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">telluric_intervals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">telluric_intervals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="p">)</span>  <span class="c1"># v3.3</span>
        <span class="n">atm_residual_intervals</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atm_residual_intervals</span><span class="p">),</span> <span class="n">line_intervals</span>
        <span class="p">)</span>
        <span class="n">common_feature_intervals</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">common_feature_intervals</span><span class="p">),</span> <span class="n">line_intervals</span>
        <span class="p">)</span>
        <span class="n">low_tsys_contamination</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">low_tsys_contamination</span><span class="p">),</span> <span class="n">line_intervals</span>
        <span class="p">)</span>

        <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">puff</span><span class="p">(</span>
            <span class="n">line_intervals</span><span class="p">,</span>
            <span class="n">delta</span><span class="o">=</span><span class="nb">int</span><span class="p">((</span><span class="mi">16</span> <span class="o">-</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4096</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">128</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">nchan</span><span class="o">=</span><span class="n">nchan</span><span class="p">,</span>  <span class="c1">### v2.2</span>
            <span class="n">chan_avoidance</span><span class="o">=</span><span class="n">common_peaks1</span><span class="p">[</span>
                <span class="n">peak_prominences</span><span class="p">(</span><span class="n">spec_b</span><span class="p">,</span> <span class="n">common_peaks1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">&gt;</span> <span class="n">n_sigma_detection_limit</span> <span class="o">*</span> <span class="n">sigma_smooth_bp</span>
            <span class="p">],</span>
        <span class="p">)</span>  <span class="c1">### v3.3</span>

        <span class="n">labeling</span><span class="p">,</span> <span class="n">number_of_intervals</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">normres</span> <span class="o">&gt;</span> <span class="n">n_sigma_detection_limit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">number_of_intervals</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">auxiliary_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="n">labeling</span> <span class="o">==</span> <span class="n">l</span><span class="p">]),</span> <span class="nb">max</span><span class="p">(</span><span class="n">chans</span><span class="p">[</span><span class="n">labeling</span> <span class="o">==</span> <span class="n">l</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">number_of_intervals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">auxiliary_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">interval</span>
                    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">auxiliary_intervals</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersection_intervals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">interval</span><span class="p">]),</span> <span class="n">line_intervals</span><span class="p">))</span>
                    <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">union_intervals</span><span class="p">(</span><span class="n">line_intervals</span><span class="p">,</span> <span class="n">auxiliary_intervals</span><span class="p">)</span>
        <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
            <span class="n">line_intervals</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">telluric_intervals</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># v3.3</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">co_telluric</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">difference_intervals</span><span class="p">(</span>
                <span class="n">line_intervals</span><span class="p">,</span> <span class="n">co_telluric</span><span class="p">[</span><span class="s2">&quot;ranges&quot;</span><span class="p">]</span>
            <span class="p">)</span>  <span class="c1"># v3.5</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;telluric_intervals: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">telluric_intervals</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;line_intervals: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">line_intervals</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;possible_line_intervals: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">possible_line_intervals</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;low_tsys_contamination: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">low_tsys_contamination</span><span class="p">)</span>
        <span class="c1"># puff the intervals by 1 channel for 12M and several if the thing has more channels</span>
        <span class="n">off_science_line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[]])</span>
        <span class="n">interval_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;telluric_intervals&quot;</span><span class="p">:</span> <span class="n">telluric_intervals</span><span class="p">,</span>
            <span class="s2">&quot;possible_line_intervals&quot;</span><span class="p">:</span> <span class="n">possible_line_intervals</span><span class="p">,</span>
            <span class="s2">&quot;low_tsys_contamination&quot;</span><span class="p">:</span> <span class="n">low_tsys_contamination</span><span class="p">,</span>
            <span class="s2">&quot;line_intervals&quot;</span><span class="p">:</span> <span class="n">line_intervals</span><span class="p">,</span>
            <span class="s2">&quot;atm_residual_intervals&quot;</span><span class="p">:</span> <span class="n">atm_residual_intervals</span><span class="p">,</span>
            <span class="s2">&quot;common_feature_intervals&quot;</span><span class="p">:</span> <span class="n">common_feature_intervals</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">interval_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">separate_non_intersecting_sci_spw</span><span class="p">(</span><span class="n">tsys</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">tsysspw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
            <span class="n">interval_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># print(f&quot;{off_science_line_intervals} {_[&#39;off&#39;]}&quot;)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">off_science_line_intervals</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">off_science_line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">off_science_line_intervals</span><span class="p">,</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">off_science_line_intervals</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]</span>

                <span class="n">off_science_line_intervals</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;off&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># assert False, off_science_line_intervals</span>
        <span class="n">sci_spw_intervals_in_tsys_channels</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;sci_intervals&quot;</span><span class="p">]</span>
        <span class="n">telluric_intervals</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;telluric_intervals&quot;</span><span class="p">]</span>
        <span class="n">possible_line_intervals</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;possible_line_intervals&quot;</span><span class="p">]</span>
        <span class="n">low_tsys_contamination</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;low_tsys_contamination&quot;</span><span class="p">]</span>
        <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;line_intervals&quot;</span><span class="p">]</span>
        <span class="n">atm_residual_intervals</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;atm_residual_intervals&quot;</span><span class="p">]</span>
        <span class="n">common_feature_intervals</span> <span class="o">=</span> <span class="n">interval_dict</span><span class="p">[</span><span class="s2">&quot;common_feature_intervals&quot;</span><span class="p">]</span>

        <span class="c1"># print(f&quot;*#* {line_intervals} {line_intervals.shape} {possible_line_intervals} {possible_line_intervals.shape}&quot;)</span>
        <span class="c1"># Large intervals are only &quot;possible&quot;</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">line_intervals</span><span class="p">:</span>
            <span class="n">relative_channel_width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">freqs_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">freqs_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">wide</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">velocity_width_kms</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">relative_channel_width</span> <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="p">)</span>
            <span class="n">dv_criterion</span> <span class="o">=</span> <span class="n">velocity_width_kms</span> <span class="o">&gt;=</span> <span class="n">MAX_VELOCITY_WIDTH</span>
            <span class="n">spw_percentage_criterion</span> <span class="o">=</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">nchan</span> <span class="o">*</span> <span class="n">large_interval_warning_limit</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">spw_percentage_criterion</span> <span class="ow">or</span> <span class="n">dv_criterion</span><span class="p">:</span>  <span class="c1"># based on Dame&#39;s CO 1-0 map.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">possible_line_intervals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">possible_line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">possible_line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">possible_line_intervals</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">wide</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">warning</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Wide line contamination&quot;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="sa">f</span><span class="s2">&quot;Channel range </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">~</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="si">}</span><span class="s2"> equivalent to&quot;</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">velocity_width_kms</span><span class="si">:</span><span class="s2">.3g</span><span class="si">}</span><span class="s2"> km/s &gt; </span><span class="si">{</span><span class="n">MAX_VELOCITY_WIDTH</span><span class="si">}</span><span class="s2"> km/s&quot;</span>
                            <span class="k">if</span> <span class="n">dv_criterion</span>
                            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">nchan</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2">% of the spw&quot;</span>
                        <span class="p">),</span>
                        <span class="sa">f</span><span class="s2">&quot;in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s2">, spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">, field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>

                <span class="n">warnings_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">warning</span><span class="p">,</span> <span class="n">message</span><span class="p">])</span>
                <span class="n">qascores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">(</span>
                        <span class="n">score</span><span class="o">=</span><span class="n">WARNINGS_QA_SCORE</span><span class="p">,</span>
                        <span class="n">shortmsg</span><span class="o">=</span><span class="n">warning</span><span class="p">,</span>
                        <span class="n">longmsg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Astrophysical line contamination covering a wide frequency range in </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s1">, spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">, field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">,</span>
                        <span class="n">applies_to</span><span class="o">=</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">TargetDataSelection</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="p">{</span><span class="n">vis</span><span class="p">},</span> <span class="n">spw</span><span class="o">=</span><span class="p">{</span><span class="n">spw</span><span class="p">},</span> <span class="n">field</span><span class="o">=</span><span class="p">{</span><span class="n">field</span><span class="p">})</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Astronomical contamination covering a wide frequency range. </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Range </span><span class="si">%s</span><span class="s2"> equivalent to </span><span class="si">%s</span><span class="s2"> km/s or </span><span class="si">%d%%</span><span class="s2"> of the SpW&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">velocity_width_kms</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">nchan</span><span class="o">*</span><span class="mi">100</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">wide</span><span class="p">:</span>
                <span class="n">_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">line_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
        <span class="c1"># possible_line_intervals = merge(possible_line_intervals</span>
        <span class="c1"># assert False, f&quot;{line_intervals} {line_intervals.shape} {possible_line_intervals} {possible_line_intervals.shape}&quot;</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">large_baseline_residual</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> large_baseline_residual: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">large_baseline_residual</span><span class="p">)</span>
            <span class="n">plot_figfile</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">savefigfile</span><span class="si">}</span><span class="s2">_spw</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">_field</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">.png&quot;</span> <span class="k">if</span> <span class="n">savefigfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">plot_source_bp_normalized_residuals</span><span class="p">(</span>
                <span class="n">source_tsys</span><span class="o">=</span><span class="n">spec_s</span><span class="p">,</span>
                <span class="n">bandpass_tsys</span><span class="o">=</span><span class="n">spec_b</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">mm</span><span class="p">,</span>
                <span class="n">frequencies</span><span class="o">=</span><span class="n">freqs_b</span> <span class="o">/</span> <span class="mf">1e3</span><span class="p">,</span>
                <span class="n">sigma</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">sigma</span><span class="p">),</span>  <span class="c1"># freqs in GHz. sigma. v3.1</span>
                <span class="c1"># level=(None,n_sigma_detection_limit),</span>
                <span class="n">normalized_residuals</span><span class="o">=</span><span class="n">normres</span><span class="p">,</span>
                <span class="n">tsys_contamination_intervals</span><span class="o">=</span><span class="n">merge_intervals</span><span class="p">(</span><span class="n">line_intervals</span><span class="p">),</span>
                <span class="n">first_plot_title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tsys</span><span class="o">.</span><span class="n">msfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">: spw</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1"> field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s1"> intent=</span><span class="si">{</span><span class="n">intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">background</span><span class="o">=</span><span class="s2">&quot;mistyrose&quot;</span> <span class="k">if</span> <span class="n">large_baseline_residual</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># v3.3</span>
                <span class="n">savefigfile</span><span class="o">=</span><span class="n">plot_figfile</span><span class="p">,</span>
                <span class="n">label_source</span><span class="o">=</span><span class="n">intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                <span class="n">other_emphasized_intervals</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;Tsys contamination?&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">possible_line_intervals</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;Telluric&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">telluric_intervals</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;Off science&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;aquamarine&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">off_science_line_intervals</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;ATM residual&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#6a4530&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">atm_residual_intervals</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;Common BP feature&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;#6a4530&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">common_feature_intervals</span><span class="p">),</span>
                    <span class="p">},</span>
                    <span class="sa">f</span><span class="s2">&quot;dT/T&lt;</span><span class="si">{</span><span class="n">relative_detection_factor</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;purple&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;hatch&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;intervals&quot;</span><span class="p">:</span> <span class="n">low_tsys_contamination</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">},</span>
                <span class="n">sci_spw_intervals</span><span class="o">=</span><span class="n">sci_spw_intervals_in_tsys_channels</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">plot_figfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plot_figfile</span><span class="p">):</span>
                <span class="n">wrapper</span> <span class="o">=</span> <span class="n">pllogger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span>
                    <span class="n">plot_figfile</span><span class="p">,</span>
                    <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span>
                    <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;tsys&#39;</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tsysdata</span><span class="o">.</span><span class="n">msfile</span><span class="p">),</span>
                        <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span>
                        <span class="s1">&#39;tsys_spw&#39;</span><span class="p">:</span> <span class="n">spw</span><span class="p">,</span>
                        <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="n">intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">plot_wrappers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>

        <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;possible_tsys_contamination&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">possible_line_intervals</span><span class="p">),</span>
            <span class="s2">&quot;telluric&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">telluric_intervals</span><span class="p">),</span>
            <span class="s2">&quot;atm_residual&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">atm_residual_intervals</span><span class="p">),</span>
            <span class="s2">&quot;tsys_contamination&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span><span class="n">line_intervals</span><span class="p">),</span>
            <span class="s2">&quot;tsys_contamination_offscience&quot;</span><span class="p">:</span> <span class="n">merge_intervals</span><span class="p">(</span>
                <span class="n">off_science_line_intervals</span>
            <span class="p">),</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">warnings_list</span><span class="p">,</span> <span class="n">plot_wrappers</span><span class="p">,</span> <span class="n">qascores</span></div>



<div class="viewcode-block" id="separate_non_intersecting_sci_spw">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.separate_non_intersecting_sci_spw">[docs]</a>
<span class="k">def</span> <span class="nf">separate_non_intersecting_sci_spw</span><span class="p">(</span><span class="n">tsysdata</span><span class="p">,</span> <span class="n">chan_tsys_intervals</span><span class="p">,</span> <span class="n">tsysspw</span><span class="p">):</span>  <span class="c1"># v2.4</span>
    <span class="n">intervals</span> <span class="o">=</span> <span class="n">chan_tsys_intervals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">scispws</span> <span class="o">=</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">inversetsysmap</span><span class="p">[</span><span class="n">tsysspw</span><span class="p">]</span>
    <span class="n">scispws_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                <span class="n">tsysdata</span><span class="o">.</span><span class="n">msspec</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">tsysdata</span><span class="o">.</span><span class="n">msspec</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scispws</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="n">scispws_intervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tsysdata</span><span class="o">.</span><span class="n">msspec</span><span class="p">[</span><span class="n">tsysspw</span><span class="p">][</span><span class="mi">1</span><span class="p">](</span><span class="n">scispws_intervals</span><span class="p">))</span>
    <span class="n">puffedscispws_intervals</span> <span class="o">=</span> <span class="n">scispws_intervals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">puffedscispws_intervals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">puffedscispws_intervals</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">puffedscispws_intervals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">puffedscispws_intervals</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">intersect</span><span class="p">,</span> <span class="n">non_intersect</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span>
                <span class="n">intersection_intervals</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">puffedscispws_intervals</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
            <span class="p">)</span>
            <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="p">):</span>
            <span class="n">non_intersect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersect</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;in&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intersect</span><span class="p">),</span>
        <span class="s2">&quot;off&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">non_intersect</span><span class="p">),</span>
        <span class="s2">&quot;sci_intervals&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="p">((</span><span class="n">spw</span><span class="p">,</span> <span class="n">scispws_intervals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scispws</span><span class="p">))</span>
        <span class="p">),</span>
    <span class="p">}</span></div>



<div class="viewcode-block" id="intervals_to_casa_string">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.intervals_to_casa_string">[docs]</a>
<span class="k">def</span> <span class="nf">intervals_to_casa_string</span><span class="p">(</span>
    <span class="n">intervals</span><span class="p">,</span> <span class="n">scaled_array</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;.0f&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">scaled_array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">scaled_array</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intervals</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">intervals</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))):</span>
        <span class="n">l0</span><span class="p">,</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">intervals</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">intervals</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">l1</span> <span class="o">&gt;=</span> <span class="n">l0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Inconsistency in integer_set_to_casa_string. </span><span class="si">{</span><span class="n">l0</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">l1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">rs</span> <span class="o">+=</span> <span class="s2">&quot;;&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">scaled_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l0</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="n">scaled_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l1</span><span class="p">)]:</span>
            <span class="n">l0</span><span class="p">,</span> <span class="n">l1</span> <span class="o">=</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l0</span>  <span class="c1"># v3.4</span>
        <span class="n">rs</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaled_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l0</span><span class="p">)]</span><span class="si">:{</span><span class="nb">format</span><span class="si">}}</span><span class="s2">~</span><span class="si">{</span><span class="n">scaled_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l1</span><span class="p">)]</span><span class="si">:{</span><span class="nb">format</span><span class="si">}}{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">l0</span> <span class="o">!=</span> <span class="n">l1</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaled_array</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">l0</span><span class="p">)]</span><span class="si">:{</span><span class="nb">format</span><span class="si">}}{</span><span class="n">unit</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>  <span class="c1"># l0!=l1 v3.4</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">rs</span></div>



<div class="viewcode-block" id="make_tsyscontamination_html_log">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.make_tsyscontamination_html_log">[docs]</a>
<span class="k">def</span> <span class="nf">make_tsyscontamination_html_log</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;TsysCont&quot;</span><span class="p">):</span>

    <span class="n">txtfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;uid___*.ms_tsys_contamination.txt&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">txtfiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">logdirname</span> <span class="o">=</span> <span class="s2">&quot;tsys_contamination_log&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">logdirname</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">logdirname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">logdirname</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdirname</span><span class="p">,</span> <span class="s2">&quot;txtstyle.css&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;html, body { font-family: Helvetica, Arial, sans-serif; white-space: pre-wrap; font-size:15}</span>
<span class="sd">hr.thick {border: 1px solid;}</span>
<span class="sd">hr.double{border: 2px double;}</span>
<span class="sd">&quot;&quot;&quot;</span>
        <span class="p">)</span>
    <span class="n">my_html</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logdirname</span><span class="p">,</span> <span class="s2">&quot;index.html&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;&lt;title&gt;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&lt;/title&gt;</span><span class="se">\n</span><span class="s1">&lt;link href=&quot;txtstyle.css&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="p">)</span>
    <span class="n">version_written</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">txtfile</span> <span class="ow">in</span> <span class="n">txtfiles</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(uid\S+(X\S+).ms)_tsys_contamination.txt&quot;</span><span class="p">,</span> <span class="n">txtfile</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;tsys cont file with bad name?&quot;</span>
        <span class="c1"># if not m: continue</span>
        <span class="n">msfile</span><span class="p">,</span> <span class="n">lid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txtfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">rr</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">rr</span><span class="p">:</span>
                <span class="c1"># print(l,&#39;version&#39; in l, version_written, not(&#39;version&#39; in l and version_written))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">l</span> <span class="ow">and</span> <span class="n">version_written</span><span class="p">):</span>
                    <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">version_written</span> <span class="o">=</span> <span class="n">version_written</span> <span class="ow">or</span> <span class="s2">&quot;version&quot;</span> <span class="ow">in</span> <span class="n">l</span>

    <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;hr class=&quot;double&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">txtfile</span> <span class="ow">in</span> <span class="n">txtfiles</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(uid\S+(X\S+).ms)_tsys_contamination.txt&quot;</span><span class="p">,</span> <span class="n">txtfile</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">m</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span>
        <span class="c1"># if not m: continue</span>
        <span class="n">msfile</span><span class="p">,</span> <span class="n">lid</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">txtfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">rr</span><span class="p">:</span>
            <span class="n">txtfile_content</span> <span class="o">=</span> <span class="n">rr</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="c1"># print(f&quot; txtfile:{txtfile_content}&quot;)</span>
        <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">txtfile_content</span><span class="p">)</span>
        <span class="n">pngs</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msfile</span><span class="si">}</span><span class="s2">_tsys_contamination_spw*_field*.png&quot;</span><span class="p">)</span>
        <span class="n">pngs</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pngfile</span> <span class="ow">in</span> <span class="n">pngs</span><span class="p">:</span>
            <span class="n">copy2</span><span class="p">(</span><span class="n">pngfile</span><span class="p">,</span> <span class="n">logdirname</span><span class="p">)</span>
            <span class="c1"># print(f&quot;{os.path.join(&#39;..&#39;,pngfile)}&quot;)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)</span>  <span class="c1"># v3.3. Cleaner working folder.</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pngfile</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;img src=&quot;</span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="s1">&quot; alt=&quot;</span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="s1">&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">my_html</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;hr class=&quot;thick&quot;&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">my_html</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.tsys_contamination.main">[docs]</a>
<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">testtables</span> <span class="o">=</span> <span class="p">[</span>  <span class="c1">#&#39;uid___A002_Xfaf3de_X1ede.ms.h_tsyscal.s6_1.tsyscal.tbl&#39;, #not ok needs pipeline run</span>
        <span class="s2">&quot;uid___A002_Xf6b678_X617.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf73568_X1c47.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. wide line</span>
        <span class="s2">&quot;uid___A002_Xf73ead_X1d0f.ms.h_tsyscal.s6_3.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. Wide line.</span>
        <span class="s2">&quot;uid___A002_Xf0fd41_Xe61c.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X1018459_X1249c.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xfc69ac_X711a.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf87688_Xc13.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. Small features and off-science spws. Off science before</span>
        <span class="s2">&quot;uid___A002_Xf8b429_X4bf7.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X103beb6_X293.ms.h_tsyscal.s6_2.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf138ff_X19f7.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf624a9_X5a2.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X1015532_X2103d.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf99bb0_X14d02.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X104d6df_X7e2d.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. TM spectra.</span>
        <span class="s2">&quot;uid___A002_X10239e1_X6f31.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X1020da2_X452f.ms.h_tsyscal.s6_3.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X10239e1_X44ce.ms.h_tsyscal.s6_11.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xfc434c_X2394.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. B9</span>
        <span class="s2">&quot;uid___A002_X1060df2_X706b.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xf4073d_X2613.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_Xfca6fd_X3be8.ms.h_tsyscal.s6_3.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X1035744_X12b8.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok . ATM residual spw32</span>
        <span class="s2">&quot;uid___A002_X1066403_X30ae.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. Large baseline residual. Very wide contamination.</span>
        <span class="s2">&quot;uid___A002_X107649f_X10cc.ms.h_tsyscal.s6_11.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok ATM residual spw38. Large baseline residual spw28. #&#39;uid___A002_X106e53c_X2c99.ms.h_tsyscal.s6_9.tsyscal.tbl&#39;,#ok</span>
        <span class="s2">&quot;uid___A002_X10bc7d4_X396b.ms.h_tsyscal.s6_15.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1">#&#39;uid___A002_X10a1d0b_X3c23.ms.h_tsyscal.s6_2.tsyscal.tbl&#39;,   # ok. Large telluric residual</span>
        <span class="s2">&quot;uid___A002_X10ac6bc_Xc408.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># single pol . ok.</span>
        <span class="s2">&quot;uid___A002_X10bc7d4_Xadb8.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok. Common BP feature.</span>
        <span class="s2">&quot;uid___A002_X10b6f7c_X1c306.ms.h_tsyscal.s6_3.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X10cc13c_Xcd9b.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># ok</span>
        <span class="s2">&quot;uid___A002_X10ded83_X9793.ms.h_tsyscal.s6_3.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1">#</span>
        <span class="s2">&quot;uid___A002_X1096e27_X3b01.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># telluric near range</span>
        <span class="s2">&quot;uid___A002_X10eb7e9_X7c12.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># telluric on top of contaminated range in spw26</span>
        <span class="s2">&quot;uid___A002_X10ed869_Xde7.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span><span class="p">,</span>  <span class="c1"># &#39;uid___A002_X10ed869_Xde7_flagged.ms.h_tsyscal.s6_1.tsyscal.tbl&#39;,</span>
    <span class="p">]</span>
    <span class="n">tsystables</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">testtables</span>
        <span class="k">if</span> <span class="s2">&quot;testing&quot;</span> <span class="ow">in</span> <span class="n">VERSION</span>
        <span class="k">else</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;uid___*.ms.h_tsyscal.*.tsyscal.tbl&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c1"># random.shuffle(tsystables)</span>
    <span class="k">for</span> <span class="n">tsystable</span> <span class="ow">in</span> <span class="n">tsystables</span><span class="p">[</span><span class="mi">0</span><span class="p">:]:</span>
        <span class="n">tsys</span> <span class="o">=</span> <span class="n">TsysData</span><span class="p">(</span>
            <span class="n">tsystable</span><span class="o">=</span><span class="n">tsystable</span><span class="p">,</span>
            <span class="n">load_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">single_polarization</span><span class="o">=</span><span class="p">(</span>
                <span class="n">tsystable</span> <span class="o">==</span> <span class="s2">&quot;uid___A002_X10ac6bc_Xc408.ms.h_tsyscal.s6_1.tsyscal.tbl&quot;</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="p">[</span><span class="n">spws</span><span class="p">,</span> <span class="n">intents</span><span class="p">,</span> <span class="n">scans</span><span class="p">,</span> <span class="n">fields</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">tsys</span><span class="o">.</span><span class="n">tsysdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">tsysfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;spw&quot;</span><span class="p">,</span> <span class="s2">&quot;intent&quot;</span><span class="p">,</span> <span class="s2">&quot;scan&quot;</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">field_intent_dict</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">scan_field_dict</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">intents</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">scans</span><span class="p">):</span>
            <span class="n">field_intent_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
            <span class="n">scan_field_dict</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
        <span class="n">field_intent_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">field_intent_dict</span><span class="p">))</span>
        <span class="n">scan_field_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">scan_field_dict</span><span class="p">))</span>
        <span class="n">field_scanlist_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">scan_field_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field_scanlist_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="n">file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tsys</span><span class="o">.</span><span class="n">tsystable</span><span class="si">}</span><span class="s2">.tsysdata.pbz2&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">save_tsysdata</span><span class="p">(</span><span class="n">tsys</span><span class="p">)</span>
        <span class="n">baktbl</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tsystable</span><span class="si">}</span><span class="s2">.bak&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">baktbl</span><span class="p">):</span>
            <span class="c1"># rmtree(baktbl)</span>
            <span class="n">copytree</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">baktbl</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">),</span> <span class="n">tsys</span><span class="o">.</span><span class="n">msfile</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">))</span>  <span class="c1"># v2.3</span>
        <span class="n">line_contamination_intervals</span><span class="p">,</span> <span class="n">warnings_list</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_tsys_contaminated_intervals</span><span class="p">(</span>
            <span class="n">tsys</span><span class="p">,</span>
            <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># large baseline residual v3.3</span>
            <span class="c1"># spwlist=[np.int(30)],fieldlist=[np.int64(2)],# this selection does not work with the saved spool sample</span>
            <span class="n">remove_n_extreme</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">relative_detection_factor</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">savefigfile</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tsys</span><span class="o">.</span><span class="n">msfile</span><span class="si">}</span><span class="s2">_tsys_contamination&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># assert False, &quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">line_contamination_intervals</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">vv</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">()]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">line_contamination_intervals</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="n">all_freqs_mhz</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">specdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">specfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;freq_mhz&quot;</span><span class="p">)]</span>

        <span class="n">output_file</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">msfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">,</span> <span class="s2">&quot;.ms_tsys_contamination.txt&quot;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">flagtsystemplate_file</span> <span class="o">=</span> <span class="n">tsys</span><span class="o">.</span><span class="n">msfile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.ms&quot;</span><span class="p">,</span> <span class="s2">&quot;.flagtsystemplate.txt&quot;</span><span class="p">)</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">flagtsystemplate_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>

        <span class="n">pl_run_dir</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;.*([0-9]</span><span class="si">{4}</span><span class="s2">\..\.[0-9]</span><span class="si">{5}</span><span class="s2">\.[^_]+_[0-9]</span><span class="si">{4}</span><span class="s2">_[0-9]</span><span class="si">{2}</span><span class="s2">_[0-9]</span><span class="si">{2}</span><span class="s2">T[0-9]</span><span class="si">{2}</span><span class="s2">_[0-9]</span><span class="si">{2}</span><span class="s2">_[0-9]</span><span class="si">{2}</span><span class="s2">\.[0-9]+).*&quot;</span><span class="p">,</span>
            <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">pl_run_dir</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;In pipeline working dir: saving timestamp code </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">pl_run_dir</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"># script version </span><span class="si">{</span><span class="n">VERSION</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">pl_run_dir</span><span class="si">}</span><span class="se">\n</span><span class="s2"># </span><span class="si">{</span><span class="n">tsystable</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">field_contamination</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">line_contamination_intervals</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?P&lt;spw&gt;[0-9]+)_(?P&lt;field&gt;[0-9]+)&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">spw</span><span class="p">,</span> <span class="n">field</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">field_contamination</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">spw</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_contamination</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;## No tsys contamination identified.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>

        <span class="c1"># v3.3 large baseline residual</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warnings_list</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;# </span><span class="si">{</span><span class="n">_</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">field_contamination</span><span class="p">:</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">spw_ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spw_ranges_freq</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">field_contamination</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">field_intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;bandpass&quot;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
                <span class="n">freqs_ghz</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">all_freqs_mhz</span><span class="p">[</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">tsys</span><span class="o">.</span><span class="n">specdata</span><span class="p">[</span><span class="n">tsys</span><span class="o">.</span><span class="n">specfields</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;spw&quot;</span><span class="p">)]</span> <span class="o">==</span> <span class="n">spw</span><span class="p">)[</span>
                            <span class="mi">0</span>
                        <span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="o">/</span> <span class="mi">1000</span>
                <span class="p">)</span>
                <span class="n">rs</span> <span class="o">=</span> <span class="n">intervals_to_casa_string</span><span class="p">(</span>
                    <span class="n">line_contamination_intervals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;tsys_contamination&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">rsf</span> <span class="o">=</span> <span class="n">intervals_to_casa_string</span><span class="p">(</span>
                    <span class="n">line_contamination_intervals</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s2">&quot;tsys_contamination&quot;</span><span class="p">],</span>
                    <span class="n">scaled_array</span><span class="o">=</span><span class="n">freqs_ghz</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;GHz&quot;</span><span class="p">,</span>
                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;.3f&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">rs</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">spw_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">rs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">spw_ranges_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">rsf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_ranges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># v2.2</span>
            <span class="n">spw_ranges</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spw_ranges</span><span class="p">)</span>
            <span class="n">spw_ranges_freq</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spw_ranges_freq</span><span class="p">)</span>
            <span class="n">contamination_scans</span> <span class="o">=</span> <span class="n">field_scanlist_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
            <span class="n">contamination_scans</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">_</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;## </span><span class="si">{</span><span class="n">tsystable</span><span class="si">}</span><span class="s2">: field=</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">, intent=</span><span class="si">{</span><span class="n">field_intent_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># for warn_ in warnings_list:</span>
            <span class="c1">#     _ += f&quot;#{warn_}\n&quot;</span>
            <span class="n">_</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;# Frequency ranges: &#39;</span><span class="si">{</span><span class="n">spw_ranges_freq</span><span class="si">}</span><span class="s2">&#39; </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">flagline</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;# mode=&#39;manual&#39; scan=&#39;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">sc</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">contamination_scans</span><span class="p">])</span><span class="si">}</span><span class="s2">&#39; spw=&#39;</span><span class="si">{</span><span class="n">spw_ranges</span><span class="si">}</span><span class="s2">&#39; reason=&#39;Tsys:tsysflag_tsys_channel&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">_</span> <span class="o">+=</span> <span class="n">flagline</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
            <span class="n">ft</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">flagline</span><span class="p">)</span>

        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">ft</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">make_tsyscontamination_html_log</span><span class="p">():</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Log folder created.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;testing&quot;</span> <span class="ow">in</span> <span class="n">VERSION</span> <span class="ow">or</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="s2">&quot;rsync&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;-uva&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;tsys_contamination_log&quot;</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;SPOOLAREA&quot;</span><span class="p">],</span> <span class="s2">&quot;PIPEREQ-49&quot;</span><span class="p">,</span> <span class="s2">&quot;PIPEREQ-232/&quot;</span><span class="p">),</span>
                <span class="p">],</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span></div>



<span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>  <span class="c1"># v2.3</span>
    <span class="k">if</span> <span class="s2">&quot;testing&quot;</span> <span class="ow">in</span> <span class="n">VERSION</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span>
            <span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span>
        <span class="p">)</span>  <span class="c1"># ignore these warnings which are not very useful</span>
    <span class="c1"># main()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>