

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.extern.findContinuum &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.extern.findContinuum</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.extern.findContinuum</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This file implements the algorithm to determine continuum channel ranges to </span>
<span class="sd">use from an ALMA image cube (dirty or clean) in CASA format.  All dependencies </span>
<span class="sd">on what were originally analysisUtils functions have been pasted into this </span>
<span class="sd">file for convenience.  This function is meant to be run inside CASA.  </span>
<span class="sd">Simple usage:</span>
<span class="sd">  import findContinuum as fc</span>
<span class="sd">  fc.findContinuum(&#39;my_dirty_cube.image&#39;)</span>
<span class="sd">This file can be found in a typical pipeline distribution directory, e.g.:</span>
<span class="sd">/lustre/naasc/sciops/comm/rindebet/pipeline/branches/trunk/pipeline/extern</span>
<span class="sd">As of March 7, 2019 (version 3.36), it is compatible with both python 2 and 3.</span>

<span class="sd">Code changes for Pipeline2025 (as of July 24, 2024)</span>
<span class="sd">0) Fix crash in recalcMomDiffSNR (not used by pipeline)</span>
<span class="sd">1) Prevent crash due to no pyfits module available in CASA 6.6.6.</span>
<span class="sd">2) Change np.string_ to np.bytes_</span>

<span class="sd">Code changes for Pipeline2024 (as of July 30, 2024)</span>
<span class="sd">0) No longer disable onlyExtraMask when returnBluePoints==True</span>
<span class="sd">1) No longer search for vis in cube dir if not specified, only if vis==&#39;auto&#39;</span>
<span class="sd">2) Remove two print statements at import</span>
<span class="sd">3) Restore PL2022 behavior of allowing autoLower if returnBluePoints==True</span>
<span class="sd">4) add tooManyPixels parameter to control amendMaskDecision</span>
<span class="sd">5) widen selections narrower than 4 to make them visible but with thinner linewidth</span>
<span class="sd">6) add useBaseline option (default to &#39;auto&#39;)</span>
<span class="sd">7) force use of middleChannels in extraMask/onlyExtraMask/autoLower/autoLower2</span>
<span class="sd">8) import copy</span>
<span class="sd">9) change algorithm in robustMADofContinuumRanges to avoid problems with</span>
<span class="sd">   taking median of the MADs of lots of narrow ranges; fit slope to medians </span>
<span class="sd">   to remove impact of slope on the global MAD of all findcont channels,</span>
<span class="sd">   and use peakSNR&gt;7 instead of 15.   2023-08-08</span>
<span class="sd">10) Allow transition names of &quot;Continuum(ID=X)&quot; for X&gt;0 to also be considered </span>
<span class="sd">    continuum if there is only (at most) one appearance of &quot;ID=&quot;  2023-08-08</span>
<span class="sd">11) Add chans parameter to imageSNR.   2024-04-29</span>
<span class="sd">12) Fix for PIPE-2034 (incorrect AllCont display)  2024-04-29</span>
<span class="sd">13) Fix for PIPE-2158 (warningStrings is now always a list of length 2, but see 15) 2024-04-29</span>
<span class="sd">14) Fix for PIPE-1644 (reverted plot now shows the difSNR value)  2024-04-30</span>
<span class="sd">15) Fix for PIPE-1629 (pb mask is applied to joint.mask and joint.mask2) and </span>
<span class="sd">    further fix PIPE-2158     2024-04-30</span>
<span class="sd">16) New code for PIPE-2171 (write dirtyCubeStats.txt file)   2024-05-09</span>
<span class="sd">17) Fix for PIPE-1579 (annulus fully inscribed)   2024-05-09</span>
<span class="sd">18) Fix for PIPE-1657 (speed up pbmom calculation)  2024-05-09</span>
<span class="sd">19) Add CASA version to end of name of dirtyCubeStats_CASAx.y.z.txt file. 2024-05-23</span>
<span class="sd">20) Reduce the length of cyan line for single channel case    2024-06-01</span>
<span class="sd">21) Fix for PIPE-2188 (try harder to avoid LowSpread)  2024-06-03</span>
<span class="sd">22) Fix for PIPE-1992: if dynamic range of mom0 is high (&gt;90), raise the mom0minsnr mask threshold to 8</span>
<span class="sd">23) Add spectralDynamicRangeString to first line of legend</span>
<span class="sd">24) Final fix for PIPE-1629 (pb mask is applied to jointMask when it is pb-based)</span>

<span class="sd">Code changes for Pipeline2023 (as of June 12, 2023)</span>
<span class="sd">0) Enable amendMaskIterations=4: .autoLower2 will run if LowBW not yet reached</span>
<span class="sd">1) Set amendMaskIterations=&#39;auto&#39; to invoked amendMaskIterations=4</span>
<span class="sd">2) Set madRatioCheck to False instead of True when middle channels used as baseline</span>
<span class="sd">3) Add parameter for momDiffLevelForProceeding with default of 8.0</span>
<span class="sd">4) Use scalingFactor = 6/7 in extraMask and .onlyExtraMask if groups &gt; 32</span>
<span class="sd">5) Add minGroupsForSFCAdjustment as a control parameter, with default of 7</span>
<span class="sd">6) Add maxGroups as a control parameter, with a default of 15</span>
<span class="sd">7) When entering autoLower, use 6/7 instead of 5/7 if momDiffSNR&lt;momDiffApproachLevel</span>
<span class="sd">8) Add myia option to imageChannelFrequencies (to support recalcMomDiffSNR)</span>
<span class="sd">9) Compute mom0 and mom8 at the same time in findContinuum, plotPickleFile, </span>
<span class="sd">    recalcMomDiffSNR, and meanSpectrumFromMom0Mom8JointMask()</span>
<span class="sd">10) Fix plotPickleFile crash for single channel ranges</span>
<span class="sd">11) Support a list of intersectRanges in recalcMomDiffSNR</span>
<span class="sd">12) Add useUncorrectedMedian as a manual usage option</span>
<span class="sd">13) Add dotted cyan line marking the median of the selected continuum channels </span>
<span class="sd">and display its value in the second line of the legend</span>
<span class="sd">14) Elevate storeExtraMask as a main control parameter</span>
<span class="sd">15) Add returnBluePoints, enableInitialQuadratic and removeOutlierBaselineChannels </span>
<span class="sd">as main control parameters.</span>
<span class="sd">16) Add skipCubeNoise option</span>
<span class="sd">17) Add returnMomDiffSNR option (for hif_findcont to set to True)</span>
<span class="sd">18) import astropy.io.fits as pyfits, if possible</span>
<span class="sd">19) fix for PIPE-1636 (set nbin=1 if &#39;cont&#39; found in transition name), incl. search for vis in cube dir</span>
<span class="sd">20) Add &#39;auto&#39; option to enableInitialQuadratic (but keep True as the default)</span>
<span class="sd">21) import gaussian_filter from scipy.ndimage (instead of scipy.ndimage.filters)</span>
<span class="sd">22) Fix onlyExtraMaskYesOrNo to allow YesMom when skipCubeNoise is set to True by the user</span>
<span class="sd">23) Raise momDiffLevel by 3.5 (from 8 to 11.5) for 7m SingleContinuum to get more AllCont</span>
<span class="sd">24) Avoid fix for CAS-13894 in casa &gt;= 6.5.3</span>
<span class="sd">25) Add amendMaskIterations as parameter to compute4LetterCodeAndUpdateLegend</span>
<span class="sd">26) Add spectralDynamicRangeBandWidth parameter for PIPE-1566 with default=None</span>

<span class="sd">Code changes for Pipeline2022 from PIPE-1221: (as of August 21, 2022)</span>
<span class="sd">0) fix for PIPE-1227 (look for .virtspw first)</span>
<span class="sd">1) Do not remove pbmom if it already exists (for speeding up manual use case)</span>
<span class="sd">2) import pickle and add useJointMaskPrior control parameter for mom0mom8jointMask</span>
<span class="sd">3) PIPE-1433: set definition for TDM for VLA data, add telescope parameter</span>
<span class="sd">4) add optional img parameter to plotPickleFile (for manual use case)</span>
<span class="sd">5) add optional window parameter and automatic smooth when nbin&gt;1 (PIPE-848)</span>
<span class="sd">6) add optional intersectRanges parameter to plotPickleFile (for manual use case)</span>
<span class="sd">7) fix for PIPE-1518 and PIPE-1498</span>
<span class="sd">8) abbreviate Frequency to Freq. in the upper x-axis label to make room for nbin</span>
<span class="sd">9) add removal of median in calculation of initialPeakOverMad (PIPE-848)</span>
<span class="sd">10) Show horizontal cyan line even for ranges that are only one channel wide</span>
<span class="sd">11) add control parameter for peakOverMadCriterion, set to 65</span>
<span class="sd">12) add control parameter for minPeakOverMadForSFCAdjustment, set to 25</span>
<span class="sd">13) add additional clause for momDiffSNR&lt;15 in order to adjust sFC in .autoLower</span>
<span class="sd">14) prevent undefined var if returnSFC=True</span>
<span class="sd">15) in autoLower, change scalingFactor for sFC from 5/7 to 6/7</span>
<span class="sd">16) in [&#39;.extraMask&#39;,&#39;.onlyExtraMask&#39;,&#39;.autoLower&#39;], set finalSigmaFindContinuum</span>
<span class="sd">17) skyThresholds adjusted to 5.0, 0.40</span>
<span class="sd">18) change maxMadRatioForSFCAdjustmentInLaterIterations from 1.20 to 1.18</span>
<span class="sd">19) in .extraMask, reset sigmaFindContinuum to sigmaFindContinuumForExtraMask=2.5</span>
<span class="sd">20) fix crash in representativeSpw, remove call to isSingleContinuum</span>
<span class="sd">21) do not revert if momDiffSNR &lt; momDiffLevel</span>
<span class="sd">22) cast spw list intersection to int (since msmd produces inconsistent types)</span>
<span class="sd">23) fix crash in cubeFrameToTopo when vis not specified</span>

<span class="sd">Code changes for Pipeline2021 from PIPE-824: (as of July 20, 2021)</span>
<span class="sd">0) fix for PRTSPR-50321</span>
<span class="sd">1) change .rstrip(&#39;.image&#39;)+&#39;.mask&#39; to .replace(&#39;.image&#39;,&#39;.mask&#39;)</span>
<span class="sd">2) fix for PIPE-1181 (protection for all joint mask pixels between pb=0.20-21)</span>
<span class="sd">3) add nbin=1 parameter in preparation for PIPE-849</span>
<span class="sd">4) fix for PIPE-1211 (does not revert to first range in Result6)</span>
<span class="sd">5) add separate ALL_CONTINUUM fraction threshold of 0.91 for nchan&lt;75 (PIPE-825)</span>
<span class="sd">6) fix for PIPE-1213 (and correction to roundFigures, unused by current PL)</span>

<span class="sd">Code changes for Pipeline2020: </span>
<span class="sd">0) fix for PIPE-554 (bug found in cube imaging of calibrators by ARI-L project)</span>
<span class="sd">1) fix for PIPE-525 (divide by zero in a 130-target MOUS)</span>
<span class="sd">2) new feature PIPE-702 (expand mask if mom8fc image has emission outside it)</span>
<span class="sd">3) Add warning messages for too little bandwidth or too little spread.</span>
<span class="sd">4) if outdir is specified and does not exist, stop and print error message.</span>
<span class="sd">5) Modified the is_binary() function to work in both python 2 and 3.</span>
<span class="sd">6) Add LSRK frequency ranges in a new final line of the .dat file</span>
<span class="sd">7) Increase to 2 significant digits on sigmaFC in the png name</span>
<span class="sd">8) Allow manually specified narrow value to be used everywhere instead of &#39;auto&#39;</span>
<span class="sd">9) Print Final selection message to casa log</span>
<span class="sd">10) fix bug in convertSelectionIntoChannelList (only relevant if avoidance used)</span>
<span class="sd">11) allow single value in convertSelection</span>
<span class="sd">12) fix bug in avoidance range when gaps were trimmed (not relevant to PL)</span>
<span class="sd">13) remove warning about no beam in cube header</span>
<span class="sd">14) Add totalChannels &amp; medianWidthOfRanges parameters+logic to pickAutoTrimChannels()</span>
<span class="sd">15) Insure that channel ranges are in increasing order if a second range is added to a solo range</span>
<span class="sd">16) add imstatListit=False to all imstat calls</span>
<span class="sd">17) add minor ticks to lower x-axis (channel number) of the plot</span>
<span class="sd">18) added 21 new control parameters to findContinuum (default values listed) for a total of 98:</span>
<span class="sd">   * returnWarnings=False (PL 2020 might set this to True if Dirk has time)</span>
<span class="sd">   * sigmaFindContinuumMode=&#39;auto&#39; (split from sigmaFindContinuum)</span>
<span class="sd">   * returnSigmaFindContinuum=False </span>
<span class="sd">   * enableRejectNarrowInnerWindows=True (to be able to disable it manually)</span>
<span class="sd">   * avoidExtremaInNoiseCalcForJointMask=False</span>
<span class="sd">   * buildMom8fc=True</span>
<span class="sd">   * momentdir=&#39;&#39;</span>
<span class="sd">   * amendMaskIterations=&#39;auto&#39;</span>
<span class="sd">   * skipchan=1</span>
<span class="sd">   * checkIfMaskWouldHaveBeenAmended=False</span>
<span class="sd">   * fontsize=10</span>
<span class="sd">   * thresholdForSame=0.01 (to control the new 4-letter codes)</span>
<span class="sd">   * keepIntermediatePngs=True</span>
<span class="sd">   * enableOnlyExtraMask=True</span>
<span class="sd">   * useMomentDiff=True</span>
<span class="sd">   * smallBandwidthFraction=0.05</span>
<span class="sd">   * smallSpreadFraction=0.33</span>
<span class="sd">   * skipAmendMask=False (for manual usage)</span>
<span class="sd">   * useAnnulus=True</span>
<span class="sd">   * cubeSigmaThreshold=7.5</span>
<span class="sd">   * npixThreshold=7 (for onlyExtraMask)</span>
<span class="sd">19) Added 27 new functions:</span>
<span class="sd">   * round_half_up (to support the same rounding in python 3 as 2)</span>
<span class="sd">   * byteDecode (to convert bytes to string for python 3)</span>
<span class="sd">   * imageSNR</span>
<span class="sd">   * imageSNRAnnulus</span>
<span class="sd">   * plotChannelSelections</span>
<span class="sd">   * compute4LetterCodeAndUpdateLegend</span>
<span class="sd">   * compute4LetterCode</span>
<span class="sd">   * cubeNoiseLevel</span>
<span class="sd">   * updateChannelRangesOnPlot</span>
<span class="sd">   * computeNpixCubeMedian</span>
<span class="sd">   * computeNpixMom8Median</span>
<span class="sd">   * computeNpixMom8MedianBadAtm</span>
<span class="sd">   * replaceLineFullRangesWithNoise</span>
<span class="sd">   * gatherWarnings</span>
<span class="sd">   * tooLittleBandwidth</span>
<span class="sd">   * tooLittleSpread</span>
<span class="sd">   * computeSpread</span>
<span class="sd">   * amendMaskYesOrNo</span>
<span class="sd">   * extraMaskYesOrNo</span>
<span class="sd">   * onlyExtraMaskYesOrNo</span>
<span class="sd">   * invertChannelRanges</span>
<span class="sd">   * robustMADofContinuumRanges</span>
<span class="sd">   * findWidestContiguousListInChannelRange</span>
<span class="sd">   * imagePercentileNoMask (not used by PL because avoidExtremaInNoiseCalcForJointMask=False)</span>
<span class="sd">   * combineContDat (not used by pipeline)</span>
<span class="sd">   * getSpwFromPipelineImageName (not used by pipeline)</span>
<span class="sd">   * getFieldnameFromPipelineImageName (not used by pipeline)</span>
<span class="sd">-Todd Hunter</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>  <span class="c1"># prevents adding old-style print statements</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># np.set_printoptions(threshold=sys.maxsize)   # for debugging large arrays</span>
<span class="c1">#import matplotlib.pyplot as pl  # used through Cycle 7 but avoided with python3 starting in PL2020</span>
<span class="c1">#import pylab as pl  # used from Pipeline 2020-2023</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">pl</span> <span class="c1"># restored for Pipeline 2024: PIPE-1865</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">timeUtilities</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="n">difSNRFontsizeAdjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">DISABLE_CUBE_NOISE</span> <span class="o">=</span> <span class="mf">1e9</span>  <span class="c1"># shortcut for not passing skipCubeNoise all the way through to extraMaskYesOrNo, this is the value that MADCubeOutside is set to if skipCubeNoise is True</span>
<span class="n">ACA_MAX_BASELINE</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">MAX_RANGES_FOR_IMMOMENTS</span> <span class="o">=</span> <span class="mi">240</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c1"># reload is already available in python 2.x</span>
<span class="c1"># Check if this is CASA6  CASA 6</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">casatools</span>
    <span class="n">casaVersion</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">utils</span><span class="p">()</span><span class="o">.</span><span class="n">version_string</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">casadef</span>
    <span class="k">if</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.0.0&#39;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">casa</span> <span class="k">as</span> <span class="nn">mycasa</span>
        <span class="k">if</span> <span class="s1">&#39;cutool&#39;</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">mycasa</span><span class="p">):</span>
            <span class="n">cu</span> <span class="o">=</span> <span class="n">mycasa</span><span class="o">.</span><span class="n">cutool</span><span class="p">()</span>
            <span class="n">casaVersion</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cu</span><span class="o">.</span><span class="n">version</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cu</span><span class="o">.</span><span class="n">version</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casaVersion</span> <span class="o">=</span> <span class="n">mycasa</span><span class="o">.</span><span class="n">casa</span><span class="p">[</span><span class="s1">&#39;build&#39;</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casaVersion</span> <span class="o">=</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span>
<span class="c1">#print(&quot;casaVersion = &quot;, casaVersion)</span>

<span class="k">if</span> <span class="p">(</span><span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9.9&#39;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">astropy.io.fits</span> <span class="k">as</span> <span class="nn">pyfits</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;6.6.6&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="c1"># ignore pyfits deprecation message, maybe casa will include astropy.io.fits soon</span>
                <span class="c1"># Note: you cannot set category=DeprecationWarning in the call to filterwarnings() because the actual </span>
                <span class="c1">#       warning is PyFITSDeprecationWarning, which of course is not defined until you import pyfits!</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="c1">#, category=DeprecationWarning)  </span>
                <span class="kn">import</span> <span class="nn">pyfits</span> 
<span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">pyfits</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">taskinit</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#    print(&quot;imported casatasks and tools using taskinit *&quot;)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="c1"># The following makes CASA 6 look like CASA 5 to a script like this.</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">casalog</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">immath</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imregrid</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imsmooth</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imhead</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">immoments</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">makemask</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imstat</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imsubimage</span>
    <span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">imcollapse</span>
    <span class="c1"># Tools</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">measures</span> <span class="k">as</span> <span class="n">metool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">table</span> <span class="k">as</span> <span class="n">tbtool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">atmosphere</span> <span class="k">as</span> <span class="n">attool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">msmetadata</span> <span class="k">as</span> <span class="n">msmdtool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">image</span> <span class="k">as</span> <span class="n">iatool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">ms</span> <span class="k">as</span> <span class="n">mstool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">quanta</span> <span class="k">as</span> <span class="n">qatool</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">regionmanager</span> <span class="k">as</span> <span class="n">rgtool</span> <span class="c1"># used by peakOverMad</span>
<span class="c1">#    print(&quot;imported casatasks and casatools individually&quot;)</span>

<span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;5.9.9&#39;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">synthesismaskhandler</span> <span class="o">=</span> <span class="n">casac</span><span class="o">.</span><span class="n">synthesismaskhandler</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This casa does not contain casac.synthesismaskhandler(), so the joint mask cannot be pruned.&quot;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">immath_cli</span> <span class="kn">import</span> <span class="n">immath_cli</span> <span class="k">as</span> <span class="n">immath</span> <span class="c1"># only used if pbcube is not passed and no emission is found</span>
    <span class="kn">from</span> <span class="nn">imhead_cli</span> <span class="kn">import</span> <span class="n">imhead_cli</span> <span class="k">as</span> <span class="n">imhead</span>
    <span class="kn">from</span> <span class="nn">imregrid_cli</span> <span class="kn">import</span> <span class="n">imregrid_cli</span> <span class="k">as</span> <span class="n">imregrid</span>
    <span class="kn">from</span> <span class="nn">imsmooth_cli</span> <span class="kn">import</span> <span class="n">imsmooth_cli</span> <span class="k">as</span> <span class="n">imsmooth</span>
    <span class="kn">from</span> <span class="nn">immoments_cli</span> <span class="kn">import</span> <span class="n">immoments_cli</span> <span class="k">as</span> <span class="n">immoments</span>
    <span class="kn">from</span> <span class="nn">makemask_cli</span> <span class="kn">import</span> <span class="n">makemask_cli</span> <span class="k">as</span> <span class="n">makemask</span>
    <span class="kn">from</span> <span class="nn">imsubimage_cli</span> <span class="kn">import</span> <span class="n">imsubimage_cli</span> <span class="k">as</span> <span class="n">imsubimage</span>
    <span class="kn">from</span> <span class="nn">imcollapse_cli</span> <span class="kn">import</span> <span class="n">imcollapse_cli</span> <span class="k">as</span> <span class="n">imcollapse</span>
    <span class="kn">from</span> <span class="nn">imstat_cli</span> <span class="kn">import</span> <span class="n">imstat_cli</span> <span class="k">as</span> <span class="n">imstat</span>  <span class="c1"># used by computeMadSpectrum</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">synthesismaskhandler</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">scoreatpercentile</span><span class="p">,</span> <span class="n">percentileofscore</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>

<span class="n">casaVersionString</span> <span class="o">=</span> <span class="n">casaVersion</span>
<span class="n">casaMajorVersion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">casaVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">if</span> <span class="n">casaMajorVersion</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nanmean</span> <span class="k">as</span> <span class="n">scipy_nanmean</span>
    <span class="kn">import</span> <span class="nn">casadef</span>  <span class="c1"># This still works in CASA 5.0, but might not someday.</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># scipy.nanmean still exists, but is deprecated in favor of numpy&#39;s version</span>
    <span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">nanmean</span> <span class="k">as</span> <span class="n">scipy_nanmean</span>

<div class="viewcode-block" id="version">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.version">[docs]</a>
<span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="n">showfile</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the CVS revision number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myversion</span> <span class="o">=</span> <span class="s2">&quot;$Id: findContinuumCycle12.py,v 8.2 2024/09/26 19:51:04 we Exp $&quot;</span> 
    <span class="k">if</span> <span class="p">(</span><span class="n">showfile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loaded from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">myversion</span></div>


<div class="viewcode-block" id="casalogPost">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.casalogPost">[docs]</a>
<span class="k">def</span> <span class="nf">casalogPost</span><span class="p">(</span><span class="n">mystring</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates an INFO message prepended with the version number of findContinuum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">version</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">origin</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">mystring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">)</span></div>

    
<span class="n">SFC_FACTOR_WHEN_MOM8MASK_EXISTS</span> <span class="o">=</span> <span class="mf">0.8</span>  <span class="c1"># was 0.6 on Jan 26; 0.5 was too low on 2015.1.00131.S G09_0847+0045 spw 17</span>
                                        <span class="c1"># 0.8 was too high on 2018.1.00828.S</span>
<span class="n">ALL_CONTINUUM_CRITERION</span> <span class="o">=</span> <span class="mf">0.925</span> <span class="c1"># for totalChannels &gt;= 75 (was 0.94 for 2019 Jan 17 test  )</span>
<span class="n">ALL_CONTINUUM_CRITERION_TDM_FULLPOL</span> <span class="o">=</span> <span class="mf">0.91</span> <span class="c1"># for totalChannels &lt; 75</span>
<span class="n">DYNAMIC_RANGE_LIMIT_PLOT</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">AMENDMASK_PIXEL_RATIO_EXCEEDED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">AMENDMASK_PIXELS_ABOVE_THRESHOLD_EXCEEDED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
<span class="n">NBIN_THRESHOLD</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># if nbin &gt;= this value, then apply smoothing</span>
<span class="n">maxTrimDefault</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">dpiDefault</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">imstatListit</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">imstatVerbose</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">meanSpectrumMethods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">,</span> <span class="s1">&#39;peakOverMad&#39;</span><span class="p">,</span> <span class="s1">&#39;peakOverRms&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">,</span> <span class="s1">&#39;meanAboveThresholdOverRms&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;meanAboveThresholdOverMad&#39;</span><span class="p">,</span> <span class="s1">&#39;auto&#39;</span><span class="p">]</span> 

<div class="viewcode-block" id="help">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.help">[docs]</a>
<span class="k">def</span> <span class="nf">help</span><span class="p">(</span><span class="n">match</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print an alphabetized list of all the defined functions at the top level in</span>
<span class="sd">    this python file.</span>
<span class="sd">    match: limit the list to those functions containing this string (case insensitive)</span>
<span class="sd">    -- Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myfile</span> <span class="o">=</span> <span class="vm">__file__</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myfile</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;c&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;au loaded from .pyc file, looking at .py file instead&quot;</span><span class="p">)</span>
        <span class="n">myfile</span> <span class="o">=</span> <span class="n">myfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">aufile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">myfile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">aufile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%d</span><span class="s2"> lines from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">),</span> <span class="vm">__file__</span><span class="p">))</span>
    <span class="n">aufile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">commands</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;def &#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">commandline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;def &#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">commandline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">commandline</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\r</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">command</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">commands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="n">commands</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">command</span> <span class="ow">in</span> <span class="n">commands</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span></div>


<div class="viewcode-block" id="round_half_up">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.round_half_up">[docs]</a>
<span class="k">def</span> <span class="nf">round_half_up</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">to_integral_value</span><span class="p">(</span><span class="n">rounding</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">ROUND_HALF_UP</span><span class="p">))</span></div>


<div class="viewcode-block" id="is_binary">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.is_binary">[docs]</a>
<span class="k">def</span> <span class="nf">is_binary</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Return true if the given filename appears to be binary.</span>
<span class="sd">    Works in python 2.7 and 3</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;file </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<span class="c1"># Old method: fails in python 3</span>
<span class="c1">#    File is considered to be binary if it contains a NULL byte.</span>
<span class="c1">#    This approach returns True for .fits files, but</span>
<span class="c1">#    incorrectly reports UTF-16 as binary.</span>
<span class="c1">#    with open(filename, &#39;rb&#39;) as f:</span>
<span class="c1">#        for block in f:</span>
<span class="c1">#            if &#39;\0&#39; in block:</span>
<span class="c1">#                return True</span>
<span class="c1">#    return False</span>

<div class="viewcode-block" id="getMemorySize">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getMemorySize">[docs]</a>
<span class="k">def</span> <span class="nf">getMemorySize</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum and runFindContinuum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">&#39;SC_PAGE_SIZE&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s1">&#39;SC_PHYS_PAGES&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># SC_PHYS_PAGES can be missing on OS X</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">([</span><span class="s1">&#39;sysctl&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="s1">&#39;hw.memsize&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span></div>


<span class="n">MOM8MINSNR_DEFAULT</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">MOM0MINSNR_DEFAULT</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="removeIfNecessary">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.removeIfNecessary">[docs]</a>
<span class="k">def</span> <span class="nf">removeIfNecessary</span><span class="p">(</span><span class="n">imgname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If an image exists, remote its directory tree.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imgname</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">imgname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imgname</span><span class="p">):</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING:  shutil.rmtree failed for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">imgname</span><span class="p">)</span></div>


<div class="viewcode-block" id="findContinuum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findContinuum">[docs]</a>
<span class="k">def</span> <span class="nf">findContinuum</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psfcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                  <span class="n">transition</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                  <span class="n">baselineModeA</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">sigmaCube</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                  <span class="n">nBaselineChannels</span><span class="o">=</span><span class="mf">0.19</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                  <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">png</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pngBasename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                  <span class="n">percentile</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">narrow</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                  <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">titleText</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="c1"># 25</span>
                  <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">meanSpectrumFile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                  <span class="n">alternateDirectory</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
                  <span class="n">plotAtmosphere</span><span class="o">=</span><span class="s1">&#39;transmission&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="n">channelFractionForSlopeRemoval</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                  <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">,</span> 
                  <span class="n">peakFilterFWHM</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># 38</span>
                  <span class="n">skyTempThreshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="c1"># was 1.5 in C4R2, reduced to 1.2 after slope removal added, increased to 5 in PL2022</span>
                  <span class="n">skyTransmissionThreshold</span><span class="o">=</span><span class="mf">0.40</span><span class="p">,</span> <span class="c1"># was 0.08 prior to PL2022</span>
                  <span class="n">maxGroupsForSkyThreshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">minBandwidthFractionForSkyThreshold</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">regressionTest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">quadraticFit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">triangleFraction</span><span class="o">=</span><span class="mf">0.83</span><span class="p">,</span> <span class="n">maxMemory</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># 46</span>
                  <span class="n">tdmSkyTempThreshold</span><span class="o">=</span><span class="mf">0.65</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span>
                  <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">applyMaskToMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                  <span class="n">plotBaselinePoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                  <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span>
                  <span class="n">projectCode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                  <span class="n">useThresholdWithMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                  <span class="n">dpi</span><span class="o">=</span><span class="n">dpiDefault</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">returnSnrs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># 61</span>
                  <span class="n">overwriteMoments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">minPeakOverMadForSFCAdjustment</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                  <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">signalRatioTier1</span><span class="o">=</span><span class="mf">0.967</span><span class="p">,</span> 
                  <span class="n">snrThreshold</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">MOM0MINSNR_DEFAULT</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">MOM8MINSNR_DEFAULT</span><span class="p">,</span> <span class="n">overwriteMasks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                  <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quadraticNsigma</span><span class="o">=</span><span class="mf">1.8</span><span class="p">,</span> <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">makeMovie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnAllContinuumBoolean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">allowBluePruning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">avoidance</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">returnSigmaFindContinuum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                  <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># 81</span>
                  <span class="n">buildMom8fc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">amendMaskIterations</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">skipchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># 85</span>
                  <span class="n">checkIfMaskWouldHaveBeenAmended</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># 88</span>
                  <span class="n">keepIntermediatePngs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnWarnings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enableOnlyExtraMask</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">useMomentDiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="o">=</span><span class="mf">0.33</span><span class="p">,</span>
                  <span class="n">skipAmendMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cubeSigmaThreshold</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> 
                  <span class="n">npixThreshold</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">useJointMaskPrior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> 
                  <span class="n">window</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxMadRatioForSFCAdjustment</span><span class="o">=</span><span class="mf">1.18</span><span class="p">,</span>  <span class="c1"># 104</span>
                  <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="o">=</span><span class="mf">1.18</span><span class="p">,</span> 
                  <span class="n">sigmaFindContinuumForExtraMask</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> 
                  <span class="n">peakOverMadCriterion</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="o">=</span><span class="mf">8.0</span><span class="p">,</span> <span class="c1"># 109</span>
                  <span class="n">minGroupsForSFCAdjustment</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">maxGroups</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">momDiffApproachLevel</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span>
                  <span class="n">mom08simultaneous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">storeExtraMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">returnBluePoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                  <span class="n">returnMomDiffSNR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">tooManyPixels</span><span class="o">=</span><span class="mi">850</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span> <span class="c1"># 123</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function calls functions to:</span>
<span class="sd">    1) compute a representative &#39;mean&#39; spectrum of a dirty cube</span>
<span class="sd">    2) find the continuum channels </span>
<span class="sd">    3) plot the results and writes a text file with channel ranges and frequency ranges</span>
<span class="sd">    It calls runFindContinuum up to 2 times.  </span>
<span class="sd">    If meanSpectrumMethod != &#39;mom0mom8jointMask&#39;, then it runs it a second </span>
<span class="sd">    time with a reduced field size if it finds only one range of continuum </span>
<span class="sd">    channels. </span>

<span class="sd">    Please note that the channel ranges do not necessarily map back to </span>
<span class="sd">    the visibility spectra in the measurement set(s).  In order to produce </span>
<span class="sd">    channel ranges that are guaranteed to map back correctly, then you must </span>
<span class="sd">    supply a list of all desired measurement sets to the vis parameter.  In </span>
<span class="sd">    this case, the final line in the .dat file created will contain the </span>
<span class="sd">    channel list in the correct frequency frame and order.</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    * A channel selection string suitable for the spw parameter of clean.</span>
<span class="sd">    * The name of the final png produced.</span>
<span class="sd">    * The aggregate bandwidth in continuum in GHz.</span>
<span class="sd">    If returnAllContinuumBoolean = True, then it also returns a Boolean desribing</span>
<span class="sd">      if it thinks the whole spectrum is continuum (True) or not (False)</span>
<span class="sd">      Cycle 7 pipeline usage should set returnAllContinuumBoolean = True</span>
<span class="sd">    If returnWarnings = True, then it also returns a list of warning strings,</span>
<span class="sd">       which may be empty [], for tooLittleBandwidth and/or tooLittleSpread (PL2020+)</span>
<span class="sd">       and the name of the joint mask image (PL2022+)</span>
<span class="sd">    If returnSnrs = True, then it also returns two more lists: mom0snrs and mom8snrs,</span>
<span class="sd">          and the max baseline (floating point meters) inferred from the psf image</span>
<span class="sd">    if returnSigmaFindContinuum = True (new in PL2020), then it also returns 17 more things:</span>
<span class="sd">       1) the final value used for sigmaFindContinuum (PL2022: at the end of the .original stage)</span>
<span class="sd">       2) the Boolean intersectionOfSelections </span>
<span class="sd">       3) number of central ranges that were (or would have been) dropped, summed</span>
<span class="sd">          over all runs of findContinuumChannels by the final run of runFindContinuum.</span>
<span class="sd">       4) the result of amendMaskYesOrNo (if it was run;  False otherwise)</span>
<span class="sd">       5) the result of extraMaskYesOrNo (if it was run;  False otherwise)</span>
<span class="sd">       6) the result of extraMaskYesOrNo test 2 (if it was run;  False otherwise)</span>
<span class="sd">       7) the result of autoLower</span>
<span class="sd">       8) the name of the finalMomDiff image (if amendMask=True) else the final mom8fc image</span>
<span class="sd">       9) the logic path code (for amendMask) (pathCode)</span>
<span class="sd">      10) the 4-letter code (for amendMask) (momDiffCode)</span>
<span class="sd">      11) the SNR in the final momDiff image (momDiffSNR)</span>
<span class="sd">      12) name of meanSpectrumFile produced</span>
<span class="sd">      13) name of the &quot;_findContinuum.dat&quot; file produced</span>
<span class="sd">      14) positiveThreshold (upper black dotted line)</span>
<span class="sd">      15) negativeThreshold (lower black dotted line)</span>
<span class="sd">      16) median (solid black line)</span>
<span class="sd">      17) median of selected continuum channels (dotted cyan line)</span>
<span class="sd">    If returnMomDiffSNR = True (new in PL2023) and returnSigmaFindContinuum &amp; returnSNRs=False</span>
<span class="sd">      then also return the momDiffSNR value.</span>
<span class="sd">    PL2023 use case (returnWarnings=True, returnAllContinuumBoolean=True returnMomDiffSNR=True) </span>
<span class="sd">      will return: </span>
<span class="sd">      selection, png, aggregateBandwidth, allContinuum, warningStrings, jointMask, momDiffSNR</span>

<span class="sd">    Required Inputs:</span>
<span class="sd">    ----------------</span>
<span class="sd">    img: the image cube to operate upon (as opposed to specifying a</span>
<span class="sd">         pre-existing meanSpectrumFile from a previous run)</span>
<span class="sd">     --or--</span>
<span class="sd">    meanSpectrumFile: an alternative pre-existing ASCII text file to use</span>
<span class="sd">         for the mean spectrum, instead of operating on the img to create one.  </span>
<span class="sd">    Note: if you specify meanSpectrumFile and vis, you must also specify img, but</span>
<span class="sd">          only its metadata will be used.</span>
<span class="sd">      Parameters relevant only to meanSpectrumFile:</span>
<span class="sd">      * invert: if True, then invert the sign of intensity and add the minimum</span>

<span class="sd">    Optional inputs (see also General Parameters below):</span>
<span class="sd">    ---------------------------------------------------</span>
<span class="sd">    spw: the spw name or number (integer or string integer) to put in the x-axis label;</span>
<span class="sd">         also, it will be used to select the spw for which to generate topo channels for the </span>
<span class="sd">         *.dat file if vis is also specified; if vis is specified and spw is </span>
<span class="sd">         not, then it will search the name of the image for an spw number </span>
<span class="sd">         and use it for generating the topo channel list.</span>
<span class="sd">    transition: the name of the spectral transition (for the plot title)</span>
<span class="sd">    avoidance: a CASA channel selection string to avoid selecting (for manual use);</span>
<span class="sd">           invoked at the end of each execution of runFindContinuum()</span>
<span class="sd">    meanSpectrumMethod: &#39;auto&#39;, &#39;mom0mom8jointMask&#39;, &#39;peakOverMad&#39;, &#39;peakOverRms&#39;, </span>
<span class="sd">       &#39;meanAboveThreshold&#39;, &#39;meanAboveThresholdOverRms&#39;, &#39;meanAboveThresholdOverMad&#39;, </span>
<span class="sd">        where &#39;peak&#39; refers to the peak in a spatially-smoothed version of cube</span>
<span class="sd">        &#39;auto&#39; invokes &#39;meanAboveThreshold&#39; unless sky temperature range </span>
<span class="sd">           (max-min) from the atmospheric model is more than skyTempThreshold </span>
<span class="sd">           in which case it invokes &#39;peakOverMad&#39; instead</span>
<span class="sd">        ALMA Cycle 5 used &#39;auto&#39;, while ALMA Cycle 6 will use &#39;mom0mom8jointMask&#39;</span>

<span class="sd">        Parameters relevant only to &#39;mom0mom8jointMask&#39; (i.e., ALMA Cycle 6 onward)</span>
<span class="sd">        ---------------------------------------------------------------------</span>
<span class="sd">        * nbin: if greater than NBIN_THRESHOLD (4), then smooth spectrum by this</span>
<span class="sd">                many channels</span>
<span class="sd">        * spectralDynamicRangeBandWidth: frequency string with units; </span>
<span class="sd">               compute nbin based on this value (overrides nbin parameter), </span>
<span class="sd">               example: &#39;5.1MHz&#39;</span>
<span class="sd">        * window: the smoothing window to use with nbin (one of: &#39;gauss&#39;,</span>
<span class="sd">                 &#39;flat&#39;,&#39;hanning&#39;,&#39;hamming&#39;,&#39;bartlett&#39;,&#39;blackman&#39;)</span>
<span class="sd">        * minPeakOverMadForSFCAdjustment: scalar value</span>
<span class="sd">        * pbcube: the primary beam response for img, but only used by </span>
<span class="sd">            meanSpectrumMethod=&#39;mom0mom8jointMask&#39;. If not specified, </span>
<span class="sd">            it will be searched for by changing file suffix from .residual to .pb</span>
<span class="sd">        * psfcube: the psf response for img, but only used by </span>
<span class="sd">            meanSpectrumMethod=&#39;mom0mom8jointMask&#39;. If not specified, </span>
<span class="sd">            it will be searched for by changing file suffix from .residual to .psf,</span>
<span class="sd">            if still not found, then pruneMask will default to 6 pixels</span>
<span class="sd">        * minbeamfrac: only used if psfcube is specified and meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">             floating point value or &#39;auto&#39; for 0.3 for 12m and 0.1 for 7m (maxBaseline&lt;60m)</span>
<span class="sd">             Set to zero to prevent pruning of the joint mask entirely; otherwise pruneMask</span>
<span class="sd">             will use np.max([4,minbeamfrac*pixelsPerBeam])</span>
<span class="sd">        * minPixelsInJointMask: if fewer than these pixels are found (after pruning), then</span>
<span class="sd">            use all pixels above pb=0.3 (or equivalent higher value on mitigated images).</span>
<span class="sd">            This option was essentially obseleted by the addition of pruneMask with the</span>
<span class="sd">            knowledge of beamsize from psfcube.  To avoid having any effect, it should be set </span>
<span class="sd">            to &lt; minbeamfrac*minPixelsPerBeam, which is typically 0.5*7=3.5; so use 3 or less.</span>
<span class="sd">        * userJointMask: if specified, use this joint mask instead of computing one</span>
<span class="sd">                         (this option is meant for test purposes only, typically *.mask2_bi)</span>
<span class="sd">        * useJointMaskPrior: if True, and if the &lt;img&gt;_mom0mom8jointMaskPrior.pkl file exists,</span>
<span class="sd">                then it will skip the creation of joint.mask and joint.mask2 on the first </span>
<span class="sd">                iteration of amendMask to save some time. </span>
<span class="sd">        * normalizeByMAD: can be True, False or &#39;auto&#39; (default); </span>
<span class="sd">            if &#39;auto&#39;, then if atmospheric transmission varies enough across the spw, </span>
<span class="sd">              set to True, otherwise set to False.  </span>
<span class="sd">            If True, then request normalization of the resulting mean spectrum by the </span>
<span class="sd">              xmadm spectrum using an outer annulus and outside the joint mask.  The </span>
<span class="sd">              nominal annulus is the 0.2-0.3 pb response, but the range will </span>
<span class="sd">              automatically be scaled upward with minimum value in the pb cube, </span>
<span class="sd">              in order to preserve the fractional number of pixels contained in </span>
<span class="sd">              a single field&#39;s 0.2-0.3 annulus.  </span>
<span class="sd">        * mom0minsnr: sets the threshold for the mom0 image (i.e. median + mom0minsnr*scaledMAD)</span>
<span class="sd">        * mom8minsnr: sets the threshold for the mom8 image (i.e. median + mom8minsnr*scaledMAD)</span>
<span class="sd">        * snrThreshold: if SNR is higher than this, then run a phase 2 mask calculation</span>
<span class="sd">        * bidirectionalMaskPhase2: True=extend mask to negative values beyond threshold; </span>
<span class="sd">            False=Cycle6+ behavior (True was tried but gives worse results in some cases)</span>
<span class="sd">        * enableInitialQuadratic: if True, assess the need for quadratic removal, and use </span>
<span class="sd">             the old-style method to remove it; if &#39;auto&#39;, then set to True only</span>
<span class="sd">             if the lowercase version of the source name includes venus, mars,</span>
<span class="sd">                 jupiter, saturn, uranus, or neptune</span>
<span class="sd">        * rmStatContQuadratic: if True, then do not do the initialQuadratic removal (if </span>
<span class="sd">            enabled and deemed necessary), but instead always perform the new-style </span>
<span class="sd">            quadratic removal</span>
<span class="sd">        * makeMovie: if True, then make a png for each quadratic fit as channels are </span>
<span class="sd">             removed one-by-one (in the rmStatContQuadratic option)</span>
<span class="sd">        * quadraticNsigma: the stopping threshold to use when ignoring outliers prior to </span>
<span class="sd">            fitting the quadratic (in the rmStatContQuadratic option). To more quickly test </span>
<span class="sd">            different values, be sure to set the meanSpectrumFile option and overwrite=False)</span>
<span class="sd">        * allowBluePruning: use continuum range pruning heuristic added in Cycle 6 (default=True)</span>
<span class="sd">        * amendMaskIterations (new in PL2020): if &#39;auto&#39;, then choose 0 for TDM and 3 for FDM;</span>
<span class="sd">            if 0, then do not attempt any amendMask (i.e. mimic the Cycle 7 pipeline release)</span>
<span class="sd">            if &gt;=1, then when finished the initial findContinuum trial, create a mom8fc image and</span>
<span class="sd">            mom0fc image scaled by nchan and chanwidth in kms, and subtract them to create momDiff </span>
<span class="sd">            image. If the momDiff image has sufficient signal remaining in it, then expand the</span>
<span class="sd">            joint mask, and repeat the findContinuum process with this expanded mask as the</span>
<span class="sd">            userJointMask;  if &gt;=2, and there is still sufficient signal in the new momDiff image from</span>
<span class="sd">            the second run of findContinuum, then check if further analysis of the extra portion of the </span>
<span class="sd">            mask is necessary. If so, first check if intersecting the ranges of the first two rounds</span>
<span class="sd">            eliminates the excess, otherwise create a new spectrum from it and pass it into a third</span>
<span class="sd">            round of findContinuum with this as the meanSpectrum file.  If &gt;=3, and there is stil</span>
<span class="sd">            sufficient signal in the new momDiff, image then set sigmaFindContinuumMode=&#39;autolower&#39;</span>
<span class="sd">            and sigmaFindContinuum=most recent value, and run another round of findContinuum.</span>
<span class="sd">            If &gt;= 4, and and there is sufficient signal in the new momDiff, run another round</span>
<span class="sd">            of autolower.</span>
<span class="sd">        * skipAmendMask: if True, then skip the test for amend mask, and move on to onlyExtraMask</span>
<span class="sd">        * skipCubeNoise: if True, then do not run cubeNoiseLevel, instead set MADCubeOutside to</span>
<span class="sd">                 DISABLE_CUBE_NOISE and the cubeMedian to zero</span>
<span class="sd">        * tooManyPixels: value of pixels in mask beyond which amendMask will not </span>
<span class="sd">                proceed, and causes result code &#39;P#&#39;</span>
<span class="sd">        * storeExtraMask: if True, the write the extraMask as a mask image (for debugging)</span>
<span class="sd">        * momDiffLevel: if amendMaskIterations&gt;0, sets the level above which pixels are counted.</span>
<span class="sd">            For SingleContinuum 7m spws, the value is automatically incremented by 3.5. It is not</span>
<span class="sd">            recommended to change this parameter, as it affects many heuristics. Change the next one.</span>
<span class="sd">        * momDiffLevelForProceeding: if amendMaskIterations&gt;0, sets the level above pixels must be</span>
<span class="sd">            in the mom8-mom0 image difference to be counted when determining whether to amend the mask.</span>
<span class="sd">        * useAnnulus: if amendMaskIterations&gt;0, sets whether median/MAD in imageSNR be assessed in </span>
<span class="sd">               annulus but outside the jointmask (True) or simply outside the joint mask (False)</span>
<span class="sd">        * subimage: if True, then add 0.2 to both radii of the annulus</span>
<span class="sd">        * enableOnlyExtraMask: if False, then do not do the extraMask or onlyExtraMask iterations</span>
<span class="sd">        * useMomentDiff: if False, use the mom8fc image to assess AmendMask decision instead of momDiff</span>
<span class="sd">        * checkIfMaskWouldHaveBeenAmended (new in PL2020): if True, then if amendMaskIterations=0, </span>
<span class="sd">              then it will still check to see if the mask would have been amended and return the </span>
<span class="sd">              result (assuming that returnSigmaFindContinuum==True) -- for test purposes only</span>
<span class="sd">        * maxMadRatioForSFCAdjustment: one of the controls for lowering sigmaFindContinuum in</span>
<span class="sd">              the .original amendMask iteration </span>
<span class="sd">        * maxMadRatioForSFCAdjustmentInLaterIterations: one of the controls for lowering </span>
<span class="sd">              sigmaFindContinuum in amendMask iterations after the .original iteration</span>
<span class="sd">        </span>
<span class="sd">        Parameters relevant only to &#39;peakOverMad&#39; or &#39;mom0mom8jointMask&#39;:</span>
<span class="sd">        -----------------------------------------------------------</span>
<span class="sd">        * maxGroups: maximum number of continuum regions below which the potential reduction </span>
<span class="sd">              factor of sigmaFindContinuum will be scaled by (1 - groups/maxGroups)**(bandwidth/1875e6)</span>
<span class="sd">              via the following equation:</span>
<span class="sd">          sFC_factor = np.max([scalingFactor/7.0, (1-groups/float(maxGroups)) ** (spwBandwidth/1.875e9)])</span>

<span class="sd">        Parameters relevant only to meanSpectrumMethod=&#39;auto&#39; and &#39;mom0mom8jointMask&#39;:</span>
<span class="sd">        ------------------------------------------------------------------------------</span>
<span class="sd">        * skyTempThreshold: rms value in Kelvin (for FDM spectra&lt;1000MHz), above which </span>
<span class="sd">            the meanSpectrumMethod is changed in &#39;auto&#39; mode to peakOverMad; and above</span>
<span class="sd">            which normalizeByMAD is set True in meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">            when normalizeByMAD=&#39;auto&#39; mode</span>
<span class="sd">        * tdmSkyTempThreshold: rms value in Kelvin (for TDM and 1875MHz FDM spectra) </span>
<span class="sd">        * skyTransmissionThreshold: threshold on (max-min)/mean, above which the</span>
<span class="sd">            meanSpectrumMethod is changed in &#39;auto&#39; mode to peakOverMad;  and above</span>
<span class="sd">            which normalizeByMAD is set True in meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">            when normalizeByMAD=&#39;auto&#39; mode</span>
<span class="sd">        * overwriteMoments: if True, then overwrite any existing moment0 or moment8 image </span>
<span class="sd">        * overwriteMasks: if True, then overwrite any existing moment0 or moment8 mask image </span>
<span class="sd">        * rmStatContQuadratic: if True, then fit and remove quadratic after removing outliers</span>
<span class="sd">        * outdir: directory to write the .mom0 and .mom8 images, .png, .dat and meanSpectrum</span>
<span class="sd">              (default is same directory as the cube)</span>
<span class="sd">        * avoidExtremaInNoiseCalcForJointMask (new in PL2020): experimental Boolean to avoid </span>
<span class="sd">             pixels &lt;5%ile and &gt;95%ile in the chauvenet imstat of mom0 and mom8 images</span>

<span class="sd">        Parameters relevant only to &#39;auto&#39;:</span>
<span class="sd">        -----------------------------------</span>
<span class="sd">        * triangleFraction: remove a triangle shape if the MAD of the dual-linfit residual </span>
<span class="sd">           is less than this fraction*originalMAD; set this parameter to zero to turn it off.</span>

<span class="sd">        Parameters relevant only to &#39;peakOverMad&#39; or &#39;meanAboveThreshold*&#39;:</span>
<span class="sd">        -------------------------------------------------------------------</span>
<span class="sd">        * maxMemory: behave as if the machine has this many GB of memory</span>
<span class="sd">        * nanBufferChannels: when removing or replacing NaNs, do this many extra channels</span>
<span class="sd">                       beyond their extent</span>
<span class="sd">        * channelFractionForSlopeRemoval: if this many channels are initially selected, </span>
<span class="sd">               then fit and remove a linear slope and re-identify continuum channels</span>
<span class="sd">               Set to 1 to turn off.</span>
<span class="sd">        * quadraticFit: if True, fit quadratic polynomial to the noise regions when </span>
<span class="sd">            deemed appropriate; Otherwise, fit only a linear slope</span>
<span class="sd">        * centralArcsec: radius of central box within which to compute the mean spectrum</span>
<span class="sd">            default=&#39;auto&#39; means start with whole field, then reduce to 1/10 if only</span>
<span class="sd">            one window is found (unless mask is specified); or &#39;fwhm&#39; for the central square</span>
<span class="sd">            with the same radius as the PB FWHM; or a floating point value in arcseconds</span>
<span class="sd">        * mask: a mask image preferably equal in shape to the parent image that is used to determine</span>
<span class="sd">            the region to compute the noise (outside the mask, i.e. mask=0) and </span>
<span class="sd">            (in the &#39;meanAboveThresholdMethod&#39;) the mean spectrum (inside the mask, i.e. mask=1).  </span>
<span class="sd">            The spatial union of all masked pixels in all channels is used as the mask for each channel.</span>
<span class="sd">            Option &#39;auto&#39; will look for the &lt;filename&gt;.mask that matches the &lt;filename&gt;.image</span>
<span class="sd">            and if it finds it, it will use it; otherwise it will use no mask.</span>
<span class="sd">            If the mask does not match in shape but is multi-channel, it will be regridded to match</span>
<span class="sd">            and written out as &lt;filename&gt;.mask.regrid.</span>
<span class="sd">            If it matches spatially but is single-channel, this channel will be used for all.</span>
<span class="sd">            To convert a .crtf file to a mask, use:</span>
<span class="sd">            makemask(mode=&#39;copy&#39;, inpimage=img, inpmask=&#39;chariklo.crtf&#39;, output=img+&#39;.mask&#39;)</span>
<span class="sd">        * applyMaskToMask: if True, apply the mask inside the user mask image to set its masked pixels to 0</span>

<span class="sd">        Parameters relevant only to &#39;peakOverRms&#39; and &#39;peakOverMad&#39;:</span>
<span class="sd">        ------------------------------------------------------------</span>
<span class="sd">        * peakFilterFWHM: value (in pixels) to presmooth each plane with a Gaussian kernel of</span>
<span class="sd">             this width.  Set to 1 to not do any smoothing.</span>
<span class="sd">             Default = 10 which is typically about 2 synthesized beams.</span>

<span class="sd">        Parameters relevant only to &#39;meanAboveThreshold&#39;:</span>
<span class="sd">        -------------------------------------------------</span>
<span class="sd">        * useAbsoluteValue: passed to meanSpectrum, then avgOverCube -- take absolute value of</span>
<span class="sd">             the cube before producing mean spectrum</span>
<span class="sd">        * useThresholdWithMask: if False, then just take mean rather than meanAboveThreshold</span>
<span class="sd">             when a mask has been specified</span>
<span class="sd">        * useIAGetProfile: if True, then for baselineMode=&#39;min&#39;, use ia.getprofile instead of </span>
<span class="sd">             ia.getregion and subsequent arithmetic (faster, less memory exhaustive)</span>
<span class="sd">        * continuumThreshold: if specified, begin by using only pixels above this intensity level</span>
<span class="sd">        * sigmaCube: multiply this value by the MAD to get the threshold above </span>
<span class="sd">               which a voxel is included in the mean spectrum.</span>
<span class="sd">        * baselineModeA: &#39;min&#39; or &#39;edge&#39;, method to define the baseline in meanSpectrum()</span>
<span class="sd">            Parameters relevant to &#39;min&#39;:</span>
<span class="sd">            -----------------------------</span>
<span class="sd">            * percentile: control parameter for &#39;min&#39;</span>

<span class="sd">            Parameters relevant to &#39;edge&#39;:</span>
<span class="sd">            * nBaselineChannels: if integer, then the number of channels to use in:</span>
<span class="sd">              a) computing the mean spectrum with the &#39;meanAboveThreshold&#39; methods.</span>
<span class="sd">              b) computing the MAD of the lowest/highest channels in findContinuumChannels</span>
<span class="sd">                 if float, then the fraction of channels to use (i.e. the percentile)</span>
<span class="sd">                 default = 0.19, which is 24 channels (i.e. 12 on each side) of a TDM window</span>

<span class="sd">        Parameters relevant only when amendMaskIterations &gt; 0 (new for PL2020)</span>
<span class="sd">        ----------------------------------------------------------------------</span>
<span class="sd">        * keepIntermediatePngs: if True, keep changing the png name to avoid overwriting them; only</span>
<span class="sd">             the final one is returned</span>
<span class="sd">        * thresholdForSame: fractional value used to determine if the residual in the mom8fc image</span>
<span class="sd">             improved (&#39;L&#39;), worsened (&#39;H&#39;) or stayed the same (&#39;S&#39;)</span>
<span class="sd">        * cubeSigmaThreshold: minimum cube SNR for onlyExtraMask to trigger</span>
<span class="sd">        * npixThreshold: minimum momDiff pixels for onlyExtraMask to trigger</span>

<span class="sd">    Parameters for function findContinuumChannels (which is called by all meanSpectrum heuristics):</span>
<span class="sd">    -----------------------------------------------------------------------------------------------</span>
<span class="sd">    baselineModeB: &#39;min&#39; (default) or &#39;edge&#39;, method to define the baseline </span>
<span class="sd">        Parameters only relevant if baselineModeB=&#39;min&#39;:</span>
<span class="sd">        * dropBaselineChannels: percentage of extreme values to drop</span>
<span class="sd">        * removeOutlierBaselineChannels: after dropBaselineChannels, remove &gt;4*scMAD </span>
<span class="sd">              outliers;  options: &#39;high&#39;, &#39;low&#39;, &#39;both&#39;, or &#39;&#39; == none/False</span>
<span class="sd">    useBaseline: &#39;low&#39;, &#39;middle&#39;, &#39;high&#39; or &#39;auto&#39;; auto tries to automatically pick &#39;low&#39; for</span>
<span class="sd">       spectra that are emission-line dominated, &#39;high&#39; if absorption line dominated, or &#39;both&#39; if</span>
<span class="sd">       both types of lines are present</span>
<span class="sd">    nBaselineChannels: if integer, then the number of channels to use in computing</span>
<span class="sd">         standard deviation/MAD of the baseline channels (i.e. the blue points in the plot)</span>
<span class="sd">         if float, then it is the fraction of channels to use (i.e. the percentile)</span>
<span class="sd">    sigmaFindContinuum: starting value for sigmaFindContinuum; passed to findContinuumChannels, </span>
<span class="sd">        &#39;auto&#39; starts with value:</span>
<span class="sd">        TDM: singleContinuum: 9, meanAboveThreshold: 4.5, peakOverMAD: 6.5,</span>
<span class="sd">             mom0mom8jointMask: 7.2</span>
<span class="sd">        FDM: meanAboveThreshold: 3.5, peakOverMAD: 6.0, </span>
<span class="sd">             mom0mom8jointMask: nchan&lt;750: 4.2 (strong lines) or 4.5 (weak lines) </span>
<span class="sd">                                nchan&gt;=759: 2.5 (strong lines) or 3.2 (weak lines)</span>
<span class="sd">        and adjusts it depending on results</span>
<span class="sd">    sigmaFindContinuumMode (new in PL2020): &#39;auto&#39;, &#39;autolower&#39;, &#39;fixed&#39;</span>
<span class="sd">    trimChannels: after doing best job of finding continuum, remove this many </span>
<span class="sd">         channels from each edge of each block of channels found (for margin of safety)</span>
<span class="sd">         If it is a float between 0..1, then trim this fraction of channels in each </span>
<span class="sd">         group (rounding up). If it is &#39;auto&#39; (default), use 0.1 but not more than </span>
<span class="sd">         maxTrim channels, and not more than maxTrimFraction</span>
<span class="sd">    narrow: the minimum number of channels that a group of channels must have to survive</span>
<span class="sd">            if 0&lt;narrow&lt;1, then it is interpreted as the fraction of all</span>
<span class="sd">                           channels within identified blocks</span>
<span class="sd">            if &#39;auto&#39;, then use int(ceil(log10(nchan)))</span>
<span class="sd">    maxTrim: in trimChannels=&#39;auto&#39;, this is the max channels to trim per group for </span>
<span class="sd">        TDM spws; it is automatically scaled upward for FDM spws.</span>
<span class="sd">    maxTrimFraction: in trimChannels=&#39;auto&#39;, the max fraction of channels to trim per group</span>
<span class="sd">    singleContinuum: if True, treat the cube as having come from a Single_Continuum setup;</span>
<span class="sd">        For testing purpose, if None, then check the contents of vis (if specified).</span>
<span class="sd">    negativeThresholdFactor: scale the nominal negative threshold by this factor (to </span>
<span class="sd">        adjust the sensitivity to absorption features: smaller values=more sensitive)</span>
<span class="sd">    signalRatioTier1: threshold for signalRatio, above which we desensitize the level to</span>
<span class="sd">        consider line emission in order to avoid small differences in noise levels from </span>
<span class="sd">        affecting the result (e.g. that occur between serial and parallel tclean cubes)</span>
<span class="sd">        signalRatio=1 means: no lines seen, while closer to zero: more lines seen</span>
<span class="sd">    enableRejectNarrowInnerWindows (new in PL2020): if True, then remove any inner groups </span>
<span class="sd">        of channels that are narrower than both edge windows (when there are 3-15 groups)</span>

<span class="sd">    General parameters:</span>
<span class="sd">    -------------------</span>
<span class="sd">    verbose: if True, then print additional information during processing</span>
<span class="sd">    useUncorrectedMedian: if True, then do not adjust the median (solid black line) upward</span>
<span class="sd">       from the median of the baseline points (dashed blue line)</span>
<span class="sd">    returnBluePoints: if True, then simply set the continuum ranges to the baseline points </span>
<span class="sd">         (i.e. the blue points) inside each run of findContinuumChannels().  If using</span>
<span class="sd">         mom0mom8jointMask with amendMask option, then also stop after amendMask (and</span>
<span class="sd">         automatically disable the onlyExtraMask step, even if enableOnlyExtraMask=True)</span>
<span class="sd">    momentdir (new in PL2020): alternative directory to look for (and write) the </span>
<span class="sd">         moment 0&amp;8 images</span>
<span class="sd">    png: the name of the png to produce (&#39;&#39; yields default name)</span>
<span class="sd">    pngBasename: if True, then remove the directory from img name before generating png name</span>
<span class="sd">    source: the name of the source, to be shown in the title of the spectrum.</span>
<span class="sd">            if None, then use imhead(&#39;object&#39;)</span>
<span class="sd">    overwrite: if True, or ASCII file does not exist, then recalculate the mean spectrum</span>
<span class="sd">                      writing it to &lt;img&gt;.meanSpectrum</span>
<span class="sd">               if False, then read the mean spectrum from the existing ASCII file</span>
<span class="sd">    separator: the character to use to separate groups of channels in the string returned</span>
<span class="sd">    titleText: default is img name and transition and the control parameter values</span>
<span class="sd">    plotAtmosphere: &#39;&#39;, &#39;tsky&#39;, or &#39;transmission&#39;</span>
<span class="sd">    airmass: for plot of atmospheric transmission</span>
<span class="sd">    skipchan (newly-exposed in PL2020): used in making the spectral plot, the number of highest </span>
<span class="sd">         and lowest intensity channels to avoid when constructing the y-axis range</span>
<span class="sd">    pwv: in mm (for plot of atmospheric transmission)</span>
<span class="sd">    vis: comma-delimited list or python list of measurement sets to use to convert channel</span>
<span class="sd">         ranges to topocentric frequency ranges (for use in uvcontfit or uvcontsub)</span>
<span class="sd">         or &#39;auto&#39; which will look for any/all vis in the cube directory</span>
<span class="sd">    plotBaselinePoints: if True, then plot the baseline-defining points as black dots</span>
<span class="sd">    fontsize (newly-exposed in PL2020): size to use for channel ranges, axis labels and plot legend</span>
<span class="sd">    dpi: dots per inch to use in writing the png (106 produces 861x649 pixels)</span>
<span class="sd">            150 produces 1218x918</span>
<span class="sd">    projectCode: a string to prepend to the title of the plot (useful for regression testing</span>
<span class="sd">        where you can put the page number from the full PDF when running only a subset)</span>
<span class="sd">    buildMom8fc (new in PL2020): if True, then when finished, generate &quot;mom8fc&quot; and &quot;mom0fc&quot;</span>
<span class="sd">              images using selected channels</span>
<span class="sd">    smallBandwidthFraction: threshold for returning a warning for too little bandwidth found</span>
<span class="sd">    smallSpreadFraction: threshold for returning a warning for too little bandwidth spread found</span>
<span class="sd">    telescope: name of telescope to use (if no image is passed from which to </span>
<span class="sd">        read it from the header)</span>
<span class="sd">    window: the smoothing window to apply to the mean spectrum (when nbin&gt;4)</span>
<span class="sd">    mom08simultaneous: if True, set moments=[0,8] in one call to immoments instead of two</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">executionTimeSeconds</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">singleContinuum</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vis</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">singleContinuum</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">meanSpectrumMethods</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized option for meanSpectrumMethod: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">meanSpectrumMethod</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Available options: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">meanSpectrumMethods</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">useBaseline</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span><span class="s1">&#39;high&#39;</span><span class="p">,</span><span class="s1">&#39;middle&#39;</span><span class="p">,</span><span class="s1">&#39;auto&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;useBaseline must be one of: low, high, middle, auto&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">meanSpectrumFile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">vis</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;If you specify meanSpectrumFile and vis, then you must also specify img (needed only to retrieve the osbserving date and direction).&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">userJointMask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">amendMaskIterations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You cannot set userJointMask at the same time as amendMaskIterations != 0&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">centralArcsec</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">centralArcsecValue</span> <span class="o">=</span> <span class="n">centralArcsec</span>
            <span class="n">centralArcsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centralArcsecValue</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">centralArcsec</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">centralArcsecValue</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Requested outdir does not exist.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="n">validWindows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;hanning&#39;</span><span class="p">,</span><span class="s1">&#39;hamming&#39;</span><span class="p">,</span><span class="s1">&#39;bartlett&#39;</span><span class="p">,</span><span class="s1">&#39;blackman&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">validWindows</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid window: </span><span class="si">%s</span><span class="s2">, must be one of: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">window</span><span class="p">),</span> <span class="n">validWindows</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The mask parameter is not relevant for meanSpectrumMethod=&#39;mom0mom8jointMask&#39;.  Use the userJointMask parameter instead.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
            <span class="n">trimChannelsString</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">trimChannels</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trimChannelsString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
            <span class="n">spectralDynamicRangeString</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectralDynamicRangeString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">narrow</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
            <span class="n">narrowString</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">narrow</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">narrowString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">narrow</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
            <span class="n">amendMaskIterationsString</span> <span class="o">=</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">amendMaskIterations</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amendMaskIterationsString</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> BEGINNING: </span><span class="si">%s</span><span class="s2"> findContinuum.findContinuum(&#39;</span><span class="si">%s</span><span class="s2">&#39;, overwriteMoments=</span><span class="si">%s</span><span class="s2">, sigmaFindContinuum=&#39;</span><span class="si">%s</span><span class="s2">&#39;, sigmaFindContinuumMode=&#39;</span><span class="si">%s</span><span class="s2">&#39;, meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39;, meanSpectrumFile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, singleContinuum=</span><span class="si">%s</span><span class="s2">, outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;, userJointMask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, useJointMaskPrior=</span><span class="si">%s</span><span class="s2">, momentdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;, amendMaskIterations=</span><span class="si">%s</span><span class="s2">, nbin=</span><span class="si">%d</span><span class="s2">, mom0minsnr=</span><span class="si">%f</span><span class="s2">, mom8minsnr=</span><span class="si">%f</span><span class="s2">, momDiffLevel=</span><span class="si">%f</span><span class="s2">, momDiffLevelForProceeding=</span><span class="si">%f</span><span class="s2">, returnBluePoints=</span><span class="si">%s</span><span class="s2">, useUncorrectedMedian=</span><span class="si">%s</span><span class="s2">, removeOutlierBaselineChannels=&#39;</span><span class="si">%s</span><span class="s2">&#39;, skipCubeNoise=</span><span class="si">%s</span><span class="s2">, trimChannels=</span><span class="si">%s</span><span class="s2">, narrow=</span><span class="si">%s</span><span class="s2">, spectralDynamicRangeBandWidth=</span><span class="si">%s</span><span class="s2">, vis=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="n">img</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">),</span> <span class="n">sigmaFindContinuumMode</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">userJointMask</span><span class="p">,</span> <span class="n">useJointMaskPrior</span><span class="p">,</span> <span class="n">momentdir</span><span class="p">,</span> <span class="n">amendMaskIterationsString</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">returnBluePoints</span><span class="p">,</span> <span class="n">useUncorrectedMedian</span><span class="p">,</span> <span class="n">removeOutlierBaselineChannels</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="p">,</span> <span class="n">trimChannelsString</span><span class="p">,</span> <span class="n">narrowString</span><span class="p">,</span> <span class="n">spectralDynamicRangeString</span><span class="p">,</span> <span class="n">vis</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> BEGINNING: </span><span class="si">%s</span><span class="s2"> findContinuum.findContinuum(&#39;</span><span class="si">%s</span><span class="s2">&#39;, centralArcsec=</span><span class="si">%s</span><span class="s2">, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, overwrite=</span><span class="si">%s</span><span class="s2">, sigmaFindContinuum=&#39;</span><span class="si">%s</span><span class="s2">&#39;, sigmaFindContinuumMode=&#39;</span><span class="si">%s</span><span class="s2">&#39;, meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39;, peakFilterFWHM=</span><span class="si">%.0f</span><span class="s2">, meanSpectrumFile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, triangleFraction=</span><span class="si">%.2f</span><span class="s2">, singleContinuum=</span><span class="si">%s</span><span class="s2">, useIAGetProfile=</span><span class="si">%s</span><span class="s2">, outdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, nbin=</span><span class="si">%d</span><span class="s2">, vis=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">],</span> <span class="n">img</span><span class="p">,</span> <span class="n">centralArcsecValue</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">),</span> <span class="n">sigmaFindContinuumMode</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">triangleFraction</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">vis</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">imageInfo</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># information returned from getImageInfo</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># convert vis to a list (if it is a string)</span>
        <span class="c1"># vis is a non-blank list or non-blank string</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="c1"># vis is now assured to be a non-blank list</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vis</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find measurement set: &quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
                <span class="k">return</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">meanSpectrumFile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting overwrite to False because both img and meanSpectrumFile were specified!&quot;</span><span class="p">)</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">)):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not find image = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imageInfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span> 
            <span class="k">return</span> 
        <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="p">,</span> <span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">imgShape</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">maxBaselineIgnore</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="n">imageInfo</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">nchan</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">,</span><span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;You must have more than one channel in the image.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">channelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># we need to define chanInfo for the tooLittleBandwidth function to work later</span>
        <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="n">readPreviousMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span>
        <span class="n">channelWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">lastFreq</span><span class="o">-</span><span class="n">firstFreq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">nchan</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">,</span><span class="n">channelWidth</span><span class="p">]</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Set chanInfo to &quot;</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">)</span>

    <span class="n">meanFreqHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">])</span>
    <span class="c1"># Look for the .pb image if it was not specified</span>
    <span class="k">if</span> <span class="n">pbcube</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pbcube</span> <span class="o">=</span> <span class="n">locatePBCube</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbcube</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found PB cube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">amendMaskIterations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No PB cube found, cannot use amendMask option.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="c1"># Look for the .psf image if it was not specified</span>
    <span class="k">if</span> <span class="n">psfcube</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">psfcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.psf&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.psf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psfcube</span><span class="p">):</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found PSF cube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">psfcube</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">psfcube</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">psfcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># i.e. it is not known if no image is passed</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">psfcube</span><span class="p">)[</span><span class="mi">11</span><span class="p">]</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Inferred max baseline = </span><span class="si">%f</span><span class="s1"> m&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxBaseline</span><span class="p">))</span>
        <span class="c1"># copy to the dirty cube for later use in the plot legend in runFindContinuum</span>
        <span class="n">imageInfo</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxBaseline</span>

    <span class="c1"># channelWidth, nchan, and maxBaseline are now defined, so we can define amendMaskIterations</span>
    <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nchan</span><span class="o">*</span><span class="n">channelWidth</span><span class="p">)</span> <span class="c1"># of the cube</span>
    <span class="n">minRegions</span> <span class="o">=</span> <span class="mi">13</span> <span class="c1"># 2021.1.00265.S spw18</span>
    <span class="n">originalNbin</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">nbin</span>
    <span class="k">if</span> <span class="n">spectralDynamicRangeBandWidth</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;None&#39;</span><span class="p">]:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Checking if nbin (</span><span class="si">%d</span><span class="s1">) is too wide compared to spectralDynamicRangeBandWidth of </span><span class="si">%s</span><span class="s1"> (=linewidth/3)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">))</span>
        <span class="n">spectralDynamicRangeBandWidthChannels</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToHz</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">)</span> <span class="o">/</span> <span class="n">channelWidth</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;spectralDynamicRangeBandWidth = </span><span class="si">%.2f</span><span class="s1"> channels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spectralDynamicRangeBandWidthChannels</span><span class="p">))</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">nchan</span> <span class="o">//</span> <span class="n">minRegions</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidthChannels</span><span class="p">))])</span>
        <span class="k">if</span> <span class="n">nbin</span> <span class="o">&lt;</span> <span class="n">originalNbin</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Reducing nbin from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">originalNbin</span><span class="p">,</span> <span class="n">nbin</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Checking if nbin (</span><span class="si">%d</span><span class="s1">) is too wide compared to repBW&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">))</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
              <span class="c1"># look for any .ms in the img directory (sometimes needed for transition name and repSpw BW)</span>
              <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searching for vis in cube directory&quot;</span><span class="p">)</span>
              <span class="n">vis</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="s1">&#39;*ms&#39;</span><span class="p">))</span>
              <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found list of vis: &quot;</span><span class="p">,</span> <span class="n">vis</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">/</span> <span class="n">nbin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minRegions</span><span class="p">:</span>
<span class="c1">#        if len(vis) == 0:</span>
<span class="c1">#            # look for any .ms in the img directory</span>
<span class="c1">#            print(&quot;Searching for vis in cube directory&quot;)</span>
<span class="c1">#            vis = glob.glob(os.path.join(os.path.dirname(img),&#39;*ms&#39;))</span>
<span class="c1">#            print(&quot;Found list of vis: &quot;, vis)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vis = </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vis</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">representativeSpwBandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">repSpw</span><span class="p">,</span> <span class="n">repBW</span><span class="p">,</span> <span class="n">repNchan</span><span class="p">,</span> <span class="n">minBW</span><span class="p">,</span> <span class="n">maxBW</span> <span class="o">=</span> <span class="n">surmiseRepresentativeSpw</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">repBW</span><span class="p">,</span> <span class="n">repSpw</span><span class="p">,</span> <span class="n">repNchan</span><span class="p">,</span> <span class="n">minBW</span><span class="p">,</span> <span class="n">maxBW</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">bandwidthForSensitivity</span> <span class="o">=</span> <span class="p">(</span><span class="n">repBW</span><span class="o">/</span><span class="n">repNchan</span><span class="p">)</span><span class="o">*</span><span class="n">nbin</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;bandwidthForSensitivity = </span><span class="si">%.6f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bandwidthForSensitivity</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">))</span>
                <span class="n">myspw</span> <span class="o">=</span> <span class="n">getSpwFromPipelineImageName</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">myspw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">minBW</span> <span class="o">&lt;</span> <span class="mf">215e6</span> <span class="ow">and</span> <span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="mf">650e6</span><span class="p">):</span>
                        <span class="c1"># If I am wide (937/1875) and any other window is </span>
                        <span class="c1"># narrow (58/117), then limit nbin</span>
                        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">nbin</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span><span class="p">:</span>
                                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Because my spw is wide and another spw is narrow, limiting nbin to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">bandwidthForSensitivity</span> <span class="o">&gt;</span> <span class="n">bandwidth</span><span class="p">):</span>
                        <span class="c1"># If the bwForSensitivity is </span>
                        <span class="c1"># wider than me, then limit nbin</span>
                        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">nbin</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span><span class="p">:</span>
                                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">3</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Because my spw bandwidth (</span><span class="si">%f</span><span class="s1">) is narrower than the bandwidthForSensitivity (</span><span class="si">%f</span><span class="s1">), limiting nbin to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bandwidth</span><span class="p">,</span><span class="n">bandwidthForSensitivity</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">repBW</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;rep spw not found from ms.&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;My bandwidth is not much wider than the narrowest spw, nor is it narrower than the bandwidthForSensitivity.&#39;</span><span class="p">)</span>
                        <span class="n">nbin</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">//</span> <span class="n">minRegions</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Setting nbin to </span><span class="si">%d</span><span class="s1">//</span><span class="si">%d</span><span class="s1"> = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="p">,</span><span class="n">minRegions</span><span class="p">,</span><span class="n">nbin</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;spw ID not parsed from img name.&#39;</span><span class="p">)</span>
                    <span class="n">nbin</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">//</span> <span class="n">minRegions</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Could not find vis=</span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">nbin</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">//</span> <span class="n">minRegions</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No vis specified. Skipping search for repSpw.&#39;</span><span class="p">)</span>
            <span class="n">nbin</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">//</span> <span class="n">minRegions</span>
        <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;For nchan=</span><span class="si">%d</span><span class="s1">, limiting nbin from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">originalNbin</span><span class="p">,</span> <span class="n">nbin</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>  <span class="c1">#  (nchan / nbin) &gt;= minRegions:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;nchan/nbin = </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> &gt;= </span><span class="si">%d</span><span class="s1">=minRegions&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="p">,</span><span class="n">nbin</span><span class="p">,</span><span class="n">nchan</span><span class="o">/</span><span class="n">nbin</span><span class="p">,</span><span class="n">minRegions</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">telescope</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="n">amendMaskIterations</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;TDM spectrum detected with maxBaseline&gt;400m detected: setting amendMaskIterations=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">amendMaskIterations</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># 3</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;TDM spectrum detected with maxBaseline&lt;=400m: setting amendMaskIterations=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amendMaskIterations</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># 3</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;FDM spectrum detected: setting amendMaskIterations=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">))</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span> <span class="c1"># returnBluePoints:  (restriction is no longer desired) </span>
            <span class="k">if</span> <span class="n">enableOnlyExtraMask</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;returnBluePoints=True: disabling onlyExtraMask&#39;</span><span class="p">)</span>
                <span class="n">enableOnlyExtraMask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;returnBluePoints=True: reducing amendMaskIterations from </span><span class="si">%d</span><span class="s1"> to 1&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterations</span><span class="p">))</span>
                <span class="n">amendMaskIterations</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">,</span><span class="s1">&#39;.mask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">maskInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">maskShape</span> <span class="o">=</span> <span class="n">maskInfo</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maskShape</span> <span class="o">==</span> <span class="n">imgShape</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">centralArcsec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Shape of mask (</span><span class="si">%s</span><span class="s2">) does not match the image (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskShape</span><span class="p">,</span><span class="n">imgShape</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;If you want to automatically regrid the mask, then set its name explicitly.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span> 
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not find image mask = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mask</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="n">maskInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">maskShape</span> <span class="o">=</span> <span class="n">maskInfo</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">maskShape</span> <span class="o">==</span> <span class="n">imgShape</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Shape of mask matches the image.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Shape of mask (</span><span class="si">%s</span><span class="s2">) does not match the image (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskShape</span><span class="p">,</span><span class="n">imgShape</span><span class="p">))</span>
                <span class="c1"># check if the spatial dimension matches.  If so, then simply add channels</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">maskShape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">imgShape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                    <span class="n">maskShape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">imgShape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
                    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> 
                    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span> <span class="c1"># assume img &amp; mask have same spectral axis number</span>
                    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">imgShape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="o">+</span><span class="s1">&#39;.regrid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">):</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regridded mask already exists, so I will use it.&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regridding the spectral axis of the mask with replicate.&quot;</span><span class="p">)</span>
                            <span class="n">imregrid</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mask</span><span class="o">+</span><span class="s1">&#39;.regrid&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
                                     <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">replicate</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                     <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> 
                                     <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;This single plane mask will be used for all channels.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regridding the mask spatially and spectrally.&quot;</span><span class="p">)</span>
                    <span class="n">imregrid</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mask</span><span class="o">+</span><span class="s1">&#39;.regrid&#39;</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">asvelocity</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">+</span><span class="s1">&#39;.regrid&#39;</span>
                <span class="n">maskInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">maskShape</span> <span class="o">=</span> <span class="n">maskInfo</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>

    <span class="nb">bytes</span> <span class="o">=</span> <span class="n">getMemorySize</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="n">minGroupsForSFCAdjustment</span> <span class="o">=</span> <span class="n">minGroupsForSFCAdjustment</span> <span class="c1"># was 8 on april 3, 2018</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">minGroupsForSFCAdjustment</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;HOST&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Total memory on </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%.3f</span><span class="s2"> GB&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="nb">bytes</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">maxMemory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">maxMemory</span> <span class="o">&lt;</span> <span class="nb">bytes</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)):</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">maxMemory</span><span class="o">*</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;but behaving as if it has only </span><span class="si">%.3f</span><span class="s2"> GB&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">bytes</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>
    <span class="n">meanSpectrumMethodRequested</span> <span class="o">=</span> <span class="n">meanSpectrumMethod</span>
    <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span><span class="o">*</span><span class="n">naxis1</span><span class="o">*</span><span class="n">naxis2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">triangularPatternSeen</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">momDiffSNR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c1"># initialize it because it is passed to runFindContinuum for use in .autoLower</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">imhead</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Read sourcename from cube = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;vis=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">enableInitialQuadratic</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">sourceLower</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">bigPlanets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;venus&#39;</span><span class="p">,</span><span class="s1">&#39;mars&#39;</span><span class="p">,</span><span class="s1">&#39;moon&#39;</span><span class="p">,</span><span class="s1">&#39;jupiter&#39;</span><span class="p">,</span><span class="s1">&#39;saturn&#39;</span><span class="p">,</span><span class="s1">&#39;uranus&#39;</span><span class="p">,</span><span class="s1">&#39;neptune&#39;</span><span class="p">]</span>
        <span class="n">enableInitialQuadratic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">bigPlanet</span> <span class="ow">in</span> <span class="n">bigPlanets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sourceLower</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">bigPlanet</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">enableInitialQuadratic</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Found large planet: changing enableInitialQuadratic from &quot;auto&quot; to True.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># Try to find the name of the spw from the image name</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">telescope</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># PIPE-1636</span>
        <span class="n">transitionName</span> <span class="o">=</span> <span class="n">transitions</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spw</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> transition names for source=</span><span class="si">%s</span><span class="s1"> in </span><span class="si">%s</span><span class="s1">: = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transitionName</span><span class="p">),</span><span class="n">source</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">transitionName</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitionName</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">transitionName</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transitionName</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">n_ids</span> <span class="o">=</span> <span class="n">transitionName</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;id=&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transitionName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;cont&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> \
               <span class="n">n_ids</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># PL2024</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Resetting nbin=1 because &#39;cont&#39; found in transition names and only (up to) one ID= is present: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">transitionName</span><span class="p">))</span>
                <span class="c1">#  PL2023 are the lines below</span>
<span class="c1">#               transitionName.find(&#39;id=0&#39;) &gt;= 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=1&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=2&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=3&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=4&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=5&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=6&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=7&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=8&#39;) &lt; 0 and \</span>
<span class="c1">#               transitionName.find(&#39;id=9&#39;) &lt; 0:</span>
<span class="c1">#                casalogPost(&quot;Resetting nbin=1 because &#39;cont&#39; found in transition names with no non-zero IDs: &quot;, transitionName)</span>
                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># Cycle 4+5 Heuristic</span>
        <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;meanAboveThreshold&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">atmosphereVariation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">skyTransmissionThreshold</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">skyTempThreshold</span><span class="p">):</span>
                <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;peakOverMad&#39;</span>
                <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Set meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; since atmos. variation </span><span class="si">%.2f</span><span class="s2">&gt;</span><span class="si">%.2f</span><span class="s2"> or </span><span class="si">%.3f</span><span class="s2">&gt;</span><span class="si">%.1f</span><span class="s2">K.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">skyTempThreshold</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;</span> <span class="n">tdmSkyTempThreshold</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="n">nchan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e9</span><span class="p">):</span> <span class="c1"># tdmSpectrum(channelWidth,nchan)):</span>
                <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;peakOverMad&#39;</span>
                <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Set meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; since atmos. variation </span><span class="si">%.2f</span><span class="s2">&gt;</span><span class="si">%.2f</span><span class="s2"> or </span><span class="si">%.3f</span><span class="s2">&gt;</span><span class="si">%.2f</span><span class="s2">K.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">tdmSkyTempThreshold</span><span class="p">)</span>
                <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Maybe comment this out once thresholds are stable</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="n">nchan</span> <span class="o">&gt;</span> <span class="mf">1e9</span><span class="p">):</span> <span class="c1"># tdmSpectrum(channelWidth,nchan):</span>
                    <span class="n">myThreshold</span> <span class="o">=</span> <span class="n">tdmSkyTempThreshold</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">myThreshold</span> <span class="o">=</span> <span class="n">skyTempThreshold</span>
                <span class="n">triangularPatternSeen</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">checkForTriangularWavePattern</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">triangleFraction</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">triangularPatternSeen</span><span class="p">):</span>
                    <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;peakOverMad&#39;</span>
                    <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Set meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; since triangular pattern was seen (</span><span class="si">%.2f</span><span class="s2">&lt;</span><span class="si">%.2f</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">triangleFraction</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">triangleMsg</span> <span class="o">=</span> <span class="s1">&#39;slopeTest=F&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">triangleMsg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&gt;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">triangleFraction</span><span class="p">)</span>
                    <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Did not change meanSpectrumMethod since atmos. variation </span><span class="si">%.2f</span><span class="s2">&lt;</span><span class="si">%.2f</span><span class="s2"> &amp; </span><span class="si">%.3f</span><span class="s2">&lt;</span><span class="si">%.1f</span><span class="s2">K (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">myThreshold</span><span class="p">,</span><span class="n">triangleMsg</span><span class="p">)</span>
<span class="c1">#                    meanSpectrumMethodMessage = &quot;Did not change meanSpectrumMethod from %s since atmos. variation %.2f&lt;%.2f &amp; %.3f&lt;%.1fK (%s).&quot; % (meanSpectrumMethod,b,skyTransmissionThreshold,e,myThreshold,triangleMsg)</span>

            <span class="n">casalogPost</span><span class="p">(</span><span class="n">meanSpectrumMethodMessage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="c1"># Cycle 6 Heuristic</span>
        <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">centralArcsecLimitedField</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">normalizeByMAD</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="c1"># second phrase added on March 22, 2019</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">atmosphereVariation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="n">pwv</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">skyTransmissionThreshold</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">skyTempThreshold</span><span class="p">):</span>
                <span class="n">normalizeByMAD</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;will potentially normalize by MAD since atmospheric variation </span><span class="si">%.2f</span><span class="s2">&gt;</span><span class="si">%.2f</span><span class="s2"> or </span><span class="si">%.3f</span><span class="s2">&gt;</span><span class="si">%.1f</span><span class="s2">K.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">skyTempThreshold</span><span class="p">)</span>
                <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#            elif (e &gt; tdmSkyTempThreshold and abs(channelWidth*nchan) &gt; 1e9): # tdmSpectrum(channelWidth,nchan)): # commented out whole elif when PIPE-848 implemented</span>
<span class="c1">#                normalizeByMAD = True</span>
<span class="c1">#                meanSpectrumMethodMessage = &quot;will potentially normalize by MAD since atmospheric variation %.2f&gt;%.2f or %.3f&gt;%.2fK.&quot; % (b,skyTransmissionThreshold,e,tdmSkyTempThreshold)</span>
<span class="c1">#                badAtmosphere = True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">normalizeByMAD</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;normalizeByMAD=&#39;auto&#39; but atmos. variation is too small to use it (</span><span class="si">%.2f</span><span class="s2">&lt;=</span><span class="si">%.2f</span><span class="s2"> and </span><span class="si">%.3f</span><span class="s2">&lt;=</span><span class="si">%.2f</span><span class="s2">K).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">skyTempThreshold</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="n">meanSpectrumMethodMessage</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Cycle 4+5 Heuristic</span>
        <span class="n">maxpixels</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">/</span><span class="mi">67</span> <span class="c1"># float(1024)*1024*960</span>
        <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">centralArcsec</span>                    
        <span class="n">centralArcsecLimitedField</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">pixelsNotAProblem</span> <span class="o">=</span> <span class="n">useIAGetProfile</span> <span class="ow">and</span> <span class="n">meanSpectrumMethod</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">,</span><span class="s1">&#39;peakOverMad&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">mask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">npixels</span> <span class="o">&gt;</span> <span class="n">maxpixels</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pixelsNotAProblem</span><span class="p">)):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Excessive number of pixels (</span><span class="si">%.0f</span><span class="s2"> &gt; </span><span class="si">%.0f</span><span class="s2">) </span><span class="si">%d</span><span class="s2">x</span><span class="si">%d</span><span class="s2">x</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npixels</span><span class="p">,</span><span class="n">maxpixels</span><span class="p">,</span><span class="n">naxis1</span><span class="p">,</span><span class="n">naxis2</span><span class="p">,</span><span class="n">nchan</span><span class="p">))</span>
                <span class="n">totalWidthArcsec</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cdelt2</span><span class="o">*</span><span class="n">naxis2</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">totalWidthArcsec</span><span class="o">*</span><span class="n">maxpixels</span><span class="o">/</span><span class="n">npixels</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Finding size of the central square that fully contains the mask.&quot;</span><span class="p">)</span>
                    <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">widthOfMaskArcsec</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">maskInfo</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Width = </span><span class="si">%.3f</span><span class="s2"> arcsec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centralArcsecField</span><span class="p">))</span>
                <span class="n">newWidth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">naxis2</span><span class="o">*</span><span class="n">centralArcsecField</span><span class="o">/</span><span class="n">totalWidthArcsec</span><span class="p">)</span>
                <span class="n">centralArcsecLimitedField</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">centralArcsecField</span><span class="p">)</span>  <span class="c1"># Remember in case we need to reinvoke later</span>
                <span class="n">maxpixpos</span> <span class="o">=</span> <span class="n">getMaxpixpos</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">maxpixpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">naxis2</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">newWidth</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> 
                    <span class="n">maxpixpos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">naxis2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">newWidth</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span>
                    <span class="n">maxpixpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">naxis2</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">newWidth</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> 
                    <span class="n">maxpixpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">naxis2</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">newWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">npixels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span><span class="o">*</span><span class="n">newWidth</span><span class="o">*</span><span class="n">newWidth</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Data max is within the smaller field&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Reducing image width examined from </span><span class="si">%.2f</span><span class="s2"> to </span><span class="si">%.2f</span><span class="s2"> arcsec to avoid memory problems.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">totalWidthArcsec</span><span class="p">,</span><span class="n">centralArcsecField</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">centralArcsec</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;peakOverMad&#39;</span><span class="p">):</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Data max is NOT within the smaller field. Keeping meanSpectrumMethod of peakOverMad over full field.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;peakOverMad&#39;</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Data max NOT within the smaller field. Switch to meanSpectrumMethod=&#39;peakOverMad&#39;&quot;</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="n">meanSpectrumMethodMessage</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using whole field since npixels=</span><span class="si">%d</span><span class="s2"> &lt; maxpixels=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npixels</span><span class="p">,</span> <span class="n">maxpixels</span><span class="p">))</span>
                <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># use the whole field</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;fwhm&#39;</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">primaryBeamArcsec</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">]),</span>
                                                   <span class="n">showEquation</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">npixels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">centralArcsecField</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cdelt2</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">centralArcsec</span>
            <span class="k">if</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">npixels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">centralArcsec</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cdelt2</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># 0=normal run, 1=after amending mask (if necessary), 2=extraMask or onlyExtraMask (if necessary) </span>
        <span class="c1"># 3=lower sigmaFindContinuum (if necessary)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">amendMask</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">amendMask</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">intersectionOfSelections</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">better</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">amendMaskDecision</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># result from amendMaskYesOrNo (need to initialize it here in case it never gets run)</span>
    <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># result from extraMaskYesOrNo (need to initialize it here in case it never gets run)</span>
    <span class="n">extraMaskDecision2</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># result from second extraMaskYesOrNo (need to initialize it here in case it never gets run)</span>
    <span class="n">autoLowerDecision</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># result from third extraMaskYesOrNo (need to initialize it here in case it never gets run)</span>
    <span class="n">autoLower2Decision</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># result from fourth extraMaskYesOrNo (need to initialize it here in case it never gets run)</span>
    <span class="n">finalMom8fc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">finalMom0fc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">checkIfMaskWouldHaveBeenAmended</span><span class="p">:</span>
        <span class="n">buildMom8fc</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># this option needs to be True for this to work</span>

    <span class="c1">##############################################################################################</span>
    <span class="c1"># Each iteration is associated with a name, which corresponds to the heuristic that shall be</span>
    <span class="c1"># followed.  The name for the next iteration is set before the prior iteration concludes.</span>
    <span class="c1"># This name is appended to all output files produced during this iteration to avoid confusion.</span>
    <span class="c1">##############################################################################################</span>
    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">amendMaskIterationNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>  
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Start with just the original loop, additional names will be added later</span>
        <span class="n">amendMaskIterationNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.original&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">amendMaskIterations</span>
        <span class="c1"># other possible names are:  &#39;.amendedMask&#39;, &#39;.extraMask&#39;, &#39;.onlyExtraMask&#39;, &#39;.autoLower&#39;, &#39;.autoLower2&#39;</span>
    <span class="n">mom8fc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of image names, keyed by amendMaskIterationName</span>
    <span class="n">mom0fc</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dictionary of image names, keyed by amendMaskIterationName</span>
    <span class="n">momDiff</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionary of image names, keyed by amendMaskIterationName</span>

    <span class="c1"># Define the default name (used if amendMaskIterations==0), so that we can also use it to create </span>
    <span class="c1"># the longer names generated when amendMaskIterations &gt; 0</span>
    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
        <span class="n">momRoot</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># dictionary of image names, keyed by amendMaskIterationName</span>

    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># img is guaranteed to not end in a &#39;/&#39; since img.rstrip(&#39;/&#39;) is called above</span>
        <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
            <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.momfc&#39;</span>
            <span class="n">pbmom</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual.momfc&#39;</span><span class="p">,</span><span class="s1">&#39;.pbmom&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.mom8fc&#39;</span>
            <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.mom0fc&#39;</span>
            <span class="c1"># Make sure that we write the pbmom to the local directory that contains mom8fc and mom0fc</span>
            <span class="n">pbmom</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual.mom0fc&#39;</span><span class="p">,</span><span class="s1">&#39;.pbmom&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pbmom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pbcube</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;mom&#39;</span>
        <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
            <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.momfc&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.mom8fc&#39;</span>
            <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;.mom0fc&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">amendMask</span> <span class="ow">or</span> <span class="n">checkIfMaskWouldHaveBeenAmended</span><span class="p">):</span>
<span class="c1">#       This is now a control parameter in PL2022, for the manual use case.</span>
<span class="c1">#        momDiffLevel = 8.0 # 8.0 is what we want in general (for 16293 maser: 8 gives 6 pix, while 7.5 gives 13 pix)</span>
        <span class="c1">#  momDiffLevel gets modified further down by -0.5 if mom8fc is more diagnostic (as it is for that maser)</span>
        <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span> <span class="ow">and</span> <span class="n">singleContinuum</span><span class="p">:</span>
            <span class="n">momDiffLevel</span> <span class="o">+=</span> <span class="mf">3.5</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Raising momDiffLevel by 3.5 to </span><span class="si">%.1f</span><span class="s1"> because this is 7m singleContinuum&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffLevel</span><span class="p">))</span>
        <span class="n">momDiffLevelBadAtm</span> <span class="o">=</span> <span class="mf">11.5</span>  <span class="c1"># for amendMask and extraMask</span>
        <span class="n">momDiffLevelBadAtmOnlyExtraMask</span> <span class="o">=</span> <span class="mf">11.0</span>
        <span class="n">mom8level</span> <span class="o">=</span> <span class="mf">8.5</span>
        <span class="n">mom8levelBadAtm</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">cubeLevel</span> <span class="o">=</span> <span class="mf">7.5</span>
        <span class="n">cubeLevel2</span> <span class="o">=</span> <span class="mf">7.25</span>  <span class="c1"># needs to be somewhat smaller than cubeLevel</span>
        <span class="n">momDiffCode</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom8code</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># mom8code</span>
        <span class="n">momDiffPeak0</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># necessary in case neither AmendMask or ExtraMask is invoked but LowBW+LowSpread triggers a new range</span>
    <span class="k">for</span> <span class="n">amendMaskIteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">amendMaskIterations</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">amendMaskIteration</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># prevent undefined var if returnSFC=True</span>
            <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span> <span class="o">=</span> <span class="n">sigmaFindContinuum</span>
        <span class="c1"># On subsequent iterations, the amendMaskIterationName (and hence heuristics to follow)</span>
        <span class="c1"># will change based on decisions made from each new .mom8fc image results.</span>
        <span class="n">amendMaskIterationName</span> <span class="o">=</span> <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">amendMask</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">amendMaskIteration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;At start of iteration </span><span class="si">%d</span><span class="s1">: aggregateBandwidth = </span><span class="si">%.6f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;---------- amendMaskIteration </span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) -------------------- sFC=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">amendMaskIterationName</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">)))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;=======================================================================&quot;</span><span class="p">)</span>
            <span class="n">previousPng</span> <span class="o">=</span> <span class="n">png</span>
            <span class="n">previousSelection</span> <span class="o">=</span> <span class="n">selection</span>
            <span class="n">previousAggregateBandwidth</span> <span class="o">=</span> <span class="n">aggregateBandwidth</span>
        <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fullLegend</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">!=</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
            <span class="c1"># There can be multiple iterations, so highlight the first one in the log.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;---------- runFindContinuum iteration 0&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vis</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">singleContinuum</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this is now passed as a parameter</span>
            <span class="n">singleContinuum</span> <span class="o">=</span> <span class="n">isSingleContinuum</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># dump all parameter values to casa log (for debugging purposes)</span>
            <span class="k">for</span> <span class="n">v</span><span class="p">,</span><span class="n">variable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">img</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span>
                         <span class="n">baselineModeA</span><span class="p">,</span><span class="n">baselineModeB</span><span class="p">,</span> <span class="n">sigmaCube</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span>
                         <span class="n">sigmaFindContinuumMode</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">pngBasename</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="p">,</span> 
                         <span class="n">source</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> 
                         <span class="n">separator</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">titleText</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span>
                         <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">centralArcsecField</span><span class="p">,</span> 
                         <span class="n">channelWidth</span><span class="p">,</span> <span class="n">alternateDirectory</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> 
                         <span class="n">plotAtmosphere</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">channelFractionForSlopeRemoval</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                         <span class="n">invert</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> 
                         <span class="n">fullLegend</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">meanSpectrumMethodMessage</span><span class="p">,</span>
                         <span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span> <span class="n">regressionTest</span><span class="p">,</span> <span class="n">quadraticFit</span><span class="p">,</span>
                         <span class="n">npixels</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">triangularPatternSeen</span><span class="p">,</span> <span class="n">maxMemory</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="p">,</span>
                         <span class="nb">bytes</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="p">,</span> <span class="n">applyMaskToMask</span><span class="p">,</span> <span class="n">plotBaselinePoints</span><span class="p">,</span>
                         <span class="n">dropBaselineChannels</span><span class="p">,</span> <span class="n">madRatioUpperLimit</span><span class="p">,</span> <span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">projectCode</span><span class="p">,</span>
                         <span class="n">useIAGetProfile</span><span class="p">,</span><span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="p">,</span>
                         <span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span> <span class="n">minPixelsInJointMask</span><span class="p">,</span> <span class="n">userJointMask</span><span class="p">,</span>
                         <span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">snrThreshold</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">overwriteMasks</span><span class="p">,</span>
                         <span class="n">rmStatContQuadratic</span><span class="p">,</span> <span class="n">quadraticNsigma</span><span class="p">,</span> 
                         <span class="n">bidirectionalMaskPhase2</span><span class="p">,</span> <span class="n">makeMovie</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">allowBluePruning</span><span class="p">,</span>
                         <span class="n">avoidance</span><span class="p">,</span> <span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                         <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">,</span> <span class="n">amendMask</span><span class="p">,</span> <span class="n">momentdir</span><span class="p">],</span> <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">) </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.extraMask&#39;</span><span class="p">:</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">sigmaFindContinuumForExtraMask</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;amendMaskIteration</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) runFindContinuum: sFC=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">)))</span>
            
        <span class="n">result</span> <span class="o">=</span> <span class="n">runFindContinuum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> 
                                  <span class="n">baselineModeA</span><span class="p">,</span><span class="n">baselineModeB</span><span class="p">,</span>
                                  <span class="n">sigmaCube</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">pngBasename</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="p">,</span> 
                                  <span class="n">source</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> 
                                  <span class="n">percentile</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> 
                                  <span class="n">separator</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">titleText</span><span class="p">,</span> 
                                  <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span>
                                  <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">centralArcsecField</span><span class="p">,</span> 
                                  <span class="n">channelWidth</span><span class="p">,</span>
                                  <span class="n">alternateDirectory</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> 
                                  <span class="n">plotAtmosphere</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> 
                                  <span class="n">channelFractionForSlopeRemoval</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                                  <span class="n">invert</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> 
                                  <span class="n">fullLegend</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">meanSpectrumMethodMessage</span><span class="p">,</span>
                                  <span class="n">minGroupsForSFCAdjustment</span><span class="o">=</span><span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span>
                                  <span class="n">regressionTest</span><span class="o">=</span><span class="n">regressionTest</span><span class="p">,</span> <span class="n">quadraticFit</span><span class="o">=</span><span class="n">quadraticFit</span><span class="p">,</span>
                                  <span class="n">megapixels</span><span class="o">=</span><span class="n">npixels</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">triangularPatternSeen</span><span class="o">=</span><span class="n">triangularPatternSeen</span><span class="p">,</span>
                                  <span class="n">maxMemory</span><span class="o">=</span><span class="n">maxMemory</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span>
                                  <span class="n">byteLimit</span><span class="o">=</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="o">=</span><span class="n">singleContinuum</span><span class="p">,</span>
                                  <span class="n">applyMaskToMask</span><span class="o">=</span><span class="n">applyMaskToMask</span><span class="p">,</span> <span class="n">plotBaselinePoints</span><span class="o">=</span><span class="n">plotBaselinePoints</span><span class="p">,</span>
                                  <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                  <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                  <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span>
                                  <span class="n">useIAGetProfile</span><span class="o">=</span><span class="n">useIAGetProfile</span><span class="p">,</span><span class="n">useThresholdWithMask</span><span class="o">=</span><span class="n">useThresholdWithMask</span><span class="p">,</span>
                                  <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="n">normalizeByMAD</span><span class="p">,</span>
                                  <span class="n">overwriteMoments</span><span class="o">=</span><span class="n">overwriteMoments</span><span class="p">,</span>
                                  <span class="n">minPeakOverMadForSFCAdjustment</span><span class="o">=</span><span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span>
                                  <span class="n">maxMadRatioForSFCAdjustment</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustment</span><span class="p">,</span>
                                  <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="p">,</span>
                                  <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="n">minPixelsInJointMask</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span>
                                  <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">snrThreshold</span><span class="o">=</span><span class="n">snrThreshold</span><span class="p">,</span> 
                                  <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">overwriteMasks</span><span class="o">=</span><span class="n">overwriteMasks</span><span class="p">,</span>
                                  <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="n">rmStatContQuadratic</span><span class="p">,</span> <span class="n">quadraticNsigma</span><span class="o">=</span><span class="n">quadraticNsigma</span><span class="p">,</span> 
                                  <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="n">bidirectionalMaskPhase2</span><span class="p">,</span> 
                                  <span class="n">makeMovie</span><span class="o">=</span><span class="n">makeMovie</span><span class="p">,</span> 
                                  <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">allowBluePruning</span><span class="o">=</span><span class="n">allowBluePruning</span><span class="p">,</span>
                                  <span class="n">avoidance</span><span class="o">=</span><span class="n">avoidance</span><span class="p">,</span> 
                                  <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                  <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">,</span>
                                  <span class="n">amendMask</span><span class="o">=</span><span class="n">amendMask</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">skipchan</span><span class="o">=</span><span class="n">skipchan</span><span class="p">,</span> 
                                  <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> 
                                  <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">useJointMaskPrior</span><span class="o">=</span><span class="n">useJointMaskPrior</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> 
                                  <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">peakOverMadCriterion</span><span class="o">=</span><span class="n">peakOverMadCriterion</span><span class="p">,</span>
                                  <span class="n">maxGroups</span><span class="o">=</span><span class="n">maxGroups</span><span class="p">,</span> <span class="n">momDiffApproachLevel</span><span class="o">=</span><span class="n">momDiffApproachLevel</span><span class="p">,</span>
                                  <span class="n">mom08simultaneous</span><span class="o">=</span><span class="n">mom08simultaneous</span><span class="p">,</span> 
                                  <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                  <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                  <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span> 
                                  <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="n">enableInitialQuadratic</span><span class="p">,</span>
                                  <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">,</span> <span class="n">spectralDynamicRangeString</span><span class="o">=</span><span class="n">spectralDynamicRangeString</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
            <span class="c1"># We only want to keep the new selection, not the other info</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">selectionPreBluePruning</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>   <span class="c1"># fix for PIPE-2034</span>
            <span class="n">finalSigmaFindContinuum</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>  <span class="c1"># new in PL2022</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selection</span><span class="p">,</span> <span class="n">mypng</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">selectionPreBluePruning</span><span class="p">,</span> <span class="n">finalSigmaFindContinuum</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">effectiveSigma</span><span class="p">,</span> <span class="n">baselineMAD</span><span class="p">,</span> <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Returned from runFindContinuum with finalSigmaFindContinuum = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">finalSigmaFindContinuum</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">mypng</span>
        <span class="n">mytest</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">!=</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
            <span class="c1"># Cycle 4+5 Heuristic</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="c1"># Only one range was found, so look closer into the center for a line</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Only one range of channels was found&quot;</span><span class="p">)</span>
                <span class="n">myselection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">myselection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myselection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparing range of </span><span class="si">%d</span><span class="s2">~</span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2">/2&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nchan</span><span class="p">))</span>
                    <span class="n">mytest</span> <span class="o">=</span> <span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mytest</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mytest</span><span class="p">):</span>
                    <span class="n">reductionFactor</span> <span class="o">=</span> <span class="mf">10.0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">naxis1</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="n">reductionFactor</span><span class="p">):</span> <span class="c1"># reduced field must be at least 1 beam across (assuming 6 pix per beam)</span>
                        <span class="c1"># reduce the field size to one tenth of the previous</span>
                        <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="p">,</span> <span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">imgShape</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">maxBaselineIgnore</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="n">imageInfo</span> 
                        <span class="n">imageWidthArcsec</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">naxis2</span><span class="o">*</span><span class="n">cdelt2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">naxis1</span><span class="o">*</span><span class="n">cdelt1</span><span class="p">))</span>
                        <span class="n">npixels</span> <span class="o">/=</span> <span class="n">reductionFactor</span><span class="o">**</span><span class="mi">2</span>
                        <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">imageWidthArcsec</span><span class="o">/</span><span class="n">reductionFactor</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Reducing the field size to 1/10 of previous (</span><span class="si">%f</span><span class="s2"> arcsec to </span><span class="si">%f</span><span class="s2"> arcsec) (</span><span class="si">%d</span><span class="s2"> to </span><span class="si">%d</span><span class="s2"> pixels)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imageWidthArcsec</span><span class="p">,</span><span class="n">centralArcsecField</span><span class="p">,</span><span class="n">naxis1</span><span class="p">,</span><span class="n">naxis1</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span>
                        <span class="c1"># could change the 128 to tdmSpectrum(channelWidth,nchan), but this heuristic may also help</span>
                        <span class="c1"># for excerpts of larger cubes with narrower channel widths.</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">nBaselineChannels</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nchan</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">):</span>  
                            <span class="n">nBaselineChannels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="o">*</span><span class="mf">1.5</span><span class="p">]))</span>
                        <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum over central </span><span class="si">%.1f</span><span class="s2"> arcsec with nBaselineChannels=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centralArcsecField</span><span class="p">,</span><span class="n">nBaselineChannels</span><span class="p">))</span>
                        <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">runFindContinuum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="n">baselineModeA</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span>
                                                  <span class="n">sigmaCube</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                                  <span class="n">verbose</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">pngBasename</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="p">,</span> 
                                                  <span class="n">source</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> 
                                                  <span class="n">percentile</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> 
                                                  <span class="n">separator</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">titleText</span><span class="p">,</span> 
                                                  <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span>
                                                  <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">centralArcsecField</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span>
                                                  <span class="n">alternateDirectory</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> 
                                                  <span class="n">plotAtmosphere</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> 
                                                  <span class="n">channelFractionForSlopeRemoval</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                                                  <span class="n">invert</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> 
                                                  <span class="n">fullLegend</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span><span class="n">meanSpectrumMethodMessage</span><span class="p">,</span>
                                                  <span class="n">minGroupsForSFCAdjustment</span><span class="o">=</span><span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span>
                                                  <span class="n">regressionTest</span><span class="o">=</span><span class="n">regressionTest</span><span class="p">,</span> <span class="n">quadraticFit</span><span class="o">=</span><span class="n">quadraticFit</span><span class="p">,</span>
                                                  <span class="n">megapixels</span><span class="o">=</span><span class="n">npixels</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">triangularPatternSeen</span><span class="o">=</span><span class="n">triangularPatternSeen</span><span class="p">,</span>
                                                  <span class="n">maxMemory</span><span class="o">=</span><span class="n">maxMemory</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span>
                                                  <span class="n">byteLimit</span><span class="o">=</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="o">=</span><span class="n">singleContinuum</span><span class="p">,</span>
                                                  <span class="n">applyMaskToMask</span><span class="o">=</span><span class="n">applyMaskToMask</span><span class="p">,</span> <span class="n">plotBaselinePoints</span><span class="o">=</span><span class="n">plotBaselinePoints</span><span class="p">,</span>
                                                  <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                                  <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                                  <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span>
                                                  <span class="n">useIAGetProfile</span><span class="o">=</span><span class="n">useIAGetProfile</span><span class="p">,</span><span class="n">useThresholdWithMask</span><span class="o">=</span><span class="n">useThresholdWithMask</span><span class="p">,</span>
                                                  <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="o">=</span><span class="n">overwriteMoments</span><span class="p">,</span>
                                                  <span class="n">minPeakOverMadForSFCAdjustment</span><span class="o">=</span><span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span>
                                                  <span class="n">maxMadRatioForSFCAdjustment</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustment</span><span class="p">,</span>
                                                  <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="p">,</span>
                                                  <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="n">minPixelsInJointMask</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span>
                                                  <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">snrThreshold</span><span class="o">=</span><span class="n">snrThreshold</span><span class="p">,</span> 
                                                  <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">mom8minsnr</span><span class="p">,</span> 
                                                  <span class="n">overwriteMasks</span><span class="o">=</span><span class="n">overwriteMasks</span><span class="p">,</span> <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="n">rmStatContQuadratic</span><span class="p">,</span> 
                                                  <span class="n">quadraticNsigma</span><span class="o">=</span><span class="n">quadraticNsigma</span><span class="p">,</span> <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="n">bidirectionalMaskPhase2</span><span class="p">,</span> 
                                                  <span class="n">makeMovie</span><span class="o">=</span><span class="n">makeMovie</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">allowBluePruning</span><span class="o">=</span><span class="n">allowBluePruning</span><span class="p">,</span> <span class="n">avoidance</span><span class="o">=</span><span class="n">avoidance</span><span class="p">,</span> 
                                                  <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                                  <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">,</span> 
                                                  <span class="n">amendMask</span><span class="o">=</span><span class="n">amendMask</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">skipchan</span><span class="o">=</span><span class="n">skipchan</span><span class="p">,</span>
                                                  <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> 
                                                  <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">useJointMaskPrior</span><span class="o">=</span><span class="n">useJointMaskPrior</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> 
                                                  <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=</span><span class="n">momDiffSNR</span><span class="p">,</span> 
                                                  <span class="n">peakOverMadCriterion</span><span class="o">=</span><span class="n">peakOverMadCriterion</span><span class="p">,</span>
                                                  <span class="n">maxGroups</span><span class="o">=</span><span class="n">maxGroups</span><span class="p">,</span> <span class="n">momDiffApproachLevel</span><span class="o">=</span><span class="n">momDiffApproachLevel</span><span class="p">,</span>
                                                  <span class="n">mom08simultaneous</span><span class="o">=</span><span class="n">mom08simultaneous</span><span class="p">,</span> <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                                  <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                                  <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                                  <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="n">enableInitialQuadratic</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">,</span> <span class="n">spectralDynamicRangeString</span><span class="o">=</span><span class="n">spectralDynamicRangeString</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">return</span>
                        <span class="n">selection</span><span class="p">,</span> <span class="n">mypng</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">selectionPreBluePruning</span><span class="p">,</span> <span class="n">finalSigmaFindContinuum</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">effectiveSigma</span><span class="p">,</span> <span class="n">baselineMAD</span><span class="p">,</span> <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="n">result</span>
                        <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">png</span> <span class="o">=</span> <span class="n">mypng</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************ b) png passed into initial call was blank&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;*** Not reducing field size since it would be less than 1 beam across&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;*** Not reducing field size since more than 1 range found&quot;</span><span class="p">)</span>
        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethodRequested</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
            <span class="c1"># Cycle 4+5 Heuristic</span>
            <span class="c1"># Here we check to see if we need to switch the method of computing the mean spectrum</span>
            <span class="c1"># based on any undesirable characteristics of the results, and if so, re-run it.</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aggregateBandwidth</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span> <span class="ow">or</span> 
                  <span class="c1"># the following line was an attempt to solve CAS-9269 case reported by Ilsang Yoon for SCOPS-2571</span>
      <span class="c1">#            (mytest and meanSpectrumMethod!=&#39;peakOverMad&#39; and groups &lt; 2) or</span>
                  <span class="p">(</span><span class="ow">not</span> <span class="n">useLowBaseline</span> <span class="ow">and</span> <span class="n">meanSpectrumMethod</span><span class="o">==</span><span class="s1">&#39;peakOverMad&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">,</span><span class="n">telescope</span><span class="p">))</span> <span class="ow">or</span>
                  <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">==</span><span class="s1">&#39;peakOverMad&#39;</span> <span class="ow">and</span> <span class="n">meanSpectrumMethodMessage</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span>
                   <span class="ow">and</span> <span class="n">groups</span> <span class="o">&gt;</span> <span class="n">maxGroupsForSkyThreshold</span>
                   <span class="c1"># the following line maintains peakOverMad for dataset in CAS-8908 (and also OMC1_NW spw39 in CAS-8720)</span>
                   <span class="ow">and</span> <span class="n">aggregateBandwidth</span> <span class="o">&lt;</span> <span class="n">minBandwidthFractionForSkyThreshold</span><span class="o">*</span><span class="n">nchan</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span>
                   <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">,</span><span class="n">telescope</span><span class="p">))):</span>
                <span class="c1"># If less than 10 kHz is found (or two other situations), then try the other approach.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;peakOverMad&#39;</span><span class="p">):</span>
                    <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;meanAboveThreshold&#39;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">aggregateBandwidth</span> <span class="o">&lt;=</span> <span class="mf">0.00001</span><span class="p">):</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Reverted to meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; because no continuum found.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with the other meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> (because aggregateBW=</span><span class="si">%e</span><span class="s2">GHz is less than 10kHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">aggregateBandwidth</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">useLowBaseline</span> <span class="ow">and</span> <span class="n">meanSpectrumMethod</span><span class="o">==</span><span class="s1">&#39;peakOverMad&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">,</span><span class="n">telescope</span><span class="p">)):</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Reverted to meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; because useLowBaseline=F.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with the other meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> (because useLowBaseline=False)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">aggregateBandwidth</span> <span class="o">&lt;</span> <span class="n">minBandwidthFractionForSkyThreshold</span><span class="o">*</span><span class="n">nchan</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span> <span class="ow">and</span> <span class="n">groups</span><span class="o">&gt;</span><span class="n">maxGroupsForSkyThreshold</span><span class="p">):</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Reverted to meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; because groups=</span><span class="si">%d</span><span class="s2">&gt;</span><span class="si">%d</span><span class="s2"> and not TDM.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">maxGroupsForSkyThreshold</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with the other meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> because it is an FDM spectrum with many groups (</span><span class="si">%d</span><span class="s2">&gt;</span><span class="si">%d</span><span class="s2">) and aggregate bandwidth (</span><span class="si">%f</span><span class="s2"> GHz) &lt; </span><span class="si">%.2f</span><span class="s2"> of total bandwidth.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">maxGroupsForSkyThreshold</span><span class="p">,</span><span class="n">aggregateBandwidth</span><span class="p">,</span><span class="n">minBandwidthFractionForSkyThreshold</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">groups</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">sigmaFindContinuum</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                                <span class="c1"># Fix for CAS-9639: strong line near band edge and odd noise characteristic</span>
                                <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">6.5</span>
                                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Setting sigmaFindContinuum = </span><span class="si">%.1f</span><span class="s1"> since groups &lt; 2&#39;</span> <span class="o">%</span> <span class="n">sigmaFindContinuum</span><span class="p">)</span>
                                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> because groups=</span><span class="si">%d</span><span class="s2">&lt;2.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span> <span class="c1"># a value was specified for sigmaFindContinuum</span>
                                <span class="k">if</span> <span class="n">sigmaFindContinuumMode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                                    <span class="n">sigmaFindContinuum</span> <span class="o">+=</span> <span class="mf">3.0</span>
                                    <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Increasing sigmaFindContinuum by 3 to </span><span class="si">%.1f</span><span class="s2"> because groups=</span><span class="si">%d</span><span class="s2">&lt;2 and not TDM.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">,</span><span class="n">groups</span><span class="p">)</span>
                                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> because groups=</span><span class="si">%d</span><span class="s2">&lt;2.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">elif</span> <span class="n">groups</span> <span class="o">&gt;</span> <span class="n">maxGroupsForSkyThreshold</span><span class="p">:</span>
                            <span class="c1"># hot core FDM case</span>
                            <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Reverted to meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; because groups=</span><span class="si">%d</span><span class="s2">&gt;</span><span class="si">%d</span><span class="s2"> and not TDM.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">maxGroupsForSkyThreshold</span><span class="p">)</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with meanSpectrumMethod: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;Reverted to meanSpectrumMethod=&#39;</span><span class="si">%s</span><span class="s2">&#39; because groups=</span><span class="si">%d</span><span class="s2"> and not TDM.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">groups</span><span class="p">)</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with meanSpectrumMethod: </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsecLimitedField</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># Re-establish the previous limit</span>
                        <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="n">centralArcsecLimitedField</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-establishing the limit on field width determined earlier: </span><span class="si">%f</span><span class="s2"> arcsec&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">centralArcsecField</span><span class="p">))</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">meanSpectrumMethod</span> <span class="o">=</span> <span class="s1">&#39;peakOverMad&#39;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mytest</span> <span class="ow">and</span> <span class="n">groups</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">centralArcsecField</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> (because still only 1 group found after zoom)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-running findContinuum with the other meanSpectrumMethod: </span><span class="si">%s</span><span class="s2"> (because aggregateBW=</span><span class="si">%e</span><span class="s2">GHz is less than 10kHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">aggregateBandwidth</span><span class="p">))</span>
                    
                <span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">png</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">runFindContinuum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">transition</span><span class="p">,</span> <span class="n">baselineModeA</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span>
                                          <span class="n">sigmaCube</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                          <span class="n">verbose</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">pngBasename</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="p">,</span> 
                                          <span class="n">source</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> 
                                          <span class="n">percentile</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> 
                                          <span class="n">separator</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">titleText</span><span class="p">,</span> 
                                          <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span>
                                          <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">centralArcsecField</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span>
                                          <span class="n">alternateDirectory</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> 
                                          <span class="n">plotAtmosphere</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> 
                                          <span class="n">channelFractionForSlopeRemoval</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                                          <span class="n">invert</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> 
                                          <span class="n">fullLegend</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> 
                                          <span class="n">meanSpectrumMethodMessage</span><span class="p">,</span>
                                          <span class="n">minGroupsForSFCAdjustment</span><span class="o">=</span><span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span>
                                          <span class="n">regressionTest</span><span class="o">=</span><span class="n">regressionTest</span><span class="p">,</span> <span class="n">quadraticFit</span><span class="o">=</span><span class="n">quadraticFit</span><span class="p">,</span>
                                          <span class="n">megapixels</span><span class="o">=</span><span class="n">npixels</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">triangularPatternSeen</span><span class="o">=</span><span class="n">triangularPatternSeen</span><span class="p">,</span>
                                          <span class="n">maxMemory</span><span class="o">=</span><span class="n">maxMemory</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span>
                                          <span class="n">byteLimit</span><span class="o">=</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="o">=</span><span class="n">singleContinuum</span><span class="p">,</span> 
                                          <span class="n">applyMaskToMask</span><span class="o">=</span><span class="n">applyMaskToMask</span><span class="p">,</span> <span class="n">plotBaselinePoints</span><span class="o">=</span><span class="n">plotBaselinePoints</span><span class="p">,</span>
                                          <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                          <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                          <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span>
                                          <span class="n">useIAGetProfile</span><span class="o">=</span><span class="n">useIAGetProfile</span><span class="p">,</span><span class="n">useThresholdWithMask</span><span class="o">=</span><span class="n">useThresholdWithMask</span><span class="p">,</span>
                                          <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="o">=</span><span class="n">overwriteMoments</span><span class="p">,</span>
                                          <span class="n">minPeakOverMadForSFCAdjustment</span><span class="o">=</span><span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span> 
                                          <span class="n">maxMadRatioForSFCAdjustment</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustment</span><span class="p">,</span>
                                          <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="o">=</span><span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="p">,</span>
                                          <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="n">minPixelsInJointMask</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> 
                                          <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">snrThreshold</span><span class="o">=</span><span class="n">snrThreshold</span><span class="p">,</span> 
                                          <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">mom8minsnr</span><span class="p">,</span> 
                                          <span class="n">overwriteMasks</span><span class="o">=</span><span class="n">overwriteMasks</span><span class="p">,</span> <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="n">rmStatContQuadratic</span><span class="p">,</span> 
                                          <span class="n">quadraticNsigma</span><span class="o">=</span><span class="n">quadraticNsigma</span><span class="p">,</span> <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="n">bidirectionalMaskPhase2</span><span class="p">,</span> 
                                          <span class="n">makeMovie</span><span class="o">=</span><span class="n">makeMovie</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">allowBluePruning</span><span class="o">=</span><span class="n">allowBluePruning</span><span class="p">,</span> 
                                          <span class="n">avoidance</span><span class="o">=</span><span class="n">avoidance</span><span class="p">,</span> <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                          <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">,</span> 
                                          <span class="n">amendMask</span><span class="o">=</span><span class="n">amendMask</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">skipchan</span><span class="o">=</span><span class="n">skipchan</span><span class="p">,</span>
                                          <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> 
                                          <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">useJointMaskPrior</span><span class="o">=</span><span class="n">useJointMaskPrior</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> 
                                          <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">peakOverMadCriterion</span><span class="o">=</span><span class="n">peakOverMadCriterion</span><span class="p">,</span>
                                          <span class="n">maxGroups</span><span class="o">=</span><span class="n">maxGroups</span><span class="p">,</span> <span class="n">momDiffApproachLevel</span><span class="o">=</span><span class="n">momDiffApproachLevel</span><span class="p">,</span>
                                          <span class="n">mom08simultaneous</span><span class="o">=</span><span class="n">mom08simultaneous</span><span class="p">,</span> <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                          <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                          <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                          <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="n">enableInitialQuadratic</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">,</span> <span class="n">spectralDynamicRangeString</span><span class="o">=</span><span class="n">spectralDynamicRangeString</span><span class="p">)</span>
                <span class="n">selection</span><span class="p">,</span> <span class="n">mypng</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">selectionPreBluePruning</span><span class="p">,</span> <span class="n">finalSigmaFindContinuum</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">effectiveSigma</span><span class="p">,</span> <span class="n">baselineMAD</span><span class="p">,</span> <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="n">result</span>   <span class="c1"># used to say selectionPreBlueTruncation</span>
                <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">amendMask</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;************ c) png passed into initial call was blank&quot;</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">mypng</span>  <span class="c1"># update to the latest png name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not re-running findContinuum with the other method because the results are deemed acceptable.&quot;</span><span class="p">)</span>
<span class="c1">#        endif (meanSpectrumMethodRequested == &#39;auto&#39;):</span>
        <span class="k">if</span> <span class="n">amendMaskIteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">originalWarnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span> <span class="c1"># only used to prevent reversion</span>
            <span class="n">originalSelection</span> <span class="o">=</span> <span class="n">selection</span>  <span class="c1"># only used in the final reversion based on 4-letter code</span>
            <span class="n">originalPng</span> <span class="o">=</span> <span class="n">png</span>  <span class="c1"># only used in the final reversion based on 4-letter code</span>
        <span class="c1"># At this point, we are done the (potentially multiple) run(s) of runFindContinuum for this amendMaskIteration</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">amendMask</span> <span class="ow">or</span> <span class="n">buildMom8fc</span><span class="p">)</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">amendMaskIteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># create a mean pb image on the first iteration, as it is needed for image statistics</span>
                    <span class="c1">#removeIfNecessary(pbmom)  # in case there was a prior run of findContinuum</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>  <span class="c1"># PIPE-1657</span>
                            <span class="n">pbmomChans</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">pbmomChans</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">nchan</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nchan</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">nchan</span><span class="o">//</span><span class="mi">8</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[-1], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">pbmomChans</span><span class="p">))</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">pbmom</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">pbmomChans</span><span class="p">)</span>
                <span class="c1"># This mask test should remain as the original joint mask throughout the </span>
                <span class="c1"># process, not change to the amended mask, which is what happens to jointMask </span>
                <span class="c1"># in the return call from runFindContinuum(userJointMask=amendedMask).</span>
                <span class="k">if</span> <span class="n">jointMask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;&quot;==0&#39;</span>
                <span class="k">if</span> <span class="n">useAnnulus</span> <span class="ow">and</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="n">imageInfo</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this happens when meanSpectrumFile is specified</span>
                        <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is the pipeline use case</span>
                        <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="n">jointMaskTest</span> <span class="o">+</span> <span class="s1">&#39; &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># start of moved block for Cycle 11 PIPE-1644: we need to run this here so that we can label reverted spectra with difSNR</span>
            <span class="c1">##################################################</span>
            <span class="c1"># build a new mom0fc and mom8fc on every iteration</span>
            <span class="c1">##################################################</span>
            <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                <span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>  <span class="c1"># here is where .original is appended on the first round</span>
                <span class="n">mom8fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span>
                <span class="n">mom0fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mom8fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>   <span class="c1"># here is where .original is appended on the first round</span>
                <span class="n">mom0fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>   <span class="c1"># here is where .original is appended on the first round</span>
            <span class="n">mymom8fc</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span>  <span class="c1"># just a short-hand notation for easier use</span>
            <span class="n">mymom0fc</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span>  <span class="c1"># just a short-hand notation for easier use</span>
            <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
            <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mymom0fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
            <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">):</span>  <span class="c1"># save time during development phase</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[8], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">mymom8fc</span><span class="p">))</span>
                    <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mymom8fc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mymom0fc</span><span class="p">):</span>  <span class="c1"># save time during development phase</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">mymom0fc</span><span class="p">))</span>
                    <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mymom0fc</span><span class="p">)</span>

            <span class="c1"># To-Do PL2024: if dynamic range of mom0 is high, raise the mom0minsnr mask threshold</span>
            
            <span class="c1">#################################</span>
            <span class="c1"># create scaled version of mom0fc</span>
            <span class="c1">#################################</span>
            <span class="n">mom0fcScaled</span> <span class="o">=</span> <span class="n">mymom0fc</span><span class="o">+</span><span class="s1">&#39;.scaled&#39;</span>
            <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
            <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
            <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
            <span class="n">immath</span><span class="p">([</span><span class="n">mymom0fc</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcScaled</span><span class="p">)</span>
            <span class="c1">##########################################</span>
            <span class="c1"># Create a new momDiff on every iteration </span>
            <span class="c1">##########################################</span>
            <span class="n">momDiff</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.minus.mom0fcScaled&#39;</span> 
            <span class="n">mymomDiff</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span>
            <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
            <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;immath([&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], mode=&#39;evalexpr&#39;, expr=&#39;IM0-IM1&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span><span class="n">mom0fcScaled</span><span class="p">,</span><span class="n">mymask</span><span class="p">,</span><span class="n">mymomDiff</span><span class="p">))</span>
            <span class="n">immath</span><span class="p">([</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">mom0fcScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mymask</span><span class="p">,</span> 
                   <span class="n">outfile</span><span class="o">=</span><span class="n">mymomDiff</span><span class="p">)</span>
            <span class="n">finalMom8fc</span> <span class="o">=</span> <span class="n">mymom8fc</span>
            <span class="n">finalMom0fc</span> <span class="o">=</span> <span class="n">mymom0fc</span>
            <span class="n">finalMomDiff</span> <span class="o">=</span> <span class="n">mymomDiff</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymom8fc</span><span class="p">))</span>
            <span class="n">useTrimmedMADIfNeeded</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># experimental method that was abandonded</span>
            <span class="c1">##############################################</span>
            <span class="c1"># Recalculate stats for mom8fc every iteration</span>
            <span class="c1">##############################################</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">) Running imageSNR(&#39;</span><span class="si">%s</span><span class="s2">&#39;,mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;,applyMaskToAll=False)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">))</span>

            <span class="c1"># This is the SNR with peak measured over the whole image; but median and MAD from outside mask (and in annulus if useAnnulus=True)</span>
            <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                      <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">) Running imageSNR(&#39;</span><span class="si">%s</span><span class="s2">&#39;,mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;,applyMaskToAll=True)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span><span class="n">jointMaskTestAnnulus</span><span class="p">))</span>
            <span class="c1"># This is the SNR outside the mask</span>
            <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                <span class="n">mom8fcSNRMom8</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mom8fcSNRMom8</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                              <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mom8fcSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">) mom8fcMedian = </span><span class="si">%f</span><span class="s2">, mom8fcScaledMAD = </span><span class="si">%f</span><span class="s2">,  mom8fcSNRinside = </span><span class="si">%f</span><span class="s2">, mom8fcSNROutside=</span><span class="si">%f</span><span class="s2">, mom8fcSum = </span><span class="si">%f</span><span class="s2">, mom8fcPeak=</span><span class="si">%f</span><span class="s2">, mom8fcPeakOutside=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcSNRMom8</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">))</span>

            <span class="c1">###############################################</span>
            <span class="c1"># Recalculate stats for momDiff every iteration</span>
            <span class="c1">###############################################</span>
            <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                          <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># end of moved block for Cycle 11 PIPE-1644</span>
            
            <span class="k">if</span> <span class="n">amendMaskIteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># copied this &#39;if&#39; statement from above for PIPE-1644</span>
                <span class="c1"># save the first png again, with the tag &quot;reverted&quot; added, in case we need it later</span>
                <span class="n">labelDescs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
<span class="c1">#                revertedAreaString = areaString + &#39;, reverted&#39;</span>
                <span class="n">revertedAreaString</span> <span class="o">=</span> <span class="n">areaString</span> <span class="o">+</span> <span class="s1">&#39;, reverted, difSNR=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">)</span>
                <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">revertedAreaString</span> <span class="o">+=</span> <span class="s1">&#39;, LowBW&#39;</span>
                    <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;spread&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">revertedAreaString</span> <span class="o">+=</span> <span class="s1">&#39;, LowSpread&#39;</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Drawing new areaString: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">revertedAreaString</span><span class="p">))</span>
                <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">revertedAreaString</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
                <span class="n">revertedPng</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;.reverted.png&#39;</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">revertedPng</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

                <span class="c1"># put back the original label</span>
                <span class="n">labelDescs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="c1"># Write out the original _findContinuum.dat file, for testing future improvements of heuristics</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumFile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> 
                    <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">buildMeanSpectrumFilename</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">outdir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
                <span class="c1"># only the base name of the meanSpectrumFile is used by writeContDat, not the contents</span>
                <span class="n">contDat</span> <span class="o">=</span> <span class="n">writeContDat</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span>
                                      <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> 
                                      <span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
            <span class="c1"># endif amendMaskIteration == 0</span>

            
            <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">amendMaskIterationName</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">mymomDiff</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">amendMask</span><span class="p">:</span> <span class="c1"># put momDiffSNR label even on the amendMask=False results</span>
                <span class="n">labelDescs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;, difSNR=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">)</span>
                <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="n">difSNRFontsizeAdjust</span><span class="p">)</span>
                <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="c1"># This is the SNR outside the mask</span>
            <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                                   <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">momDiffSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="c1">#        endif (amendMask or buildMom8fc) and img != &#39;&#39;:</span>

        <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">amendMask</span> <span class="ow">or</span> <span class="n">checkIfMaskWouldHaveBeenAmended</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.original&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">badAtmosphere</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># in case this was not established above (i.e. someone ran it with normalizeByMAD=False)</span>
                    <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">e</span> <span class="o">=</span> <span class="n">atmosphereVariation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="n">pwv</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                    <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;</span> <span class="n">skyTransmissionThreshold</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="n">skyTempThreshold</span><span class="p">):</span>
                        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;setting badAtmosphere=True since atmospheric variation </span><span class="si">%.2f</span><span class="s2">&gt;</span><span class="si">%.2f</span><span class="s2"> or </span><span class="si">%.3f</span><span class="s2">&gt;</span><span class="si">%.1f</span><span class="s2">K.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">skyTransmissionThreshold</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">skyTempThreshold</span><span class="p">)</span>
<span class="c1">#                    elif (e &gt; tdmSkyTempThreshold and abs(channelWidth*nchan) &gt; 1e9): # commented out whole elif when PIPE-848 implemented</span>
<span class="c1">#                        badAtmosphere = True</span>
<span class="c1">#                        meanSpectrumMethodMessage = &quot;setting badAtmosphere=True since atmospheric variation %.2f&gt;%.2f or %.3f&gt;%.2fK.&quot; % (b,skyTransmissionThreshold,e,tdmSkyTempThreshold)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">meanSpectrumMethodMessage</span> <span class="o">=</span> <span class="s2">&quot;atmospheric variation is considered too small to set badAtmosphere=True&quot;</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="n">meanSpectrumMethodMessage</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;badAtmosphere is already </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">badAtmosphere</span><span class="p">))</span>
                <span class="c1"># Moment8 image: Set levels and count number of pixels above each level (and outside the joint mask)</span>
                <span class="n">NpixMom8Median</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixMom8MedianBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8levelBadAtm</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMom8MedianBadAtm = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMom8MedianBadAtm</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMom8Median = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMom8Median</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">skipCubeNoise</span><span class="p">:</span>
                    <span class="n">MADCubeOutside</span> <span class="o">=</span> <span class="n">DISABLE_CUBE_NOISE</span>
                    <span class="n">cubeMedian</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running fc.cubeNoiseLevel(&#39;</span><span class="si">%s</span><span class="s2">&#39;, pbcube=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, subimage=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">subimage</span><span class="p">))</span>
                    <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">cubeMedian</span> <span class="o">=</span> <span class="n">cubeNoiseLevel</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="n">pbmom</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="n">imageInfo</span><span class="p">)</span> <span class="c1"># no need for jointMaskTestAnnulus since pbmom is passed already</span>
                <span class="n">mom8fcSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
                <span class="n">TenEventSigma</span> <span class="o">=</span> <span class="n">oneEvent</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> pixels yields 10-event sigma = </span><span class="si">%f</span><span class="s2">,  MAD of cube outside joint mask = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                <span class="n">NpixCubeMedian</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixCubeMedian2</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">cubeLevel2</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>

                <span class="c1"># MomentDiff image: Set levels and count number of pixels above each level (and outside the joint mask)</span>
                <span class="c1"># This is the SNR with peak measured over the whole image.</span>
                <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                              <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiff</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
                <span class="c1"># This is the SNR outside the mask</span>
                <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                    <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                    <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                                       <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">momDiffSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">momDiffPeakOutside</span><span class="o">-</span><span class="n">momDiffMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNRCube: </span><span class="si">%f</span><span class="s1">  peakOutside: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  cubeScaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                <span class="n">momDiffSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">mom8fcSNRMom8</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">momDiffRatio</span> <span class="o">=</span> <span class="n">momDiffSNR</span><span class="o">/</span><span class="n">mom8fcSNRMom8</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Test for reducing momDiffLevel: momDiffSNR/mom8fcSNRMom8 = </span><span class="si">%f</span><span class="s1"> &lt; 0.3?&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffRatio</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">momDiffRatio</span> <span class="o">&lt;</span> <span class="mf">0.3</span><span class="p">:</span>
                        <span class="n">momDiffLevel</span> <span class="o">-=</span> <span class="mf">0.5</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Reducing momDiffLevel by 0.5 to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffLevel</span><span class="p">))</span>

                <span class="n">NpixMomDiff</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixMomDiff2</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixMomDiffBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixMomDiff2BadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="o">+</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMomDiffBadAtm = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMomDiffBadAtm</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMomDiff2BadAtm = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMomDiff2BadAtm</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMomDiff = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMomDiff</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;NpixMomDiff2 = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMomDiff2</span><span class="p">))</span>
                <span class="n">NpixDiffCubeMedian</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span> <span class="c1"># used by amendMaskYesOrNo</span>
                <span class="n">NpixDiffCubeMedian2</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">cubeLevel2</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span> <span class="c1"># used by amendMaskYesOrNo</span>
                <span class="k">if</span> <span class="n">skipAmendMask</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Skipping amendMask due to skipAmendMask request&#39;</span><span class="p">)</span>
                    <span class="n">amendMaskDecision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
                    <span class="n">sigmaUsedToAmendMask</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">npixels</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMaskTest</span><span class="p">,</span><span class="n">mymom8fc</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span><span class="n">mymask</span><span class="p">))</span>
                    <span class="n">mystats</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mymask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystats</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">negativePixels</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">negativePixels</span> <span class="o">=</span> <span class="n">mystats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fractionNegativePixels</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">negativePixels</span><span class="p">)</span><span class="o">/</span><span class="n">npixels</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Fraction of negative pixels: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fractionNegativePixels</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="c1"># MomDiff Decision</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;------------Assessing moment difference image first--------------&#39;</span><span class="p">)</span>
                        <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span> <span class="o">=</span> <span class="n">amendMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffSNRCube</span><span class="p">,</span> 
                                                                                                   <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> <span class="n">NpixDiffCubeMedian</span><span class="p">,</span> 
                                                                                                   <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> 
                                                                                                   <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">NpixDiffCubeMedian2</span><span class="p">,</span>
                                                                                                   <span class="n">fractionNegativePixels</span><span class="p">,</span> <span class="n">NpixMomDiff2</span><span class="p">,</span> <span class="n">NpixMomDiff2BadAtm</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="p">,</span> <span class="n">tooManyPixels</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Moment8 decision</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;----------------Assessing moment8 image first------------------&#39;</span><span class="p">)</span>
                        <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span> <span class="o">=</span> <span class="n">amendMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcSNRMom8</span><span class="p">,</span> <span class="n">mom8fcSNRCube</span><span class="p">,</span> 
                                                                                                   <span class="n">NpixMom8Median</span><span class="p">,</span> <span class="n">NpixMom8MedianBadAtm</span><span class="p">,</span> <span class="n">NpixCubeMedian</span><span class="p">,</span> 
                                                                                                   <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> 
                                                                                                   <span class="n">mom8levelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">NpixCubeMedian2</span><span class="p">,</span>
                                                                                                   <span class="n">fractionNegativePixels</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="o">=</span><span class="n">skipCubeNoise</span><span class="p">,</span> <span class="n">tooManyPixels</span><span class="o">=</span><span class="n">tooManyPixels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">amendMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">amendMask</span><span class="p">:</span> 
                    <span class="c1"># Normally, the decision is all we need, but we also check the directive amendMask, because it </span>
                    <span class="c1"># could be False if the user set the parameter checkIfMaskWouldHaveBeenAmended=True.</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not amending mask&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">amendMask</span> <span class="ow">and</span> <span class="n">enableOnlyExtraMask</span> <span class="ow">and</span> <span class="n">sigmaUsedToAmendMask</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># sigmaUsedToAmendMask=-1 means PixelRatio, -2 means PixelsAboveThreshold are too high, and we want to exit on that</span>
                        <span class="c1"># Assess whether onlyExtraMask should be run</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)</span>
                        <span class="n">cubePeak</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># in whole cube (not merely outside the mask), so we need a fresh call</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;channel selection: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;cube peak anywhere = </span><span class="si">%f</span><span class="s2">, medianOutside = </span><span class="si">%f</span><span class="s2">, scaledMADoutside = </span><span class="si">%f</span><span class="s2">,  (peak-medianOutside)/scaledMADoutside=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cubePeak</span><span class="p">,</span><span class="n">cubeMedian</span><span class="p">,</span><span class="n">MADCubeOutside</span><span class="p">,(</span><span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span><span class="p">))</span>
                        <span class="n">NpixMomDiff</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">NpixMomDiffBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevelBadAtmOnlyExtraMask</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">NpixCubeDiffMedian</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># unused now</span>
                        <span class="c1"># This is the one of the remaining places where the choice of useMomentDiff is assumed to be True.</span>
                        <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">extraMaskSigmaUsed</span> <span class="o">=</span> <span class="n">onlyExtraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                                     <span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span>
                                                                                                     <span class="n">NpixCubeDiffMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                                                                                                     <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">cubePeak</span><span class="p">,</span> <span class="n">cubeMedian</span><span class="p">,</span> 
                                                                                                     <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">momDiffLevelBadAtmOnlyExtraMask</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span>
                                                                                                     <span class="n">cubeSigmaThreshold</span><span class="p">,</span> <span class="n">npixThreshold</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="p">)</span>
                    <span class="n">warning</span> <span class="o">=</span> <span class="n">tooLittleBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Current fractional bandwidth is too small to allow Extra Mask.&#39;</span><span class="p">)</span>
                        <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Current fractional bandwidth is large enough to allow Extra Mask.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">extraMaskDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;No&#39;</span><span class="p">]:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Only Extra Mask will not be tried&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">amendMask</span><span class="p">:</span>
                            <span class="c1">#########################################################</span>
                            <span class="c1"># Result0: No Amend Mask, no Extra Mask ---------------------</span>
                            <span class="c1">#########################################################</span>
                            <span class="c1"># write an &#39;S&#39; after the number of pixels in the legend (remove the zeros since they are not</span>
                            <span class="c1"># yet calculated and will not be used anyway)</span>
                            <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                            <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                                <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> 
                                                              <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                              <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="c1"># there is no difference between mom8fcSum,mom8fcSum0</span>
                                                              <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                              <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                              <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                              <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                              <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                                     <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                        <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                            <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                        <span class="k">break</span> <span class="c1"># do not run a second round</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># The following step is needed, e.g. for Nessie_F1 spw 18 and 24</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Extra Mask will be tried&quot;</span><span class="p">)</span>
                        <span class="c1"># remember the previous values in case the extra mask is indeed used</span>
                        <span class="n">mom8fcPeak0</span> <span class="o">=</span> <span class="n">mom8fcPeak</span>
                        <span class="n">mom8fcPeakOutside0</span> <span class="o">=</span> <span class="n">mom8fcPeakOutside</span>
                        <span class="n">mom8fcMAD0</span> <span class="o">=</span> <span class="n">mom8fcMAD</span>
                        <span class="n">mom8fcSum0</span> <span class="o">=</span> <span class="n">mom8fcSum</span>
                        <span class="n">momDiffPeak0</span> <span class="o">=</span> <span class="n">momDiffPeak</span>
                        <span class="n">momDiffPeakOutside0</span> <span class="o">=</span> <span class="n">momDiffPeakOutside</span>
                        <span class="n">momDiffMAD0</span> <span class="o">=</span> <span class="n">momDiffMAD</span>
                        <span class="n">momDiffSum0</span> <span class="o">=</span> <span class="n">momDiffSum</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extraMaskSigmaUsed = </span><span class="si">%f</span><span class="s2">, ExtraMaskLevel = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extraMaskSigmaUsed</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------------------------------------&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;momDiff = &quot;</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pbmom = &quot;</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------------------------------------------------------&quot;</span><span class="p">)</span>
                        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">),</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
                        <span class="n">lineFullSelection</span> <span class="o">=</span> <span class="n">invertChannelRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>  <span class="c1"># selection = line-free ranges</span>
                        <span class="n">myChannelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="c1"># myChannelList = list of line-free channels</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Continuum channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Line-full channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineFullSelection</span><span class="p">))</span>
                        <span class="n">scaledMADFCSubset</span><span class="p">,</span> <span class="n">medianFCSubset</span> <span class="o">=</span> <span class="n">robustMADofContinuumRanges</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
                        <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromOnlyExtraMask_beforeNoiseReplacement&#39;</span>
                        <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> 
                                          <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                        <span class="n">intensity</span> <span class="o">=</span> <span class="n">replaceLineFullRangesWithNoise</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">lineFullSelection</span><span class="p">,</span> <span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">)</span>
                        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromOnlyExtraMask&#39;</span>
                        <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> 
                                          <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> 
                                          <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                        <span class="c1"># update selection0 to hold the amendMask selection</span>
                        <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> 
                        <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                            <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                        <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.onlyExtraMask&#39;</span>
                        <span class="n">signalRatioTier1</span> <span class="o">=</span> <span class="mf">1.0</span>
                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuumMode=&#39;autolower&#39; with sigmaFindContinuum=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                        <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># do not overwrite the spectrum we just wrote when runFindContinuum runs again!</span>
                        <span class="k">continue</span>  <span class="c1"># from  .original iteration to .onlyExtraMask iteration</span>
                <span class="c1"># endif amendMaskDecision==&#39;No&#39;</span>

                <span class="c1"># Remember the previous values if we are proceeding with amending the mask.</span>
                <span class="c1"># These *0&#39;s will be used to compute the mom8fc 4-letter code generation</span>
                <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> 
                <span class="n">mom8fcPeak0</span> <span class="o">=</span> <span class="n">mom8fcPeak</span>
                <span class="n">mom8fcPeakOutside0</span> <span class="o">=</span> <span class="n">mom8fcPeakOutside</span>
                <span class="n">mom8fcMAD0</span> <span class="o">=</span> <span class="n">mom8fcMAD</span>
                <span class="n">mom8fcSum0</span> <span class="o">=</span> <span class="n">mom8fcSum</span>
                <span class="c1"># These *0&#39;s will be used to compute the MomDiff 4-letter code generation</span>
                <span class="n">momDiffPeak0</span> <span class="o">=</span> <span class="n">momDiffPeak</span>
                <span class="n">momDiffPeakOutside0</span> <span class="o">=</span> <span class="n">momDiffPeakOutside</span>
                <span class="n">momDiffMAD0</span> <span class="o">=</span> <span class="n">momDiffMAD</span>
                <span class="n">momDiffSum0</span> <span class="o">=</span> <span class="n">momDiffSum</span>
                <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">userJointMask</span> <span class="o">=</span>  <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.amendedJointMask&#39;</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>
                    <span class="k">if</span> <span class="n">storeExtraMask</span><span class="p">:</span>
                        <span class="n">addedMask</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.addedMask&#39;</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">userJointMask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.amendedJointMask&#39;</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">storeExtraMask</span><span class="p">:</span>
                        <span class="n">addedMask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.addedMask&#39;</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span><span class="p">)</span>
                <span class="c1"># here is the problem where the jointMask was being removed because it had same name as userJointMask</span>
                <span class="k">if</span> <span class="n">useJointMaskPrior</span><span class="p">:</span>
                    <span class="c1"># need to change the name because jointMask was set equal to userJointMask earlier</span>
                    <span class="n">userJointMask</span> <span class="o">+=</span> <span class="s1">&#39;.prior&#39;</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Amending the mask with new fluxThreshold = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">AmendMaskLevel</span><span class="p">))</span>
                <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;iif((IM0==1)||(IM1&gt;</span><span class="si">%f</span><span class="s1">), 1, 0)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">AmendMaskLevel</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running immath(imagename=[&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mode=&#39;evalexpr&#39;, expr=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">,</span><span class="n">mymom8fc</span><span class="p">,</span><span class="n">userJointMask</span><span class="p">,</span><span class="n">expression</span><span class="p">))</span>
                <span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="n">jointMask</span><span class="p">,</span><span class="n">mymom8fc</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> 
                       <span class="n">expr</span><span class="o">=</span><span class="n">expression</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">storeExtraMask</span><span class="p">:</span>
                    <span class="c1"># Make spectrum of the newly-added portion of the amendedJointMask</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;iif((IM0==0)&amp;&amp;(IM1==1), 1, 0)&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">addedMask</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running immath(imagename=[&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], mode=&#39;evalexpr&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, expr=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">,</span><span class="n">userJointMask</span><span class="p">,</span><span class="n">addedMask</span><span class="p">,</span><span class="n">expression</span><span class="p">))</span>
                    <span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="n">jointMask</span><span class="p">,</span><span class="n">userJointMask</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">addedMask</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="n">expression</span><span class="p">)</span>
                    <span class="n">plotStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">addedMask</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">png</span><span class="o">=</span><span class="n">addedMask</span><span class="o">+</span><span class="s1">&#39;.meanspec.png&#39;</span><span class="p">)</span>
                
                <span class="n">maskedPixelsBefore</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
                <span class="n">maskedPixelsAfter</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span> 
                <span class="n">newPixels</span> <span class="o">=</span> <span class="n">maskedPixelsAfter</span> <span class="o">-</span> <span class="n">maskedPixelsBefore</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------&quot;</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;amending mask </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2">, adding </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">=</span><span class="si">%d</span><span class="s2"> pixels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">,</span><span class="n">userJointMask</span><span class="p">,</span><span class="n">maskedPixelsAfter</span><span class="p">,</span><span class="n">maskedPixelsBefore</span><span class="p">,</span><span class="n">newPixels</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">maskedPixelsBefore</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># protect against divide by zero</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">maskedPixelsAfter</span><span class="p">)</span><span class="o">/</span><span class="n">maskedPixelsBefore</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                        <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuumMode = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuumMode</span><span class="p">))</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuum = finalSigmaFindContinuum = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">finalSigmaFindContinuum</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not changing sigmaFindContinuumMode for the next run.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                <span class="c1"># Set the name/heuristic of the next iteration</span>
                <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.amendedMask&#39;</span>
                <span class="k">continue</span>  <span class="c1"># from  .original iteration to .amendedMask iteration</span>
            <span class="c1"># endif amendMaskIterationName == &#39;.original&#39; </span>
            <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.amendedMask&#39;</span><span class="p">:</span>  
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------------------------------------------------------&quot;</span><span class="p">)</span>
                <span class="c1"># mom8fcSNRMom8 (outside) is already calculated fresh (above) on the latest .mom8fc on every iteration</span>
                <span class="n">mom8fcSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                <span class="n">NpixMom8Median</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">]),</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="n">NpixMom8MedianBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="c1"># use mom8fc image</span>
                <span class="n">NpixCubeMedian</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">]),</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mymom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span> <span class="c1"># unused now</span>
                <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                    <span class="c1"># These values are no longer used in extraMaskYesOrNo, so could probably not bother calculating them now.</span>
                    <span class="n">NpixMomDiff</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">NpixMomDiffBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">NpixCubeDiffMedian</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># unused now</span>
                    <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">extraMaskSigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                             <span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> 
                                                                                             <span class="n">NpixCubeDiffMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                                                                                             <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span>
                                                                                             <span class="n">cubeLevel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">extraMaskSigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcSNRMom8</span><span class="p">,</span> 
                                                                                             <span class="n">mom8fcSNRCube</span><span class="p">,</span> <span class="n">NpixMom8Median</span><span class="p">,</span> <span class="n">NpixMom8MedianBadAtm</span><span class="p">,</span> 
                                                                                             <span class="n">NpixCubeMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> 
                                                                                             <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> <span class="n">mom8levelBadAtm</span><span class="p">,</span>
                                                                                             <span class="n">cubeLevel</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymomDiff</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNRCube: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                <span class="n">warning</span> <span class="o">=</span> <span class="n">tooLittleBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Current fractional bandwidth is too small to allow Extra Mask.&#39;</span><span class="p">)</span>
                    <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Current fractional bandwidth is enough to allow Extra Mask.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">extraMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span> <span class="c1"># crystal relies on this when using returnBluePoints # or returnBluePoints: # latter will prevent ADIX  </span>
                    <span class="c1"># If No, we are done</span>
                    <span class="c1">########################################</span>
                    <span class="c1"># Result1: Amended Mask but no Extra Mask</span>
                    <span class="c1">########################################</span>
                    <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Extra Mask not deemed necessary, so we are done.&quot;</span><span class="p">)</span>
                    <span class="c1"># derive 4-letter codes and update the final line of plot legend</span>
                    <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                    <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                      <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                                                             <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                             <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Needs momDiff 4-letter code</span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                                                                <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Extra Mask is needed&quot;</span><span class="p">)</span>
                <span class="c1">#################################################################</span>
                <span class="c1"># There is still excess emission.</span>
                <span class="c1"># Can intersect help?  build mom8fc.amendedMask - mom8fc.original</span>
                <span class="c1">#################################################################</span>
                <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                    <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.amendedMask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.diff&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">])</span>
                    <span class="n">immath</span><span class="p">([</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.original&#39;</span><span class="p">],</span> <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.amendedMask&#39;</span><span class="p">]],</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM1-IM0&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running fc.imageSNRAnnulus(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, applyMaskToAll=False)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">))</span>
<span class="c1">#                        diffStats = imageSNRAnnulus(momDiff[&#39;.diff&#39;], jointMaskTest, jointMaskTestAnnulus) # this is what we used on July 30</span>
                        <span class="n">diffStats</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">diffStats</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.amendedMask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.diff&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">])</span>
                    <span class="n">immath</span><span class="p">([</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.original&#39;</span><span class="p">],</span> <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.amendedMask&#39;</span><span class="p">]],</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM1-IM0&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running fc.imageSNRAnnulus(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;, applyMaskToAll=False)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">))</span>
                        <span class="n">diffStats</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">diffStats</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.diff&#39;</span><span class="p">],</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
                    <span class="n">testDiffLev</span> <span class="o">=</span> <span class="n">mom8levelBadAtm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">testDiffLev</span> <span class="o">=</span> <span class="n">mom8level</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">diffStats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">testDiffLev</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;**************************************************************&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;There is significant emission in difference image (</span><span class="si">%f</span><span class="s1"> &gt; </span><span class="si">%f</span><span class="s1">):  Needs intersection of ranges.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diffStats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">testDiffLev</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;**************************************************************&#39;</span><span class="p">)</span>
                    <span class="n">channelList0</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection0</span><span class="p">)</span>
                    <span class="n">channelList1</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="n">channelList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">channelList0</span><span class="p">,</span><span class="n">channelList1</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Taking intersection of </span><span class="si">%d</span><span class="s2"> channels with </span><span class="si">%d</span><span class="s2"> channels, to get </span><span class="si">%d</span><span class="s2"> channels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channelList0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">)))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;first channel list = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection0</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;second channel list = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No intersecting ranges found: Reverting to first channel selection and stopping. (Result2)&quot;</span><span class="p">)</span>
                        <span class="n">channelList</span> <span class="o">=</span> <span class="n">channelList0</span>  <span class="c1"># reverting</span>
                        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
                        <span class="c1">##########################################################################################</span>
                        <span class="c1"># Result2: Amended Mask and Extra Mask was tried but reverted due to no remaining channels</span>
                        <span class="c1">##########################################################################################</span>
                        <span class="c1"># derive 4-letter codes and update the final line of the plot legend</span>
                        <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                        <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                 <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Needs momDiff 4-letter code</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                    <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">intersectionOfSelections</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1">###############################################################</span>
                    <span class="c1"># create mom8fcIntersect from original and amendedMask regions</span>
                    <span class="c1">###############################################################</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Building new mom8fc with chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                        <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.intersectChannelRanges&#39;</span>
                        <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span>
                        <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.intersectChannelRanges&#39;</span>
                        <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.intersectChannelRanges&#39;</span>
                    <span class="n">mom8fcIntersect</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span>  <span class="c1"># just a shorthand</span>
                    <span class="n">mom0fcIntersect</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">)</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcIntersect</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8fcIntersect</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">mom0fcIntersect</span><span class="p">))</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcIntersect</span><span class="p">)</span>
                    <span class="n">finalMom8fc</span> <span class="o">=</span> <span class="n">mom8fcIntersect</span>
                    <span class="n">finalMom0fc</span> <span class="o">=</span> <span class="n">mom0fcIntersect</span>

                    <span class="c1"># Compute statistics of mom8fcIntersect image</span>
                    <span class="c1"># Assess mom8fc.intersect using original mask</span>
                    <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span>
                                                                              <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="c1"># This function uses 2 calls of imageSNR in order to get peak anywhere outside the joint mask, but median and MAD from the annulus (in order to calculate SNR).</span>
                        <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                                                                     <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">mom8fcSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                    <span class="n">mom8fcSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;new  mom8fcMedian = </span><span class="si">%f</span><span class="s2">, mom8fcScaledMAD = </span><span class="si">%f</span><span class="s2">,  mom8fcSNR = </span><span class="si">%f</span><span class="s2">, mom8fcSNROutside = </span><span class="si">%f</span><span class="s2">, mom8fcSum = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">))</span>
                    <span class="n">NpixMom8Median</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">]),</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                    <span class="n">NpixMom8MedianBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
                    <span class="n">NpixCubeMedian</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">]),</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>

                    <span class="c1"># create scaled version of mom0fcIntersect</span>
                    <span class="n">mom0fcIntersectScaled</span> <span class="o">=</span> <span class="n">mom0fcIntersect</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                    <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
                    <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
                    <span class="n">immath</span><span class="p">([</span><span class="n">mom0fcIntersect</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>

                    <span class="c1"># Need to build a new momDiff image</span>
                    <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fcIntersect</span> <span class="o">+</span> <span class="s1">&#39;.minus.mom0fcScaled&#39;</span>
                    <span class="n">momDiffIntersect</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.intersect&#39;</span><span class="p">]</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiffIntersect</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.3&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;immath([&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], mode=&#39;evalexpr&#39;, expr=&#39;IM0-IM1&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span><span class="n">mom0fcIntersectScaled</span><span class="p">,</span><span class="n">mymask</span><span class="p">,</span><span class="n">momDiffIntersect</span><span class="p">))</span>
                    <span class="n">immath</span><span class="p">([</span><span class="n">mom8fcIntersect</span><span class="p">,</span> <span class="n">mom0fcIntersectScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiffIntersect</span><span class="p">)</span>
                    <span class="n">mymomDiff</span> <span class="o">=</span> <span class="n">momDiffIntersect</span>
                    <span class="n">finalMomDiff</span> <span class="o">=</span> <span class="n">momDiffIntersect</span>

                    <span class="c1">###########################################################################################</span>
                    <span class="c1"># Recalculate momDiff stats for purposes of extraMaskYesOrNo, and the second 4-letter code</span>
                    <span class="c1">###########################################################################################</span>
                    <span class="c1">#  momDiffSNR, momDiffPeak = peak anywhere in image</span>
                    <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                                  <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymomDiff</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
                    <span class="c1"># This is the SNR outside the mask</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                        <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                                                           <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">momDiffSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">momDiffPeakOutside</span><span class="o">-</span><span class="n">momDiffMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNRCube: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                    <span class="n">momDiffSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="c1"># These values are no longer used in extraMaskYesOrNo, so could probably not bother calculating them now.</span>
                        <span class="n">NpixMomDiff</span> <span class="o">=</span> <span class="n">computeNpixMom8Median</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">NpixMomDiffBadAtm</span> <span class="o">=</span> <span class="n">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">NpixCubeDiffMedian</span> <span class="o">=</span> <span class="n">computeNpixCubeMedian</span><span class="p">(</span><span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mymomDiff</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># unused now</span>
                        <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">extraMaskSigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                                  <span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> 
                                                                                                  <span class="n">NpixCubeDiffMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                                                                                                  <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span>
                                                                                                  <span class="n">cubeLevel</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># NpixMom8Median used here was defined above as max([5.5,TenEventSigma])</span>
                        <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">extraMaskSigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcSNRMom8</span><span class="p">,</span> 
                                                                                                  <span class="n">mom8fcSNRCube</span><span class="p">,</span> <span class="n">NpixMom8Median</span><span class="p">,</span> <span class="n">NpixMom8MedianBadAtm</span><span class="p">,</span> 
                                                                                                  <span class="n">NpixCubeMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> 
                                                                                                  <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> <span class="n">mom8levelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">extraMaskDecision2</span> <span class="o">==</span> <span class="s1">&#39;No&#39;</span><span class="p">:</span> 
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Extra Mask is no longer deemed necessary. Stopping (Result3).&#39;</span><span class="p">)</span>
                        <span class="c1"># If No, stop: because Taking intersection was enough, so do not proceed with extraMask.</span>
                        <span class="c1">###################################################</span>
                        <span class="c1"># Result3: Amended Mask and Intersection was enough</span>
                        <span class="c1">###################################################</span>
                        <span class="c1"># Derive 4-letter codes and update the plot (channel ranges and legend)</span>
                        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                                                                       <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> 
                                                                       <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> 
                                                                       <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=</span><span class="n">initialPeakOverMad</span><span class="p">)</span>
                        <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                        <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                          <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                 <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Needs momDiff 4-letter code</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                    <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="c1"># give the modified figure a new name so that it does not overwrite the pre-extraMask png</span>
                        <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.amendedMask.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.amendedMaskIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">amendMaskIterationNames</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># len will be 2 if amendMaskIterations was 1</span>
                        <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
                        <span class="c1">#############################################################</span>
                        <span class="c1"># Result4: amendMaskIterations was set to only 1 (not 2 or 3)</span>
                        <span class="c1">#############################################################</span>
                        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                                                                       <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> 
                                                                       <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> 
                                                                       <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=</span><span class="n">initialPeakOverMad</span><span class="p">)</span>
                        <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                        <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                 <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                    <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Stopping because amendMaskIterations was set less than 2 (Result4)&#39;</span><span class="p">)</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="c1"># If Yes, do the extraMask procedure:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extraMaskSigmaUsed = </span><span class="si">%f</span><span class="s2">, ExtraMaskLevel = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extraMaskSigmaUsed</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffIntersect</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">),</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># use mom8fc.intersect to set the mask level from fc.imageSNR calcs  (using original mask)</span>
                        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcIntersect</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">),</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
                    <span class="n">lineFullSelection</span> <span class="o">=</span> <span class="n">invertChannelRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>  <span class="c1"># converts a string to a string</span>
                    <span class="n">myChannelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Continuum channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Line-full channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineFullSelection</span><span class="p">))</span>
                    <span class="n">scaledMADFCSubset</span><span class="p">,</span> <span class="n">medianFCSubset</span> <span class="o">=</span> <span class="n">robustMADofContinuumRanges</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Intersect was done: Median and scaledMAD of </span><span class="si">%d</span><span class="s1"> continuum channels: </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">),</span><span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">))</span>
                    <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromExtraMask_beforeNoiseReplacement&#39;</span>
                    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> 
                                      <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">replaceLineFullRangesWithNoise</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">lineFullSelection</span><span class="p">,</span> <span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">)</span>
                    <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromExtraMask&#39;</span>
                    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> 
                                      <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                    <span class="c1"># update selection0 to hold the amendMask/intersect selection</span>
                    <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> 
                    <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                        <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                        <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuumMode=&#39;autolower&#39; with sigmaFindContinuum=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                    <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.extraMask&#39;</span>
                    <span class="n">signalRatioTier1</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># do not overwrite the spectrum we just wrote when runFindContinuum runs again!</span>
                    <span class="k">continue</span>  <span class="c1"># from  .amendedMask iteration to .extraMask iteration</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;**************************************************************&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;There is no significant emission in difference image (</span><span class="si">%f</span><span class="s1"> &lt; </span><span class="si">%f</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">diffStats</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">testDiffLev</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;**************************************************************&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">amendMaskIterationNames</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="c1">########################################################</span>
                        <span class="c1"># Result5: amendMaskIterations was set to only 1 (not 2)</span>
                        <span class="c1">########################################################</span>
                        <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
                        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                                                                       <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> 
                                                                       <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> 
                                                                       <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=</span><span class="n">initialPeakOverMad</span><span class="p">)</span>
                        <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                        <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                 <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                    <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Stopping because amendMaskIterations was set less than 2 (Result5)&#39;</span><span class="p">)</span>
                        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="c1"># do the extraMaskProcedure:</span>
                    <span class="c1"># jointMaskTest will be the original mask, unless I take action here</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;sigmaUsed to set level = </span><span class="si">%f</span><span class="s2">, computing spectrum from pixels &gt; </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">extraMaskSigmaUsed</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">),</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mymom8fc</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">),</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
                    <span class="n">lineFullSelection</span> <span class="o">=</span> <span class="n">invertChannelRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span> <span class="c1"># converts a string to a string</span>
                    <span class="n">myChannelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Continuum channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Line-full channels so far: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineFullSelection</span><span class="p">))</span>
                    <span class="n">scaledMADFCSubset</span><span class="p">,</span> <span class="n">medianFCSubset</span> <span class="o">=</span> <span class="n">robustMADofContinuumRanges</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,</span> <span class="n">intensity</span><span class="p">)</span>
                    <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Intersect was not done: Median and scaledMAD of </span><span class="si">%d</span><span class="s1"> continuum channels: </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">),</span><span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">))</span>
                    <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromExtraMask_beforeNoiseReplacement&#39;</span>
                    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> 
                                      <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                    <span class="n">intensity</span> <span class="o">=</span> <span class="n">replaceLineFullRangesWithNoise</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">lineFullSelection</span><span class="p">,</span> <span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">)</span>
                    <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">mymom8fc</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrumFile_fromExtraMask&#39;</span>
                    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> 
                                      <span class="n">intensity</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> 
                                      <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span>
                    <span class="c1"># update selection0 to hold the amendMask/intersect selection</span>
                    <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> 
                    <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                        <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                    <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.extraMask&#39;</span>
                    <span class="n">signalRatioTier1</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                        <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuumMode=&#39;autolower&#39; with sigmaFindContinuum=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># do not overwrite the spectrum we just wrote when runFindContinuum runs again!</span>
                    <span class="k">continue</span>  <span class="c1"># from .amendedMask iteration to .extraMask iteration</span>
                <span class="c1"># end if diffStats[0] &gt; testDiffLev  else:</span>
            <span class="c1"># end if amendMaskIterationName == &#39;.amendedMask&#39;</span>
            <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span> <span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
                <span class="c1"># Intersect extraMask spectral (cyan) ranges with amendMask spectral (cyan) ranges</span>
                <span class="c1"># selection0 will hold the amendMask selection if .extraMask was run</span>
                <span class="n">channelList0</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection0</span><span class="p">)</span>
                <span class="n">channelList1</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                <span class="n">channelList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">channelList0</span><span class="p">,</span><span class="n">channelList1</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Taking intersection of </span><span class="si">%d</span><span class="s2"> channels with </span><span class="si">%d</span><span class="s2"> channels, to get </span><span class="si">%d</span><span class="s2"> channels (aggregateBW=</span><span class="si">%.4f</span><span class="s2"> GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channelList0</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;first channel list = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection0</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;second channel list = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1">###########################################################################################</span>
                    <span class="c1"># Result6: ExtraMask or onlyExtraMask was used but no channels were left after intersection</span>
                    <span class="c1">###########################################################################################</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No intersection: Reverting to first channel selection (Result6)&quot;</span><span class="p">)</span>
                    <span class="n">channelList</span> <span class="o">=</span> <span class="n">channelList0</span>  <span class="c1"># reverting</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span> <span class="c1"># this line was added to fix PIPE-1211</span>
                    <span class="c1"># derive 4-letter codes and update the final line of the plot legend</span>
                    <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                    <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                          <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                          <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Needs momDiff 4-letter code, but only if it was .extraMask </span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span>
                                                                                                <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">]:</span>
                    <span class="c1"># save the .original.meanSpectrum.*.png before modifying the channel ranges and legend below</span>
                    <span class="c1"># save the .amendedMask.meanSpectrum.*.png before modifying the channel ranges and legend below</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Saving </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">png</span><span class="p">))</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">channelList0</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.extraMask&#39;</span><span class="p">:</span>
                        <span class="n">extraMaskDecision</span> <span class="o">=</span> <span class="s1">&#39;NoImprovement&#39;</span>
                    <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.autoLower&#39;</span><span class="p">:</span>
                        <span class="n">autoLowerDecision</span> <span class="o">=</span> <span class="s1">&#39;NoImprovement&#39;</span>
                    <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.autoLower2&#39;</span><span class="p">:</span>
                        <span class="n">autoLower2Decision</span> <span class="o">=</span> <span class="s1">&#39;NoImprovement&#39;</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No change in channel list&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">nchan</span> <span class="o">&gt;</span> <span class="mi">500</span><span class="p">:</span>
                    <span class="c1"># disallow first and final channel if either is the adjacent channel</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;intersected channel list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="n">onlyChannel</span> <span class="o">=</span> <span class="n">channelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">channelList</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="n">onlyChannel</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">onlyChannel</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Forcing single channel to include the adjacent channels because nchan&gt;500&#39;</span><span class="p">)</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
                                   
<span class="c1">#                else:  # process new channel selection (even if it is the same, because we want to produce the autoLowerIntersect momDiff)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;intersected channel list: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                <span class="c1">##########################################</span>
                <span class="c1"># Build a (potentially) final mom8fc image</span>
                <span class="c1">##########################################</span>
                <span class="n">myIntersectName</span> <span class="o">=</span> <span class="n">amendMaskIterationName</span><span class="o">+</span><span class="s1">&#39;Intersect&#39;</span>
                <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                    <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                    <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span>
                    <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                    <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                    <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[8], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                    <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                    <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                <span class="n">finalMom0fc</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>
                <span class="n">finalMom8fc</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>

                <span class="c1"># compute final 4-letter code and update the final line of the plot legend</span>
                <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                          <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                    <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                    <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                                     <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># need to recalculate mom8fcSNRCube because the numerator has changed</span>
                <span class="n">mom8fcSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                <span class="n">mom8fcSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># create scaled version of mom0fcIntersect</span>
                <span class="n">mom0fcIntersectScaled</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
                <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
                <span class="n">immath</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>

                <span class="c1"># Need to build a new momDiff image since we have a new mom8fc[myIntersectName]</span>
                <span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.minus.mom0fcScaled&#39;</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.3&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;immath([&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], mode=&#39;evalexpr&#39;, expr=&#39;IM0-IM1&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span><span class="n">mom0fcIntersectScaled</span><span class="p">,</span><span class="n">mymask</span><span class="p">,</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                <span class="n">immath</span><span class="p">([</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mom0fcIntersectScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                <span class="n">finalMomDiff</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>

                <span class="c1"># Recalculate for purposes of second 4-letter code</span>
                <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                              <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span>
                                                                              <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
                <span class="c1"># This is the SNR outside the mask</span>
                <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                    <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                    <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                                       <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">momDiffSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">momDiffSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">momDiffPeakOutside</span><span class="o">-</span><span class="n">momDiffMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNRCube: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.extraMask&#39;</span> <span class="ow">and</span> <span class="n">amendMaskIterations</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.onlyExtraMask&#39;</span> <span class="ow">and</span> <span class="n">amendMaskIterations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>   <span class="c1"># PL2022</span>
<span class="c1">#                if not returnBluePoints and ((amendMaskIterationName == &#39;.extraMask&#39; and amendMaskIterations &gt; 2) or (amendMaskIterationName == &#39;.onlyExtraMask&#39; and amendMaskIterations &gt; 1)):  # PL2023 (only needed if amendMaskIterations != &#39;auto&#39;)</span>
                    <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<span class="c1">#                        These values are no longer used in extraMaskYesOrNo(), so no need to compute them</span>
<span class="c1">#                        NpixMomDiff = computeNpixMom8Median(momDiffMedian, momDiffLevel, momDiffMAD, momDiff[myIntersectName], &#39;&#39;)</span>
<span class="c1">#                        NpixMomDiffBadAtm = computeNpixMom8MedianBadAtm(momDiffMedian, momDiffLevelBadAtm, momDiffMAD, momDiff[myIntersectName], &#39;&#39;)</span>
                        <span class="c1"># NpixCubeDiffMedian is unused now</span>
                        <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">autoLowerLevel</span><span class="p">,</span> <span class="n">autoLowerSigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> 
                                                                                                 <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                                 <span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> 
                                                                                                 <span class="n">NpixCubeDiffMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                                                                                                 <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;autoLowerDecision = </span><span class="si">%s</span><span class="s1">, autoLowerLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">autoLowerLevel</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">autoLowerDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                                <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                            <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.autoLower&#39;</span>
                            <span class="n">signalRatioTier1</span> <span class="o">=</span> <span class="mf">1.0</span>
                            <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                            <span class="k">if</span> <span class="n">momDiffSNR</span> <span class="o">&lt;</span> <span class="n">momDiffApproachLevel</span><span class="p">:</span>
                                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Scaling sigmaFindContinuum by 6/7 because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &lt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffApproachLevel</span><span class="p">))</span>
                                <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span><span class="o">*</span><span class="mi">6</span><span class="o">/</span><span class="mf">7.</span>  <span class="c1"># added *6/7 in PL2023</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Scaling sigmaFindContinuum by 5/7 because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &gt;= </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffApproachLevel</span><span class="p">))</span>
                                <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span><span class="o">*</span><span class="mi">5</span><span class="o">/</span><span class="mf">7.</span>  <span class="c1"># added *5/7 in PL2022</span>
                            <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> <span class="c1"># be sure we intersect against this latest channel selection</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuumMode=&#39;autolower&#39; with sigmaFindContinuum=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                            <span class="k">continue</span> <span class="c1"># from .extraMask/.onlyExtraMask to .autoLower</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nWarnings</span> <span class="o">=</span>  <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not trying .autoLower because we have </span><span class="si">%d</span><span class="s2"> bandwidth warning(s)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nWarnings</span><span class="p">))</span>             

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">!=</span> <span class="s1">&#39;.autoLower&#39;</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not trying .autoLower2 because amendMaskIteration=</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> (amendMaskIterationName=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">amendMaskIterations</span><span class="p">,</span><span class="n">amendMaskIterationName</span><span class="p">))</span>
                        <span class="n">autoLower2Decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span> <span class="c1"># need to keep this setting so &#39;Y&#39; is displayed on the png</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># .autoLower2</span>
                        <span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">autoLower2Level</span><span class="p">,</span> <span class="n">autoLower2SigmaUsed</span> <span class="o">=</span> <span class="n">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> 
                                                                                                    <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                                                                    <span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> 
                                                                                                    <span class="n">NpixCubeDiffMedian</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                                                                                                    <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevelForProceeding</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;autoLower2Decision = </span><span class="si">%s</span><span class="s1">, autoLower2Level = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">autoLower2Level</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">autoLower2Decision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">amendMaskIterations</span><span class="o">&gt;</span><span class="mi">3</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">keepIntermediatePngs</span><span class="p">:</span>
                                <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># reset name so that new name will be chosen and prior plot not overwritten</span>
                            <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.autoLower2&#39;</span>
                            <span class="n">signalRatioTier1</span> <span class="o">=</span> <span class="mf">1.0</span>
                            <span class="n">sigmaFindContinuumMode</span> <span class="o">=</span> <span class="s1">&#39;autolower&#39;</span>
                            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span><span class="o">*</span><span class="mi">6</span><span class="o">/</span><span class="mf">7.</span> 
                            <span class="n">selection0</span> <span class="o">=</span> <span class="n">selection</span> <span class="c1"># be sure we intersect against this latest channel selection</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuumMode=&#39;autolower&#39; with sigmaFindContinuum=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                            <span class="k">continue</span> <span class="c1"># from .autoLower to .autoLower2</span>
                <span class="c1"># was: endif list(channelList) == list(channelList0)  else:</span>
                <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                <span class="n">channelRanges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                <span class="c1"># update the plot channel ranges </span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;A) calling updateChannelRangesOnPlot prior to Result7, autoLower2Decision=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">autoLower2Decision</span><span class="p">))</span>
                <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                                                               <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> 
                                                               <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> 
                                                               <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> 
                                                               <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=</span><span class="n">initialPeakOverMad</span><span class="p">)</span>
                <span class="c1">########################################################################</span>
                <span class="c1"># Result7: ExtraMask or onlyExtraMask, and possibly autoLower were used </span>
                <span class="c1">########################################################################</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                    <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> 
                                                      <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                      <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> 
                                                      <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                      <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Needs momDiff 4-letter code</span>
                    <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                  <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                  <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                  <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> 
                                                  <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                  <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                  <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                  <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span>
                                                  <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> 
                                                  <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                  <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                <span class="c1"># give the modified figure a new name so that it does not overwrite the pre-extraMask png</span>
                <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">:</span> 
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onlyExtraMask) Changing name of png: &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.original.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMaskIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="c1"># do not allow it to try a 3rd iteration, since we are done</span>
                    <span class="k">break</span> 
                <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.extraMask&#39;</span><span class="p">:</span>  
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extraMask) Changing name of png: &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.extraMask.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.extraMaskIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.amendedMask.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.extraMaskIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Saving </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="k">break</span> <span class="c1"># not needed if amendMaskIterations=2, but needed if it is 3</span>
                <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.autoLower&#39;</span><span class="p">:</span>  
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;autoLower) Changing name of png: &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.amendedMask.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLowerIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.original.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLowerIntersect.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">) Saving </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterationName</span><span class="p">,</span><span class="n">png</span><span class="p">))</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">break</span> <span class="c1"># needed if amendMaskIterations == 3 and we did not amendMask (because autoLower would be 2nd iteration)</span>
                    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">break</span> <span class="c1"># also needed if amendMaskIterations == 4 and autoLower2Decision is No (which is how we can get here)</span>
                    <span class="n">haveLowBW</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not allowing .autoLower2 because we are in the LowBW state already&quot;</span><span class="p">)</span>
                            <span class="n">haveLowBW</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">haveLowBW</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="n">amendMaskIterationNames</span><span class="p">[</span><span class="n">amendMaskIteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.autoLower2&#39;</span>
                <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.autoLower2&#39;</span><span class="p">:</span>  <span class="c1"># new</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;autoLower2) Changing name of png: &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.amendedMask.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLowerIntersect2.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">png</span> <span class="o">=</span> <span class="n">png</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.original.meanSpectrum&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLowerIntersect2.meanSpectrum&#39;</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">) Saving </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterationName</span><span class="p">,</span><span class="n">png</span><span class="p">))</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="k">break</span> <span class="c1"># needed if amendMaskIterations == 4 and we did not amendMask (because autoLower2 would be 3rd iteration)</span>
            <span class="c1"># endif amendMaskIterationName in [&#39;.extraMask&#39;,&#39;.onlyExtraMask&#39;,&#39;.autoLower&#39;]</span>
        <span class="c1"># endif meanSpectrumMethod==&#39;mom0mom8jointMask&#39; and (amendMask or checkIfMaskWouldHaveBeenAmended):</span>
    <span class="c1"># end &#39;for&#39; loop over amendMaskIterations</span>
    <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span> <span class="o">=</span> <span class="n">finalSigmaFindContinuum</span>

    <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">amendMask</span><span class="p">:</span>
        <span class="c1"># I think this should never happen due to protection above, but I leave this code here, just in case.</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Blank selection found: Reverting to prior iteration with selection: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">previousSelection</span>
        <span class="n">png</span> <span class="o">=</span> <span class="n">previousPng</span>
        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">previousAggregateBandwidth</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># At this point, all of the images and pngs have been saved with the correct names.</span>
    <span class="c1"># Now compare the 4-letter &#39;code&#39; to see if we need to revert the channel range results,</span>
    <span class="c1"># the png returned, and the final image returned to the .original versions of these files.</span>
    <span class="c1">##########################################################################################</span>
    <span class="k">if</span> <span class="n">amendMask</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Check for need to revert.&quot;</span><span class="p">)</span>
        <span class="n">reversionCodes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HHHH&#39;</span><span class="p">,</span><span class="s1">&#39;HHHS&#39;</span><span class="p">]</span>
        <span class="n">revert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">momDiffCode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">mom8code</span>
            <span class="k">if</span> <span class="n">mom8code</span> <span class="ow">in</span> <span class="n">reversionCodes</span><span class="p">:</span>
                <span class="n">revert</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;This mom8fc code triggers reversion to original result.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">code</span> <span class="o">=</span> <span class="n">momDiffCode</span>
            <span class="k">if</span> <span class="n">momDiffCode</span> <span class="ow">in</span> <span class="n">reversionCodes</span> <span class="ow">and</span> <span class="n">momDiffSNR</span> <span class="o">&gt;</span> <span class="n">momDiffLevel</span><span class="p">:</span> <span class="c1"># and False: # temporary test for PIPE-2188</span>
                <span class="n">revert</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;This momDiff code with momDiffSNR&gt;</span><span class="si">%.1f</span><span class="s1"> triggers reversion to original result.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">momDiffLevel</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">revert</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No need for reversion.&quot;</span><span class="p">)</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
<span class="c1">#            if len(warnings[0]) &gt; 0 and len(warnings[1]) &gt; 0: # PL2023</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># LowSpread    # PL2024</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Will try to fix the LowSpread condition&quot;</span><span class="p">)</span>    <span class="c1"># PL2024</span>
                <span class="c1"># do our addition of new channel range(s)</span>
                <span class="n">continuumChannels</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">continuumChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="n">continuumChannels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="c1"># channels are in increasing order;  don&#39;t look beyond the half-way point of the spectrum</span>
                    <span class="n">endchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">continuumChannels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nchan</span><span class="o">*</span><span class="n">smallSpreadFraction</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="o">//</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="n">channelRange</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">endchan</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">startchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">nchan</span><span class="o">*</span><span class="n">smallSpreadFraction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">channelRange</span> <span class="o">=</span> <span class="p">[</span><span class="n">startchan</span><span class="p">,</span><span class="n">nchan</span><span class="p">]</span>
                <span class="n">mylist</span> <span class="o">=</span> <span class="n">findWidestContiguousListInChannelRange</span><span class="p">(</span><span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channelRange</span><span class="p">,</span> <span class="n">continuumChannels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mylist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** No blue points found in the wider side of the spectrum: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">channelRange</span><span class="p">)))</span>
                    <span class="c1"># now need to look for non-blue points within the min/max range of blue points</span>
                    <span class="n">mylist</span> <span class="o">=</span> <span class="n">findChannelsInChannelRangeWithComparableIntensity</span><span class="p">(</span><span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channelRange</span><span class="p">,</span> <span class="n">continuumChannels</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">)</span>  <span class="c1"># PL2024</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mylist</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#                else:</span>
<span class="c1">#                    mylist = [mylist] # convert single range to list of 1 range</span>

                <span class="c1"># Need to check if most of the points are beyond 1 sigma MAD of all points (for PIPE-2188)</span>
                <span class="c1"># and if so, then reject it since it might be the shoulders of a real line.</span>
                <span class="k">if</span> <span class="n">mylist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">MADofBaselineChannels</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">medianNegativeSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">negativeThreshold</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]))</span> <span class="o">/</span> <span class="n">MADofBaselineChannels</span>
                    <span class="n">medianPositiveSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">mylist</span><span class="p">])</span> <span class="o">-</span> <span class="n">positiveThreshold</span><span class="p">)</span> <span class="o">/</span> <span class="n">MADofBaselineChannels</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;medianNegativeSigma = </span><span class="si">%f</span><span class="s1">, medianPositiveSigma = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianNegativeSigma</span><span class="p">,</span> <span class="n">medianPositiveSigma</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">medianNegativeSigma</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Rejecting new range because the median value is </span><span class="si">%.1f</span><span class="s1"> (&gt; 1) scaled MAD beyond one of the dotted lines (negativeThreshold).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianNegativeSigma</span><span class="p">))</span>
                        <span class="n">mylist</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">medianPositiveSigma</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Rejecting new range because the median value is </span><span class="si">%.1f</span><span class="s1"> (&gt; 1) scaled MAD beyond one of the dotted lines (positiveThreshold).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianPositiveSigma</span><span class="p">))</span>
                        <span class="n">mylist</span> <span class="o">=</span> <span class="kc">None</span>
                        
                <span class="k">if</span> <span class="n">mylist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** No points with intensity in the range of the blue points were found in the wider side of the spectrum&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we added 1 (or more) new selections, so need to update everything</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mylist before split: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mylist</span><span class="p">))</span>
                    <span class="n">mylist</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mylist after split: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">mylist</span><span class="p">))</span>
                    <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;group </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span><span class="n">mylist</span><span class="p">[</span><span class="n">group</span><span class="p">]))</span>
                        <span class="n">secondSelectionAdded</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">mylist</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="n">selection</span> <span class="o">=</span> <span class="n">secondSelectionAdded</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">mylist</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">continuumChannels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="c1"># add to end of string (to maintain increasing order)</span>
                                <span class="n">selection</span> <span class="o">+=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">secondSelectionAdded</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># add to beginning of string (to maintain increasing order)</span>
                                <span class="n">selection</span> <span class="o">=</span> <span class="n">secondSelectionAdded</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">selection</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** Added another selection in wider side of the spectrum: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">secondSelectionAdded</span><span class="p">))</span>
                    <span class="c1"># end &#39;for&#39; loop over groups</span>
                    <span class="k">if</span> <span class="n">momDiffPeak0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># No AmendMask nor ExtraMask was done, so we need to store the original values.</span>
                        <span class="c1"># These *0&#39;s will be used to compute the MomDiff 4-letter code generation</span>
                        <span class="n">momDiffPeak0</span> <span class="o">=</span> <span class="n">momDiffPeak</span>
                        <span class="n">momDiffPeakOutside0</span> <span class="o">=</span> <span class="n">momDiffPeakOutside</span>
                        <span class="n">momDiffMAD0</span> <span class="o">=</span> <span class="n">momDiffMAD</span>
                        <span class="n">momDiffSum0</span> <span class="o">=</span> <span class="n">momDiffSum</span>
                        <span class="n">mom8fcPeak0</span> <span class="o">=</span> <span class="n">mom8fcPeak</span>
                        <span class="n">mom8fcPeakOutside0</span> <span class="o">=</span> <span class="n">mom8fcPeakOutside</span>
                        <span class="n">mom8fcMAD0</span> <span class="o">=</span> <span class="n">mom8fcMAD</span>
                        <span class="n">mom8fcSum0</span> <span class="o">=</span> <span class="n">mom8fcSum</span>
                        <span class="n">removeRanges</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">removeRanges</span> <span class="o">=</span> <span class="kc">False</span>
                    
                    <span class="c1"># update the plot again</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;B) calling updateChannelRangesOnPlot&#39;</span><span class="p">)</span>
                    <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                                                                   <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> 
                                                                   <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> 
                                                                   <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span>
                                                                   <span class="n">remove</span><span class="o">=</span><span class="n">removeRanges</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=</span><span class="n">initialPeakOverMad</span><span class="p">)</span>
                    <span class="n">warnings</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
                    <span class="c1"># recompute a new mom8fc, mom0fc, momDiff, mom8fc.minus.mom0fcScaled</span>
                    <span class="c1">##################################</span>
                    <span class="c1"># Build a final mom8fc image</span>
                    <span class="c1">##################################</span>
                    <span class="n">myIntersectName</span> <span class="o">=</span> <span class="n">amendMaskIterationName</span><span class="o">+</span><span class="s1">&#39;Intersect&#39;</span>
                    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                        <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                        <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span>
                        <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                        <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">amendMaskIterationName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Intersect&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[8], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0], chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                        <span class="n">immoments</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="n">finalMom0fc</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>
                    <span class="n">finalMom8fc</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>
                    <span class="n">mom8fcSNR</span><span class="p">,</span> <span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8fcMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                              <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span>
                                                                              <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                        <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mom8fcSNROutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                                         <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># need to recalculate mom8fcSNRCube because the numerator has changed</span>
                    <span class="n">mom8fcSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                    <span class="n">mom8fcSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># create scaled version of mom0fcIntersect</span>
                    <span class="n">mom0fcIntersectScaled</span> <span class="o">=</span> <span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                    <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
                    <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
                    <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
                    <span class="n">immath</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcIntersectScaled</span><span class="p">)</span>

                    <span class="c1"># Need to build a new momDiff image since we have a new mom8fc[myIntersectName]</span>
                    <span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">=</span> <span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.minus.mom0fcScaled&#39;</span>
                    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>  <span class="c1"># in case there was a prior run of findContinuum</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.3&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;immath([&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], mode=&#39;evalexpr&#39;, expr=&#39;IM0-IM1&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span><span class="n">mom0fcIntersectScaled</span><span class="p">,</span><span class="n">mymask</span><span class="p">,</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                    <span class="n">immath</span><span class="p">([</span><span class="n">mom8fc</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mom0fcIntersectScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">])</span>
                    <span class="n">finalMomDiff</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]</span>

                    <span class="c1"># Recalculate for purposes of second 4-letter code</span>
                    <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span>
                                                                                  <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span>
                                                                                  <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">]))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNR: </span><span class="si">%f</span><span class="s1">  peakAnywhere: </span><span class="si">%f</span><span class="s1">  median: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">))</span>
                    <span class="c1"># This is the SNR outside the mask</span>
                    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
                        <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median and MAD from the annulus</span>
                        <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span> <span class="o">=</span> <span class="n">imageSNRAnnulus</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> 
                                                                                           <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">momDiffSum</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">momDiff</span><span class="p">[</span><span class="n">myIntersectName</span><span class="p">],</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)[</span><span class="s1">&#39;sum&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">momDiffSNRCube</span> <span class="o">=</span> <span class="p">(</span><span class="n">momDiffPeakOutside</span><span class="o">-</span><span class="n">momDiffMedian</span><span class="p">)</span><span class="o">/</span><span class="n">MADCubeOutside</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;momDiffSNRCube: </span><span class="si">%f</span><span class="s1">  scaledMAD: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mom8code</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                                          <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                                          <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># use looser definition of Same</span>
                                                          <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                          <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                          <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                          <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                          <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> 
                                                          <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">addedSelection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Needs momDiff 4-letter code</span>
                        <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">momDiffCode</span> <span class="o">=</span> <span class="n">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">momDiffPeak</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeak0</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> 
                                                      <span class="n">momDiffPeakOutside0</span><span class="p">,</span> <span class="n">momDiffSum</span><span class="p">,</span> <span class="n">momDiffSum0</span><span class="p">,</span> 
                                                      <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span>  <span class="c1"># use looser definition of Same</span>
                                                      <span class="n">areaString</span><span class="p">,</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span>
                                                      <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> 
                                                      <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">useMomentDiff</span><span class="p">,</span> 
                                                      <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                      <span class="n">addedSelection</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoLower2Decision</span><span class="o">=</span><span class="n">autoLower2Decision</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="n">amendMaskIterations</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="n">originalPng</span><span class="p">:</span>
                        <span class="n">png</span> <span class="o">=</span> <span class="n">originalPng</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span><span class="s1">&#39;_addedRange.png&#39;</span><span class="p">)</span>
                    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
                    <span class="c1"># but we *might* have made it worse, so check again</span>
                    <span class="k">if</span> <span class="n">momDiffCode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">code</span> <span class="o">=</span> <span class="n">mom8code</span>
                        <span class="k">if</span> <span class="n">mom8code</span> <span class="ow">in</span> <span class="n">reversionCodes</span><span class="p">:</span>
                            <span class="n">revert</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;This mom8fc code triggers reversion to original result.&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> 
                        <span class="n">code</span> <span class="o">=</span> <span class="n">momDiffCode</span>
                        <span class="k">if</span> <span class="n">momDiffCode</span> <span class="ow">in</span> <span class="n">reversionCodes</span> <span class="ow">and</span> <span class="n">momDiffSNR</span> <span class="o">&gt;</span> <span class="n">momDiffLevel</span><span class="p">:</span> <span class="c1"># and False: # temporary test for PIPE-2188</span>
                            <span class="n">revert</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;This momDiff code with momDiffSNR&gt;</span><span class="si">%.1f</span><span class="s1"> triggers reversion to original result.&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">momDiffLevel</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">warnings</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">revert</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;This combination of bandwidth warnings triggers reversion to original result, which had only </span><span class="si">%d</span><span class="s1"> warning(s).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">originalWarnings</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">revert</span><span class="p">:</span>
            <span class="n">finalMomDiff</span> <span class="o">=</span> <span class="n">momDiff</span><span class="p">[</span><span class="s1">&#39;.original&#39;</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">originalSelection</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;code=</span><span class="si">%s</span><span class="s1">: Reverting to original selection: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span><span class="n">selection</span><span class="p">))</span>
            <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">originalPng</span> <span class="o">!=</span> <span class="n">png</span><span class="p">:</span>
                <span class="n">png</span> <span class="o">=</span> <span class="n">revertedPng</span>
                <span class="c1"># update the modification time to current time (like Unix &#39;touch&#39;) so that it appears to be most recent</span>
                <span class="n">os</span><span class="o">.</span><span class="n">utime</span><span class="p">(</span><span class="n">png</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">revertedPng</span><span class="p">)</span>
<span class="c1">#    endif amendMask:</span>

    <span class="c1">##########################################################################################</span>
    <span class="c1"># Determine the name of the finalImageToReturn, in case it was requested</span>
    <span class="c1">##########################################################################################</span>
    <span class="n">pathCode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">amendMask</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
            <span class="n">finalImageToReturn</span> <span class="o">=</span> <span class="n">finalMomDiff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalImageToReturn</span> <span class="o">=</span> <span class="n">finalMom8fc</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;finalImageToReturn = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">finalImageToReturn</span><span class="p">))</span>
        <span class="n">momDiffSNR</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                              <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;********************************************&#39;</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;***** SNR in final momDiff image: </span><span class="si">%.1f</span><span class="s1"> *****&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;********************************************&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">areaString</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pathCode</span> <span class="o">=</span> <span class="n">areaString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;***** pathCode: </span><span class="si">%s</span><span class="s1">   momDiffCode: </span><span class="si">%s</span><span class="s1"> *****&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pathCode</span><span class="p">,</span><span class="n">momDiffCode</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">momDiffCode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">momDiffSNR</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">finalImageToReturn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># could return the image if I find the right name</span>

    <span class="c1">##########################################################################</span>
    <span class="c1"># Finish up by generating warnings (if necessary), checking for AllCont, </span>
    <span class="c1"># and writing summary of results to the _findContinuum.dat file</span>
    <span class="c1">##########################################################################</span>
    <span class="n">nranges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span>
    <span class="n">nkeep</span> <span class="o">=</span> <span class="n">MAX_RANGES_FOR_IMMOMENTS</span>
    <span class="k">if</span> <span class="n">nranges</span> <span class="o">&gt;</span> <span class="n">nkeep</span> <span class="ow">and</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;6.5.3&#39;</span><span class="p">:</span>
        <span class="c1"># avoid CAS-13894</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">cutSomeNarrowRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nkeep</span><span class="p">)</span>
        <span class="n">channelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Cut </span><span class="si">%d</span><span class="s1"> narrowest ranges to avoid CAS-13894 in casa-</span><span class="si">%s</span><span class="s1">.  New aggregate bandwidth = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">casaVersion</span><span class="p">,</span><span class="n">aggregateBandwidth</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumFile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> 
        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">buildMeanSpectrumFilename</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
    <span class="c1"># only the base name of the meanSpectrumFile is used by writeContDat, not the contents</span>
    <span class="n">contDat</span> <span class="o">=</span> <span class="n">writeContDat</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span>
                           <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> 
                           <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
    <span class="n">executionTimeSeconds</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">executionTimeSeconds</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Final selection: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">))</span>
    <span class="n">channelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="n">pdiff</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">channelList</span><span class="p">])</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span> <span class="o">/</span> <span class="n">medianTrue</span>
    <span class="n">dottedCyanLevel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">channelList</span><span class="p">])</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Median of cyan ranges spw</span><span class="si">%s</span><span class="s2">: </span><span class="si">%f</span><span class="s2">  medianTrue(black): </span><span class="si">%f</span><span class="s2">  percentDiff=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">dottedCyanLevel</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">pdiff</span><span class="p">))</span>
    <span class="c1">#####################################################################################</span>
    <span class="c1"># Post Final warnings to the log (as they might have changed due to reversion above)</span>
    <span class="c1">#####################################################################################</span>
    <span class="n">warningStringList</span> <span class="o">=</span> <span class="n">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
    <span class="n">warningStrings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">warningStringList</span><span class="p">:</span>  <span class="c1"># PIPE-2158 for Cycle 11</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="c1">#    warningStrings = [w.split()[-1] for w in warningStrings]  # picks out LowBW and/or LowSpread at end of string (see tooLittleSpread() and tooLittleBandwidth())</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Final warnings: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">warningStrings</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">aggregateBandwidth</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="n">nchan</span><span class="p">):</span>
        <span class="c1"># There is more than 1 group after blue pruning, page 258, so there might be a line in that gap</span>
        <span class="c1"># or less than half was selected for continuum, so this is dubious enough that we should clean it</span>
        <span class="n">allContinuum</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">allContinuum</span> <span class="o">=</span> <span class="n">allContinuumSelected</span><span class="p">(</span><span class="n">selectionPreBluePruning</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>

    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;final png: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">png</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;final jointMask: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jointMask</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Finished findContinuum.py. Execution time: </span><span class="si">%.1f</span><span class="s2"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">executionTimeSeconds</span><span class="p">))</span>
    <span class="c1">########################################################################</span>
    <span class="c1"># There are 16 possible return lists, based on control parameters.</span>
    <span class="c1"># The pipeline use case (which has changed with release) is noted below.</span>
    <span class="c1">########################################################################</span>
    <span class="k">if</span> <span class="n">returnSnrs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">returnAllContinuumBoolean</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">returnSigmaFindContinuum</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">)</span>  
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">returnSigmaFindContinuum</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>   
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># not returnSnrs</span>
        <span class="k">if</span> <span class="n">returnAllContinuumBoolean</span><span class="p">:</span>  <span class="c1"># default=True</span>
            <span class="k">if</span> <span class="n">returnSigmaFindContinuum</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>  <span class="c1"># default=True</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">contDat</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">negativeThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">dottedCyanLevel</span><span class="p">)</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">contDat</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">negativeThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">dottedCyanLevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">returnMomDiffSNR</span><span class="p">:</span>
                        <span class="c1"># PL2023 use case</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Pipeline 2020+ use case</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">)</span> <span class="c1">#  added mask name here for PL2022+</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">returnMomDiffSNR</span><span class="p">:</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Pipeline Cycle 7 use case</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">allContinuum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">returnSigmaFindContinuum</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">warningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>    
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">sigmaFindContinuumAtEndOfOriginalIteration</span><span class="p">,</span> <span class="n">intersectionOfSelections</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span> <span class="n">finalImageToReturn</span><span class="p">,</span> <span class="n">pathCode</span><span class="p">,</span> <span class="n">momDiffCode</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">returnWarnings</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">returnMomDiffSNR</span><span class="p">:</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">returnWarningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">returnWarningStrings</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">returnMomDiffSNR</span><span class="p">:</span>
                        <span class="c1"># Pipeline Cycle 6 (and prior) use case</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">)</span></div>

<span class="c1"># end of findContinuum   </span>

<div class="viewcode-block" id="cutSomeNarrowRanges">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.cutSomeNarrowRanges">[docs]</a>
<span class="k">def</span> <span class="nf">cutSomeNarrowRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nkeep</span><span class="o">=</span><span class="n">MAX_RANGES_FOR_IMMOMENTS</span><span class="p">,</span> 
                        <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove the N narrowest ranges from a channel selection string to avoid </span>
<span class="sd">    CAS-13894 crash of immoments.</span>
<span class="sd">    selection: e.g. &#39;14~18;50~60&#39;</span>
<span class="sd">    nkeep: number of ranges to keep (failures of imstat have been seen at 244 </span>
<span class="sd">        and 245)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="n">countChannelsInRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="n">ncut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span><span class="o">-</span><span class="n">nkeep</span>
    <span class="k">if</span> <span class="n">ncut</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">selection</span>
    <span class="k">elif</span> <span class="n">nkeep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Cutting the </span><span class="si">%d</span><span class="s2"> narrowest ranges to avoid CAS-13894&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ncut</span><span class="p">))</span>
    <span class="n">indexShortestFirst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lengths</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indexShortestFirst</span><span class="p">[:</span><span class="n">ncut</span><span class="p">]:</span>
            <span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">selectionRanges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span>
    <span class="n">selectionRanges</span> <span class="o">=</span> <span class="n">selectionRanges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">j</span><span class="p">)]</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selectionRanges</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">selection</span></div>


<div class="viewcode-block" id="gauss_kern">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.gauss_kern">[docs]</a>
<span class="k">def</span> <span class="nf">gauss_kern</span><span class="p">(</span><span class="n">size</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Returns a normalized 2D gauss kernel array for convolutions.  Used by smooth.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
    <span class="n">x</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="n">size</span><span class="p">:</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">g</span> <span class="o">/</span> <span class="n">g</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>


<div class="viewcode-block" id="smooth">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.smooth">[docs]</a>
<span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">window_len</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;hanning&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">newMethod</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    https://scipy-cookbook.readthedocs.io/items/SignalSmooth.html</span>
<span class="sd">    Date: 2017-07-13</span>

<span class="sd">    Smooth the data using a window with requested size.</span>
<span class="sd">    </span>
<span class="sd">    This method is based on the convolution of a scaled window with the signal.</span>
<span class="sd">    The signal is prepared by introducing reflected copies of the signal </span>
<span class="sd">    (with the window size) in both ends so that transient parts are minimized</span>
<span class="sd">    in the beginning and end part of the output signal.</span>
<span class="sd">    </span>
<span class="sd">    input:</span>
<span class="sd">        x: the input signal </span>
<span class="sd">        window_len: the dimension of the smoothing window</span>
<span class="sd">        window: the type of window from &#39;flat&#39;, &#39;hanning&#39;, &#39;hamming&#39;, &#39;bartlett&#39;, &#39;blackman&#39;</span>
<span class="sd">            flat window will produce a moving average smoothing.</span>

<span class="sd">    output:</span>
<span class="sd">        the smoothed signal</span>
<span class="sd">        </span>
<span class="sd">    example:</span>

<span class="sd">    t = linspace(-2,2,0.1)</span>
<span class="sd">    x = sin(t)+random.randn(len(t))*0.1</span>
<span class="sd">    y = smooth(x)</span>
<span class="sd">    </span>
<span class="sd">    see also: </span>
<span class="sd">    </span>
<span class="sd">    numpy.hanning, numpy.hamming, numpy.bartlett, numpy.blackman, numpy.convolve</span>
<span class="sd">    scipy.signal.lfilter</span>
<span class="sd"> </span>
<span class="sd">    TODO: the window parameter could be the window itself if an array instead of a string   </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;smooth only accepts 1 dimension arrays.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">window_len</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input vector needs to be bigger than window size.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">window_len</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning unsmoothed input data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">window</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="s1">&#39;hanning&#39;</span><span class="p">,</span> <span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="s1">&#39;blackman&#39;</span><span class="p">,</span> <span class="s1">&#39;gauss&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Window is on of &#39;flat&#39;, &#39;hanning&#39;, &#39;hamming&#39;, &#39;bartlett&#39;, &#39;blackman&#39;, &#39;gauss&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">newMethod</span><span class="p">:</span>  <span class="c1"># superior</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> 
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># this method introduces rollups or rolldowns at the edges</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">window_len</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kernel length: </span><span class="si">%d</span><span class="s2">, window_len: </span><span class="si">%d</span><span class="s2">, data_len: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">window_len</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    
    <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span> <span class="c1">#moving average</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_len</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">gauss_kern</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">window</span><span class="p">)(</span><span class="n">window_len</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">w</span><span class="o">/</span><span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">s</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">window_len</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="n">window_len</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="robustMADofContinuumRanges">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.robustMADofContinuumRanges">[docs]</a>
<span class="k">def</span> <span class="nf">robustMADofContinuumRanges</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,</span> <span class="n">myIntensity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    myChannelList: subset of channels that are currently the continuum selection</span>
<span class="sd">    intensity: list of intensities in *all* channels of the spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">myIntensity</span><span class="p">)</span> <span class="c1"># prevent changing the input!</span>
    <span class="n">totalChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="n">intensityInFCSubset</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">myChannelList</span><span class="p">]</span>
    <span class="n">medianFCSubset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Median of the </span><span class="si">%d</span><span class="s1"> continuum channels: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">),</span> <span class="n">medianFCSubset</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">:</span>
<span class="c1">#        Original simpler method:        </span>
<span class="c1">#        scaledMADFCSubset = MAD(intensityInFCSubset)</span>
<span class="c1">#        casalogPost(&#39;using MAD of the %d continuum channels: %f&#39; % (len(myChannelList),scaledMADFCSubset))</span>
        <span class="c1"># This method removes the effect of a slope in the baseline on the MAD</span>
        <span class="n">myChannelLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span>
        <span class="n">MADs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Medians</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mylist</span> <span class="ow">in</span> <span class="n">myChannelLists</span><span class="p">:</span>
            <span class="n">Medians</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">mylist</span><span class="p">]))</span>
            <span class="n">MADs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">mylist</span><span class="p">]))</span>
        <span class="n">scaledMADFCSubset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">MADs</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">)</span><span class="o">-</span><span class="n">medianFCSubset</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaledMADFCSubset</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;(median of the MADs)/sqrt(2) of the </span><span class="si">%d</span><span class="s1"> ranges: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelLists</span><span class="p">),</span><span class="n">scaledMADFCSubset</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;old SNR = (peak-median)/medianMAD = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr</span><span class="p">))</span>

        <span class="c1"># But taking the MAD of very narrow ranges (width 2-4 channels) will severely underestimate the true MAD</span>
        <span class="c1"># So we should go back to  using all channels at once.  In order to still be able to remove the effect of</span>
        <span class="c1"># a slope in the baseline, we could do a linear fit to all of their median values if len(myChannelLists) &gt; 1.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelLists</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Medians</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Medians</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Medians</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;slope=</span><span class="si">%f</span><span class="s1">, intercept=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="n">intercept</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mylist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">myChannelLists</span><span class="p">):</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">intercept</span> <span class="o">+</span> <span class="n">slope</span><span class="o">*</span><span class="n">i</span>
<span class="c1">#                casalogPost(&#39;subtracting bias = %f&#39; % (bias))</span>
                <span class="n">intensity</span><span class="p">[</span><span class="n">mylist</span><span class="p">]</span> <span class="o">-=</span> <span class="n">bias</span>
            <span class="n">intensityInFCSubset</span> <span class="o">=</span> <span class="n">intensity</span><span class="p">[</span><span class="n">myChannelList</span><span class="p">]</span>
        <span class="n">scaledMADFCSubset</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">)</span>   <span class="c1"># dividing by 3 makes it close to the prior method for G35.03 spw27</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;MAD of all FC channels together = </span><span class="si">%f</span><span class="s1">,  1/3 of that = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">MAD</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">),</span> <span class="n">scaledMADFCSubset</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">intensityInFCSubset</span> <span class="o">+=</span> <span class="n">medianFCSubset</span>   <span class="c1"># restore the global median of all FC channels</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">)</span><span class="o">-</span><span class="n">medianFCSubset</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaledMADFCSubset</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;new SNR = (peak-median) / MAD = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snr</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">)</span>
        <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span>
        <span class="n">nBaselineChannels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">0.19</span> <span class="o">*</span> <span class="n">npts</span><span class="p">))</span>
        <span class="c1"># If there are strong lines in the &quot;continuum&quot; regions, then the MAD can be not representative</span>
        <span class="c1"># So we examine the 19% lowest channels instead</span>
        <span class="k">if</span> <span class="n">nBaselineChannels</span> <span class="o">&gt;</span> <span class="mi">35</span> <span class="ow">and</span> <span class="n">snr</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>  <span class="c1"># put the cutoff between TDM and FDM240 (35/.19=184chan)</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">nBaselineChannels</span><span class="p">])</span>
<span class="c1">#            percentile = 100.0*nBaselineChannels / totalChannels</span>
            <span class="n">correctionFactor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># sigmaCorrectionFactor(&#39;min&#39;, npts, percentile)</span>
            <span class="n">newMAD</span> <span class="o">=</span> <span class="n">mad</span> <span class="o">*</span> <span class="n">correctionFactor</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Because there is significant signal in the continuum-free ranges, computing the MAD inferred from the lowest </span><span class="si">%d</span><span class="s1"> channels: </span><span class="si">%f</span><span class="s1"> (using correctionFactor=</span><span class="si">%f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">newMAD</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">newMAD</span> <span class="o">&lt;</span> <span class="n">scaledMADFCSubset</span><span class="p">:</span>
                <span class="n">newMedianFCSubset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensityInFCSubset</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">nBaselineChannels</span><span class="p">])</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Because the MAD is lower, computing the MAD and median (</span><span class="si">%f</span><span class="s1">) of the baseline channels.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newMedianFCSubset</span><span class="p">))</span>
                <span class="n">scaledMADFCSubset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">scaledMADFCSubset</span><span class="p">,</span> <span class="n">newMAD</span><span class="p">])</span>
                <span class="n">medianFCSubset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">newMedianFCSubset</span><span class="p">])</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Using the mean of the two methods: median=</span><span class="si">%f</span><span class="s1"> MAD=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianFCSubset</span><span class="p">,</span> <span class="n">scaledMADFCSubset</span><span class="p">))</span>
<span class="c1">#            medianFCSubset = medianCorrected(&#39;min&#39;, percentile, np.median(intensityInFCSubset[idx][:nBaselineChannels]), </span>
<span class="c1">#                                             scaledMADFCSubset, 1, True)</span>
<span class="c1">#            casalogPost(&#39;Inferred median = %f&#39; % (medianFCSubset))</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># there are too few channels to compute a reliable MAD</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;using MAD of all channels because there are too few channels in line-free regions (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)))</span>
        <span class="n">scaledMADFCSubset</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scaledMADFCSubset</span><span class="p">,</span> <span class="n">medianFCSubset</span></div>


<div class="viewcode-block" id="gatherWarnings">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.gatherWarnings">[docs]</a>
<span class="k">def</span> <span class="nf">gatherWarnings</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    Return list of warning strings (often empty).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warningStrings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">tooLittleBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallBandwidthFraction</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># PIPE-2158</span>
    <span class="n">warning</span> <span class="o">=</span> <span class="n">tooLittleSpread</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">smallSpreadFraction</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">warning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warning</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warningStrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="c1"># PIPE-2158</span>
    <span class="k">return</span> <span class="n">warningStrings</span></div>


<div class="viewcode-block" id="compute4LetterCodeAndUpdateLegend">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.compute4LetterCodeAndUpdateLegend">[docs]</a>
<span class="k">def</span> <span class="nf">compute4LetterCodeAndUpdateLegend</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                      <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                      <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> 
                                      <span class="n">labelDescs</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">amendMaskDecision</span><span class="p">,</span> 
                                      <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">,</span>
                                      <span class="n">intersectionOfSelections</span><span class="p">,</span> 
                                      <span class="n">useMomentDiff</span><span class="p">,</span> <span class="n">warnings</span><span class="p">,</span> <span class="n">channelRanges</span><span class="p">,</span> <span class="n">sigmaUsedToAmendMask</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">skipDecisionCode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">addedSelection</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">autoLower2Decision</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amendMaskIterations</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    Add a variable length code and a 4-letter code to the end of the last line of the upper legend.</span>
<span class="sd">    useMomentDiff: specified in the call to findContinuum()</span>
<span class="sd">    Returns:  labelDescs, areaString, mycode</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;compute4LetterCodeAndUpdateLegend: replace=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">replace</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">replace</span><span class="p">:</span>
        <span class="n">areaString</span> <span class="o">=</span> <span class="n">areaString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skipDecisionCode</span><span class="p">:</span>
        <span class="n">decisionCode</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amend=</span><span class="si">%s</span><span class="s2">, extra=</span><span class="si">%s</span><span class="s2">, extra2=</span><span class="si">%s</span><span class="s2">, autoLower=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision</span><span class="p">,</span> <span class="n">extraMaskDecision2</span><span class="p">,</span> <span class="n">autoLowerDecision</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">amendMaskDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;No&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">extraMaskDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;No&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">sigmaUsedToAmendMask</span> <span class="o">==</span> <span class="n">AMENDMASK_PIXEL_RATIO_EXCEEDED</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, PR&#39; to the plot legend&quot;</span><span class="p">)</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, PR&#39;</span>
                <span class="k">elif</span> <span class="n">sigmaUsedToAmendMask</span> <span class="o">==</span> <span class="n">AMENDMASK_PIXELS_ABOVE_THRESHOLD_EXCEEDED</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, P#&#39; to the plot legend&quot;</span><span class="p">)</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, P#&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, S&#39; to the plot legend&quot;</span><span class="p">)</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, S&#39;</span>
            <span class="k">elif</span> <span class="n">extraMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;NoImprovement&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, Se&#39; to the plot legend&quot;</span><span class="p">)</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s2">&quot;, Se&quot;</span>
            <span class="k">elif</span> <span class="n">extraMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;YesMom&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, ED&#39; to the plot legend&quot;</span><span class="p">)</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, ED&#39;</span>
            <span class="k">elif</span> <span class="n">extraMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;YesCube&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding &#39;, EC&#39; to the plot legend&quot;</span><span class="p">)</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, EC&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;, A&#39;</span>
            <span class="k">if</span> <span class="n">amendMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;YesMom&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">useMomentDiff</span><span class="p">:</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;D&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;8&#39;</span>
            <span class="k">elif</span> <span class="n">amendMaskDecision</span> <span class="o">==</span> <span class="s1">&#39;YesCube&#39;</span><span class="p">:</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;C&#39;</span>
            <span class="k">if</span> <span class="n">extraMaskDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">extraMaskDecision2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]:</span>
<span class="c1">#                if extraMaskDecision in [&#39;YesMom&#39;,&#39;YesCube&#39;]:</span>
<span class="c1">#                    decisionCode += &#39;E&#39;</span>
                <span class="k">if</span> <span class="n">intersectionOfSelections</span><span class="p">:</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
                    <span class="k">if</span> <span class="n">extraMaskDecision2</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]:</span>
                        <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;E&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;E&#39;</span>
            <span class="k">elif</span> <span class="n">intersectionOfSelections</span><span class="p">:</span>
                <span class="c1"># this will only happen if findContinuum was run with amendMaskIterations=1 instead of 2</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">if</span> <span class="n">autoLowerDecision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]:</span>
            <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;X&#39;</span>
        <span class="k">elif</span> <span class="n">autoLowerDecision</span> <span class="o">==</span> <span class="s1">&#39;NoImprovement&#39;</span><span class="p">:</span>
            <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;x&#39;</span>
        <span class="k">elif</span> <span class="n">autoLowerDecision</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;No&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
            <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">amendMaskIterations</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;autoLower2Decision = &quot;</span><span class="p">,</span> <span class="n">autoLower2Decision</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">autoLower2Decision</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;YesMom&#39;</span><span class="p">,</span><span class="s1">&#39;YesCube&#39;</span><span class="p">]:</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;Y&#39;</span>
            <span class="k">elif</span> <span class="n">autoLower2Decision</span> <span class="o">==</span> <span class="s1">&#39;NoImprovement&#39;</span><span class="p">:</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;y&#39;</span>
            <span class="k">elif</span> <span class="n">autoLower2Decision</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;No&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
                <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span>
        <span class="k">if</span> <span class="n">addedSelection</span><span class="p">:</span>
            <span class="n">decisionCode</span> <span class="o">+=</span> <span class="s1">&#39;+&#39;</span> <span class="c1"># added a selection of channels at the end due to LowBW/LowSpread</span>
        <span class="n">areaString</span> <span class="o">+=</span> <span class="n">decisionCode</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Decision code: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decisionCode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">mycode</span> <span class="o">=</span> <span class="n">compute4LetterCode</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> 
                                <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> <span class="n">mom8fcSum0</span><span class="p">,</span> 
                                <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">thresholdForSame</span><span class="p">)</span>
    <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">mycode</span> <span class="o">+</span> <span class="s1">&#39;, difSNR=</span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">skipDecisionCode</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;, LowBW&#39;</span>
            <span class="k">if</span> <span class="n">warning</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;spread&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;, LowSpread&#39;</span>
    <span class="n">myaxis</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">myaxis</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Label: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">get_text</span><span class="p">()))</span>
    <span class="n">labelDescs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">areaString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">areaString</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39; </span><span class="si">%d</span><span class="s1"> ranges&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">channelRanges</span><span class="p">),</span> <span class="n">token</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Drawing new areaString: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">areaString</span><span class="p">))</span>
    <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.99</span><span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="n">difSNRFontsizeAdjust</span><span class="p">)</span>
    <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
<span class="c1">#    casalogPost(&quot;calling pl.draw&quot;)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
<span class="c1">#    casalogPost(&quot;done pl.draw&quot;)</span>
    <span class="k">return</span> <span class="n">labelDescs</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">mycode</span></div>


<div class="viewcode-block" id="updateChannelRangesOnPlot">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.updateChannelRangesOnPlot">[docs]</a>
<span class="k">def</span> <span class="nf">updateChannelRangesOnPlot</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> 
                              <span class="n">skipchan</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">positiveThreshold</span><span class="p">,</span> <span class="n">upperXlabel</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> 
                              <span class="n">channelWidth</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">remove</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    channelWidth: in Hz</span>
<span class="sd">    Returns: new aggregate bandwidth in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">remove</span><span class="p">:</span>
        <span class="c1"># exclude final item, which is the 3rd line of the legend</span>
<span class="c1">#        print(&quot;labelDescs: &quot;, labelDescs)</span>
        <span class="k">for</span> <span class="n">ld</span><span class="p">,</span><span class="n">labelDesc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">labelDescs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span> 
<span class="c1">#            print(&quot;type(labelDesc) = &quot;, type(labelDesc))</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>  <span class="c1"># plot artists (i.e., the cyan lines)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">labelDesc</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># text artists (i.e., the chan0~chan1 labels above the cyan lines)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">labelDesc</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># prevent a crash; not sure why this happens sometimes on the first call</span>
                    <span class="k">pass</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling plotChannelSelections: &quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
    <span class="n">labelDescs</span> <span class="o">=</span> <span class="n">plotChannelSelections</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                          <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> 
                          <span class="n">positiveThreshold</span><span class="p">)</span>
    <span class="n">loc</span> <span class="o">=</span> <span class="n">upperXlabel</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;contBW&#39;</span><span class="p">)</span>
    <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">upperXlabel</span> <span class="o">=</span> <span class="n">upperXlabel</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;contBW: </span><span class="si">%.2f</span><span class="s1"> MHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aggregateBandwidth</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;=</span> <span class="n">NBIN_THRESHOLD</span><span class="p">:</span> <span class="c1"># PIPE-848</span>
            <span class="n">upperXlabel</span> <span class="o">+=</span> <span class="s1">&#39;, iPoM=</span><span class="si">%.1f</span><span class="s1">, nbin=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting new upper x-axis label: </span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="p">(</span><span class="n">upperXlabel</span><span class="p">))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">upperXlabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span> <span class="c1"># this artist cannot be removed in CASA 5.6, so just overwrite it</span>
    <span class="k">return</span> <span class="n">aggregateBandwidth</span> <span class="c1"># , labelDescs</span></div>


<div class="viewcode-block" id="computeNpixCubeMedian">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeNpixCubeMedian">[docs]</a>
<span class="k">def</span> <span class="nf">computeNpixCubeMedian</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">mom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    jointMaskTest: can be a mask, a mask statement or compound mask statement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mom8fcMedian</span> <span class="o">+</span> <span class="n">cubeLevel</span><span class="o">*</span><span class="n">MADCubeOutside</span>
    <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">))[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npixels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">NpixCubeMedian</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">NpixCubeMedian</span> <span class="o">=</span> <span class="n">npixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">NpixCubeMedian</span></div>


<div class="viewcode-block" id="computeNpixMom8MedianBadAtm">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeNpixMom8MedianBadAtm">[docs]</a>
<span class="k">def</span> <span class="nf">computeNpixMom8MedianBadAtm</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8levelBadAtm</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    jointMaskTest: can be a mask, a mask statement or compound mask statement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mom8fcMedian</span> <span class="o">+</span> <span class="n">mom8levelBadAtm</span><span class="o">*</span><span class="n">mom8fcMAD</span>
    <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">))[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npixels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">NpixMom8MedianBadAtm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">NpixMom8MedianBadAtm</span> <span class="o">=</span> <span class="n">npixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">NpixMom8MedianBadAtm</span></div>


<div class="viewcode-block" id="computeNpixMom8Median">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeNpixMom8Median">[docs]</a>
<span class="k">def</span> <span class="nf">computeNpixMom8Median</span><span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fc</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    mom8fcMedian: the median of the moment8 image being used </span>
<span class="sd">    mom8level: a sigma value to use</span>
<span class="sd">    mom8fcMAD: a scaled MAD</span>
<span class="sd">    jointMaskTest: can be a mask, a mask statement or compound mask statement</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">mom8fcMedian</span> <span class="o">+</span> <span class="n">mom8level</span><span class="o">*</span><span class="n">mom8fcMAD</span>
    <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;computeNpixMom8Median(): Running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span><span class="n">mymask</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mymask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npixels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">NpixMom8Median</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">NpixMom8Median</span> <span class="o">=</span> <span class="n">npixels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;computeNpixMom8Median(): momMedian=</span><span class="si">%f</span><span class="s2">, momlevel=</span><span class="si">%f</span><span class="s2">, momMAD=</span><span class="si">%f</span><span class="s2">, peak=</span><span class="si">%f</span><span class="s2">, jointMaskTest=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcMedian</span><span class="p">,</span> <span class="n">mom8level</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;                         threshold=</span><span class="si">%f</span><span class="s2">, NpixMom=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threshold</span><span class="p">,</span><span class="n">NpixMom8Median</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">NpixMom8Median</span></div>


<div class="viewcode-block" id="replaceLineFullRangesWithNoise">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.replaceLineFullRangesWithNoise">[docs]</a>
<span class="k">def</span> <span class="nf">replaceLineFullRangesWithNoise</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">scaledMAD</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    intensity: an array of intensity values of *all* channels in the spectrum</span>
<span class="sd">    selection: a channel selection string in CASA format, whose intensities should be replaced</span>
<span class="sd">    median: of the channels *not* in the selection string (for the noise generation)</span>
<span class="sd">    scaledMAD: of the channels *not* in the selection string (for the noise generation)</span>
<span class="sd">    Returns: a new intensity array, of the same dimension as the input array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2001</span><span class="p">)</span>  <span class="c1"># A Space Odyssey (guarantees that .onlyExtraMask will get same result everytime)</span>
    <span class="k">for</span> <span class="n">myrange</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="n">c0</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
<span class="c1">#        print(&quot;len(intensity)=%d, c0,c1 = %d,%d&quot; % (len(intensity), c0,c1))</span>
        <span class="n">peakSNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">scaledMAD</span>
        <span class="k">if</span> <span class="n">peakSNR</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>  <span class="c1"># was 15 in PL2023 (when the SNR values were anomalously high)</span>
            <span class="c1"># Note because the continuum is still in this spectrum, it can have a slope which</span>
            <span class="c1"># will make the MAD higher than normal, so we may need to account for this he scaledMAD </span>
            <span class="c1"># somewhat.</span>
            <span class="n">intensity</span><span class="p">[</span><span class="n">c0</span><span class="p">:</span><span class="n">c1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">pickRandomErrors</span><span class="p">(</span><span class="n">c1</span><span class="o">-</span><span class="n">c0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scaledMAD</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Replacing channel range </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2"> (peakSNR=</span><span class="si">%f</span><span class="s2">) with median=</span><span class="si">%f</span><span class="s2"> +- randomNumber*scaledMAD=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">peakSNR</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">scaledMAD</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not replacing channel range </span><span class="si">%d</span><span class="s2">:</span><span class="si">%d</span><span class="s2"> (peakSNR=</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">peakSNR</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">intensity</span></div>


<div class="viewcode-block" id="compute4LetterCode">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.compute4LetterCode">[docs]</a>
<span class="k">def</span> <span class="nf">compute4LetterCode</span><span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span> <span class="n">mom8fcPeak0</span><span class="p">,</span> <span class="n">mom8fcPeakOutside</span><span class="p">,</span> <span class="n">mom8fcPeakOutside0</span><span class="p">,</span> <span class="n">mom8fcSum</span><span class="p">,</span> 
                       <span class="n">mom8fcSum0</span><span class="p">,</span> <span class="n">mom8fcMAD</span><span class="p">,</span> <span class="n">mom8fcMAD0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">returnRatios</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    threshold: to use for Peak, PeakOutside, and Sum;  double this value is used for MAD (i.e. 2%)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">better</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">changeInPeakInside</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeak</span><span class="o">-</span><span class="n">mom8fcPeak0</span><span class="p">)</span><span class="o">/</span><span class="n">mom8fcPeak0</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># these will be negative values when the quantity improved</span>
    <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changeInPeakInside</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">changeInPeakInside</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak inside = H because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &gt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">changeInPeakInside</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">changeInPeakInside</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak inside = L because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &lt; -</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">changeInPeakInside</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak inside = S because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is between -</span><span class="si">%f</span><span class="s1"> and +</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeak</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">mom8fcPeak0</span><span class="p">,</span><span class="n">changeInPeakInside</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">changeInPeakOutside</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="o">-</span><span class="n">mom8fcPeakOutside0</span><span class="p">)</span><span class="o">/</span><span class="n">mom8fcPeakOutside0</span>
    <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changeInPeakOutside</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">changeInPeakOutside</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak outside = H because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &gt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">changeInPeakOutside</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">changeInPeakOutside</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak outside = L because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &lt; -</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">changeInPeakOutside</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;peak outside = S because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is between -</span><span class="si">%f</span><span class="s1"> and +</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcPeakOutside</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">mom8fcPeakOutside0</span><span class="p">,</span><span class="n">changeInPeakOutside</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">changeInSum</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcSum</span><span class="o">-</span><span class="n">mom8fcSum0</span><span class="p">)</span><span class="o">/</span><span class="n">mom8fcSum0</span>
    <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changeInSum</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">changeInSum</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;sum = H because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &gt; </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcSum</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">changeInSum</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">changeInSum</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">threshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;sum = L because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &lt; -</span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcSum</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">changeInSum</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;sum = S because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is between -</span><span class="si">%f</span><span class="s1"> and +</span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcSum</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">mom8fcSum0</span><span class="p">,</span><span class="n">changeInSum</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">changeInMad</span> <span class="o">=</span> <span class="p">(</span><span class="n">mom8fcMAD</span><span class="o">-</span><span class="n">mom8fcMAD0</span><span class="p">)</span><span class="o">/</span><span class="n">mom8fcMAD0</span>
    <span class="n">ratios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">changeInMad</span><span class="p">)</span>
    <span class="n">madThreshold</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">threshold</span>
    <span class="k">if</span> <span class="n">changeInMad</span> <span class="o">&gt;</span> <span class="n">madThreshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;MAD = H because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &gt; </span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcMAD</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">changeInMad</span><span class="p">,</span><span class="n">madThreshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;H&#39;</span>
    <span class="k">elif</span> <span class="n">changeInMad</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">madThreshold</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;MAD = L because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is &lt; -</span><span class="si">%f</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcMAD</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">changeInMad</span><span class="p">,</span><span class="n">madThreshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;L&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;MAD = S because (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1">=</span><span class="si">%f</span><span class="s1"> is between -</span><span class="si">%f</span><span class="s1"> and +</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8fcMAD</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">mom8fcMAD0</span><span class="p">,</span><span class="n">changeInMad</span><span class="p">,</span><span class="n">madThreshold</span><span class="p">,</span><span class="n">madThreshold</span><span class="p">))</span>
        <span class="n">better</span> <span class="o">+=</span> <span class="s1">&#39;S&#39;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;4-letter code: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">better</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">returnRatios</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">better</span><span class="p">,</span> <span class="n">ratios</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">better</span></div>


<div class="viewcode-block" id="cubeNoiseLevel">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.cubeNoiseLevel">[docs]</a>
<span class="k">def</span> <span class="nf">cubeNoiseLevel</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    Computes median of the per-channel scaled MAD within the standard noise annulus</span>
<span class="sd">    and outside the specified mask</span>
<span class="sd">    chans: channel selection string (passed to imstat)</span>
<span class="sd">    mask: either mask image to use (e.g. the string passed to imstat will be &#39;&quot;mask&quot; == 0&#39;)</span>
<span class="sd">          or a proper mask string containing &gt;, &lt; or ==</span>
<span class="sd">    percentile: compute this percentile value of the per-channel scaled MAD</span>
<span class="sd">          (examples: 50 = median,  90 = close to the highest value)</span>
<span class="sd">          if it is a list, then a list of values is returned</span>
<span class="sd">    Returns: median of MAD, median</span>
<span class="sd">          or [list of MADs], median</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find the cube&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">pbcube</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">pbcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbcube</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not find the corresponding pbcube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Will use the whole image (or the specified mask) to compute the MAD.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">,</span><span class="s1">&#39;.mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.mask&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">cube</span> <span class="o">+</span> <span class="s1">&#39;.joint.mask2&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">cube</span> <span class="o">+</span> <span class="s1">&#39;.joint.mask&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find any corresponding clean mask or findContinuum jointmask&quot;</span><span class="p">)</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbcube</span><span class="p">):</span>
        <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">mask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">mask</span><span class="o">+</span><span class="s1">&#39;&quot;==0&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    Using mask: &quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
            <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mymask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    mymask expression = &quot;</span><span class="p">,</span> <span class="n">mymask</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mymask</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">)</span>
    <span class="n">cubeMedian</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">percentile</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">percentile</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">percentile</span> <span class="o">=</span> <span class="p">[</span><span class="n">percentile</span><span class="p">]</span>
    <span class="n">cubeScaledMAD</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">percentile</span><span class="p">:</span>
        <span class="n">cubeScaledMAD</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="mf">0.6745</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cubeScaledMAD</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubeScaledMAD</span><span class="p">,</span> <span class="n">cubeMedian</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cubeScaledMAD</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cubeMedian</span></div>


<div class="viewcode-block" id="tooLittleBandwidth">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.tooLittleBandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">tooLittleBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    Returns: a string if there is a warning, or None if not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
    <span class="n">aggBandwidthHz</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>
    <span class="n">myfraction</span> <span class="o">=</span> <span class="n">aggBandwidthHz</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="n">nchan</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">myfraction</span> <span class="o">&lt;</span> <span class="n">fraction</span><span class="p">:</span> <span class="c1"># compute4LetterCodeAndUpdateLegend() keys on the presence of the word &#39;amount&#39;</span>
        <span class="n">warning</span> <span class="o">=</span> <span class="s1">&#39;WARNING: Small amount of fractional bandwidth found (</span><span class="si">%.3f</span><span class="s1"> &lt; </span><span class="si">%.3f</span><span class="s1">) = LowBW&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myfraction</span><span class="p">,</span><span class="n">fraction</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">warning</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Current fractional bandwidth is </span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myfraction</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="computeSpread">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeSpread">[docs]</a>
<span class="k">def</span> <span class="nf">computeSpread</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">startchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="c1"># keep extending the endchan where there is more than 1 group</span>
            <span class="n">endchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">endchan</span><span class="o">-</span><span class="n">startchan</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">channelWidth</span></div>


<div class="viewcode-block" id="tooLittleSpread">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.tooLittleSpread">[docs]</a>
<span class="k">def</span> <span class="nf">tooLittleSpread</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.33</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    Returns: a string if there is a warning, or None if not</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
    <span class="n">spread</span> <span class="o">=</span> <span class="n">computeSpread</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">)</span>
    <span class="n">myfraction</span> <span class="o">=</span> <span class="n">spread</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nchan</span><span class="o">*</span><span class="n">channelWidth</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">myfraction</span> <span class="o">&lt;</span> <span class="n">fraction</span><span class="p">:</span>  <span class="c1"># compute4LetterCodeAndUpdateLegend() keys on the presence of the word &#39;spread&#39;</span>
        <span class="n">warning</span> <span class="o">=</span> <span class="s1">&#39;WARNING: Fractional spread of frequency coverage is small (</span><span class="si">%.3f</span><span class="s1"> &lt; </span><span class="si">%.3f</span><span class="s1">) = LowSpread&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myfraction</span><span class="p">,</span><span class="n">fraction</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="n">warning</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">warning</span>
    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="amendMaskYesOrNo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.amendMaskYesOrNo">[docs]</a>
<span class="k">def</span> <span class="nf">amendMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">momSNR</span><span class="p">,</span> <span class="n">momSNRCube</span><span class="p">,</span> <span class="n">Npix</span><span class="p">,</span> <span class="n">NpixBadAtm</span><span class="p">,</span> <span class="n">NpixCube</span><span class="p">,</span> 
                     <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">MADMomOutside</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momLevel</span><span class="p">,</span> 
                     <span class="n">momLevelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">NpixCube2</span><span class="p">,</span> <span class="n">fractionNegativePixels</span><span class="p">,</span>
                     <span class="n">Npix2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">Npix2BadAtm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">tooManyPixels</span><span class="o">=</span><span class="mi">850</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    median: median of mom8fc img if fc(useMomentDiff=False), or momDiff (mom8-mom0scaled) if useMomentDiff=True</span>
<span class="sd">    momSNR: SNR of mom8fc img if fc(useMomentDiff=False), or momDiff (mom8-mom0scaled) if useMomentDiff=True</span>
<span class="sd">    etc.</span>
<span class="sd">    badAtmosphere: either a boolean or a string (&#39;goodAtm&#39; or &#39;badAtm&#39;)</span>
<span class="sd">    momLevel: for the non-badAtmosphere case, this is passed in from momDiffLevelForProceeding </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AMENDMASK_PIXEL_RATIO_EXCEEDED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">AMENDMASK_PIXELS_ABOVE_THRESHOLD_EXCEEDED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
    <span class="n">AmendMaskLevel</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">AMENDMASK_PIXEL_RATIO_EXCEEDED</span>
    <span class="k">if</span> <span class="n">Npix2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">Npix2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pixelRatio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">Npix</span><span class="p">)</span><span class="o">/</span><span class="n">Npix2</span>
            <span class="k">if</span> <span class="n">pixelRatio</span> <span class="o">&gt;</span> <span class="mf">2.2</span><span class="p">:</span>  <span class="c1"># IRAS16293 maser gives 2.1667, NGC6334I spw16 gives 2.333</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Pixel ratio is too high to trigger AmendMask: </span><span class="si">%f</span><span class="s1"> &gt; 2.2&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pixelRatio</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;badAtm&#39;</span><span class="p">,</span><span class="kc">True</span><span class="p">]:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">fractionNegativePixels</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">NpixBadAtm</span> <span class="o">&gt;</span> <span class="n">tooManyPixels</span><span class="p">:</span>
            <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">AMENDMASK_PIXELS_ABOVE_THRESHOLD_EXCEEDED</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Fraction of negative pixels (</span><span class="si">%f</span><span class="s1">) &gt; 0.1 and too many pixels (</span><span class="si">%d</span><span class="s1">) above threshold to trigger AmendMask&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fractionNegativePixels</span><span class="p">,</span><span class="n">NpixBadAtm</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span>
    <span class="k">elif</span> <span class="n">badAtmosphere</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;goodAtm&#39;</span><span class="p">,</span><span class="kc">False</span><span class="p">]:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">fractionNegativePixels</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">Npix</span> <span class="o">&gt;</span> <span class="n">tooManyPixels</span><span class="p">:</span>
            <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">AMENDMASK_PIXELS_ABOVE_THRESHOLD_EXCEEDED</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Fraction of negative pixels (</span><span class="si">%f</span><span class="s1">) &gt; 0.1 and too many pixels (</span><span class="si">%d</span><span class="s1">) above threshold to trigger AmendMask&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fractionNegativePixels</span><span class="p">,</span><span class="n">Npix</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;fractionNegativePixels = </span><span class="si">%f</span><span class="s1">, Npix = </span><span class="si">%d</span><span class="s1">, allows it to trigger AmendMask&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fractionNegativePixels</span><span class="p">,</span><span class="n">Npix</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;badAtmosphere has unrecognized value = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">badAtmosphere</span><span class="p">))</span>
    <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># this is the value that will be returned if threshold are not met</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using badAtmosphere thresholds: momLevelBadAtm=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momLevelBadAtm</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">momSNR</span> <span class="o">&gt;=</span> <span class="n">momLevelBadAtm</span> <span class="ow">and</span> <span class="n">NpixBadAtm</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">AmendMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaUsed</span><span class="o">*</span><span class="n">MADMomOutside</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Found YesMom (BadAtm) with sigma=</span><span class="si">%g</span><span class="s1"> yielding AmendMaskLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">AmendMaskLevel</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amendMaskYesOrNo(): median=</span><span class="si">%f</span><span class="s2">, MADMomOutside=</span><span class="si">%f</span><span class="s2">, momSNR=</span><span class="si">%f</span><span class="s2">, Npix=%.f&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">MADMomOutside</span><span class="p">,</span> <span class="n">momSNR</span><span class="p">,</span> <span class="n">Npix</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;amendMaskYesOrNo(): momSNRCube=</span><span class="si">%f</span><span class="s2">, MADCubeOutside=</span><span class="si">%f</span><span class="s2">, NpixCube=</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momSNRCube</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">NpixCube</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">momSNR</span> <span class="o">&gt;=</span> <span class="n">momLevel</span> <span class="ow">and</span> <span class="n">Npix</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">AmendMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span> <span class="o">*</span> <span class="n">MADMomOutside</span>
            <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Found YesMom with sigma=</span><span class="si">%g</span><span class="s1"> (because momSNR=</span><span class="si">%f</span><span class="s1"> &gt;= momLevel=</span><span class="si">%f</span><span class="s1">) yielding AmendMaskLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">momSNR</span><span class="p">,</span><span class="n">momLevel</span><span class="p">,</span><span class="n">AmendMaskLevel</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">momSNRCube</span> <span class="o">&gt;=</span> <span class="n">cubeLevel</span> <span class="ow">and</span> <span class="n">NpixCube</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">skipCubeNoise</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Skipping the check for AmendMask needed on the basis of MADCubeOutside (due to skipCubeNoise=True)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Need to guard against divide by zero below, so we only assess the</span>
                <span class="c1"># ratio if we know that NpixCube &gt; 0, rather than making it</span>
                <span class="c1"># a 3-term &#39;elif&#39; clause above.</span>
                <span class="c1"># The float() below is to insure real arithmetic in CASA &lt; 6.</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">NpixCube2</span><span class="p">)</span><span class="o">/</span><span class="n">NpixCube</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
                    <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesCube&#39;</span>
                    <span class="n">AmendMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span> <span class="o">*</span> <span class="n">MADCubeOutside</span>
                    <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;YesCube: sigmaUsed = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">AmendMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span></div>


<div class="viewcode-block" id="extraMaskYesOrNo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.extraMaskYesOrNo">[docs]</a>
<span class="k">def</span> <span class="nf">extraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">momSNR</span><span class="p">,</span> <span class="n">momSNRCube</span><span class="p">,</span> <span class="n">NpixMom</span><span class="p">,</span> <span class="n">NpixMomBadAtm</span><span class="p">,</span> <span class="n">NpixCubeAnywhere</span><span class="p">,</span> 
                     <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">MADMomOutside</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> 
                     <span class="n">cubeLevel</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.  Also used for autoLower decision logic.</span>
<span class="sd">    badAtmosphere: either a boolean or a string (&#39;goodAtm&#39; or &#39;badAtm&#39;)</span>
<span class="sd">    momSNR: SNR outside the mask, i.e. will be momDiffSNR if useMomentDiff=True (which PL uses)</span>
<span class="sd">    NpixMom: unused now</span>
<span class="sd">    NpixMomBadAtm: unused now</span>
<span class="sd">    NpixCubeAnywhere: unused now</span>
<span class="sd">    momDiffLevel: for the non-badAtmosphere case, this is passed in from momDiffLevelForProceeding </span>
<span class="sd">    MADCubeOutside: not currently used in this function!</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
    <span class="n">ExtraMaskLevel</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span> <span class="o">==</span> <span class="s1">&#39;badAtm&#39;</span><span class="p">:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">badAtmosphere</span> <span class="o">==</span> <span class="s1">&#39;goodAtm&#39;</span><span class="p">:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
        <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">8</span>
<span class="c1">#        if momSNR &gt;= sigmaUsed and NpixMomBadAtm &gt;= 9:</span>
        <span class="k">if</span> <span class="n">momSNR</span> <span class="o">&gt;=</span> <span class="n">momDiffLevelBadAtm</span><span class="p">:</span> <span class="c1"># and NpixMomBadAtm &gt;= 9:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">ExtraMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaUsed</span><span class="o">*</span><span class="n">MADMomOutside</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;badAtm: Found YesMom (BadAtm) with sigma=</span><span class="si">%g</span><span class="s1"> yielding ExtraMaskLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">ExtraMaskLevel</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;badAtm: decision=No because momSNR=</span><span class="si">%f</span><span class="s1"> &lt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momSNR</span><span class="p">,</span><span class="n">momDiffLevelBadAtm</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extraMaskYesOrNo(): median=</span><span class="si">%f</span><span class="s2">, MADMomOutside=</span><span class="si">%f</span><span class="s2">, momDiffSNR=</span><span class="si">%f</span><span class="s2">, NpixMom=</span><span class="si">%.1f</span><span class="s2"> (unused here)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">MADMomOutside</span><span class="p">,</span> <span class="n">momSNR</span><span class="p">,</span> <span class="n">NpixMom</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;extraMaskYesOrNo(): momSNRCube=</span><span class="si">%f</span><span class="s2">, NpixCubeAnywhere=</span><span class="si">%.1f</span><span class="s2"> (unused here)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momSNRCube</span><span class="p">,</span> <span class="n">NpixCubeAnywhere</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
        <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>
        <span class="n">cubeSigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>
<span class="c1">#        if momSNR &gt;= sigmaUsed and NpixMom &gt;= 9:</span>
        <span class="k">if</span> <span class="n">momSNR</span> <span class="o">&gt;=</span> <span class="n">momDiffLevel</span><span class="p">:</span> <span class="c1"># and NpixMom &gt;= 9:</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">ExtraMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaUsed</span> <span class="o">*</span> <span class="n">MADMomOutside</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;YesMom: sigmaUsed = </span><span class="si">%f</span><span class="s1"> because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &gt;= momDiffLevel=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">momSNR</span><span class="p">,</span><span class="n">momDiffLevel</span><span class="p">))</span>
<span class="c1">#        elif momSNRCube &gt;= cubeSigmaUsed and NpixCubeAnywhere &gt;= 9:</span>
<span class="c1">#        elif momSNRCube &gt;= cubeLevel:  # and NpixCubeAnywhere &gt;= 9:</span>
<span class="c1">#            decision = &#39;YesCube&#39;</span>
<span class="c1">#            ExtraMaskLevel = median + cubeSigmaUsed * MADCubeOutside</span>
<span class="c1">#            sigmaUsed = cubeSigmaUsed</span>
<span class="c1">#            casalogPost(&#39;YesCube: sigmaUsed = %f&#39; % (sigmaUsed))</span>
        <span class="k">else</span><span class="p">:</span>
<span class="c1">#            casalogPost(&#39;%s.  Neither YesMom nor YesCube was triggered.&#39; % (decision))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.  YesMom was not triggered because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &lt; momDiffLevel=</span><span class="si">%f</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decision</span><span class="p">,</span><span class="n">momSNR</span><span class="p">,</span><span class="n">momDiffLevel</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">ExtraMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span></div>


<div class="viewcode-block" id="onlyExtraMaskYesOrNo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.onlyExtraMaskYesOrNo">[docs]</a>
<span class="k">def</span> <span class="nf">onlyExtraMaskYesOrNo</span><span class="p">(</span><span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffSNRCube</span><span class="p">,</span> 
                         <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> 
                         <span class="n">NpixCubeAnywhere</span><span class="p">,</span> <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> 
                         <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">cubePeak</span><span class="p">,</span> <span class="n">cubeMedian</span><span class="p">,</span>
                         <span class="n">momDiffLevel</span><span class="p">,</span> <span class="n">momDiffLevelBadAtm</span><span class="p">,</span> <span class="n">cubeLevel</span><span class="p">,</span> 
                         <span class="n">sigmaThreshold</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">npixThreshold</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">skipCubeNoise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in Pipeline2020 going forward.</span>
<span class="sd">    badAtmosphere: either a boolean or a string (&#39;goodAtm&#39; or &#39;badAtm&#39;)</span>
<span class="sd">    momDiffSNR: SNR where peak is measured over whole image (instead of outside mask), </span>
<span class="sd">                   (mom scaledMAD is in denominator)</span>
<span class="sd">    momDiffSNRCube: SNR where peak is measured over whole image (instead of outside mask), </span>
<span class="sd">                   (cube scaledMAD is in denominator)</span>
<span class="sd">    NpixCubeAnywhere: unused now</span>
<span class="sd">    momDiffLevel: for the non-badAtmosphere case, this is passed in from momDiffLevelForProceeding </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** arguments:&quot;</span><span class="p">,</span> <span class="n">badAtmosphere</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffSNRCube</span><span class="p">,</span> 
                         <span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">NpixMomDiffBadAtm</span><span class="p">,</span> <span class="n">NpixCubeAnywhere</span><span class="p">,</span> 
                         <span class="n">TenEventSigma</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">MADCubeOutside</span><span class="p">,</span> <span class="n">cubePeak</span><span class="p">,</span>
                         <span class="n">cubeMedian</span><span class="p">)</span>
    <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;No&#39;</span>
    <span class="n">onlyExtraMaskLevel</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;*******************************************&#39;</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;npixThreshold = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npixThreshold</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;*******************************************&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span> <span class="o">==</span> <span class="s1">&#39;badAtm&#39;</span><span class="p">:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">badAtmosphere</span> <span class="o">==</span> <span class="s1">&#39;goodAtm&#39;</span><span class="p">:</span>
        <span class="n">badAtmosphere</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">badAtmosphere</span><span class="p">:</span>
        <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># to set the mask level</span>
        <span class="k">if</span> <span class="n">momDiffSNR</span> <span class="o">&gt;=</span> <span class="n">momDiffLevelBadAtm</span> <span class="ow">and</span> <span class="n">NpixMomDiffBadAtm</span> <span class="o">&gt;=</span> <span class="n">npixThreshold</span> <span class="ow">and</span> <span class="p">((</span><span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">)</span><span class="o">&gt;</span><span class="n">sigmaThreshold</span><span class="o">*</span><span class="n">MADCubeOutside</span> <span class="ow">or</span> <span class="n">MADCubeOutside</span><span class="o">==</span><span class="n">DISABLE_CUBE_NOISE</span><span class="p">):</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">onlyExtraMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaUsed</span><span class="o">*</span><span class="n">momDiffMAD</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Found YesMom (BadAtm) with sigma=</span><span class="si">%g</span><span class="s1"> yielding onlyExtraMaskLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">onlyExtraMaskLevel</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No onlyExtraMask: momSNR=</span><span class="si">%f</span><span class="s1">,NpixMomBadAtm=</span><span class="si">%.1f</span><span class="s1"> &#39;</span><span class="o">%</span><span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">NpixMomDiffBadAtm</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onlyExtraMaskYesOrNo(): median=</span><span class="si">%f</span><span class="s2">, momDiffMAD=</span><span class="si">%f</span><span class="s2">, momSNRMom=</span><span class="si">%f</span><span class="s2">, NpixMom=</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">momDiffMAD</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">NpixMomDiff</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;onlyExtraMaskYesOrNo(): momSNRCube=</span><span class="si">%f</span><span class="s2">, (cubePeak=</span><span class="si">%f</span><span class="s2"> - cubeMedian=</span><span class="si">%f</span><span class="s2">) = </span><span class="si">%f</span><span class="s2">, </span><span class="si">%g</span><span class="s2">*MADCubeOutside=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNRCube</span><span class="p">,</span> <span class="n">cubePeak</span><span class="p">,</span> <span class="n">cubeMedian</span><span class="p">,</span> <span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">,</span> <span class="n">sigmaThreshold</span><span class="p">,</span> <span class="n">sigmaThreshold</span><span class="o">*</span><span class="n">MADCubeOutside</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-------------------------------------&quot;</span><span class="p">)</span>
        <span class="n">sigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>  <span class="c1"># to set the mask level (when YesMom is triggered)</span>
        <span class="n">cubeSigmaUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span><span class="n">TenEventSigma</span><span class="p">])</span>  <span class="c1"># to set the mask level (when YesCube is triggered)</span>
        <span class="k">if</span> <span class="n">momDiffSNR</span> <span class="o">&gt;=</span> <span class="n">momDiffLevel</span> <span class="ow">and</span> <span class="n">NpixMomDiff</span> <span class="o">&gt;=</span> <span class="n">npixThreshold</span> <span class="ow">and</span> <span class="p">(</span><span class="n">skipCubeNoise</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">)</span><span class="o">&gt;</span><span class="n">sigmaThreshold</span><span class="o">*</span><span class="n">MADCubeOutside</span><span class="p">):</span>
            <span class="n">decision</span> <span class="o">=</span> <span class="s1">&#39;YesMom&#39;</span>
            <span class="n">onlyExtraMaskLevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaUsed</span> <span class="o">*</span> <span class="n">momDiffMAD</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;YesMom: sigmaUsed = </span><span class="si">%f</span><span class="s1"> because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &gt;= momDiffLevel=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaUsed</span><span class="p">,</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffLevel</span><span class="p">))</span>
<span class="c1">#        elif momDiffSNRCube &gt;= cubeLevel and NpixCubeAnywhere &gt;= 9  and (cubePeak-cubeMedian)&gt;sigmaThreshold*MADCubeOutside:</span>
<span class="c1">#            decision = &#39;YesCube&#39;</span>
<span class="c1">#            onlyExtraMaskLevel = median + cubeSigmaUsed * MADCubeOutside</span>
<span class="c1">#            sigmaUsed = cubeSigmaUsed</span>
<span class="c1">#            casalogPost(&#39;YesCube: sigmaUsed = %f&#39; % (sigmaUsed))</span>
        <span class="k">else</span><span class="p">:</span>
<span class="c1">#            casalogPost(&#39;%s.  Neither YesMom nor YesCube was triggered. &#39; % (decision))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.  YesMom was not triggered. &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">decision</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">momDiffSNR</span> <span class="o">&lt;</span> <span class="n">momDiffLevel</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  because momDiffSNR=</span><span class="si">%f</span><span class="s1"> &lt; momDiffLevel=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffLevel</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">NpixMomDiff</span> <span class="o">&lt;</span> <span class="n">npixThreshold</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  because NpixMomDiff=</span><span class="si">%d</span><span class="s1"> &lt; npixThreshold=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NpixMomDiff</span><span class="p">,</span> <span class="n">npixThreshold</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">sigmaThreshold</span><span class="o">*</span><span class="n">MADCubeOutside</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  because (cubePeak-cubeMedian)=</span><span class="si">%f</span><span class="s1"> &lt;= (sigmaThreshold*MADCubeOutside)=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cubePeak</span><span class="o">-</span><span class="n">cubeMedian</span><span class="p">,</span> <span class="n">sigmaThreshold</span><span class="o">*</span><span class="n">MADCubeOutside</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">decision</span><span class="p">,</span> <span class="n">onlyExtraMaskLevel</span><span class="p">,</span> <span class="n">sigmaUsed</span></div>


<div class="viewcode-block" id="allContinuumSelected">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.allContinuumSelected">[docs]</a>
<span class="k">def</span> <span class="nf">allContinuumSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="n">ALL_CONTINUUM_CRITERION</span><span class="p">,</span> 
                         <span class="n">fraction2</span><span class="o">=</span><span class="n">ALL_CONTINUUM_CRITERION_TDM_FULLPOL</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns True if only one range is selected and that range covers sufficient</span>
<span class="sd">    bandwidth (default fraction = 92.5%)</span>
<span class="sd">    nchan: number of channels in the spectrum</span>
<span class="sd">    fraction: for nchan &gt;= 75 (default = 0.925 which is 92.5%)</span>
<span class="sd">    fraction2: for nchan &lt; 75 (default = 0.91)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">fraction2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">fraction</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c0</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># in case a single channel is selected</span>
            <span class="n">c0</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="nb">int</span><span class="p">(</span><span class="n">ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
<span class="c1">#       Require this single range to be centered:</span>
<span class="c1">#        if c0 &lt;= fraction*nchan and c1 &gt;= (1-fraction)*(nchan-1):</span>
<span class="c1">#       Range is not required to be centered:</span>
        <span class="n">myfraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1</span><span class="o">-</span><span class="n">c0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">nchan</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">myfraction</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;continuum fraction (spw</span><span class="si">%s</span><span class="s2">): </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%f</span><span class="s2"> &gt;= </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">myfraction</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;continuum fraction (spw</span><span class="si">%s</span><span class="s2">): </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">: </span><span class="si">%f</span><span class="s2"> &lt; </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">myfraction</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="byteDecode">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.byteDecode">[docs]</a>
<span class="k">def</span> <span class="nf">byteDecode</span><span class="p">(</span><span class="n">buffer</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9.9&#39;</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">buffer</span></div>


<div class="viewcode-block" id="maskArgumentMismatch">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.maskArgumentMismatch">[docs]</a>
<span class="k">def</span> <span class="nf">maskArgumentMismatch</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by checkForMismatch.</span>
<span class="sd">    Determines if the requested mask does not match what was used to generate </span>
<span class="sd">    the specified meanSpectrumFile.</span>
<span class="sd">    Returns: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    casalogPost(&#39;Entered maskArgumentMismatch()&#39;)</span>
    <span class="n">grepResult</span> <span class="o">=</span> <span class="n">byteDecode</span><span class="p">(</span><span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;mask&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">grepResult</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span> 
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Mismatch: mask was used previously, but we did not request one this time&#39;</span><span class="p">)</span>
            <span class="c1"># mask was used previously, but we did not request one this time</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># mask was not used previously and we are not requesting one this time</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No mismatch: mask was not used previously and we are not requesting one this time&#39;</span><span class="p">)</span>
            <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">grepResult</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># requested mask was not used previously</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Mismatch: requested mask was not used previously&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># requested mask was used previously.  Except if the new mask is a subset </span>
        <span class="c1"># of the old name, so check for that possibility.</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="n">mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">newtoken</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">newtoken</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byteDecode</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">newtoken</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Mismatch: mask name not in meanSpectrumFile&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if threshold was 0.00 before and we are using one now</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">useThresholdWithMask</span> <span class="ow">and</span> <span class="n">threshold</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">useThresholdWithMask</span> <span class="ow">and</span> <span class="n">threshold</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Mismatch in threshold: useThresholdWithMask=</span><span class="si">%s</span><span class="s1">, threshold=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No mismatch in threshold&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="centralArcsecArgumentMismatch">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.centralArcsecArgumentMismatch">[docs]</a>
<span class="k">def</span> <span class="nf">centralArcsecArgumentMismatch</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by checkForMismatch.</span>
<span class="sd">    Determines if the requested centralArcsec value does not match what was used to </span>
<span class="sd">    generate the specified meanSpectrumFile.</span>
<span class="sd">    Returns: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">or</span> <span class="n">centralArcsec</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=auto&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> 
            <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=-1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;request for auto but &#39;centralArcsec=auto&#39; not found and &#39;centralArcsec=-1&#39; not found&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=auto&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">result</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="c1"># This will force re-run of any result that went to a smaller size.</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=auto&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()):</span>
                        <span class="k">return</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=auto </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span>
          <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=mom0mom8jointMask True&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span>
          <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=mom0mom8jointMask False&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span>
          <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">grep</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;centralArcsec=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;centralArcsec=&#39;</span><span class="p">)</span>
        <span class="c1"># the Boolean after centralArcsec=mom0mom8jointMask is: initialQuadraticRemoved</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># This should never happen, but if it does, prevent a crash by returning now.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Did not find string &#39;centralArcsec=&#39; with a value in the meanSpectrum file.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;auto &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;              value = &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">previousRequest</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">centralArcsecThresholdPercent</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">previousRequest</span><span class="o">-</span><span class="n">centralArcsec</span><span class="p">)</span><span class="o">/</span><span class="n">centralArcsec</span> <span class="o">&lt;</span> <span class="n">centralArcsecThresholdPercent</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;request for specific value (</span><span class="si">%s</span><span class="s2">) and previous value (</span><span class="si">%s</span><span class="s2">) is within </span><span class="si">%d</span><span class="s2"> percent&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">previousRequest</span><span class="p">),</span><span class="n">centralArcsecThresholdPercent</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;request for specific value but &#39;centralArcsec=auto </span><span class="si">%s</span><span class="s2">&#39; not within </span><span class="si">%d</span><span class="s2"> percent&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="n">centralArcsecThresholdPercent</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># If there is any trouble reading the previous value, then return now.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Failed to parse floating point value: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="plotMeanSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.plotMeanSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">plotMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">plotfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">selection</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Not used by pipeline.</span>
<span class="sd">    Reads a *.findcont.residual.meanSpectrum.&lt;method&gt; file and plots it as</span>
<span class="sd">    intensity vs. channel.</span>
<span class="sd">    plotfile: set to a string to generate a png</span>
<span class="sd">    selection: channel selection string to draw in cyan horizontal lines,</span>
<span class="sd">       and its median intensity as a dotted cyan line</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find file: &quot;</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">channel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">:]:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">channel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">intensity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">intensity</span><span class="p">,</span><span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selection</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">channelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">myChannelLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
        <span class="n">cyanLevel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">channelList</span><span class="p">])</span>
        <span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span><span class="o">-</span><span class="n">cyanLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">3.</span> <span class="o">+</span> <span class="n">cyanLevel</span>
        <span class="k">for</span> <span class="n">myChannelList</span> <span class="ow">in</span> <span class="n">myChannelLists</span><span class="p">:</span>
<span class="c1">#            print(&quot;myChannelList = &quot;, myChannelList)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># add a channel to length of line</span>
                <span class="c1"># channel range has only one channel, so cyan line doesn&#39;t appear</span>
                <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span>
                <span class="n">myChannelList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>  <span class="c1"># add a channel to length of line</span>
                <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span>
                <span class="n">myChannelList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span>
            <span class="k">elif</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># this should never happen</span>
                <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span>
                <span class="n">myChannelList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">0.5</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,[</span><span class="n">level</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">),</span><span class="s1">&#39;c-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">cyanLevel</span><span class="p">],</span> <span class="s1">&#39;c:&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plotfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plotfile</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">plotfile</span> <span class="o">=</span> <span class="n">meanSpectrumFile</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote &quot;</span><span class="p">,</span> <span class="n">plotfile</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeContDat">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.writeContDat">[docs]</a>
<span class="k">def</span> <span class="nf">writeContDat</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">,</span> 
                 <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                 <span class="n">numchan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chanInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lsrkwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum.</span>
<span class="sd">    Writes out an ASCII file called &lt;meanSpectrumFile&gt;_findContinuum.dat</span>
<span class="sd">    that contains the selected channels, the png name and the aggregate </span>
<span class="sd">    bandwidth in GHz. </span>
<span class="sd">    Returns: name of file written</span>
<span class="sd">    meanSpectrumFile: only used to generate the name of the .dat file, unless</span>
<span class="sd">       firstFreq &lt;= 0, in which case the readPreviousMeanSpectrum is called on it</span>
<span class="sd">       (It splits off name before &#39;.meanSpectrum&#39; and appends _findContinuum.dat)</span>
<span class="sd">    vis: if specified, then also write a line with the topocentric velocity ranges</span>
<span class="sd">    spw: integer or string ID number; if specified (along with vis), then also write </span>
<span class="sd">         a final line with the topocentric channel ranges for this spw</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumFile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.meanSpectrumFile&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
<span class="c1">#        contDat = meanSpectrumFile.split(&#39;.meanSpectrum&#39;)[0] + &#39;_findContinuum.dat&#39;</span>
        <span class="c1"># remove meanSpectrum from the name to avoid confusion that this is not a mean spectrum file</span>
        <span class="n">contDat</span> <span class="o">=</span> <span class="n">meanSpectrumFile</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.meanSpectrumFile&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_findContinuum.dat&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">contDat</span> <span class="o">=</span> <span class="n">meanSpectrumFile</span> <span class="o">+</span> <span class="s1">&#39;_findContinuum.dat&#39;</span>
    <span class="n">contDatDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">contDat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">firstFreq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">readPreviousMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">firstFreq</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">lastFreq</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">firstFreq</span> <span class="o">&gt;</span> <span class="n">lastFreq</span> <span class="ow">and</span> <span class="n">channelWidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># restore negative channel widths if appropriate</span>
        <span class="n">channelWidth</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="c1">#    print(&quot;firstFreq=%f, channelWidth=%f&quot; % (firstFreq,channelWidth))</span>
    <span class="n">lsrkfreqs</span> <span class="o">=</span> <span class="mf">1e-9</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="o">+</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contDatDir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">contDatDir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">contDatDir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span> <span class="ow">and</span> <span class="n">contDatDir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="c1"># Tf there is no write permission, then use the directory of the png</span>
        <span class="c1"># since this has been established as writeable in runFindContinuum.</span>
        <span class="n">contDat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">png</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">contDat</span><span class="p">))</span>
<span class="c1">#    try:</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">contDat</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;writeContDat(): aggregateBandwidth = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aggregateBandwidth</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%g</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="p">))</span>
        <span class="c1"># Now write the LSRK frequency ranges on a new line</span>
        <span class="n">freqRange</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)):</span>
            <span class="n">c0</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
            <span class="n">minFreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">],</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">],</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
            <span class="n">freqRange</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">GHz~</span><span class="si">%.9f</span><span class="s1">GHz LSRK &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minFreq</span><span class="p">,</span><span class="n">maxFreq</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">freqRange</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># vis is a non-blank list or non-blank string</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="c1"># vis is now assured to be a non-blank list</span>
            <span class="n">topoFreqRanges</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># this will be a list of lists</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">getFreqType</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vis</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Converting continuum ranges from </span><span class="si">%s</span><span class="s2"> to TOPO for vis = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">frame</span><span class="p">,</span><span class="n">v</span><span class="p">))</span>
                <span class="n">vselection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)):</span>
                    <span class="n">c0</span><span class="p">,</span><span class="n">c1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
                    <span class="n">minFreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">],</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
                    <span class="n">maxFreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">],</span><span class="n">lsrkfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]])</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
                    <span class="n">freqRange</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">GHz~</span><span class="si">%.5f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minFreq</span><span class="p">,</span><span class="n">maxFreq</span><span class="p">)</span>
<span class="c1">#                    casalogPost(&quot;%2d) %s channelRange in cube = %s&quot; % (i, frame, s))</span>
<span class="c1">#                    casalogPost(&quot;    %s freqRange in cube = %s&quot; % (frame,str(freqRange)))</span>
<span class="c1">#                    casalogPost(&quot;    img=%s  spw=%s&quot; % (img, str(spw)))</span>
                    <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">fromFrame</span> <span class="o">=</span> <span class="n">cubeFrameToTopo</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">freqRange</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="n">nchan</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="n">lastFreq</span><span class="p">,</span> <span class="n">chanwidth</span><span class="o">=</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span><span class="p">,</span> <span class="n">fromFrame</span> <span class="o">=</span> <span class="n">cubeFrameToTopo</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">freqRange</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">*=</span> <span class="mf">1e-9</span> <span class="c1"># convert from Hz to GHz</span>
                    <span class="c1"># pipeline calls uvcontfit with GHz label only on upper freq</span>
                    <span class="n">freqRange</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.5f</span><span class="s1">~</span><span class="si">%.5f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">result</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;    TOPO freqRange for this vis = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqRange</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span> <span class="n">vselection</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span>
                    <span class="n">vselection</span> <span class="o">+=</span> <span class="n">freqRange</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">vselection</span><span class="p">))</span>
                <span class="n">topoFreqRanges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vselection</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spw</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
                    <span class="n">topoChanRanges</span> <span class="o">=</span> <span class="n">topoFreqRangeListToChannel</span><span class="p">(</span><span class="n">freqlist</span><span class="o">=</span><span class="n">topoFreqRanges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">topoChanRanges</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Wrote </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contDat</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">contDat</span></div>

<span class="c1">#    except:</span>
<span class="c1">#        casalogPost(&quot;Failed to write %s&quot; % (contDat))</span>

<div class="viewcode-block" id="getFieldnameFromPipelineImageName">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getFieldnameFromPipelineImageName">[docs]</a>
<span class="k">def</span> <span class="nf">getFieldnameFromPipelineImageName</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the field name from the pipeline image file name.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">fieldname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">styles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sci&#39;</span><span class="p">,</span><span class="s1">&#39;chk&#39;</span><span class="p">,</span><span class="s1">&#39;bp&#39;</span><span class="p">,</span><span class="s1">&#39;ph&#39;</span><span class="p">,</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="c1"># I am anticpating that polcal will be called pol.</span>
    <span class="k">for</span> <span class="n">style</span> <span class="ow">in</span> <span class="n">styles</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">basename</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">style</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">style</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No image found of these styles: &quot;</span><span class="p">,</span> <span class="n">styles</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fieldname</span>
    <span class="c1"># this will now be: a_Xb.s35_0.NGC300</span>
    <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_0.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fieldname</span> <span class="o">=</span> <span class="n">fieldname</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fieldname</span></div>


<span class="k">def</span> <span class="nf">getSpwFromPipelineImageName</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the spw ID from the pipeline image file name.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sourceName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sourceName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.mfs.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sourceName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.cube.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;sourcename&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.cube.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mfs.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.virtspw&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># PIPE-1105</span>
        <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.virtspw&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.spw&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sourceName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="combineContDat">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.combineContDat">[docs]</a>
<span class="k">def</span> <span class="nf">combineContDat</span><span class="p">(</span><span class="n">contdatlist</span><span class="p">,</span> <span class="n">outputfile</span><span class="o">=</span><span class="s1">&#39;cont.dat&#39;</span><span class="p">,</span> <span class="n">fieldname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list of *.dat files created by findContinuum for a single field/spw</span>
<span class="sd">    and pulls the line that contains LSRK frequency ranges from each one, and </span>
<span class="sd">    writes it to a new cont.dat file suitable for the pipeline that contains an</span>
<span class="sd">    entry for each spw of that field.  </span>
<span class="sd">    contdatlist: a list or comma-delimited string of the .dat files, or of</span>
<span class="sd">          the cube names (to which &#39;_findContinuum.dat&#39; will be appended)</span>
<span class="sd">    fieldname: use this value if specified, otherwise parse from filename</span>
<span class="sd">    spw: integer or string integer, use this value if specified, otherwise parse</span>
<span class="sd">         from the filename</span>
<span class="sd">    Note: It assumes that none of the files originate from an ALLcont spw, so it will</span>
<span class="sd">    never write the &quot;ALL&quot; line that the pipeline triggers on.  But this feature could be</span>
<span class="sd">    added by calling the following function if there is only one range of channels read:</span>
<span class="sd">       allContinuumSelected(selection, nchan, fraction=ALL_CONTINUUM_CRITERION)</span>
<span class="sd">    We would only need to know nchan.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">contdatlist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">contdatlist</span> <span class="o">=</span> <span class="n">contdatlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">contdat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contdatlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">contdat</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">contdat</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">contdat</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.dat&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">contdatlist</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">contdat</span> <span class="o">+</span> <span class="s1">&#39;_findContinuum.dat&#39;</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">contdat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contdatlist</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">contdat</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find file: &quot;</span><span class="p">,</span> <span class="n">contdat</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">o</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">previousFieldname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">contdat</span> <span class="ow">in</span> <span class="n">contdatlist</span><span class="p">:</span>
        <span class="n">cube</span> <span class="o">=</span> <span class="n">contdat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_findContinuum.dat&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">fieldname</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">fieldname</span> <span class="o">=</span> <span class="n">getFieldnameFromPipelineImageName</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">getSpwFromPipelineImageName</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">contdat</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fieldname</span> <span class="o">!=</span> <span class="n">previousFieldname</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Field: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fieldname</span><span class="p">))</span>
        <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SpectralWindow: </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">myrange</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">myrange</span> <span class="o">=</span> <span class="n">myrange</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myrange</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># could be a line with only a few blanks</span>
                <span class="k">if</span> <span class="n">myrange</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;GHz&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># remove GHz from the first frequency (if it is present on both)</span>
                    <span class="n">myrange</span> <span class="o">=</span> <span class="n">myrange</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;GHz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> LSRK</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myrange</span><span class="p">))</span>
        <span class="n">o</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">o</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">previousFieldname</span> <span class="o">=</span> <span class="n">fieldname</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">o</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="drawYlabel">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.drawYlabel">[docs]</a>
<span class="k">def</span> <span class="nf">drawYlabel</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">typeOfMeanSpectrum</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span>
               <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Draws a descriptive y-axis label based on the origin and type of mean spectrum used.</span>
<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean spectrum passed in as ASCII file&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;(Average spectrum &gt; threshold=(</span><span class="si">%g</span><span class="s1">))/MAD&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">meanSpectrumThreshold</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverRms&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;(Average spectrum &gt; threshold=(</span><span class="si">%g</span><span class="s1">))/RMS&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">meanSpectrumThreshold</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">useThresholdWithMask</span> <span class="ow">or</span> <span class="n">mask</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Average spectrum &gt; threshold=(</span><span class="si">%g</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">meanSpectrumThreshold</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Average spectrum within mask&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOverMad&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">peakFilterFWHM</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Per-channel (Peak / MAD) of image smoothed by FWHM=</span><span class="si">%d</span><span class="s1"> pixels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFilterFWHM</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Per-channel (Peak / MAD)&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOverRms&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">peakFilterFWHM</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Per-channel (Peak / RMS) of image smoothed by FWHM=</span><span class="si">%d</span><span class="s1"> pixels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFilterFWHM</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Per-channel (Peak / RMS)&#39;</span>
        <span class="k">elif</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Mean profile from mom0+8 joint mask&#39;</span>
            <span class="k">if</span> <span class="n">normalized</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (normalized by MAD)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s1">&#39; (not normalized by MAD)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;Unknown method&#39;</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">typeOfMeanSpectrum</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">label</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span></div>


<div class="viewcode-block" id="computeBandwidth">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeBandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum and findContinuum.</span>
<span class="sd">    selection: a string of format:  &#39;5~6;9~20&#39;</span>
<span class="sd">    channelWidth: in Hz</span>
<span class="sd">    Returns: bandwidth in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">channels</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">aggregateBW</span> <span class="o">=</span> <span class="n">channels</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-9</span>
    <span class="k">return</span><span class="p">(</span><span class="n">aggregateBW</span><span class="p">)</span></div>


<div class="viewcode-block" id="buildMeanSpectrumFilename">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.buildMeanSpectrumFilename">[docs]</a>
<span class="k">def</span> <span class="nf">buildMeanSpectrumFilename</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> 
                              <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum and runFindContinuum.</span>
<span class="sd">    Creates the name of the meanSpectrumFile to search for and/or create.</span>
<span class="sd">    Returns: a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peak&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">myname</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrum.&#39;</span><span class="o">+</span><span class="n">meanSpectrumMethod</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">peakFilterFWHM</span><span class="o">+</span><span class="n">amendMaskIterationName</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">):</span>
            <span class="n">myname</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrum&#39;</span><span class="o">+</span><span class="n">amendMaskIterationName</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">myname</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrum.&#39;</span><span class="o">+</span><span class="n">meanSpectrumMethod</span><span class="o">+</span><span class="n">amendMaskIterationName</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span> <span class="ow">and</span> <span class="n">nbin</span> <span class="o">&gt;=</span> <span class="n">NBIN_THRESHOLD</span><span class="p">:</span>
        <span class="n">myname</span> <span class="o">+=</span> <span class="s1">&#39;.nbin</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Built meanSpectrumFile name = &quot;</span><span class="p">,</span> <span class="n">myname</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">myname</span><span class="p">)</span></div>


<div class="viewcode-block" id="tdmSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.tdmSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum and findContinuum.</span>
<span class="sd">    Use 15e6 instead of 15.625e6 because LSRK channel width can be slightly narrower than TOPO.</span>
<span class="sd">    Works for single, dual, or full-polarization.</span>
<span class="sd">    channelWidth: in Hz</span>
<span class="sd">    Returns: True or False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">telescope</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># PIPE-1433 requests chanwidth &gt;= 1MHz and BW&gt;=64 MHz</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">channelWidth</span> <span class="o">&gt;=</span> <span class="mf">0.97e6</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="n">nchan</span> <span class="o">&gt;=</span> <span class="mf">62e6</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Treating VLA spw as TDM&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">channelWidth</span> <span class="o">&gt;=</span> <span class="mf">15e6</span><span class="o">/</span><span class="mf">2.</span> <span class="ow">and</span> <span class="n">nchan</span><span class="o">&gt;</span><span class="mi">240</span><span class="p">)</span> <span class="ow">or</span> <span class="c1"># 1 pol TDM, must avoid 240-chan FDM</span>
             <span class="p">(</span><span class="n">channelWidth</span> <span class="o">&gt;=</span> <span class="mf">15e6</span><span class="p">)):</span>
    <span class="c1">#        (channelWidth &gt;= 15e6 and nchan&lt;96) or     # 2 pol TDM (128 chan)</span>
    <span class="c1">#        (channelWidth &gt;= 30e6 and nchan&lt;96)):      # 4 pol TDM (64 chan)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="atmosphereVariation">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.atmosphereVariation">[docs]</a>
<span class="k">def</span> <span class="nf">atmosphereVariation</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">removeSlope</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum.</span>
<span class="sd">    Computes the absolute and percentage variation in atmospheric transmission </span>
<span class="sd">    and sky temperature across an image cube.</span>
<span class="sd">    Returns 5 values: max(Trans)-min(Trans), and as percentage of mean,</span>
<span class="sd">                      Max(Tsky)-min(Tsky), and as percentage of mean, </span>
<span class="sd">                      standard devation of Tsky</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freqs</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">CalcAtmTransmissionForImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="n">pwv</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;transmission&#39;</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">removeSlope</span><span class="p">:</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computed atmospheric variation and determined slope: </span><span class="si">%f</span><span class="s2"> per GHz (</span><span class="si">%.0f</span><span class="s2">,</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="p">(</span><span class="n">freqs</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">maxMinusMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">percentage</span> <span class="o">=</span> <span class="n">maxMinusMin</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">freqs</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="n">CalcAtmTransmissionForImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="n">pwv</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;tsky&#39;</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">removeSlope</span><span class="p">:</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">values</span><span class="o">*</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">values</span> <span class="o">-</span> <span class="p">(</span><span class="n">freqs</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">TmaxMinusMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">values</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">Tpercentage</span> <span class="o">=</span> <span class="n">TmaxMinusMin</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">stdValues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">maxMinusMin</span><span class="p">,</span> <span class="n">percentage</span><span class="p">,</span> <span class="n">TmaxMinusMin</span><span class="p">,</span> <span class="n">Tpercentage</span><span class="p">,</span> <span class="n">stdValues</span><span class="p">)</span></div>


<div class="viewcode-block" id="versionStringToArray">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.versionStringToArray">[docs]</a>
<span class="k">def</span> <span class="nf">versionStringToArray</span><span class="p">(</span><span class="n">versionString</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by casaVersionCompare.</span>
<span class="sd">    Converts &#39;5.3.0-22&#39; to np.array([5,3,0,22], dtype=np.int32)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">versionString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">+=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">version</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="casaVersionCompare">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.casaVersionCompare">[docs]</a>
<span class="k">def</span> <span class="nf">casaVersionCompare</span><span class="p">(</span><span class="n">comparitor</span><span class="p">,</span> <span class="n">versionString</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrum.</span>
<span class="sd">    Uses cu.compare_version in CASA5, uses string comparison in CASA4 and 6.</span>
<span class="sd">    (but is not used by meanSpectrumMethod=&#39;mom0mom8jointMask&#39; which is </span>
<span class="sd">     the Pipeline default)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">casaMajorVersion</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span> <span class="o">&gt;=</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span> <span class="o">&gt;</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span> <span class="o">&lt;</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casadef</span><span class="o">.</span><span class="n">casa_version</span> <span class="o">&lt;=</span> <span class="n">versionString</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown comparitor: &quot;</span><span class="p">,</span> <span class="n">comparitor</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">casaMajorVersion</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">versionStringToArray</span><span class="p">(</span><span class="n">versionString</span><span class="p">)</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="n">cu</span><span class="o">.</span><span class="n">compare_version</span><span class="p">(</span><span class="n">comparitor</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># casa 6</span>
        <span class="k">if</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casaVersion</span> <span class="o">&gt;</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="n">versionString</span>
        <span class="k">elif</span> <span class="n">comparitor</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
            <span class="n">comparison</span> <span class="o">=</span> <span class="n">casaVersion</span> <span class="o">&lt;=</span> <span class="n">versionString</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown comparitor: &quot;</span><span class="p">,</span> <span class="n">comparitor</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">comparison</span></div>


<div class="viewcode-block" id="getFreqType">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getFreqType">[docs]</a>
<span class="k">def</span> <span class="nf">getFreqType</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum and cubeFrameToTopo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">mytype</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">referencecode</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mytype</span></div>


<div class="viewcode-block" id="getEquinox">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getEquinox">[docs]</a>
<span class="k">def</span> <span class="nf">getEquinox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by cubeFrameToTopo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">myia</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">equinox</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">referencecode</span><span class="p">(</span><span class="s1">&#39;direction&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span> <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">equinox</span></div>


<div class="viewcode-block" id="getTelescope">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getTelescope">[docs]</a>
<span class="k">def</span> <span class="nf">getTelescope</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by CalcAtmTransmissionForImage and cubeFrameToTopo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">myia</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">telescope</span><span class="p">()</span>
<span class="c1">#    telescope = myia.miscinfo()[&#39;TELESCOP&#39;]  # not in images produced in 4.2.2</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span> <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">telescope</span></div>


<div class="viewcode-block" id="getDateObs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getDateObs">[docs]</a>
<span class="k">def</span> <span class="nf">getDateObs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by cubeFrameToTopo.</span>
<span class="sd">    Returns string of format: &#39;2014/05/22/08:47:05&#39; suitable for lsrkToTopo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">myia</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">epoch</span><span class="p">()[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span> <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">mydate</span> <span class="o">=</span> <span class="n">mjdToUT</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39; UT&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mydate</span></div>


<div class="viewcode-block" id="removeInitialQuadraticIfNeeded">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.removeInitialQuadraticIfNeeded">[docs]</a>
<span class="k">def</span> <span class="nf">removeInitialQuadraticIfNeeded</span><span class="p">(</span><span class="n">avgSpectrum</span><span class="p">,</span> <span class="n">initialQuadraticImprovementThreshold</span><span class="o">=</span><span class="mf">1.6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum when meanSpectrumMethod=&#39;mom0mom8jointMask&#39;.</span>
<span class="sd">    Fits a quadratic to the specified spectrum, and removes it if the</span>
<span class="sd">    MAD will improve by more than a factor of threshold</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrum</span><span class="p">)))</span>
    <span class="n">priorMad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrum</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;preMad: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorMad</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fitResult</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">avgSpectrum</span><span class="p">,</span> <span class="n">priorMad</span><span class="p">)</span>
    <span class="n">order2</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">fitResult</span>
    <span class="n">myx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrum</span><span class="p">))</span> <span class="o">-</span> <span class="n">xoffset</span>
    <span class="n">trialSpectrum</span> <span class="o">=</span> <span class="n">avgSpectrum</span> <span class="o">+</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">avgSpectrum</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">myx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">order2</span> <span class="o">+</span> <span class="n">myx</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
    <span class="n">postMad</span> <span class="o">=</span>  <span class="n">MAD</span><span class="p">(</span><span class="n">trialSpectrum</span><span class="p">)</span>
<span class="c1">#    print(&quot;postMad=%e, trialSpectrum has %d non-zero values: &quot; % (postMad,len(np.where(trialSpectrum != 0.0))), trialSpectrum)</span>
    <span class="k">if</span> <span class="n">postMad</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">improvementRatio</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="n">avgSpectrum</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">improvementRatio</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;preMad: </span><span class="si">%f</span><span class="s2">, postMad: </span><span class="si">%f</span><span class="s2">, factorReduction: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorMad</span><span class="p">,</span><span class="n">postMad</span><span class="p">,</span><span class="n">priorMad</span><span class="o">/</span><span class="n">postMad</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">improvementRatio</span> <span class="o">=</span> <span class="n">priorMad</span><span class="o">/</span><span class="n">postMad</span>
    <span class="k">if</span> <span class="n">improvementRatio</span> <span class="o">&gt;</span> <span class="n">initialQuadraticImprovementThreshold</span><span class="p">:</span>
        <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">avgSpectrum</span> <span class="o">=</span> <span class="n">trialSpectrum</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Initial quadratic removed because improvement ratio: </span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">improvementRatio</span><span class="p">,</span><span class="n">initialQuadraticImprovementThreshold</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Initial quadratic not removed because improvement ratio: </span><span class="si">%f</span><span class="s2"> &lt;= </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">improvementRatio</span><span class="p">,</span><span class="n">initialQuadraticImprovementThreshold</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">avgSpectrum</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">improvementRatio</span></div>


<div class="viewcode-block" id="checkForMismatch">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.checkForMismatch">[docs]</a>
<span class="k">def</span> <span class="nf">checkForMismatch</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">,</span> 
                     <span class="n">fitsTable</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Returns True if there is a mismatch between the pre-existing </span>
<span class="sd">    meanSpectrumFile and the requested parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">maskArgumentMismatch</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regenerating the meanSpectrum since there is a mismatch in the mask or useThresholdWithMask parameters. (fitsTable=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fitsTable</span><span class="p">))</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No mismatch in the mask argument vs. the meanSpectrum file.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsecArgumentMismatch</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regenerating the meanSpectrum since there is a mismatch in the centralArcsec argument (</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">)))</span>
            <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No mismatch in the centralArcsec argument vs. the meanSpectrum file. Setting overwrite=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">overwrite</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Did not find mean spectrum file = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">overwrite</span></div>


<div class="viewcode-block" id="pick_sFC_TDM">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pick_sFC_TDM">[docs]</a>
<span class="k">def</span> <span class="nf">pick_sFC_TDM</span><span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Chooses the value of sigmaFindContinuum for TDM datasets based on</span>
<span class="sd">    the meanSpectrumMethod and whether the user requested single continuum in</span>
<span class="sd">    the Observing Tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">singleContinuum</span><span class="p">:</span>
        <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="mf">9.0</span> 
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="mf">4.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOverMAD&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="mf">6.5</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">):</span>
        <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="mf">7.2</span> <span class="c1"># 2018-03-23 was 4.5, 2018-03-26 was 5.5, 2018-03-27 was 6.5, 2018-03-31 was 7.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="mf">4.5</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Unknown meanSpectrumMethod: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">sFC_TDM</span></div>


<div class="viewcode-block" id="setYLimitsAvoidingEdgeChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.setYLimitsAvoidingEdgeChannels">[docs]</a>
<span class="k">def</span> <span class="nf">setYLimitsAvoidingEdgeChannels</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">chan</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by runFindContinuum to set the y-axis limits..</span>
<span class="sd">    1) Avoid spikes in edge channels from skewing the plot limits, by </span>
<span class="sd">       setting plot limits on the basis of channels chan..-chan</span>
<span class="sd">    2) Enforce a maximum dynamic range (peak-median)/mad so that weak features</span>
<span class="sd">       can be seen, allowing strongest ones to overflow the top.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y0</span><span class="p">,</span><span class="n">y1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
    <span class="n">y0naturalBuffer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span> <span class="o">-</span> <span class="n">y0</span>
    <span class="n">y1naturalBuffer</span> <span class="o">=</span> <span class="n">y1</span>  <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span>
    <span class="n">mymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">chan</span><span class="p">:</span><span class="o">-</span><span class="n">chan</span><span class="p">])</span> <span class="o">-</span> <span class="n">y0naturalBuffer</span>
    <span class="n">mymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">chan</span><span class="p">:</span><span class="o">-</span><span class="n">chan</span><span class="p">])</span> <span class="o">+</span> <span class="n">y1naturalBuffer</span>
    <span class="n">mymedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span>
    <span class="n">highDynamicRange</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">dynamicRange</span> <span class="o">=</span> <span class="p">(</span><span class="n">mymax</span><span class="o">-</span><span class="n">mymedian</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span>
    <span class="k">if</span> <span class="n">dynamicRange</span> <span class="o">&gt;</span> <span class="n">DYNAMIC_RANGE_LIMIT_PLOT</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Spectral dynamic range exceeds </span><span class="si">%d</span><span class="s1">, limiting maximum y-axis value&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DYNAMIC_RANGE_LIMIT_PLOT</span><span class="p">))</span>
        <span class="n">mymax</span> <span class="o">=</span> <span class="n">DYNAMIC_RANGE_LIMIT_PLOT</span><span class="o">*</span><span class="n">mad</span> <span class="o">+</span> <span class="n">mymedian</span> 
        <span class="n">highDynamicRange</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">mymin</span><span class="p">,</span> <span class="n">mymax</span><span class="p">])</span> 
    <span class="k">return</span> <span class="n">highDynamicRange</span></div>


<div class="viewcode-block" id="ExpandYLimitsForLegend">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.ExpandYLimitsForLegend">[docs]</a>
<span class="k">def</span> <span class="nf">ExpandYLimitsForLegend</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called by runFindContinuum.</span>
<span class="sd">    Make room for legend text at bottom and top of existing plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">yrange</span><span class="o">*</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">yrange</span><span class="o">*</span><span class="mf">0.2</span><span class="p">]</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span></div>


<div class="viewcode-block" id="pickRandomErrors">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickRandomErrors">[docs]</a>
<span class="k">def</span> <span class="nf">pickRandomErrors</span><span class="p">(</span><span class="n">nvalues</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Picks a series of random values from a Gaussian distribution with mean 0 and standard </span>
<span class="sd">    deviation = 1 and returns it as an array.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvalues</span><span class="p">):</span>
        <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pickRandomError</span><span class="p">())</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p</span><span class="p">))</span></div>


<div class="viewcode-block" id="pickRandomError">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickRandomError">[docs]</a>
<span class="k">def</span> <span class="nf">pickRandomError</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Picks a random value from a Gaussian distribution with mean 0 and standard deviation = 1.</span>
<span class="sd">    seed: if specified, then first reseed with random.seed(seed)</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="k">while</span> <span class="p">(</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mf">1.0</span> <span class="p">):</span>
      <span class="n">x1</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span>
      <span class="n">x2</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">-</span> <span class="mf">1.0</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">x2</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span> <span class="n">w</span> <span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">w</span> <span class="p">)</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">x1</span> <span class="o">*</span> <span class="n">w</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">*</span> <span class="n">w</span>
    <span class="k">return</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span></div>


<div class="viewcode-block" id="createNoisyQuadratic">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.createNoisyQuadratic">[docs]</a>
<span class="k">def</span> <span class="nf">createNoisyQuadratic</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function meant simply to test removeStatContQuadratic.</span>
<span class="sd">    n: number of points in synthetic noise spectrum</span>
<span class="sd">    nsigma: passed to removeStatContQuadratic</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pickRandomErrors</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">+=</span> <span class="mf">0.001</span><span class="o">*</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span> 
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">y1</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">yfit</span> <span class="o">=</span> <span class="n">removeStatContQuadratic</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">returnExtra</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="removeStatContQuadratic">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.removeStatContQuadratic">[docs]</a>
<span class="k">def</span> <span class="nf">removeStatContQuadratic</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">returnExtra</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">minPercentage</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">makeMovie</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">keepContinuum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Iteratively removes outlier points down to nsigma, then fits a quadratic to the remaining </span>
<span class="sd">    points, removes this quadratic from the full initial spectrum, and returns it, along</span>
<span class="sd">    with the list of channels used for the fit and the fit evaluated at all channels.</span>
<span class="sd">    minPercentage: stop removing outliers if number of remaining goes below this threshold</span>
<span class="sd">    makeMovie: if True, then make a png for each quadratic fit as channels are removed one-by-one</span>
<span class="sd">    img: only used to name the movie frame pngs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># start with all points</span>
    <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">makeMovie</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> 
            <span class="n">img</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -f &#39;</span> <span class="o">+</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">yfit</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">nsigma</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diff</span><span class="p">):</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
<span class="c1">#        print(&quot;Removing channel %d&quot; % (peak))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="p">[</span><span class="n">peak</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minPercentage</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c1"># fit only the remaining points             </span>
        <span class="n">fitResult</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
        <span class="n">order2</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">fitResult</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">xoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">order2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">xoffset</span><span class="p">)</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span>   
        <span class="n">diff0</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">yfit</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">diff0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff0</span><span class="p">)</span>
        <span class="n">diffWithoutFit</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yfit</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yfit</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">yfit</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">yfit</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">peakOverMAD</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">peakOverMAD</span>
        <span class="k">if</span> <span class="n">ratio</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span> <span class="c1"># 3*(np.max(yfit) - np.min(yfit)) &lt; np.max(y[idx]) - np.min(y[idx]):</span>
            <span class="c1"># strong lines are still present, so revert to using the median</span>
            <span class="n">fitUsed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">diffWithoutFit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fitUsed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">makeMovie</span><span class="p">:</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">yfit</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="s1">&#39;b-&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> points (ratio=</span><span class="si">%.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">ratio</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ylim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">)],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fitUsed</span><span class="p">:</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;quadratic and median removed&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;median removed&#39;</span><span class="p">)</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;fit</span><span class="si">%04d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">))</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Too few points (</span><span class="si">%d</span><span class="s1">) to fit a quadratic&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeroes</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># remove the fit from all points</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xoffset</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">order2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xoffset</span><span class="p">)</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span>   
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">yfit</span>
        <span class="k">if</span> <span class="n">keepContinuum</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">yfit</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">returnExtra</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">yfit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="runFindContinuum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.runFindContinuum">[docs]</a>
<span class="k">def</span> <span class="nf">runFindContinuum</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psfcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                     <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">transition</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">baselineModeA</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span>
                     <span class="n">sigmaCube</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="o">=</span><span class="mf">0.19</span><span class="p">,</span> 
                     <span class="n">sigmaFindContinuum</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">png</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pngBasename</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">nanBufferChannels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                     <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                     <span class="n">percentile</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">narrow</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                     <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">titleText</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">meanSpectrumFile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">channelWidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">alternateDirectory</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="p">[],</span> <span class="n">chanInfo</span><span class="o">=</span><span class="p">[],</span> 
                     <span class="n">plotAtmosphere</span><span class="o">=</span><span class="s1">&#39;transmission&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">channelFractionForSlopeRemoval</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="o">=</span><span class="s1">&#39;peakOverMad&#39;</span><span class="p">,</span> 
                     <span class="n">peakFilterFWHM</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fullLegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">meanSpectrumMethodMessage</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">minSlopeToRemove</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span>
                     <span class="n">minGroupsForSFCAdjustment</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                     <span class="n">regressionTest</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">quadraticFit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">megapixels</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">triangularPatternSeen</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxMemory</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                     <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">byteLimit</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                     <span class="n">singleContinuum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">applyMaskToMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">plotBaselinePoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                     <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> 
                     <span class="n">projectCode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                     <span class="n">useThresholdWithMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpiDefault</span><span class="p">,</span> 
                     <span class="n">normalizeByMAD</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">initialQuadraticImprovementThreshold</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span>
                     <span class="n">minPeakOverMadForSFCAdjustment</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> 
                     <span class="n">maxMadRatioForSFCAdjustment</span><span class="o">=</span><span class="mf">1.20</span><span class="p">,</span>
                     <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span><span class="o">=</span><span class="mf">1.20</span><span class="p">,</span>
                     <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">signalRatioTier1</span><span class="o">=</span><span class="mf">0.965</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> 
                     <span class="n">snrThreshold</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">MOM0MINSNR_DEFAULT</span><span class="p">,</span> 
                     <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">MOM8MINSNR_DEFAULT</span><span class="p">,</span> 
                     <span class="n">overwriteMasks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                     <span class="n">quadraticNsigma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">plotQuadraticPoints</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makeMovie</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">allowBluePruning</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">avoidance</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                     <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">amendMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">skipchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                     <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">useJointMaskPrior</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span>
                     <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">momDiffSNR</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">peakOverMadCriterion</span><span class="o">=</span><span class="mi">85</span><span class="p">,</span>
                     <span class="n">maxGroups</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="c1"># was 25 in PL2021 # was 40 earlier</span>
                     <span class="n">momDiffApproachLevel</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">mom08simultaneous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                     <span class="n">returnBluePoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                     <span class="n">spectralDynamicRangeString</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum.  It calls functions that:</span>
<span class="sd">    1) compute the mean spectrum of a dirty cube</span>
<span class="sd">    2) find the continuum channels </span>
<span class="sd">    3) plot the results</span>
<span class="sd">    Inputs: channelWidth: in Hz</span>
<span class="sd">    Returns: 23 items</span>
<span class="sd">    *1 A channel selection string suitable for the spw parameter of clean.</span>
<span class="sd">    *2 The name of the png produced.</span>
<span class="sd">    *3 The slope of the linear fit (or None if no fit attempted).</span>
<span class="sd">    *4 The channel width in Hz (only necessary for the fitsTable option).</span>
<span class="sd">    *5 nchan in the cube (only necessary to return this for the fitsTable option, will be computed otherwise).</span>
<span class="sd">    *6 Boolean: True if it used low values as the baseline (as opposed to high values)</span>
<span class="sd">    *7 SNRs in the moment0 image (raw, outside mask, outside phase2 mask)</span>
<span class="sd">    *8 SNRs in the moment8 image (raw, outside mask, outside phase2 mask)</span>
<span class="sd">    *9 Boolean: True if the middle-valued channels were used as the baseline (as opposed to low or high)</span>
<span class="sd">    *10 list: selectionPreBluePruning</span>
<span class="sd">    *11 float: finalSigmaFindContinuum</span>
<span class="sd">    *12 string: name of jointMask</span>
<span class="sd">    *13 float array: avgspectrumAboveThreshold</span>
<span class="sd">    *14 float: the true median of the spectrum</span>
<span class="sd">    *15 list: of plot artist descriptors (things to potentially remove and replot)</span>
<span class="sd">    *16 axis instance: ax1 (lower x-axis)</span>
<span class="sd">    *17 axis instance: ax2 (upper x-axis)</span>
<span class="sd">    *18 float: threshold (the positive threshold for line detection)</span>
<span class="sd">    *19 string: final line of upper text legend</span>
<span class="sd">    *20 int: number of narrow central groups that were dropped (or would have been dropped</span>
<span class="sd">           if enableRejectNarrowWindows had been True, but wasn&#39;t), summed over all runs</span>
<span class="sd">           of findContinuumChannels() </span>
<span class="sd">    *21 float: effectiveSigma (product of finalSigmaFindContinuum*correctionFactor)</span>
<span class="sd">    *22 float: baselineMAD</span>
<span class="sd">    *23 string: upper x-axis label</span>
<span class="sd">    *24 list of int: allBaselineChannelsXY (channel numbers of baseline)</span>
<span class="sd">    *25 int: nbin</span>
<span class="sd">    *26 float: initialPeakOverMad</span>
<span class="sd">    *27 float or None: negativeThreshold</span>
<span class="sd">    Inputs:</span>
<span class="sd">    img: the image cube to operate upon</span>
<span class="sd">    spw: the spw name or number to put in the x-axis label</span>
<span class="sd">    transition: the name of the spectral transition (for the plot title)</span>
<span class="sd">    baselineModeA: &#39;min&#39; or &#39;edge&#39;, method to define the baseline in meanSpectrum()</span>
<span class="sd">    sigmaCube: multiply this value by the MAD to get the threshold above which a pixel</span>
<span class="sd">               is included in the mean spectrum</span>
<span class="sd">    nBaselineChannels: if integer, then the number of channels to use in:</span>
<span class="sd">      a) computing the mean spectrum with the &#39;meanAboveThreshold&#39; methods.</span>
<span class="sd">      b) computing the MAD of the lowest/highest channels in findContinuumChannels</span>
<span class="sd">          if float, then the fraction of channels to use (i.e. the percentile)</span>
<span class="sd">          default = 0.19, which is 24 channels (i.e. 12 on each side) of a TDM window</span>
<span class="sd">    sigmaFindContinuum: passed to findContinuumChannels, &#39;auto&#39; starts with 3.5</span>
<span class="sd">    sigmaFindContinuumMode: &#39;auto&#39;, &#39;autolower&#39;, or &#39;fixed&#39;</span>
<span class="sd">    verbose: if True, then print additional information during processing</span>
<span class="sd">    png: the name of the png to produce (&#39;&#39; yields default name)</span>
<span class="sd">    pngBasename: if True, then remove the directory from img name before generating png name</span>
<span class="sd">    nanBufferChannels: when removing or replacing NaNs, do this many extra channels</span>
<span class="sd">                       beyond their extent</span>
<span class="sd">    source: the name of the source, to be shown in the title of the spectrum.</span>
<span class="sd">            if None, then use the filename, up to the first underscore.</span>
<span class="sd">    findContinuum: if True, then find the continuum channels before plotting</span>
<span class="sd">    overwrite: if True, or ASCII file does not exist, then recalculate the mean spectrum</span>
<span class="sd">                      writing it to &lt;img&gt;.meanSpectrum</span>
<span class="sd">               if False, then read the mean spectrum from the existing ASCII file</span>
<span class="sd">    trimChannels: after doing best job of finding continuum, remove this many </span>
<span class="sd">         channels from each edge of each block of channels found (for margin of safety)</span>
<span class="sd">         If it is a float between 0..1, then trim this fraction of channels in each </span>
<span class="sd">         group (rounding up). If it is &#39;auto&#39;, use 0.1 but not more than maxTrim channels</span>
<span class="sd">         and not more than maxTrimFraction</span>
<span class="sd">    percentile: control parameter used with baselineMode=&#39;min&#39;</span>
<span class="sd">    continuumThreshold: if specified, only use pixels above this intensity level</span>
<span class="sd">    narrow: the minimum number of channels that a group of channels must have to survive</span>
<span class="sd">            if 0&lt;narrow&lt;1, then it is interpreted as the fraction of all</span>
<span class="sd">                           channels within identified blocks</span>
<span class="sd">            if &#39;auto&#39;, then use int(ceil(log10(nchan)))</span>
<span class="sd">    titleText: default is img name and transition and the control parameter values</span>
<span class="sd">    meanSpectrumFile: an alternative ASCII text file to use for the mean spectrum.</span>
<span class="sd">                      Must also set img=&#39;&#39;.</span>
<span class="sd">    meanSpectrumMethod: &#39;peakOverMad&#39;, &#39;peakOverRms&#39;, &#39;meanAboveThreshold&#39;, </span>
<span class="sd">       &#39;meanAboveThresholdOverRms&#39;, &#39;meanAboveThresholdOverMad&#39;, </span>
<span class="sd">        where &#39;peak&#39; refers to the peak in a spatially-smoothed version of cube</span>
<span class="sd">    peakFilterFWHM: value used by &#39;peakOverRms&#39; and &#39;peakOverMad&#39; to presmooth </span>
<span class="sd">        each plane with a Gaussian kernel of this width (in pixels)</span>
<span class="sd">        Set to 1 to not do any smoothing.</span>
<span class="sd">    centralArcsec: radius of central box within which to compute the mean spectrum</span>
<span class="sd">        default=&#39;auto&#39; means start with whole field, then reduce to 1/10 if only</span>
<span class="sd">        one window is found (unless mask is specified); or &#39;fwhm&#39; for the central square</span>
<span class="sd">        with the same radius as the PB FWHM; or a floating point value in arcseconds</span>
<span class="sd">    mask: a mask image equal in shape to the parent image that is used to determine the</span>
<span class="sd">        region to compute the noise (outside the mask) and the mean spectrum (inside the mask)</span>
<span class="sd">        option &#39;auto&#39; will look for the &lt;filename&gt;.mask that matches the &lt;filename&gt;.image</span>
<span class="sd">        and if it finds it, it will use it; otherwise it will use no mask</span>
<span class="sd">    plotAtmosphere: &#39;&#39;, &#39;tsky&#39;, or &#39;transmission&#39;</span>
<span class="sd">    airmass: for plot of atmospheric transmission</span>
<span class="sd">    pwv: in mm (for plot of atmospheric transmission)</span>
<span class="sd">    channelFractionForSlopeRemoval: if at least this many channels are initially selected, or </span>
<span class="sd">       if there are only 1-2 ranges found and the widest range has &gt; nchan*0.3 channels, then </span>
<span class="sd">       fit and remove a linear slope and re-identify continuum channels.  Set to 1 to turn off.</span>
<span class="sd">    quadraticFit: if True, fit quadratic polynomial to the noise regions when appropriate; </span>
<span class="sd">         otherwise fit only a linear slope</span>
<span class="sd">    megapixels: simply used to label the plot</span>
<span class="sd">    triangularPatternSeen: if True, then slightly boost sigmaFindContinuum if it is in &#39;auto&#39; mode</span>
<span class="sd">    maxMemory: only used to name the png if it is set</span>
<span class="sd">    applyMaskToMask: if True, apply the mask inside the user mask image to set its masked pixels to 0</span>
<span class="sd">    plotBaselinePoints: if True, then plot the baseline-defining points as black dots</span>
<span class="sd">    dropBaselineChannels: percentage of extreme values to drop in baseline mode &#39;min&#39;</span>
<span class="sd">    useIAGetProfile: if True, then for meanAboveThreshold and baselineMode=&#39;min&#39;, then</span>
<span class="sd">        use ia.getprofile instead of ia.getregion and subsequent arithmetic (faster)</span>
<span class="sd">    initialQuadraticImprovementThreshold: if removal of a quadratic from the raw meanSpectrum reduces</span>
<span class="sd">        the MAD by this factor or more, then proceed with removing this quadratic (new Cycle 6 heuristic)</span>
<span class="sd">    maxMadRatioForSFCAdjustment: madRatio must be below this value (among other things) in order</span>
<span class="sd">           for automatic lowering of sigmaFindContinuum value to occur in .original iteration</span>
<span class="sd">    maxMadRatioForSFCAdjustmentInLaterIterations: madRatio must be below this value (among other things) in order</span>
<span class="sd">           for automatic lowering of sigmaFindContinuum value to occur in later iterations</span>
<span class="sd">    avoidance: a CASA channel selection string to avoid selecting for continuum (for </span>
<span class="sd">         manual use); invoked just before making the plot and returning</span>

<span class="sd">    Parameters only relevant to mom0mom8jointMask:</span>
<span class="sd">    mom0minsnr: sets the threshold for the mom0 image (i.e. median + mom0minsnr*scaledMAD)</span>
<span class="sd">    mom8minsnr: sets the threshold for the mom8 image (i.e. median + mom8minsnr*scaledMAD)</span>
<span class="sd">    snrThreshold: if SNR is higher than this, and phase2==True, then run a phase 2 mask calculation</span>
<span class="sd">    minPixelsInJointMask: if fewer than these pixels are found, then use all pixels above pb=0.3</span>
<span class="sd">          (when meanSpectrumMethod = &#39;mom0mom8jointMask&#39;)</span>
<span class="sd">    overwriteMoments: if True, then overwrite any existing moment0 or moment8 image </span>
<span class="sd">    overwriteMasks: if True, then overwrite any existing moment0 or moment8 mask image </span>
<span class="sd">    enableInitialQuadratic: if True, assess the need for quadratic removal, and use the </span>
<span class="sd">        old-style method to remove it</span>
<span class="sd">    rmStatContQuadratic: if True, then do not do the initialQuadratic removal (if </span>
<span class="sd">            enabled and deemed necessary), but instead always perform the new-style </span>
<span class="sd">            quadratic removal</span>
<span class="sd">    quadraticNsigma: the stopping threshold to use when ignoring outliers prior to fitting</span>
<span class="sd">            fitting the quadratic (in the rmStatContQuadratic option). To more quickly test </span>
<span class="sd">            different values, be sure to set the meanSpectrumFile option and overwrite=False)</span>
<span class="sd">    bidirectionalMaskPhase2: True=extend mask to negative values beyond threshold; False=Cycle6 behavior</span>
<span class="sd">    makeMovie: if True, then make a png for each quadratic fit as channels are </span>
<span class="sd">             removed one-by-one (in the rmStatContQuadratic option)</span>
<span class="sd">    outdir: where to write the .mom0 and .mom8 images, .dat, meanSpectrum, and the .png file</span>
<span class="sd">    maxGroups: maximum number of continuum regions below which the potential reduction </span>
<span class="sd">          factor of sigmaFindContinuum will be scaled by (1 - groups/maxGroups)**(bandwidth/1875e6)</span>
<span class="sd">          via the following equation:</span>
<span class="sd">      sFC_factor = np.max([scalingFactor/7.0, (1-groups/float(maxGroups))**(spwBandwidth/1.875e9)])</span>

<span class="sd">    Parameters passed to findContinuumChannels (and only used in there):</span>
<span class="sd">    useUncorrectedMedian: if True, then do not adjust the median (solid black line) upward</span>
<span class="sd">       from the median of the baseline points (dashed blue line)</span>
<span class="sd">    returnBluePoints: if True, then simply set the continuum ranges to the baseline points </span>
<span class="sd">         (i.e. the blue points) instead of what the other heuristics might have found</span>
<span class="sd">    baselineModeB: &#39;min&#39; or &#39;edge&#39;, method to define the baseline in findContinuumChannels()</span>
<span class="sd">    separator: the character to use to separate groups of channels in the string returned</span>
<span class="sd">    maxTrim: in trimChannels=&#39;auto&#39;, this is the max channels to trim per group for TDM spws; it is automatically scaled upward for FDM spws.</span>
<span class="sd">    maxTrimFraction: in trimChannels=&#39;auto&#39;, the max fraction of channels to trim per group</span>
<span class="sd">    negativeThresholdFactor: scale the nominal negative threshold by this factor (to adjust </span>
<span class="sd">        sensitivity to absorption features: smaller values=more sensitive)</span>
<span class="sd">    signalRatioTier1: threshold for signalRatio, above which we desensitize the level to</span>
<span class="sd">        consider line emission in order to avoid small differences in noise levels from </span>
<span class="sd">        affecting the result (e.g. that occur between serial and parallel tclean cubes)</span>
<span class="sd">        signalRatio=1 means: no lines seen, while closer to zero: more lines seen</span>
<span class="sd">    signalRatioTier2: second threshold for signalRatio, used for FDM spws (nchan&gt;192) and</span>
<span class="sd">        for cases of peakOverMad &lt; 5.  Should be &lt; signalRatioTier1.</span>
<span class="sd">    dropBaselineChannels: percentage of extreme values to drop in baseline mode &#39;min&#39;</span>
<span class="sd">    madRatioUpperLimit, madRatioLowerLimit: determines when dropBaselineChannels is used</span>
<span class="sd">    mom08simultaneous: passed to meanSpectrumFromMom0Mom8JointMask</span>
<span class="sd">    useBaseline: &#39;low&#39;, &#39;middle&#39;, &#39;high&#39; or &#39;auto&#39;; auto tries to automatically pick &#39;low&#39; for</span>
<span class="sd">       spectra that are emission-line dominated, &#39;high&#39; if absorption line dominated, or &#39;both&#39; if</span>
<span class="sd">       both types of lines are present</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;.original&#39;</span><span class="p">]:</span>
        <span class="n">maxMadRatioForSFCAdjustment</span> <span class="o">=</span> <span class="n">maxMadRatioForSFCAdjustmentInLaterIterations</span>  <span class="c1"># added May 4, 2022</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># This will be set True only by return value from meanSpectrumFromMom0Mom8JointMask()</span>
    <span class="n">startTime</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">slope</span><span class="o">=</span><span class="kc">None</span> 
    <span class="n">replaceNans</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># This used to be a command-line option, but no longer.</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="n">fitsTable</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">typeOfMeanSpectrum</span> <span class="o">=</span> <span class="s1">&#39;Existing&#39;</span> <span class="c1"># until proven otherwise later</span>
    <span class="n">narrowValueModified</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">RangesDropped</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mom0snrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">mom8snrs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># added March 22, 2019</span>
        <span class="k">if</span> <span class="n">minbeamfrac</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="n">minbeamfrac</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;minbeamfrac = &#39;auto&#39;: using </span><span class="si">%.2f</span><span class="s2"> since no image was passed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minbeamfrac</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">minbeamfrac</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span><span class="p">:</span>
                <span class="n">minbeamfrac</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;minbeamfrac = &#39;auto&#39;: using </span><span class="si">%.2f</span><span class="s2"> since maxBaseline &lt;= </span><span class="si">%d</span><span class="s2">m&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minbeamfrac</span><span class="p">,</span><span class="n">ACA_MAX_BASELINE</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">minbeamfrac</span> <span class="o">=</span> <span class="mf">0.3</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;minbeamfrac = &#39;auto&#39;: using </span><span class="si">%.2f</span><span class="s2"> since maxBaseline &gt; </span><span class="si">%d</span><span class="s2">m&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minbeamfrac</span><span class="p">,</span><span class="n">ACA_MAX_BASELINE</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumFile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using existing meanSpectrumFile = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">is_binary</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)):</span>
            <span class="n">fitsTable</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span><span class="p">):</span>
        <span class="c1"># chanInfo will be == [] if an ASCII meanSpectrumFile is specified</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanInfo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
            <span class="n">channelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span>
            <span class="n">nBaselineChannels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="o">*</span><span class="n">nchan</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> channels in the cube&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="n">nBaselineChannels</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanInfo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;You must have at least 2 edge channels (nBaselineChannels = </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumFile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">buildMeanSpectrumFilename</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">img</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">img</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">amendMaskIterationName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">]:</span> 
        <span class="c1"># do not allow overwrite to be changed from False to True if we are in the extraMaskStage</span>
        <span class="n">overwrite</span> <span class="o">=</span> <span class="n">checkForMismatch</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> 
                                     <span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">fitsTable</span><span class="p">,</span> 
                                     <span class="n">iteration</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="p">)</span>
    <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">initialPeakOverMad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">pbBasedMask</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mom0peakOverMad</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># in case it does not get set below</span>
    <span class="n">mom8peakOverMad</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># in case it does not get set below</span>
    <span class="n">numberPixelsInMom8Mask</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># added March 22, 2019  </span>
    <span class="n">jointMask</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># will only become populated if meanSpectrumMethod == &#39;mom0mom8jointMask&#39;</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span><span class="p">):</span>
        <span class="n">typeOfMeanSpectrum</span> <span class="o">=</span> <span class="s1">&#39;Computed&#39;</span>
        <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
            <span class="c1"># There should be no Nans that were replaced, but keep this name </span>
            <span class="c1"># for the spectrum for consistency with the older methods.</span>
            <span class="n">saveTime</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># somehow, the returned values do not match exactly, so leave this False for now.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">overwrite</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">useJointMaskPrior</span> <span class="ow">and</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">saveTime</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not regenerating the mean spectrum file because pickle file exists.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regenerating the mean spectrum file with method=&#39;</span><span class="si">%s</span><span class="s2">&#39; (momentdir=&#39;</span><span class="si">%s</span><span class="s2">&#39;, numberPixelsInMom8Mask=</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span><span class="n">momentdir</span><span class="p">,</span><span class="n">numberPixelsInMom8Mask</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Generating the mean spectrum file with method=&#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">priorValuesFile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_mom0mom8jointMaskPrior.pkl&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">priorValuesFile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">_mom0mom8jointMaskPrior.pkl&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useJointMaskPrior</span> <span class="ow">and</span> <span class="n">saveTime</span><span class="p">:</span>
                <span class="c1"># Read values from &lt;img&gt;_mom0mom8jointMaskPrior.pkl</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*****  </span><span class="si">%s</span><span class="s2"> does not exist, setting useJointMaskPrior to False ****&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorValuesFile</span><span class="p">))</span>
                    <span class="n">useJointMaskPrior</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***** priorValuesFile: </span><span class="si">%s</span><span class="s2"> ****&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorValuesFile</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">useJointMaskPrior</span> <span class="ow">and</span> <span class="n">saveTime</span><span class="p">:</span>
                <span class="c1"># This pickle file contains all the results returned by prior run of meanSpectrumFromMom0Mom8JointMask().</span>
                <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded </span><span class="si">%d</span><span class="s2"> values from pickle file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">priorValuesFile</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">13</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">meanSpectrumFromMom0Mom8JointMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">projectCode</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="p">,</span> <span class="n">overwriteMasks</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="n">minPixelsInJointMask</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">snrThreshold</span><span class="o">=</span><span class="n">snrThreshold</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">mom0minsnr</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="n">rmStatContQuadratic</span><span class="p">,</span> <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="n">bidirectionalMaskPhase2</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="o">=</span><span class="n">maxBaseline</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">,</span> <span class="n">mom08simultaneous</span><span class="o">=</span><span class="n">mom08simultaneous</span><span class="p">,</span><span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="n">enableInitialQuadratic</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">results</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">mom0peakOverMad</span><span class="p">,</span> <span class="n">mom8peakOverMad</span> <span class="o">=</span> <span class="n">results</span>
                <span class="c1"># Write values to &lt;img&gt;_mom0mom8jointMaskPrior.pkl</span>
                <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">open_file</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;wrote </span><span class="si">%d</span><span class="s2"> values to pickle file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">priorValuesFile</span><span class="p">))</span>
                <span class="n">open_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;returned from meanSpectrumFromMom0Mom8JointMask: numberPixelsInMom8Mask = &quot;</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">)</span>
            <span class="n">nanmin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">edgesUsed</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">meanSpectrumThreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">overwrite</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Regenerating the mean spectrum file with centralArcsec=</span><span class="si">%s</span><span class="s2">, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="n">mask</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Generating the mean spectrum file with centralArcsec=</span><span class="si">%s</span><span class="s2">, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">meanSpectrum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaCube</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span>
                                  <span class="n">nanBufferChannels</span><span class="p">,</span><span class="n">useAbsoluteValue</span><span class="p">,</span>
                                  <span class="n">baselineModeA</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span>
                                  <span class="n">continuumThreshold</span><span class="p">,</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> 
                                  <span class="n">centralArcsec</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span>
                                  <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> 
                                  <span class="n">applyMaskToMask</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">overwrite</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansRemoved</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span>\
              <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(avgspectrum) = </span><span class="si">%d</span><span class="s2">, len(avgSpectrumNansReplaced)=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Here is where nchan is defined for case of FITS table or previous spectrum</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fitsTable</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">readMeanSpectrumFITSFile</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;FITS table is not valid.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># An ASCII file was specified as the spectrum to process</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running readPreviousMeanSpectrum(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">readPreviousMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">invert</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;ASCII file is not valid, re-run with overwrite=True&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">previousCentralArcsec</span><span class="p">,</span> <span class="n">previousMask</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
                <span class="n">numberPixelsInJointMask</span> <span class="o">=</span> <span class="n">edgesUsed</span>
            <span class="c1"># Note: previousCentralArcsec  and   previousMask  are not used yet</span>
            <span class="n">regionsPruned</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># we don&#39;t know if pruning was done to generate this spectrum</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="nb">abs</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(avgspectrum) = &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;ASCII file is too short, re-run with overwrite=True&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">firstFreq</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">lastFreq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># This was an old-format ASCII file, without a frequency column</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
            <span class="n">channelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fitsTable</span> <span class="ow">or</span> <span class="n">img</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fitsTable</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;nBaselineChannels=</span><span class="si">%d</span><span class="s2">, nchan=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">nchan</span><span class="p">))</span>
                <span class="n">nBaselineChannels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="o">*</span><span class="n">nchan</span><span class="p">))</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>  <span class="c1"># freqs are in Hz</span>
            <span class="n">channelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting channelWidth to </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channelWidth</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nBaselineChannels</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;You must have at least 2 edge channels&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    <span class="c1"># By this point, nchan is guaranteed to be defined, in case it is needed.</span>
    <span class="k">if</span> <span class="n">narrow</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="n">narrow</span> <span class="o">=</span> <span class="n">pickNarrow</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>  <span class="c1"># May 6, 2020 for ALMAGAL manual usage of narrow</span>
    <span class="n">donetime</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> sec elapsed in meanSpectrum()&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">donetime</span><span class="o">-</span><span class="n">startTime</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Iteration </span><span class="si">%d</span><span class="s2"> (sigmaFindContinuumMode=&#39;</span><span class="si">%s</span><span class="s2">&#39;, sigmaFindContinuum=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">iteration</span><span class="p">,</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">)))</span>
    <span class="n">sFC_TDM</span> <span class="o">=</span> <span class="n">pick_sFC_TDM</span><span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">singleContinuum</span><span class="p">)</span>
    <span class="c1"># This definition of peakOverMad will be high if there is strong continuum</span>
    <span class="c1"># or if there is a strong line. However, removing the median from the peak </span>
    <span class="c1"># would eliminate the sensitivity to continuum emission, which we found to</span>
    <span class="c1"># be a bad idea.</span>
    <span class="n">peakOverMad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="c1"># But for purposes of deciding when to not trigger amend mask (i.e. strong</span>
    <span class="c1"># continuum) then we do want to discriminate, and removing the median is </span>
    <span class="c1"># good for that. Here we ignore the edge channels to calculate the peak.</span>
    <span class="n">peakMinusMedianOverMad</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="s1">&#39;autolower&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># Choose the starting value for sigmaFindContinuum if automatic mode is selected.  </span>
        <span class="c1"># Here we could consider adding a dependency on whether numberPixelsInMom8Mask &gt; 0</span>
        <span class="c1"># or not, but let&#39;s first try only adjusting this before the second run. 06 Jan 2019.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)):</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="n">sFC_TDM</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuum = </span><span class="si">%.1f</span><span class="s2"> since it is TDM&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_TDM</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">3.5</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuum = </span><span class="si">%.1f</span><span class="s2"> since we are using meanAboveThreshold&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOverMAD&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">6.0</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuum = </span><span class="si">%.1f</span><span class="s2"> since we are using peakOverMAD&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">):</span>
            <span class="c1"># Here is some fine tuning based on the type of spw, which we may</span>
            <span class="c1"># regret in the future, but it gives better practical results for ALMA.</span>
            <span class="c1"># Will need to revamp if storage of subregions of an spw are ever </span>
            <span class="c1"># implemented in the correlator.</span>
            <span class="k">if</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">750</span><span class="p">:</span>
                <span class="c1"># i.e. TDM spw or lots of channel averaging</span>
                <span class="k">if</span> <span class="n">peakOverMad</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">4.2</span> <span class="c1"># was 3.5 on March29, 2018</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">4.5</span> <span class="c1"># was 3.5 on March29, 2018</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># i.e. FDM spw with no (or little) channel averaging</span>
                <span class="k">if</span> <span class="n">peakOverMad</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">2.5</span> <span class="c1"># was 2.6 in v4.90;  was 3.0 on Apr2, was 3.5 on Mar29</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">3.2</span> <span class="c1"># was 3.0 on Apr2, was 3.5 on Mar29</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting sigmaFindContinuum = </span><span class="si">%.1f</span><span class="s2"> since we are using mom0mom8jointMask&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">=</span> <span class="mf">3.0</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unknown method&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">triangularPatternSeen</span> <span class="ow">and</span> <span class="n">sigmaFindContinuumMode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>  
            <span class="c1"># this cannot happen with mom0mom8jointMask because we don&#39;t check for it </span>
            <span class="c1"># (because it doesn&#39;t happen in that method of constructing a mean spectrum)</span>
            <span class="n">sigmaFindContinuum</span> <span class="o">+=</span> <span class="mf">0.5</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Adding 0.5 to sigmaFindContinuum due to triangularPattern seen&quot;</span><span class="p">)</span>

    <span class="n">fCCiteration</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span> <span class="ow">and</span> <span class="n">rmStatContQuadratic</span><span class="p">):</span>
        <span class="c1"># We remove the quadratic from the stored mean spectrum, that way the stored spectrum still</span>
        <span class="c1"># contains the curved baseline, which may be useful for future reference.</span>
        <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">channelsFit</span><span class="p">,</span> <span class="n">yfit</span> <span class="o">=</span> <span class="n">removeStatContQuadratic</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">quadraticNsigma</span><span class="p">,</span> <span class="n">returnExtra</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">makeMovie</span><span class="o">=</span><span class="n">makeMovie</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removed quadratic computed from </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> channels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channelsFit</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling findContinuumChannels with nBaselineChannels = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> 
                                   <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span> 
                                   <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> 
                                   <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span>
                                   <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span> 
                                   <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                   <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                   <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> 
                                   <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="n">fCCiteration</span><span class="p">,</span>
                                   <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="n">signalRatioTier2</span><span class="p">,</span>
                                   <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                   <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                   <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                   <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                   <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                   <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">)</span>
    
    <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">,</span><span class="n">spectralDiff</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">RangesDropped</span> <span class="o">+=</span> <span class="n">rangesDropped</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aboveBelow run0&quot;</span><span class="p">)</span>
    <span class="n">sumAboveMedian</span><span class="p">,</span> <span class="n">sumBelowMedian</span><span class="p">,</span> <span class="n">sumRatio</span><span class="p">,</span> <span class="n">channelsAboveMedian</span><span class="p">,</span> <span class="n">channelsBelowMedian</span><span class="p">,</span> <span class="n">channelRatio</span> <span class="o">=</span> \
        <span class="n">aboveBelow</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">)</span>
    <span class="n">spwBandwidth</span> <span class="o">=</span> <span class="n">nchan</span><span class="o">*</span><span class="n">channelWidth</span>  <span class="c1"># in Hz</span>
    <span class="n">c_mks</span> <span class="o">=</span> <span class="mf">2.99792458e8</span>
    <span class="n">spwBandwidthKms</span> <span class="o">=</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">c_mks</span> <span class="o">*</span> <span class="n">spwBandwidth</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">])</span>
    <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">newMaxTrim</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sFC_adjusted</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># Due to the following code block, rejectNarrowInnerWindowsChannels() can (by reducing groups from &gt;2 to 2)</span>
    <span class="c1"># can lead to a different value of maxTrim for FDM datasets.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span> <span class="ow">and</span> 
        <span class="n">maxTrim</span><span class="o">==</span><span class="n">maxTrimDefault</span> <span class="ow">and</span> <span class="n">trimChannels</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="c1"># CAS-8822</span>
        <span class="n">newMaxTrim</span> <span class="o">=</span> <span class="n">maxTrimDefault</span><span class="o">*</span><span class="n">nchan</span><span class="o">/</span><span class="mi">128</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Changing maxTrim from </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2"> for this FDM spw because trimChannels=&#39;</span><span class="si">%s</span><span class="s2">&#39; and groups=</span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">maxTrim</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">newMaxTrim</span><span class="p">),</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">maxTrim</span> <span class="o">=</span> <span class="n">newMaxTrim</span>

    <span class="c1"># Adjust sigmaFindContinuum if necessary, and re-run findContinuumChannels()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">singleChannelPeaksAboveSFC</span><span class="o">==</span><span class="n">allGroupsAboveSFC</span> <span class="ow">and</span> <span class="n">allGroupsAboveSFC</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># If all the channels exceeding the threshold are single spikes and there are more</span>
        <span class="c1"># than one of them, then they may be noise spikes, so raise the threshold a bit</span>
        <span class="c1"># This &#39;if&#39; block CAN sometimes be used by meanSpectrumMethod=&#39;mom0mom8jointMask&#39;.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span> <span class="o">&lt;</span> <span class="n">sFC_TDM</span><span class="p">):</span>  
            <span class="k">if</span> <span class="n">sigmaFindContinuumMode</span> <span class="o">==</span> <span class="s1">&#39;autolower&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Because we are in autolower, not scaling the threshold upward by a factor of </span><span class="si">%.2f</span><span class="s2"> to avoid apparent noise spikes (</span><span class="si">%d</span><span class="s2">==</span><span class="si">%d</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_factor</span><span class="p">,</span> <span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">sigmaFindContinuumMode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="c1"># raise the threshold a bit since all the peaks look like all noise spikes</span>
                <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">1.5</span>
                <span class="n">sigmaFindContinuum</span> <span class="o">*=</span> <span class="n">sFC_factor</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Scaling the threshold upward by a factor of </span><span class="si">%.2f</span><span class="s2"> to avoid apparent noise spikes (</span><span class="si">%d</span><span class="s2">==</span><span class="si">%d</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_factor</span><span class="p">,</span> <span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">))</span>
                <span class="n">fCCiteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> 
                                               <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> 
                                               <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> 
                                               <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span>
                                               <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span>
                                               <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                               <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                               <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> 
                                               <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="n">fCCiteration</span><span class="p">,</span>
                                               <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="n">signalRatioTier2</span><span class="p">,</span><span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span>                                    
                                               <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                               <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                               <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                               <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                               <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">)</span>
            <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">,</span><span class="n">spectralDiff</span><span class="p">,</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">RangesDropped</span> <span class="o">+=</span> <span class="n">rangesDropped</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aboveBelow run1&quot;</span><span class="p">)</span>
            <span class="n">sumAboveMedian</span><span class="p">,</span> <span class="n">sumBelowMedian</span><span class="p">,</span> <span class="n">sumRatio</span><span class="p">,</span> <span class="n">channelsAboveMedian</span><span class="p">,</span> <span class="n">channelsBelowMedian</span><span class="p">,</span> <span class="n">channelRatio</span> <span class="o">=</span> \
                <span class="n">aboveBelow</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">groups</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">1.3</span><span class="p">))</span> <span class="ow">and</span> <span class="n">sigmaFindContinuumMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="s1">&#39;autolower&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOver&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">singleContinuum</span><span class="p">):</span>
        <span class="c1"># If there are a lot of groups, or a lot of flux in channels above the median </span>
        <span class="c1"># compared to channels below the median (i.e. the channelRatio), then lower the </span>
        <span class="c1"># sigma in order to push the threshold for real lines (or line emission wings) lower.</span>
        <span class="c1"># However, if there is only 1 group, then there may be no real lines </span>
        <span class="c1"># present, so lowering the threshold in this case can create needless </span>
        <span class="c1"># extra groups, so don&#39;t allow it.</span>
        <span class="c1"># **** This &#39;elif&#39; is NOT used by meanSpectrumMethod=&#39;mom0mom8jointMask&#39;. *****</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A: groups,channelRatio=&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">channelRatio</span><span class="p">,</span> <span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">channelRatio</span><span class="o">&gt;</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">),</span> <span class="n">groups</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">channelRatio</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">firstFreq</span><span class="o">&gt;</span><span class="mf">60e9</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">))</span> <span class="ow">and</span> <span class="n">groups</span><span class="o">&gt;</span><span class="mi">2</span><span class="p">):</span>  <span class="c1"># was nchan&gt;256</span>
            <span class="c1"># Don&#39;t allow this much reduction in ALMA TDM mode as it chops up </span>
            <span class="c1"># line-free quasar spectra too much. The channelRatio&gt;0.1 </span>
            <span class="c1"># requirement prevents failures due to ALMA TFB platforming.</span>
            <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">0.333</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">&lt;</span> <span class="n">channelRatio</span> <span class="o">&lt;</span> <span class="mf">1.3</span> <span class="ow">and</span> <span class="n">groups</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> 
                <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)</span> <span class="ow">and</span> <span class="n">channelWidth</span><span class="o">&gt;=</span><span class="mf">1875e6</span><span class="o">/</span><span class="mf">600.</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">channelWidth</span> <span class="o">&lt;</span> <span class="mf">1875e6</span><span class="o">/</span><span class="mf">360.</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">madRatioLowerLimit</span> <span class="o">&lt;</span> <span class="n">madRatio</span> <span class="o">&lt;</span> <span class="n">madRatioUpperLimit</span><span class="p">:</span>
                        <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">0.60</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">0.50</span> 
                    <span class="c1"># i.e. for galaxy spectra with FDM 480 channel (online-averaging) resolution</span>
                    <span class="c1"># but 0.5 is too low for uid___A001_X879_X47a.s24_0.ELS26_sci.spw25.mfs.I.findcont.residual</span>
                    <span class="c1"># and for uid___A001_X2d8_X2c5.s24_0.2276_444_53712_sci.spw16.mfs.I.findcont.residual</span>
                    <span class="c1">#    the latter requires &gt;=0.057</span>
                    <span class="c1">#   need to reconcile in future versions</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">0.7</span>  <span class="c1"># i.e. for galaxy spectra with FDM 240 channel (online-averaging) resolution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># prevent sigmaFindContinuum going to inf if groups==1</span>
                <span class="c1"># prevent sigmaFindContinuum going &gt; 1 if groups==2</span>
                <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">0.9</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">):</span>
                <span class="n">sFC_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">elif</span> <span class="n">channelWidth</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># the second factor tempers the reduction as the spw bandwidth decreases</span>
                <span class="n">sFC_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="n">spwBandwidth</span><span class="o">/</span><span class="mf">1.875e9</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sFC_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;setting factor to </span><span class="si">%f</span><span class="s2"> because groups=</span><span class="si">%d</span><span class="s2">, channelRatio=</span><span class="si">%g</span><span class="s2">, firstFreq=</span><span class="si">%g</span><span class="s2">, nchan=</span><span class="si">%d</span><span class="s2">, channelWidth=</span><span class="si">%e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_factor</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">channelRatio</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">nchan</span><span class="p">,</span><span class="n">channelWidth</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Scaling the threshold by a factor of </span><span class="si">%.2f</span><span class="s2"> (groups=</span><span class="si">%d</span><span class="s2">, channelRatio=</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_factor</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span><span class="n">channelRatio</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
        <span class="n">sigmaFindContinuum</span> <span class="o">*=</span> <span class="n">sFC_factor</span>
        <span class="n">fCCiteration</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> 
                                       <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> 
                                       <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> 
                                       <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span>
                                       <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span> 
                                       <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                       <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                       <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> 
                                       <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="n">fCCiteration</span><span class="p">,</span>
                                       <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="n">signalRatioTier2</span><span class="p">,</span>
                                       <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                       <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                       <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                       <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                       <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                       <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">)</span>

        <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">,</span><span class="n">spectralDiff</span><span class="p">,</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">RangesDropped</span> <span class="o">+=</span> <span class="n">rangesDropped</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aboveBelow run2&quot;</span><span class="p">)</span>
        <span class="n">sumAboveMedian</span><span class="p">,</span> <span class="n">sumBelowMedian</span><span class="p">,</span> <span class="n">sumRatio</span><span class="p">,</span> <span class="n">channelsAboveMedian</span><span class="p">,</span> <span class="n">channelsBelowMedian</span><span class="p">,</span> <span class="n">channelRatio</span> <span class="o">=</span> \
            <span class="n">aboveBelow</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.autoLower&#39;</span> <span class="ow">and</span> <span class="n">momDiffSNR</span> <span class="o">&lt;</span> <span class="n">momDiffApproachLevel</span><span class="p">:</span> <span class="c1"># added Jun 16, 2022</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not adjusting sigmaFindContinuum because we are in .autoLower and momDiffSNR=</span><span class="si">%.1f</span><span class="s2"> &lt; </span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">momDiffSNR</span><span class="p">,</span><span class="n">momDiffApproachLevel</span><span class="p">))</span> <span class="c1"># added May 11, 2022, with momDiffSNR clause added June 11</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOver&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> 
            <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not adjusting sigmaFindContinuum, because groups=</span><span class="si">%d</span><span class="s2">, channelRatio=</span><span class="si">%g</span><span class="s2">, firstFreq=</span><span class="si">%g</span><span class="s2">, nchan=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groups</span><span class="p">,</span><span class="n">channelRatio</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">nchan</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># We are using either peakOverMad or mom0mom8jointMask</span>
            <span class="k">if</span> <span class="n">madRatio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># python2 behavior for a None inequality was True, while python3 crashes</span>
                <span class="n">madRatioCheck</span> <span class="o">=</span> <span class="n">peakOverMad</span><span class="o">&gt;</span><span class="mi">40</span> <span class="c1">#   this value was set True in PL&lt;=PL2022, note that 40 is different from default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">madRatioCheck</span> <span class="o">=</span> <span class="n">madRatio</span> <span class="o">&lt;</span> <span class="n">maxMadRatioForSFCAdjustment</span> <span class="ow">or</span> <span class="n">peakOverMad</span><span class="o">&gt;</span><span class="n">peakOverMadCriterion</span>  <span class="c1"># added or statement on May 11, 2022</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;numberPixelsInMom8Mask=</span><span class="si">%d</span><span class="s2">, allContinuumSelected(&#39;</span><span class="si">%s</span><span class="s2">&#39;,</span><span class="si">%d</span><span class="s2">)=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInMom8Mask</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">nchan</span><span class="p">,</span><span class="n">allContinuumSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">nchan</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">groups</span> <span class="o">&gt;=</span> <span class="n">minGroupsForSFCAdjustment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)</span> 
                 <span class="ow">or</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)))</span>  <span class="ow">and</span> 
                <span class="n">sigmaFindContinuumMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="s1">&#39;autolower&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="c1"># added Mar 27, 2019</span>
<span class="c1">#               (peakOverMad&gt;minPeakOverMadForSFCAdjustment or </span>
               <span class="p">((</span><span class="n">peakOverMad</span><span class="o">&gt;</span><span class="n">minPeakOverMadForSFCAdjustment</span> <span class="ow">and</span> <span class="n">madRatioCheck</span><span class="p">)</span> 
                <span class="ow">or</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOver&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)):</span> 
                <span class="c1"># ***** This &#39;if&#39; block will never be used when groups==1 *****</span>
                <span class="c1">#18 set by 312:2016.1.01400.S spw25 not needing it with 11.7 and</span>
                <span class="c1">#          431:E2E5.1.00036.S spw24 not needing it with 17.44</span>
                <span class="c1">#          268:2015.1.00190.S spw16 not needing it with 18.7</span>
                <span class="c1">#          423:E2E5.1.00034.S spw25 needing it with 20.3</span>
                <span class="c1">#      but 262:2015.1.01068.S spw37 does not need it with 38</span>
                <span class="c1"># The following heuristics for sFC achieve better results on hot cores </span>
                <span class="c1"># when meanAboveThreshold cannot be used.</span>
                <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span> <span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
                    <span class="n">scalingFactor</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># added May 10, 2022</span>
                <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.onlyExtraMask&#39;</span> <span class="ow">and</span> <span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">scalingFactor</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># added for PL2023</span>
                <span class="k">elif</span> <span class="n">amendMaskIterationName</span> <span class="o">==</span> <span class="s1">&#39;.extraMask&#39;</span> <span class="ow">and</span> <span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
                    <span class="n">scalingFactor</span> <span class="o">=</span> <span class="mi">6</span> <span class="c1"># added for PL2023</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scalingFactor</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="k">if</span> <span class="n">groups</span> <span class="o">&lt;</span> <span class="n">maxGroups</span><span class="p">:</span> 
                    <span class="c1"># protect against negative number raised to a power</span>
                    <span class="n">sFC_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">scalingFactor</span><span class="o">/</span><span class="mf">7.0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">groups</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">maxGroups</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="n">spwBandwidth</span><span class="o">/</span><span class="mf">1.875e9</span><span class="p">)])</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Because groups=</span><span class="si">%d</span><span class="s2"> &lt; maxGroups=</span><span class="si">%d</span><span class="s2">, setting sFC_factor to </span><span class="si">%f</span><span class="s2"> instead of </span><span class="si">%d</span><span class="s2">/7.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groups</span><span class="p">,</span><span class="n">maxGroups</span><span class="p">,</span><span class="n">sFC_factor</span><span class="p">,</span><span class="n">scalingFactor</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sFC_factor</span> <span class="o">=</span> <span class="n">scalingFactor</span><span class="o">/</span><span class="mf">7.0</span> <span class="c1"># was previously 2.5/sigmaFindContinuum </span>
                <span class="c1"># How often do we get 5/7 vs. a higher value? (in the benchmark)</span>
                <span class="n">sigmaFindContinuum</span> <span class="o">*=</span> <span class="n">sFC_factor</span>
                <span class="c1"># madRatio could be &#39;None&#39; so set to string</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Adjusting sigmaFindContinuum by x</span><span class="si">%.2f</span><span class="s2"> to </span><span class="si">%f</span><span class="s2"> because groups=</span><span class="si">%d</span><span class="s2">&gt;=</span><span class="si">%d</span><span class="s2"> and not TDM and meanSpectrumMethod = </span><span class="si">%s</span><span class="s2"> and peakOverMad=</span><span class="si">%f</span><span class="s2">&gt;</span><span class="si">%g</span><span class="s2"> and (madRatio=</span><span class="si">%s</span><span class="s2">&lt;</span><span class="si">%f</span><span class="s2"> or peakOverMad&gt;</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">sFC_factor</span><span class="p">,</span><span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span> <span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">madRatio</span><span class="p">),</span><span class="n">maxMadRatioForSFCAdjustment</span><span class="p">,</span> <span class="n">peakOverMadCriterion</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">sFC_adjusted</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># need to set this to force examination of blue points below</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">numberPixelsInMom8Mask</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="ow">and</span> <span class="n">allContinuumSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">nchan</span><span class="p">):</span>
                <span class="n">normalizedMom0peak</span> <span class="o">=</span> <span class="n">mom0peak</span><span class="o">/</span><span class="n">spwBandwidthKms</span>
                <span class="c1"># before I added tdm/fdm split, it was 1.4 on Jan 26 regression;  1.5 on Feb 01 regression</span>
                <span class="c1"># page 260 needs &lt;= 1.41</span>
                <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
                    <span class="n">normalizedMom0factor</span> <span class="o">=</span> <span class="mf">1.5</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">normalizedMom0factor</span> <span class="o">=</span> <span class="mf">1.4</span> <span class="c1"># was 1.4 on Jan 26 regression;  1.5 on Feb 01 regression</span>
                <span class="k">if</span> <span class="n">mom8peak</span> <span class="o">&gt;</span> <span class="n">normalizedMom0factor</span><span class="o">*</span><span class="n">normalizedMom0peak</span><span class="p">:</span>
                    <span class="c1"># New for Cycle 7:  Here we adjust sFC downward because emission was found </span>
                    <span class="c1"># in the mom8 image but no line regions were found initially. - 06 Jan 2019</span>
                    <span class="n">sFC_factor</span> <span class="o">=</span> <span class="n">SFC_FACTOR_WHEN_MOM8MASK_EXISTS</span>
                    <span class="n">sigmaFindContinuum</span> <span class="o">*=</span> <span class="n">sFC_factor</span>
                    <span class="k">if</span> <span class="n">mom8peak</span> <span class="o">&gt;</span> <span class="mf">3.5</span><span class="o">*</span><span class="n">normalizedMom0peak</span> <span class="ow">and</span> <span class="n">peakOverMad</span> <span class="o">&gt;</span> <span class="mf">5.5</span><span class="p">:</span>
                        <span class="c1"># needed for helms61 spw16 in 2018.1.00922.S</span>
                        <span class="n">sFC_adjusted</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># need to set this to force examination of blue points below</span>
<span class="c1">#                   but do not set it between 1.5-3.5 since it removes too much continuum in line-free cases</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Adjusting sigmaFindContinuum by </span><span class="si">%.2f</span><span class="s2"> to </span><span class="si">%f</span><span class="s2"> because groups=1 and &gt;=</span><span class="si">%.3f</span><span class="s2"> of the channels were selected and mom8peak=</span><span class="si">%f</span><span class="s2"> &gt; </span><span class="si">%.2f</span><span class="s2">*(mom0peak=</span><span class="si">%f</span><span class="s2">/bwkms=</span><span class="si">%f</span><span class="s2">)=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">sFC_factor</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">ALL_CONTINUUM_CRITERION</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">normalizedMom0factor</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">spwBandwidthKms</span><span class="p">,</span> <span class="n">normalizedMom0factor</span><span class="o">*</span><span class="n">normalizedMom0peak</span><span class="p">))</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Mom8 mask is present and allContinuumSelected, but mom8peak=</span><span class="si">%f</span><span class="s2"> not &gt; </span><span class="si">%.2f</span><span class="s2">*(mom0peak=</span><span class="si">%f</span><span class="s2">/bwkms=</span><span class="si">%f</span><span class="s2">)=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">normalizedMom0factor</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">spwBandwidthKms</span><span class="p">,</span> <span class="n">normalizedMom0factor</span><span class="o">*</span><span class="n">normalizedMom0peak</span><span class="p">))</span> 
            <span class="k">elif</span> <span class="n">groups</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
                <span class="c1"># This is for the case of double-peaked spectrum where weaker detection in the channels between </span>
                <span class="c1"># the peaks are below threshold.</span>
                <span class="n">sFC_adjusted</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># need to set this to force examination of blue points below</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Not adjusting sigmaFindContinuum, but setting blue pruning because there are 3 groups and TDM&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># madRatio could be &#39;None&#39; so force it to be a string</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Not adjusting sigmaFindContinuum because groups=</span><span class="si">%d</span><span class="s2"> &lt; </span><span class="si">%d</span><span class="s2"> or peakOverMad=</span><span class="si">%f</span><span class="s2">&lt;</span><span class="si">%.0f</span><span class="s2"> or (madRatio=</span><span class="si">%s</span><span class="s2">&gt;=</span><span class="si">%f</span><span class="s2"> and peakOverMad&lt;=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span><span class="n">minGroupsForSFCAdjustment</span><span class="p">,</span><span class="n">peakOverMad</span><span class="p">,</span><span class="n">minPeakOverMadForSFCAdjustment</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">madRatio</span><span class="p">),</span><span class="n">maxMadRatioForSFCAdjustment</span><span class="p">,</span><span class="n">peakOverMadCriterion</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="p">(</span><span class="n">newMaxTrim</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">allContinuumSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">nchan</span><span class="p">)</span> <span class="ow">and</span> <span class="n">numberPixelsInMom8Mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="c1"># line added 06 Jan 2019</span>
            <span class="p">(</span><span class="n">groups</span><span class="o">&gt;</span><span class="n">minGroupsForSFCAdjustment</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">))):</span> <span class="c1"># line added Aug 22, 2016</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">newMaxTrim</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;But re-running findContinuumChannels with new maxTrim&quot;</span><span class="p">)</span>
            <span class="n">fCCiteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> 
                                           <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> 
                                           <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> 
                                           <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span>
                                           <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span> 
                                           <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                           <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                           <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> 
                                           <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="n">fCCiteration</span><span class="p">,</span>
                                           <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="n">signalRatioTier2</span><span class="p">,</span>
                                           <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                           <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                           <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span> 
                                           <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                           <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span>
                                           <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="n">amendMaskIterationName</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">)</span>
                                           

            <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">,</span><span class="n">spectralDiff</span><span class="p">,</span><span class="n">trimChannels</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">RangesDropped</span> <span class="o">+=</span> <span class="n">rangesDropped</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aboveBelow run3&quot;</span><span class="p">)</span>
            <span class="n">sumAboveMedian</span><span class="p">,</span> <span class="n">sumBelowMedian</span><span class="p">,</span> <span class="n">sumRatio</span><span class="p">,</span> <span class="n">channelsAboveMedian</span><span class="p">,</span> <span class="n">channelsBelowMedian</span><span class="p">,</span> <span class="n">channelRatio</span> <span class="o">=</span> \
                <span class="n">aboveBelow</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">)</span>

    <span class="n">selectionPreBluePruning</span> <span class="o">=</span> <span class="n">selection</span>
    <span class="n">secondSelectionAdded</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># used to indicate on the spectrum plot if the heuristic for CAS-11720 was activated to ensure a second region</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No slope fit attempted because we are using mom0mom8jointMask.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">sFC_adjusted</span> <span class="ow">or</span> <span class="p">((</span><span class="n">peakOverMad</span><span class="o">&gt;</span><span class="mi">6</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="o">*</span><span class="n">nchan</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)))</span> <span class="ow">and</span> 
             <span class="nb">len</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">allowBluePruning</span><span class="p">):</span>
            <span class="c1"># New heuristic for Cycle 6: blue pruning (a.k.a. examining blue points)</span>
            <span class="c1"># Definition: remove any candidate continuum range</span>
            <span class="c1"># (horizontal cyan lines in the plot) that do not contain any </span>
            <span class="c1"># initial baseline points (blue points in the plot), and trim </span>
            <span class="c1"># those ranges that do contain baseline points to the maximal </span>
            <span class="c1"># extent of the enclosed baseline points, eliminating them if </span>
            <span class="c1"># they get too narrow.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Activating blue pruning heuristic&#39;</span><span class="p">)</span>
            <span class="n">channelSelections</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
            <span class="n">validSelections</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">newContinuumChannels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">newGroups</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">checkForGaps</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># checkForGaps means to look for large portions of a channelSelection that has no</span>
            <span class="c1"># baseline channels in it, and if found, then split up that selection into pieces.</span>
            <span class="c1"># This is meant to eliminate the remaining weak lines in a hot core spectrum that</span>
            <span class="c1"># are below the final threshold.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ccstring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channelSelections</span><span class="p">):</span> 
                <span class="n">validSelection</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ccstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
                <span class="n">selectionWidth</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># We set a max threshold mainly to prevent losing too much continuum if the &quot;line&quot; is not real</span>
                <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">):</span>
                    <span class="n">gapMaxThreshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># was 70</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">gapMaxThreshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># added for 478chan spw27 in 2018.1.00081.S</span>
                <span class="k">if</span> <span class="n">groups</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Enable detection of single faint narrow line, </span>
                    <span class="c1"># e.g. 42 in project 54 uid___A001_X144_X7b.s21_0.IRD_C_sci.spw29</span>
                    <span class="c1"># 58 MHz 240 chan, 15 chan -&gt; 3.6 km/s at 300 GHz</span>
                    <span class="c1"># 58 MHz 480 chan, 30 chan -&gt; 3.6 km/s</span>
                    <span class="c1"># 58 MHz 960 chan, 60 chan -&gt; 3.6 km/s</span>
                    <span class="c1"># 58 MHz 960 chan, 15 chan -&gt; 3.6 km/s at 75 GHz</span>
                    <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="p">(</span><span class="n">firstFreq</span><span class="o">/</span><span class="mf">300e9</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">spwBandwidth</span><span class="o">/</span><span class="mf">58e6</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mf">480.</span><span class="p">))</span> <span class="c1"># previously was 40</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;initial gapMinThreshold=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gapMinThreshold</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">peakOverMad</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">:</span> <span class="c1"># we got into here only because more than 4/5 channels were picked</span>
                        <span class="k">if</span> <span class="n">gapMinThreshold</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
                            <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># 30 was set to avoid gaps with no lines</span>
                        <span class="k">elif</span> <span class="n">gapMinThreshold</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">:</span> <span class="c1">#50:</span>
                            <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="mi">45</span> <span class="c1">#50  # 50 was set by E2E6.1.00030.S spw16 CO galaxy w/no continuum uid___A002_Xcff05c_X1bd.s28_0.HCG25b_sci.spw16.mfs.I.findcont.residual, but this line is 111 channels wide, so no longer appears to motivate this value</span>
                                                 <span class="c1">#49 was needed by 2018.1.00635.S spw29 CI1-0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">16</span><span class="p">,</span><span class="n">gapMinThreshold</span><span class="p">])</span> <span class="c1"># original heuristic, Note: can be a large number, even &gt; gapMaxThreshold!</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">gapMinThreshold</span> <span class="o">&gt;</span> <span class="n">gapMaxThreshold</span><span class="p">):</span>  
                        <span class="c1"># this would fix two results on CAS-5290, including 2018.1.01100.S </span>
                        <span class="c1"># but has not been checked in regression</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;sFC was adjusted and gapMin=</span><span class="si">%d</span><span class="s1"> &gt; gapMax=</span><span class="si">%d</span><span class="s1">, so setting gapMin=30&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gapMinThreshold</span><span class="p">,</span><span class="n">gapMaxThreshold</span><span class="p">))</span>
                        <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># could also try 0.06*nchan (which is 28 for 478 chan)</span>
                        <span class="k">if</span> <span class="n">gapMinThreshold</span> <span class="o">&gt;</span> <span class="n">gapMaxThreshold</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;   but new gapMin=</span><span class="si">%d</span><span class="s1"> &gt; gapMax=</span><span class="si">%d</span><span class="s1">, so setting gapMin=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gapMinThreshold</span><span class="p">,</span><span class="n">gapMaxThreshold</span><span class="p">,</span><span class="n">gapMaxThreshold</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
                            <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="n">gapMaxThreshold</span><span class="o">-</span><span class="mi">10</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Must be at least half the width of the group</span>
                    <span class="n">gapMinThreshold</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">selectionWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">narrow</span><span class="p">]))</span>   <span class="c1"># splitgaps.pdf</span>

                <span class="k">if</span> <span class="n">checkForGaps</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Looking for gaps in group </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2"> that are </span><span class="si">%d</span><span class="s2"> &lt; gap &lt; </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">channelSelections</span><span class="p">),</span><span class="n">ccstring</span><span class="p">,</span><span class="n">gapMinThreshold</span><span class="p">,</span> <span class="n">gapMaxThreshold</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">theseChannels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">startChan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">stopChan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">theseChannels</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">chan</span> <span class="ow">in</span> <span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">validSelection</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># valid if any of the channels appeared in the original baseline</span>
                        <span class="k">if</span> <span class="n">startChan</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">startChan</span> <span class="o">=</span> <span class="n">chan</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If the blue points are contiguous, then chan will now be stopChan+1, so check</span>
                            <span class="c1"># if it is actually a lot more than that (meaning we just crossed a gap). But,</span>
                            <span class="c1"># it must be a big gap relative to the selection width in order to qualify.</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">stopChan</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">chan</span><span class="o">-</span><span class="n">stopChan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">gapMinThreshold</span> <span class="ow">and</span> <span class="p">(</span><span class="n">chan</span><span class="o">-</span><span class="n">stopChan</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">gapMaxThreshold</span> <span class="ow">and</span> <span class="n">checkForGaps</span><span class="p">):</span>
                                <span class="n">gaps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stopChan</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">chan</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">chan</span><span class="o">-</span><span class="n">stopChan</span> <span class="o">&gt;=</span> <span class="n">gapMaxThreshold</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chan-stopChan = </span><span class="si">%d</span><span class="s2"> &gt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">chan</span><span class="o">-</span><span class="n">stopChan</span><span class="p">,</span><span class="n">gapMaxThreshold</span><span class="p">))</span>
                            <span class="n">stopChan</span> <span class="o">=</span> <span class="n">chan</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)):</span>
                    <span class="c1"># check if the max is in here</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">gaps</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])):</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Removing the one gap found because the peak is not in here&#39;</span><span class="p">)</span>
                        <span class="n">gaps</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">tooNarrow</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">validSelection</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">stopChan</span> <span class="o">-</span> <span class="n">startChan</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">narrow</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">tooNarrow</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">validSelection</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Looking for trimmed channel ranges to drop&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">projectCode</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">stopChan</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">stopChan</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">ccstring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startChan</span><span class="p">,</span><span class="n">stopChan</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">validSelection</span><span class="p">:</span>
                        <span class="n">newGroups</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">validSelections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccstring</span><span class="p">)</span>
                        <span class="n">newContinuumChannels</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">startChan</span><span class="p">,</span><span class="n">stopChan</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># theseChannels (bug fix May 14, 2020)</span>
                    <span class="k">elif</span> <span class="n">tooNarrow</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Dropping trimmed channel range </span><span class="si">%s</span><span class="s1"> because it is too narrow (&lt;</span><span class="si">%d</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">,</span><span class="n">narrow</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ccstring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Dropping channel range </span><span class="si">%s</span><span class="s1"> because not enough baseline channels are contained and sFC was previously adjusted downwards.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># new heuristic on April 7, 2018</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Splitting channel range </span><span class="si">%s</span><span class="s1"> into </span><span class="si">%d</span><span class="s1"> ranges due to wide gaps in baseline channels.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ngap</span><span class="p">,</span><span class="n">gap</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gaps</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">ngap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">firstChan</span> <span class="o">=</span> <span class="n">startChan</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">firstChan</span> <span class="o">=</span> <span class="n">gaps</span><span class="p">[</span><span class="n">ngap</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                        <span class="n">ccstring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">firstChan</span><span class="p">,</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">firstChan</span> <span class="o">&gt;=</span> <span class="n">narrow</span><span class="p">:</span>
                            <span class="c1"># The split piece of the range is wide enough to keep it.</span>
                            <span class="n">newGroups</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">validSelections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccstring</span><span class="p">)</span>
                            <span class="n">newContinuumChannels</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">firstChan</span><span class="p">,</span> <span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> Defining range </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> Skipping range </span><span class="si">%s</span><span class="s1"> because it is too narrow (&lt;</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">,</span><span class="n">narrow</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># Process the final piece</span>
                    <span class="n">ccstring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gaps</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">stopChan</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">stopChan</span> <span class="o">-</span> <span class="n">gaps</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">narrow</span><span class="p">:</span>
                        <span class="n">newGroups</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">validSelections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ccstring</span><span class="p">)</span>
                        <span class="n">newContinuumChannels</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">gaps</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">gaps</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">stopChan</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> Defining range </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> Skipping range </span><span class="si">%s</span><span class="s1"> because it is too narrow (&lt;</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">ccstring</span><span class="p">,</span><span class="n">narrow</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># end for i,ccstring in enumerate(channelSelections)</span>
            <span class="k">if</span> <span class="n">newGroups</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">separator</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validSelections</span><span class="p">)</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="n">newGroups</span>
                <span class="n">continuumChannels</span> <span class="o">=</span> <span class="n">newContinuumChannels</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Restoring dropped channels because no groups are left.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">allowBluePruning</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not examining blue dots (at user request)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not examining blue dots because: sFC_adjusted=</span><span class="si">%s</span><span class="s2"> is False or (peakOverMad=</span><span class="si">%.2f</span><span class="s2"> &lt;= 6 and len(chans)=</span><span class="si">%d</span><span class="s2"> &lt;= 4*nchan/5=</span><span class="si">%d</span><span class="s2">) or it&#39;s TDM&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sFC_adjusted</span><span class="p">,</span><span class="n">peakOverMad</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">),</span> <span class="mi">4</span><span class="o">*</span><span class="n">nchan</span><span class="o">/</span><span class="mi">5</span><span class="p">))</span>
        <span class="c1"># check if only 1 narrow group found (to activate a fix for CAS-11720 == PIPE-183)</span>
        <span class="k">if</span> <span class="n">groups</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This should not happen since PIPE-359 was fixed.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">amendMask</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">channelsInSingleGroup</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">group0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
                <span class="n">channelsInSingleGroup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">group0</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">minPercentInSingleGroup</span> <span class="o">=</span> <span class="mf">5.0</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">channelsInSingleGroup</span><span class="p">)</span><span class="o">/</span><span class="n">nchan</span> <span class="o">&lt;</span> <span class="n">minPercentInSingleGroup</span><span class="o">/</span><span class="mi">100</span><span class="p">:</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">channelsInSingleGroup</span> <span class="o">/</span> <span class="n">nchan</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** There is only a single channel range found with only </span><span class="si">%.1f%%</span><span class="s1"> (&lt; </span><span class="si">%.0f%%</span><span class="s1">) of the channels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">percentage</span><span class="p">,</span><span class="n">minPercentInSingleGroup</span><span class="p">))</span>
                <span class="n">whichHalf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">group0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">mylist</span> <span class="o">=</span> <span class="n">findWidestContiguousListInOtherHalf</span><span class="p">(</span><span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">whichHalf</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mylist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">groups</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">secondSelectionAdded</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">selection</span> <span class="o">=</span> <span class="n">secondSelectionAdded</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lastChannelOfOnlyRegion</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lastChannelOfOnlyRegion</span><span class="p">:</span> <span class="c1"># allBaselineChannelsXY[0][-1]:</span>
                            <span class="c1"># add to end of string (to maintain increasing order)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding to end of string&quot;</span><span class="p">)</span>
                            <span class="n">selection</span> <span class="o">+=</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">secondSelectionAdded</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># add to beginning of string (to maintain increasing order)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">%s</span><span class="s2"> to beginning of string because </span><span class="si">%d</span><span class="s2"> &lt;= </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">secondSelectionAdded</span><span class="p">,</span> <span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">lastChannelOfOnlyRegion</span><span class="p">))</span>
                            <span class="n">selection</span> <span class="o">=</span> <span class="n">secondSelectionAdded</span> <span class="o">+</span> <span class="n">separator</span> <span class="o">+</span> <span class="n">selection</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** Added a second selection in the other half of the spectrum: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">secondSelectionAdded</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">%s</span><span class="s1"> ****** No blue points found in the other half of the spectrum&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># The following Cycle 4+5 logic (on checking for the presence of </span>
        <span class="c1"># candidate continuum channels in various segments of the</span>
        <span class="c1"># spectrum in order to decide whether to attempt to remove a first or</span>
        <span class="c1"># second order baseline) is not used by the mom0mom8jointMask method.</span>
        <span class="n">selectedChannels</span> <span class="o">=</span> <span class="n">countChannels</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">largestGroup</span> <span class="o">=</span> <span class="n">channelsInLargestGroup</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">selections</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
        <span class="n">slopeRemoved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">channelDistancesFromCenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span><span class="o">-</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">channelDistancesFromLowerThird</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span><span class="o">-</span><span class="n">nchan</span><span class="o">*</span><span class="mf">0.3</span>
        <span class="n">channelDistancesFromUpperThird</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span><span class="o">-</span><span class="n">nchan</span><span class="o">*</span><span class="mf">0.7</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channelDistancesFromCenter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> 
            <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channelDistancesFromCenter</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">channelsInBothHalves</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># casalogPost(&quot;channelDistancesFromCenter = %s&quot; % (channelDistancesFromCenter))</span>
            <span class="n">channelsInBothHalves</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># does not get triggered by case 115, which could use it</span>
        <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channelDistancesFromLowerThird</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> 
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channelDistancesFromUpperThird</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">channelsInBothEdgeThirds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channelsInBothEdgeThirds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Too many selected windows means there might be a lot of lines, </span>
        <span class="c1"># so do not attempt a baseline fit.</span>
        <span class="n">maxSelections</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># 2    # July 27, 2017</span>
        <span class="c1"># If you select too few channels, you cannot get a reliable fit</span>
        <span class="n">minBWFraction</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">selectedChannels</span> <span class="o">&gt;</span> <span class="n">channelFractionForSlopeRemoval</span><span class="o">*</span><span class="n">nchan</span> <span class="ow">or</span> 
            <span class="p">(</span><span class="n">selectedChannels</span> <span class="o">&gt;</span> <span class="mf">0.4</span><span class="o">*</span><span class="n">nchan</span> <span class="ow">and</span> <span class="n">selections</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">channelFractionForSlopeRemoval</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> 
            <span class="c1"># fix for project 00956 spw 25 is to put lower bound of 1 &lt; selections:</span>
            <span class="p">(</span><span class="n">largestGroup</span><span class="o">&gt;</span><span class="n">nchan</span><span class="o">*</span><span class="n">minBWFraction</span> <span class="ow">and</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">selections</span> <span class="o">&lt;=</span> <span class="n">maxSelections</span> <span class="ow">and</span> 
             <span class="n">channelFractionForSlopeRemoval</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">))):</span>
            <span class="n">previousResult</span> <span class="o">=</span> <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span>        
            <span class="c1"># remove linear slope from mean spectrum and run it again</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">channelSelectionRangesToIndexArray</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="c1">#        if quadraticFit and (channelsInBothEdgeThirds or (channelsInBothHalves and selections==1)):  # July 27, 2017</span>
            <span class="n">quadraticFitTest</span> <span class="o">=</span> <span class="n">quadraticFit</span> <span class="ow">and</span> <span class="p">((</span><span class="n">channelsInBothEdgeThirds</span> <span class="ow">and</span> <span class="n">selections</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">channelsInBothHalves</span> <span class="ow">and</span> <span class="n">selections</span><span class="o">==</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">quadraticFitTest</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Fitting quadratic to </span><span class="si">%d</span><span class="s2"> channels (largestGroup=</span><span class="si">%d</span><span class="s2">,nchan*</span><span class="si">%.1f</span><span class="s2">=</span><span class="si">%.1f</span><span class="s2">,selectedChannels=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">largestGroup</span><span class="p">,</span> <span class="n">minBWFraction</span><span class="p">,</span> <span class="n">nchan</span><span class="o">*</span><span class="n">minBWFraction</span><span class="p">,</span> <span class="n">selectedChannels</span><span class="p">))</span>
                <span class="n">fitResult</span> <span class="o">=</span> <span class="n">polyfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">order2</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">xoffset</span> <span class="o">=</span> <span class="n">fitResult</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Fitting slope to </span><span class="si">%d</span><span class="s2"> channels (largestGroup=</span><span class="si">%d</span><span class="s2">,nchan*</span><span class="si">%.1f</span><span class="s2">=</span><span class="si">%.1f</span><span class="s2">,selectedChannels=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">largestGroup</span><span class="p">,</span> <span class="n">minBWFraction</span><span class="p">,</span> <span class="n">nchan</span><span class="o">*</span><span class="n">minBWFraction</span><span class="p">,</span> <span class="n">selectedChannels</span><span class="p">))</span>
                <span class="n">fitResult</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">fitResult</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sFC_factor</span> <span class="o">&gt;=</span> <span class="mf">1.5</span> <span class="ow">and</span> <span class="n">maxTrim</span><span class="o">==</span><span class="n">maxTrimDefault</span> <span class="ow">and</span> <span class="n">trimChannels</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
                <span class="c1">#                 add these &#39;and&#39; cases on July 20, 2016</span>
                <span class="c1"># Do not restore if we have modified maxTrim.  This prevents breaking up an FDM</span>
                <span class="c1"># spectrum with no line detection into multiple smaller continuum windows.</span>
                <span class="n">sigmaFindContinuum</span> <span class="o">/=</span> <span class="n">sFC_factor</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Restoring sigmaFindContinuum to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">))</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">quadraticFitTest</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removing quadratic = </span><span class="si">%g</span><span class="s2">*(x-</span><span class="si">%f</span><span class="s2">)**2 + </span><span class="si">%g</span><span class="s2">*(x-</span><span class="si">%f</span><span class="s2">) + </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">order2</span><span class="p">,</span><span class="n">xoffset</span><span class="p">,</span><span class="n">slope</span><span class="p">,</span><span class="n">xoffset</span><span class="p">,</span><span class="n">intercept</span><span class="p">))</span>
                <span class="n">myx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span> <span class="o">-</span> <span class="n">xoffset</span>
                <span class="n">priorMad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
                <span class="n">trialSpectrum</span> <span class="o">=</span> <span class="n">avgSpectrumNansReplaced</span> <span class="o">+</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">myx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">order2</span> <span class="o">+</span> <span class="n">myx</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
                <span class="n">postMad</span> <span class="o">=</span>  <span class="n">MAD</span><span class="p">(</span><span class="n">trialSpectrum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">postMad</span> <span class="o">&gt;</span> <span class="n">priorMad</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;MAD of spectrum got worse after quadratic removal: </span><span class="si">%f</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">. Switching to linear fit.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorMad</span><span class="p">,</span> <span class="n">postMad</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Fitting slope to </span><span class="si">%d</span><span class="s2"> channels (largestGroup=</span><span class="si">%d</span><span class="s2">,nchan*</span><span class="si">%.1f</span><span class="s2">=</span><span class="si">%.1f</span><span class="s2">,selectedChannels=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">largestGroup</span><span class="p">,</span> <span class="n">minBWFraction</span><span class="p">,</span> <span class="n">nchan</span><span class="o">*</span><span class="n">minBWFraction</span><span class="p">,</span> <span class="n">selectedChannels</span><span class="p">))</span>
                    <span class="n">fitResult</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
                    <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">fitResult</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minSlopeToRemove</span><span class="p">):</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removing slope = </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">))</span>
                        <span class="c1"># Do not remove the offset in order to avoid putting spectrum near zero</span>
                        <span class="n">avgSpectrumNansReplaced</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)))</span><span class="o">*</span><span class="n">slope</span>
                        <span class="n">slopeRemoved</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">avgSpectrumNansReplaced</span> <span class="o">=</span> <span class="n">trialSpectrum</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;MAD of spectrum improved after quadratic removal:  </span><span class="si">%f</span><span class="s2"> to </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">priorMad</span><span class="p">,</span> <span class="n">postMad</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">slopeRemoved</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">lineStrengthFactor</span> <span class="o">&lt;</span> <span class="mf">1.2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sigmaFindContinuumMode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">)</span> <span class="ow">or</span> <span class="n">sigmaFindContinuum</span> <span class="o">&lt;</span> <span class="mf">3.5</span><span class="p">:</span>  <span class="c1"># was 4</span>
                            <span class="n">sigmaFindContinuum</span> <span class="o">+=</span> <span class="mf">0.5</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;lineStrengthFactor = </span><span class="si">%f</span><span class="s2"> &lt; 1.2 (increasing sigmaFindContinuum by 0.5 to </span><span class="si">%.1f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">sigmaFindContinuum</span><span class="p">))</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;lineStrengthFactor = </span><span class="si">%f</span><span class="s2"> &lt; 1.2 (but not increasing sigmaFindContinuum by 0.5 because it is TDM or already &gt;=4)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineStrengthFactor</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;lineStrengthFactor = </span><span class="si">%f</span><span class="s2"> &lt; 1.2 (but not increasing sigmaFindContinuum by 0.5 because it is not &#39;auto&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineStrengthFactor</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;lineStrengthFactor = </span><span class="si">%f</span><span class="s2"> &gt;= 1.2&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineStrengthFactor</span><span class="p">))</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minSlopeToRemove</span><span class="p">):</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removing slope = </span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope</span><span class="p">))</span>
                    <span class="n">avgSpectrumNansReplaced</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)))</span><span class="o">*</span><span class="n">slope</span>
                    <span class="n">slopeRemoved</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">rerun</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># The following helped deliver more continuum bandwidth for HD_142527 spw3, but</span>
            <span class="c1"># it harmed 2013.1.00518 13co (and probably others) by including wing emission.</span>
            <span class="c1"># if trimChannels == &#39;auto&#39;:   # prevent overzealous trimming  July 20, 2016</span>
            <span class="c1">#     maxTrim = maxTrimDefault # prevent overzealous trimming  July 20, 2016</span>
            <span class="n">discardSlopeResult</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>   <span class="c1"># this is only relevant in Cycle 4 and 5; not used by mom0mom8jointMask</span>
                <span class="n">fCCiteration</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> 
                                               <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> 
                                               <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> 
                                               <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="p">,</span> <span class="n">fitResult</span><span class="p">,</span> 
                                               <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="n">negativeThresholdFactor</span><span class="p">,</span> 
                                               <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="n">dropBaselineChannels</span><span class="p">,</span>
                                               <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="n">madRatioUpperLimit</span><span class="p">,</span> 
                                               <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="n">madRatioLowerLimit</span><span class="p">,</span> 
                                               <span class="n">projectCode</span><span class="o">=</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="n">fCCiteration</span><span class="p">,</span>
                                               <span class="n">signalRatioTier1</span><span class="o">=</span><span class="n">signalRatioTier1</span><span class="p">,</span> 
                                               <span class="n">signalRatioTier2</span><span class="o">=</span><span class="n">signalRatioTier2</span><span class="p">,</span>
                                               <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span>
                                               <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="n">enableRejectNarrowInnerWindows</span><span class="p">,</span> 
                                               <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="n">useUncorrectedMedian</span><span class="p">,</span>
                                               <span class="n">returnBluePoints</span><span class="o">=</span><span class="n">returnBluePoints</span><span class="p">,</span>
                                               <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="n">removeOutlierBaselineChannels</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="n">useBaseline</span><span class="p">)</span>

                <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span><span class="p">,</span><span class="n">spectralDiff</span><span class="p">,</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="p">,</span> <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">RangesDropped</span> <span class="o">+=</span> <span class="n">rangesDropped</span>

                <span class="c1"># If we had only one group and only added one or two more group after removing slope, and the</span>
                <span class="c1"># smallest is small compared to the original group, then discard the new solution.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">previousResult</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">counts</span> <span class="o">=</span> <span class="n">countChannelsInRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">counts</span><span class="p">))</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">):</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;*** Restoring result prior to linfit because </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> &lt; 0.2***&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">counts</span><span class="p">)))</span>
                        <span class="n">discardSlopeResult</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">continuumChannels</span><span class="p">,</span><span class="n">selection</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">groups</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">lineStrengthFactor</span><span class="p">,</span><span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span><span class="n">allGroupsAboveSFC</span> <span class="o">=</span> <span class="n">previousResult</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">channelFractionForSlopeRemoval</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No slope fit attempted because selected channels (</span><span class="si">%d</span><span class="s2">) &lt; </span><span class="si">%.2f</span><span class="s2"> * nchan(</span><span class="si">%d</span><span class="s2">) or other criteria not met&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selectedChannels</span><span class="p">,</span><span class="n">channelFractionForSlopeRemoval</span><span class="p">,</span><span class="n">nchan</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;  largestGroup=</span><span class="si">%d</span><span class="s2"> &lt;= nchan*</span><span class="si">%.1f</span><span class="s2">=</span><span class="si">%.1f</span><span class="s2"> or selections=</span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">largestGroup</span><span class="p">,</span><span class="n">minBWFraction</span><span class="p">,</span><span class="n">nchan</span><span class="o">*</span><span class="n">minBWFraction</span><span class="p">,</span><span class="n">selections</span><span class="p">,</span><span class="n">maxSelections</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No slope fit attempted because channelFractionForSlopeRemoval &gt;= 1&quot;</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">madOfPointsBelowThreshold</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">avoidance</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1"># Here we are relying on continuumChannels to match the selection string, so double-check to be sure</span>
        <span class="k">if</span> <span class="n">selection</span> <span class="o">!=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;THERE IS A MISMATCH BETWEEN selection AND continuumChannels!!!&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;selection: &quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;continuumChannels: &quot;</span><span class="p">,</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">))</span>
        <span class="n">avoidChannels</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">avoidance</span><span class="p">)</span>
        <span class="n">newContinuumChannels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">avoidChannels</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%d</span><span class="s2"> channels from list due to avoidance regions&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">newContinuumChannels</span><span class="p">)))</span>
        <span class="n">continuumChannels</span> <span class="o">=</span> <span class="n">newContinuumChannels</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
    
    <span class="c1">#########################################</span>
    <span class="c1"># Plot the results (before returning)</span>
    <span class="c1">#########################################</span>
    <span class="n">labelDescs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9&#39;</span><span class="p">:</span> 
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ax1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">replaceNans</span><span class="p">:</span>
        <span class="n">avgspectrumAboveThreshold</span> <span class="o">=</span> <span class="n">avgSpectrumNansReplaced</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">avgspectrumAboveThreshold</span> <span class="o">=</span> <span class="n">avgSpectrumNansRemoved</span>
    <span class="c1"># I have co-opted the edgesUsed field in the meanSpectrum text file to</span>
    <span class="c1"># hold the numberOfPixelsInMask for the mom0mom8jointMask method, so its </span>
    <span class="c1"># value will be unpredictable, so we test for the method name too.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">edgesUsed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> 
        <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">):</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">))),</span> 
                <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="n">drawYlabel</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">typeOfMeanSpectrum</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span>
                   <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">,</span> <span class="n">normalized</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># The upper edge is not used and can have an upward spike</span>
        <span class="c1"># so don&#39;t show it.</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not showing final </span><span class="si">%d</span><span class="s2"> channels of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skipchan</span><span class="p">,</span>\
               <span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)))</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span><span class="o">-</span><span class="n">skipchan</span><span class="p">)),</span> 
                <span class="n">avgspectrumAboveThreshold</span><span class="p">[:</span><span class="o">-</span><span class="n">skipchan</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="n">drawYlabel</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">typeOfMeanSpectrum</span><span class="p">,</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span> 
                   <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1"># The lower edge channels are not used and the threshold mean can </span>
        <span class="c1"># have an upward spike, so don&#39;t show the first channel inward from </span>
        <span class="c1"># there.</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not showing first </span><span class="si">%d</span><span class="s2"> channels of </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skipchan</span><span class="p">,</span>\
                                   <span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)))</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">skipchan</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">))),</span>
                <span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">skipchan</span><span class="p">:],</span> <span class="s1">&#39;r-&#39;</span><span class="p">)</span>
        <span class="n">drawYlabel</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">typeOfMeanSpectrum</span><span class="p">,</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">meanSpectrumThreshold</span><span class="p">,</span> 
                   <span class="n">peakFilterFWHM</span><span class="p">,</span> <span class="n">fontsize</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">useThresholdWithMask</span><span class="p">)</span>

    <span class="n">highDynamicRange</span> <span class="o">=</span> <span class="n">setYLimitsAvoidingEdgeChannels</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">mad</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">baselineModeA</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
        <span class="n">nEdgeChannels</span> <span class="o">=</span> <span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nEdgeChannels</span><span class="p">)),</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">[:</span><span class="n">nEdgeChannels</span><span class="p">],</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">edgesUsed</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="n">nEdgeChannels</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)),</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="o">-</span><span class="n">nEdgeChannels</span><span class="p">:],</span> <span class="s1">&#39;m-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotBaselinePoints</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">allBaselineChannelsXY</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;b.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plotQuadraticPoints</span> <span class="ow">and</span> <span class="n">rmStatContQuadratic</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">channelsFit</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">channelsFit</span><span class="p">],</span> <span class="s1">&#39;g.&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">MAX_RANGES_FOR_IMMOMENTS</span> <span class="ow">and</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;6.5.3&#39;</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">cutSomeNarrowRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="c1"># protect against CAS-13894</span>
    <span class="n">channelSelections</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Drawing positive threshold at </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threshold</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">threshold</span><span class="p">,</span><span class="n">threshold</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
    <span class="n">ylims</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">threshold</span><span class="p">])])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negativeThreshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Drawing negative threshold at </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">negativeThreshold</span><span class="p">))</span>
        <span class="n">ylims</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">negativeThreshold</span><span class="p">]),</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Drawing observed median as dashed line at </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">median</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">median</span><span class="p">,</span><span class="n">median</span><span class="p">],</span> <span class="s1">&#39;b--&#39;</span><span class="p">)</span>  <span class="c1"># observed median (always lower than true for mode=&#39;min&#39;)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Drawing inferredMedian as solid line at </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianTrue</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">channelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="n">cyanLevel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">channelList</span><span class="p">])</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Drawing median of selection ranges as dotted cyan line at </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cyanLevel</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="p">[</span><span class="n">cyanLevel</span><span class="p">,</span><span class="n">cyanLevel</span><span class="p">],</span> <span class="s1">&#39;c:&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">baselineModeB</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">nEdgeChannels</span><span class="p">,</span> <span class="n">nEdgeChannels</span><span class="p">],</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(),</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">nchan</span><span class="o">-</span><span class="n">nEdgeChannels</span><span class="p">,</span> <span class="n">nchan</span><span class="o">-</span><span class="n">nEdgeChannels</span><span class="p">],</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(),</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">continuumChannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">labelDescs</span> <span class="o">=</span> <span class="n">plotChannelSelections</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> 
                           <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">skipchan</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> 
                           <span class="n">threshold</span><span class="p">,</span> <span class="n">secondSelectionAdded</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fitsTable</span> <span class="ow">or</span> <span class="n">img</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">meanSpectrumFile</span>
        <span class="n">freqType</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freqType</span> <span class="o">=</span> <span class="n">getFreqType</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">titleText</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">narrowString</span> <span class="o">=</span> <span class="n">pickNarrowString</span><span class="p">(</span><span class="n">narrow</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">narrowValueModified</span><span class="p">)</span> 
        <span class="n">trimString</span> <span class="o">=</span> <span class="n">pickTrimString</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">projectCode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">projectCode</span> <span class="o">+=</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">titleText</span> <span class="o">=</span> <span class="n">projectCode</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">transition</span>
    <span class="n">ylim</span> <span class="o">=</span> <span class="n">ExpandYLimitsForLegend</span><span class="p">()</span>
    <span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">titlesize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">fontsize</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">fontsize</span><span class="o">*</span><span class="mf">100.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">titleText</span><span class="p">)))])</span>
    <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">):</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="s1">&#39;TDM&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="s1">&#39;FDM&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">spw</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;(Spw </span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1"> Channels (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">dm</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">singleContinuum</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SingleCont &#39;</span> <span class="o">+</span> <span class="n">label</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Channels (</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dm</span><span class="p">,</span><span class="n">nchan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">singleContinuum</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;(SingleContinuum) &#39;</span> <span class="o">+</span> <span class="n">label</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">750</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">1500</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">3000</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">200</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9.9&#39;</span><span class="p">:</span>
        <span class="n">titleYoffset</span> <span class="o">=</span> <span class="mf">1.10</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">titleYoffset</span> <span class="o">=</span> <span class="mf">1.08</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">titleYoffset</span><span class="p">,</span> <span class="n">titleText</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">titlesize</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
<span class="c1">#  The following line seems to have zero effect.</span>
<span class="c1">#    ax1.yaxis.set_major_formatter(matplotlib.ticker.FormatStrFormatter(&#39;%.2e&#39;))</span>
    <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax1</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">ax2</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">firstFreq</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span><span class="n">lastFreq</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">)</span>
    <span class="n">freqRange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lastFreq</span><span class="o">-</span><span class="n">firstFreq</span><span class="p">)</span>
    <span class="n">power</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freqRange</span><span class="p">))</span><span class="o">-</span><span class="mi">9</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">))</span>
    <span class="n">numberOfTicks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">visibleTicks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mytick</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">mytick</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">&gt;=</span> <span class="n">firstFreq</span> <span class="ow">and</span> <span class="n">mytick</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">&lt;=</span> <span class="n">lastFreq</span><span class="p">:</span>
            <span class="n">numberOfTicks</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">visibleTicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mytick</span><span class="p">)</span>
<span class="c1">#    numberOfTicks = len(ax2.get_xticks()) # this is not reliable</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting major locator to </span><span class="si">%f</span><span class="s2"> GHz, yielding </span><span class="si">%d</span><span class="s2"> visible major ticks: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">,</span> <span class="n">numberOfTicks</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">visibleTicks</span><span class="p">)))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">numberOfTicks</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">))</span>
        <span class="n">numberOfTicks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">visibleTicks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mytick</span> <span class="ow">in</span> <span class="n">ax2</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mytick</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">&gt;=</span> <span class="n">firstFreq</span> <span class="ow">and</span> <span class="n">mytick</span><span class="o">*</span><span class="mf">1e9</span> <span class="o">&lt;=</span> <span class="n">lastFreq</span><span class="p">:</span>
                <span class="n">numberOfTicks</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">visibleTicks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mytick</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting major locator to </span><span class="si">%f</span><span class="s2"> GHz to get </span><span class="si">%d</span><span class="s2"> visible major ticks: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">,</span> <span class="n">numberOfTicks</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">visibleTicks</span><span class="p">)))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">))</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">aggregateBandwidth</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">channelWidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">channelWidthString</span> <span class="o">=</span> <span class="s1">&#39;, chanwidth: </span><span class="si">%.2f</span><span class="s1"> kHz, BW: </span><span class="si">%g</span><span class="s1"> MHz, contBW: </span><span class="si">%.2f</span><span class="s1"> MHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channelWidth</span><span class="o">*</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">spwBandwidth</span><span class="o">*</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">aggregateBandwidth</span><span class="o">*</span><span class="mi">1000</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;=</span> <span class="n">NBIN_THRESHOLD</span><span class="p">:</span>
            <span class="n">channelWidthString</span> <span class="o">+=</span> <span class="s1">&#39;, iPoM=</span><span class="si">%.1f</span><span class="s1">, nbin=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">channelWidthString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="c1">#    if (spw != &#39;&#39;):</span>
<span class="c1">#        upperXlabel = r&#39;$\bf{%s\/Freq.\/(GHz)}$&#39; % (str(spw), freqType) + channelWidthString</span>
<span class="c1">#    else:</span>
    <span class="n">upperXlabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\bf{</span><span class="si">%s</span><span class="s1">\/Freq.\/(GHz)}$&#39;</span> <span class="o">%</span> <span class="n">freqType</span> <span class="o">+</span> <span class="n">channelWidthString</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">upperXlabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span> <span class="c1"># this artist cannot be removed in CASA 5.6</span>
    <span class="n">inc</span> <span class="o">=</span> <span class="mf">0.03</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span> <span class="ow">and</span> <span class="n">rmStatContQuadratic</span><span class="p">):</span>
        <span class="n">bottomLegend</span> <span class="o">=</span> <span class="s1">&#39;rm quad: </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channelsFit</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">initialQuadraticRemoved</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">=</span> <span class="s2">&quot;rm quad: mad improve: </span><span class="si">%.1f</span><span class="s2">&gt;</span><span class="si">%.1f</span><span class="s2">, &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span><span class="n">initialQuadraticImprovementThreshold</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">madRatio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">+=</span> <span class="s2">&quot;peak/MAD: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, signalRatio: </span><span class="si">%.3f</span><span class="s2">, madRatio: </span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakOverMad</span><span class="p">,</span><span class="n">peakMinusMedianOverMad</span><span class="p">,</span><span class="n">mom0peakOverMad</span><span class="p">,</span><span class="n">mom8peakOverMad</span><span class="p">,</span><span class="n">signalRatio</span><span class="p">,</span><span class="n">madRatio</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">useMiddleChannels</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">+=</span> <span class="s2">&quot;peak/MAD: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, signalRatio: </span><span class="si">%.3f</span><span class="s2">, middle chans used&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakOverMad</span><span class="p">,</span><span class="n">peakMinusMedianOverMad</span><span class="p">,</span><span class="n">mom0peakOverMad</span><span class="p">,</span><span class="n">mom8peakOverMad</span><span class="p">,</span><span class="n">signalRatio</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">+=</span> <span class="s2">&quot;peak/MAD: </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, </span><span class="si">%.2f</span><span class="s2">, signalRatio: </span><span class="si">%.3f</span><span class="s2">, madRatio not computed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakOverMad</span><span class="p">,</span><span class="n">peakMinusMedianOverMad</span><span class="p">,</span><span class="n">mom0peakOverMad</span><span class="p">,</span><span class="n">mom8peakOverMad</span><span class="p">,</span><span class="n">signalRatio</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="n">bottomLegend</span> <span class="o">+=</span> <span class="s1">&#39;, pixMom8=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInMom8Mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bottomLegend</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.01</span><span class="p">,</span><span class="n">bottomLegend</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">effectiveSigma</span> <span class="o">=</span> <span class="n">sigmaFindContinuum</span><span class="o">*</span><span class="n">correctionFactor</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;bl=(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">), sCube=</span><span class="si">%.1f</span><span class="s1">, sigmaEff=</span><span class="si">%.2f</span><span class="s1">*</span><span class="si">%.2f</span><span class="s1">=</span><span class="si">%.2f</span><span class="s1">, trim=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baselineModeA</span><span class="p">,</span><span class="n">baselineModeB</span><span class="p">,</span><span class="n">sigmaCube</span><span class="p">,</span><span class="n">sigmaFindContinuum</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">effectiveSigma</span><span class="p">,</span><span class="n">trimString</span><span class="p">),</span><span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="s1">&#39; baselineModeB=</span><span class="si">%s</span><span class="s1">, sFC=</span><span class="si">%.2f</span><span class="s1">*</span><span class="si">%.2f</span><span class="s1">=</span><span class="si">%.2f</span><span class="s1">, trim=</span><span class="si">%s</span><span class="s1">, sdrBW=</span><span class="si">%s</span><span class="s1">, maxBase=</span><span class="si">%.0f</span><span class="s1">m&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">baselineModeB</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">,</span> <span class="n">effectiveSigma</span><span class="p">,</span> <span class="n">trimString</span><span class="p">,</span> <span class="n">spectralDynamicRangeString</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">),</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="n">peakFeatureSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span>
    <span class="n">maxPeakFeatureSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">peak</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span><span class="o">/</span><span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
<span class="c1">#    casalogPost(&quot;initial peakFeatureSigma = (%f-%f)/%f = %f, maxPeakFeatureSigma=%f&quot; % (peak,medianTrue,mad,peakFeatureSigma,maxPeakFeatureSigma))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="n">signalRatioTier1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="n">signalRatioTier2</span> <span class="ow">and</span> <span class="n">peakOverMad</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">))</span> <span class="ow">and</span> <span class="n">peakFeatureSigma</span> <span class="o">&gt;</span> <span class="n">maxPeakFeatureSigma</span><span class="p">:</span>
        <span class="n">mad</span> <span class="o">*=</span> <span class="n">peakFeatureSigma</span><span class="o">/</span><span class="n">maxPeakFeatureSigma</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Limiting peakFeatureSigma from </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">, reset MAD to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFeatureSigma</span><span class="p">,</span><span class="n">maxPeakFeatureSigma</span><span class="p">,</span><span class="n">mad</span><span class="p">))</span>
        <span class="n">peakFeatureSigma</span> <span class="o">=</span> <span class="n">maxPeakFeatureSigma</span>
        <span class="n">areaString</span> <span class="o">=</span> <span class="s1">&#39;limited max: </span><span class="si">%.1f</span><span class="s1">*mad=</span><span class="si">%.4f</span><span class="s1">; </span><span class="si">%d</span><span class="s1"> ranges; &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFeatureSigma</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelSelections</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;maxPeakFeatureSigma=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxPeakFeatureSigma</span><span class="p">))</span>
        <span class="n">areaString</span> <span class="o">=</span> <span class="s1">&#39;max: </span><span class="si">%.1f</span><span class="s1">*mad=</span><span class="si">%.4f</span><span class="s1">; </span><span class="si">%d</span><span class="s1"> ranges; &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFeatureSigma</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelSelections</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fullLegend</span><span class="p">):</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;rms=MAD*1.4826: of baseline chans = </span><span class="si">%f</span><span class="s1">, scaled by </span><span class="si">%.1f</span><span class="s1"> for all chans = </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mad</span><span class="p">,</span><span class="n">correctionFactor</span><span class="p">,</span><span class="n">mad</span><span class="o">*</span><span class="n">correctionFactor</span><span class="p">),</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.017</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;lineStrength factor: </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lineStrengthFactor</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.983</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;MAD*1.4826: of points below upper dotted line = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">madOfPointsBelowThreshold</span><span class="p">),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;median: of </span><span class="si">%d</span><span class="s1"> baseline chans = </span><span class="si">%f</span><span class="s1">, offset by </span><span class="si">%.1f</span><span class="s1">*MAD for all chans = </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span><span class="n">medianCorrectionFactor</span><span class="p">,</span><span class="n">medianTrue</span><span class="o">-</span><span class="n">median</span><span class="p">),</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;chans&gt;median: </span><span class="si">%d</span><span class="s1"> (sum=</span><span class="si">%.4f</span><span class="s1">), chans&lt;median: </span><span class="si">%d</span><span class="s1"> (sum=</span><span class="si">%.4f</span><span class="s1">), ratio: </span><span class="si">%.2f</span><span class="s1"> (</span><span class="si">%.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">channelsAboveMedian</span><span class="p">,</span><span class="n">sumAboveMedian</span><span class="p">,</span><span class="n">channelsBelowMedian</span><span class="p">,</span><span class="n">sumBelowMedian</span><span class="p">,</span><span class="n">channelRatio</span><span class="p">,</span><span class="n">sumRatio</span><span class="p">),</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negativeThreshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;narrow=</span><span class="si">%s</span><span class="s1">, mad: </span><span class="si">%.3g</span><span class="s1">; levs: </span><span class="si">%.3g</span><span class="s1">, </span><span class="si">%.3g</span><span class="s1"> (dot); median: </span><span class="si">%.3g</span><span class="s1"> (solid), medmin: </span><span class="si">%.3g</span><span class="s1"> (dash) cyan: </span><span class="si">%.3g</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">narrowString</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span><span class="n">negativeThreshold</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">cyanLevel</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="s1">&#39;narrow=</span><span class="si">%s</span><span class="s1">, mad: </span><span class="si">%.3g</span><span class="s1">; threshold: </span><span class="si">%.3g</span><span class="s1"> (dot); median: </span><span class="si">%.3g</span><span class="s1"> (solid), medmin: </span><span class="si">%.3g</span><span class="s1"> (dash) cyan: </span><span class="si">%.3g</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">narrowString</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">threshold</span><span class="p">,</span><span class="n">medianTrue</span><span class="p">,</span><span class="n">median</span><span class="p">,</span><span class="n">cyanLevel</span><span class="p">),</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pbBasedMask</span><span class="p">:</span>
            <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;pixels in pb-based mask: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInJointMask</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> pixels in pb-based mask: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">regionsPruned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># some regions were pruned</span>
                <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;pixels in pruned mask: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInJointMask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;pixels in joint mask: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInJointMask</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> pixels in joint mask: </span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">))</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;mean over area: (unknown)&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;mean over area: whole field (</span><span class="si">%.2f</span><span class="s1">Mpix)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">megapixels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">areaString</span> <span class="o">+=</span> <span class="s1">&#39;mean over: central box of radius </span><span class="si">%.1f</span><span class="s1">&quot; (</span><span class="si">%.2f</span><span class="s1">Mpix)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">centralArcsec</span><span class="p">,</span><span class="n">megapixels</span><span class="p">)</span>
    <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span><span class="n">areaString</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">+</span><span class="n">difSNRFontsizeAdjust</span><span class="p">)</span>
    <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethodMessage</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9.9&#39;</span><span class="p">:</span>
            <span class="n">msmm_ylabel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.12</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msmm_ylabel</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.10</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="n">msmm_ylabel</span><span class="p">,</span><span class="n">meanSpectrumMethodMessage</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
        
    <span class="n">finalLine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">percentagePixelsNotMasked</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">finalLine</span> <span class="o">+=</span> <span class="s1">&#39;mask=</span><span class="si">%s</span><span class="s1"> (</span><span class="si">%.2f%%</span><span class="s1"> pixels)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">percentagePixelsNotMasked</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalLine</span> <span class="o">+=</span> <span class="s1">&#39;mask=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.99</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="n">finalLine</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">finalLine</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slope</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">discardSlopeResult</span><span class="p">:</span>
            <span class="n">discarded</span> <span class="o">=</span> <span class="s1">&#39; (result discarded)&#39;</span>
        <span class="k">elif</span> <span class="n">slopeRemoved</span><span class="p">:</span>
            <span class="n">discarded</span> <span class="o">=</span> <span class="s1">&#39; (removed)&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">discarded</span> <span class="o">=</span> <span class="s1">&#39; (not removed)&#39;</span>
        <span class="k">if</span> <span class="n">quadraticFitTest</span><span class="p">:</span>
            <span class="n">finalLine</span> <span class="o">+=</span> <span class="s1">&#39;quadratic fit: </span><span class="si">%g</span><span class="s1">*(x-</span><span class="si">%g</span><span class="s1">)**2+</span><span class="si">%g</span><span class="s1">*(x-</span><span class="si">%g</span><span class="s1">)+</span><span class="si">%g</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">order2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">xoffset</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">xoffset</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">intercept</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">discarded</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalLine</span> <span class="o">+=</span> <span class="s1">&#39;linear slope: </span><span class="si">%g</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">roundFigures</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">discarded</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c1">#   This is the line to use to put the legend in the top group of lines.</span>
<span class="c1">#    pl.text(0.5, 0.99-i*inc, finalLine, transform=ax1.transAxes, ha=&#39;center&#39;, size=fontsize)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">finalLine</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> 
            <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

    <span class="n">gigabytes</span> <span class="o">=</span> <span class="n">getMemorySize</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">regressionTest</span><span class="p">:</span>
        <span class="c1"># Write CVS version to plot legend</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.06</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">version</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> 
                <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
        <span class="c1"># Write CASA version to plot legend</span>
        <span class="n">casaText</span> <span class="o">=</span> <span class="s2">&quot;CASA &quot;</span><span class="o">+</span><span class="n">casaVersion</span><span class="o">+</span><span class="s1">&#39; (</span><span class="si">%.0f</span><span class="s1"> GB&#39;</span><span class="o">%</span><span class="n">gigabytes</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casaText</span> <span class="o">=</span> <span class="s1">&#39;(</span><span class="si">%.0f</span><span class="s1"> GB&#39;</span> <span class="o">%</span> <span class="n">gigabytes</span>
    <span class="n">byteLimit</span> <span class="o">=</span> <span class="n">byteLimit</span><span class="o">/</span><span class="p">(</span><span class="mf">1024.</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxMemory</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">byteLimit</span> <span class="o">==</span> <span class="n">gigabytes</span><span class="p">:</span>
        <span class="n">casaText</span> <span class="o">+=</span> <span class="s1">&#39;)&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casaText</span> <span class="o">+=</span> <span class="s1">&#39;, but limited to </span><span class="si">%.0f</span><span class="s1">GB)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">byteLimit</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.03</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.005</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">inc</span><span class="p">,</span> <span class="n">casaText</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">plotAtmosphere</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">img</span> <span class="o">!=</span> <span class="n">meanSpectrumFile</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">plotAtmosphere</span> <span class="o">==</span> <span class="s1">&#39;tsky&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;tsky&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;transmission&#39;</span>
        <span class="n">freqs</span><span class="p">,</span> <span class="n">atm</span> <span class="o">=</span> <span class="n">CalcAtmTransmissionForImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">airmass</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;freqs: min=</span><span class="si">%g</span><span class="s2">, max=</span><span class="si">%g</span><span class="s2"> n=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)))</span>
        <span class="n">atmRange</span> <span class="o">=</span> <span class="mf">0.5</span>  <span class="c1"># how much of the y-axis should it take up</span>
        <span class="n">yrange</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;transmission&#39;</span><span class="p">):</span>
            <span class="n">atmRescaled</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">yrange</span> <span class="o">+</span> <span class="n">atm</span><span class="o">*</span><span class="n">atmRange</span><span class="o">*</span><span class="n">yrange</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;atmRescaled: min=</span><span class="si">%f</span><span class="s2">, max=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">atmRescaled</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">atmRescaled</span><span class="p">)))</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.015</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;0%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.015</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.03</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s1">&#39;Atmospheric Transmission&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">yt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.81</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="n">xtickTrans</span><span class="p">,</span><span class="n">ytickTrans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.01</span><span class="p">],[</span><span class="n">yt</span><span class="p">,</span><span class="n">yt</span><span class="p">]])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">xtickTrans</span><span class="p">,</span><span class="n">ytickTrans</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atmRescaled</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">yrange</span> <span class="o">+</span> <span class="n">atm</span><span class="o">*</span><span class="n">atmRange</span><span class="o">*</span><span class="n">yrange</span><span class="o">/</span><span class="mf">300.</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.015</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.015</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;300&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.03</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s1">&#39;Sky temperature (K)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                    <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">yt</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.81</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="n">xtickTrans</span><span class="p">,</span><span class="n">ytickTrans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.01</span><span class="p">],[</span><span class="n">yt</span><span class="p">,</span><span class="n">yt</span><span class="p">]])</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span><span class="n">xtickTrans</span><span class="p">,</span><span class="n">ytickTrans</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">line</span><span class="o">.</span><span class="n">set_clip_on</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.06</span><span class="p">,</span> <span class="mf">0.55</span><span class="p">,</span> <span class="s1">&#39;(</span><span class="si">%.1f</span><span class="s1"> mm PWV, 1.5 airmass)&#39;</span><span class="o">%</span><span class="n">pwv</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> 
                <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax1</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="c1">#        pl.plot(freqs, atmRescaled, &#39;w.&#39;, ms=0)  # need this to finalize the ylim value</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="n">yrange</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;transmission&#39;</span><span class="p">):</span>
            <span class="n">atmRescaled</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">yrange</span> <span class="o">+</span> <span class="n">atm</span><span class="o">*</span><span class="n">atmRange</span><span class="o">*</span><span class="n">yrange</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atmRescaled</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.3</span><span class="o">*</span><span class="n">yrange</span> <span class="o">+</span> <span class="n">atm</span><span class="o">*</span><span class="n">atmRange</span><span class="o">*</span><span class="n">yrange</span><span class="o">/</span><span class="mf">300.</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">atmRescaled</span><span class="p">,</span> <span class="s1">&#39;m-&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>  <span class="c1"># restore the prior value (needed for CASA 5.0)</span>

    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TkAgg&#39;</span> <span class="ow">and</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9&#39;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span> <span class="c1"># critical for TkAgg in CASA 6, or else set_fig_size never takes effect!</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pngBasename</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="n">amendMaskIterationName</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">png</span><span class="p">))</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">transition</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">transition</span>
        <span class="n">narrowString</span> <span class="o">=</span> <span class="n">pickNarrowString</span><span class="p">(</span><span class="n">narrow</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">narrowValueModified</span><span class="p">)</span> <span class="c1"># this is used later</span>
        <span class="n">trimString</span> <span class="o">=</span> <span class="n">pickTrimString</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">),</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;=</span> <span class="n">NBIN_THRESHOLD</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.nbin</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">userJointMask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.meanSpectrum.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%.2f</span><span class="s1">sigma.narrow</span><span class="si">%s</span><span class="s1">.trim</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="p">,</span> <span class="n">baselineModeA</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">narrowString</span><span class="p">,</span> <span class="n">trimString</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">userJointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.amendedJointMask&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.meanSpectrum.amendedJointMask.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%.2f</span><span class="s1">sigma.narrow</span><span class="si">%s</span><span class="s1">.trim</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baselineModeA</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">narrowString</span><span class="p">,</span> <span class="n">trimString</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.meanSpectrum.userJointMask.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%.2f</span><span class="s1">sigma.narrow</span><span class="si">%s</span><span class="s1">.trim</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">baselineModeA</span><span class="p">,</span> <span class="n">baselineModeB</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">narrowString</span><span class="p">,</span> <span class="n">trimString</span><span class="p">,</span> <span class="n">transition</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">maxMemory</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.</span><span class="si">%.0f</span><span class="s1">GB&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxMemory</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.overwriteTrue.png&#39;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># change the following to &#39;.png&#39; after my test of July 20, 2016</span>
            <span class="n">png</span> <span class="o">+=</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">pngdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pngdir</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">pngdir</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">pngdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pngdir</span> <span class="o">!=</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No permission to write to specified directory: </span><span class="si">%s</span><span class="s2">. Will try alternateDirectory.&quot;</span> <span class="o">%</span> <span class="n">pngdir</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alternateDirectory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">alternateDirectory</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">png</span> <span class="o">=</span> <span class="n">alternateDirectory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
        <span class="n">pngdir</span> <span class="o">=</span> <span class="n">alternateDirectory</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;png = &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">pngdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">)):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No permission to write to alternateDirectory. Will not save the plot.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Wrote png = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">png</span><span class="p">))</span>
    <span class="n">donetime</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2"> sec elapsed in runFindContinuum&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">donetime</span><span class="o">-</span><span class="n">startTime</span><span class="p">))</span>
    <span class="n">baselineMAD</span> <span class="o">=</span> <span class="n">mad</span>
    <span class="k">if</span> <span class="n">amendMaskIterationName</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.extraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.onlyExtraMask&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower&#39;</span><span class="p">,</span><span class="s1">&#39;.autoLower2&#39;</span><span class="p">]:</span>
        <span class="c1"># go back to original figure now</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> 
           <span class="n">selectionPreBluePruning</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> 
           <span class="n">labelDescs</span><span class="p">,</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">areaString</span><span class="p">,</span> <span class="n">RangesDropped</span><span class="p">,</span> <span class="n">effectiveSigma</span><span class="p">,</span> <span class="n">baselineMAD</span><span class="p">,</span> <span class="n">upperXlabel</span><span class="p">,</span>
           <span class="n">allBaselineChannelsXY</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">negativeThreshold</span><span class="p">)</span></div>

<span class="c1"># end of runFindContinuum    </span>
<span class="c1">#                    [avgSpectrumNansReplaced, normalized, numberPixelsInJointMask, pbBasedMask, initialQuadraticRemoved, initialQuadraticImprovementRatio, mom0snrs, mom8snrs, regionsPruned, numberPixelsInMom8Mask, mom0peak, mom8peak, jointMask, nbin, initialPeakOverMad] = result</span>

<div class="viewcode-block" id="invertChannelRanges">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.invertChannelRanges">[docs]</a>
<span class="k">def</span> <span class="nf">invertChannelRanges</span><span class="p">(</span><span class="n">invertstring</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">startchan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                        <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a CASA channel selection string and inverts it.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myspw</span> <span class="o">=</span> <span class="n">spw</span>
    <span class="n">checkForMultipleSpw</span> <span class="o">=</span> <span class="n">invertstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">mystring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vis</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">checkForMultipleSpw</span><span class="p">)):</span>
      <span class="n">checkspw</span> <span class="o">=</span> <span class="n">checkForMultipleSpw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">checkspw</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spw</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
          <span class="n">spw</span> <span class="o">=</span> <span class="n">checkspw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="n">checkForMultipleSpw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">checkspw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">vis</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
          <span class="n">nchan</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">))</span>
<span class="c1">#          print &quot;Setting nchan = %d for spw %s&quot; % (nchan,str(spw))</span>
      <span class="n">goodstring</span> <span class="o">=</span> <span class="n">checkForMultipleSpw</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
      <span class="n">goodranges</span> <span class="o">=</span> <span class="n">goodstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
          <span class="n">mystring</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">goodranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">startchan</span><span class="p">):</span>
          <span class="n">mystring</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startchan</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">goodranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
      <span class="n">multiWindows</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">goodranges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">r</span> <span class="o">=</span> <span class="n">goodranges</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
          <span class="n">s</span> <span class="o">=</span> <span class="n">goodranges</span><span class="p">[</span><span class="n">g</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
          <span class="n">mystring</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
          <span class="n">multiWindows</span> <span class="o">=</span> <span class="kc">True</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodranges</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
              <span class="n">mystring</span> <span class="o">+=</span> <span class="n">separator</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">goodranges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">startchan</span><span class="o">+</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">multiWindows</span><span class="p">):</span>
              <span class="n">mystring</span> <span class="o">+=</span> <span class="n">separator</span>
          <span class="n">mystring</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">goodranges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">startchan</span><span class="o">+</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">checkForMultipleSpw</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
          <span class="n">mystring</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>
      <span class="n">spw</span> <span class="o">=</span> <span class="n">myspw</span>  <span class="c1"># reset to the initial value</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vis</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span></div>


<div class="viewcode-block" id="plotChannelSelections">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.plotChannelSelections">[docs]</a>
<span class="k">def</span> <span class="nf">plotChannelSelections</span><span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> 
                          <span class="n">skipchan</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> 
                          <span class="n">threshold</span><span class="p">,</span> <span class="n">secondSelectionAdded</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lineColor</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    avgspectrumAboveThreshold: computed in runFindContinuum</span>
<span class="sd">    medianTrue, threshold: computed by findContinuumChannels</span>
<span class="sd">    Returns labelDescs: list of plot artists that may be removed and replaced later</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">labelDescs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channelSelections</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
<span class="c1">#    ylevel = np.mean(avgspectrumAboveThreshold) # Cycle 0-5 heuristic</span>
    <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">[</span><span class="n">skipchan</span><span class="p">:</span><span class="o">-</span><span class="n">skipchan</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">peak</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="o">*</span><span class="p">(</span><span class="n">threshold</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">):</span>
        <span class="n">ylevel</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">+</span> <span class="p">(</span><span class="n">threshold</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">peak</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">threshold</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting cyan level (</span><span class="si">%f</span><span class="s2">) to just above the positive threshold dotted line&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ylevel</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylevel</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">threshold</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting cyan level to half the positive threshold dotted line&quot;</span><span class="p">)</span>
    <span class="n">yoffset</span> <span class="o">=</span> <span class="n">ylevel</span> <span class="o">+</span> <span class="mf">0.04</span><span class="o">*</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">pl</span><span class="o">.</span><span class="n">ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ccstring</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channelSelections</span><span class="p">):</span> 
        <span class="n">cc</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ccstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
        <span class="c1"># length of cc will always be at least 2</span>
        <span class="n">mywidth</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># can be 0 or larger</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mywidth</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span> 
<span class="c1">#            print(&quot;Widening cyan line by %d: &quot; % (2-mywidth))</span>
            <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="n">mywidth</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">-</span><span class="n">mywidth</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span>
            <span class="n">mylw</span> <span class="o">=</span> <span class="mf">1.33</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mylw</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="p">))</span><span class="o">*</span><span class="n">ylevel</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lineColor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">mylw</span><span class="p">)</span>
        <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
        <span class="n">mystring</span> <span class="o">=</span> <span class="n">ccstring</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">secondSelectionAdded</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="c1"># indicate if the heuristic for CAS-11720 was activated to ensure a second region</span>
            <span class="n">mystring</span> <span class="o">+=</span> <span class="s1">&#39; added&#39;</span>
        <span class="n">labelDesc</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cc</span><span class="p">),</span> <span class="n">yoffset</span><span class="p">,</span> <span class="n">mystring</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">labelDescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labelDesc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">labelDescs</span></div>


<div class="viewcode-block" id="findWidestContiguousListInOtherHalf">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findWidestContiguousListInOtherHalf">[docs]</a>
<span class="k">def</span> <span class="nf">findWidestContiguousListInOtherHalf</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">lowerHalf</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of channels, find the longest contiguous list in the first half or second half</span>
<span class="sd">    example:</span>
<span class="sd">    CASA &lt;43&gt;: fc.findWidestContiguousListInOtherHalf([2,3,7,8,9,12,13,14,15], True, 20)</span>
<span class="sd">    Out[43]: [12, 13, 14, 15]</span>
<span class="sd">    channels: list of blue points channel numbers</span>
<span class="sd">    lowerHalf: a Boolean (True for lower half, False for upper half)</span>
<span class="sd">    nchan: total channels in spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contiguousLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span>
    <span class="n">mylengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widestList</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">widestListLength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">contiguousList</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contiguousLists</span><span class="p">):</span>
        <span class="n">mylengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lowerHalf</span> <span class="ow">and</span> <span class="n">contiguousList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">lowerHalf</span> <span class="ow">and</span> <span class="n">contiguousList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contiguousList</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">widestListLength</span><span class="p">:</span>
            <span class="n">widestListLength</span> <span class="o">=</span> <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">widestList</span> <span class="o">=</span> <span class="n">contiguousList</span>
    <span class="k">return</span> <span class="n">widestList</span></div>


<div class="viewcode-block" id="findChannelsInChannelRangeWithComparableIntensity">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findChannelsInChannelRangeWithComparableIntensity">[docs]</a>
<span class="k">def</span> <span class="nf">findChannelsInChannelRangeWithComparableIntensity</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">channelRange</span><span class="p">,</span> <span class="n">continuumChannels</span><span class="p">,</span>
                                                      <span class="n">intensity</span><span class="p">,</span> <span class="n">withinSigma</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Finds channels in a portion of the spectrum (intensity) whose intensity is </span>
<span class="sd">    within the range of intensities of the blue points (channels) by some sigma</span>
<span class="sd">    beyond the min and max.</span>
<span class="sd">    channels: list of blue points channel numbers</span>
<span class="sd">    intensity: intensity of whole spectrum (an array)</span>
<span class="sd">    channelRange: range of channels to look for widest set of blue points [first,final]</span>
<span class="sd">    continuumChannels: current selection of continuuum channels</span>
<span class="sd">    withinSigma: fix for PIPE-2188</span>
<span class="sd">    Returns: a list of channels, possibly non-contiguous, sorted low to high</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">imin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">channels</span><span class="p">])</span>
    <span class="n">imax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">channels</span><span class="p">])</span>
    <span class="n">newList</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1">#    sigma = np.std(intensity[channels])  fc &lt;= v7.16</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">[</span><span class="n">channels</span><span class="p">])</span>   <span class="c1"># fc v7.17</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">channelRange</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">channelRange</span><span class="p">[</span><span class="mi">1</span><span class="p">])):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imin</span><span class="o">-</span><span class="n">withinSigma</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">intensity</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">imax</span><span class="o">+</span><span class="n">withinSigma</span><span class="o">*</span><span class="n">sigma</span><span class="p">):</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">imax</span><span class="o">-</span><span class="n">intensity</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="n">intensity</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">-</span><span class="n">imin</span><span class="p">])</span><span class="o">/</span><span class="n">sigma</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Channel </span><span class="si">%d</span><span class="s1"> is within </span><span class="si">%.1f</span><span class="s1"> scaled MAD of nearest blue point intensity&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">distance</span><span class="p">))</span>
            <span class="n">newList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="c1">#    newLists = splitListIntoContiguousLists(sorted(newList))</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">newList</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="findWidestContiguousListInChannelRange">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findWidestContiguousListInChannelRange">[docs]</a>
<span class="k">def</span> <span class="nf">findWidestContiguousListInChannelRange</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">channelRange</span><span class="p">,</span> <span class="n">continuumChannels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a list of channels, find the longest contiguous list in the first half or second half</span>
<span class="sd">    example:</span>
<span class="sd">    CASA &lt;43&gt;: fc.findWidestContiguousListInChannelRange([2,3,7,8,9,12,13,14,15], [10,20], [7,8,9])</span>
<span class="sd">    Out[43]: [12, 13, 14, 15]</span>
<span class="sd">    channels: list of blue points channel numbers</span>
<span class="sd">    channelRange: range of channels to look for widest set of blue points</span>
<span class="sd">    continuumChannels: current selection of continuuum channels</span>
<span class="sd">    Returns: a list of contiguous channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contiguousLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span>
    <span class="n">currentRange</span> <span class="o">=</span> <span class="n">continuumChannels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">continuumChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">mylengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">widestList</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">widestListLength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">startchan</span><span class="p">,</span> <span class="n">endchan</span> <span class="o">=</span> <span class="n">channelRange</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">contiguousList</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contiguousLists</span><span class="p">):</span>
        <span class="n">mylengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">contiguousList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">startchan</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">contiguousList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">endchan</span><span class="p">):</span>
            <span class="n">spreadFactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">contiguousList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">continuumChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">continuumChannels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">contiguousList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">currentRange</span>
            <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">contiguousList</span><span class="p">)</span> <span class="o">*</span> <span class="n">spreadFactor</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Possible region: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%d</span><span class="s1">*</span><span class="si">%f</span><span class="s1"> = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contiguousList</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">contiguousList</span><span class="p">),</span> <span class="n">spreadFactor</span><span class="p">,</span> <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">widestListLength</span><span class="p">:</span>
            <span class="n">widestListLength</span> <span class="o">=</span> <span class="n">mylengths</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">widestList</span> <span class="o">=</span> <span class="n">contiguousList</span>
    <span class="k">return</span> <span class="n">widestList</span></div>


<div class="viewcode-block" id="aboveBelow">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.aboveBelow">[docs]</a>
<span class="k">def</span> <span class="nf">aboveBelow</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Given an array of values (i.e. a spectrum) and a threshold value, this </span>
<span class="sd">    function computes and returns 6 items: </span>
<span class="sd">    * the number of channels above that threshold (group 1)</span>
<span class="sd">    * the number of channels below that threshold (group 2)</span>
<span class="sd">    * the ratio of these numbers (i.e., #ChanAboveThreshold / #ChanBelowThreshold))</span>
<span class="sd">    * sum of the intensities in group (1)    </span>
<span class="sd">    * sum of the intensities in group (2)</span>
<span class="sd">    * the ratio of these sums  (i.e., FluxAboveThreshold / FluxBelowThreshold)</span>
<span class="sd">      (This value is not currently used by the calling function.)</span>
<span class="sd">      Example with 24 channels where 3 have positive spikes, and rest are zero:</span>
<span class="sd">                       3      2      3        channelsAbove = 3</span>
<span class="sd">     +threshold=+1 ........................   sumAbove = (3-1) + (2-1) + (3-1) = 5    </span>
<span class="sd">           zero ---------------------------   channelsBelow = 21</span>
<span class="sd">     -threshold=-1 ........................   sumBelow = 21*(1-0) = 21</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">avgSpectrumNansReplaced</span>
    <span class="n">aboveMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">belowMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">sumAboveMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">threshold</span><span class="o">+</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">aboveMedian</span><span class="p">])</span>
    <span class="n">sumBelowMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">threshold</span><span class="o">-</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">belowMedian</span><span class="p">])</span>
    <span class="n">channelsAboveMedian</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aboveMedian</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">channelsBelowMedian</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">belowMedian</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">channelRatio</span> <span class="o">=</span> <span class="n">channelsAboveMedian</span><span class="o">*</span><span class="mf">1.0</span><span class="o">/</span><span class="n">channelsBelowMedian</span>
    <span class="n">sumRatio</span> <span class="o">=</span> <span class="n">sumAboveMedian</span><span class="o">/</span><span class="n">sumBelowMedian</span>  <span class="c1"># this value is unused by the calling function</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sumAboveMedian</span><span class="p">,</span> <span class="n">sumBelowMedian</span><span class="p">,</span> <span class="n">sumRatio</span><span class="p">,</span> 
           <span class="n">channelsAboveMedian</span><span class="p">,</span> <span class="n">channelsBelowMedian</span><span class="p">,</span> <span class="n">channelRatio</span><span class="p">)</span></div>


<div class="viewcode-block" id="writeMeanSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.writeMeanSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">avgspectrum</span><span class="p">,</span> 
                      <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                      <span class="n">nanmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrum.</span>
<span class="sd">    Writes out the mean spectrum (and the key parameters used to create it), </span>
<span class="sd">    so that it can quickly be restored.  This allows the manual user to quickly </span>
<span class="sd">    experiment with different parameters of findContinuumChannels applied to </span>
<span class="sd">    the same mean spectrum.</span>
<span class="sd">    Units are Hz and Jy/beam.</span>
<span class="sd">    meanSpectrumFile: name of file to create</span>
<span class="sd">    threshold: this is interpreted as mom0threshold for meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">    edgesUsed: this is interpreted as numberPixelsInMask for meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">    nanmin:    this is interpreted as mom8threshold for meanSpectrumMethod=&#39;mom0mom8jointMask&#39;</span>
<span class="sd">    frequency: list or array of frequencies</span>
<span class="sd">    Returns: None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: blank name requested for meanSpectrumFile!!&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">:</span>
        <span class="n">field1</span> <span class="o">=</span> <span class="s1">&#39;mom0threshold&#39;</span>
        <span class="n">field2</span> <span class="o">=</span> <span class="s1">&#39;numberPixelsInMask&#39;</span>
        <span class="n">field4</span> <span class="o">=</span> <span class="s1">&#39;mom8threshold&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">field1</span> <span class="o">=</span> <span class="s1">&#39;threshold&#39;</span>
        <span class="n">field2</span> <span class="o">=</span> <span class="s1">&#39;edgesUsed&#39;</span>
        <span class="n">field4</span> <span class="o">=</span> <span class="s1">&#39;nanmin&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> nchan </span><span class="si">%s</span><span class="s1"> centralArcsec=</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field1</span><span class="p">,</span><span class="n">field2</span><span class="p">,</span><span class="n">field4</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="n">mask</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#threshold edgesUsed nchan nanmin centralArcsec=auto </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">centralArcsec</span><span class="p">),</span><span class="n">mask</span><span class="p">))</span>
    <span class="c1">#                                field1      field2           field4</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1"> </span><span class="si">%g</span><span class="s1"> </span><span class="si">%g</span><span class="s1"> </span><span class="si">%.10f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">))</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#chan freq(Hz) avgSpectrum avgSpectrumNansReplaced</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">)):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%.1f</span><span class="s1"> </span><span class="si">%.10f</span><span class="s1"> </span><span class="si">%.10f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">frequency</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">avgspectrum</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Wrote </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="findContinuumChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findContinuumChannels">[docs]</a>
<span class="k">def</span> <span class="nf">findContinuumChannels</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                          <span class="n">nanmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">baselineMode</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span>
                          <span class="n">narrow</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> 
                          <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="n">peakOverMad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fitResult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                          <span class="n">maxGroupsForMaxTrimAdjustment</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">lowHighBaselineThreshold</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                          <span class="n">lineSNRThreshold</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">negativeThresholdFactor</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> 
                          <span class="n">dropBaselineChannels</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">madRatioUpperLimit</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
                          <span class="n">madRatioLowerLimit</span><span class="o">=</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">projectCode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                          <span class="n">signalRatioTier1</span><span class="o">=</span><span class="mf">0.965</span><span class="p">,</span> <span class="n">signalRatioTier2</span><span class="o">=</span><span class="mf">0.94</span><span class="p">,</span> <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> 
                          <span class="n">enableRejectNarrowInnerWindows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">useUncorrectedMedian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">returnBluePoints</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">removeOutlierBaselineChannels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">amendMaskIterationName</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useBaseline</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Trys to find continuum channels in a spectrum, based on a threshold or</span>
<span class="sd">    some number of edge channels and their median and standard deviation.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    spectrum: a one-dimensional array of intensity values</span>
<span class="sd">    nBaselineChannels: number of channels over which to compute standard deviation/MAD</span>
<span class="sd">    sigmaFindContinuum: value to multiply the standard deviation by then add </span>
<span class="sd">      to median to get threshold.  Default = 3.  </span>
<span class="sd">    narrow: the minimum number of channels in a contiguous block to accept </span>
<span class="sd">            if 0&lt;narrow&lt;1, then it is interpreted as the fraction of all</span>
<span class="sd">                           channels within identified blocks</span>
<span class="sd">    nanmin: the value that NaNs were replaced by in previous steps</span>
<span class="sd">    baselineMode: &#39;min&#39; or &#39;edge&#39;,  &#39;edge&#39; will use nBaselineChannels/2 from each edge</span>
<span class="sd">    trimChannels: if integer, use that number of channels.  If float between</span>
<span class="sd">      0 and 1, then use that fraction of channels in each contiguous list</span>
<span class="sd">      (rounding up). If &#39;auto&#39;, then use 0.1 but not more than maxTrim channels.</span>
<span class="sd">      The &#39;auto&#39; mode can also cause trimChannels to be set to 13 or 6 in certain</span>
<span class="sd">      circumstances (when moderately strong lines are present).</span>
<span class="sd">    maxTrim: if trimChannels=&#39;auto&#39;, this is the max channels to trim per group for TDM spws; it is automatically scaled upward for FDM spws.</span>
<span class="sd">    maxTrimFraction: in trimChannels=&#39;auto&#39;, the max fraction of channels to trim per group</span>
<span class="sd">    separator: the character to use to separate groups of channels in the string returned</span>
<span class="sd">    negativeThresholdFactor: scale the nominal negative threshold by this factor (to adjust </span>
<span class="sd">        sensitivity to absorption features: smaller values=more sensitive)</span>
<span class="sd">    dropBaselineChannels: percentage of extreme values to drop in baseline mode &#39;min&#39;</span>
<span class="sd">    madRatioUpperLimit, madRatioLowerLimit: if ratio of MADs (MAD of all baseline channels / </span>
<span class="sd">        MAD of baseline channels with extreme channels dropped) is between these values, then</span>
<span class="sd">        apply dropBaselineChannels when defining the MAD of the baseline range</span>
<span class="sd">    fitResult: coefficients from linear or quadratic fit, only relevant when meanSpectrumMethod is</span>
<span class="sd">             not &#39;mom0mom8jointMask&#39;</span>
<span class="sd">    signalRatioTier1: threshold for signalRatio, above which we desensitize the level to</span>
<span class="sd">        consider line emission in order to avoid small differences in noise levels from </span>
<span class="sd">        affecting the result (e.g. that occur between serial and parallel tclean cubes)</span>
<span class="sd">        signalRatio=1 means: no lines seen, while closer to zero: more lines seen</span>
<span class="sd">    signalRatioTier2: second threshold for signalRatio, used for FDM spws (nchan&gt;192) and</span>
<span class="sd">        for cases of peakOverMad &lt; 5.  Should be &lt; signalRatioTier1.</span>
<span class="sd">    sigmaFindContinuumMode: if &#39;auto&#39;, then do not desensitize with signalRatioTier1</span>
<span class="sd">    removeOutlierBaselineChannels: after dropBaselineChannels, remove &gt;4*scMAD </span>
<span class="sd">        outliers;  options: &#39;high&#39;, &#39;low&#39;, &#39;both&#39;/True, or &#39;&#39; which means none/False</span>
<span class="sd">    returnBluePoints: if True, then simply set the continuum ranges to the baseline points </span>
<span class="sd">         (i.e. the blue points) instead of what the other heuristics might have found</span>
<span class="sd">    useBaseline: &#39;low&#39;, &#39;middle&#39;, &#39;high&#39; or &#39;auto&#39;; auto tries to automatically pick &#39;low&#39; for</span>
<span class="sd">       spectra that are emission-line dominated, &#39;high&#39; if absorption line dominated, or &#39;both&#39; if</span>
<span class="sd">       both types of lines are present</span>

<span class="sd">    Returns:</span>
<span class="sd">    1  list of channels to use (separated by the specified separator)</span>
<span class="sd">    2  list converted to ms channel selection syntax</span>
<span class="sd">    3  positive threshold used</span>
<span class="sd">    4  median of the baseline-defining channels</span>
<span class="sd">    5  number of groups found</span>
<span class="sd">    6  correctionFactor used</span>
<span class="sd">    7  inferred true median</span>
<span class="sd">    8  scaled MAD of the baseline-defining channels</span>
<span class="sd">    9  correction factor applied to get the inferred true median</span>
<span class="sd">    10 negative threshold used</span>
<span class="sd">    11 lineStrength factor</span>
<span class="sd">    12 singleChannelPeaksAboveSFC: how many cases where only a single channel exceeds the threshold </span>
<span class="sd">    13 allGroupsAboveSFC</span>
<span class="sd">    14 spectralDiff (percentage of median)</span>
<span class="sd">    15 value of trimChannels parameter</span>
<span class="sd">    16 Boolean describing whether the low values were used as the baseline</span>
<span class="sd">    17 value of the narrow parameter</span>
<span class="sd">    18 tuple containing the channel numbers of the baseline channels, and their respective y-axis values</span>
<span class="sd">    19 value of madRatio: MAD/MAD_after_dropping_extreme_channels</span>
<span class="sd">         This value will be larger if there are many tall single channel peaks.</span>
<span class="sd">    20 number of ranges it dropped (or would have dropped if it was enabled)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fitResult</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">myx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitResult</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">myx</span> <span class="o">-=</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">originalSpectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">+</span> <span class="p">(</span><span class="n">fitResult</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">myx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">myx</span> <span class="o">+</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">-</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;min/max spectrum = </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectrum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
            <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;min/max originalSpectrum = </span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">originalSpectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">+</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">myx</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">originalSpectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">narrow</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">narrow</span> <span class="o">=</span> <span class="n">pickNarrow</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
        <span class="n">autoNarrow</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">autoNarrow</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">npts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="n">percentile</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">nBaselineChannels</span><span class="o">/</span><span class="n">npts</span>
    <span class="n">correctionFactor</span> <span class="o">=</span> <span class="n">sigmaCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
    <span class="n">sigmaEffective</span> <span class="o">=</span> <span class="n">sigmaFindContinuum</span><span class="o">*</span><span class="n">correctionFactor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fitResult</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fitResult</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;****** starting findContinuumChannels (</span><span class="si">%d</span><span class="s2">) (polynomial=</span><span class="si">%g</span><span class="s2">*(x-</span><span class="si">%.2f</span><span class="s2">)**2+</span><span class="si">%g</span><span class="s2">*(x-</span><span class="si">%.2f</span><span class="s2">)+</span><span class="si">%g</span><span class="s2">) ***********&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;****** starting findContinuumChannels (</span><span class="si">%d</span><span class="s2">) (slope=</span><span class="si">%g</span><span class="s2">) ***********&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span> <span class="n">fitResult</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;****** starting findContinuumChannels (</span><span class="si">%d</span><span class="s2">) with nBaselineChannels=</span><span class="si">%d</span><span class="s2"> ***********&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span><span class="n">nBaselineChannels</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigmaFindContinuum=</span><span class="si">%.2f</span><span class="s2">, sigmaEffective=</span><span class="si">%.1f</span><span class="s2">, percentile=</span><span class="si">%.0f</span><span class="s2"> for mode=</span><span class="si">%s</span><span class="s2">, channels=</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">sigmaEffective</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">baselineMode</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
        <span class="c1"># pick n channels on both edges</span>
        <span class="n">lowerChannels</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">upperChannels</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">lowerChannels</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">upperChannels</span><span class="p">)</span>
        <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> \
                               <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span> <span class="o">-</span> <span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">lowerChannels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">upperChannels</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">upperChannels</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;edge method: Dropping lower channels from median and std calculations&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">upperChannels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">lowerChannels</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">lowerChannels</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;edge method: Dropping upper channels from median and std calculations&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
        <span class="n">useLowBaseline</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Pick the n channels with the n lowest values (or highest if those </span>
        <span class="c1"># have smallest MAD), but ignore edge channels inward for as long they </span>
        <span class="c1"># are identical to themselves (i.e. avoid the</span>
        <span class="c1"># effect of TDM edge flagging.)</span>
        <span class="n">myspectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
        <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">)))</span>
        <span class="c1"># the following could also be len(spectrum), since their lengths are identical</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span> <span class="c1"># and len(originalSpectrum) &lt;= 128):</span>
            <span class="c1"># Was opened up to all data (not just TDM) in Cycle 6</span>
            <span class="c1"># picks up some continuum in self-absorbed area in Cha-MMs1_CS in 200-channel spw</span>
            <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                <span class="c1"># ALMA Cycle 4+5</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">originalSpectrum</span> <span class="o">!=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">originalSpectrum</span> <span class="o">!=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ALMA Cycle 6 onward</span>
                <span class="n">edgeValuedChannels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">originalSpectrum</span> <span class="o">==</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">originalSpectrum</span> <span class="o">==</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">edgeValuedChannelsLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">edgeValuedChannels</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;edgeValuedChannelsLists: &quot;</span><span class="p">,</span> <span class="n">edgeValuedChannelsLists</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">edgeValuedChannelsLists</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">edgeValuedChannelsLists</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">myspectrum</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Avoided </span><span class="si">%d</span><span class="s1"> edge channels of </span><span class="si">%d</span><span class="s1"> when computing min channels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;using channels </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">allBaselineXChannelsOriginal</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span>

        <span class="c1"># Sort by intensity: myspectrum is often only a subset of spectrum, so</span>
        <span class="c1"># the channel numbers in original spectrum must be tracked separately</span>
        <span class="c1"># in the variable: allBaselineXChannels</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">)</span>
        <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="p">]]</span> 
        <span class="n">allBaselineOriginalChannels</span> <span class="o">=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="p">]]</span>
        <span class="n">highestChannels</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">:]]</span>  
        <span class="n">medianOfAllChannels</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">)</span>
        <span class="n">mad0</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
        <span class="n">mad1</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">highestChannels</span><span class="p">)</span>
        <span class="n">middleChannels</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">nBaselineChannels</span><span class="p">:</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">]]</span>
        <span class="n">madMiddleChannels</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">middleChannels</span><span class="p">)</span>
        <span class="c1"># added useBaseline as a top-level parameter on June 20, 2023</span>
        <span class="k">if</span> <span class="n">useBaseline</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="n">amendMaskIterationName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xtra&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">amendMaskIterationName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;autoLower&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># to not conflict with 46 lines down</span>
            <span class="c1"># Introduced the lowHighBaselineThreshold factor on Aug 31, 2016 for CAS-8938</span>
            <span class="n">whichBaseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">([</span><span class="n">mad0</span><span class="p">,</span> <span class="n">lowHighBaselineThreshold</span><span class="o">*</span><span class="n">mad1</span><span class="p">,</span> <span class="n">lowHighBaselineThreshold</span><span class="o">*</span><span class="n">madMiddleChannels</span><span class="p">])</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Using automatic heuristic of useBaseline = </span><span class="si">%s</span><span class="s1">, which picked whichBaseline=</span><span class="si">%d</span><span class="s1"> because mads: </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">, </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">useBaseline</span><span class="p">,</span><span class="n">whichBaseline</span><span class="p">,</span><span class="n">mad0</span><span class="p">,</span> <span class="n">lowHighBaselineThreshold</span><span class="o">*</span><span class="n">mad1</span><span class="p">,</span> <span class="n">lowHighBaselineThreshold</span><span class="o">*</span><span class="n">madMiddleChannels</span><span class="p">))</span>
            <span class="n">leftmostHighChannel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">:])</span>
            <span class="n">rightmostHighChannel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">:])</span>
            <span class="n">noBluePointInterruptsHighestChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">leftmostHighChannel</span><span class="p">,</span><span class="n">rightmostHighChannel</span><span class="p">),</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">whichBaseline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noBluePointInterruptsHighestChannels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">noBluePointInterruptsHighestChannels</span> <span class="ow">and</span> <span class="n">whichBaseline</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;No blue point interrupts the sequence of highest channels, so this signifies an emission line, and we will useBaseline=low instead of high.&#39;</span><span class="p">)</span>
                <span class="n">useBaseline</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">whichBaseline</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">useBaseline</span> <span class="o">=</span> <span class="s1">&#39;high&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">madMiddleChannels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">useBaseline</span> <span class="o">=</span> <span class="s1">&#39;middle&#39;</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># fix for PRTSPR-50321</span>
                    <span class="n">useBaseline</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;***** Using manual setting of useBaseline = </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">useBaseline</span><span class="p">))</span>
            
        <span class="c1"># In the following if/elif/else, we convert the tri-valued variable useBaseline into two</span>
        <span class="c1"># Booleans for legacy purposes (i.e before useMiddleChannels was considered as an option).</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">useBaseline</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">):</span>
            <span class="c1"># This is the absorption line case</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Using highest </span><span class="si">%d</span><span class="s2"> channels as baseline because low:mid:high = </span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">nBaselineChannels</span><span class="p">,</span><span class="n">mad0</span><span class="p">,</span><span class="n">madMiddleChannels</span><span class="p">,</span><span class="n">mad1</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">highestChannels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reversed it so that first channel is highest value</span>
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">:]</span>
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># reversed it so that first channel is highest value</span>
            <span class="n">mad0</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">useLowBaseline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">useMiddleChannels</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">useBaseline</span> <span class="o">==</span> <span class="s1">&#39;middle&#39;</span><span class="p">:</span>
            <span class="c1"># This case is needed when there is a mix of emission and absorption lines, </span>
            <span class="c1"># as in Band 10 Orion = 2016.1.00970.S spw25,31.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Using middle </span><span class="si">%d</span><span class="s2"> channels as baseline because low:mid:high = </span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">, setting dropBaselineChannels to 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">middleChannels</span><span class="p">),</span><span class="n">mad0</span><span class="p">,</span><span class="n">madMiddleChannels</span><span class="p">,</span><span class="n">mad1</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">middleChannels</span>
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">nBaselineChannels</span><span class="p">:</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">]</span>
            <span class="n">dropBaselineChannels</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mad0</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">useLowBaseline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">useMiddleChannels</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is the emission line case</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> Using lowest </span><span class="si">%d</span><span class="s2"> channels as baseline because low:mid:high = </span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">:</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span><span class="n">nBaselineChannels</span><span class="p">,</span><span class="n">mad0</span><span class="p">,</span><span class="n">madMiddleChannels</span><span class="p">,</span><span class="n">mad1</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">useLowBaseline</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">useMiddleChannels</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span><span class="p">[</span><span class="n">idx</span><span class="p">][:</span><span class="n">nBaselineChannels</span><span class="p">]</span>
<span class="c1">#            allBaselineXChannels = idx[:nBaselineChannels]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">amendMaskIterationName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xtra&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">amendMaskIterationName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;autoLower&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">useMiddleChannels</span><span class="p">:</span>
            <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">middleChannels</span>
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannelsOriginal</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">nBaselineChannels</span><span class="p">:</span><span class="o">-</span><span class="n">nBaselineChannels</span><span class="p">]</span>
            <span class="n">dropBaselineChannels</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mad0</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">useLowBaseline</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">useMiddleChannels</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;***** PL2024: Forcing use of middle channels in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">amendMaskIterationName</span><span class="p">))</span>
            <span class="c1"># This was found to work better on the extra mask construction as positive</span>
            <span class="c1"># features (emission) and negative features (missing flux) are often both present.</span>
            <span class="k">if</span> <span class="n">returnBluePoints</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;***** PL2024: Forcing returnBluePoints=False&#39;</span><span class="p">)</span>
                <span class="n">returnBluePoints</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Median of all channels = </span><span class="si">%f</span><span class="s2">,  MAD of selected baseline channels = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianOfAllChannels</span><span class="p">,</span><span class="n">mad0</span><span class="p">))</span>
        <span class="n">madRatio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dropBaselineChannels</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;dropBaselineChannels is zero, so madRatio will not be computed, and instead set to None&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dropExtremeChannels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">*</span><span class="n">dropBaselineChannels</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;dropExtremeChannels = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dropExtremeChannels</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">dropExtremeChannels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">intensityAllBaselineChannelsDropExtremeChannels</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">dropExtremeChannels</span><span class="p">:</span><span class="n">nBaselineChannels</span><span class="o">+</span><span class="n">dropExtremeChannels</span><span class="p">]]</span> 
                <span class="n">allBaselineXChannelsDropExtremeChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannelsOriginal</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">dropExtremeChannels</span><span class="p">:</span><span class="n">nBaselineChannels</span><span class="o">+</span><span class="n">dropExtremeChannels</span><span class="p">]]</span> 
<span class="c1">#                casalogPost(&#39;intensityAllBaselineChannelsDropExtremeChannels = %s&#39; % str(intensityAllBaselineChannelsDropExtremeChannels))</span>
                <span class="n">mad0_dropExtremeChannels</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannelsDropExtremeChannels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">mad0_dropExtremeChannels</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;mad0_dropExtremeChannels = 0, will set madRatio to None and will not drop any baseline channels.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># prevent division by zero error</span>
                    <span class="n">madRatio</span> <span class="o">=</span> <span class="n">mad0</span><span class="o">/</span><span class="n">mad0_dropExtremeChannels</span>
                    <span class="k">if</span> <span class="n">madRatioLowerLimit</span> <span class="o">&lt;</span> <span class="n">madRatio</span> <span class="o">&lt;</span> <span class="n">madRatioUpperLimit</span><span class="p">:</span>
                        <span class="c1"># more than 1.2 means there was a significant improvement; more than 1.5 means something unexpected about the statistics</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;****** Dropping most extreme </span><span class="si">%d</span><span class="s2"> = </span><span class="si">%.1f%%</span><span class="s2"> of channels when computing the MAD, since it reduces the mad by a factor of x=</span><span class="si">%.2f</span><span class="s2"> (</span><span class="si">%.2f</span><span class="s2">&lt;x&lt;</span><span class="si">%.2f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dropExtremeChannels</span><span class="p">,</span> <span class="n">dropBaselineChannels</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">madRatioUpperLimit</span><span class="p">))</span>
                        <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">intensityAllBaselineChannelsDropExtremeChannels</span>
<span class="c1">#                        print(&quot;len(allBaselineXChannels)=%d, len(idx)=%d, dropExtremeChannels=%d, nBaselineChannels+dropExtremeChannels=%d&quot; % (len(allBaselineXChannels), len(idx), dropExtremeChannels, nBaselineChannels+dropExtremeChannels))</span>
                        <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannelsDropExtremeChannels</span>
                        <span class="n">allBaselineOriginalChannels</span> <span class="o">=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="n">allBaselineXChannelsDropExtremeChannels</span><span class="p">]</span> <span class="c1"># allBaselineXChannels[idx][dropExtremeChannels:nBaselineChannels+dropExtremeChannels]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;**** Not dropping most extreme channels when computing the MAD, since the change in MAD of </span><span class="si">%.2f</span><span class="s2"> is not within </span><span class="si">%.2f</span><span class="s2">&lt;x&lt;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">madRatio</span><span class="p">,</span> <span class="n">madRatioLowerLimit</span><span class="p">,</span> <span class="n">madRatioUpperLimit</span><span class="p">))</span>
            

        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;min method: computing MAD and median of </span><span class="si">%d</span><span class="s2"> channels used as the baseline&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)))</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
        <span class="n">madOriginal</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">allBaselineOriginalChannels</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;MAD of all baseline channels = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mad</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fitResult</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;MAD of original baseline channels (before removal of fit) = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">madOriginal</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mad</span> <span class="o">&lt;</span> <span class="mf">1e-17</span> <span class="ow">or</span> <span class="n">madOriginal</span> <span class="o">&lt;</span> <span class="mf">1e-17</span><span class="p">):</span> 
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;min method: avoiding blocks of identical-valued channels&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                <span class="c1"># first avoid values that propagate from either edge</span>
                <span class="n">myspectrum</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">originalSpectrum</span> <span class="o">!=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">originalSpectrum</span> <span class="o">!=</span> <span class="n">originalSpectrum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))]</span>
                <span class="c1"># next avoid identical zeroes  (PIPE-1213)</span>
                <span class="n">myspectrum</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">myspectrum</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)]</span> <span class="c1"># possible fix for PIPE-1213</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># original logic, prior to linear fit removal</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spectrum</span> <span class="o">!=</span> <span class="n">intensityAllBaselineChannels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">myspectrum</span> <span class="o">=</span> <span class="n">spectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">myspectrum</span><span class="p">)</span>
            <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">myspectrum</span><span class="p">[</span><span class="n">idx</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="p">]]</span> 
            <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nBaselineChannels</span><span class="p">]</span>  <span class="c1"># was commented out in PL2020</span>
<span class="c1">#            for i in range(len(idx)):</span>
<span class="c1">#                casalogPost(&quot;idx[%d] = %d has %.3f&quot; % (i,idx[i],myspectrum[idx[i]]))</span>
<span class="c1">#            casalogPost(&quot;len(allBaselineXChannels)=%d, shape(idx)=%s, nBaselineChannels=%d&quot; % (len(allBaselineXChannels), str(np.shape(idx)), nBaselineChannels))</span>
<span class="c1">#            allBaselineXChannels = allBaselineXChannels[idx][:nBaselineChannels]  # was used in PL2020, caused crash PIPE-1213</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;            computing MAD and median of </span><span class="si">%d</span><span class="s2"> channels used as the baseline&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)))</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;min method: median intensity of </span><span class="si">%d</span><span class="s2"> channels used as the baseline: </span><span class="si">%f</span><span class="s2">, mad: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">),</span> <span class="n">median</span><span class="p">,</span> <span class="n">mad</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">removeOutlierBaselineChannels</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>  
            <span class="c1"># Try this for PL2023</span>
            <span class="n">rOBCsigma</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">removeOutlierBaselineChannels</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">]:</span>  
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">mad</span> <span class="o">&lt;</span> <span class="n">rOBCsigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">removeOutlierBaselineChannels</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]:</span>  
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">intensityAllBaselineChannels</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">mad</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">rOBCsigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">removeOutlierBaselineChannels</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;high&#39;</span><span class="p">]:</span>  
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">intensityAllBaselineChannels</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">/</span> <span class="n">mad</span> <span class="o">&lt;</span> <span class="n">rOBCsigma</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">allBaselineXChannels</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">remainingChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allBaselineXChannels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;not removing outlier baseline channels as it would remove over half of them (</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">remainingChannels</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">allBaselineXChannels</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">removedChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allBaselineXChannels</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;removing </span><span class="si">%d</span><span class="s2"> outlier baseline channels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">removedChannels</span><span class="p">))</span>
                <span class="n">allBaselineXChannels</span> <span class="o">=</span> <span class="n">allBaselineXChannels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">intensityAllBaselineChannels</span> <span class="o">=</span> <span class="n">intensityAllBaselineChannels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;min method: after outlier removal: median intensity of </span><span class="si">%d</span><span class="s2"> channels used as the baseline: </span><span class="si">%f</span><span class="s2">, mad: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">intensityAllBaselineChannels</span><span class="p">),</span> <span class="n">median</span><span class="p">,</span> <span class="n">mad</span><span class="p">))</span>
    <span class="c1"># endif baselineMode==&#39;edge&#39; else &#39;min&#39;</span>
    <span class="c1"># signalRatio will be 1.0 if no lines present and 0.25 if half the channels have lines, etc.</span>
    <span class="n">signalRatio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum</span><span class="o">-</span><span class="n">median</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span><span class="o">*</span><span class="mi">2</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">returnBluePoints</span><span class="p">:</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">allBaselineXChannels</span><span class="p">)</span>
        <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">median</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span> <span class="o">+</span> <span class="n">medianTrue</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="o">-</span><span class="n">negativeThresholdFactor</span><span class="o">*</span><span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span> <span class="o">+</span> <span class="n">medianTrue</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">lineStrengthFactor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">signalRatio</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">singleChannelPeaksAboveSFC</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">allGroupsAboveSFC</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">spectralDiff</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">spectralDiff2</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># prevent crash for undefined variable</span>
        <span class="n">rangesDropped</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># prevent crash for undefined variable</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># not returning blue points</span>
        <span class="k">if</span> <span class="n">signalRatio</span> <span class="o">&gt;=</span> <span class="mf">0.99</span> <span class="ow">or</span> <span class="p">((</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="mf">0.98</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="mi">15</span> <span class="o">&gt;</span> <span class="n">peakOverMad</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)):</span>
            <span class="c1"># If nearly no lines are found, then look a bit deeper to allow the possibility of signalRatio to drop enough to </span>
            <span class="c1"># go below 0.965, and thereby prevent the desensitizing that comes later (see line 2542).</span>
            <span class="n">weakLineFactor</span> <span class="o">=</span> <span class="mf">1.35</span> <span class="c1">#1.39 gives 0.982 on 305  # 1.5 gives 1.0 on 305</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Initial signalRatio: </span><span class="si">%f</span><span class="s2">, peakOverMad=</span><span class="si">%f</span><span class="s2">,  Re-assessing.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signalRatio</span><span class="p">,</span><span class="n">peakOverMad</span><span class="p">))</span>
            <span class="n">signalRatio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum</span><span class="o">-</span><span class="n">median</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span><span class="o">*</span><span class="n">weakLineFactor</span><span class="p">))[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">maxdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">spectrum</span><span class="o">-</span><span class="n">median</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;max(abs(spectrum-median)) = </span><span class="si">%f</span><span class="s2"> while sigmaEffective(</span><span class="si">%f</span><span class="s2">)*mad(</span><span class="si">%f</span><span class="s2">)*</span><span class="si">%.2f</span><span class="s2">=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxdiff</span><span class="p">,</span><span class="n">sigmaEffective</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">weakLineFactor</span><span class="p">,</span><span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span><span class="o">*</span><span class="n">weakLineFactor</span><span class="p">))</span>
        <span class="n">originalMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">)</span>
        <span class="c1"># Should not divide by post-baseline-fit median since it may be close to 0</span>
        <span class="n">spectralDiff</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span><span class="o">/</span><span class="n">originalMedian</span>
        <span class="n">spectralDiff2</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="n">originalMedian</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;signalRatio=</span><span class="si">%f</span><span class="s2">, spectralDiff = </span><span class="si">%f</span><span class="s2"> and spectralDiff2=</span><span class="si">%f</span><span class="s2"> percent of the median&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signalRatio</span><span class="p">,</span> <span class="n">spectralDiff</span><span class="p">,</span><span class="n">spectralDiff2</span><span class="p">))</span>
        <span class="n">lineStrengthFactor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">signalRatio</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">spectralDiff2</span> <span class="o">&lt;</span> <span class="mf">0.65</span> <span class="ow">and</span> <span class="n">npts</span> <span class="o">&gt;</span> <span class="mi">192</span> <span class="ow">and</span> <span class="n">signalRatio</span><span class="o">&lt;</span><span class="n">signalRatioTier2</span><span class="p">):</span>  <span class="c1"># used to be &lt;0.95 but regression 321 has 0.949 so use 0.94</span>
            <span class="c1"># This appears to be a channel-averaged FDM spectrum with lots of real line emission.</span>
            <span class="c1"># So, don&#39;t allow the median to be raised, and reduce the mad to lower the threshold.</span>
            <span class="c1"># page 15: G11.92_B7.ms_spw3 yields spectralDiff2=0.6027</span>
            <span class="c1"># We can also get into here if there is a large slope in the mean spectrum, so we</span>
            <span class="c1"># counter that by removing a linear slope before evaluating lineSNR.</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;The spectral difference (n=2) is rather small, so set signalRatio=0 to reduce the baseline level.&#39;</span><span class="p">,</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">signalRatio</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># note: this slope removal differs from the one in runFindContinuum because</span>
                <span class="c1"># it always acts upon the whole spectrum, not just the potential baseline windows.</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removing linear slope for purposes of computing lineSNR.&quot;</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">MAD</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span>
                <span class="n">newspectrum</span> <span class="o">=</span> <span class="n">spectrum</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="n">slope</span>
                <span class="n">newmad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">newspectrum</span><span class="p">)</span>
                <span class="c1"># Avoid high edge channels from creating false high SNR</span>
                <span class="n">lineSNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">newspectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">newspectrum</span><span class="p">))</span><span class="o">/</span><span class="n">newmad</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Avoid high edge channels from creating false high SNR</span>
                <span class="n">lineSNR</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">median</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;lineSNR = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">lineSNR</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lineSNR</span> <span class="o">&gt;</span> <span class="n">lineSNRThreshold</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;The lineSNR &gt; </span><span class="si">%d</span><span class="s1">, so scaling the mad by 1/3 to reduce the threshold.&#39;</span> <span class="o">%</span> <span class="n">lineSNRThreshold</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">mad</span> <span class="o">*=</span> <span class="mf">0.33</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">trimChannels</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span> 
                    <span class="n">trimChannels</span> <span class="o">=</span> <span class="mi">6</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Setting trimChannels to </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trimChannels</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Not reducing mad by 1/3: npts=</span><span class="si">%d</span><span class="s1">, signalRatio=</span><span class="si">%.3f</span><span class="s1">, spectralDiff2=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npts</span><span class="p">,</span><span class="n">signalRatio</span><span class="p">,</span><span class="n">spectralDiff2</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">useMiddleChannels</span> <span class="ow">or</span> <span class="n">useUncorrectedMedian</span><span class="p">:</span>
            <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">median</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Do not use signalRatio here as the 5th parameter anymore, because we may have set it to zero just above, </span>
            <span class="c1"># but 1/lineStrengthFactor is the same value as before it was set to zero.  Setting it to zero causes</span>
            <span class="c1"># problems on non-hot core FDM, like spw29 of 2015.1.00581.S, uid://A001/X2f6/X16b (CAS-11671).  Not</span>
            <span class="c1"># setting it to zero changes the selection on hot cores, some giving more channels, some giving fewer,</span>
            <span class="c1"># but not drastically either direction.  Largest change is on spw22 of uid://A001/X2f6/X265 (page 245).</span>
            <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">medianCorrected</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> 
                                         <span class="mf">1.0</span><span class="o">/</span><span class="n">lineStrengthFactor</span><span class="p">,</span> <span class="n">useLowBaseline</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">medianTrue</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectrum</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;**** PIPE-525: Corrected median is less than all data points.  Using true median instead.&quot;</span><span class="p">)</span>
                <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>

        <span class="n">peakFeatureSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span><span class="o">-</span><span class="n">medianTrue</span><span class="p">)</span><span class="o">/</span><span class="n">mad</span> 
        <span class="c1"># De-sensitize the threshold in order to avoid small differences in noise levels </span>
        <span class="c1"># (e.g. that occur between serial and parallel tclean cubes)</span>
        <span class="c1"># from producing drastically different continuum selections.</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="n">signalRatioTier1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="n">signalRatioTier2</span> <span class="ow">and</span> <span class="n">peakOverMad</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sigmaFindContinuumMode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="s1">&#39;autolower&#39;</span><span class="p">]):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;findContinuumChannels: desensitizing because </span><span class="si">%f</span><span class="s1">&gt;</span><span class="si">%f</span><span class="s1"> or (</span><span class="si">%f</span><span class="s1">&gt;</span><span class="si">%f</span><span class="s1"> and </span><span class="si">%f</span><span class="s1">&lt;5)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signalRatio</span><span class="p">,</span><span class="n">signalRatioTier1</span><span class="p">,</span><span class="n">signalRatio</span><span class="p">,</span><span class="n">signalRatioTier2</span><span class="p">,</span><span class="n">peakOverMad</span><span class="p">))</span>
            <span class="n">maxPeakFeatureSigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spectrum</span><span class="p">))</span><span class="o">/</span><span class="n">MAD</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">peakFeatureSigma</span> <span class="o">&gt;</span> <span class="n">maxPeakFeatureSigma</span><span class="p">:</span>
                <span class="n">oldmad</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="n">mad</span>
                <span class="n">mad</span> <span class="o">*=</span> <span class="n">peakFeatureSigma</span><span class="o">/</span><span class="n">maxPeakFeatureSigma</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;findContinuumChannels: Limiting peakFeatureSigma from </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">, reset MAD from </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFeatureSigma</span><span class="p">,</span><span class="n">maxPeakFeatureSigma</span><span class="p">,</span><span class="n">oldmad</span><span class="p">,</span><span class="n">mad</span><span class="p">))</span>
                <span class="n">peakFeatureSigma</span> <span class="o">=</span> <span class="n">maxPeakFeatureSigma</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;findContinuumChannels: not limiting peakFeatureSigma because </span><span class="si">%f</span><span class="s1"> &gt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peakFeatureSigma</span><span class="p">,</span><span class="n">maxPeakFeatureSigma</span><span class="p">))</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span> <span class="o">+</span> <span class="n">medianTrue</span>
        <span class="c1"># Use a (default=15%) lower negative threshold to help prevent false identification of absorption features.</span>
        <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="o">-</span><span class="n">negativeThresholdFactor</span><span class="o">*</span><span class="n">sigmaEffective</span><span class="o">*</span><span class="n">mad</span> <span class="o">+</span> <span class="n">medianTrue</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;MAD = </span><span class="si">%f</span><span class="s2">, median = </span><span class="si">%f</span><span class="s2">, trueMedian=</span><span class="si">%f</span><span class="s2">, signalRatio=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mad</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;findContinuumChannels: computed threshold = </span><span class="si">%f</span><span class="s2">, medianTrue=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">medianTrue</span><span class="p">))</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spectrum</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">negativeThreshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">channels2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spectrum</span> <span class="o">&gt;</span> <span class="n">negativeThreshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="n">channels2</span><span class="p">)</span>

        <span class="c1"># for CAS-8059: remove channels that are equal to the minimum if all </span>
        <span class="c1"># channels from it toward the nearest edge are also equal to the minimum: </span>
        <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">)]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1e-10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))):</span>
            <span class="n">lastmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lastmin</span><span class="p">)</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Checking channels </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">)):</span>
                <span class="n">mydiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span>
                <span class="n">mycrit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1e-10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mydiff</span> <span class="o">&gt;</span> <span class="n">mycrit</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">removed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> channels on low channel edge that were at the minimum.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">removed</span><span class="p">))</span>
        <span class="c1"># Now come in from the upper side</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">)]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1e-10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))):</span>
            <span class="n">lastmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lastmin</span><span class="p">)</span>
            <span class="n">removed</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;Checking channels </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">mydiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span>
                <span class="n">mycrit</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="mf">1e-10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">originalSpectrum</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mydiff</span> <span class="o">&gt;</span> <span class="n">mycrit</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
                    <span class="n">channels</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                    <span class="n">removed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> channels on high channel edge that were at the minimum.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">removed</span><span class="p">))</span>
        <span class="n">peakChannels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spectrum</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">peakChannelsLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">peakChannels</span><span class="p">)</span>
        <span class="n">widthOfWidestFeature</span> <span class="o">=</span> <span class="n">maxLengthOfLists</span><span class="p">(</span><span class="n">peakChannelsLists</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Width of widest feature = </span><span class="si">%d</span><span class="s2"> (length spectrum = </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">widthOfWidestFeature</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)))</span>
        <span class="c1"># C4R2 had signalRatio &lt; 0.6 and spectralDiff2 &lt; 1.2 but this yielded only 1 channel </span>
        <span class="c1"># of continuum on NGC6334I spw25 when memory expanded to 256GB.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signalRatio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">signalRatio</span> <span class="o">&lt;</span> <span class="mf">0.925</span> <span class="ow">and</span> <span class="n">spectralDiff2</span> <span class="o">&lt;</span> <span class="mf">1.3</span> <span class="ow">and</span> 
            <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span>  <span class="ow">and</span> <span class="n">trimChannels</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> 
            <span class="n">widthOfWidestFeature</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="p">):</span>
            <span class="c1"># This is meant to prevent rich hot cores from returning only 1</span>
            <span class="c1"># or 2 channels of continuum.  signalRatio&gt;0 is to avoid conflict</span>
            <span class="c1"># with the earlier heuristic above where it is set to zero.</span>
            <span class="n">trimChannels</span> <span class="o">=</span> <span class="mi">13</span>
            <span class="k">if</span> <span class="n">autoNarrow</span><span class="p">:</span>
                <span class="n">narrow</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Setting trimChannels=</span><span class="si">%d</span><span class="s1">, narrow=</span><span class="si">%s</span><span class="s1"> since many lines appear to be present (signalRatio=</span><span class="si">%f</span><span class="s1">).&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trimChannels</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">narrow</span><span class="p">),</span> <span class="n">signalRatio</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Not changing trimChannels from </span><span class="si">%s</span><span class="s1">: signalRatio=</span><span class="si">%f</span><span class="s1">, spectralDiff2=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">),</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">spectralDiff2</span><span class="p">))</span>
            

        <span class="n">peakMultiChannelsLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndRejectNarrow</span><span class="p">(</span><span class="n">peakChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">allGroupsAboveSFC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">peakChannelsLists</span><span class="p">)</span>
        <span class="n">singleChannelPeaksAboveSFC</span> <span class="o">=</span> <span class="n">allGroupsAboveSFC</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">peakMultiChannelsLists</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> potential continuum channels: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">selection</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndRejectZeroStd</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;channels = &quot;</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> channels in </span><span class="si">%d</span><span class="s2"> groups after rejecting zero std: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="n">groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">selection</span><span class="p">)))</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Calling splitListIntoContiguousListsAndTrim(totalChannels=</span><span class="si">%s</span><span class="s2">, channels=</span><span class="si">%s</span><span class="s2">, trimChannels=</span><span class="si">%s</span><span class="s2">, maxTrim=</span><span class="si">%d</span><span class="s2">, maxTrimFraction=</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">),</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">))</span>
                <span class="n">originalChannels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">[:]</span>
                <span class="n">channels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndTrim</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> 
                             <span class="n">trimChannels</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  <span class="c1"># fix for PIPE-359</span>
                    <span class="n">maxTrim</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span> <span class="n">trimChannels</span> <span class="o">=</span> <span class="mi">2</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;WARNING: all potential continuum channels trimmed, which is quite rare.  Reverting to maxTrim=</span><span class="si">%.2f</span><span class="s2"> and trimChannels=</span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxTrim</span><span class="p">,</span><span class="n">trimChannels</span><span class="p">),</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
                    <span class="n">channels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndTrim</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">originalChannels</span><span class="p">,</span> 
                                  <span class="n">trimChannels</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>  
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;WARNING: selection is still blank, skipping trim&#39;</span><span class="p">)</span>
                        <span class="n">channels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">originalChannels</span><span class="p">)</span>
                        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Selection = &#39;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
                <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="n">maxGroupsForMaxTrimAdjustment</span> <span class="ow">and</span> <span class="n">trimChannels</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span>
                    <span class="ow">and</span> <span class="n">maxTrim</span><span class="o">&gt;</span><span class="n">maxTrimDefault</span><span class="p">):</span>
                    <span class="n">maxTrim</span> <span class="o">=</span> <span class="n">maxTrimDefault</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Restoring maxTrim=</span><span class="si">%d</span><span class="s2"> because groups now &gt; </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxTrim</span><span class="p">,</span><span class="n">maxGroupsForMaxTrimAdjustment</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Calling splitListIntoContiguousListsAndTrim(totalChannels=</span><span class="si">%s</span><span class="s2">, channels=</span><span class="si">%s</span><span class="s2">, trimChannels=</span><span class="si">%s</span><span class="s2">, maxTrim=</span><span class="si">%d</span><span class="s2">, maxTrimFraction=</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">npts</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">),</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">))</span>
                    <span class="n">trialChannels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndTrim</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> 
                                 <span class="n">trimChannels</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialChannels</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Zero channels left after trimming. Reverting to prior selection.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">channels</span> <span class="o">=</span> <span class="n">trialChannels</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;channels = &quot;</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
                        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                        <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> groups of channels = &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groups</span><span class="p">),</span> <span class="n">channels</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1">#                if verbose:</span>
    <span class="c1">#                    casalogPost(&quot;Calling splitListIntoContiguousListsAndRejectNarrow(channels=%s, narrow=%s)&quot; % (str(channels), str(narrow)))</span>
    <span class="c1">#                else:</span>
    <span class="c1">#                    casalogPost(&quot;Calling splitListIntoContiguousListsAndRejectNarrow(narrow=%s)&quot; % (str(narrow)))</span>
                    <span class="n">trialChannels</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndRejectNarrow</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trialChannels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">channels</span> <span class="o">=</span> <span class="n">trialChannels</span>
                        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> channels after trimming </span><span class="si">%s</span><span class="s2"> channels and rejecting narrow groups.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">)))</span>
                        <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
                        <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Not rejecting narrow groups since there is only </span><span class="si">%d</span><span class="s2"> group!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> continuum channels in </span><span class="si">%d</span><span class="s2"> groups: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="n">groups</span><span class="p">,</span> <span class="n">selection</span><span class="p">))</span>
        <span class="n">potentialChannels</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">rangesDropped</span> <span class="o">=</span> <span class="n">rejectNarrowInnerWindowsChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enableRejectNarrowInnerWindows</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">potentialChannels</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rangesDropped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;rejectNarrowInnerWindows wanted to remove </span><span class="si">%d</span><span class="s2"> ranges, but it was not enabled&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rangesDropped</span><span class="p">))</span>
    <span class="c1"># endif for the else (i.e., end of returnBluePoints==False)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Final: found </span><span class="si">%d</span><span class="s2"> continuum channels (sFC=</span><span class="si">%.2f</span><span class="s2">) in </span><span class="si">%d</span><span class="s2"> groups: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="n">sigmaFindContinuum</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">selection</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">correctionFactor</span><span class="p">,</span> 
           <span class="n">medianTrue</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">computeMedianCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span><span class="o">*</span><span class="n">signalRatio</span><span class="p">,</span>
           <span class="n">negativeThreshold</span><span class="p">,</span> <span class="n">lineStrengthFactor</span><span class="p">,</span> <span class="n">singleChannelPeaksAboveSFC</span><span class="p">,</span> 
           <span class="n">allGroupsAboveSFC</span><span class="p">,</span> <span class="p">[</span><span class="n">spectralDiff</span><span class="p">,</span> <span class="n">spectralDiff2</span><span class="p">],</span> <span class="n">trimChannels</span><span class="p">,</span> 
           <span class="n">useLowBaseline</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="p">[</span><span class="n">allBaselineXChannels</span><span class="p">,</span><span class="n">intensityAllBaselineChannels</span><span class="p">],</span> 
           <span class="n">madRatio</span><span class="p">,</span> <span class="n">useMiddleChannels</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">)</span></div>


<div class="viewcode-block" id="rejectNarrowInnerWindowsChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.rejectNarrowInnerWindowsChannels">[docs]</a>
<span class="k">def</span> <span class="nf">rejectNarrowInnerWindowsChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">fCCiteration</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    If there are 3-15 groups of channels, then remove any inner window </span>
<span class="sd">    that is narrower than both edge windows.</span>
<span class="sd">    Returns: a list of channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span>
    <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rangesDropped</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#    if (groups &gt; 2 and groups &lt; 8):  C4R2 heuristic</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">groups</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">):</span>  <span class="c1"># Cycle 5 onward</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lenFirstGroup</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lenLastGroup</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start with the first window</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">groups</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">):</span>
            <span class="n">widthFactor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># this is to prevent unnecessarily trimming narrow windows, e.g. in a hot core case</span>
            <span class="n">widthFactor</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="c1"># The final group needs to be included in the output channels list, and it is safe to</span>
        <span class="c1"># simply included it in the loop because it will always pass the test.</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">groups</span><span class="p">):</span> 
<span class="c1">#            if (len(mylists[group]) &gt;= np.mean([lenFirstGroup,lenLastGroup])*widthFactor): #  or len(mylists[group]) &gt;= lenLastGroup*widthFactor):</span>
            <span class="n">widthThreshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">lenFirstGroup</span><span class="p">,</span><span class="n">lenLastGroup</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">[</span><span class="n">group</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">widthThreshold</span><span class="o">*</span><span class="n">widthFactor</span><span class="p">)):</span> 
                <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylists</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="n">groups</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t report the final group because it is not really under consideration here</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fCCiter</span><span class="si">%d</span><span class="s1">:  Keeping channel group </span><span class="si">%d</span><span class="s1"> because it is wider than </span><span class="si">%.1f</span><span class="s1">*width of both edge groups&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span><span class="n">group</span><span class="p">,</span><span class="n">widthFactor</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rangesDropped</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fCCiter</span><span class="si">%d</span><span class="s1">: Dropping channel group </span><span class="si">%d</span><span class="s1"> because it is narrower (</span><span class="si">%d</span><span class="s1">) than </span><span class="si">%.1f</span><span class="s1">*width (</span><span class="si">%d</span><span class="s1">) of both edge groups&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">[</span><span class="n">group</span><span class="p">]),</span> <span class="n">widthFactor</span><span class="p">,</span> <span class="n">widthThreshold</span><span class="o">*</span><span class="n">widthFactor</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rangesDropped</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fCCiter</span><span class="si">%d</span><span class="s1">: No channel groups dropped by rejectNarrowInnerWindowsChannels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fCCiter</span><span class="si">%d</span><span class="s1">: Number of channel groups (</span><span class="si">%d</span><span class="s1">) disqualifies it for rejectNarrowInnerWindowsChannels&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fCCiteration</span><span class="p">,</span><span class="n">groups</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">messages</span><span class="p">,</span> <span class="n">rangesDropped</span><span class="p">)</span></div>


<div class="viewcode-block" id="splitListIntoContiguousListsAndRejectNarrow">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.splitListIntoContiguousListsAndRejectNarrow">[docs]</a>
<span class="k">def</span> <span class="nf">splitListIntoContiguousListsAndRejectNarrow</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">narrow</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Split a list of channels into contiguous lists, and reject those that</span>
<span class="sd">    have a small number of channels.</span>
<span class="sd">    narrow: if &gt;=1, then interpret it as the minimum number of channels that</span>
<span class="sd">                  a group must have in order to survive</span>
<span class="sd">            if &lt;1, then interpret it as the minimum fraction of channels that</span>
<span class="sd">                  a group must have relative to the total number of channels</span>
<span class="sd">    Returns: a new single list (as an array)</span>
<span class="sd">    Example:  [1,2,3,4,6,7,9,10,11] --&gt; [ 1,  2,  3,  4,  9, 10, 11]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mylist</span> <span class="ow">in</span> <span class="n">mylists</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">narrow</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">narrow</span><span class="o">*</span><span class="n">length</span><span class="p">):</span>  <span class="c1"># PIPE-1865 fraction-&gt;narrow</span>
                <span class="k">continue</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">narrow</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span></div>


<div class="viewcode-block" id="splitListIntoContiguousListsAndTrim">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.splitListIntoContiguousListsAndTrim">[docs]</a>
<span class="k">def</span> <span class="nf">splitListIntoContiguousListsAndTrim</span><span class="p">(</span><span class="n">totalChannels</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                                        <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> 
                                        <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Split a list of channels into contiguous lists, and trim some number</span>
<span class="sd">    of channels from each edge.</span>
<span class="sd">    totalChannels: number of channels in the spectrum</span>
<span class="sd">    channels: a list of channels selected for potential continuum</span>
<span class="sd">    trimChannels: if integer, use that number of channels.  If float between</span>
<span class="sd">        0 and 1, then use that fraction of channels in each contiguous list</span>
<span class="sd">        (rounding up). If &#39;auto&#39;, then use 0.1 but not more than maxTrim </span>
<span class="sd">        channels and not more than maxTrimFraction of channels.</span>
<span class="sd">    maxTrim and maxTrimChannels: used in &#39;auto&#39; mode</span>
<span class="sd">    Returns: a new single list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trimChannels</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">trimChannelsMode</span> <span class="o">=</span> <span class="n">trimChannels</span>
    <span class="n">medianWidthOfRanges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">countChannelsInRanges</span><span class="p">(</span><span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trimChannels</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">trimChannels</span> <span class="o">=</span> <span class="n">pickAutoTrimChannels</span><span class="p">(</span><span class="n">totalChannels</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">medianWidthOfRanges</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Picked trimChannels = </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">)))</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">totalChannels</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">:</span>
        <span class="n">trimLimitForEdgeRegion</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trimLimitForEdgeRegion</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mylist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mylists</span><span class="p">):</span>
        <span class="n">trimChan</span> <span class="o">=</span> <span class="n">trimChannels</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trimChan=</span><span class="si">%d</span><span class="s2">, Checking list = &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trimChan</span><span class="p">),</span> <span class="n">mylist</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trimChannels</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">trimChan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span><span class="o">*</span><span class="n">trimChannels</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;since trimChannels=</span><span class="si">%s</span><span class="s2">&lt;1; reset trimChan=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">),</span><span class="n">trimChan</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">trimChannelsMode</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">and</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">trimChan</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxTrimFraction</span><span class="p">):</span>
            <span class="n">trimChan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">maxTrimFraction</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trimChan for this window = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trimChan</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">+</span><span class="n">trimChan</span><span class="o">*</span><span class="mi">2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># If there was only one list of 1 or 2 channels, then don&#39;t trim it away!</span>
                <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="c1"># Limit the trimming of the edge closest to the edge of the spw to trimLimitForEdgeRegion (i.e., 2 or 3)</span>
        <span class="c1"># in order to preserve bandwidth.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">trimChan</span> <span class="o">&gt;</span> <span class="n">trimLimitForEdgeRegion</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># It is the only window so limit the trim on the far edge too</span>
<span class="c1">#                print(&quot;trim case 0: %d-%d --&gt; %d-%d&quot; % (mylist[0], mylist[-1], mylist[trimLimitForEdgeRegion],mylist[-trimLimitForEdgeRegion]))</span>
                <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">trimLimitForEdgeRegion</span><span class="p">:</span><span class="o">-</span><span class="n">trimLimitForEdgeRegion</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">trimLimitForEdgeRegion</span><span class="p">:</span><span class="o">-</span><span class="n">trimChan</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">trimChan</span> <span class="o">&gt;</span> <span class="n">trimLimitForEdgeRegion</span><span class="p">):</span>
            <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">trimChan</span><span class="p">:</span><span class="o">-</span><span class="n">trimLimitForEdgeRegion</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># It is either not an edge window, or it is an edge window and trimChan&lt;=trimLimitForEdgeRegion</span>
            <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">trimChan</span><span class="p">:</span><span class="o">-</span><span class="n">trimChan</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span></div>


<div class="viewcode-block" id="maxLengthOfLists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.maxLengthOfLists">[docs]</a>
<span class="k">def</span> <span class="nf">maxLengthOfLists</span><span class="p">(</span><span class="n">lists</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    lists: a list if lists</span>
<span class="sd">    Returns: an integer that is the length of the longest list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">maxLength</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lists</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxLength</span><span class="p">):</span>
            <span class="n">maxLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">maxLength</span></div>


<div class="viewcode-block" id="roundFigures">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.roundFigures">[docs]</a>
<span class="k">def</span> <span class="nf">roundFigures</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">digits</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum and drawYlabel.</span>
<span class="sd">    This function rounds a floating point value to a number of significant </span>
<span class="sd">    figures.  Was originally taken from analysisUtils.</span>
<span class="sd">    value: value to be rounded (between 1e-20 and 1e+20)</span>
<span class="sd">    digits: number of significant digits, both before or after decimal point</span>
<span class="sd">    Returns: a floating point value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">%</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span><span class="p">)):</span>
            <span class="n">digits</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">r</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="n">digits</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="pickAutoTrimChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickAutoTrimChannels">[docs]</a>
<span class="k">def</span> <span class="nf">pickAutoTrimChannels</span><span class="p">(</span><span class="n">totalChannels</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">medianWidthOfRanges</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by splitListIntoContiguousListsAndTrim and pickTrimString.</span>
<span class="sd">    Automatic choice of number of trimChannels as a function of the number </span>
<span class="sd">    of potential continuum channels in an spw.</span>
<span class="sd">    length: number of channels in the list of potential continuum channels</span>
<span class="sd">    Returns: an integer or floating point value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">trimChannels</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;median width of potential continuum ranges = </span><span class="si">%.1f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianWidthOfRanges</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="n">trimChannels</span> <span class="o">&gt;</span> <span class="n">maxTrim</span> <span class="ow">and</span> <span class="n">medianWidthOfRanges</span> <span class="o">&gt;</span> <span class="n">maxTrim</span><span class="o">*</span><span class="mf">1.5</span> <span class="ow">and</span> <span class="n">totalChannels</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;pickAutoTrimChannels(): set trimChannels = </span><span class="si">%d</span><span class="s2"> because </span><span class="si">%.0f</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2"> and totalChannels=</span><span class="si">%d</span><span class="s2">&gt;256&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxTrim</span><span class="p">,</span><span class="n">length</span><span class="o">*</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">maxTrim</span><span class="p">,</span><span class="n">totalChannels</span><span class="p">))</span>
        <span class="n">trimChannels</span> <span class="o">=</span> <span class="n">maxTrim</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;pickAutoTrimChannels(): set trimChannels = </span><span class="si">%.1f</span><span class="s2"> because </span><span class="si">%.0f</span><span class="s2"> &lt;= </span><span class="si">%d</span><span class="s2"> or </span><span class="si">%.1f</span><span class="s2"> &lt;= </span><span class="si">%f</span><span class="s2"> or totalChannels=</span><span class="si">%d</span><span class="s2"> &lt;= 256&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">length</span><span class="o">*</span><span class="n">trimChannels</span><span class="p">,</span><span class="n">maxTrim</span><span class="p">,</span><span class="n">medianWidthOfRanges</span><span class="p">,</span><span class="n">maxTrim</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span><span class="n">totalChannels</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">trimChannels</span><span class="p">)</span></div>


<div class="viewcode-block" id="pickTrimString">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickTrimString">[docs]</a>
<span class="k">def</span> <span class="nf">pickTrimString</span><span class="p">(</span><span class="n">totalChannels</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Generate a string describing the setting of the trimChannels parameter.</span>
<span class="sd">    totalChannels: total number of points in spectrum</span>
<span class="sd">    trimChannels: string (e.g. &#39;auto&#39;) or integer (e.g. 20) or float (e.g. 0.1)</span>
<span class="sd">    length: number of channels in the spectrum  (now unused)</span>
<span class="sd">    selection: continuum channel selection string</span>
<span class="sd">    Returns: a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trimChannels</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">contSelectionLength</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">countChannelsInRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
        <span class="n">medianWidthOfRanges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">countChannelsInRanges</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
<span class="c1">#        trimString = &#39;auto_max=%g&#39; % pickAutoTrimChannels(length, maxTrim, medianWidthOfRanges)</span>
        <span class="n">trimString</span> <span class="o">=</span> <span class="s1">&#39;auto_max=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pickAutoTrimChannels</span><span class="p">(</span><span class="n">totalChannels</span><span class="p">,</span> <span class="n">contSelectionLength</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">medianWidthOfRanges</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">trimString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trimChannels</span>
    <span class="k">return</span><span class="p">(</span><span class="n">trimString</span><span class="p">)</span></div>


<div class="viewcode-block" id="pickNarrowString">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickNarrowString">[docs]</a>
<span class="k">def</span> <span class="nf">pickNarrowString</span><span class="p">(</span><span class="n">narrow</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">narrowValueModified</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Generate a string describing the setting of the narrow parameter.</span>
<span class="sd">    Returns: a string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">narrow</span><span class="o">==</span><span class="s1">&#39;auto&#39;</span><span class="p">):</span>
        <span class="n">myNarrow</span> <span class="o">=</span> <span class="n">pickNarrow</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">narrowValueModified</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">myNarrow</span> <span class="o">==</span> <span class="n">narrowValueModified</span><span class="p">):</span>
            <span class="n">narrowString</span> <span class="o">=</span> <span class="s1">&#39;auto=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">myNarrow</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">narrowString</span> <span class="o">=</span> <span class="s1">&#39;auto=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">narrowValueModified</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">narrowString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">narrow</span>
    <span class="k">return</span><span class="p">(</span><span class="n">narrowString</span><span class="p">)</span></div>


<div class="viewcode-block" id="pickNarrow">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pickNarrow">[docs]</a>
<span class="k">def</span> <span class="nf">pickNarrow</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by pickNarrowString and findContinuumChannels.</span>
<span class="sd">    Automatically picks a setting for the narrow parameter of </span>
<span class="sd">    findContinuumChannels() based on the number of channels in the spectrum.  </span>
<span class="sd">    Returns: an integer</span>
<span class="sd">    Examples: This formula results in the following values:</span>
<span class="sd">    length: 64,128,240,480,960,1920,3840,7680:</span>
<span class="sd">    return:  2,  3,  3,  3,  3,   4,   4,   4  (ceil(log10)) **** current function ****</span>
<span class="sd">             2,  2,  2,  3,  3,   3,   4,   4  (round_half_up(log10))</span>
<span class="sd">             1,  2,  2,  2,  2,   3,   3,   3  (floor(log10))</span>
<span class="sd">             5,  5,  6,  7,  7,   8,   9,   9  (ceil(log))</span>
<span class="sd">             4,  5,  5,  6,  7,   8,   8,   9  (round_half_up(log))</span>
<span class="sd">             4,  4,  5,  6,  6,   7,   8,   8  (floor(log))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">length</span><span class="p">))))</span></div>


<div class="viewcode-block" id="sigmaCorrectionFactor">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.sigmaCorrectionFactor">[docs]</a>
<span class="k">def</span> <span class="nf">sigmaCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">npts</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Computes the correction factor for the fact that the measured rms (or MAD) </span>
<span class="sd">    on the N%ile lowest points of a datastream will be less than the true rms </span>
<span class="sd">    (or MAD) of all points.  </span>
<span class="sd">    npts: nchan in the spw</span>
<span class="sd">    Returns: a value between 0 and 1, which will be used to reduce the </span>
<span class="sd">             estimate of the population sigma based on the sample sigma</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edgeValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">npts</span><span class="o">/</span><span class="mf">128.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.08</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">edgeValue</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">edgeValue</span><span class="o">*</span><span class="mf">2.8</span><span class="o">*</span><span class="p">(</span><span class="n">percentile</span><span class="o">/</span><span class="mf">10.</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.25</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;sigmaCorrectionFactor using percentile = </span><span class="si">%g</span><span class="s2"> to get sCF=</span><span class="si">%g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percentile</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="medianCorrected">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.medianCorrected">[docs]</a>
<span class="k">def</span> <span class="nf">medianCorrected</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">signalRatio</span><span class="p">,</span> 
                    <span class="n">useLowBaseline</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Computes the true median of a datastream from the observed median and MAD </span>
<span class="sd">    of the lowest Nth percentile points.</span>
<span class="sd">    signalRatio: when there is a lot of signal, we need to reduce the </span>
<span class="sd">                 correction factor because it is less like Gaussian noise</span>
<span class="sd">                 It is 1.0 if no lines are present, 0.25 if half the channels </span>
<span class="sd">                 have signal, etc.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;medianCorrected using signalRatio=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">signalRatio</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">useLowBaseline</span><span class="p">:</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">computeMedianCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span><span class="o">*</span><span class="n">mad</span><span class="o">*</span><span class="n">signalRatio</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">corrected</span> <span class="o">=</span> <span class="n">median</span> <span class="o">-</span> <span class="n">computeMedianCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span><span class="o">*</span><span class="n">mad</span><span class="o">*</span><span class="n">signalRatio</span>
    <span class="k">return</span><span class="p">(</span><span class="n">corrected</span><span class="p">)</span></div>


<div class="viewcode-block" id="computeMedianCorrectionFactor">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeMedianCorrectionFactor">[docs]</a>
<span class="k">def</span> <span class="nf">computeMedianCorrectionFactor</span><span class="p">(</span><span class="n">baselineMode</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels and medianCorrected.</span>
<span class="sd">    Computes the effect due to the fact that taking the median of the</span>
<span class="sd">    N%ile lowest points of a Gaussian noise datastream will be lower than the true </span>
<span class="sd">    median of all the points.  This is (TrueMedian-ObservedMedian)/ObservedMAD</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;computeMedianCorrectionFactor using percentile=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">percentile</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="mf">6.3</span><span class="o">*</span><span class="p">(</span><span class="mf">5.0</span><span class="o">/</span><span class="n">percentile</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span></div>


<div class="viewcode-block" id="getImageInfo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getImageInfo">[docs]</a>
<span class="k">def</span> <span class="nf">getImageInfo</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">returnBeamAreaPerChannel</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum and meanSpectrum.</span>
<span class="sd">    Extract the beam and pixel information from a CASA image.</span>
<span class="sd">    This was copied from getFitsBeam in analysisUtils.py.</span>
<span class="sd">    Returns: A list of 12 things: bmaj, bmin, bpa, cdelt1, cdelt2, </span>
<span class="sd">                 naxis1, naxis2, frequency, shape, crval1, crval2, maxBaseline,</span>
<span class="sd">                 telescope name</span>
<span class="sd">       Beam angles are in arcseconds (bpa in degrees), crvals are in radians</span>
<span class="sd">       Frequency is in GHz and is the central frequency</span>
<span class="sd">       MaxBaseline is in meters, inferred from freq and beamsize (will be zero for .residual images)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ARCSEC_PER_RAD</span> <span class="o">=</span> <span class="mf">206264.80624709636</span>
    <span class="n">c_mks</span> <span class="o">=</span> <span class="mf">2.99792458e8</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;image not found: &quot;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">mydict</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;major&#39;</span> <span class="ow">in</span> <span class="n">mydict</span> <span class="ow">or</span> <span class="s1">&#39;beams&#39;</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">:</span>
        <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
        <span class="k">if</span> <span class="s1">&#39;major&#39;</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">:</span>
            <span class="c1"># single beam case</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">bpa</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">],</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;beams&#39;</span> <span class="ow">in</span> <span class="n">mydict</span><span class="p">:</span>
            <span class="c1"># perplane beams</span>
            <span class="n">beams</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">]</span>
            <span class="n">major</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">minor</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sinpa</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cospa</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">chan_beam</span> <span class="ow">in</span> <span class="n">beams</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">chan_pol_beam</span> <span class="ow">in</span> <span class="n">chan_beam</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">major</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">chan_pol_beam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="n">minor</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">chan_pol_beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="n">sinpa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">chan_pol_beam</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
                    <span class="n">cospa</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">chan_pol_beam</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">returnBeamAreaPerChannel</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">major</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
            <span class="n">bpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sinpa</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">cospa</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized beam dictionary.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bmaj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bpa</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#        if &#39;mask&#39; not in img:</span>
<span class="c1">#            print(&quot;Warning: No beam found in header.&quot;)</span>
    <span class="n">naxis1</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">naxis2</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">restfreq</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mycs</span><span class="o">.</span><span class="n">restfrequency</span><span class="p">(),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cdelt1</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">ARCSEC_PER_RAD</span>  <span class="c1"># arcsec</span>
    <span class="n">cdelt2</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">ARCSEC_PER_RAD</span>  <span class="c1"># arcsec</span>
    <span class="n">crval1</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># radian</span>
    <span class="n">crval2</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># radian</span>
    <span class="n">deltaFreq</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">frequencyGHz</span> <span class="o">=</span>  <span class="n">frequency</span> <span class="o">*</span> <span class="mf">1e-9</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">bunit</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">()</span>
    <span class="n">velocityWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c_mks</span> <span class="o">*</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">deltaFreq</span> <span class="o">/</span> <span class="n">frequency</span><span class="p">)</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
    <span class="n">telescope</span> <span class="o">=</span> <span class="n">getTelescope</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">myia</span><span class="p">)</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">bmaj</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="n">c_mks</span>  <span class="o">/</span> <span class="p">((</span><span class="mf">1e9</span><span class="o">*</span><span class="n">frequencyGHz</span><span class="o">*</span><span class="p">(</span><span class="n">bmaj</span><span class="o">*</span><span class="n">bmin</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">ARCSEC_PER_RAD</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span><span class="p">([</span><span class="n">bmaj</span><span class="p">,</span><span class="n">bmin</span><span class="p">,</span><span class="n">bpa</span><span class="p">,</span><span class="n">cdelt1</span><span class="p">,</span><span class="n">cdelt2</span><span class="p">,</span><span class="n">naxis1</span><span class="p">,</span><span class="n">naxis2</span><span class="p">,</span><span class="n">frequencyGHz</span><span class="p">,</span><span class="n">shape</span><span class="p">,</span><span class="n">crval1</span><span class="p">,</span><span class="n">crval2</span><span class="p">,</span><span class="n">maxBaseline</span><span class="p">,</span><span class="n">telescope</span><span class="p">])</span></div>

                                                            
<div class="viewcode-block" id="numberOfChannelsInCube">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.numberOfChannelsInCube">[docs]</a>
<span class="k">def</span> <span class="nf">numberOfChannelsInCube</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                           <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum, cubeFrameToTopo, </span>
<span class="sd">    computeStatisticalSpectrumFromMask, and meanSpectrum.</span>
<span class="sd">    Finds the number of channels in a CASA image cube.</span>
<span class="sd">    returnFreqs: if True, then also return the frequency of the center of the</span>
<span class="sd">           first and last channel (in Hz)</span>
<span class="sd">    returnChannelWidth: if True, then also return the channel width (in Hz)</span>
<span class="sd">    verbose: if True, then print the frequencies of first and last channel</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">myia</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">myia</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">naxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="n">cdelt</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">pixel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">naxes</span>
    <span class="n">firstFreq</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">pixel</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchan</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">lastFreq</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="n">pixel</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;n&#39;</span><span class="p">)[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">returnFreqs</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">returnChannelWidth</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">,</span><span class="n">cdelt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">returnChannelWidth</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span><span class="n">cdelt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span></div>


<div class="viewcode-block" id="nanmean">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.nanmean">[docs]</a>
<span class="k">def</span> <span class="nf">nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels, runFindContinuum, and avgOverCube.</span>
<span class="sd">    Takes the mean of an array, ignoring the nan entries</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">scipy_nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_nanmedian</span><span class="p">(</span><span class="n">arr1d</span><span class="p">,</span> <span class="n">preop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># This only works on 1d arrays</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private function for rank a arrays. Compute the median ignoring Nan.</span>
<span class="sd">    This function is called by nanmedian(), which is in turn called by MAD.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    arr1d : ndarray</span>
<span class="sd">        Input array, of rank 1.</span>

<span class="sd">    Results</span>
<span class="sd">    -------</span>
<span class="sd">    m : float</span>
<span class="sd">        The median.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">arr1d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;All-NaN slice encountered&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">elif</span> <span class="n">s</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># select non-nans at end of array</span>
        <span class="n">enonan</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">:][</span><span class="o">~</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">:]]</span>
        <span class="c1"># fill nans in beginning of array with non-nans of end</span>
        <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">[:</span><span class="n">enonan</span><span class="o">.</span><span class="n">size</span><span class="p">]]</span> <span class="o">=</span> <span class="n">enonan</span>
        <span class="c1"># slice nans away</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">preop</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">preop</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">overwrite_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="nanmedian">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.nanmedian">[docs]</a>
<span class="k">def</span> <span class="nf">nanmedian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">preop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by MAD, avgOverCube, and meanSpectrum.</span>
<span class="sd">    Compute the median along the given axis ignoring nan values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x : array_like</span>
<span class="sd">        Input array.</span>
<span class="sd">    axis : int or None, optional</span>
<span class="sd">        Axis along which the median is computed. Default is 0.</span>
<span class="sd">        If None, compute over the whole array `x`.</span>
<span class="sd">    preop : function</span>
<span class="sd">        function to apply on 1d slice after removing the NaNs and before</span>
<span class="sd">        computing median</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    m : float</span>
<span class="sd">        The median of `x` along `axis`.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    nanstd, nanmean, numpy.nanmedian</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from scipy import stats</span>
<span class="sd">    &gt;&gt;&gt; a = np.array([0, 3, 1, 5, 5, np.nan])</span>
<span class="sd">    &gt;&gt;&gt; stats.nanmedian(a)</span>
<span class="sd">    array(3.0)</span>

<span class="sd">    &gt;&gt;&gt; b = np.array([0, 3, 1, 5, 5, np.nan, 5])</span>
<span class="sd">    &gt;&gt;&gt; stats.nanmedian(b)</span>
<span class="sd">    array(4.0)</span>

<span class="sd">    Example with axis:</span>

<span class="sd">    &gt;&gt;&gt; c = np.arange(30.).reshape(5,6)</span>
<span class="sd">    &gt;&gt;&gt; idx = np.array([False, False, False, True, False] * 6).reshape(5,6)</span>
<span class="sd">    &gt;&gt;&gt; c[idx] = np.nan</span>
<span class="sd">    &gt;&gt;&gt; c</span>
<span class="sd">    array([[  0.,   1.,   2.,  nan,   4.,   5.],</span>
<span class="sd">           [  6.,   7.,  nan,   9.,  10.,  11.],</span>
<span class="sd">           [ 12.,  nan,  14.,  15.,  16.,  17.],</span>
<span class="sd">           [ nan,  19.,  20.,  21.,  22.,  nan],</span>
<span class="sd">           [ 24.,  25.,  26.,  27.,  nan,  29.]])</span>
<span class="sd">    &gt;&gt;&gt; stats.nanmedian(c, axis=1)</span>
<span class="sd">    array([  2. ,   9. ,  15. ,  20.5,  26. ])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">preop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="s1">&#39;nanmedian&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">_nanmedian</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">preop</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="findSpectralAxis">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findSpectralAxis">[docs]</a>
<span class="k">def</span> <span class="nf">findSpectralAxis</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by computeStatisticalSpectrumFromMask, getImageInfo, </span>
<span class="sd">    findContinuum and numberOfChannelsInCube.</span>
<span class="sd">    Finds the spectral axis number of an image tool instance, or an image.</span>
<span class="sd">    img: string or iatool instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">img</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mycs</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">iax</span> <span class="o">=</span> <span class="n">mycs</span><span class="o">.</span><span class="n">findaxisbyname</span><span class="p">(</span><span class="s2">&quot;spectral&quot;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: can&#39;t find spectral axis.  Assuming it is 3.&quot;</span><span class="p">)</span>
        <span class="n">iax</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">mycs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span> <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">iax</span></div>


<div class="viewcode-block" id="countUnmaskedPixels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.countUnmaskedPixels">[docs]</a>
<span class="k">def</span> <span class="nf">countUnmaskedPixels</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">useImstat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrumFromMom0Mom8JointMask.</span>
<span class="sd">    Returns number of unmasked pixels in an multi-dimensional image, i.e. </span>
<span class="sd">    where the internal mask is True.</span>
<span class="sd">    Total pixels: spatial * spectral * Stokes</span>
<span class="sd">    Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">useImstat</span><span class="p">:</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># append the statistics of dirty cube to a text file for this MOUS (PIPE-2171)</span>
            <span class="n">mous</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">outdir</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">mous</span> <span class="o">+</span> <span class="s1">&#39;_dirtyCubeStats_CASA</span><span class="si">%s</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">casaVersion</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">img</span><span class="p">),</span> <span class="n">mous</span> <span class="o">+</span> <span class="s1">&#39;_dirtyCubeStats_CASA</span><span class="si">%s</span><span class="s1">.txt&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">casaVersion</span><span class="p">))</span>
            <span class="n">alreadyExists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">alreadyExists</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# dirtyCubeName min max rms medabsdevmed</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">mymin</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">];</span> <span class="n">mymax</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">];</span> <span class="n">mystd</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">];</span> <span class="n">mymad</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.7f</span><span class="s1"> </span><span class="si">%.7f</span><span class="s1"> </span><span class="si">%.7f</span><span class="s1"> </span><span class="si">%.7f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">mymin</span><span class="p">,</span><span class="n">mymax</span><span class="p">,</span><span class="n">mystd</span><span class="p">,</span><span class="n">mymad</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">npix</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">npix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">maskdata</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maskdata</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maskedPixels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">maskdata</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">pixels</span><span class="o">-</span><span class="n">maskedPixels</span></div>


<div class="viewcode-block" id="countPixelsAboveZero">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.countPixelsAboveZero">[docs]</a>
<span class="k">def</span> <span class="nf">countPixelsAboveZero</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pbmom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">useImstat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrumFromMom0Mom8JointMask.</span>
<span class="sd">    Returns number of pixels &gt; a specified threshold.</span>
<span class="sd">    pbmom: if specified, and useImstat==True, then also require pb&gt;0.21</span>
<span class="sd">    Note that the value of 0.21 is also used in findOuterAnnulusForPBCube and should be changed in parallel</span>
<span class="sd">    value: threshold (default=0)</span>
<span class="sd">    Total pixels: spatial * spectral * Stokes</span>
<span class="sd">    Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find image: &quot;</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">useImstat</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pbmom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0 &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.21&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">pbmom</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">npix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">()</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span><span class="o">&gt;</span><span class="n">value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixels</span></div>


<div class="viewcode-block" id="flattenMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.flattenMask">[docs]</a>
<span class="k">def</span> <span class="nf">flattenMask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a multi-channel CASA image mask and propagates all pixels to a </span>
<span class="sd">    new single plane image mask</span>
<span class="sd">    outfile: default name = &lt;mask&gt;.flattened</span>
<span class="sd">    - Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find mask image.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">outfile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">outfile</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">+</span> <span class="s1">&#39;.flattened&#39;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">imcollapse</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> 
               <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outfile</span></div>


<div class="viewcode-block" id="imagePercentileNoMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.imagePercentileNoMask">[docs]</a>
<span class="k">def</span> <span class="nf">imagePercentileNoMask</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">percentiles</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    percentiles: a single value or a list</span>
<span class="sd">    Returns: a single value or a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">mymask</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">percentiles</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span> <span class="c1"># type(percentiles) != list and type(percentiles) != np.ndarray:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mymask</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)],</span> <span class="n">percentiles</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">percentile</span> <span class="ow">in</span> <span class="n">percentiles</span><span class="p">:</span>
        <span class="n">value</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mymask</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)],</span> <span class="n">percentile</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="meanSpectrumFromMom0Mom8JointMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.meanSpectrumFromMom0Mom8JointMask">[docs]</a>
<span class="k">def</span> <span class="nf">meanSpectrumFromMom0Mom8JointMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psfcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                                      <span class="n">projectCode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">overwriteMoments</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                      <span class="n">overwriteMasks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phase2</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                      <span class="n">normalizeByMAD</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">minPixelsInJointMask</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                      <span class="n">initialQuadraticImprovementThreshold</span><span class="o">=</span><span class="mf">1.6</span><span class="p">,</span> <span class="n">userJointMask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                      <span class="n">snrThreshold</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">mom0minsnr</span><span class="o">=</span><span class="n">MOM0MINSNR_DEFAULT</span><span class="p">,</span> 
                                      <span class="n">mom8minsnr</span><span class="o">=</span><span class="n">MOM8MINSNR_DEFAULT</span><span class="p">,</span> <span class="n">rmStatContQuadratic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">bidirectionalMaskPhase2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                                      <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">momentdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                      <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">pbmom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> 
                                      <span class="n">maxBaseline</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mom08simultaneous</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">enableInitialQuadratic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum when meanSpectrumMethod=&#39;mom0mom8jointMask&#39;.</span>
<span class="sd">    This is the new heuristic for Cycle 6 which creates the moment 0 and moment 8 images</span>
<span class="sd">    for a cube, takes their union and determines the mean spectrum by calling </span>
<span class="sd">    computeStatisticalSpectrumFromMask(), which uses ia.getprofile.</span>
<span class="sd">    pbcube: if not specified, then assume &#39;.residual&#39; should be replaced in the name by &#39;.pb&#39;</span>
<span class="sd">    pbmom: if not specified, then assume &#39;.pb&#39; should be replaced in the name by &#39;.pbmom&#39;</span>
<span class="sd">    overwriteMoments: rebuild the mom0 and mom8 images even if they already exist</span>
<span class="sd">    overwriteMasks: rebuild the mom0 and mom8 mask images even if they already exist</span>
<span class="sd">    phase2: if True, then run a second phase if SNR is high</span>
<span class="sd">    minPixelsInJointMask: if fewer than these pixels are found, then use all pixels above pb=0.3</span>
<span class="sd">    userJointMask: if specified, use this joint mask instead of computing one; if it is a cube mask,</span>
<span class="sd">       as from tclean, then this function will form a flattened version first, and then use that</span>
<span class="sd">    snrThreshold: if SNR is higher than this, and phase2==True, then run a phase 2 mask calculation</span>
<span class="sd">    mom0minsnr: sets the threshold for the mom0 image (i.e. median + mom0minsnr*scaledMAD of the whole image)</span>
<span class="sd">    mom8minsnr: sets the threshold for the mom8 image (i.e. median + mom8minsnr*scaledMAD of thw whole image)</span>
<span class="sd">    enableInitialQuadratic: if True, assess the need for quadratic removal, and use the </span>
<span class="sd">        old-style method to remove it</span>
<span class="sd">    rmStatContQuadratic: if True, then do not do the initialQuadratic removal (if enabled</span>
<span class="sd">       and deemed necessary), but instead always perform the new-style quadratic removal</span>
<span class="sd">    bidirectionalMaskPhase2: True=extend mask to negative values beyond threshold; </span>
<span class="sd">            False=Cycle6+ behavior (True was tried but gives worse results in some cases)</span>
<span class="sd">    outdir: directory to write the mom0, mom8, masks, .dat and mean spectrum text files</span>
<span class="sd">    avoidExtremaInNoiseCalcForJointMask: experimental Boolean to avoid pixels &lt;5%ile and &gt;95%ile</span>
<span class="sd">             in the chauvenet imstat of mom0 and mom8 images</span>
<span class="sd">    momentdir: alternate directory to look for existing mom0 and mom8 images</span>
<span class="sd">    mom08simultaneous: if True, set moments=[0,8] in one call to immoments instead of two</span>
<span class="sd">    Returns: 17 things: </span>
<span class="sd">       * 1) the meanSpectrum</span>
<span class="sd">       * 2) a Boolean which states whether normalization was applied</span>
<span class="sd">       * 3) the number of pixels in the mask</span>
<span class="sd">       * 4) a Boolean for whether the mask reverted to pb-based</span>
<span class="sd">       * 5) a Boolean for whether a quadratic was removed</span>
<span class="sd">       * 6) the initialQuadraticImprovementRatio</span>
<span class="sd">       * 7) the list of 3 mom0snrs</span>
<span class="sd">       * 8) the list of 3 mom8snrs </span>
<span class="sd">       * 9) the number of regions pruned</span>
<span class="sd">       * 10) number of pixels in moment 8 mask</span>
<span class="sd">       * 11) mom0peak (Jy*km/s)</span>
<span class="sd">       * 12) mom8peak (Jy)</span>
<span class="sd">       * 13) name of jointMask file</span>
<span class="sd">       * 14) nbin</span>
<span class="sd">       * 15) initialPeakOverMad</span>
<span class="sd">       * 16) mom0peakOverMad</span>
<span class="sd">       * 17) mom8peakOverMad</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;momentdir = &quot;</span><span class="p">,</span> <span class="n">momentdir</span><span class="p">)</span>
    <span class="n">overwritePhase2</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Look for the .pb image if it was not specified</span>
    <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pbcube</span> <span class="o">=</span> <span class="n">locatePBCube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;meanSpectrumFromMom0Mom8JointMask(): Could not find pbcube&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">pbmom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pbmom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pbcube</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;mom&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">:</span>  <span class="c1"># PIPE-1657</span>
                <span class="n">pbmomChans</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pbmomChans</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan</span><span class="o">//</span><span class="mi">8</span><span class="p">,</span> <span class="n">nchan</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="n">nchan</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">nchan</span><span class="o">//</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">nchan</span><span class="o">//</span><span class="mi">8</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[-1], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, chans=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">pbmomChans</span><span class="p">))</span>
            <span class="n">immoments</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">pbmom</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">pbmomChans</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Re-using existing pbmom: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">))</span>
    <span class="c1"># Look for the .psf image if it was not specified</span>
    <span class="k">if</span> <span class="n">psfcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.psf&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.psf&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">psfcube</span><span class="p">):</span>
                <span class="n">psfcube</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;psfcube = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">psfcube</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
        <span class="n">mom0suffix</span> <span class="o">=</span> <span class="s1">&#39;.integrated&#39;</span>
        <span class="n">mom8suffix</span> <span class="o">=</span> <span class="s1">&#39;.maximum&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mom0suffix</span> <span class="o">=</span> <span class="s1">&#39;.mom0&#39;</span>
        <span class="n">mom8suffix</span> <span class="o">=</span> <span class="s1">&#39;.mom8&#39;</span>
    <span class="k">if</span> <span class="n">momentdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">momRoot</span> <span class="o">=</span> <span class="n">cube</span> <span class="o">+</span><span class="s1">&#39;.mom&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">momRoot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mom&#39;</span><span class="p">)</span>
        <span class="n">mom0</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="n">mom0suffix</span>
        <span class="n">mom8</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="n">mom8suffix</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Look first in the output directory</span>
        <span class="n">momRoot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.mom&#39;</span><span class="p">)</span>
        <span class="n">mom0</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="n">mom0suffix</span>
        <span class="n">mom8</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="n">mom8suffix</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0</span><span class="p">):</span>
            <span class="c1"># now look in the momentdir directory</span>
            <span class="n">firstParentDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">momentdir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">momentdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span><span class="n">momentdir</span><span class="p">)</span>
            <span class="n">mom0src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="n">mom0suffix</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for mom0 at: &quot;</span><span class="p">,</span> <span class="n">mom0src</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0src</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Creating symlink to moment 0&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">mom0src</span><span class="p">,</span> <span class="n">mom0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8</span><span class="p">):</span>
            <span class="n">mom8src</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">momentdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="n">mom8suffix</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for mom8 at: &quot;</span><span class="p">,</span> <span class="n">mom8src</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8src</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Creating symlink to moment 8&#39;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">mom8src</span><span class="p">,</span> <span class="n">mom8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">overwriteMoments</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">mom0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mom0info</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">mom0</span><span class="p">)</span>
            <span class="c1"># check if RA/Dec images sizes match</span>
            <span class="k">if</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">mom0info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">and</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">mom0info</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Re-using existing moment0 image at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mismatch between cube and mom0 image, rebuilding mom0&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">mom0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">overwriteMoments</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">mom8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mom8info</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">mom8</span><span class="p">)</span>
            <span class="c1"># check if RA/Dec images sizes match</span>
            <span class="k">if</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="n">mom8info</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="ow">and</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">mom8info</span><span class="p">[</span><span class="mi">6</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Re-using existing moment8 image at </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mismatch between cube and mom8 image, rebuilding mom8&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span> <span class="o">+</span> <span class="n">mom8</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mom08simultaneous</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0,8], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;!=0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cube</span><span class="p">,</span><span class="n">momRoot</span><span class="p">,</span><span class="n">cube</span><span class="p">))</span>
            <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;!=0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span> <span class="c1"># PL use case</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0</span><span class="p">):</span>
            <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="o">+</span><span class="s1">&#39;.integrated&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;!=0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8</span><span class="p">):</span> 
            <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="o">+</span><span class="s1">&#39;.maximum&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;!=0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
        <span class="n">moment0name</span> <span class="o">=</span> <span class="n">momRoot</span><span class="o">+</span><span class="s1">&#39;.integrated&#39;</span>
        <span class="n">moment8name</span> <span class="o">=</span> <span class="n">momRoot</span><span class="o">+</span><span class="s1">&#39;.maximum&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find: &quot;</span><span class="p">,</span> <span class="n">mom0</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[0], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">mom0</span><span class="p">))</span>
    <span class="c1">#        immoments(cube, moments=[8], outfile=mom8) # PL2022</span>
            <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;!=0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running immoments(&#39;</span><span class="si">%s</span><span class="s2">&#39;, moments=[8], outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">mom8</span><span class="p">))</span>
            <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;!=0&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>
        <span class="n">moment0name</span> <span class="o">=</span> <span class="n">mom0</span>
        <span class="n">moment8name</span> <span class="o">=</span> <span class="n">mom8</span>

    <span class="c1"># PL2024: PIPE-1992 if dynamic range of mom0 is high, raise the mom0minsnr mask threshold</span>
    <span class="n">imstatResults</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">moment0name</span><span class="p">)</span>
    <span class="n">mom0peakOverMad</span> <span class="o">=</span> <span class="n">imstatResults</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstatResults</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span>
    <span class="n">imstatResults</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">moment8name</span><span class="p">)</span>
    <span class="n">mom8peakOverMad</span> <span class="o">=</span> <span class="n">imstatResults</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstatResults</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mom0peakOverMad</span> <span class="o">&gt;</span> <span class="mi">90</span><span class="p">:</span>    <span class="c1"># 2019.1.01184 needs 93</span>
        <span class="n">new_mom0minsnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom0minsnr</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Raising mom0minsnr from </span><span class="si">%f</span><span class="s1"> to </span><span class="si">%f</span><span class="s1"> because mom0peakOverMad=</span><span class="si">%.1f</span><span class="s1"> &gt; 90&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0minsnr</span><span class="p">,</span><span class="n">new_mom0minsnr</span><span class="p">,</span><span class="n">mom0peakOverMad</span><span class="p">))</span>
        <span class="n">mom0minsnr</span> <span class="o">=</span> <span class="n">new_mom0minsnr</span>
    
    <span class="n">pbBasedMask</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mom0mask</span> <span class="o">=</span> <span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask_bi&#39;</span>
    <span class="n">mom0mask2</span> <span class="o">=</span> <span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask2_bi&#39;</span>
    <span class="n">mom8mask</span> <span class="o">=</span> <span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask_bi&#39;</span>
    <span class="n">mom8mask2</span> <span class="o">=</span> <span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_bi&#39;</span>
    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">jointMask</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.joint.mask&#39;</span>
        <span class="n">jointMask2</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.joint.mask2&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jointMask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.joint.mask&#39;</span><span class="p">)</span>
        <span class="n">jointMask2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.joint.mask2&#39;</span><span class="p">)</span>
        
    <span class="n">lowerAnnulusLevel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1">#    sevenMeter = False</span>
<span class="c1">#    if sevenMeter:</span>
<span class="c1">#        snrThreshold = 20</span>
<span class="c1">#    else:</span>
<span class="c1">#        snrThreshold = 25</span>
    <span class="n">regionsPruned</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#    if overwriteMasks or not os.path.exists(mom0mask) or not os.path.exists(mom8mask):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">overwriteMasks</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0mask</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8mask</span><span class="p">))</span> <span class="ow">and</span> <span class="n">userJointMask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="c1">#####################</span>
        <span class="c1"># Build Moment 0 mask</span>
        <span class="c1">#####################</span>
        <span class="n">nptsInCube</span> <span class="o">=</span> <span class="n">countUnmaskedPixels</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">:</span>
            <span class="n">avoidLow</span><span class="p">,</span> <span class="n">avoidHigh</span> <span class="o">=</span> <span class="n">imagePercentileNoMask</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; </span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">avoidLow</span><span class="p">,</span> <span class="n">mom0</span><span class="p">,</span> <span class="n">avoidHigh</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, algorithm=&#39;chauvenet&#39;, maxiter=5, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, algorithm=&#39;chauvenet&#39;, maxiter=5)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="n">mom0peak</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom0snr</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scaledMAD</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">mom0sigma</span> <span class="o">=</span> <span class="n">mom0minsnr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mom0minsnr</span> <span class="o">==</span> <span class="n">MOM0MINSNR_DEFAULT</span><span class="p">:</span>
                <span class="n">mom0sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom0minsnr</span><span class="p">,</span><span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span><span class="mi">1</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mom0sigma</span> <span class="o">=</span> <span class="n">mom0minsnr</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;+++ nptsInCube=</span><span class="si">%d</span><span class="s2">, initial mom0sigma=</span><span class="si">%f</span><span class="s2">, scaledMAD=</span><span class="si">%f</span><span class="s2">,  mom0median=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span> <span class="n">mom0sigma</span><span class="p">,</span> <span class="n">scaledMAD</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">mom0threshold</span> <span class="o">=</span> <span class="n">mom0sigma</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom0min</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom0max</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># the test against mom0max is to prevent infinite loop</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">mom0min</span> <span class="o">&gt;=</span> <span class="n">mom0threshold</span> <span class="ow">and</span> <span class="n">mom0threshold</span> <span class="o">&lt;</span> <span class="n">mom0max</span><span class="p">):</span>
            <span class="c1"># Then there will be no points that satisfy subsequent mask, so raise the threshold so that at least some points are considered to be signal-free</span>
            <span class="n">mom0sigma</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   </span><span class="si">%e</span><span class="s2"> &lt; </span><span class="si">%e</span><span class="s2">: increasing mom0sigma to </span><span class="si">%d</span><span class="s2"> = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0min</span><span class="p">,</span><span class="n">mom0threshold</span><span class="p">,</span><span class="n">mom0sigma</span><span class="p">,</span><span class="n">mom0sigma</span><span class="o">*</span><span class="n">scaledMAD</span><span class="p">))</span>
            <span class="n">mom0threshold</span> <span class="o">=</span> <span class="n">mom0sigma</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> || &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; -</span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">,</span> <span class="n">mom0</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;applying mask to mom0: &quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="c1"># mom0.mask_chauv_bi: this image will have the true values of the image where it is not masked</span>
        <span class="n">imsubimage</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi&#39;</span><span class="p">)</span>
        <span class="c1"># mom0.mask_bi:       this image will have the value of 1.0 where it is not masked</span>
        <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi&#39;</span><span class="p">,</span>
                 <span class="n">inpmask</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mom0mask</span><span class="p">)</span>

        <span class="c1">#####################</span>
        <span class="c1"># Build Moment 8 mask</span>
        <span class="c1">#####################</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avoidExtremaInNoiseCalcForJointMask</span><span class="p">:</span>
            <span class="n">avoidLow8</span><span class="p">,</span> <span class="n">avoidHigh8</span> <span class="o">=</span> <span class="n">imagePercentileNoMask</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; </span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">avoidLow8</span><span class="p">,</span> <span class="n">mom8</span><span class="p">,</span> <span class="n">avoidHigh8</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, algorithm=&#39;chauvenet&#39;, maxiter=5, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span><span class="n">mask</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">,</span>
                            <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="n">mom8peak</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">scaledMAD</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;+++mom8 scaled MAD = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scaledMAD</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">scaledMAD</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">scaledMAD</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">scaledMAD</span> <span class="o">/</span> <span class="mf">1.4826</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using sigma = </span><span class="si">%g</span><span class="s2"> instead of scaled MAD, which was zero.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scaledMAD</span><span class="p">))</span>
        <span class="n">mom8snr</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">myMAD8</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">oneEventPoints</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">mom8minsnr</span> <span class="o">==</span> <span class="n">MOM8MINSNR_DEFAULT</span><span class="p">:</span>
                <span class="n">mom8sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom8minsnr</span><span class="p">,</span><span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="o">//</span><span class="n">nchan</span><span class="p">,</span><span class="n">oneEventPoints</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mom8sigma</span> <span class="o">=</span> <span class="n">mom8minsnr</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Choosing </span><span class="si">%f</span><span class="s2"> from mom8minsnr=</span><span class="si">%f</span><span class="s2">, oneEvent=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8sigma</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="o">//</span><span class="n">nchan</span><span class="p">,</span><span class="n">oneEventPoints</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Cycle 7</span>
            <span class="n">oneEventPoints</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">mom8minsnr</span> <span class="o">==</span> <span class="n">MOM8MINSNR_DEFAULT</span><span class="p">:</span>
                <span class="n">mom8sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom8minsnr</span><span class="p">,</span><span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span><span class="n">oneEventPoints</span><span class="p">)])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mom8sigma</span> <span class="o">=</span> <span class="n">mom8minsnr</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Choosing </span><span class="si">%f</span><span class="s2"> from mom8minsnr=</span><span class="si">%f</span><span class="s2">, oneEvent=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8sigma</span><span class="p">,</span> <span class="n">mom8minsnr</span><span class="p">,</span> <span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span><span class="n">oneEventPoints</span><span class="p">)))</span>
        <span class="n">mom8min</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom8max</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom8threshold</span> <span class="o">=</span> <span class="n">mom8sigma</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># the test against mom8max is to prevent infinite loop</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ Initial mom8sigma = </span><span class="si">%f</span><span class="s1">, scaledMAD=</span><span class="si">%f</span><span class="s1">,  mom8median=</span><span class="si">%f</span><span class="s1">, mom8min=</span><span class="si">%g</span><span class="s1">, mom8max=</span><span class="si">%g</span><span class="s1">, mom8threshold=</span><span class="si">%g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8sigma</span><span class="p">,</span> <span class="n">scaledMAD</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">mom8min</span><span class="p">,</span> <span class="n">mom8max</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">mom8min</span> <span class="o">&gt;=</span> <span class="n">mom8threshold</span> <span class="ow">and</span> <span class="n">mom8threshold</span> <span class="o">&lt;</span> <span class="n">mom8max</span><span class="p">):</span>
            <span class="c1"># Then there will be no points that satisfy subsequent mask, so raise the threshold so that at least some points are considered to be signal-free</span>
            <span class="n">mom8sigma</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">mom8threshold</span> <span class="o">=</span> <span class="n">mom8sigma</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%e</span><span class="s2">&gt;</span><span class="si">%e</span><span class="s2">:  increasing mom8sigma to </span><span class="si">%d</span><span class="s2">: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8min</span><span class="p">,</span><span class="n">mom8threshold</span><span class="p">,</span><span class="n">mom8sigma</span><span class="p">,</span><span class="n">mom8sigma</span><span class="o">*</span><span class="n">scaledMAD</span><span class="p">))</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> || &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; -</span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">,</span> <span class="n">mom8</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;applying mask to mom8: &quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="c1"># mom8.mask_chauv_bi: this image will have the true values of the image where it is not masked</span>
        <span class="n">imsubimage</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi&#39;</span><span class="p">)</span>
        <span class="c1"># mom8.mask_bi: this image will have the true values of the image where it is not masked</span>
        <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi&#39;</span><span class="p">,</span>
                 <span class="n">inpmask</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask_chauv_bi:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mom8mask</span><span class="p">)</span>
        <span class="n">numberPixelsInMom8Mask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">mom8mask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>

        <span class="c1">####################</span>
        <span class="c1"># Build joint mask</span>
        <span class="c1">####################</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running makemask(inpimage=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mode=&#39;copy&#39;, inpmask=[&#39;</span><span class="si">%s</span><span class="s2">&#39;,&#39;</span><span class="si">%s</span><span class="s2">&#39;], output=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mom0mask</span><span class="p">,</span> <span class="n">mom8mask</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">))</span>
        <span class="n">jointMaskTemp</span> <span class="o">=</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">)</span>
        <span class="n">makemask</span><span class="p">(</span><span class="n">inpimage</span><span class="o">=</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpmask</span><span class="o">=</span><span class="p">[</span><span class="n">mom0mask</span><span class="p">,</span> <span class="n">mom8mask</span><span class="p">],</span> 
                 <span class="n">output</span><span class="o">=</span><span class="n">jointMaskTemp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">minbeamfrac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">regionsPruned</span> <span class="o">=</span> <span class="n">pruneMask</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">)</span>

        <span class="c1"># try to get pb mask onto the joint.mask = PIPE-1629</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running imsubimage(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">jointMask</span><span class="p">))</span>
        <span class="c1"># looks like you need to protect mask with quotes if name includes a &#39;/&#39; character</span>
        <span class="n">imsubimage</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0&quot;</span><span class="o">%</span><span class="n">pbmom</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">jointMask</span><span class="p">)</span>  <span class="c1"># try adding &gt; 0, yes we need it!</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">)</span>
            
        <span class="n">pixelsInMask</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
        <span class="n">jointMask1</span> <span class="o">=</span> <span class="n">jointMask</span>

        <span class="n">snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom0snr</span><span class="p">,</span><span class="n">mom8snr</span><span class="p">])</span>
        <span class="n">mom0snr2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom8snr2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom0snr3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom8snr3</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom0sigma2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">mom8sigma2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jointMask2</span><span class="p">):</span>
            <span class="c1"># remove any old version to avoid confusion if phase2 is not run</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">phase2</span> <span class="ow">and</span> <span class="n">snr</span> <span class="o">&gt;</span> <span class="n">snrThreshold</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Doing phase 2 mask calculation because one or both SNR &gt; </span><span class="si">%.0f</span><span class="s2"> (mom0=</span><span class="si">%f</span><span class="s2">,mom8=</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snrThreshold</span><span class="p">,</span><span class="n">mom0snr</span><span class="p">,</span><span class="n">mom8snr</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">overwritePhase2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom0mask2</span><span class="p">)</span> 
                <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8mask2</span><span class="p">))</span> <span class="ow">and</span> <span class="n">pixelsInMask</span><span class="p">:</span>
                <span class="c1">####################################################################</span>
                <span class="c1"># Recompute statistics using pixels outside the initial coarse mask</span>
                <span class="c1"># because it will likely yield a lower MAD value.</span>
                <span class="c1">#################################################</span>
                <span class="c1"># Build Mom 0 mask</span>
                <span class="c1">##################</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask2*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;&lt;0.5)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span><span class="n">jointMask</span><span class="p">))</span>
                <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;, algorithm=&#39;chauvenet&#39;, maxiter=5, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;&lt;0.5)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span><span class="n">jointMask</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="c1"># Compute SNR (peak/MAD) outside of phase 1 mask</span>
                <span class="n">mom0snr2</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scaledMAD</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>
                <span class="n">resultPositive</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultPositive</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;WARNING: zero-length results from imstat(mom0)&quot;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
                <span class="c1"># reduce the sigma somewhat: </span>
                <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">mom0sigma2</span> <span class="o">=</span> <span class="n">mom0minsnr</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># Cycle 7</span>
                    <span class="k">if</span> <span class="n">mom0minsnr</span> <span class="o">==</span> <span class="n">MOM0MINSNR_DEFAULT</span><span class="p">:</span>
                        <span class="n">mom0sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom0minsnr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mom0sigma2</span> <span class="o">=</span> <span class="n">mom0minsnr</span><span class="o">-</span><span class="mi">1</span>
                <span class="n">mom0threshold</span> <span class="o">=</span> <span class="n">mom0sigma2</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ phase 2 mom0sigma2=</span><span class="si">%f</span><span class="s1">, npts=</span><span class="si">%d</span><span class="s1">, scaledMAD=</span><span class="si">%f</span><span class="s1">, median=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0sigma2</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledMAD</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ phase 2 mom0threshold = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mom0threshold</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bidirectionalMaskPhase2</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> || &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; -</span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">,</span> <span class="n">mom0</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">)</span>  <span class="c1"># Cycle 6 release</span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">)</span>
                <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">,</span>
                         <span class="n">inpmask</span><span class="o">=</span><span class="n">mom0</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mom0mask2</span><span class="p">)</span>

                <span class="c1">##################</span>
                <span class="c1"># Build Mom 8 mask</span>
                <span class="c1">##################</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask2*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running: &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
                <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running imstat(&#39;</span><span class="si">%s</span><span class="s2">&#39;,algorithm=&#39;chauvenet&#39;,maxiter=5,mask=&#39;</span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s2">&lt;0.5, listit=</span><span class="si">%s</span><span class="s2">, verbose=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">imstatListit</span><span class="p">,</span> <span class="n">imstatVerbose</span><span class="p">))</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">myMAD8</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c1"># mom8 images can potentially have a majority of identical 0, if immoments(mask) does not avoid 0.0</span>
                    <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1.4826</span>
                <span class="n">mom8snr2</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">myMAD8</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: zero-length results from mom8&quot;</span><span class="p">)</span>
                <span class="n">scaledMAD</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>
                <span class="k">if</span> <span class="n">mom8minsnr</span> <span class="o">==</span> <span class="n">MOM8MINSNR_DEFAULT</span><span class="p">:</span>
                    <span class="n">mom8sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">mom8minsnr</span><span class="p">,</span><span class="n">oneEvent</span><span class="p">(</span><span class="n">nptsInCube</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)])</span>
<span class="c1">#                    mom8sigma2 = np.max([mom8minsnr,oneEvent(nptsInCube//nchan,oneEventPoints)]) # was 0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mom8sigma2</span> <span class="o">=</span> <span class="n">mom8minsnr</span>
                <span class="n">mom8threshold</span> <span class="o">=</span> <span class="n">mom8sigma2</span><span class="o">*</span><span class="n">scaledMAD</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ phase 2 mom8sigma2=</span><span class="si">%f</span><span class="s1">, npts=</span><span class="si">%d</span><span class="s1">, scaledMAD=</span><span class="si">%f</span><span class="s1">, median=</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8sigma2</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">scaledMAD</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ phase 2 mom8threshold = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">mom8threshold</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bidirectionalMaskPhase2</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%.9f</span><span class="s1"> || &quot;</span><span class="si">%s</span><span class="s1">&quot; &lt; -</span><span class="si">%.9f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">,</span> <span class="n">mom8</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; &gt; </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">)</span>  <span class="c1"># Cycle 6 release</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running imsubimage(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">))</span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running makemask(mode=&#39;copy&#39;, inpimage=&#39;</span><span class="si">%s</span><span class="s2">&#39;, inpmask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, output=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">,</span> <span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv:mask0&#39;</span><span class="p">,</span> <span class="n">mom8mask2</span><span class="p">))</span>
                <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
                <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">myia</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">mom8mask2exists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;++++++ phase 2 mom8.mask2_chauv has no mask (no qualifying pixels).&#39;</span><span class="p">)</span>
                    <span class="n">mom8mask2exists</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mom8mask2exists</span><span class="p">:</span>
                    <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv&#39;</span><span class="p">,</span>
                           <span class="n">inpmask</span><span class="o">=</span><span class="n">mom8</span><span class="o">+</span><span class="s1">&#39;.mask2_chauv:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">mom8mask2</span><span class="p">)</span>
                    <span class="n">inpmask</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom0mask2</span><span class="p">,</span> <span class="n">mom8mask2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inpmask</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom0mask2</span><span class="p">]</span>

                <span class="c1">##########################</span>
                <span class="c1"># Build second joint mask</span>
                <span class="c1">##########################</span>
                <span class="n">jointMask2temp</span> <span class="o">=</span> <span class="n">jointMask2</span><span class="o">+</span><span class="s1">&#39;.tmp&#39;</span>
                <span class="n">makemask</span><span class="p">(</span><span class="n">inpimage</span><span class="o">=</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpmask</span><span class="o">=</span><span class="n">inpmask</span><span class="p">,</span> 
                         <span class="n">output</span><span class="o">=</span><span class="n">jointMask2temp</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">minbeamfrac</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">regionsPruned</span> <span class="o">=</span> <span class="n">pruneMask</span><span class="p">(</span><span class="n">jointMask2temp</span><span class="p">,</span> <span class="n">psfcube</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">)</span>

                <span class="c1"># try to get pb mask onto the joint.mask2 = PIPE-1629</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running imsubimage(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&gt;0&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask2temp</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">jointMask2</span><span class="p">))</span>
                <span class="c1"># looks like you need to protect mask with quotes if name includes a &#39;/&#39; character</span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">jointMask2temp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0&quot;</span><span class="o">%</span><span class="n">pbmom</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">jointMask2</span><span class="p">)</span>  <span class="c1"># try adding &gt; 0, yes we need it!</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">jointMask2temp</span><span class="p">)</span>

                <span class="n">jointMask</span> <span class="o">=</span> <span class="n">jointMask2</span>
                <span class="n">pixelsInMask</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">jointMask2</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

                <span class="c1"># Compute SNR (peak/MAD) outside of phase 2 mask</span>
                <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="n">mom0snr3</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
                <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">myMAD8</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="c1"># mom8 images can potentially have a majority of identical 0, if immoments(mask) does not avoid 0.0</span>
                    <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1.4826</span>
                <span class="n">mom8snr3</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">myMAD8</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not doing phase 2 because both SNR &lt; </span><span class="si">%.0f</span><span class="s2"> (</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">snrThreshold</span><span class="p">,</span><span class="n">mom0snr</span><span class="p">,</span><span class="n">mom8snr</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask2*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom0</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">.mask2*&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom8</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.mom0mom8jointMask&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.mom0mom8jointMask&#39;</span><span class="p">)</span>
        <span class="n">mom0snrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom0snr</span><span class="p">,</span> <span class="n">mom0snr2</span><span class="p">,</span> <span class="n">mom0snr3</span><span class="p">]</span>
        <span class="n">mom8snrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom8snr</span><span class="p">,</span> <span class="n">mom8snr2</span><span class="p">,</span> <span class="n">mom8snr3</span><span class="p">]</span>
        <span class="c1"># if no pixels were found in the mask, then build one from PB annulus, or use whole image if no PB is available.</span>
        <span class="n">numberPixelsInMask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pixelsInMask</span> <span class="ow">or</span> <span class="n">numberPixelsInMask</span> <span class="o">&lt;</span> <span class="n">minPixelsInJointMask</span><span class="p">:</span>
            <span class="n">pbBasedMask</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">))</span> 
            <span class="n">myMask1chan</span> <span class="o">=</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;.1chan&#39;</span>
            <span class="k">if</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;No pb was passed into </span><span class="si">%s</span><span class="s2"> and .residual does not appear in cube name. Using whole image.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__file__</span><span class="p">),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1">#                imsubimage(cube, chans=&#39;1&#39;, mask=&#39;&quot;%s&quot;&gt;-1000&#39;%(cube), outfile=myMask1chan, overwrite=True)</span>
                <span class="n">immath</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;iif(IM0&gt;-1000, 1.0, 0.0)&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">jointMask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Because less than </span><span class="si">%d</span><span class="s2"> pixels were in the joint mask, building pb-based mask from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minPixelsInJointMask</span><span class="p">,</span><span class="n">pbcube</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">imstatListit</span><span class="p">,</span> <span class="n">imstatVerbose</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
                
<span class="c1">#                imsubimage(pbcube, chans=&#39;1&#39;, mask=&#39;&quot;%s&quot;&gt;%f&#39; % (pbcube,higherAnnulusLevel), outfile=myMask1chan, overwrite=True) </span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">myMask1chan</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># PIPE-1629 for the pb-based jointmask case</span>
                <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">myMask1chan</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                         <span class="n">inpmask</span><span class="o">=</span><span class="n">myMask1chan</span><span class="o">+</span><span class="s1">&#39;:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">jointMaskTemp</span><span class="p">)</span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># PIPE-1629 for the pb-based jointmask case</span>
                <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="n">mom0peak</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom0</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="n">mom0snr</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom0snrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom0snr</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">mom0threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">classicResult</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">mom8</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
        <span class="n">mom8peak</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">myMAD8</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mom8snr</span> <span class="o">=</span> <span class="n">classicResult</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">myMAD8</span>
        <span class="n">mom8snrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">mom8snr</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">mom8threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mom8mask</span><span class="p">):</span>
            <span class="n">numberPixelsInMom8Mask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">mom8mask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">):</span>
            <span class="n">numberPixelsInMom8Mask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using userJointMask to set numberPixelsInMom8Mask = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInMom8Mask</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">numberPixelsInMom8Mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Neither the mom8mask nor the userJointMask exists. Setting numberPixelsInMom8Mask = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">numberPixelsInMom8Mask</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">userJointMask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jointMask</span> <span class="o">=</span> <span class="n">userJointMask</span> <span class="o">+</span> <span class="s1">&#39;.flattened&#39;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jointMask</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using existing flattened version of userJointMask&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running flattenMask(&#39;</span><span class="si">%s</span><span class="s2">&#39;, &#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">))</span>
                <span class="n">flattenMask</span><span class="p">(</span><span class="n">userJointMask</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Setting jointMask = userJointMask&quot;</span><span class="p">)</span>
            <span class="n">jointMask</span> <span class="o">=</span> <span class="n">userJointMask</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">userJointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.amendedJointMask&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># special case name</span>
                <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.amendedJointMask&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.userJointMask&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">userJointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.amendedJointMask&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># special case name</span>
                <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.amendedJointMask&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.meanSpectrum.userJointMask&#39;</span><span class="p">)</span>
<span class="c1">#        print(&quot;++++++++++++++++ Setting meanSpectrumFile = %s&quot; % (meanSpectrumFile))</span>
    <span class="n">computeFirstSpectrum</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">computeFirstSpectrum</span><span class="p">:</span>
        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointMask1</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">statistic</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">projectCode</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="p">)</span>
        <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="o">+</span><span class="s1">&#39;_bidirectional&#39;</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> 
                          <span class="n">intensity</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">,</span> 
                          <span class="n">nchan</span><span class="p">,</span> <span class="n">numberPixelsInMask</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">,</span> 
                          <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">statistic</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">projectCode</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="p">)</span>

    <span class="n">numberPixelsInMask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="c1"># Fix for CAS-11960</span>
        <span class="n">pbBasedMask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMask</span><span class="p">))</span>
        <span class="n">myMask1chan</span> <span class="o">=</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;.1chan&#39;</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Because less than </span><span class="si">%d</span><span class="s2"> pixels were in the joint mask, building pb-based mask from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minPixelsInJointMask</span><span class="p">,</span><span class="n">pbcube</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">imstatListit</span><span class="p">,</span> <span class="n">imstatVerbose</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
        
<span class="c1">#        imsubimage(pbcube, chans=&#39;1&#39;, mask=&#39;&quot;%s&quot;&gt;%f&#39; % (pbcube,higherAnnulusLevel), outfile=myMask1chan, overwrite=True)  # PL2023</span>
        <span class="n">imsubimage</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">myMask1chan</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># PIPE-1629 for pb-based jointmask case</span>
        <span class="n">makemask</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="n">inpimage</span><span class="o">=</span><span class="n">myMask1chan</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">inpmask</span><span class="o">=</span><span class="n">myMask1chan</span><span class="o">+</span><span class="s1">&#39;:mask0&#39;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="n">jointMaskTemp</span><span class="p">)</span>
        <span class="n">imsubimage</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># PIPE-1629 for the pb-based jointmask case</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">jointMaskTemp</span><span class="p">)</span>

        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">statistic</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">projectCode</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">subimage</span><span class="p">)</span>
        <span class="n">numberPixelsInMask</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
        <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">initialQuadraticImprovementRatio</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">rmStatContQuadratic</span> <span class="ow">and</span> <span class="n">enableInitialQuadratic</span><span class="p">:</span>
        <span class="n">intensity</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span> <span class="o">=</span> <span class="n">removeInitialQuadraticIfNeeded</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span><span class="n">initialQuadraticImprovementThreshold</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">initialQuadraticRemoved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">initialQuadraticImprovementRatio</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">initialPeakOverMad</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">intensity</span><span class="p">))</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nbin</span> <span class="o">&gt;=</span> <span class="n">NBIN_THRESHOLD</span><span class="p">:</span> <span class="c1"># PIPE-848  need to add a maximum peak/MAD</span>
        <span class="c1"># smooth by nbin and re-run findContinuumChannels</span>
        <span class="n">MAX_PEAK_OVER_MAD</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">if</span> <span class="n">initialPeakOverMad</span> <span class="o">&gt;</span> <span class="n">MAX_PEAK_OVER_MAD</span><span class="p">:</span>
            <span class="c1"># do not allow large nbin when strong lines are present</span>
            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span><span class="p">:</span>  <span class="c1"># ACA</span>
                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># np.min([3,NBIN_THRESHOLD])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nbin</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># np.min([2,NBIN_THRESHOLD])</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Limiting nbin to </span><span class="si">%d</span><span class="s1"> because initialPeakOverMad = </span><span class="si">%.2f</span><span class="s1"> &gt; </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">,</span><span class="n">initialPeakOverMad</span><span class="p">,</span><span class="n">MAX_PEAK_OVER_MAD</span><span class="p">))</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Applying nbin of </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nbin</span><span class="p">))</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>  <span class="c1"># original heuristic</span>
    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> 
                      <span class="n">intensity</span><span class="p">,</span> <span class="n">mom0threshold</span><span class="p">,</span> 
                      <span class="n">nchan</span><span class="p">,</span> <span class="n">numberPixelsInMask</span><span class="p">,</span> <span class="n">mom8threshold</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=</span><span class="s1">&#39;mom0mom8jointMask&#39;</span><span class="p">,</span> 
                      <span class="n">mask</span><span class="o">=</span><span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">mom0peakOverMad</span><span class="p">,</span> <span class="n">mom8peakOverMad</span></div>

<span class="c1"># immoment</span>

<div class="viewcode-block" id="locatePBCube">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.locatePBCube">[docs]</a>
<span class="k">def</span> <span class="nf">locatePBCube</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">cube</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.residual&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbcube</span><span class="p">):</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">cube</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># need this section for it to work on a clean cube instead of dirty cube</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.image&#39;</span><span class="p">,</span><span class="s1">&#39;.pb&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbcube</span><span class="p">):</span>
            <span class="n">pbcube</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pbcube</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">pbcube</span></div>


<div class="viewcode-block" id="oneEvent">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.oneEvent">[docs]</a>
<span class="k">def</span> <span class="nf">oneEvent</span><span class="p">(</span><span class="n">npts</span><span class="p">,</span> <span class="n">events</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">positive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrumFromMom0Mom8JointMask.</span>
<span class="sd">    For a specified size of a Gaussian population of data, compute the sigma </span>
<span class="sd">    that gives just less than one event, by using scipy.special.erfinv.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    positive: if True, then only considers positive events.</span>
<span class="sd">    events: how many events to allow</span>
<span class="sd">    verbose: passed to sigmaEvent</span>
<span class="sd">    Return:</span>
<span class="sd">    sigma: floating point value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">odds</span> <span class="o">=</span> <span class="n">events</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">positive</span><span class="p">:</span>
        <span class="n">odds</span> <span class="o">*=</span> <span class="mi">2</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">special</span><span class="o">.</span><span class="n">erfinv</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">odds</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span></div>


<div class="viewcode-block" id="cornersEmptyEdgesNotEmpty">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.cornersEmptyEdgesNotEmpty">[docs]</a>
<span class="k">def</span> <span class="nf">cornersEmptyEdgesNotEmpty</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">middleChannel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks if the four corner pixels of an image are masked while the four</span>
<span class="sd">    middle edge pixels are not masked --&gt; True, otherwise False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">imageInfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">middleChannel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">middleChannel</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="p">,</span> <span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">imgShape</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">maxBaselineIgnore</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="n">imageInfo</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># corners</span>
    <span class="n">box1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>       <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">)</span> 
    <span class="n">box2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>       <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">box3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>        <span class="mi">0</span><span class="p">)</span> 
    <span class="n">box4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">corners</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">[</span><span class="n">box1</span><span class="p">,</span><span class="n">box2</span><span class="p">,</span><span class="n">box3</span><span class="p">,</span><span class="n">box4</span><span class="p">]:</span>
        <span class="n">corners</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imstat</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">chans</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">middleChannel</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">])</span>
    <span class="c1"># edges</span>
    <span class="n">box1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> 
    <span class="n">box2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">box3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">naxis1</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>         <span class="mi">0</span><span class="p">)</span> 
    <span class="n">box4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">naxis1</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span>  <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>  <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">[</span><span class="n">box1</span><span class="p">,</span><span class="n">box2</span><span class="p">,</span><span class="n">box3</span><span class="p">,</span><span class="n">box4</span><span class="p">]:</span>
        <span class="n">edges</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">imstat</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">middleChannel</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)[</span><span class="s1">&#39;npts&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">corners</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">edges</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="findOuterAnnulusForPBCube">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.findOuterAnnulusForPBCube">[docs]</a>
<span class="k">def</span> <span class="nf">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">imstatListit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imstatVerbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                              <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a PB cube, finds the minimum sensitivity value, then computes the</span>
<span class="sd">    corresponding higher value to form an annulus.  Returns 0.2-0.3 for normal</span>
<span class="sd">    images that have not been mitigated.  The factor of 1.15 below will </span>
<span class="sd">    effectively mimic a corresponding higher range.  For example:</span>
<span class="sd">    CASA &lt;247&gt;: au.gaussianBeamResponse(au.gaussianBeamOffset(0.5)/1.15, fwhm=1)</span>
<span class="sd">    Out[247]: 0.59207684245045789</span>
<span class="sd">    CASA &lt;248&gt;: au.gaussianBeamResponse(au.gaussianBeamOffset(0.8)/1.15, fwhm=1)</span>
<span class="sd">    Out[248]: 0.8447381483786558</span>
<span class="sd">    subimage: if True, then add 0.2 to both radii of the annulus</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lowerAnnulusLevel</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)[</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;lowerAnnulusLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lowerAnnulusLevel</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">imageInfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span>
    <span class="n">middleChannel</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="k">if</span> <span class="n">lowerAnnulusLevel</span> <span class="o">&gt;</span> <span class="mf">0.22</span> <span class="ow">or</span> <span class="n">cornersEmptyEdgesNotEmpty</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span><span class="n">imageInfo</span><span class="p">,</span><span class="n">middleChannel</span><span class="p">):</span>
        <span class="c1"># fix for PIPE-1579</span>
        <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="p">,</span> <span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">imgShape</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">maxBaselineIgnore</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="n">imageInfo</span>
        <span class="n">response</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">box1</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>       <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">box2</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>       <span class="mi">0</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">box3</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">naxis2</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">box4</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>       <span class="mi">0</span><span class="p">,</span>        <span class="mi">0</span><span class="p">,</span> <span class="n">naxis1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>        <span class="mi">0</span><span class="p">)</span> 
        <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="p">[</span><span class="n">box1</span><span class="p">,</span><span class="n">box2</span><span class="p">,</span><span class="n">box3</span><span class="p">,</span><span class="n">box4</span><span class="p">]:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imstat</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">middleChannel</span><span class="p">),</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">)[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span>
        <span class="n">newLowerAnnulusLevel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;FOV mitigated, maximum pb along image edges: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newLowerAnnulusLevel</span><span class="p">))</span>
        <span class="c1"># compute a higher annulus level but keep the original lowerAnnulusLevel</span>
        <span class="c1"># in order to include the unmasked part of the corners in the annulus</span>
        <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">gaussianBeamResponse</span><span class="p">(</span><span class="n">gaussianBeamOffset</span><span class="p">(</span><span class="n">newLowerAnnulusLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">gaussianBeamResponse</span><span class="p">(</span><span class="n">gaussianBeamOffset</span><span class="p">(</span><span class="n">lowerAnnulusLevel</span><span class="p">)</span><span class="o">/</span><span class="mf">1.15</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;higherAnnulusLevel = </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">higherAnnulusLevel</span><span class="p">)</span>
    <span class="c1"># Note that the value of 0.21 is also used in countPixelsAboveZero and should be changed in parallel</span>
    <span class="k">if</span> <span class="n">subimage</span><span class="p">:</span>
        <span class="n">increase</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.21</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">])</span><span class="o">+</span><span class="n">increase</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="o">+</span><span class="n">increase</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mf">0.21</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">]),</span> <span class="n">higherAnnulusLevel</span></div>


<div class="viewcode-block" id="computeStatisticalSpectrumFromMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeStatisticalSpectrumFromMask">[docs]</a>
<span class="k">def</span> <span class="nf">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointmask</span><span class="p">,</span> <span class="n">pbimg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                       <span class="n">projectCode</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lowerAnnulusLevel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                       <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    New heuristic for Cycle 6 pipeline.  It is called by meanSpectrumFromMom0Mom8JointMask</span>
<span class="sd">    Uses ia.getprofile to compute the mean spectrum of a cube within a </span>
<span class="sd">    masked area.</span>
<span class="sd">    jointmask: a 2D or 3D mask image indicating which pixels shall be used</span>
<span class="sd">               or an expression with &lt; or &gt; along with a 2D or 3D mask image</span>
<span class="sd">    jointMaskForNormalize: a 2D or 3D mask image to be used when normalizeByMAD==True</span>
<span class="sd">    pbimg: the path to the primary beam of this cube, or a 2D primary beam with an expression</span>
<span class="sd">    statistic: passed to ia.getprofile via the &#39;function&#39; parameter</span>
<span class="sd">    normalizeByMAD: if True, then create the inverse of the jointmask and </span>
<span class="sd">      normalize the spectrum by the spectrum of &#39;xmadm&#39; (scaled MAD) </span>
<span class="sd">      computed on the inverse mask</span>
<span class="sd">    subimage: if True, then raise the pb level annulus by 0.2</span>
<span class="sd">    Returns: three arrays: channels, freqs(Hz), intensities, and a Boolean </span>
<span class="sd">       which says if normalization was applied</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span> <span class="c1"># freqs are in Hz</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>  <span class="c1"># lsrk</span>

    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;ia.open(&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cube</span><span class="p">))</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using jointmask = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointmask</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">jointmask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">jointmask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">jointmask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># an expression was given</span>
        <span class="n">jointmaskQuoted</span> <span class="o">=</span> <span class="n">jointmask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># a filename was given</span>
        <span class="n">jointmaskQuoted</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">jointmask</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;0&#39;</span>
    <span class="k">if</span> <span class="n">pbimg</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pbimg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pbimg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># a plain pbimg was given</span>
                <span class="c1"># Note that the value of 0.21 is also used in countPixelsAboveZero and should be changed in parallel</span>
                <span class="n">pbimgExpression</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.21&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbimg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pbimgExpression</span> <span class="o">=</span> <span class="n">pbimg</span>
            <span class="n">jointmaskQuoted</span> <span class="o">+=</span> <span class="s1">&#39; &amp;&amp; &#39;</span> <span class="o">+</span> <span class="n">pbimgExpression</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running ia.getprofile(axis=</span><span class="si">%d</span><span class="s2">, function=&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, stretch=True)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">statistic</span><span class="p">,</span> <span class="n">jointmaskQuoted</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot; on the cube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cube</span><span class="p">))</span>
    <span class="n">avgIntensity</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointmaskQuoted</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1">#   Note: I tried putting this stage here, but a strong line at spw center (2016.1.00484.L) </span>
<span class="c1">#   CS5-4 in spw21, will cause it to over-remove the quadratic, leaving a bowl which prevents</span>
<span class="c1">#   identifying the line in the later stage, and puts it in the continuum selection.</span>
<span class="c1">#    avgIntensity, initialQuadraticRemoved, initialQuadraticImprovementRatio = removeInitialQuadraticIfNeeded(avgIntensity,initialQuadraticImprovementThreshold)</span>

    <span class="n">normalized</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># start off by assuming it won&#39;t get normalized</span>
    <span class="k">if</span> <span class="n">normalizeByMAD</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pbimg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;pbimg is None, will not attempt to use the sensitivity annulus&quot;</span><span class="p">)</span>
            <span class="n">pbimgExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbimg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>  <span class="c1"># remove any &gt; &lt; expression</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not find primary beam cube: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbimg</span><span class="p">))</span>
            <span class="n">pbimgExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pbimgExists</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pbimgExists</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jointMaskForNormalize</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">]:</span>
                <span class="n">outsideMaskQuoted</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computing potential normalization spectrum from outside the joint mask (to remove atmospheric features). jointmask=</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMaskForNormalize</span><span class="p">))</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;**** Number of unmasked pixels in jointmask = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">countUnmaskedPixels</span><span class="p">(</span><span class="n">jointMaskForNormalize</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">jointMaskForNormalize</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.joint.&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outsideMask</span> <span class="o">=</span> <span class="n">jointMaskForNormalize</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.joint.&#39;</span><span class="p">,</span><span class="s1">&#39;.inverseJoint.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outsideMask</span> <span class="o">=</span> <span class="n">jointMaskForNormalize</span> <span class="o">+</span> <span class="s1">&#39;.inverseJoint&#39;</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating outsideMask = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">outsideMask</span><span class="p">))</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">jointMaskForNormalize</span> <span class="o">+</span> <span class="s1">&#39;&quot;&lt;0.5&#39;</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running imsubimage(&#39;</span><span class="si">%s</span><span class="s2">&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, outfile=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jointMaskForNormalize</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">outsideMask</span><span class="p">))</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf &#39;</span><span class="o">+</span><span class="n">outsideMask</span><span class="p">)</span>
                <span class="n">imsubimage</span><span class="p">(</span><span class="n">jointMaskForNormalize</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outsideMask</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**** Using unmasked pixels outside = &quot;</span><span class="p">,</span> <span class="n">countUnmaskedPixels</span><span class="p">(</span><span class="n">outsideMask</span><span class="p">))</span>
                <span class="n">outsideMaskQuoted</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span><span class="o">+</span><span class="n">outsideMask</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use the annulus region from 0.21-0.3, unless image does not go out that far, in </span>
            <span class="c1"># which case we use a comparable annulus that begins at a higher level</span>
            <span class="k">if</span> <span class="n">higherAnnulusLevel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pbimg</span> <span class="o">=</span> <span class="n">pbimg</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running fc.findOuterAnnulusForPbcube(&#39;</span><span class="si">%s</span><span class="s2">&#39;,False,False)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbimg</span><span class="p">))</span>
                <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbimg</span><span class="p">,</span> <span class="n">imstatListit</span><span class="p">,</span> <span class="n">imstatVerbose</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computing potential normalization spectrum from MAD of an outer annulus &lt;</span><span class="si">%.2f</span><span class="s2"> (to remove atmospheric features).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">higherAnnulusLevel</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jointMaskForNormalize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
                <span class="n">outsideMaskQuoted</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%g</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%g</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;0.5&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbimg</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbimg</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">,</span><span class="n">jointMaskForNormalize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outsideMaskQuoted</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%g</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%g</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbimg</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbimg</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running ia.getprofile(axis=</span><span class="si">%d</span><span class="s2">, function=&#39;xmadm&#39;, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;, stretch=True)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="n">outsideMaskQuoted</span><span class="p">))</span>
        <span class="n">xmadm</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;xmadm&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">outsideMaskQuoted</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
        <span class="c1"># The following is only needed for debugging</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">avgIntensityOutsideMask</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">outsideMaskQuoted</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">avgIntensityOutsideMask</span> <span class="o">=</span> <span class="n">avgIntensity</span><span class="o">*</span><span class="mf">0.0</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">originalMAD</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)</span>
        <span class="n">originalMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)])</span>
        <span class="n">avgIntensityOffset</span> <span class="o">=</span> <span class="n">avgIntensity</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="n">avgIntensityNormToZero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgIntensityOffset</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgIntensityOffset</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># this is a scalar</span>
        <span class="n">xmadmNormToZero</span> <span class="o">=</span> <span class="n">xmadm</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)</span> <span class="c1"># this is a vector</span>
        <span class="n">normalizationFactor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">xmadmNormToZero</span> <span class="o">*</span> <span class="n">avgIntensityNormToZero</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xmadmNormToZero</span><span class="p">)</span>  <span class="c1"># this is a vector</span>
        <span class="n">mymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">normalizationFactor</span><span class="p">)</span>
        <span class="n">mymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">normalizationFactor</span><span class="p">)</span>
        <span class="c1"># 2018-04-05: avoid dividing by numbers near zero and thus inserting spikes</span>
        <span class="k">if</span> <span class="n">mymin</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">mymax</span><span class="p">:</span>
            <span class="n">normalizationFactor</span> <span class="o">+=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">mymax</span> <span class="o">-</span> <span class="n">mymin</span> <span class="c1"># 1*np.median(normalizationFactor)</span>
<span class="c1">#        if mymin &lt; 0.5:</span>
<span class="c1">#            normalizationFactor += 0.5-mymin</span>
        <span class="n">myMAD</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">normalizationFactor</span><span class="p">)</span>

        <span class="n">avgIntensityNormalized</span> <span class="o">=</span> <span class="n">avgIntensityOffset</span> <span class="o">/</span> <span class="n">normalizationFactor</span> <span class="o">-</span> <span class="n">offset</span>

        <span class="c1"># Proposed modification 2018-04-05 to avoid producing spectra with negative medians:</span>
        <span class="n">myMedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgIntensityNormalized</span><span class="p">)</span>
        <span class="n">newMADestimate</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgIntensityNormalized</span><span class="p">)</span> <span class="c1"># could raise this to account for processing</span>
        <span class="n">avgIntensityNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">avgIntensityNormalized</span><span class="o">-</span><span class="n">myMedian</span><span class="p">)</span><span class="o">*</span><span class="n">originalMAD</span><span class="o">/</span><span class="n">newMADestimate</span> <span class="o">+</span> <span class="n">originalMedian</span>

        <span class="c1"># Here is where you would put writeXmadmFile()</span>

        <span class="c1"># Here we use the highest common MAD because the number of pixels may </span>
        <span class="c1"># be drastically different between the mask area and the </span>
        <span class="c1"># outside-the-mask area.  We only need to try to remove the effect </span>
        <span class="c1"># atmospheric lines if they dominate the signal spectrum.</span>
        <span class="n">highestMAD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">MAD</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">),</span> <span class="n">MAD</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)])</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;peak(avgIntensity)=</span><span class="si">%f</span><span class="s2">, MAD(avgIntensity)=</span><span class="si">%f</span><span class="s2">, MAD(xmadm)=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">),</span><span class="n">MAD</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">),</span><span class="n">MAD</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)),</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># This definition of peakOverMad will be high if there is strong continuum</span>
        <span class="c1"># or if there is a strong line. Removing the median from the peak would </span>
        <span class="c1"># eliminate the sensitivity to continuum emission.</span>
        <span class="n">peakOverMAD_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)</span> <span class="o">/</span> <span class="n">highestMAD</span>
        <span class="n">peakOverMAD_xmadm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)</span> <span class="o">/</span> <span class="n">highestMAD</span>
        <span class="n">applyNormalizationThreshold</span> <span class="o">=</span> <span class="mf">3.2</span> <span class="c1"># was initially 3.5</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># This method was attempted to try to resolve the 308 vs. 312, 355, 372 </span>
            <span class="c1"># discrepancy but caused too many other poor results.</span>
            <span class="n">peakOverMAD_signal</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">))</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)</span>
            <span class="n">peakOverMAD_xmadm</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xmadm</span><span class="p">))</span> <span class="o">/</span> <span class="n">MAD</span><span class="p">(</span><span class="n">xmadm</span><span class="p">)</span>
            <span class="n">applyNormalizationThreshold</span> <span class="o">=</span> <span class="mf">1.4</span>
            <span class="k">if</span> <span class="n">tdmSpectrum</span><span class="p">(</span><span class="n">channelWidth</span><span class="p">,</span><span class="n">nchan</span><span class="p">):</span>
                <span class="n">applyNormalizationThreshold</span> <span class="o">*=</span> <span class="mi">4</span>
                
        <span class="n">projectCode</span> <span class="o">=</span> <span class="n">projectCode</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
        <span class="k">if</span> <span class="n">peakOverMAD_xmadm</span> <span class="o">&gt;</span> <span class="n">peakOverMAD_signal</span><span class="o">/</span><span class="n">applyNormalizationThreshold</span><span class="p">:</span>
            <span class="n">avgIntensity</span> <span class="o">=</span> <span class="n">avgIntensityNormalized</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Applying normalization because peak/MAD of xmadm spectrum </span><span class="si">%f</span><span class="s1"> &gt; (peak/MAD of signal </span><span class="si">%.3f</span><span class="s1">/</span><span class="si">%.2f</span><span class="s1">=</span><span class="si">%.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">peakOverMAD_xmadm</span><span class="p">,</span><span class="n">peakOverMAD_signal</span><span class="p">,</span><span class="n">applyNormalizationThreshold</span><span class="p">,</span><span class="n">peakOverMAD_signal</span><span class="o">/</span><span class="n">applyNormalizationThreshold</span><span class="p">))</span>
            <span class="n">normalized</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Rejecting normalization because peak/MAD of xmadm spectrum </span><span class="si">%f</span><span class="s1"> &lt;= (peak/MAD of signal </span><span class="si">%.3f</span><span class="s1">/</span><span class="si">%.2f</span><span class="s1">=</span><span class="si">%.3f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">projectCode</span><span class="p">,</span> <span class="n">peakOverMAD_xmadm</span><span class="p">,</span> <span class="n">peakOverMAD_signal</span><span class="p">,</span> <span class="n">applyNormalizationThreshold</span><span class="p">,</span> <span class="n">peakOverMAD_signal</span><span class="o">/</span><span class="n">applyNormalizationThreshold</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Not-computing normalization because atmospheric variation considered too small&#39;</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgIntensity</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">nchan</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Discrepant number of channels!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">),</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">avgIntensity</span><span class="p">,</span> <span class="n">normalized</span></div>


<div class="viewcode-block" id="create_casa_quantity">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.create_casa_quantity">[docs]</a>
<span class="k">def</span> <span class="nf">create_casa_quantity</span><span class="p">(</span><span class="n">myqatool</span><span class="p">,</span><span class="n">value</span><span class="p">,</span><span class="n">unit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by CalcAtmTransmissionForImage, frames, and lsrkToRest.</span>
<span class="sd">    A wrapper to handle the changing ways in which casa quantities are invoked.</span>
<span class="sd">    Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;casac&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">casac</span><span class="o">.</span><span class="n">Quantity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">):</span>  <span class="c1"># casa 4.x</span>
            <span class="n">myqa</span> <span class="o">=</span> <span class="n">myqatool</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># casa 3.x</span>
            <span class="n">myqa</span> <span class="o">=</span> <span class="n">casac</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This is CASA 6 (same as 4.x and 5.x)</span>
        <span class="n">myqa</span> <span class="o">=</span> <span class="n">myqatool</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">unit</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">myqa</span><span class="p">)</span></div>


<div class="viewcode-block" id="MAD">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.MAD">[docs]</a>
<span class="k">def</span> <span class="nf">MAD</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mf">0.6745</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by removeInitialQuadraticIfNeeded, findContinuumChannels,</span>
<span class="sd">    meanSpectrum, computeStatisticalSpectrumFromMask, plotStatisticalSpectrumFromMask</span>
<span class="sd">    and runFindContinuum.</span>
<span class="sd">    Median Absolute Deviation along given axis of an array:</span>
<span class="sd">         median(abs(a - median(a))) / c</span>
<span class="sd">    c = 0.6745 is the constant to convert from MAD to std </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                  <span class="n">preop</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">x</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">/</span> <span class="n">c</span></div>


<div class="viewcode-block" id="splitListIntoContiguousLists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.splitListIntoContiguousLists">[docs]</a>
<span class="k">def</span> <span class="nf">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">mylist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Called by copyweights. See also splitListIntoHomogenousLists.</span>
<span class="sd">    Converts [1,2,3,5,6,7] into [[1,2,3],[5,6,7]], etc.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">mylists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newlist</span><span class="p">)</span>
            <span class="n">newlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">mylists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newlist</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span></div>


<div class="viewcode-block" id="splitListIntoContiguousListsAndRejectZeroStd">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.splitListIntoContiguousListsAndRejectZeroStd">[docs]</a>
<span class="k">def</span> <span class="nf">splitListIntoContiguousListsAndRejectZeroStd</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">nanmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Takes a list of numerical values, splits into contiguous lists and </span>
<span class="sd">    removes those that have zero standard deviation in their associated values.</span>
<span class="sd">    Note that values *must* hold the values of the whole array, while channels </span>
<span class="sd">    can be a subset.</span>
<span class="sd">    If nanmin is specified, then reject lists that contain more than 3 </span>
<span class="sd">    appearances of this value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;splitListIntoContiguousListsAndRejectZeroStd:  len(values)=</span><span class="si">%d</span><span class="s2">, len(channels)=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)))</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mylist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mylists</span><span class="p">):</span>
        <span class="n">mystd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">mylist</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mystd</span> <span class="o">&gt;</span> <span class="mf">1e-17</span><span class="p">):</span>  <span class="c1"># avoid blocks of identically-zero values</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">nanmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">minvalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">nanmin</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">minvalues</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span> <span class="ow">and</span> <span class="n">minvalues</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rejecting list </span><span class="si">%d</span><span class="s2"> with multiple min values (</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">minvalues</span><span class="p">))</span>
                    <span class="k">continue</span>
            <span class="n">channels</span> <span class="o">+=</span> <span class="n">mylist</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">))</span></div>


<div class="viewcode-block" id="convertChannelListIntoSelection">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.convertChannelListIntoSelection">[docs]</a>
<span class="k">def</span> <span class="nf">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">trim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuumChannels.</span>
<span class="sd">    Converts a list of channels into casa selection string syntax.</span>
<span class="sd">    channels: a list of channels</span>
<span class="sd">    trim: the number of channels to trim off of each edge of a block of channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">firstList</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mylist</span> <span class="ow">in</span> <span class="n">mylists</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">trim</span> <span class="o">&lt;=</span> <span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">trim</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">firstList</span><span class="p">):</span>
                    <span class="n">selection</span> <span class="o">+=</span> <span class="n">separator</span>
                <span class="n">selection</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">trim</span><span class="p">,</span> <span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">trim</span><span class="p">)</span>
                <span class="n">firstList</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span></div>


<div class="viewcode-block" id="widenSelections">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.widenSelections">[docs]</a>
<span class="k">def</span> <span class="nf">widenSelections</span><span class="p">(</span><span class="n">datfiles</span><span class="p">,</span> <span class="n">eachside</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a list of _findContinuum.dat files, and widen each channel range</span>
<span class="sd">    of the selection string by a number of channels on each side.</span>
<span class="sd">    datfiles: python list of datfiles, or a comma-delimited or wildcard string</span>
<span class="sd">    eachside: how many channels to add on each side</span>
<span class="sd">    minwidth: width of narrowest range to expand</span>
<span class="sd">    verbose: passed to widenSelection to print the new selection strings</span>
<span class="sd">    nchan: if specified, then avoid going past the final channel (nchan-1)</span>
<span class="sd">         can be an int if single file is passed (or all spws have same nchan);  </span>
<span class="sd">         or a list of ints</span>
<span class="sd">    Returns: if only 1 file passed, it returns the new selection string; if  </span>
<span class="sd">       multiple files are passed, then return the bandwidth increase factor</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newBW</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">oldBW</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datfiles</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">datfiles</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">datfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">datfiles</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datfiles</span> <span class="o">=</span> <span class="n">datfiles</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading </span><span class="si">%d</span><span class="s2"> files&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datfiles</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">datfile</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datfiles</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datfile</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find datfile: &quot;</span><span class="p">,</span> <span class="n">datfile</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">readContDat</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span>
        <span class="n">chanwidth</span> <span class="o">=</span> <span class="n">readContDatChanWidth</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="c1"># convert GHz to Hz</span>
        <span class="n">oldBW</span> <span class="o">+=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanwidth</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
            <span class="n">mynchan</span> <span class="o">=</span> <span class="n">nchan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mynchan</span> <span class="o">=</span> <span class="n">nchan</span>
        <span class="n">newSelection</span> <span class="o">=</span> <span class="n">widenSelection</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">eachside</span><span class="p">,</span> <span class="n">minwidth</span><span class="p">,</span> <span class="n">chanwidth</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">mynchan</span><span class="p">)</span>
        <span class="n">newBW</span> <span class="o">+=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">newSelection</span><span class="p">,</span> <span class="n">chanwidth</span><span class="p">)</span>
    <span class="n">factor</span> <span class="o">=</span> <span class="n">newBW</span><span class="o">/</span><span class="n">oldBW</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">datfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total bandwidth increase factor = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">factor</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bandwidth increase factor = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">factor</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">newSelection</span></div>


<div class="viewcode-block" id="widenSelection">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.widenSelection">[docs]</a>
<span class="k">def</span> <span class="nf">widenSelection</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">eachside</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minwidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">channelWidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                   <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Widen each component of a channel selection string on each side.</span>
<span class="sd">    selection: channel selection string</span>
<span class="sd">    eachside: how many channels to add on each side</span>
<span class="sd">    minwidth: width of narrowest range to expand</span>
<span class="sd">    channelWidth: width of channels in Hz</span>
<span class="sd">    verbose: if True, print the new selection</span>
<span class="sd">    nchan: if specified, then avoid going past the final channel (nchan-1)</span>
<span class="sd">    Returns: new selection string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">channelList</span> <span class="o">=</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">channelList</span><span class="p">)</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mylist</span> <span class="ow">in</span> <span class="n">mylists</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">minwidth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nchan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newlist</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eachside</span><span class="p">]),</span> <span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">eachside</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newlist</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eachside</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">eachside</span><span class="p">,</span> <span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newlist</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># the sorted(unique()) is needed to avoid producing adjacent selections </span>
    <span class="c1"># that have no channel gap, i.e. they are merged into one wider selection,</span>
    <span class="c1"># in order to prevent problems downstream when converting to topo, etc.</span>
    <span class="n">newSelection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">newlist</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Old selection: &quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;New selection: &quot;</span><span class="p">,</span> <span class="n">newSelection</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">channelWidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">oldBW</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">)</span>
        <span class="n">newBW</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">newSelection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">newBW</span><span class="o">/</span><span class="n">oldBW</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Bandwidth increase factor = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">factor</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newSelection</span></div>


<div class="viewcode-block" id="convertSelectionIntoChannelList">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.convertSelectionIntoChannelList">[docs]</a>
<span class="k">def</span> <span class="nf">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts an arbitrary CASA selection string into an array of channel numbers</span>
<span class="sd">    &#39;0~1;4~6&#39; --&gt; np.array([0,4,5])</span>
<span class="sd">    Ignores any initial spw number that preceeds a colon.  Will fail if there is more than one colon.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spw</span><span class="p">,</span> <span class="n">selection</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">selections</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">mylist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">myrange</span> <span class="ow">in</span> <span class="n">selections</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">myrange</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">[</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">]</span> <span class="o">=</span> <span class="n">myrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
            <span class="n">mylist</span> <span class="o">+=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c0</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># single value</span>
            <span class="n">mylist</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">myrange</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="CalcAtmTransmissionForImage">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.CalcAtmTransmissionForImage">[docs]</a>
<span class="k">def</span> <span class="nf">CalcAtmTransmissionForImage</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">chanInfo</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">airmass</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">pwv</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">spectralaxis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;transmission&#39;</span><span class="p">,</span> <span class="n">P</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">H</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> 
                                <span class="n">T</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">altitude</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by atmosphereVariation.</span>
<span class="sd">    Supported telescopes are VLA and ALMA (needed for default weather and PWV)</span>
<span class="sd">    img: name of CASA image</span>
<span class="sd">    value: &#39;transmission&#39; or &#39;tsky&#39;</span>
<span class="sd">    chanInfo: a list containing nchan, firstFreqHz, lastFreqHz, channelWidthHz</span>
<span class="sd">    pwv: in mm</span>
<span class="sd">    P: in mbar</span>
<span class="sd">    H: in percent</span>
<span class="sd">    T: in Kelvin</span>
<span class="sd">    Returns:</span>
<span class="sd">    2 arrays: frequencies (in GHz) and values (Kelvin, or transmission: 0..1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="c1"># Input was a spectrum rather than an image</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;chanInfo: &quot;</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">chanInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">60e9</span><span class="p">):</span>
            <span class="n">telescopeName</span> <span class="o">=</span> <span class="s1">&#39;ALMA&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">telescopeName</span> <span class="o">=</span> <span class="s1">&#39;VLA&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">telescopeName</span> <span class="o">=</span> <span class="n">getTelescope</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">chanInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">numchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span>
    <span class="n">lsrkwidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">chanInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">numchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">fromFrame</span> <span class="o">=</span> <span class="n">cubeFrameToTopo</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="n">numchan</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="n">chanInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">f1</span><span class="o">=</span><span class="n">chanInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">chanwidth</span><span class="o">=</span><span class="n">lsrkwidth</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">topofreqs</span> <span class="o">=</span> <span class="n">freqs</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">topoWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">numchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">topofreqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-9</span>
        <span class="k">if</span> <span class="n">fromFrame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Converted </span><span class="si">%s</span><span class="s2"> range, width (</span><span class="si">%f</span><span class="s2">-</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">) to TOPO (</span><span class="si">%f</span><span class="s2">-</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">) over </span><span class="si">%d</span><span class="s2"> channels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fromFrame</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span><span class="n">lsrkwidth</span><span class="p">,</span><span class="n">topofreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">topofreqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">topoWidth</span><span class="p">,</span><span class="n">numchan</span><span class="p">))</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="mf">1000.0</span> <span class="c1"># mbar</span>
    <span class="n">H0</span> <span class="o">=</span> <span class="mf">20.0</span>   <span class="c1"># percent</span>
    <span class="n">T0</span> <span class="o">=</span> <span class="mf">273.0</span>  <span class="c1"># Kelvin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">telescopeName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ALMA&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">telescopeName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ACA&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">pwv0</span> <span class="o">=</span> <span class="mf">1.0</span>   
        <span class="n">P0</span> <span class="o">=</span> <span class="mf">563.0</span>
        <span class="n">H0</span> <span class="o">=</span> <span class="mf">20.0</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="mf">273.0</span>
        <span class="n">altitude0</span> <span class="o">=</span> <span class="mi">5059</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">telescopeName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">P0</span> <span class="o">=</span> <span class="mf">786.0</span>
        <span class="n">pwv0</span> <span class="o">=</span> <span class="mf">5.0</span>  
        <span class="n">altitude0</span> <span class="o">=</span> <span class="mi">2124</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pwv0</span> <span class="o">=</span> <span class="mf">10.0</span>  
        <span class="n">altitude0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pwv</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">pwv</span> <span class="o">=</span> <span class="n">pwv0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">T</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">T0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">H</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">P</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">altitude</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">altitude</span> <span class="o">=</span> <span class="n">altitude0</span>
    <span class="n">tropical</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">midLatitudeSummer</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">midLatitudeWinter</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">topofreqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">numchan</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">topofreqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">numchan</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>
<span class="c1">#    reffreq = np.mean(topofreqs)</span>
    <span class="n">numchanModel</span> <span class="o">=</span> <span class="n">numchan</span><span class="o">*</span><span class="mi">1</span>
    <span class="n">chansepModel</span> <span class="o">=</span> <span class="p">(</span><span class="n">topofreqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">topofreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">numchanModel</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">nbands</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">fCenter</span> <span class="o">=</span> <span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
    <span class="n">fResolution</span> <span class="o">=</span> <span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span> <span class="n">chansepModel</span><span class="p">,</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
    <span class="n">fWidth</span> <span class="o">=</span> <span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span> <span class="n">numchanModel</span><span class="o">*</span><span class="n">chansepModel</span><span class="p">,</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
    <span class="n">myat</span> <span class="o">=</span> <span class="n">attool</span><span class="p">()</span>
    <span class="n">myat</span><span class="o">.</span><span class="n">initAtmProfile</span><span class="p">(</span><span class="n">humidity</span><span class="o">=</span><span class="n">H</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span><span class="n">T</span><span class="p">,</span><span class="s2">&quot;K&quot;</span><span class="p">),</span>
                        <span class="n">altitude</span><span class="o">=</span><span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span><span class="n">altitude</span><span class="p">,</span><span class="s2">&quot;m&quot;</span><span class="p">),</span>
                        <span class="n">pressure</span><span class="o">=</span><span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span><span class="n">P</span><span class="p">,</span><span class="s1">&#39;mbar&#39;</span><span class="p">),</span><span class="n">atmType</span><span class="o">=</span><span class="n">midLatitudeWinter</span><span class="p">)</span>
    <span class="n">myat</span><span class="o">.</span><span class="n">initSpectralWindow</span><span class="p">(</span><span class="n">nbands</span><span class="p">,</span> <span class="n">fCenter</span><span class="p">,</span> <span class="n">fWidth</span><span class="p">,</span> <span class="n">fResolution</span><span class="p">)</span>
    <span class="n">myat</span><span class="o">.</span><span class="n">setUserWH2O</span><span class="p">(</span><span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span> <span class="n">pwv</span><span class="p">,</span> <span class="s1">&#39;mm&#39;</span><span class="p">))</span>
<span class="c1">#    myat.setAirMass()  # This does not affect the opacity, but it does effect TebbSky, so do it manually.</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="n">dry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myat</span><span class="o">.</span><span class="n">getDryOpacitySpec</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">wet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myat</span><span class="o">.</span><span class="n">getWetOpacitySpec</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">TebbSky</span> <span class="o">=</span> <span class="n">myat</span><span class="o">.</span><span class="n">getTebbSkySpec</span><span class="p">(</span><span class="n">spwid</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="c1"># readback the values to be sure they got set</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">myat</span><span class="o">.</span><span class="n">getRefFreq</span><span class="p">()[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;There is a unit mismatch for refFreq in the atm code.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myat</span><span class="o">.</span><span class="n">getChanSep</span><span class="p">()[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;MHz&#39;</span><span class="p">):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;There is a unit mismatch for chanSep in the atm code.&quot;</span><span class="p">)</span>
    <span class="n">numchanModel</span> <span class="o">=</span> <span class="n">myat</span><span class="o">.</span><span class="n">getNumChan</span><span class="p">()</span>
    <span class="n">freq0</span> <span class="o">=</span> <span class="n">myat</span><span class="o">.</span><span class="n">getChanFreq</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">freq1</span> <span class="o">=</span> <span class="n">myat</span><span class="o">.</span><span class="n">getChanFreq</span><span class="p">(</span><span class="n">numchanModel</span><span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="c1"># We keep the original LSRK freqs for overlay on the LSRK spectrum, but associate</span>
    <span class="c1"># the transmission values from the equivalent TOPO freqs</span>
    <span class="n">newfreqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">numchanModel</span><span class="p">)</span>  <span class="c1"># fix for SCOPS-4815</span>
    <span class="n">transmission</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">airmass</span><span class="o">*</span><span class="p">(</span><span class="n">wet</span><span class="o">+</span><span class="n">dry</span><span class="p">))</span>
    <span class="n">TebbSky</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">airmass</span><span class="o">*</span><span class="p">(</span><span class="n">wet</span><span class="o">+</span><span class="n">dry</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">wet</span><span class="o">-</span><span class="n">dry</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">value</span><span class="o">==</span><span class="s1">&#39;transmission&#39;</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">transmission</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">TebbSky</span>
    <span class="k">del</span> <span class="n">myat</span>
    <span class="k">return</span><span class="p">(</span><span class="n">newfreqs</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span></div>


<div class="viewcode-block" id="mjdToUT">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.mjdToUT">[docs]</a>
<span class="k">def</span> <span class="nf">mjdToUT</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span> <span class="n">use_metool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by getDateObs.</span>
<span class="sd">    Converts an MJD value to a UT date and time string</span>
<span class="sd">    such as &#39;2012-03-14 00:00:00 UT&#39;</span>
<span class="sd">    use_metool: whether or not to use the CASA measures tool if running from CASA.</span>
<span class="sd">         This parameter is simply for testing the non-casa calculation.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mjdsec</span> <span class="o">=</span> <span class="n">mjd</span><span class="o">*</span><span class="mi">86400</span>
    <span class="n">utstring</span> <span class="o">=</span> <span class="n">mjdSecondsToMJDandUT</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">,</span> <span class="n">use_metool</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">utstring</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="mjdSecondsToMJDandUT">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.mjdSecondsToMJDandUT">[docs]</a>
<span class="k">def</span> <span class="nf">mjdSecondsToMJDandUT</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by mjdToUT.</span>
<span class="sd">    Converts a value of MJD seconds into MJD, and into a UT date/time string.</span>
<span class="sd">    prec: 6 means HH:MM:SS,  7 means HH:MM:SS.S</span>
<span class="sd">    example: (56000.0, &#39;2012-03-14 00:00:00 UT&#39;)</span>
<span class="sd">    Caveat: only works for a scalar input value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myme</span> <span class="o">=</span> <span class="n">metool</span><span class="p">()</span>
    <span class="n">today</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span><span class="s1">&#39;today&#39;</span><span class="p">)</span>
    <span class="n">mjd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mjdsec</span><span class="p">)</span> <span class="o">/</span> <span class="mf">86400.</span>
    <span class="n">today</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">mjd</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">hhmmss</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">today</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">splitdate</span><span class="p">(</span><span class="n">today</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">utstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s%s%02d%s%02d</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> UT&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">],</span><span class="n">delimiter</span><span class="p">,</span><span class="n">date</span><span class="p">[</span><span class="s1">&#39;month&#39;</span><span class="p">],</span><span class="n">delimiter</span><span class="p">,</span>
                                             <span class="n">date</span><span class="p">[</span><span class="s1">&#39;monthday&#39;</span><span class="p">],</span><span class="n">hhmmss</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">mjd</span><span class="p">,</span> <span class="n">utstring</span><span class="p">)</span></div>


<div class="viewcode-block" id="cubeFrameToTopo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.cubeFrameToTopo">[docs]</a>
<span class="k">def</span> <span class="nf">cubeFrameToTopo</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">,</span> <span class="n">freqrange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                    <span class="n">nchan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">f1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chanwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by CalcAtmTransmissionForImage and writeContDat.</span>
<span class="sd">    Reads the date of observation, central RA and Dec,</span>
<span class="sd">    and observatory from an image cube and then calls lsrkToTopo to</span>
<span class="sd">    return the specified frequency range in TOPO, and the name of the original </span>
<span class="sd">    frame that was converted (which will not be a REST-frame cube&#39;s frame if </span>
<span class="sd">    vis not specified).</span>
<span class="sd">    If the cube is in REST frame, it calls casaRestToTopo(), and if the cube is</span>
<span class="sd">    in LSRK frame, it calls lsrkToTopo().</span>
<span class="sd">    freqrange: desired range of frequencies (empty string or list = whole cube)</span>
<span class="sd">          floating point list of two frequencies, or a delimited string</span>
<span class="sd">          (delimiter = &#39;,&#39;, &#39;~&#39; or space)</span>
<span class="sd">    prec: in fractions of Hz (only used to display the value when verbose=True)</span>
<span class="sd">    chanwidth: unused</span>
<span class="sd">    vis: read date of observation from the specified measurement set (instead of from img)</span>
<span class="sd">    &quot;&quot;&quot;</span>
<span class="c1">#    print(&quot;cubeFrameToTopo received spw = %s.  type=%s&quot; % (str(spw), type(spw)))</span>
    <span class="k">if</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">getFreqType</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TOPO&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This cube is purportedly already in TOPO.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">f1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">chanwidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">nchan</span><span class="p">,</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">chanwidth</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqrange</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startFreq</span> <span class="o">=</span> <span class="n">f0</span> 
        <span class="n">stopFreq</span> <span class="o">=</span> <span class="n">f1</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">freqrange</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">freqrange</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">freqrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">parseFrequencyArgument</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">freqrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">freqrange</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">freqrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">parseFrequencyArgument</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">freqrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freqrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">parseFrequencyArgument</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">freqrange</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
        <span class="n">startFreq</span><span class="p">,</span> <span class="n">stopFreq</span> <span class="o">=</span> <span class="n">freqrange</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startFreq</span><span class="p">,</span> <span class="n">stopFreq</span> <span class="o">=</span> <span class="n">freqrange</span>
    <span class="n">ra</span><span class="p">,</span><span class="n">dec</span> <span class="o">=</span> <span class="n">rad2radec</span><span class="p">(</span><span class="n">imageInfo</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">imageInfo</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">equinox</span> <span class="o">=</span> <span class="n">getEquinox</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">observatory</span> <span class="o">=</span> <span class="n">getTelescope</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">myia</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">datestring</span> <span class="o">=</span> <span class="n">getDateObs</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">myia</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Measurement set does not exist!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">datestring</span> <span class="o">=</span> <span class="n">getObservationStartDate</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">myType</span> <span class="o">=</span> <span class="n">getFreqType</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">myType</span> <span class="o">==</span> <span class="s1">&#39;LSRK&#39;</span> <span class="ow">or</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;6.2&#39;</span> <span class="ow">or</span> <span class="n">vis</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">myType</span> <span class="o">==</span> <span class="s1">&#39;REST&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&lt;</span> <span class="s1">&#39;6.2&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;WARNING: This CASA version is unable to convert from REST to TOPO. Converting from LSKR to TOPO instead.  Atmospheric overlay will not be quite right.&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">vis</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;WARNING: This cube is in REST frame, but the vis parameter was not supplied. Converting from LSKR to TOPO instead.  Atmospheric overlay will not be quite right.&#39;</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="s1">&#39;WARN&#39;</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">lsrkToTopo</span><span class="p">(</span><span class="n">startFreq</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">lsrkToTopo</span><span class="p">(</span><span class="n">stopFreq</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span> 
        <span class="n">fromFrame</span> <span class="o">=</span> <span class="s1">&#39;LSRK&#39;</span>
    <span class="k">elif</span> <span class="n">myType</span> <span class="o">==</span> <span class="s1">&#39;REST&#39;</span><span class="p">:</span>
        <span class="n">fromFrame</span> <span class="o">=</span> <span class="s1">&#39;REST&#39;</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">getSpwFromPipelineImageName</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Read spw </span><span class="si">%d</span><span class="s2"> from image name, type=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">spw</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">fieldIDForName</span><span class="p">(</span><span class="n">mymsmd</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="n">chanfreqs</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;    Calling fc.casaRestToTopo(</span><span class="si">%f</span><span class="s2">, </span><span class="si">%f</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startFreq</span><span class="p">,</span> <span class="n">stopFreq</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">fieldid</span><span class="p">))</span>
        <span class="n">c0</span><span class="p">,</span> <span class="n">c1</span> <span class="o">=</span> <span class="n">casaRestToTopo</span><span class="p">(</span><span class="n">startFreq</span><span class="p">,</span> <span class="n">stopFreq</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">)</span>
        <span class="c1"># convert TOPO channel to TOPO frequency</span>
        <span class="k">if</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>  <span class="c1"># USB</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># LSB</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="n">c1</span><span class="p">]</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="n">c0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Unrecognized frequency frame type: </span><span class="si">%s</span><span class="s1">.  Skipping frame conversion.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myType</span><span class="p">))</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">startFreq</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">stopFreq</span>
        <span class="n">fromFrame</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">]),</span> <span class="n">fromFrame</span><span class="p">)</span></div>


<div class="viewcode-block" id="fieldIDForName">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.fieldIDForName">[docs]</a>
<span class="k">def</span> <span class="nf">fieldIDForName</span><span class="p">(</span><span class="n">mymsmd</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns field ID for source name, ignoring those fields which are not used</span>
<span class="sd">    to observe the main target and calibrator intents (when those intents are</span>
<span class="sd">    also observed).</span>
<span class="sd">    Note: the following simple mechanism will fail if there is an ATMOSPHERE-only field</span>
<span class="sd">    fieldnames = mymsmd.fieldnames()</span>
<span class="sd">    fieldid = fieldnames.index(source)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fieldids</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">fieldsforname</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">intents</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">intentsforfield</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">intentfields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;OBSERVE_TARGET#ON_SOURCE&#39;</span><span class="p">,</span><span class="s1">&#39;CALIBRATE_BANDPASS#ON_SOURCE&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;CALIBRATE_PHASE#ON_SOURCE&#39;</span><span class="p">,</span><span class="s1">&#39;CALIBRATE_FLUX#ON_SOURCE&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;CALIBRATE_POLARIZATION#ON_SOURCE&#39;</span><span class="p">,</span><span class="s1">&#39;OBSERVE_CHECK_SOURCE#ON_SOURCE&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">intents</span><span class="p">:</span>
            <span class="n">intentfields</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">fieldsforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intentfields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">intentfields</span><span class="p">,</span><span class="n">fieldids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;    Picked field ID </span><span class="si">%d</span><span class="s1"> for intent </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fieldid</span><span class="p">,</span><span class="n">intent</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">fieldids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;    Picked field ID </span><span class="si">%d</span><span class="s1"> from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fieldid</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldids</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">fieldid</span></div>


<div class="viewcode-block" id="getObservationStartDate">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getObservationStartDate">[docs]</a>
<span class="k">def</span> <span class="nf">getObservationStartDate</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">obsid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">measuresToolFormat</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the tb tool to read the start time of the observation and reports the date.</span>
<span class="sd">    See also getObservationStartDay.</span>
<span class="sd">    Returns: &#39;2013-01-31 07:36:01 UT&#39;</span>
<span class="sd">    measuresToolFormat: if True, then return &#39;2013/01/31/07:36:01&#39;, suitable for lsrkToTopo</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mjdsec</span> <span class="o">=</span> <span class="n">getObservationStart</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">obsid</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mjdsec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">obsdateString</span> <span class="o">=</span> <span class="n">mjdToUT</span><span class="p">(</span><span class="n">mjdsec</span><span class="o">/</span><span class="mf">86400.</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">):</span>
        <span class="n">obsdateString</span> <span class="o">=</span> <span class="n">obsdateString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">measuresToolFormat</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">obsdateString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; UT&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">obsdateString</span><span class="p">)</span></div>


<div class="viewcode-block" id="rad2radec">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.rad2radec">[docs]</a>
<span class="k">def</span> <span class="nf">rad2radec</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">dec</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
              <span class="n">replaceDecDotsWithColons</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">hmsdms</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;, &#39;</span><span class="p">,</span>
              <span class="n">prependEquinox</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">hmdm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by cubeFrameToTopo.</span>
<span class="sd">    Convert a position in RA/Dec from radians to sexagesimal string which</span>
<span class="sd">    is comma-delimited, e.g. &#39;20:10:49.01, +057:17:44.806&#39;.</span>
<span class="sd">    The position can either be entered as scalars via the &#39;ra&#39; and &#39;dec&#39; </span>
<span class="sd">    parameters, as a tuple via the &#39;ra&#39; parameter, or as an array of shape (2,1)</span>
<span class="sd">    via the &#39;ra&#39; parameter.</span>
<span class="sd">    replaceDecDotsWithColons: replace dots with colons as the Declination d/m/s delimiter</span>
<span class="sd">    hmsdms: produce output of format: &#39;20h10m49.01s, +057d17m44.806s&#39;</span>
<span class="sd">    hmdm: produce output of format: &#39;20h10m49.01, +057d17m44.806&#39; (for simobserve)</span>
<span class="sd">    delimiter: the character to use to delimit the RA and Dec strings output</span>
<span class="sd">    prependEquinox: if True, insert &quot;J2000&quot; before coordinates (i.e. for clean or simobserve)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># must come first before ra is redefined</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">myra</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">formxxx</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.12f</span><span class="s1">rad&#39;</span><span class="o">%</span><span class="n">ra</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;hms&#39;</span><span class="p">,</span><span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">mydec</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">formxxx</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.12f</span><span class="s1">rad&#39;</span><span class="o">%</span><span class="n">dec</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;dms&#39;</span><span class="p">,</span><span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">replaceDecDotsWithColons</span><span class="p">:</span>
        <span class="n">mydec</span> <span class="o">=</span> <span class="n">mydec</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mydec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">):</span>
        <span class="n">mydec</span> <span class="o">=</span> <span class="n">mydec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">mydec</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">mystring</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myra</span><span class="p">,</span> <span class="n">mydec</span><span class="p">)</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hmsdms</span><span class="p">):</span>
        <span class="n">mystring</span> <span class="o">=</span> <span class="n">convertColonDelimitersToHMSDMS</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prependEquinox</span><span class="p">):</span>
            <span class="n">mystring</span> <span class="o">=</span> <span class="s2">&quot;J2000 &quot;</span> <span class="o">+</span> <span class="n">mystring</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">hmdm</span><span class="p">):</span>
        <span class="n">mystring</span> <span class="o">=</span> <span class="n">convertColonDelimitersToHMSDMS</span><span class="p">(</span><span class="n">mystring</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prependEquinox</span><span class="p">):</span>
            <span class="n">mystring</span> <span class="o">=</span> <span class="s2">&quot;J2000 &quot;</span> <span class="o">+</span> <span class="n">mystring</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">delimiter</span> <span class="o">!=</span> <span class="s1">&#39;, &#39;</span><span class="p">):</span>
        <span class="n">mystring</span> <span class="o">=</span> <span class="n">mystring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">mystring</span><span class="p">)</span></div>


<div class="viewcode-block" id="convertColonDelimitersToHMSDMS">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.convertColonDelimitersToHMSDMS">[docs]</a>
<span class="k">def</span> <span class="nf">convertColonDelimitersToHMSDMS</span><span class="p">(</span><span class="n">mystring</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usePeriodsForDeclination</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by rad2radec.</span>
<span class="sd">    Converts HH:MM:SS.SSS, +DD:MM:SS.SSS  to  HHhMMmSS.SSSs, +DDdMMmSS.SSSs</span>
<span class="sd">          or HH:MM:SS.SSS +DD:MM:SS.SSS   to  HHhMMmSS.SSSs +DDdMMmSS.SSSs</span>
<span class="sd">          or HH:MM:SS.SSS, +DD:MM:SS.SSS  to  HHhMMmSS.SSSs, +DD.MM.SS.SSS</span>
<span class="sd">          or HH:MM:SS.SSS +DD:MM:SS.SSS   to  HHhMMmSS.SSSs +DD.MM.SS.SSS</span>
<span class="sd">    s: whether or not to include the trailing &#39;s&#39; in both axes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">colons</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">colons</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mystring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">mystring</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Insufficient number of colons (</span><span class="si">%d</span><span class="s2">) to proceed (need 4)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colons</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">usePeriodsForDeclination</span><span class="p">):</span>
        <span class="n">decdeg</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">decmin</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">decsec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">decdeg</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span>
        <span class="n">decmin</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
        <span class="n">decsec</span> <span class="o">=</span> <span class="s1">&#39;s&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">):</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="n">mystring</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;s,&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">decdeg</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">decmin</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">decsec</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mystring</span><span class="p">):</span>
            <span class="n">outstring</span> <span class="o">=</span> <span class="n">outstring</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;s &#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outstring</span> <span class="o">=</span> <span class="n">mystring</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;h&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;m&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">decdeg</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="n">decmin</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">outstring</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="casaRestToTopo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.casaRestToTopo">[docs]</a>
<span class="k">def</span> <span class="nf">casaRestToTopo</span><span class="p">(</span><span class="n">restFrequency</span><span class="p">,</span> <span class="n">restFrequency2</span><span class="p">,</span> <span class="n">msname</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a range of SOURCE frame frequencies to TOPO channels in a </span>
<span class="sd">    specified measurement set.  The input frequencies should be the </span>
<span class="sd">    center frequencies of the edge channels in the cube.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># needs to use new tool in CASA 6.2</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">synthesisutils</span>
    <span class="c1"># Figure out which channels in the ms were used to make the SOURCE frame</span>
    <span class="c1"># cube</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="n">su</span> <span class="o">=</span> <span class="n">synthesisutils</span><span class="p">()</span>
    <span class="c1"># this function expects the center frequency of each edge channel and returns channel number in ms/spw</span>
    <span class="n">mydict</span> <span class="o">=</span> <span class="n">su</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">,</span>
                              <span class="n">ephemtable</span><span class="o">=</span><span class="s1">&#39;TRACKFIELD&#39;</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="n">fieldid</span><span class="p">,</span>
                              <span class="n">freqstart</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">Hz&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">restFrequency</span><span class="p">),</span>
                              <span class="n">freqend</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">Hz&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">restFrequency2</span><span class="p">))</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">startChan</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;nchan&#39;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">stopChan</span> <span class="o">=</span> <span class="n">startChan</span> <span class="o">+</span> <span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;    TOPO channel range in ms: </span><span class="si">%d</span><span class="s2">-</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startChan</span><span class="p">,</span><span class="n">stopChan</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">startChan</span><span class="p">,</span> <span class="n">stopChan</span></div>


<div class="viewcode-block" id="lsrkToTopo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.lsrkToTopo">[docs]</a>
<span class="k">def</span> <span class="nf">lsrkToTopo</span><span class="p">(</span><span class="n">lsrkFrequency</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="o">=</span><span class="s1">&#39;J2000&#39;</span><span class="p">,</span> 
               <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by cubeFrameToTopo.</span>
<span class="sd">    Converts an LSRKfrequency and observing date/direction</span>
<span class="sd">    to the corresponding frequency in the TOPO frame.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    lsrkFrequency: floating point value in Hz or GHz, or a string with units</span>
<span class="sd">    datestring:  &quot;YYYY/MM/DD/HH:MM:SS&quot; (format = image header keyword &#39;date-obs&#39;)</span>
<span class="sd">    ra: string &quot;HH:MM:SS.SSSS&quot;</span>
<span class="sd">    dec: string &quot;DD.MM.SS.SSSS&quot; or &quot;DD:MM:SS.SSSS&quot; (colons will be replaced with .)</span>
<span class="sd">    prec: only used to display the value when verbose=True</span>
<span class="sd">    Returns: the TOPO frequency in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">velocityLSRK</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># does not matter what it is, just needs to be same in both calls</span>
    <span class="n">restFreqHz</span> <span class="o">=</span> <span class="n">lsrkToRest</span><span class="p">(</span><span class="n">lsrkFrequency</span><span class="p">,</span> <span class="n">velocityLSRK</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="p">,</span>
                            <span class="n">observatory</span><span class="p">,</span> <span class="n">prec</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">topoFrequencyHz</span> <span class="o">=</span> <span class="n">restToTopo</span><span class="p">(</span><span class="n">restFreqHz</span><span class="p">,</span> <span class="n">velocityLSRK</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="p">,</span> 
                                <span class="n">observatory</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">topoFrequencyHz</span></div>


<div class="viewcode-block" id="lsrkToRest">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.lsrkToRest">[docs]</a>
<span class="k">def</span> <span class="nf">lsrkToRest</span><span class="p">(</span><span class="n">lsrkFrequency</span><span class="p">,</span> <span class="n">velocityLSRK</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> 
               <span class="n">equinox</span><span class="o">=</span><span class="s1">&#39;J2000&#39;</span><span class="p">,</span> <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by lsrkToTopo.</span>
<span class="sd">    Converts an LSRK frequency, LSRK velocity, and observing date/direction</span>
<span class="sd">    to the corresponding frequency in the rest frame.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    lsrkFrequency: floating point value in Hz or GHz, or a string with units</span>
<span class="sd">    velocityLSRK: floating point value in km/s</span>
<span class="sd">    datestring:  &quot;YYYY/MM/DD/HH:MM:SS&quot; (format = image header keyword &#39;date-obs&#39;)</span>
<span class="sd">    ra: string &quot;HH:MM:SS.SSSS&quot;</span>
<span class="sd">    dec: string &quot;DD.MM.SS.SSSS&quot; or &quot;DD:MM:SS.SSSS&quot; (colons will be replaced with .)</span>
<span class="sd">    prec: only used to display the value when verbose=True</span>
<span class="sd">    Returns: the Rest frequency in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: replacing colons with decimals in the dec field.&quot;</span><span class="p">)</span>
    <span class="n">freqGHz</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">lsrkFrequency</span><span class="p">)</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">myme</span> <span class="o">=</span> <span class="n">metool</span><span class="p">()</span>
    <span class="n">velocityRadio</span> <span class="o">=</span> <span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span><span class="n">velocityLSRK</span><span class="p">,</span><span class="s2">&quot;km/s&quot;</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">equinox</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
    <span class="n">obstime</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="s1">&#39;TAI&#39;</span><span class="p">,</span> <span class="n">datestring</span><span class="p">)</span>
    <span class="n">dopp</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">doppler</span><span class="p">(</span><span class="s2">&quot;RADIO&quot;</span><span class="p">,</span><span class="n">velocityRadio</span><span class="p">)</span>
    <span class="n">radialVelocityLSRK</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">toradialvelocity</span><span class="p">(</span><span class="s2">&quot;LSRK&quot;</span><span class="p">,</span><span class="n">dopp</span><span class="p">)</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">myme</span><span class="o">.</span><span class="n">observatory</span><span class="p">(</span><span class="n">observatory</span><span class="p">))</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span>
    <span class="n">rvelRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">radialVelocityLSRK</span><span class="p">,</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
    <span class="n">doppRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">todoppler</span><span class="p">(</span><span class="s1">&#39;RADIO&#39;</span><span class="p">,</span> <span class="n">rvelRad</span><span class="p">)</span>
    <span class="n">freqRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">torestfrequency</span><span class="p">(</span><span class="n">myme</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">freqGHz</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;GHz&#39;</span><span class="p">),</span> <span class="n">dopp</span><span class="p">)</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">freqRad</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="restToTopo">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.restToTopo">[docs]</a>
<span class="k">def</span> <span class="nf">restToTopo</span><span class="p">(</span><span class="n">restFrequency</span><span class="p">,</span> <span class="n">velocityLSRK</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="o">=</span><span class="s1">&#39;J2000&#39;</span><span class="p">,</span> 
               <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> <span class="n">veltype</span><span class="o">=</span><span class="s1">&#39;radio&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by lsrkToTopo.</span>
<span class="sd">    Converts a rest frequency, LSRK velocity, and observing date/direction</span>
<span class="sd">    to the corresponding frequency in the TOPO frame.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    restFrequency: floating point value in Hz or GHz, or a string with units</span>
<span class="sd">    velocityLSRK: floating point value in km/s</span>
<span class="sd">    datestring:  &quot;YYYY/MM/DD/HH:MM:SS&quot;</span>
<span class="sd">    ra: string &quot;HH:MM:SS.SSSS&quot;</span>
<span class="sd">    dec: string &quot;DD.MM.SS.SSSS&quot; or &quot;DD:MM:SS.SSSS&quot; (colons will be replaced with .)</span>
<span class="sd">    prec: only used to display the value when verbose=True</span>
<span class="sd">    Returns: the TOPO frequency in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">topoFreqHz</span><span class="p">,</span> <span class="n">diff1</span><span class="p">,</span> <span class="n">diff2</span> <span class="o">=</span> <span class="n">frames</span><span class="p">(</span><span class="n">velocityLSRK</span><span class="p">,</span> <span class="n">datestring</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">equinox</span><span class="p">,</span> 
                                      <span class="n">observatory</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
                                      <span class="n">restFreq</span><span class="o">=</span><span class="n">restFrequency</span><span class="p">,</span> <span class="n">veltype</span><span class="o">=</span><span class="n">veltype</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">topoFreqHz</span></div>


<div class="viewcode-block" id="frames">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.frames">[docs]</a>
<span class="k">def</span> <span class="nf">frames</span><span class="p">(</span><span class="n">velocity</span><span class="o">=</span><span class="mf">286.7</span><span class="p">,</span> <span class="n">datestring</span><span class="o">=</span><span class="s2">&quot;2005/11/01/00:00:00&quot;</span><span class="p">,</span>
           <span class="n">ra</span><span class="o">=</span><span class="s2">&quot;05:35:28.105&quot;</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="s2">&quot;-069.16.10.99&quot;</span><span class="p">,</span> <span class="n">equinox</span><span class="o">=</span><span class="s2">&quot;J2000&quot;</span><span class="p">,</span> 
           <span class="n">observatory</span><span class="o">=</span><span class="s2">&quot;ALMA&quot;</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">myme</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">myqa</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
           <span class="n">restFreq</span><span class="o">=</span><span class="mf">345.79599</span><span class="p">,</span> <span class="n">veltype</span><span class="o">=</span><span class="s1">&#39;optical&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by restToTopo.</span>
<span class="sd">    Converts an optical velocity into barycentric, LSRK and TOPO frames.</span>
<span class="sd">    Converts a radio LSRK velocity into TOPO frame.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    velocity: in km/s</span>
<span class="sd">    datestring:  &quot;YYYY/MM/DD/HH:MM:SS&quot;</span>
<span class="sd">    ra: &quot;05:35:28.105&quot;</span>
<span class="sd">    dec: &quot;-069.16.10.99&quot;</span>
<span class="sd">    equinox: &quot;J2000&quot; </span>
<span class="sd">    observatory: &quot;ALMA&quot;</span>
<span class="sd">    prec: precision to display (digits to the right of the decimal point)</span>
<span class="sd">    veltype: &#39;radio&#39; or &#39;optical&#39;</span>
<span class="sd">    restFreq: in Hz, GHz or a string with units</span>
<span class="sd">    Returns: </span>
<span class="sd">    * TOPO frequency in Hz</span>
<span class="sd">    * difference between LSRK-TOPO in km/sec</span>
<span class="sd">    * difference between LSRK-TOPO in Hz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">localme</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">localqa</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myme</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">myme</span> <span class="o">=</span> <span class="n">metool</span><span class="p">()</span>
        <span class="n">localme</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myqa</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
        <span class="n">localqa</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dec</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">equinox</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span>
    <span class="n">obstime</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="s1">&#39;TAI&#39;</span><span class="p">,</span> <span class="n">datestring</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">veltype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;opt&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">velOpt</span> <span class="o">=</span> <span class="n">create_casa_quantity</span><span class="p">(</span><span class="n">myqa</span><span class="p">,</span><span class="n">velocity</span><span class="p">,</span><span class="s2">&quot;km/s&quot;</span><span class="p">)</span>
        <span class="n">dopp</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">doppler</span><span class="p">(</span><span class="s2">&quot;OPTICAL&quot;</span><span class="p">,</span><span class="n">velOpt</span><span class="p">)</span>
        <span class="c1"># CASA doesn&#39;t do Helio, but difference to Bary is hopefully small</span>
        <span class="n">rvelOpt</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">toradialvelocity</span><span class="p">(</span><span class="s2">&quot;BARY&quot;</span><span class="p">,</span><span class="n">dopp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">veltype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;rad&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">rvelOpt</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">radialvelocity</span><span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;veltype must be &#39;rad&#39;io or &#39;opt&#39;ical&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">myme</span><span class="o">.</span><span class="n">observatory</span><span class="p">(</span><span class="n">observatory</span><span class="p">))</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">obstime</span><span class="p">)</span>
    <span class="n">myme</span><span class="o">.</span><span class="n">showframe</span><span class="p">()</span>

    <span class="n">rvelRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">rvelOpt</span><span class="p">,</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
    <span class="n">doppRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">todoppler</span><span class="p">(</span><span class="s2">&quot;RADIO&quot;</span><span class="p">,</span><span class="n">rvelRad</span><span class="p">)</span>       
    <span class="n">restFreq</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">restFreq</span><span class="p">)</span>
    <span class="n">freqRad</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">tofrequency</span><span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="n">doppRad</span><span class="p">,</span> <span class="n">myme</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">restFreq</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;GHz&#39;</span><span class="p">))</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">lsrk</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">rvelRad</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span><span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="p">)</span>
    <span class="n">rvelTop</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">rvelOpt</span><span class="p">,</span><span class="s1">&#39;TOPO&#39;</span><span class="p">)</span>
    <span class="n">doppTop</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">todoppler</span><span class="p">(</span><span class="s2">&quot;RADIO&quot;</span><span class="p">,</span><span class="n">rvelTop</span><span class="p">)</span>       
    <span class="n">freqTop</span> <span class="o">=</span> <span class="n">myme</span><span class="o">.</span><span class="n">tofrequency</span><span class="p">(</span><span class="s1">&#39;TOPO&#39;</span><span class="p">,</span> <span class="n">doppTop</span><span class="p">,</span> <span class="n">myme</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="s1">&#39;rest&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">restFreq</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;GHz&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">localme</span><span class="p">):</span>
        <span class="n">myme</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">topo</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">rvelTop</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span><span class="n">prec</span><span class="o">=</span><span class="n">prec</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">localqa</span><span class="p">):</span>
        <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">velocityDifference</span> <span class="o">=</span> <span class="mf">0.001</span><span class="o">*</span><span class="p">(</span><span class="n">rvelRad</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">rvelTop</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
    <span class="n">frequencyDifference</span> <span class="o">=</span> <span class="n">freqRad</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freqTop</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">freqTop</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">velocityDifference</span><span class="p">,</span> <span class="n">frequencyDifference</span><span class="p">)</span></div>


<div class="viewcode-block" id="parseFrequencyArgumentToGHz">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.parseFrequencyArgumentToGHz">[docs]</a>
<span class="k">def</span> <span class="nf">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by frames and lsrkToRest.</span>
<span class="sd">    Converts a frequency string into floating point in GHz, based on the units.</span>
<span class="sd">    If the units are not present, then the value is assumed to be GHz if less</span>
<span class="sd">    than 1000.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">parseFrequencyArgument</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">*=</span> <span class="mf">1e-9</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="parseFrequencyArgumentToHz">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.parseFrequencyArgumentToHz">[docs]</a>
<span class="k">def</span> <span class="nf">parseFrequencyArgumentToHz</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a frequency string into floating point in Hz, based on the units.</span>
<span class="sd">    If the units are not present, then the value is assumed to be GHz if less</span>
<span class="sd">    than 1000 (in contrast to parseFrequencyArgument).</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e9</span>
    <span class="k">return</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="parseFrequencyArgument">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.parseFrequencyArgument">[docs]</a>
<span class="k">def</span> <span class="nf">parseFrequencyArgument</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by parseFrequencyArgumentToGHz, topoFreqToChannel and cubeFrameToTopo.</span>
<span class="sd">    Converts a string frequency into floating point in Hz, based on the units.</span>
<span class="sd">    If the units are not present, then the value is simply converted to float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">bandwidth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span>
    <span class="n">ghz</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ghz&#39;</span><span class="p">)</span>
    <span class="n">mhz</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mhz&#39;</span><span class="p">)</span>
    <span class="n">khz</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;khz&#39;</span><span class="p">)</span>
    <span class="n">hz</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;hz&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ghz</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">1e9</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">[:</span><span class="n">ghz</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">mhz</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">1e6</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">[:</span><span class="n">mhz</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">khz</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mf">1e3</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">[:</span><span class="n">khz</span><span class="p">])</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">hz</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">[:</span><span class="n">hz</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">bandwidth</span><span class="p">)</span></div>


<div class="viewcode-block" id="intersectChannelSelections">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.intersectChannelSelections">[docs]</a>
<span class="k">def</span> <span class="nf">intersectChannelSelections</span><span class="p">(</span><span class="n">selection1</span><span class="p">,</span> <span class="n">selection2</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take the intersection of two ranges.</span>
<span class="sd">    e.g. &#39;3~8;10~11&#39;, &#39;5~9&#39;  -&gt;  &#39;5~8&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list1</span> <span class="o">=</span> <span class="n">channelSelectionRangesToIndexArray</span><span class="p">(</span><span class="n">selection1</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
    <span class="n">list2</span> <span class="o">=</span> <span class="n">channelSelectionRangesToIndexArray</span><span class="p">(</span><span class="n">selection2</span><span class="p">,</span> <span class="n">separator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span><span class="n">list2</span><span class="p">))</span></div>


<div class="viewcode-block" id="channelSelectionRangesToIndexArray">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.channelSelectionRangesToIndexArray">[docs]</a>
<span class="k">def</span> <span class="nf">channelSelectionRangesToIndexArray</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Convert a channel selection range string to integer array of indices.</span>
<span class="sd">    e.g.:  &#39;3~8;10~11&#39; -&gt; [3,4,5,6,7,8,10,11]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="linfit">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.linfit">[docs]</a>
<span class="k">def</span> <span class="nf">linfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerror</span><span class="p">,</span> <span class="n">pinit</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by atmosphereVariation in Cycle 4+5+6 and by</span>
<span class="sd">    runFindContinuum in Cycle 4+5.</span>
<span class="sd">    Basic linear function fitter with error bars in y-axis data points.</span>
<span class="sd">    Uses scipy.optimize.leastsq().  Accepts either lists or arrays.</span>
<span class="sd">    Example:</span>
<span class="sd">         lf = au.linfit()</span>
<span class="sd">         lf.linfit(x, y, yerror, pinit)</span>
<span class="sd">    Input:</span>
<span class="sd">         x, y: x and y axis values</span>
<span class="sd">         yerror: uncertainty in the y-axis values (vector or scalar)</span>
<span class="sd">         pinit contains the initial guess of [slope, intercept]</span>
<span class="sd">    Output:</span>
<span class="sd">       The fit result as: [slope, y-intercept]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">yerror</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">yerror</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">yerror</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">yerror</span>
    <span class="n">fitfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x</span>
    <span class="n">errfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">err</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yerror</span><span class="o">/</span><span class="n">y</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">covar</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="polyfit">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.polyfit">[docs]</a>
<span class="k">def</span> <span class="nf">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">yerror</span><span class="p">,</span> <span class="n">pinit</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by removeInitialQuadraticIfNeeded in Cycle 6, and by</span>
<span class="sd">    runFindContinuum in Cycle 4+5.</span>
<span class="sd">    Basic second-order polynomial function fitter with error bars in y-axis data points.</span>
<span class="sd">    Uses scipy.optimize.leastsq().  Accepts either lists or arrays.</span>
<span class="sd">    Input:</span>
<span class="sd">         x, y: x and y axis values</span>
<span class="sd">         yerror: uncertainty in the y-axis values (vector or scalar)</span>
<span class="sd">         pinit contains the initial guess of [slope, intercept]</span>
<span class="sd">         y = order2coeff*(x-xoffset)**2 + slope*(x-xoffset) + y-intercept</span>
<span class="sd">    Output:</span>
<span class="sd">       The fit result as: [xoffset, order2coeff, slope, y-intercept]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">pinit</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">pinit</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">yerror</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">yerror</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">yerror</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="n">yerror</span>
    <span class="n">fitfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">errfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">err</span><span class="p">:</span> <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">fitfunc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">err</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">leastsq</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">pinit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">yerror</span><span class="o">/</span><span class="n">y</span><span class="p">),</span> <span class="n">full_output</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">covar</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="channelsInLargestGroup">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.channelsInLargestGroup">[docs]</a>
<span class="k">def</span> <span class="nf">channelsInLargestGroup</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Returns the number of channels in the largest group of channels in a</span>
<span class="sd">    CASA selection string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">largest</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">c1</span><span class="o">-</span><span class="n">c0</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">&gt;</span> <span class="n">largest</span><span class="p">):</span>
            <span class="n">largest</span> <span class="o">=</span> <span class="n">channels</span>
    <span class="k">return</span> <span class="n">largest</span></div>


<div class="viewcode-block" id="countChannelsInRanges">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.countChannelsInRanges">[docs]</a>
<span class="k">def</span> <span class="nf">countChannelsInRanges</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Counts the number of channels in one spw of a CASA channel selection string</span>
<span class="sd">    and return a list of numbers.</span>
<span class="sd">    e.g. &quot;5~20;30~40&quot;  yields [16,11]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)):</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">count</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1</span><span class="o">-</span><span class="n">c0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="countChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.countChannels">[docs]</a>
<span class="k">def</span> <span class="nf">countChannels</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by runFindContinuum.</span>
<span class="sd">    Counts the number of channels in a CASA channel selection string.</span>
<span class="sd">    If multiple spws are found, then it returns a dictionary of counts:</span>
<span class="sd">    e.g. &quot;1:5~20;30~40&quot;  yields 27; or  &#39;6~30&#39; yields 25</span>
<span class="sd">         &quot;1:5~20;30~40,2:6~30&quot; yields {1:27, 2:25}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">channels</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">nspw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspw</span><span class="p">):</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">spw</span><span class="p">,</span><span class="n">string</span> <span class="o">=</span> <span class="n">string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">c0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c0</span> <span class="o">&gt;</span> <span class="n">c1</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Invalid channel range: c0 &gt; c1 (</span><span class="si">%d</span><span class="s2"> &gt; </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c0</span><span class="p">,</span><span class="n">c1</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">]</span>
        <span class="n">count</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nspw</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">count</span><span class="p">)</span></div>


<div class="viewcode-block" id="grep">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.grep">[docs]</a>
<span class="k">def</span> <span class="nf">grep</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called only by maskArgumentMismatch and centralArcsecArgumentMismatch.</span>
<span class="sd">    Runs grep for string &lt;arg&gt; in a subprocess and reports stdout and stderr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;grep&#39;</span><span class="p">,</span> <span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">filename</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span></div>


<div class="viewcode-block" id="topoFreqToChannel">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.topoFreqToChannel">[docs]</a>
<span class="k">def</span> <span class="nf">topoFreqToChannel</span><span class="p">(</span><span class="n">freqlist</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is used by pipeline in writeContDat()</span>
<span class="sd">    Converts a python floating point list of topocentric frequency ranges to </span>
<span class="sd">    channel ranges in the specified ms.</span>
<span class="sd">    freqlist:  [150.45e9,151.67e9]  or [150.45, 151.67] </span>
<span class="sd">    spw: integer ID</span>
<span class="sd">    vis: reads the channel frequencies from this measurement set for the specified spw</span>
<span class="sd">    Returns: a python list of channels</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mymsmd</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">chanfreqs</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mymsmd</span><span class="o">.</span><span class="n">chanwidths</span><span class="p">(</span><span class="n">spw</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">freqlist</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">freqlist</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">freqlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">freqlist</span><span class="p">]</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">freqlist</span><span class="p">:</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">parseFrequencyArgument</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chanfreqs</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">width</span>
        <span class="n">f1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">chanfreqs</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">width</span>
        <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">f0</span>  <span class="ow">or</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">f1</span><span class="p">:</span>
            <span class="n">chanoff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f0</span><span class="o">-</span><span class="n">freq</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span><span class="o">-</span><span class="n">f1</span><span class="p">)])</span> <span class="o">/</span> <span class="n">width</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;frequency </span><span class="si">%.6f</span><span class="s2"> GHz not within spw </span><span class="si">%d</span><span class="s2">: </span><span class="si">%.6f</span><span class="s2"> - </span><span class="si">%.6f</span><span class="s2"> GHz (off by </span><span class="si">%.2f</span><span class="s2"> channels)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">f0</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">f1</span><span class="o">*</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">chanoff</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="n">f0</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">f0</span>
            <span class="k">elif</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="n">f1</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">f1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting frequency to last channel: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">))</span>
        <span class="n">diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">chanfreqs</span><span class="o">-</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">diffs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">channels</span></div>

    
<div class="viewcode-block" id="topoFreqRangeListToChannel">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.topoFreqRangeListToChannel">[docs]</a>
<span class="k">def</span> <span class="nf">topoFreqRangeListToChannel</span><span class="p">(</span><span class="n">contdatline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">vispath</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">freqlist</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                               <span class="n">returnFlatlist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writeChannelsInIncreasingOrder</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is used by pipeline in writeContDat()</span>
<span class="sd">    Converts a semicolon-delimited string list of topocentric frequency ranges to </span>
<span class="sd">    channel ranges in the specified ms.</span>
<span class="sd">    contdatline: line cut-and-pasted from .dat file  (e.g. &#39;my.ms 150.45~151.67GHz;151.45~152.67GHz&#39;) </span>
<span class="sd">    vispath: set the path to the measurement set whose name was read from contdatline</span>
<span class="sd">    freqlist:  &#39;150.45~151.67GHz;151.45~152.67GHz&#39;</span>
<span class="sd">    spw: integer ID or string ID</span>
<span class="sd">    writeChannelsInIncreasingOrder: if True, then ensure that the list is in increasing order</span>
<span class="sd">    Returns: a string like:  &#39;29:134~136;200~204&#39;</span>
<span class="sd">    if flatlist==True, then return  [134,136,200,204]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">contdatline</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">freqlist</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Need to specify either contdatline or freqlist.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">contdatline</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">vis</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Need to specify either contdatline or vis.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">contdatline</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">vis</span><span class="p">,</span> <span class="n">freqlist</span> <span class="o">=</span> <span class="n">contdatline</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vispath</span> <span class="o">!=</span> <span class="s1">&#39;./&#39;</span><span class="p">:</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vispath</span><span class="p">,</span><span class="n">vis</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">spw</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spw must be specified&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">freqlist</span> <span class="o">=</span> <span class="n">freqlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">chanlist</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">myqa</span> <span class="o">=</span> <span class="n">qatool</span><span class="p">()</span>
    <span class="n">flatlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">freqlist</span><span class="p">:</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">myfreq</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">myfreq</span><span class="p">,</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">myfreq</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> 
            <span class="n">f0</span> <span class="o">=</span> <span class="n">myqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">myqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">unit</span><span class="p">),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running topoFreqToChannel([</span><span class="si">%f</span><span class="s2">,</span><span class="si">%f</span><span class="s2">], &#39;</span><span class="si">%s</span><span class="s2">&#39;, </span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">vis</span><span class="p">,</span><span class="n">spw</span><span class="p">))</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="n">topoFreqToChannel</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span><span class="n">f1</span><span class="p">],</span> <span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">mymsmd</span><span class="p">)</span>
            <span class="n">chanlist</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chans</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">chans</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">freqlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">chanlist</span> <span class="o">+=</span> <span class="s1">&#39;;&#39;</span>
            <span class="n">flatlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">chans</span><span class="p">))</span>
            <span class="n">flatlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">chans</span><span class="p">))</span>
    <span class="n">myqa</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnFlatlist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">flatlist</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">writeChannelsInIncreasingOrder</span><span class="p">:</span>
            <span class="n">cselections</span> <span class="o">=</span> <span class="n">chanlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cselections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">cselections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">cselections</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reversing order of output channel list (due to lower sideband spw).&quot;</span><span class="p">)</span>
                    <span class="n">cselections</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">chanlist</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cselections</span><span class="p">)</span>
        <span class="n">chanlist</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="o">+</span> <span class="n">chanlist</span>
        <span class="k">return</span> <span class="n">chanlist</span></div>


<div class="viewcode-block" id="gaussianBeamOffset">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.gaussianBeamOffset">[docs]</a>
<span class="k">def</span> <span class="nf">gaussianBeamOffset</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is used by pipeline in computeStatisticalSpectrumFromMask().</span>
<span class="sd">    Computes the radius at which the response of a Gaussian</span>
<span class="sd">    beam drops to the specified level.  For the inverse</span>
<span class="sd">    function, see gaussianBeamResponse.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">response</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;response must be between 0..1&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhm</span><span class="o">/</span><span class="mf">2.3548</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">response</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span> 
    <span class="k">return</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="gaussianBeamResponse">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.gaussianBeamResponse">[docs]</a>
<span class="k">def</span> <span class="nf">gaussianBeamResponse</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is used by pipeline in computeStatisticalSpectrumFromMask().</span>
<span class="sd">    Computes the gain at the specified radial offset from the center</span>
<span class="sd">    of a Gaussian beam. For the inverse function, see gaussianBeamOffset.</span>
<span class="sd">    Required inputs:</span>
<span class="sd">    radius: in arcseconds</span>
<span class="sd">    fwhm: in arcseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm</span><span class="o">/</span><span class="mf">2.3548</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">radius</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span></div>


<div class="viewcode-block" id="imageSNRAnnulus">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.imageSNRAnnulus">[docs]</a>
<span class="k">def</span> <span class="nf">imageSNRAnnulus</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">jointMaskTestWithAnnulus</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>                   
    <span class="c1"># Need 2 calls to get peak anywhere outside the joint mask, but median from annulus, and MAD the lower of the two possibilities</span>
    <span class="n">ignore2</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span><span class="p">,</span> <span class="n">ignore0</span><span class="p">,</span> <span class="n">ignore1</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span>
                                                             <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="n">applyMaskToAll</span><span class="p">)</span>
    <span class="n">ignore1</span><span class="p">,</span> <span class="n">ignore2</span><span class="p">,</span> <span class="n">medianForSNR</span><span class="p">,</span> <span class="n">madForSNR</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mymomDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestWithAnnulus</span><span class="p">,</span> 
                                                         <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="n">applyMaskToAll</span><span class="p">)</span>
    <span class="n">momDiffSNROutside</span> <span class="o">=</span> <span class="p">(</span><span class="n">momDiffPeakOutside</span> <span class="o">-</span> <span class="n">medianForSNR</span><span class="p">)</span> <span class="o">/</span> <span class="n">madForSNR</span>
    <span class="k">return</span> <span class="n">momDiffSNROutside</span><span class="p">,</span> <span class="n">momDiffPeakOutside</span></div>


<div class="viewcode-block" id="imageSNR">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.imageSNR">[docs]</a>
<span class="k">def</span> <span class="nf">imageSNR</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[],</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">usepb</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses imstat (which automatically applies the internal mask, i.e avoids the </span>
<span class="sd">    black edges of the image) to compute (max-median)/scaledMAD</span>
<span class="sd">    axes: passed to imstat (use [0,1,2] to get a vector SNR per channel)</span>
<span class="sd">    img: a 2D image or a cube</span>
<span class="sd">    mask: additional mask image (or expression) to apply when computing everything but max</span>
<span class="sd">    maskWithAnnulus: additional mask image (or expression) to use for median and MAD</span>
<span class="sd">            if useAnnulus==True (but always take the smaller of the 2 possible MADs)</span>
<span class="sd">    applyMaskToAll: also apply the provided mask when computing the max (default=False=anywhere)</span>
<span class="sd">    returnAllStats: if True, then also return the peak, median and scaledMAD where the</span>
<span class="sd">          peak has *not* had the median subtracted (in contrast to the SNR)</span>
<span class="sd">    usepb: (optional) name of a single-plane pb image to include in the mask (at &gt;0.23 level)</span>
<span class="sd">    -ToddHunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">usepb</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">+=</span> <span class="s1">&#39; &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">usepb</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
        <span class="n">statsAnnulus</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskWithAnnulus</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">applyMaskToAll</span><span class="p">:</span>
        <span class="n">stats_nomask</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">)</span>
        <span class="c1"># replace max with the max over the whole image</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats_nomask</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">useAnnulus</span><span class="p">:</span>
        <span class="c1"># use the median from the annulus</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;median = </span><span class="si">%f</span><span class="s2">, median from annulus = </span><span class="si">%f</span><span class="s2">;  scMAD = </span><span class="si">%f</span><span class="s2">, scMAD from annulus = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span><span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">.6745</span><span class="p">,</span><span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">.6745</span><span class="p">))</span>
        <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">]</span>
        <span class="c1"># pick the lower of the two possible MADs; otherwise, do not use the rest of the statsAnnulus results</span>
        <span class="k">if</span> <span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># keep it as an array of length 1</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]])])</span>
        <span class="k">elif</span> <span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># this means that stats[&#39;medabsdevmed&#39;] is zero, so we replace it</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">statsAnnulus</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">.6745</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;snr = (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> (npts=</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">.6745</span><span class="p">,</span><span class="n">snr</span><span class="p">,</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Because the MAD is zero, using the sigma instead in the calculation of SNR&#39;</span><span class="p">)</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;snr = (</span><span class="si">%f</span><span class="s1">-</span><span class="si">%f</span><span class="s1">)/</span><span class="si">%f</span><span class="s1"> = </span><span class="si">%f</span><span class="s1"> (npts=</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">],</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">],</span><span class="n">snr</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="n">snr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mymax</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mymedian</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">myscaledMAD</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">.6745</span>
    <span class="k">if</span> <span class="n">returnAllStats</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">snr</span><span class="p">,</span> <span class="n">mymax</span><span class="p">,</span> <span class="n">mymedian</span><span class="p">,</span> <span class="n">myscaledMAD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">snr</span></div>


<div class="viewcode-block" id="getSpwFromPipelineImageName">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getSpwFromPipelineImageName">[docs]</a>
<span class="k">def</span> <span class="nf">getSpwFromPipelineImageName</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts the spw ID from the pipeline image file name.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sourceName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A = &quot;</span><span class="p">,</span> <span class="n">sourceName</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sourceName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.mfs.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sourceName</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.cube.&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.cube.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.mfs.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;B = &quot;</span><span class="p">,</span> <span class="n">sourceName</span><span class="p">)</span>
    <span class="n">sourceName</span> <span class="o">=</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.spw&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spw = &quot;</span><span class="p">,</span> <span class="n">sourceName</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sourceName</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">sourceName</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="representativeSpwBandwidth">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.representativeSpwBandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">representativeSpwBandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses updateSBSummary to learn the name of the representativeWindow, then </span>
<span class="sd">    translates that name to a science spw ID using msmd.spwsfornames, and </span>
<span class="sd">    finally a bandwidth.  </span>
<span class="sd">    Returns: spw ID, spw bandwidth in Hz (or 0 if no rep spw can be discerned),</span>
<span class="sd">       minimum science spw bandwidth, maximum science spw bandwidth</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find vis: &quot;</span><span class="p">,</span> <span class="n">vis</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/ASDM_SBSUMMARY&#39;</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">scienceGoal</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;scienceGoal&#39;</span><span class="p">)</span>
    <span class="c1"># Read the existing values for those that were not specified</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">representativeSPW</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scienceGoal</span><span class="p">):</span>
        <span class="c1"># args will look like: </span>
        <span class="c1"># array([&#39;representativeFrequency = 219.55647641503566 GHz&#39;])</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># arg will look like: </span>
            <span class="c1">#  &#39;representativeFrequency = 219.55647641503566 GHz&#39;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeWindow&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">representativeSPW</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">representativeSPW</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">representativeSpwPresent</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;representativeWindow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="k">if</span> <span class="s1">&#39;representativeWindow&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SBSummary does not contain the representativeWindow key&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spwname</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;representativeWindow&#39;</span><span class="p">]</span>
    <span class="n">myspws</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">spwsfornames</span><span class="p">(</span><span class="n">spwname</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spwname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">myspws</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SBSummary does not contain a valid representativeWindow name&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">myspws</span><span class="p">[</span><span class="n">spwname</span><span class="p">],</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">spwsforintent</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">intent</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
<span class="c1">#    spw = np.intersect1d(mymsmd.spwsfornames(info[&#39;representativeWindow&#39;])[spwname], mymsmd.spwsforintent(&#39;*&#39;+intent+&#39;*&#39;))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># intersection of uint64 with int64 is a float!</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">()[</span><span class="n">spw</span><span class="p">]</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bandwidth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bws</span> <span class="o">=</span> <span class="n">getScienceSpwBandwidths</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">spw</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bws</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bws</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="updateSBSummary">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.updateSBSummary">[docs]</a>
<span class="k">def</span> <span class="nf">updateSBSummary</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">representativeFrequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">minAcceptableAngResolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                    <span class="n">maxAcceptableAngResolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dynamicRange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">representativeBandwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">representativeSource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">representativeSPW</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">maxAllowedBeamAxialRatio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">spectralDynamicRangeBandWidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the ASDM_SBSUMMARY table of a measurement set with one or more new</span>
<span class="sd">    values.  If a value is not present in the existing table and also not </span>
<span class="sd">    specified, then it will remain not present in the updated table.</span>
<span class="sd">    representativeFrequency: float value in typical units (GHz), </span>
<span class="sd">            or string with units (space before units is optional)</span>
<span class="sd">    minAcceptableAngResolution: float value in typical units (arcsec), </span>
<span class="sd">            or string with units (space before units is required)</span>
<span class="sd">    maxAcceptableAngResolution: float value in typical units (arcsec), </span>
<span class="sd">            or string with units (space before units is required)</span>
<span class="sd">    dynamicRange: float value</span>
<span class="sd">    representativeBandwidth: float value in typical units (GHz), </span>
<span class="sd">            or string with units (space before units is optional)</span>
<span class="sd">    representativeSource: string</span>
<span class="sd">    representativeSPW: string</span>
<span class="sd">    maxAllowedBeamAxialRatio: float</span>
<span class="sd">    spectralDynamicRangeBandWidth: float value in typical units (MHz), </span>
<span class="sd">            or string with units (space before units is optional)</span>
<span class="sd">    Returns: dictionary keyed by parameter name</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find ms.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/ASDM_SBSUMMARY&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find ASDM_SBSUMMARY table for this ms.  Was it imported?&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">representativeFrequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> 
        <span class="n">minAcceptableAngResolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> 
        <span class="n">maxAcceptableAngResolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">maxAllowedBeamAxialRatio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="n">dynamicRange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">representativeBandwidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="n">representativeSource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">representativeSPW</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="n">spectralDynamicRangeBandWidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
    <span class="n">nomodify</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">update</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/ASDM_SBSUMMARY&#39;</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="n">nomodify</span><span class="p">)</span>
    <span class="n">scienceGoal</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;scienceGoal&#39;</span><span class="p">)</span>
    <span class="n">numScienceGoal</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;numScienceGoal&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">representativeSpwPresent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">axialRatioPresent</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Read the existing values for those that were not specified</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">args</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scienceGoal</span><span class="p">):</span>
        <span class="c1"># args will look like: </span>
        <span class="c1"># array([&#39;representativeFrequency = 219.55647641503566 GHz&#39;])</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># arg will look like: </span>
            <span class="c1">#  &#39;representativeFrequency = 219.55647641503566 GHz&#39;</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeFrequency&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">representativeFrequency</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">representativeFrequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">freqUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;representativeFrequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minAcceptableAngResolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">minUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">maxAcceptableAngResolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">maxUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;dynamicRange&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dynamicRange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">dynamicRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;dynamicRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeBandwidth&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">representativeBandwidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">representativeBandwidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">bwUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;representativeBandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;spectralDynamicRangeBandWidth&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">spectralDynamicRangeBandWidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">bwUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;spectralDynamicRangeBandWidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeSource&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">representativeSource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">representativeSource</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;representativeSource&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeWindow&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">representativeSPW</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">representativeSPW</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">representativeSpwPresent</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;representativeWindow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">maxAllowedBeamAxialRatio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">axialRatioPresent</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SBName&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">sbname</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;SBName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbname</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;sensitivityGoal&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">sbname</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;sensitivityGoal&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbname</span>
    <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
        <span class="c1"># convert any command-line arguments from string to value and units</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">representativeFrequency</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">representativeFrequency</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">representativeFrequency</span><span class="p">)</span>
            <span class="n">freqUnits</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">representativeBandwidth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">representativeBandwidth</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">representativeBandwidth</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">bwUnits</span> <span class="o">=</span> <span class="s1">&#39;MHz&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
            <span class="n">bwUnits</span> <span class="o">=</span> <span class="s1">&#39;MHz&#39;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dynamicRange</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">dynamicRange</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dynamicRange</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">minAcceptableAngResolution</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">minAcceptableAngResolution</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">minUnits</span> <span class="o">=</span> <span class="s1">&#39;arcsec&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">minUnits</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">maxAcceptableAngResolution</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">maxAcceptableAngResolution</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">result</span>
                <span class="n">maxUnits</span> <span class="o">=</span> <span class="s1">&#39;arcsec&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span><span class="p">,</span> <span class="n">maxUnits</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">newvalues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">representativeFrequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;representativeFrequency = </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">representativeFrequency</span><span class="p">,</span><span class="n">freqUnits</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">minAcceptableAngResolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;minAcceptableAngResolution = </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">minAcceptableAngResolution</span><span class="p">,</span> <span class="n">minUnits</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">maxAcceptableAngResolution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;maxAcceptableAngResolution = </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">maxAcceptableAngResolution</span><span class="p">,</span> <span class="n">maxUnits</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">dynamicRange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;dynamicRange = </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">dynamicRange</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">representativeBandwidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;representativeBandwidth = </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">representativeBandwidth</span><span class="p">,</span> <span class="n">bwUnits</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">spectralDynamicRangeBandWidth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;spectralDynamicRangeBandWidth = </span><span class="si">%f</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">,</span> <span class="n">bwUnits</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">representativeFrequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;representativeSource = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">representativeSource</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">representativeSPW</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;representativeWindow = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="nb">str</span><span class="p">(</span><span class="n">representativeSPW</span><span class="p">)]]</span>
        <span class="k">if</span> <span class="n">maxAllowedBeamAxialRatio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newvalues</span> <span class="o">+=</span> <span class="p">[[</span><span class="s1">&#39;maxAllowedBeamAxialRatio = </span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">maxAllowedBeamAxialRatio</span><span class="p">]]</span>
        <span class="n">newvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newvalues</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newvalues</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numScienceGoal</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Updating numScienceGoal to </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newvalues</span><span class="p">)))</span>
            <span class="n">mytb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s1">&#39;numScienceGoal&#39;</span><span class="p">,[</span><span class="nb">len</span><span class="p">(</span><span class="n">newvalues</span><span class="p">)])</span>
            <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;Wrote new value of numScienceGoal to </span><span class="si">%s</span><span class="s1">/ASDM_SBSUMMARY: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">newvalues</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Putting new values:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">newvalues</span><span class="p">)</span>
        <span class="n">mytb</span><span class="o">.</span><span class="n">putcol</span><span class="p">(</span><span class="s1">&#39;scienceGoal&#39;</span><span class="p">,</span><span class="n">newvalues</span><span class="p">)</span>
        <span class="n">casalog</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;Wrote new values to </span><span class="si">%s</span><span class="s1">/ASDM_SBSUMMARY: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">newvalues</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current values: shape=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">scienceGoal</span><span class="p">))),</span> <span class="n">scienceGoal</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">representativeSpwPresent</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Looking for spw that contains the representative frequency...&quot;</span><span class="p">)</span>
            <span class="n">spw</span><span class="p">,</span> <span class="n">repBW</span><span class="p">,</span> <span class="n">minBW</span><span class="p">,</span> <span class="n">maxBW</span> <span class="o">=</span> <span class="n">representativeSpwBandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spw = &quot;</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">mydict</span></div>


<div class="viewcode-block" id="representativeFrequency">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.representativeFrequency">[docs]</a>
<span class="k">def</span> <span class="nf">representativeFrequency</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the representative frequency from the ASDM_SBSUMMARY table of a</span>
<span class="sd">    measurement set, if it has been imported with asis.</span>
<span class="sd">    e.g. [representativeFrequency = 230.0348592858192 GHz, ...] </span>
<span class="sd">    verbose: if True, then also print the min/max acceptable angular resolutions</span>
<span class="sd">    Returns the value in GHz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find measurement set.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/ASDM_SBSUMMARY&#39;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find ASDM_SBSUMMARY table.  Did you not import it with asis=&#39;SBSummary&#39;?&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/ASDM_SBSUMMARY&#39;</span><span class="p">)</span>
    <span class="n">scienceGoal</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;scienceGoal&#39;</span><span class="p">)</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">minAcceptableResolution</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxAcceptableResolution</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bw</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">scienceGoal</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeFrequency&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">freq</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;representativeBandwidth&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">bw</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToGHz</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">minAcceptableResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">minUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">loc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">loc</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">maxAcceptableResolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">maxUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;minAcceptableResolution = </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">minAcceptableResolution</span><span class="p">,</span> <span class="n">minUnits</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;maxAcceptableResolution = </span><span class="si">%f</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxAcceptableResolution</span><span class="p">,</span> <span class="n">maxUnits</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">bw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;representativeBandwidth = </span><span class="si">%f</span><span class="s2"> GHz&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bw</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span></div>


<div class="viewcode-block" id="surmiseRepresentativeSpw">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.surmiseRepresentativeSpw">[docs]</a>
<span class="k">def</span> <span class="nf">surmiseRepresentativeSpw</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the representative frequency from the measurement set, then computes </span>
<span class="sd">    which science spw(s) contains it.</span>
<span class="sd">    Returns: spwID, repBW, repNchan, np.min(bandwidths), np.max(bandwidths)</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">representativeFrequency</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="n">getScienceSpwsForFrequency</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">)</span>
    <span class="n">scienceSpws</span> <span class="o">=</span> <span class="n">getScienceSpws</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">spws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No spws cover the representative frequency (</span><span class="si">%g</span><span class="s2"> GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freq</span><span class="p">))</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">scienceSpws</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spw central frequencies in GHz: &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mymsmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e-9</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Multiple spws (</span><span class="si">%s</span><span class="s2">) cover the representative frequency (</span><span class="si">%g</span><span class="s2"> GHz)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spws</span><span class="p">),</span><span class="n">freq</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning the one nearest to the center.&quot;</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">getScienceSpwsForFrequency</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">nearestOnly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">spw</span>
    <span class="n">repBW</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">repNchan</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">nchan</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">bandwidths</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">(</span><span class="n">scienceSpws</span><span class="p">)</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">repBW</span><span class="p">,</span> <span class="n">repNchan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bandwidths</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bandwidths</span><span class="p">)</span></div>


<div class="viewcode-block" id="getScienceSpwsForFrequency">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getScienceSpwsForFrequency">[docs]</a>
<span class="k">def</span> <span class="nf">getScienceSpwsForFrequency</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">nearestOnly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of science spws that cover a given frequency.</span>
<span class="sd">    vis: name of measurement set</span>
<span class="sd">    frequency: in Hz, GHz, or a string with units</span>
<span class="sd">    nearestOnly: if True, the return only one spw (nearest to center)</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="n">getScienceSpws</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">parseFrequencyArgumentToHz</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
    <span class="n">spws2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">frequency</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">frequency</span><span class="p">):</span>
            <span class="n">spws2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
            <span class="n">delta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">frequency</span><span class="o">-</span><span class="n">mymsmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="n">spw</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">nearestOnly</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">spws2</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">delta</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="n">spws2</span><span class="p">)</span></div>


<div class="viewcode-block" id="getScienceSpwBandwidths">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getScienceSpwBandwidths">[docs]</a>
<span class="k">def</span> <span class="nf">getScienceSpwBandwidths</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;OBSERVE_TARGET#ON_SOURCE&#39;</span><span class="p">,</span> 
                             <span class="n">tdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sqld</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnDict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnMHz</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns: an array of bandwidths (in Hz) in order sorted by spw ID</span>
<span class="sd">    returnDict: if True, then return a dictionary keyed by spw ID</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">getScienceSpws</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">tdm</span><span class="p">,</span> <span class="n">fdm</span><span class="p">,</span> <span class="n">mymsmd</span><span class="p">,</span> <span class="n">sqld</span><span class="p">,</span> <span class="n">verbose</span><span class="p">))</span>
    <span class="n">bandwidths</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnMHz</span><span class="p">:</span>
        <span class="n">bandwidths</span> <span class="o">*=</span> <span class="mf">1e-6</span>
    <span class="k">if</span> <span class="n">returnDict</span><span class="p">:</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spws</span><span class="p">):</span>
            <span class="n">mydict</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">bandwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">mydict</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bandwidths</span></div>


<div class="viewcode-block" id="getScienceSpws">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getScienceSpws">[docs]</a>
<span class="k">def</span> <span class="nf">getScienceSpws</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;OBSERVE_TARGET#ON_SOURCE&#39;</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                   <span class="n">returnListOfStrings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">tdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                   <span class="n">sqld</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">returnFreqRanges</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a list of spws with the specified intent.  For ALMA data,</span>
<span class="sd">    it ignores channel-averaged and SQLD spws.</span>
<span class="sd">    intent: either full intent name including #subIntent, or an abbreviated key, like &#39;PHASE&#39;</span>
<span class="sd">    returnString: if True, return &#39;1,2,3&#39;</span>
<span class="sd">                  if False, return [1,2,3]</span>
<span class="sd">    returnListOfStrings: if True, return [&#39;1&#39;,&#39;2&#39;,&#39;3&#39;]  (amenable to tclean spw parameter)</span>
<span class="sd">                         if False, return [1,2,3]</span>
<span class="sd">    returnFreqRanges: if True, returns a dictionary keyed by spw ID, with values</span>
<span class="sd">          equal to the frequency of the middle of the min and max channel (Hz)</span>
<span class="sd">    -- Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">returnString</span> <span class="ow">and</span> <span class="n">returnListOfStrings</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You can only specify one of: returnString, returnListOfStrings&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">allIntents</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">intents</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allIntents</span> <span class="ow">and</span> <span class="n">intent</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allIntents</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">intent</span> <span class="o">=</span> <span class="n">i</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Translated intent to &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="c1"># minimum match OBSERVE_TARGET to OBSERVE_TARGET#UNSPECIFIED</span>
    <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">allIntents</span><span class="p">]</span>
    <span class="c1"># If any intent gives a match, the mean value of the location list will be &gt; -1</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">intent</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not found in this dataset. Available intents: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">intent</span><span class="p">),</span> <span class="n">allIntents</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span> 
            <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">returnString</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">spwsforintent</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">spwsforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">getObservatoryName</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ALMA&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">getObservatoryName</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OSF&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">almaspws</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">almaspws</span><span class="p">(</span><span class="n">tdm</span><span class="o">=</span><span class="n">tdm</span><span class="p">,</span><span class="n">fdm</span><span class="o">=</span><span class="n">fdm</span><span class="p">,</span><span class="n">sqld</span><span class="o">=</span><span class="n">sqld</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">almaspws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scienceSpws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scienceSpws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span><span class="n">almaspws</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">scienceSpws</span> <span class="o">=</span> <span class="n">spws</span>
    <span class="n">mydict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scienceSpws</span><span class="p">:</span>
        <span class="n">mydict</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">mymsmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span><span class="n">mymsmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">returnFreqRanges</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mydict</span>
    <span class="k">if</span> <span class="n">returnString</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scienceSpws</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">returnListOfStrings</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scienceSpws</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scienceSpws</span><span class="p">))</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># Functions below this point are not used by the Cycle 6 or 7 pipeline or PL2020</span>
<span class="c1">################################################################################</span>

<div class="viewcode-block" id="readContDat">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readContDat">[docs]</a>
<span class="k">def</span> <span class="nf">readContDat</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the channel selection for a _findContinuum.dat file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">selection</span></div>


<div class="viewcode-block" id="readContDatPNG">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readContDatPNG">[docs]</a>
<span class="k">def</span> <span class="nf">readContDatPNG</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the png name from a _findContinuum.dat file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">png</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">png</span></div>


<div class="viewcode-block" id="readContDatAggregateContinuum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readContDatAggregateContinuum">[docs]</a>
<span class="k">def</span> <span class="nf">readContDatAggregateContinuum</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the aggregate continuum from a _findContinuum.dat file.</span>
<span class="sd">    Returns: value in GHz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">selection</span></div>


<div class="viewcode-block" id="readContDatChanWidth">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readContDatChanWidth">[docs]</a>
<span class="k">def</span> <span class="nf">readContDatChanWidth</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts aggBW and channel number to chanWidth (in GHz).</span>
<span class="sd">    This will differ slightly from fc.numberOfChannelsInCube(jointMask,returnChannelWidth=True)</span>
<span class="sd">    due to precision of the frequency display in the file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">aggBW</span> <span class="o">=</span> <span class="n">readContDatAggregateContinuum</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">readContDat</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
    <span class="n">chanWidth</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">aggBW</span><span class="p">)</span><span class="o">/</span><span class="n">nchan</span>
    <span class="k">return</span> <span class="n">chanWidth</span></div>


<div class="viewcode-block" id="readContDatLSRKRanges">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readContDatLSRKRanges">[docs]</a>
<span class="k">def</span> <span class="nf">readContDatLSRKRanges</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the LSRK ranges from a _findContinuum.dat file and returns one</span>
<span class="sd">    string of format: &#39;XXX.YYYYYYYYYGHz~XXX.YYYYYYYYYGHz;...&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">channelString</span><span class="p">,</span> <span class="n">png</span><span class="p">,</span> <span class="n">aggregateContinuum</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lsrkRangesString</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">lsrkRanges</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsrkRangesString</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lsrkRanges</span></div>


<div class="viewcode-block" id="imageChannelFrequency">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.imageChannelFrequency">[docs]</a>
<span class="k">def</span> <span class="nf">imageChannelFrequency</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the frequency (in GHz) of the specified channel of any CASA or FITS</span>
<span class="sd">    image cube with a spectral axis.</span>
<span class="sd">    channel: can be a scalar or a list/vector, if None then return list for all channels, </span>
<span class="sd">             if -1 then return the final channel</span>
<span class="sd">    Returns: value in GHz; scalar (if one channel) or array (if more than 1 channel)</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find image&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">pixel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">channel</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">myia</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">myia</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not open image: </span><span class="si">%s</span><span class="s2">, check permissions&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">maxchan</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">myia</span><span class="o">=</span><span class="n">myia</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="n">maxchan</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid channel </span><span class="si">%d</span><span class="s2">, max=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">maxchan</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
                    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="nb">range</span><span class="p">:</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
    <span class="n">spectralAxis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">spectralAxis</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">channel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">channel</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">pixel</span><span class="p">[</span><span class="n">spectralAxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="n">pixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">spectralAxis</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not a cube?&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">spectralAxis</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
<span class="c1">#    print(&quot;type(freq) = &quot;, type(freq[0]))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># the first channel is all we have</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">freq</span> <span class="o">*</span> <span class="mf">1e-9</span></div>

             
<div class="viewcode-block" id="recalcMomDiffSNR">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.recalcMomDiffSNR">[docs]</a>
<span class="k">def</span> <span class="nf">recalcMomDiffSNR</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">intersectRanges</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                     <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">datfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                     <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">includeMom10</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows rapid feedback for adjusting the channel ranges to use for momDiffSNR</span>
<span class="sd">    priorValuesFile: a pickle file generated by findContinuum()</span>
<span class="sd">    img: the cube (in case it has been moved and cannot be found automatically)</span>
<span class="sd">      1) The pbmom image is required to be present, either in the same directory</span>
<span class="sd">         as the img, or the current working directory.</span>
<span class="sd">      2) The joint mask listed in the priorValuesFile must also exist in the</span>
<span class="sd">         current working directory.</span>
<span class="sd">    intersectRanges: the selection of channels to use;  either a single string,</span>
<span class="sd">        or a python list of strings to be intersected before using.  If you </span>
<span class="sd">        would like to use LSRK frequency ranges instead, you can first use the </span>
<span class="sd">        function au.imageFrequencyRangesToChannelRanges() to do the conversion </span>
<span class="sd">        for your cube.</span>
<span class="sd">    subimage: setting this True will raise the pb levels of the annulus by 0.2</span>
<span class="sd">    useAnnulus: passed to fc.imageSNR</span>
<span class="sd">    datfile: if present, then generate new datfile with the missing ranges </span>
<span class="sd">        removed</span>
<span class="sd">    outdir: if blank, then put it where the cube is</span>
<span class="sd">    includeMom10: also compute moment 10 and mom10DiffSNR</span>
<span class="sd">    Returns: new momDiffSNR, new AggBW (GHz), and (if includeMom10=True) the</span>
<span class="sd">             new mom10DiffSNR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">datfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datfile</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find datfile: &quot;</span><span class="p">,</span> <span class="n">datfile</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded </span><span class="si">%d</span><span class="s2"> values from pickle file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">priorValuesFile</span><span class="p">))</span>
    <span class="n">open_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>  <span class="c1"># PL2021</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.findcont.residual&#39;</span><span class="p">)</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">jointMask</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.findcont.residual&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">img</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># PL2022+23</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.findcont.residual&#39;</span><span class="p">)</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">jointMask</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.findcont.residual&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">img</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>  <span class="c1"># PL2024</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">mom0peakOverMad</span><span class="p">,</span> <span class="n">mom8peakOverMad</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.findcont.residual&#39;</span><span class="p">)</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">jointMask</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.findcont.residual&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">img</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unrecognized len(result) = </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find the cube.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">intersectRanges</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">intersectRanges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">intersectRanges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersecting </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">r</span><span class="p">))</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="n">intersectChannelSelections</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Intersected range: &quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid type for intersectRanges: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">))))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>

    <span class="c1"># build mom8fc and mom0fc images</span>
    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">momRoot</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.fc&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">momRoot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.fc&#39;</span><span class="p">)</span>
    <span class="n">mom8fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span> <span class="c1"># cube+&#39;.recalcMomDiffSNR.mom8fc&#39;</span>
    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
    <span class="n">mom0fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
    <span class="k">if</span> <span class="n">includeMom10</span><span class="p">:</span>
        <span class="n">moments</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">mom10fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.minimum&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom10fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">moments</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">]</span>
    <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="n">moments</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">)</span>
        
    <span class="c1"># create scaled version of mom0fc</span>
    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">mom0fcScaled</span> <span class="o">=</span> <span class="n">mom0fc</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mom0fcScaled</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span><span class="p">)</span>
    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
    <span class="n">meanFreqHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">])</span>
    <span class="n">channelWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">lastFreq</span><span class="o">-</span><span class="n">firstFreq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
    <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scale factor = </span><span class="si">%f</span><span class="s2">, chanWidthKms=</span><span class="si">%f</span><span class="s2">, fcChannels=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">chanWidthKms</span><span class="p">,</span> <span class="n">fcChannels</span><span class="p">))</span>
    <span class="n">immath</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcScaled</span><span class="p">)</span>
    <span class="c1"># Create momDiff </span>
    <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">momDiff</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.momDiff&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">momDiff</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.momDiff&#39;</span><span class="p">)</span>
    <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiff</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
    <span class="n">pbcube</span> <span class="o">=</span> <span class="n">locatePBCube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="n">pbmom</span> <span class="o">=</span> <span class="n">pbcube</span><span class="o">+</span><span class="s1">&#39;mom&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pbmom is not in the same directory as the cube, looking in current directory instead&quot;</span><span class="p">)</span>
        <span class="c1"># look in current directory</span>
        <span class="n">pbmom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;mom&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;recalcMomDiffSNR: Could not find pbmom image, neither with the cube, nor in the current working directory.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="n">immath</span><span class="p">([</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">mom0fcScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> 
           <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiff</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includeMom10</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outdir</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">mom10Diff</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.mom10Diff&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mom10Diff</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.recalcMomDiffSNR.mom10Diff&#39;</span><span class="p">)</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom10Diff</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">immath</span><span class="p">([</span><span class="n">mom0fcScaled</span><span class="p">,</span> <span class="n">mom10fc</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> 
               <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom10Diff</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jointMask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;&quot;==0&#39;</span>
        <span class="k">if</span> <span class="n">useAnnulus</span> <span class="ow">and</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this happens when meanSpectrumFile is specified</span>
                <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is the pipeline use case</span>
                <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="n">jointMaskTest</span> <span class="o">+</span> <span class="s1">&#39; &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jointMaskTest = &quot;</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jointMaskTestAnnulus = &quot;</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
    <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                  <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includeMom10</span><span class="p">:</span>
        <span class="n">mom10DiffSNR</span><span class="p">,</span> <span class="n">mom10DiffPeak</span><span class="p">,</span> <span class="n">mom10DiffMedian</span><span class="p">,</span> <span class="n">mom10DiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom10Diff</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span> 
                                                                  <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">chanwidth</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">jointMask</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Hz</span>
    <span class="n">newAggBW</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">chanwidth</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;aggregate bandwidth = </span><span class="si">%.4f</span><span class="s2"> GHz&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">newAggBW</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;momDiffSNR = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">includeMom10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mom10DiffSNR = </span><span class="si">%.4f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom10DiffSNR</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">datfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">originalSelection</span> <span class="o">=</span> <span class="n">readContDat</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span>
        <span class="n">originalPNG</span> <span class="o">=</span> <span class="n">readContDatPNG</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span>
        <span class="n">originalAggBW</span> <span class="o">=</span> <span class="n">readContDatAggregateContinuum</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span>
        <span class="n">originalLSRK</span> <span class="o">=</span> <span class="n">readContDatLSRKRanges</span><span class="p">(</span><span class="n">datfile</span><span class="p">)</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">originalRanges</span> <span class="o">=</span> <span class="n">originalSelection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">originalLSRKRanges</span> <span class="o">=</span> <span class="n">originalLSRK</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="n">LSRKranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">originalRanges</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: You have changed a range (</span><span class="si">%d</span><span class="s2">), not merely removed some.  I will recalculate the LSRKrange and overwrite the datfile anyway.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">freqs</span> <span class="o">=</span> <span class="n">imageChannelFrequency</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">channel</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                <span class="n">chanwidth</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">newrange</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.9f</span><span class="s1">GHz~</span><span class="si">%.9f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">freqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])]</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chanwidth</span><span class="p">,</span> <span class="n">freqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span><span class="o">+</span><span class="mf">0.5</span><span class="o">*</span><span class="n">chanwidth</span><span class="p">)</span>
                <span class="n">LSRKranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newrange</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">originalRanges</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">LSRKranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">originalLSRKRanges</span><span class="p">[</span><span class="n">loc</span><span class="p">])</span>
        <span class="n">LSRKranges</span> <span class="o">=</span> <span class="s1">&#39; LSRK &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">LSRKranges</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; LSRK&#39;</span>
        <span class="n">foutput</span> <span class="o">=</span> <span class="n">datfile</span><span class="o">+</span><span class="s1">&#39;.recalc.dat&#39;</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">foutput</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%.5f</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">originalPNG</span><span class="p">,</span> <span class="n">newAggBW</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">LSRKranges</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote &quot;</span><span class="p">,</span> <span class="n">foutput</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includeMom10</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">newAggBW</span><span class="p">,</span> <span class="n">mom10DiffSNR</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">newAggBW</span></div>


<div class="viewcode-block" id="printPickleFile">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.printPickleFile">[docs]</a>
<span class="k">def</span> <span class="nf">printPickleFile</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prints the contents of the specified pickle file of prior values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded </span><span class="si">%d</span><span class="s2"> values from pickle file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">priorValuesFile</span><span class="p">))</span>
    <span class="n">open_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>  <span class="c1"># PL2021</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># PL2022</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">variable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;avgSpectrumNansReplaced&#39;</span><span class="p">,</span> <span class="s1">&#39;normalized&#39;</span><span class="p">,</span> <span class="s1">&#39;numberPixelsInJointMask&#39;</span><span class="p">,</span> <span class="s1">&#39;pbBasedMask&#39;</span><span class="p">,</span> <span class="s1">&#39;initialQuadraticRemoved&#39;</span><span class="p">,</span> <span class="s1">&#39;initialQuadraticImprovementRatio&#39;</span><span class="p">,</span> <span class="s1">&#39;mom0snrs&#39;</span><span class="p">,</span> <span class="s1">&#39;mom8snrs&#39;</span><span class="p">,</span> <span class="s1">&#39;regionsPruned&#39;</span><span class="p">,</span> <span class="s1">&#39;numberPixelsInMom8Mask&#39;</span><span class="p">,</span> <span class="s1">&#39;mom0peak&#39;</span><span class="p">,</span> <span class="s1">&#39;mom8peak&#39;</span><span class="p">,</span> <span class="s1">&#39;jointMask&#39;</span><span class="p">]):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">variable</span><span class="p">)))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># PL2022</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">variable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;nbin&#39;</span><span class="p">,</span><span class="s1">&#39;initialPeakOverMad&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%2d</span><span class="s2">) </span><span class="si">%s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">13</span><span class="p">,</span> <span class="n">variable</span><span class="p">,</span> <span class="nb">eval</span><span class="p">(</span><span class="n">variable</span><span class="p">)))</span></div>


<div class="viewcode-block" id="modifyContinuumChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.modifyContinuumChannels">[docs]</a>
<span class="k">def</span> <span class="nf">modifyContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">minlevel</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> <span class="n">intersectRanges</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                            <span class="n">trimChannels</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">narrow</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">avoidance</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Re-assess spectrum using new minlevel and maxlevel</span>
<span class="sd">    verbose: print the list of channel ranges after each stage of processing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="n">avgSpectrumNansReplaced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">minlevel</span> <span class="o">&lt;</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">avgSpectrumNansReplaced</span> <span class="o">&lt;</span> <span class="n">maxlevel</span><span class="p">))</span>
<span class="c1">#    print(&#39;qualifying channels: &#39;, idx[0])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">finalList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">),</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">finalList</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finalList after intersect = &quot;</span><span class="p">,</span> <span class="n">finalList</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">avoidance</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">finalList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">finalList</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">))</span><span class="o">-</span><span class="nb">set</span><span class="p">(</span><span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">avoidance</span><span class="p">))))</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finalList after avoidance = &quot;</span><span class="p">,</span> <span class="n">finalList</span><span class="p">)</span>
    <span class="n">finalList</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndTrim</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">finalList</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finalList after trim = &quot;</span><span class="p">,</span> <span class="n">finalList</span><span class="p">)</span>
    <span class="n">finalList</span> <span class="o">=</span> <span class="n">splitListIntoContiguousListsAndRejectNarrow</span><span class="p">(</span><span class="n">finalList</span><span class="p">,</span> <span class="n">narrow</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finalList after narrow = &quot;</span><span class="p">,</span> <span class="n">finalList</span><span class="p">)</span>
    <span class="n">mad</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">finalList</span><span class="p">])</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">[</span><span class="n">finalList</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">finalList</span><span class="p">,</span> <span class="n">mad</span><span class="p">,</span> <span class="n">median</span></div>


<div class="viewcode-block" id="plotPickleFile">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.plotPickleFile">[docs]</a>
<span class="k">def</span> <span class="nf">plotPickleFile</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="n">sigmaFindContinuum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">plotfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">contdat</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                   <span class="n">narrow</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">img</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">intersectRanges</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> 
                   <span class="n">computeMomDiffSNR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useAnnulus</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                   <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span>
                   <span class="n">minlevel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxlevel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">maxTrim</span><span class="o">=</span><span class="n">maxTrimDefault</span><span class="p">,</span> <span class="n">maxTrimFraction</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">avoidance</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                   <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Allows rapid feedback from adjusting the cut level of the pickle file </span>
<span class="sd">    spectrum created by a previous run of findContinuum, and produces a </span>
<span class="sd">    new _findContinuum.dat file.</span>
<span class="sd">    priorValuesFile: pickle file from prior run of findContinuum</span>
<span class="sd">         The following things are used: the spectrum, jointMask.</span>
<span class="sd">    plotfile: if not defined, set it to jointMask+&#39;_adjusted.png&#39;</span>
<span class="sd">             if it is a directory path, then prepend it</span>
<span class="sd">    contdat: name of file to write; if not defined, set it to </span>
<span class="sd">        jointMask+&#39;_adjusted_findContinuum.dat&#39;; </span>
<span class="sd">        if it is a directory path, then prepend it to this default filename</span>
<span class="sd">    img: full path to cube, in case it has been moved since creating the pickle</span>
<span class="sd">    intersectRanges: if specified, don&#39;t allow selections outside of these ranges, </span>
<span class="sd">         example: &#39;60~80;200~300&#39;</span>
<span class="sd">    computeMomDiffSNR: if specified, compute and return the momDiffSNR</span>
<span class="sd">    useAnnulus: passed to fc.imageSNR</span>
<span class="sd">    trimChannels: use 0 to avoid re-trimming ranges that were already trimmed</span>
<span class="sd">         in the initial run of findContinuum</span>
<span class="sd">    subimage: passed to findOuterAnnulusForPBCube() to raise annulus by 0.2</span>
<span class="sd">    sigmaFindContinuumMode: passed to findContinuumChannels()</span>
<span class="sd">    To invoke alternative method, set:</span>
<span class="sd">    minlevel: level of lower dotted line of prior findContinuum run</span>
<span class="sd">    maxlevel: level of upper dotted line of prior findContinuum run</span>
<span class="sd">    median: level of solid line of prior findContinuum run (only needed to</span>
<span class="sd">        draw this level on the plot, or if fraction is specified)</span>
<span class="sd">    fraction: scale the median-to-min distance and median-to-max distance by this</span>
<span class="sd">       fraction prior to running; if &gt;1.0, then also ignore intersectRanges</span>
<span class="sd">    avoidance: passed to modifyContinuumChannels; thus, only used if minlevel/maxlevel/median</span>
<span class="sd">        are set</span>
<span class="sd">    grid: if True, draw dotted grid lines at the major tick marks</span>
<span class="sd">    Note: only minlevel and maxlevel are ultimately passed to modifyContinuumChannels;</span>
<span class="sd">          fraction and median are merely a way to adjust them automatically.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">open_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">open_file</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;loaded </span><span class="si">%d</span><span class="s2"> values from pickle file: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">priorValuesFile</span><span class="p">))</span>
    <span class="n">open_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">:</span>  <span class="c1"># PL2021</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.findcont.residual&#39;</span><span class="p">)</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">jointMask</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.findcont.residual&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">img</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>  <span class="c1"># PL2022</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">if</span> <span class="n">img</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;.findcont.residual&#39;</span><span class="p">)</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">jointMask</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.findcont.residual&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cube</span> <span class="o">=</span> <span class="n">img</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># if I expand the contents of the pkl file someday to include chanInfo and imageInfo:</span>
        <span class="p">[</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">numberPixelsInJointMask</span><span class="p">,</span> <span class="n">pbBasedMask</span><span class="p">,</span> <span class="n">initialQuadraticRemoved</span><span class="p">,</span> <span class="n">initialQuadraticImprovementRatio</span><span class="p">,</span> <span class="n">mom0snrs</span><span class="p">,</span> <span class="n">mom8snrs</span><span class="p">,</span> <span class="n">regionsPruned</span><span class="p">,</span> <span class="n">numberPixelsInMom8Mask</span><span class="p">,</span> <span class="n">mom0peak</span><span class="p">,</span> <span class="n">mom8peak</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">initialPeakOverMad</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">chanInfo</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
    <span class="k">if</span> <span class="n">plotfile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">plotfile</span> <span class="o">=</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;_adjusted.png&#39;</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">plotfile</span><span class="p">):</span>
        <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;_adjusted.png&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">contdat</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">contdat</span> <span class="o">=</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;_adjusted&#39;</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">contdat</span><span class="p">):</span>
        <span class="n">contdat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">contdat</span><span class="p">,</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;_adjusted&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9&#39;</span><span class="p">:</span> 
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">forward</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">desc</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)),</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channels&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">jointMask</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jointMask = &quot;</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">priorValuesFile</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="n">nBaselineChannels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mf">0.19</span><span class="o">*</span><span class="n">nchan</span><span class="p">))</span>
    <span class="n">medianCyan</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">minlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">maxlevel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">median</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This method was added in August 2022</span>
        <span class="k">if</span> <span class="n">maxlevel</span> <span class="o">&lt;</span> <span class="n">median</span> <span class="ow">or</span> <span class="n">minlevel</span> <span class="o">&gt;</span> <span class="n">median</span> <span class="ow">and</span> <span class="n">fraction</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;non-sensical min,median,max values&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">fraction</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">minlevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">-</span> <span class="n">fraction</span><span class="o">*</span><span class="p">(</span><span class="n">median</span><span class="o">-</span><span class="n">minlevel</span><span class="p">)</span>
            <span class="n">maxlevel</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">fraction</span><span class="o">*</span><span class="p">(</span><span class="n">maxlevel</span><span class="o">-</span><span class="n">median</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fraction</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">intersectRanges</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;CALLING modifyContinuumChannels() instead of findContinuumChannels()&#39;</span><span class="p">)</span>
        <span class="n">finalList</span><span class="p">,</span><span class="n">mad</span><span class="p">,</span><span class="n">medianCyan</span> <span class="o">=</span> <span class="n">modifyContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">minlevel</span><span class="p">,</span> <span class="n">maxlevel</span><span class="p">,</span> 
                                                           <span class="n">intersectRanges</span><span class="p">,</span> <span class="n">trimChannels</span><span class="p">,</span> <span class="n">narrow</span><span class="p">,</span> <span class="n">maxTrim</span><span class="p">,</span> 
                                                           <span class="n">maxTrimFraction</span><span class="p">,</span> <span class="n">avoidance</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">positiveThreshold</span> <span class="o">=</span> <span class="n">maxlevel</span>
        <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="n">minlevel</span>
        <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">median</span>
    <span class="k">elif</span> <span class="n">minlevel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">maxlevel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">median</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">findContinuumChannels</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="p">,</span> 
                                       <span class="n">sigmaFindContinuum</span><span class="p">,</span> 
                                       <span class="n">sigmaFindContinuumMode</span><span class="o">=</span><span class="n">sigmaFindContinuumMode</span><span class="p">,</span> 
                                       <span class="n">narrow</span><span class="o">=</span><span class="n">narrow</span><span class="p">,</span> <span class="n">trimChannels</span><span class="o">=</span><span class="n">trimChannels</span><span class="p">)</span>
        <span class="n">initialList</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">positiveThreshold</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">median</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">medianTrue</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">mad</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
        <span class="n">negativeThreshold</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">intersectRanges</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">finalList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">initialList</span><span class="p">,</span> <span class="n">convertSelectionIntoChannelList</span><span class="p">(</span><span class="n">intersectRanges</span><span class="p">))</span>
            <span class="n">reduction</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">initialList</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalList</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reduction</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;intersectRanges reduced the channel list by </span><span class="si">%d</span><span class="s2"> channels to </span><span class="si">%d</span><span class="s2"> channels.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reduction</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">finalList</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalList</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You must specify all 3 parameters or none of them: minlevel, maxlevel, median&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">myChannelLists</span> <span class="o">=</span> <span class="n">splitListIntoContiguousLists</span><span class="p">(</span><span class="n">finalList</span><span class="p">)</span>
    <span class="n">selection</span> <span class="o">=</span> <span class="n">convertChannelListIntoSelection</span><span class="p">(</span><span class="n">finalList</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAD = &quot;</span><span class="p">,</span> <span class="n">MAD</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;selection: &quot;</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
    <span class="n">ylevel</span> <span class="o">=</span> <span class="n">medianTrue</span> <span class="o">+</span> <span class="n">mad</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;medianTrue + MAD = &quot;</span><span class="p">,</span> <span class="n">ylevel</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">positiveThreshold</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">negativeThreshold</span><span class="p">],</span> <span class="s1">&#39;k:&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">median</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">medianTrue</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">medianCyan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="p">[</span><span class="n">medianCyan</span><span class="p">],</span> <span class="s1">&#39;c:&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="s1">&#39;fraction=</span><span class="si">%.3f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fraction</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">desc</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">myChannelList</span> <span class="ow">in</span> <span class="n">myChannelLists</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># [0] == myChannelList[1]:</span>
            <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mf">0.5</span>
            <span class="n">myChannelList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">myChannelList</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">positiveThreshold</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">mad</span><span class="p">],</span> <span class="s1">&#39;c-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aggBW</span> <span class="o">=</span> <span class="n">computeBandwidth</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">)</span>  <span class="c1"># in GHz</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="s1">&#39;aggBW=</span><span class="si">%.3f</span><span class="s1"> MHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aggBW</span><span class="o">*</span><span class="mi">1000</span><span class="p">),</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">desc</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">pl</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;TkAgg&#39;</span> <span class="ow">and</span> <span class="n">casaVersion</span> <span class="o">&gt;=</span> <span class="s1">&#39;5.9&#39;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">flush_events</span><span class="p">()</span> <span class="c1"># critical for TkAgg in CASA 6, or else set_fig_size never takes effect!</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpiDefault</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote &quot;</span><span class="p">,</span> <span class="n">plotfile</span><span class="p">)</span>
    <span class="n">writeContDat</span><span class="p">(</span><span class="n">contdat</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">plotfile</span><span class="p">,</span> <span class="n">aggBW</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">computeMomDiffSNR</span><span class="p">:</span>
        <span class="c1"># build mom8fc and mom0fc images</span>
        <span class="n">momRoot</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.plotPickleFile.fc&#39;</span>
        <span class="n">mom8fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.maximum&#39;</span> 
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom8fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">mom0fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.integrated&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">mom10fc</span> <span class="o">=</span> <span class="n">momRoot</span> <span class="o">+</span> <span class="s1">&#39;.minimum&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom10fc</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">immoments</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momRoot</span><span class="p">)</span>

        <span class="c1"># create scaled version of mom0fc</span>
        <span class="n">mom0fcScaled</span> <span class="o">=</span> <span class="n">mom0fc</span> <span class="o">+</span> <span class="s1">&#39;.scaled&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom0fcScaled</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">meanFreqHz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">])</span>
        <span class="n">channelWidth</span> <span class="o">=</span> <span class="p">(</span><span class="n">lastFreq</span><span class="o">-</span><span class="n">firstFreq</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">chanWidthKms</span> <span class="o">=</span> <span class="mf">299792.458</span><span class="o">*</span><span class="n">channelWidth</span><span class="o">/</span><span class="n">meanFreqHz</span> 
        <span class="n">fcChannels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">finalList</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">chanWidthKms</span><span class="o">/</span><span class="n">fcChannels</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;scale factor = </span><span class="si">%f</span><span class="s2">, chanWidthKms=</span><span class="si">%f</span><span class="s2">, fcChannels=</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">factor</span><span class="p">,</span> <span class="n">chanWidthKms</span><span class="p">,</span> <span class="n">fcChannels</span><span class="p">))</span>
        <span class="n">immath</span><span class="p">(</span><span class="n">mom0fc</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0*</span><span class="si">%f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">factor</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom0fcScaled</span><span class="p">)</span>
        <span class="c1"># Create momDiff </span>
        <span class="n">momDiff</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.plotPickleFile.momDiff&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">momDiff</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">mom10Diff</span> <span class="o">=</span> <span class="n">cube</span><span class="o">+</span><span class="s1">&#39;.plotPickleFile.mom10Diff&#39;</span>
        <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mom10Diff</span><span class="p">)</span>  <span class="c1"># in case there was a prior run</span>
        <span class="n">pbcube</span> <span class="o">=</span> <span class="n">locatePBCube</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
        <span class="n">pbmom</span> <span class="o">=</span> <span class="n">pbcube</span><span class="o">+</span><span class="s1">&#39;mom&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;pbmom is not in the same directory as the cube, looking in current directory instead&quot;</span><span class="p">)</span>
            <span class="c1"># look in current directory</span>
            <span class="n">pbmom</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pbcube</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;mom&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pbmom</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plotPickleFile: Could not find pbmom image, neither with the cube, nor in the current working directory.&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="n">immath</span><span class="p">([</span><span class="n">mom8fc</span><span class="p">,</span> <span class="n">mom0fcScaled</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> 
               <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">momDiff</span><span class="p">)</span>
        <span class="n">immath</span><span class="p">([</span><span class="n">mom0fcScaled</span><span class="p">,</span> <span class="n">mom10fc</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;evalexpr&#39;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;IM0-IM1&#39;</span><span class="p">,</span> 
               <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;0.23&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pbmom</span><span class="p">),</span> <span class="n">outfile</span><span class="o">=</span><span class="n">mom10Diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">jointMask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jointMaskTest</span> <span class="o">=</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;&quot;==0&#39;</span>
            <span class="k">if</span> <span class="n">useAnnulus</span> <span class="ow">and</span> <span class="n">pbcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lowerAnnulusLevel</span><span class="p">,</span> <span class="n">higherAnnulusLevel</span> <span class="o">=</span> <span class="n">findOuterAnnulusForPBCube</span><span class="p">(</span><span class="n">pbcube</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">subimage</span><span class="p">,</span> <span class="n">imageInfo</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">jointMaskTest</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># this happens when meanSpectrumFile is specified</span>
                    <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># this is the pipeline use case</span>
                    <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="n">jointMaskTest</span> <span class="o">+</span> <span class="s1">&#39; &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&gt;</span><span class="si">%f</span><span class="s1"> &amp;&amp; &quot;</span><span class="si">%s</span><span class="s1">&quot;&lt;</span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pbmom</span><span class="p">,</span><span class="n">lowerAnnulusLevel</span><span class="p">,</span><span class="n">pbmom</span><span class="p">,</span><span class="n">higherAnnulusLevel</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">jointMaskTestAnnulus</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jointMaskTest = &quot;</span><span class="p">,</span> <span class="n">jointMaskTest</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;jointMaskTestAnnulus = &quot;</span><span class="p">,</span> <span class="n">jointMaskTestAnnulus</span><span class="p">)</span>
        <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">momDiffPeak</span><span class="p">,</span> <span class="n">momDiffMedian</span><span class="p">,</span> <span class="n">momDiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">momDiff</span><span class="p">,</span> 
              <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span>
              <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mom10DiffSNR</span><span class="p">,</span> <span class="n">mom10DiffPeak</span><span class="p">,</span> <span class="n">mom10DiffMedian</span><span class="p">,</span> <span class="n">mom10DiffMAD</span> <span class="o">=</span> <span class="n">imageSNR</span><span class="p">(</span><span class="n">mom10Diff</span><span class="p">,</span> 
              <span class="n">mask</span><span class="o">=</span><span class="n">jointMaskTest</span><span class="p">,</span> <span class="n">maskWithAnnulus</span><span class="o">=</span><span class="n">jointMaskTestAnnulus</span><span class="p">,</span>
              <span class="n">useAnnulus</span><span class="o">=</span><span class="n">useAnnulus</span><span class="p">,</span> <span class="n">returnAllStats</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">applyMaskToAll</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;momDiffSNR = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">momDiffSNR</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mom10DiffSNR = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mom10DiffSNR</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">momDiffSNR</span><span class="p">,</span> <span class="n">mom10DiffSNR</span></div>


<div class="viewcode-block" id="meanSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.meanSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">meanSpectrum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">nBaselineChannels</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">sigmaCube</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">nanBufferChannels</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">baselineMode</span><span class="o">=</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">continuumThreshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">meanSpectrumFile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">imageInfo</span><span class="o">=</span><span class="p">[],</span> 
                 <span class="n">chanInfo</span><span class="o">=</span><span class="p">[],</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">meanSpectrumMethod</span><span class="o">=</span><span class="s1">&#39;peakOverRms&#39;</span><span class="p">,</span> 
                 <span class="n">peakFilterFWHM</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                 <span class="n">applyMaskToMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">useThresholdWithMask</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nbin</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is not used by Cycle 6 pipeline, but remains as a manual user</span>
<span class="sd">    option. Computes a threshold and then uses it to compute the average </span>
<span class="sd">    spectrum across a CASA image cube, via the specified method.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    nBaselineChannels: number of channels to use as the baseline in </span>
<span class="sd">                       the &#39;meanAboveThreshold&#39; methods.</span>
<span class="sd">    baselineMode: how to select the channels to use as the baseline:</span>
<span class="sd">              &#39;edge&#39;: use an equal number of channels on each edge of the spw</span>
<span class="sd">               &#39;min&#39;: use the percentile channels with the lowest absolute intensity</span>
<span class="sd">    sigmaCube: multiply this value by the rms to get the threshold above which a pixel</span>
<span class="sd">               is included in the mean spectrum</span>
<span class="sd">    nanBufferChannels: when removing or replacing NaNs, do this many extra channels</span>
<span class="sd">                       beyond their actual extent</span>
<span class="sd">    useAbsoluteValue: passed to avgOverCube</span>
<span class="sd">    percentile: used with baselineMode=&#39;min&#39;</span>
<span class="sd">    continuumThreshold: if specified, only use pixels above this intensity level</span>
<span class="sd">    meanSpectrumFile: name of ASCII file to produce to speed up future runs </span>
<span class="sd">    centralArcsec: default=-1 means whole field, or a floating point value in arcsec</span>
<span class="sd">    mask: a mask image (e.g. from clean); restrict calculations to pixels with mask=1</span>
<span class="sd">    chanInfo: the list returned by numberOfChannelsInCube</span>
<span class="sd">    meanSpectrumMethod: &#39;peakOverMad&#39;, &#39;peakOverRms&#39;, &#39;meanAboveThreshold&#39;, </span>
<span class="sd">                  &#39;meanAboveThresholdOverRms&#39;, or &#39;meanAboveThresholdOverMad&#39; </span>
<span class="sd">    * &#39;meanAboveThreshold&#39;: uses a selection of baseline channels to compute the </span>
<span class="sd">        rms to be used as a threshold value (similar to constructing a moment map).</span>
<span class="sd">    * &#39;meanAboveThresholdOverRms/Mad&#39;: scale spectrum by RMS or MAD        </span>
<span class="sd">    * &#39;peakOverRms/Mad&#39; computes the ratio of the peak in a spatially-smoothed </span>
<span class="sd">        version of cube to the RMS or MAD.  Smoothing is set by peakFilterFWHM.</span>
<span class="sd">    peakFilterFWHM: value used by &#39;peakOverRms&#39; and &#39;peakOverMad&#39; to presmooth </span>
<span class="sd">        each plane with a Gaussian kernel of this width (in pixels)</span>
<span class="sd">        Set to 1 to not do any smoothing.</span>
<span class="sd">    useIAGetProfile: if True, then for peakOverMad, or meanAboveThreshold with </span>
<span class="sd">        baselineMode=&#39;min&#39;, then use ia.getprofile instead of ia.getregion </span>
<span class="sd">        and the subsequent arithmetic (because it should be faster)</span>
<span class="sd">    useThresholdWithMask: if False, then just take mean rather than meanAboveThreshold</span>
<span class="sd">        when a mask has been specified</span>
<span class="sd">    nbin: this argument is accepted but not used (not yet implemented for this older mode)</span>
<span class="sd">    Returns 8 items:</span>
<span class="sd">       * avgspectrum (vector)</span>
<span class="sd">       * avgspectrumAboveThresholdNansRemoved (vector)</span>
<span class="sd">       * avgspectrumAboveThresholdNansReplaced (vector)</span>
<span class="sd">       * threshold (scalar) </span>
<span class="sd">       * edgesUsed: 0=lower, 1=upper, 2=both</span>
<span class="sd">       * nchan (scalar)</span>
<span class="sd">       * nanmin (the value used to replace NaNs)</span>
<span class="sd">       * percentagePixelsNotMasked</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">meanSpectrumFile</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">meanSpectrumFile</span> <span class="o">=</span> <span class="n">img</span> <span class="o">+</span> <span class="s1">&#39;.meanSpectrum.&#39;</span> <span class="o">+</span> <span class="n">meanSpectrumMethod</span>
    <span class="k">if</span> <span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid meanSpectrumMethod: cannot be &#39;auto&#39; at this point.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">img</span><span class="p">)):</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not find image = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">usermaskdata</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># This is the user-specified mask (not the minpb mask inside the cube).</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">maskAxis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
        <span class="n">usermaskShape</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="n">myshape</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">myshape</span><span class="p">[</span><span class="n">maskAxis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">singlePlaneUserMask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">singlePlaneUserMask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calling myia.getregion(axes=2)&quot;</span><span class="p">)</span>
            <span class="n">usermaskdata</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape(usermaskdata) = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">usermaskdata</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">applyMaskToMask</span><span class="p">:</span>
                <span class="n">usermaskmask</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">usermaskmask</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;applyMaskToMask has zeroed out </span><span class="si">%d</span><span class="s1"> pixels.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
                    <span class="n">usermaskdata</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">usermaskdata</span><span class="p">)[</span><span class="n">maskAxis</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">singlePlaneUserMask</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">singlePlaneUserMask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">singlePlaneUserMask</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;single plane user masks are not supported by meanSpectrumMethod=&#39;meanAboveThreshold&#39;, try peakOverMad.&quot;</span><span class="p">)</span>
                <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">myia</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found spectral axis = &quot;</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imageInfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imageInfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">myrg</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">myrg</span> <span class="o">=</span> <span class="n">rgtool</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">centralArcsec</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span> <span class="ow">or</span> <span class="n">useIAGetProfile</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
                <span class="n">centralArcsec</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">meanSpectrumMethod</span> <span class="o">!=</span> <span class="s1">&#39;peakOverMad&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">useIAGetProfile</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion() useIAGetProfile=&quot;</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="p">)</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion(getmask=True)&quot;</span><span class="p">)</span>
                <span class="n">maskdata</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">blc</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trc</span> <span class="o">=</span> <span class="p">[</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="p">,</span> <span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2</span><span class="p">,</span> <span class="n">naxis1</span><span class="p">,</span> <span class="n">naxis2</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">imgShape</span><span class="p">,</span> <span class="n">crval1</span><span class="p">,</span> <span class="n">crval2</span><span class="p">,</span> <span class="n">maxBaseline</span><span class="p">,</span> <span class="n">telescope</span> <span class="o">=</span> <span class="n">imageInfo</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">chanInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">naxis1</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">centralArcsec</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">)))</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">naxis1</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">centralArcsec</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">)))</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">naxis2</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">centralArcsec</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">cdelt2</span><span class="p">))</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">naxis2</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">+</span> <span class="n">centralArcsec</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">cdelt2</span><span class="p">))</span>
            <span class="c1"># avoid going off the edge of non-square images</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span> <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span> <span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x0</span> <span class="o">&gt;=</span> <span class="n">naxis1</span><span class="p">):</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">naxis1</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">y0</span> <span class="o">&gt;=</span> <span class="n">naxis2</span><span class="p">):</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">naxis2</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">blc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trc</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchan</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion(region=region)&quot;</span><span class="p">)</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion(region=region, getmask=True)&quot;</span><span class="p">)</span>
            <span class="n">maskdata</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Taking submask for central area of image: blc=</span><span class="si">%s</span><span class="s2">, trc=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">blc</span><span class="p">),</span><span class="nb">str</span><span class="p">(</span><span class="n">trc</span><span class="p">)))</span>
                <span class="n">usermaskdata</span> <span class="o">=</span> <span class="n">submask</span><span class="p">(</span><span class="n">usermaskdata</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape of pixels = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span> <span class="o">==</span> <span class="n">usermaskShape</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Mismatch in shape between image (</span><span class="si">%s</span><span class="s2">) and mask (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span> <span class="n">usermaskShape</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">myrg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">myrg</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># in principle, the &#39;if&#39; branch could be used for both cases, but it is not yet tested so we keep the old method.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">usermaskdata</span><span class="p">)))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Mismatch in shape between image (</span><span class="si">%s</span><span class="s2">) and mask (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">usermaskdata</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">myrg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">myrg</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="k">return</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">casaVersionCompare</span><span class="p">(</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;5.3.0-22&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">useIAGetProfile</span><span class="p">)</span> <span class="ow">and</span> 
        <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverRms&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="c1"># compute myrms or mymad, ignoring masked values and usermasked values</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computing std on each plane&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computing mad on each plane&quot;</span><span class="p">)</span>
        <span class="n">myvalue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="p">))</span>
            <span class="c1"># Extract this one channel</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">mypixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="n">maskdata</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">singlePlaneUserMask</span><span class="p">):</span>
                        <span class="n">myusermask</span> <span class="o">=</span> <span class="n">usermaskdata</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">myusermask</span> <span class="o">=</span> <span class="n">usermaskdata</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="n">myregion</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
                    <span class="n">mypixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">)</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">,</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">mypixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="n">maskdata</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">singlePlaneUserMask</span><span class="p">):</span>
                        <span class="n">myusermask</span> <span class="o">=</span> <span class="n">usermaskdata</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">myusermask</span> <span class="o">=</span> <span class="n">usermaskdata</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                    <span class="n">myregion</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
                    <span class="n">mypixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">)</span>
                    <span class="n">mymask</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">,</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># user mask is typically a clean mask, so we want to use the region outside the</span>
                <span class="c1"># clean mask for computing the MAD, but also avoiding the masked edges of the image,</span>
                <span class="c1"># which are generally masked to False</span>
                <span class="n">pixelsForStd</span> <span class="o">=</span> <span class="n">mypixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">myusermask</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">mymask</span><span class="o">==</span><span class="kc">True</span><span class="p">))]</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="c1"># avoid the masked (typically outer) edges of the image using the built-in mask</span>
                <span class="n">pixelsForStd</span> <span class="o">=</span> <span class="n">mypixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mymask</span><span class="o">==</span><span class="kc">True</span><span class="p">)]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">myvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pixelsForStd</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">myvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MAD</span><span class="p">(</span><span class="n">pixelsForStd</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">myrms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myvalue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mymad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myvalue</span><span class="p">)</span>

    <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># perhaps it should be None, but this would require modification to print statement in writeMeanSpectrum</span>
    <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;peakOver&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">mybox</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">blc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">trc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">trc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">gaussianSigma</span> <span class="o">=</span> <span class="n">peakFilterFWHM</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="c1"># 2.355</span>
        <span class="k">if</span> <span class="n">casaVersionCompare</span><span class="p">(</span><span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span><span class="s1">&#39;5.3.0-22&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">gaussianSigma</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))):</span>
                <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">smoothimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">+</span><span class="s1">&#39;.imsmooth&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">smoothimg</span><span class="p">):</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Creating smoothed cube for extracting peak/mad over box=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">mybox</span><span class="p">))</span>
                    <span class="n">imsmooth</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">pix&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">peakFilterFWHM</span><span class="p">),</span> 
                             <span class="n">minor</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">pix&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">peakFilterFWHM</span><span class="p">),</span> <span class="n">pa</span><span class="o">=</span><span class="s1">&#39;0deg&#39;</span><span class="p">,</span>
                             <span class="n">box</span><span class="o">=</span><span class="n">mybox</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">smoothimg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Using existing smoothed cube&#39;</span><span class="p">)</span>
                <span class="n">smoothia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
                <span class="n">smoothia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">smoothimg</span><span class="p">)</span>
                <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">smoothia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;max/xmadm&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
<span class="c1">#               Old method, before ratios were implemented in toolkit:</span>
<span class="c1">#                mymax = smoothia.getprofile(axis=axis, function=&#39;max&#39;, mask=mask)[&#39;values&#39;]</span>
<span class="c1">#                mymad = smoothia.getprofile(axis=axis, function=&#39;xmadm&#39;, mask=mask)[&#39;values&#39;]</span>
<span class="c1">#                avgspectrum = mymax / mymad</span>
                <span class="n">smoothia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;max/xmadm&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
                <span class="n">mymax</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
                <span class="n">mymad</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;xmadm&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># compute mymax (an array of channel maxima), then divide by either myrms or mymad array</span>
            <span class="c1"># which already exist from above.</span>
            <span class="n">myvalue</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Smoothing and computing peak on each plane over box=</span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">mybox</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">usermaskdata</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span> 
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nchan</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mypixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="n">a</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">blc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                        <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                        <span class="n">myregion</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
                        <span class="n">mypixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mypixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">a</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">blc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                        <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
                        <span class="n">myregion</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
                        <span class="n">mypixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">myregion</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">gaussianSigma</span> <span class="o">&gt;</span> <span class="mf">1.1</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># taken from stackoverflow.com/questions/18697532/gaussian-filtering-a-image-with-nan-in-python</span>
                        <span class="n">V</span> <span class="o">=</span> <span class="n">mypixels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">V</span><span class="p">[</span><span class="n">mypixels</span><span class="o">!=</span><span class="n">mypixels</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">VV</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">gaussianSigma</span><span class="p">)</span>
                        <span class="n">W</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">mypixels</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>   <span class="c1"># the lack of a zero here was a long-standing bug found on Oct 12, 2017</span>
                        <span class="n">W</span><span class="p">[</span><span class="n">mypixels</span><span class="o">!=</span><span class="n">mypixels</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">WW</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">gaussianSigma</span><span class="p">)</span>
                        <span class="n">mypixels</span> <span class="o">=</span> <span class="n">VV</span><span class="o">/</span><span class="n">WW</span>
                        <span class="n">myvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mypixels</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">myvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">mypixels</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="n">gaussianSigma</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">myvalue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mypixels</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;finished&quot;</span><span class="p">)</span>
            <span class="n">mymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">myvalue</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;peakOverRms&#39;</span><span class="p">):</span>
                <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">mymax</span><span class="o">/</span><span class="n">myrms</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span> <span class="o">==</span> <span class="s1">&#39;peakOverMad&#39;</span><span class="p">):</span>
                <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">mymax</span><span class="o">/</span><span class="n">mymad</span>
        <span class="n">nansRemoved</span> <span class="o">=</span> <span class="n">removeNaNs</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">nansReplaced</span><span class="p">,</span><span class="n">nanmin</span> <span class="o">=</span> <span class="n">removeNaNs</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">,</span> <span class="n">replaceWithMin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                         <span class="n">nanBufferChannels</span><span class="o">=</span><span class="n">nanBufferChannels</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;meanAboveThreshold&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">continuumThreshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">belowThreshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="n">continuumThreshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;shape of belowThreshold = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">belowThreshold</span><span class="p">))</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">belowThreshold</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">naxes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span> <span class="c1"># len(np.shape(pixels))</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="c1"># np.shape(pixels)[axis]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>  <span class="c1"># not currently used by pipeline</span>
            <span class="c1"># Method #1: Use the two edges of the spw to find the line-free rms of the spectrum</span>
            <span class="n">nEdgeChannels</span> <span class="o">=</span> <span class="n">nBaselineChannels</span><span class="o">/</span><span class="mi">2</span>
            <span class="c1"># lower edge</span>
            <span class="n">blc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">naxes</span><span class="p">)</span>
            <span class="n">trc</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))]</span>
            <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">nEdgeChannels</span>
            <span class="n">myrg</span> <span class="o">=</span> <span class="n">rgtool</span><span class="p">()</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion(blc=</span><span class="si">%s</span><span class="s2">,trc=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="p">))</span>
            <span class="n">lowerEdgePixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
            <span class="c1"># drop all floating point zeros (which will drop pixels outside the mosaic image mask)</span>
            <span class="n">lowerEdgePixels</span> <span class="o">=</span> <span class="n">lowerEdgePixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lowerEdgePixels</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)]</span>
            <span class="n">stdLowerEdge</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">lowerEdgePixels</span><span class="p">)</span>
            <span class="n">medianLowerEdge</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">lowerEdgePixels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAD of </span><span class="si">%d</span><span class="s2"> channels on lower edge = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nBaselineChannels</span><span class="p">,</span> <span class="n">stdLowerEdge</span><span class="p">))</span>

            <span class="c1"># upper edge</span>
            <span class="n">blc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">naxes</span><span class="p">)</span>
            <span class="n">trc</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))]</span>
            <span class="n">blc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">trc</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="n">nEdgeChannels</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">myrg</span><span class="o">.</span><span class="n">box</span><span class="p">(</span><span class="n">blc</span><span class="o">=</span><span class="n">blc</span><span class="p">,</span> <span class="n">trc</span><span class="o">=</span><span class="n">trc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion(blc=</span><span class="si">%s</span><span class="s2">,trc=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">blc</span><span class="p">,</span><span class="n">trc</span><span class="p">))</span>
            <span class="n">upperEdgePixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
<span class="c1">#            myrg.done()</span>
            <span class="c1"># drop all floating point zeros</span>
            <span class="n">upperEdgePixels</span> <span class="o">=</span> <span class="n">upperEdgePixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">upperEdgePixels</span><span class="o">!=</span><span class="mf">0.0</span><span class="p">)]</span>
            <span class="n">stdUpperEdge</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">upperEdgePixels</span><span class="p">)</span>
            <span class="n">medianUpperEdge</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">upperEdgePixels</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;meanSpectrum(): edge medians: lower=</span><span class="si">%.10f</span><span class="s2">, upper=</span><span class="si">%.10f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianLowerEdge</span><span class="p">,</span> <span class="n">medianUpperEdge</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAD of </span><span class="si">%d</span><span class="s2"> channels on upper edge = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nEdgeChannels</span><span class="p">,</span> <span class="n">stdUpperEdge</span><span class="p">))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">stdLowerEdge</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">stdEdge</span> <span class="o">=</span> <span class="n">stdUpperEdge</span>
                <span class="n">medianEdge</span> <span class="o">=</span> <span class="n">medianUpperEdge</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">stdUpperEdge</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">stdEdge</span> <span class="o">=</span> <span class="n">stdLowerEdge</span>
                <span class="n">medianEdge</span> <span class="o">=</span> <span class="n">medianLowerEdge</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="n">stdEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stdLowerEdge</span><span class="p">,</span><span class="n">stdUpperEdge</span><span class="p">])</span>
                <span class="n">medianEdge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">medianLowerEdge</span><span class="p">,</span><span class="n">medianUpperEdge</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">!=</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>  <span class="c1"># of the meanAboveThreshold case</span>
            <span class="c1"># Method #2: pick the N channels with the lowest absolute values (to avoid</span>
            <span class="c1">#            confusion from absorption lines and negative bowls of missing flux)</span>
            <span class="c1">#            However, for the case of significant absorption lines, this only </span>
            <span class="c1">#            works if the continuum has been subtracted, but in</span>
            <span class="c1">#            the pipeline case, it has not been.  It should probably be changed</span>
            <span class="c1">#            to first determine if the median is closer to the min or the max, </span>
            <span class="c1">#            and if the latter, then use the maximum absolute values.</span>
            <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">useThresholdWithMask</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">maskArgument</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">maskArgument</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskArgument</span><span class="p">)</span>
                    <span class="n">absPixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">])</span>
                    <span class="c1"># Find the lowest pixel values</span>
                    <span class="n">percentileThreshold</span> <span class="o">=</span> <span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">absPixels</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">absPixels</span> <span class="o">&lt;</span> <span class="n">percentileThreshold</span><span class="p">)</span>
                    <span class="c1"># Take their statistics</span>
                    <span class="c1"># In the original implementation, the percentile min is computed over all pixels, but </span>
                    <span class="c1"># here I take aggregated over all spatial pixels into a spectral profile, because that</span>
                    <span class="c1"># is what is available from getprofile.</span>
                    <span class="n">stdMin</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">absPixels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                    <span class="n">medianMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">absPixels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">centralArcsec</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running ia.getregion&quot;</span><span class="p">)</span>
                    <span class="n">allPixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">allPixels</span> <span class="o">=</span> <span class="n">pixels</span>
                <span class="c1"># Convert all NaNs to zero</span>
                <span class="n">allPixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">allPixels</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Drop all floating point zeros and internally-masked pixels from calculation</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">allPixels</span> <span class="o">=</span> <span class="n">allPixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">allPixels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maskdata</span><span class="o">==</span><span class="kc">True</span><span class="p">))]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># avoid identical zeros and clean mask when looking for lowest pixels</span>
                    <span class="n">allPixels</span> <span class="o">=</span> <span class="n">allPixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">allPixels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maskdata</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">usermaskdata</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">))]</span>
                <span class="c1"># Take absolute value</span>
                <span class="n">absPixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">allPixels</span><span class="p">)</span>
                <span class="c1"># Find the lowest pixel values by percentile</span>
                <span class="n">percentileThreshold</span> <span class="o">=</span> <span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">absPixels</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">absPixels</span> <span class="o">&lt;</span> <span class="n">percentileThreshold</span><span class="p">)</span>
                <span class="c1"># Take their statistics</span>
                <span class="n">stdMin</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">allPixels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">medianMin</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">allPixels</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">baselineMode</span> <span class="o">==</span> <span class="s1">&#39;edge&#39;</span><span class="p">):</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">stdEdge</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">medianEdge</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;meanSpectrum(): edge mode:  median=</span><span class="si">%f</span><span class="s2">  MAD=</span><span class="si">%f</span><span class="s2">  threshold=</span><span class="si">%f</span><span class="s2"> (edgesUsed=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">medianEdge</span><span class="p">,</span> <span class="n">stdEdge</span><span class="p">,</span> <span class="n">medianEdge</span><span class="o">+</span><span class="n">stdEdge</span><span class="o">*</span><span class="n">sigmaCube</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">))</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaCube</span><span class="o">*</span><span class="n">std</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">useIAGetProfile</span> <span class="ow">or</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">useThresholdWithMask</span><span class="p">):</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">stdMin</span>
            <span class="n">median</span> <span class="o">=</span> <span class="n">medianMin</span>
            <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;**** meanSpectrum(useIAGetProfile=</span><span class="si">%s</span><span class="s2">): min mode:  median=</span><span class="si">%f</span><span class="s2">  MAD=</span><span class="si">%f</span><span class="s2">  threshold=</span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">useIAGetProfile</span><span class="p">,</span> <span class="n">medianMin</span><span class="p">,</span> <span class="n">stdMin</span><span class="p">,</span> <span class="n">medianMin</span><span class="o">+</span><span class="n">stdMin</span><span class="o">*</span><span class="n">sigmaCube</span><span class="p">))</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="n">sigmaCube</span><span class="o">*</span><span class="n">std</span>
        
        <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">maskArgument</span> <span class="o">=</span> <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0&quot;</span> <span class="o">%</span> <span class="n">mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maskArgument</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;running ia.getprofile(mean, mask=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="n">maskArgument</span><span class="p">)</span>
            <span class="n">profile</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskArgument</span><span class="p">)</span>
            <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;npix&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">naxes</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
                <span class="c1"># drop the degenerate axis so that avgOverCube will work with nanmean(axis=0)</span>
                <span class="n">pixels</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">maskdata</span> <span class="o">=</span> <span class="n">propagateMaskToAllChannels</span><span class="p">(</span><span class="n">maskdata</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maskdata</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="n">avgOverCube</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskdata</span><span class="p">,</span> <span class="n">usermask</span><span class="o">=</span><span class="n">usermaskdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverRms&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgspectrum</span> <span class="o">/=</span> <span class="n">myrms</span>
        <span class="k">elif</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgspectrum</span> <span class="o">/=</span> <span class="n">mymad</span>
        <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;running ia.getprofile(mean above threshold: mask=&#39;</span><span class="si">%s</span><span class="s2">&gt;</span><span class="si">%f</span><span class="s2">&#39;)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">threshold</span><span class="p">))</span>
                <span class="n">profile</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;</span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">useThresholdWithMask</span><span class="p">:</span>
                    <span class="n">profile</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getprofile</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;0 &amp;&amp; &#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;</span><span class="si">%f</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">threshold</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we just keep the prior result for profile which did not use a threshold</span>
                    <span class="k">pass</span>
            <span class="n">avgspectrumAboveThreshold</span> <span class="o">=</span> <span class="n">profile</span><span class="p">[</span><span class="s1">&#39;values&#39;</span><span class="p">]</span>
            <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;npix&#39;</span><span class="p">])</span><span class="o">*</span><span class="mf">100.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Using threshold above which to compute mean spectrum = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">threshold</span><span class="p">),</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Running avgOverCube&quot;</span><span class="p">)</span>
            <span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="n">avgOverCube</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">maskdata</span><span class="p">,</span> <span class="n">usermask</span><span class="o">=</span><span class="n">usermaskdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverRms&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgspectrumAboveThreshold</span> <span class="o">/=</span> <span class="n">myrms</span>
        <span class="k">elif</span> <span class="n">meanSpectrumMethod</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;OverMad&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">avgspectrumAboveThreshold</span> <span class="o">/=</span> <span class="n">mymad</span>
        <span class="k">if</span> <span class="n">useIAGetProfile</span><span class="p">:</span>
            <span class="n">nansRemoved</span> <span class="o">=</span> <span class="n">removeZeros</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span>
            <span class="n">nansReplaced</span> <span class="o">=</span> <span class="n">nansRemoved</span>
            <span class="n">nanmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running removeNaNs (len(avgspectrumAboveThreshold)=</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)))</span>
            <span class="n">nansRemoved</span> <span class="o">=</span> <span class="n">removeNaNs</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">)</span>
            <span class="n">nansReplaced</span><span class="p">,</span><span class="n">nanmin</span> <span class="o">=</span> <span class="n">removeNaNs</span><span class="p">(</span><span class="n">avgspectrumAboveThreshold</span><span class="p">,</span> <span class="n">replaceWithMin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                             <span class="n">nanBufferChannels</span><span class="o">=</span><span class="n">nanBufferChannels</span><span class="p">)</span>

    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanInfo</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">chanInfo</span> <span class="o">=</span> <span class="n">numberOfChannelsInCube</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">returnChannelWidth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">returnFreqs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="n">nchan</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">channelWidth</span> <span class="o">=</span> <span class="n">chanInfo</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
    <span class="n">writeMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">avgspectrum</span><span class="p">,</span> <span class="n">nansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
                      <span class="n">nchan</span><span class="p">,</span> <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myrg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span> <span class="n">myrg</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">,</span> <span class="n">nansRemoved</span><span class="p">,</span> <span class="n">nansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> 
           <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span><span class="p">)</span></div>


<div class="viewcode-block" id="getMaxpixpos">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getMaxpixpos">[docs]</a>
<span class="k">def</span> <span class="nf">getMaxpixpos</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by findContinuum, but only in Cycle 4+5 heuristic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">maxpixpos</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">statistics</span><span class="p">()[</span><span class="s1">&#39;maxpos&#39;</span><span class="p">]</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">maxpixpos</span></div>


<div class="viewcode-block" id="submask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.submask">[docs]</a>
<span class="k">def</span> <span class="nf">submask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrum, but only in Cycle 4+5 heuristic.</span>
<span class="sd">    Takes a spectral mask array, and picks out a subcube defined by a </span>
<span class="sd">    blc,trc-defined region</span>
<span class="sd">    region: dictionary containing keys &#39;blc&#39; and &#39;trc&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;blc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;trc&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">region</span><span class="p">[</span><span class="s1">&#39;blc&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span><span class="n">region</span><span class="p">[</span><span class="s1">&#39;trc&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="avgOverCube">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.avgOverCube">[docs]</a>
<span class="k">def</span> <span class="nf">avgOverCube</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">useAbsoluteValue</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">median</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">usermask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">useIAGetProfile</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function was used by Cycle 4 and 5 pipeline from meanSpectrum(), </span>
<span class="sd">    but will not be used in the Cycle 6 default heuristic of </span>
<span class="sd">    &#39;mom0mom8jointMask&#39;.</span>
<span class="sd">    Computes the average spectrum across a multi-dimensional</span>
<span class="sd">    array read from an image cube, ignoring any NaN values.</span>
<span class="sd">    Inputs:</span>
<span class="sd">    pixels: a 3D array (with degenerate Stokes axis dropped)</span>
<span class="sd">    threshold: value in Jy</span>
<span class="sd">    median: if True, compute the median instead of the mean</span>
<span class="sd">    mask: use pixels inside this spatial mask (i.e. with value==1 or True) to compute </span>
<span class="sd">          the average (the spectral mask is taken as the union of all channels)</span>
<span class="sd">          This is the mask located inside the image cube specified in findContinuum(img=&#39;&#39;)</span>
<span class="sd">    usermask: this array results from the mask specified in findContinuum(mask=&#39;&#39;) parameter</span>
<span class="sd">    If threshold is specified, then it only includes pixels</span>
<span class="sd">    with an intensity above that value.</span>
<span class="sd">    Returns:</span>
<span class="sd">    * average spectrum</span>
<span class="sd">    * percentage of pixels not masked</span>
<span class="sd">    Note: This function assumes that the spectral axis is the final axis.</span>
<span class="sd">        If it is not, there is no single setting of the axis parameter that </span>
<span class="sd">        can make it work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">useAbsoluteValue</span><span class="p">):</span>
        <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">pixels</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="o">==</span><span class="kc">False</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">maskfalse</span> <span class="o">=</span> <span class="n">after</span><span class="o">-</span><span class="n">before</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> pixels (</span><span class="si">%.2f%%</span><span class="s2">) where mask is False&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskfalse</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="mf">100.</span><span class="o">*</span><span class="n">maskfalse</span><span class="o">/</span><span class="n">npixels</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">usermask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">usermask</span><span class="o">==</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">maskfalse</span> <span class="o">=</span> <span class="n">after</span><span class="o">-</span><span class="n">before</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Ignoring </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> pixels (</span><span class="si">%.2f%%</span><span class="s2">) where usermask is 0&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskfalse</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="mf">100.</span><span class="o">*</span><span class="n">maskfalse</span><span class="o">/</span><span class="n">npixels</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">usermask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">nonnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span>
        <span class="n">percentageUsed</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">nonnan</span><span class="o">/</span><span class="n">npixels</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> pixels (</span><span class="si">%.2f%%</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nonnan</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="n">percentageUsed</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">percentageUsed</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Check if each channel has an intensity contribution from at least one spatial pixel.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span> <span class="o">==</span> <span class="mi">4</span><span class="p">):</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="n">pixels</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">validChan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">validChan</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;ch</span><span class="si">%4d</span><span class="s2">: none of the </span><span class="si">%d</span><span class="s2"> pixels meet the threshold in this channel&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">channel</span><span class="p">)))</span>
    <span class="c1"># Compute the mean (or median) spectrum by averaging over one spatial dimension followed by the next,</span>
    <span class="c1"># replacing the pixels array with an array that is smaller by one dimension after the first averaging step.</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">median</span><span class="p">):</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">nanmedian</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pixels</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pixels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">pixels</span> <span class="o">=</span> <span class="n">nanmean</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">pixels</span><span class="p">,</span> <span class="n">percentageUsed</span><span class="p">)</span></div>


<div class="viewcode-block" id="propagateMaskToAllChannels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.propagateMaskToAllChannels">[docs]</a>
<span class="k">def</span> <span class="nf">propagateMaskToAllChannels</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called by meanSpectrum.</span>
<span class="sd">    Takes a spectral mask array, and propagates every masked spatial pixel to </span>
<span class="sd">    all spectral channels of the array.</span>
<span class="sd">    Returns: a 2D mask (of the same spatial dimension as the input, </span>
<span class="sd">              but with only 1 channel)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Propagating image mask to all channels&quot;</span><span class="p">)</span>
    <span class="n">startTime</span> <span class="o">=</span> <span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">newmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">newmask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">newmask</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;  elapsed time = </span><span class="si">%.1f</span><span class="s2"> sec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">timeUtilities</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">startTime</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">newmask</span><span class="p">)</span></div>


<div class="viewcode-block" id="widthOfMaskArcsec">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.widthOfMaskArcsec">[docs]</a>
<span class="k">def</span> <span class="nf">widthOfMaskArcsec</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">maskInfo</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is not used by pipeline when meanSpectrumMethod=&#39;mom0mom8jointMask&#39; or if mask=&#39;&#39;</span>
<span class="sd">    Finds width of the smallest central square that circumscribes all masked </span>
<span class="sd">    pixels.  Returns the value in arcsec.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Opening mask: &quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
    <span class="c1">#  ia.getregion()           yields np.shape(pixels) = (1,138119016)</span>
    <span class="c1">#  ia.getregion(axes=[0,1]) yields np.shape(pixels) = (1,1,1,1918)</span>
    <span class="c1">#  ia.getregion(axes=[2,3]) yields np.shape(pixels) = (1960,1960,1,1)</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pixels</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">leftRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">rightRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">width</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">leftRadius</span><span class="p">,</span><span class="n">rightRadius</span><span class="p">]))</span>
    <span class="n">topRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">bottomRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">pixels</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> 
    <span class="n">height</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">([</span><span class="n">topRadius</span><span class="p">,</span><span class="n">bottomRadius</span><span class="p">]))</span>
    <span class="n">cdelt1</span> <span class="o">=</span> <span class="n">maskInfo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cdelt1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">width</span></div>


<div class="viewcode-block" id="checkForTriangularWavePattern">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.checkForTriangularWavePattern">[docs]</a>
<span class="k">def</span> <span class="nf">checkForTriangularWavePattern</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">triangleFraction</span><span class="o">=</span><span class="mf">0.83</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used for meanSpectrumMethod == &#39;mom0mom8jointMask&#39;.</span>
<span class="sd">    Fit and remove linear slopes to each half of the spectrum, then comparse</span>
<span class="sd">    the MAD of the residual to the MAD of the original spectrum</span>
<span class="sd">    pad: fraction of total channels to ignore on each edge (e.g. 20: 1/20th)</span>
<span class="sd">    triangleFraction: MAD of dual-linfit residual must be less than this fraction*originalMAD</span>
<span class="sd">    Returns: </span>
<span class="sd">    * Boolean: whether triangular pattern meets the threshold</span>
<span class="sd">    * value: either False (if slope test failed) or a float (the ratio of the MADs)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Checking for triangular wave pattern in the noise&#39;</span><span class="p">)</span>
    <span class="n">chanlist</span><span class="p">,</span> <span class="n">mad</span> <span class="o">=</span> <span class="n">computeMadSpectrum</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanlist</span><span class="p">)</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">nchan</span><span class="o">/</span><span class="n">pad</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">nchan</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nchan</span><span class="o">/</span><span class="n">pad</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">intercept</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mad</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">:</span><span class="o">-</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">])</span>
    <span class="n">slope0</span><span class="p">,</span> <span class="n">intercept0</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">:</span><span class="n">n0</span><span class="p">],</span> <span class="n">mad</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">:</span><span class="n">n0</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">mad</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">:</span><span class="n">n0</span><span class="p">]))</span>
    <span class="n">slope1</span><span class="p">,</span> <span class="n">intercept1</span> <span class="o">=</span> <span class="n">linfit</span><span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="o">-</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">],</span> <span class="n">mad</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="o">-</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">],</span> <span class="n">MAD</span><span class="p">(</span><span class="n">mad</span><span class="p">[</span><span class="n">n1</span><span class="p">:</span><span class="o">-</span><span class="n">nchan</span><span class="o">/</span><span class="n">pad</span><span class="p">]))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;checkForTriangularWavePattern: slope0=</span><span class="si">%+g</span><span class="s2">, slope1=</span><span class="si">%+g</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slope0</span><span class="p">,</span><span class="n">slope1</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
    <span class="n">slopeTest</span> <span class="o">=</span> <span class="n">slope0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">slope1</span> <span class="o">&lt;</span> <span class="mi">0</span> 
    <span class="n">slopeDiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span><span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope0</span><span class="p">))</span>
    <span class="n">slopeSum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope0</span><span class="p">))</span>
    <span class="n">similarSlopeThreshold</span> <span class="o">=</span> <span class="mf">0.70</span> <span class="c1"># 0.40</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;slopeSum = &quot;</span><span class="p">,</span> <span class="n">slopeSum</span><span class="p">)</span>
    <span class="n">similarSlopes</span> <span class="o">=</span> <span class="n">slopeDiff</span><span class="o">/</span><span class="n">slopeSum</span> <span class="o">&lt;</span> <span class="n">similarSlopeThreshold</span> 
    <span class="c1"># if the slope is sufficiently high, then it is probably a real feature, not a noise feature</span>
    <span class="n">slopeSignPattern</span> <span class="o">=</span> <span class="n">slope0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">slope1</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">largeSlopes</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slope0</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-5</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">slope1</span><span class="p">)</span><span class="o">&gt;</span><span class="mf">1e-5</span>
    <span class="n">differentSlopeThreshold</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">differentSlopes</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope0</span><span class="o">/</span><span class="n">slope1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">differentSlopeThreshold</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">slope0</span><span class="o">/</span><span class="n">slope1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">differentSlopeThreshold</span><span class="p">)</span>
    <span class="n">slopeTest</span> <span class="o">=</span> <span class="p">(</span><span class="n">slopeSignPattern</span> <span class="ow">and</span> <span class="n">similarSlopes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">largeSlopes</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">differentSlopes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">largeSlopes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slopeTest</span><span class="p">:</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">mad</span> <span class="o">-</span> <span class="p">(</span><span class="n">chanlist</span><span class="o">*</span><span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>
        <span class="n">madOfResidualSingleLine</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="n">residual</span><span class="p">)</span>  
        <span class="n">residual0</span> <span class="o">=</span> <span class="n">mad</span><span class="p">[:</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[:</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">slope0</span> <span class="o">+</span> <span class="n">intercept0</span><span class="p">)</span>
        <span class="n">residual1</span> <span class="o">=</span> <span class="n">mad</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">chanlist</span><span class="p">[</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">:]</span><span class="o">*</span><span class="n">slope1</span> <span class="o">+</span> <span class="n">intercept1</span><span class="p">)</span>
        <span class="n">madOfResidual</span> <span class="o">=</span> <span class="n">MAD</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">residual0</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">residual1</span><span class="p">))</span>
        <span class="n">madRatio</span> <span class="o">=</span> <span class="n">madOfResidual</span><span class="o">/</span><span class="n">madOfResidualSingleLine</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;checkForTriangularWavePattern: MAD_of_residual=</span><span class="si">%e</span><span class="s2">, thresholdFraction=</span><span class="si">%.2f</span><span class="s2">, ratio_of_MADs=</span><span class="si">%.3f</span><span class="s2">, slopeDiff/slopeSum=</span><span class="si">%.2f</span><span class="s2">, slope0/slope1=</span><span class="si">%.2f</span><span class="s2">, signPattern=</span><span class="si">%s</span><span class="s2"> similarSlopes=</span><span class="si">%s</span><span class="s2"> largeSlopes=</span><span class="si">%s</span><span class="s2"> differentSlopes=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">madOfResidual</span><span class="p">,</span> <span class="n">triangleFraction</span><span class="p">,</span> <span class="n">madRatio</span><span class="p">,</span> <span class="n">slopeDiff</span><span class="o">/</span><span class="n">slopeSum</span><span class="p">,</span><span class="n">slope0</span><span class="o">/</span><span class="n">slope1</span><span class="p">,</span><span class="n">slopeSignPattern</span><span class="p">,</span><span class="n">similarSlopes</span><span class="p">,</span><span class="n">largeSlopes</span><span class="p">,</span><span class="n">differentSlopes</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">madRatio</span> <span class="o">&lt;</span> <span class="n">triangleFraction</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">madRatio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">madRatio</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;checkForTriangularWavePattern: slopeDiff/slopeSum=</span><span class="si">%.2f</span><span class="s2"> signPattern=</span><span class="si">%s</span><span class="s2"> similarSlopes=</span><span class="si">%s</span><span class="s2"> largeSlopes=</span><span class="si">%s</span><span class="s2">  </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slopeDiff</span><span class="o">/</span><span class="n">slopeSum</span><span class="p">,</span><span class="n">slopeSignPattern</span><span class="p">,</span><span class="n">similarSlopes</span><span class="p">,</span><span class="n">largeSlopes</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">slopeTest</span></div>

    
<div class="viewcode-block" id="computeMadSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.computeMadSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">computeMadSpectrum</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used for meanSpectrumMethod == &#39;mom0mom8jointMask&#39;.</span>
<span class="sd">            Only used by checkForTriangularWavePattern.</span>
<span class="sd">    Uses the imstat task to compute an array containing the MAD spectrum of a cube.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">findSpectralAxis</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">myshape</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myshape</span><span class="p">)))</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">myshape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="n">chanlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nchan</span><span class="p">))</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Computing MAD spectrum with imstat.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;imstat&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">)</span> 
    <span class="n">mydict</span> <span class="o">=</span> <span class="n">imstat</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">,</span> <span class="n">listit</span><span class="o">=</span><span class="n">imstatListit</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">imstatVerbose</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">chanlist</span><span class="p">,</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="isSingleContinuum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.isSingleContinuum">[docs]</a>
<span class="k">def</span> <span class="nf">isSingleContinuum</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;OBSERVE_TARGET&#39;</span><span class="p">,</span> 
                      <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used by pipeline, rather it is an expected input parameter.</span>
<span class="sd">    Checks whether an spw was defined as single continuum in the OT by</span>
<span class="sd">    looking at the transition name in the SOURCE table of a measurement set.</span>
<span class="sd">    vis: a single measurement set, a comma-delimited list, or a python list </span>
<span class="sd">         (only the first one will be used)</span>
<span class="sd">    Optional parameters:</span>
<span class="sd">    spw: can be integer ID or string integer ID; if not specified, then it </span>
<span class="sd">         will use the first science spw</span>
<span class="sd">    source: passed to transitions(); if not specified, it will use the first one</span>
<span class="sd">    intent: if source is blank then use first one with matching intent and spw</span>
<span class="sd">    mymsmd: an existing instance of the msmd tool</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">vis</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">spw</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
            <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">getScienceSpws</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">returnString</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="n">mymsmd</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">transitions</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">mymsmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Single_Continuum&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Identified spectral setup as Single_Continuum from transition name.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>

    
<div class="viewcode-block" id="sanitizeNames">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.sanitizeNames">[docs]</a>
<span class="k">def</span> <span class="nf">sanitizeNames</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">newchar</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces various special characters with specified character.</span>
<span class="sd">    +++++++ This function is not used by pipeline, because it is only used by transitions() which is only used by isSingleContinuum.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">newnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">newname</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;(&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">]:</span>
            <span class="n">newname</span> <span class="o">=</span> <span class="n">newname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="n">newchar</span><span class="p">)</span>
        <span class="n">newnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newname</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">newnames</span></div>


<div class="viewcode-block" id="transitions">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.transitions">[docs]</a>
<span class="k">def</span> <span class="nf">transitions</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;OBSERVE_TARGET&#39;</span><span class="p">,</span> 
                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mymsmd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used by pipeline, because it is only used by </span>
<span class="sd">    isSingleContinuum() and the pipeline passes the Boolean singleContinuum.</span>
<span class="sd">    However, it is used by my regression, so it is important to pass the vis</span>
<span class="sd">    which has the virtual spw == real spw, which is normally the first spw</span>
<span class="sd">    observed.</span>
<span class="sd">    Returns the list of transitions for specified spw (and source).</span>
<span class="sd">    vis: measurement set</span>
<span class="sd">    spw: can be integer ID or string integer ID</span>
<span class="sd">    Optional parameters:</span>
<span class="sd">    source: can be integer ID or string name; if not specified, use the first one</span>
<span class="sd">    intent: if source is blank then use first one with matching intent and spw</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find measurement set&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">mymsmd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">needToClose</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mymsmd</span> <span class="o">=</span> <span class="n">msmdtool</span><span class="p">()</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">spw</span> <span class="o">&gt;=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">nspw</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spw not in the dataset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
            <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SOURCE&#39;</span><span class="p">)</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
    <span class="n">sourceIDs</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SOURCE_ID&#39;</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="c1"># pick source</span>
            <span class="n">fields1</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">fieldsforintent</span><span class="p">(</span><span class="n">intent</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
            <span class="n">fields2</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">fieldsforspw</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">fields1</span><span class="p">,</span><span class="n">fields2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spw=</span><span class="si">%d</span><span class="s2">, intent=</span><span class="si">%s</span><span class="s2">, fields1=</span><span class="si">%s</span><span class="s2">, fields2=</span><span class="si">%s</span><span class="s2">, Fields=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span><span class="n">intent</span><span class="p">,</span><span class="n">fields1</span><span class="p">,</span><span class="n">fields2</span><span class="p">,</span><span class="n">fields</span><span class="p">))</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">mymsmd</span><span class="o">.</span><span class="n">namesforfields</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;For spw </span><span class="si">%d</span><span class="s2">, picked source: &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">source</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bytes_</span><span class="p">)):</span>
        <span class="n">sourcerows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">names</span><span class="o">==</span><span class="n">source</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sourcerows</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># look for characters ()/ and replace with underscore</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sanitizeNames</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
            <span class="n">sourcerows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">source</span><span class="o">==</span><span class="n">names</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sourcerows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sourceIDs</span><span class="o">==</span><span class="n">source</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
    <span class="n">spwrows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spws</span><span class="o">==</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">spwrows</span><span class="p">,</span> <span class="n">sourcerows</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mytb</span><span class="o">.</span><span class="n">iscelldefined</span><span class="p">(</span><span class="s1">&#39;TRANSITION&#39;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TRANSITION&#39;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No transition value found for this source/spw (row=</span><span class="si">%s</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">)</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">needToClose</span><span class="p">:</span>
        <span class="n">mymsmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span></div>


<div class="viewcode-block" id="getObservationStart">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getObservationStart">[docs]</a>
<span class="k">def</span> <span class="nf">getObservationStart</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">obsid</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads the start time of the observation from the OBSERVATION table (using tb tool)</span>
<span class="sd">    and reports it in MJD seconds.</span>
<span class="sd">    obsid: if -1, return the start time of the earliest obsID</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;vis does not exist = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vis</span><span class="p">))</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/table.dat&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No table.dat.  This does not appear to be an ms.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Use au.getObservationStartDateFromASDM().&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/OBSERVATION&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR: failed to open OBSERVATION table on file &quot;</span><span class="o">+</span><span class="n">vis</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">time_range</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME_RANGE&#39;</span><span class="p">)</span>
    <span class="n">mytb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time_range: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_range</span><span class="p">))</span>
    <span class="c1"># the first index is whether it is starttime(0) or stoptime(1) </span>
    <span class="n">time_range</span> <span class="o">=</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time_range[0]: &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time_range</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">obsid</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_range</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Invalid obsid&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">obsid</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="n">time_range</span><span class="p">[</span><span class="n">obsid</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">time_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">time_range</span><span class="p">)</span></div>


<div class="viewcode-block" id="getObservatoryName">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getObservatoryName">[docs]</a>
<span class="k">def</span> <span class="nf">getObservatoryName</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used by pipeline, because it is only used by getScienceSpws.</span>
<span class="sd">    Returns the observatory name in the specified ms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">antTable</span> <span class="o">=</span> <span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/OBSERVATION&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mytb</span> <span class="o">=</span> <span class="n">tbtool</span><span class="p">()</span>
        <span class="n">mytb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">antTable</span><span class="p">)</span>
        <span class="n">myName</span> <span class="o">=</span> <span class="n">mytb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TELESCOPE_NAME&#39;</span><span class="p">)</span>
        <span class="n">mytb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Could not open OBSERVATION table to get the telescope name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">antTable</span><span class="p">))</span>
        <span class="n">myName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">myName</span><span class="p">)</span></div>


<div class="viewcode-block" id="makeUvcontsub">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.makeUvcontsub">[docs]</a>
<span class="k">def</span> <span class="nf">makeUvcontsub</span><span class="p">(</span><span class="n">files</span><span class="o">=</span><span class="s1">&#39;*.dat&#39;</span><span class="p">,</span> <span class="n">fitorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">useFrequency</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used anywhere else in this file.</span>
<span class="sd">    Takes a list of output files from findContinuum and builds an spw selection</span>
<span class="sd">    for uvcontsub, then prints the resulting commands to the screen.</span>
<span class="sd">    files: a list of files, either a comma-delimited string, a python list, or a wildcard string</span>
<span class="sd">    fitorder: passed through to the uvcontsub</span>
<span class="sd">    useFrequency: if True, then produce selection string in frequency; otherwise use channels</span>
<span class="sd">      Note: frequencies in the findContinuum .dat file are topo, which is what uvcontsub wants.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">files</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">resultFiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
        <span class="n">uids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">resultFile</span> <span class="ow">in</span> <span class="n">resultFiles</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">resultFile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">uids</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are results for more than one OUS in this directory.  Be more specific.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">resultFiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resultFiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
    <span class="n">freqRanges</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">resultFiles</span><span class="p">:</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">rf</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">+</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">rf</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">channelRanges</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">freqRanges</span><span class="p">:</span>
                    <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">]:</span>
                    <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>
                <span class="k">if</span> <span class="n">useFrequency</span><span class="p">:</span>
                    <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span><span class="n">channelRanges</span><span class="p">)</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spws</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">freqRanges</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">and</span> <span class="n">useFrequency</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no frequency ranges in the *.dat files.  You need to run findContinuum with the &#39;vis&#39; parameter specified.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="n">freqRanges</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;uvcontsub(&#39;</span><span class="si">%s</span><span class="s2">&#39;, field=&#39;</span><span class="si">%s</span><span class="s2">&#39;, fitorder=</span><span class="si">%d</span><span class="s2">, spw=&#39;</span><span class="si">%s</span><span class="s2">&#39;, fitspw=&#39;</span><span class="si">%s</span><span class="s2">&#39;)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">fitorder</span><span class="p">,</span> <span class="n">spws</span><span class="p">,</span> <span class="n">freqRanges</span><span class="p">[</span><span class="n">uid</span><span class="p">][</span><span class="n">field</span><span class="p">]))</span></div>


<div class="viewcode-block" id="getcube">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.getcube">[docs]</a>
<span class="k">def</span> <span class="nf">getcube</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;cubelist.txt&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++ This function is not used by pipeline.</span>
<span class="sd">    Translates a PDF page number to a cube name, for regression purposes,</span>
<span class="sd">    by reading the specified file.</span>
<span class="sd">    filename: a file containing 2-column lines like:  &#39;1 mycube.residual&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">cube</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>         
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Translated cube </span><span class="si">%d</span><span class="s1"> into </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">cube</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">cube</span></div>


<div class="viewcode-block" id="readViewerOutputFile">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readViewerOutputFile">[docs]</a>
<span class="k">def</span> <span class="nf">readViewerOutputFile</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++++ This function is not used by the pipeline.</span>
<span class="sd">    Reads an ASCII spectrum file produced by the CASA viewer or by tt.ispec.</span>
<span class="sd">    Returns: 4 items: 2 arrays and 2 strings:</span>
<span class="sd">    * array for x-axis, array for y-axis </span>
<span class="sd">    * x-axis units, intensity units</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pixel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">xunits</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="n">intensityUnits</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span> 
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;pixel&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">pixel</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;[[&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;]]&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xLabel&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">xunits</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Read xunits = &quot;</span><span class="p">,</span> <span class="n">xunits</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;yLabel&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">intensityUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">intensityUnits</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; (&#39;</span> <span class="o">+</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>
            <span class="k">continue</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span> 
            <span class="k">continue</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">xunits</span><span class="p">,</span> <span class="n">intensityUnits</span><span class="p">)</span></div>


<div class="viewcode-block" id="readMeanSpectrumFITSFile">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readMeanSpectrumFITSFile">[docs]</a>
<span class="k">def</span> <span class="nf">readMeanSpectrumFITSFile</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++++ This function is not used by the pipeline.</span>
<span class="sd">    Reads a spectrum from a FITS table, such as one output by the spectralcube</span>
<span class="sd">    python module: https://spectral-cube.readthedocs.io/en/latest/index.html</span>
<span class="sd">    Returns: 8 items</span>
<span class="sd">    * average spectrum</span>
<span class="sd">    * average spectrum with the NaNs replaced with the minimum value</span>
<span class="sd">    * threshold used (currently hardcoded to 0.0)</span>
<span class="sd">    * edges used (currently hardcoded to 2)</span>
<span class="sd">    * number of channels</span>
<span class="sd">    * the minimum value</span>
<span class="sd">    * first frequency</span>
<span class="sd">    * last frequency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">)</span>
    <span class="n">tbheader</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="n">tbdata</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">unit</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbdata</span><span class="p">)</span>
    <span class="n">crpix</span> <span class="o">=</span> <span class="n">tbheader</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span>
    <span class="n">crval</span> <span class="o">=</span> <span class="n">tbheader</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span>
    <span class="n">cdelt</span> <span class="o">=</span> <span class="n">tbheader</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">tbheader</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="p">(</span><span class="s1">&#39;hz&#39;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: frequency units are not Hz = &quot;</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">return</span>
    <span class="n">firstFreq</span> <span class="o">=</span> <span class="n">crval</span> <span class="o">-</span> <span class="p">(</span><span class="n">crpix</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">cdelt</span>
    <span class="n">lastFreq</span> <span class="o">=</span> <span class="n">firstFreq</span> <span class="o">+</span> <span class="n">cdelt</span><span class="o">*</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">tbdata</span>
    <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#    print(&quot;Found %d channels&quot; % (len(tbdata)), np.shape(tbdata))</span>
    <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span><span class="n">nanmin</span> <span class="o">=</span> <span class="n">removeNaNs</span><span class="p">(</span><span class="n">tbdata</span><span class="p">,</span> <span class="n">replaceWithMin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                     <span class="n">nanBufferChannels</span><span class="o">=</span><span class="n">nanBufferChannels</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
           <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">)</span></div>


<div class="viewcode-block" id="readPreviousMeanSpectrum">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.readPreviousMeanSpectrum">[docs]</a>
<span class="k">def</span> <span class="nf">readPreviousMeanSpectrum</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">invert</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ++++++ This function is not used by the pipeline.</span>
<span class="sd">    Read a previous calculated mean spectrum and its parameters,</span>
<span class="sd">    or an ASCII file created by the CASA viewer (or tt.ispec).</span>
<span class="sd">    Note: only the intensity column(s) are returned, not the </span>
<span class="sd">       channel/frequency columns.</span>
<span class="sd">    This function will not typically be used by the pipeline, only manual users.</span>
<span class="sd">    Returns: 11 things:  </span>
<span class="sd">           avgspectrum, avgSpectrumNansReplaced, threshold,</span>
<span class="sd">           edgesUsed, nchan, nanmin, firstFreq, lastFreq, centralArcsec,</span>
<span class="sd">           mask, percentagePixelsNotMasked</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">meanSpectrumFile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span>  <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Detect file type:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;title: Spectral profile&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># CASA viewer/au.ispec output file</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading CASA viewer output file&quot;</span><span class="p">)</span>
        <span class="n">freq</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">freqUnits</span><span class="p">,</span> <span class="n">intensityUnits</span> <span class="o">=</span> <span class="n">readViewerOutputFile</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">freqUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ghz&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">freq</span> <span class="o">*=</span> <span class="mf">1e9</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">freqUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mhz&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">freq</span> <span class="o">*=</span> <span class="mf">1e6</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">freqUnits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;[hz&#39;</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spectral axis of viewer output file must be in Hz, MHz or GHz, not </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">freqUnits</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">return</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
               <span class="n">edgesUsed</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">intensity</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">intensity</span><span class="p">),</span> <span class="n">freq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">centralArcsec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;centralArcsec=&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=auto&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">centralArcsec</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;=mom0mom8jointMask&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">centralArcsec</span> <span class="o">=</span> <span class="s1">&#39;mom0mom8jointMask&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">centralArcsec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;centralArcsec=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">):</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">):</span>
                    <span class="n">percentagePixelsNotMasked</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">token</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">edgesUsed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">nanmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">edgesUsed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nanmin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">avgspectrum</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">avgSpectrumNansReplaced</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">):</span> <span class="k">continue</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># continue to support the old 2-column format</span>
            <span class="n">freq</span><span class="p">,</span><span class="n">a</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">nchan</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">:</span>
                <span class="n">freq</span> <span class="o">*=</span> <span class="mf">1e6</span> <span class="c1"># convert MHz to Hz</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">chan</span><span class="p">,</span><span class="n">freq</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
            <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;len(tokens) = &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">avgspectrum</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">avgSpectrumNansReplaced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="n">avgspectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">)</span>    
    <span class="n">avgSpectrumNansReplaced</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
        <span class="n">avgspectrum</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">))</span>
        <span class="n">avgSpectrumNansReplaced</span> <span class="o">+=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">avgSpectrumNansReplaced</span><span class="p">))</span>
        
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">firstFreq</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lastFreq</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">firstFreq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lastFreq</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Read previous mean spectrum with </span><span class="si">%d</span><span class="s2"> channels, (</span><span class="si">%d</span><span class="s2"> freqs: </span><span class="si">%f</span><span class="s2">-</span><span class="si">%f</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">freqs</span><span class="p">),</span><span class="n">firstFreq</span><span class="p">,</span><span class="n">lastFreq</span><span class="p">),</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">avgspectrum</span><span class="p">,</span> <span class="n">avgSpectrumNansReplaced</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span>
           <span class="n">edgesUsed</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nanmin</span><span class="p">,</span> <span class="n">firstFreq</span><span class="p">,</span> <span class="n">lastFreq</span><span class="p">,</span> <span class="n">centralArcsec</span><span class="p">,</span>
           <span class="n">mask</span><span class="p">,</span> <span class="n">percentagePixelsNotMasked</span><span class="p">)</span></div>


<div class="viewcode-block" id="removeNaNs">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.removeNaNs">[docs]</a>
<span class="k">def</span> <span class="nf">removeNaNs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">replaceWithMin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nanBufferChannels</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
               <span class="n">replaceWithZero</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++++ This function is not used for meanSpectrumMethod == &#39;mom0mom8jointMask&#39; by pipeline,</span>
<span class="sd">            But it is called by readMeanSpectrumFITSFile available to manual users.</span>
<span class="sd">    Remove or replace the nan values from an array.</span>
<span class="sd">    replaceWithMin: if True, then replace NaNs with np.nanmin of array</span>
<span class="sd">                    if False, then simply remove the NaNs</span>
<span class="sd">    replaceWithZero: if True, then replace NaNs with np.nanmin of array</span>
<span class="sd">                    if False, then simply remove the NaNs</span>
<span class="sd">    nanBufferChannels: only active if replaceWithMin=True</span>
<span class="sd">    Returns:</span>
<span class="sd">    * new array</span>
<span class="sd">    * if replaceWithMin=True, then also return the value used to replace NaNs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> 
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span> <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">startLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">replaceWithMin</span> <span class="ow">or</span> <span class="n">replaceWithZero</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> nan channels: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Found </span><span class="si">%d</span><span class="s2"> inf channels&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idx2</span><span class="o">==</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">a_nanmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nanBufferChannels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">idxlist</span> <span class="o">=</span> <span class="n">splitListIntoHomogeneousLists</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mylist</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxlist</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="c1"># if this is a sublist of NaN channels, then apply list as is</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="n">mylist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if this is a sublist of non-NaN channels, then flag</span>
                    <span class="c1"># an additional nanBufferChannels after the prior NaN </span>
                    <span class="c1"># sublist, but only if there was a prior sublist</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">newSubString</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newSubString</span> <span class="o">=</span> <span class="n">nanBufferChannels</span><span class="o">*</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span> 
                    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxlist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="c1"># we are not on the final sublist</span>
                        <span class="n">newSubString</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">nanBufferChannels</span><span class="p">:</span><span class="o">-</span><span class="n">nanBufferChannels</span><span class="p">]</span> <span class="o">+</span> <span class="n">nanBufferChannels</span><span class="o">*</span><span class="p">[</span><span class="kc">True</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newSubString</span> <span class="o">+=</span> <span class="n">mylist</span><span class="p">[</span><span class="o">-</span><span class="n">nanBufferChannels</span><span class="p">:]</span>
                    <span class="c1"># In case the channel block was less than 2*nanBufferChannels wide, then only insert up to its width</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="n">newSubString</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replaced </span><span class="si">%d</span><span class="s2"> NaNs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replaced </span><span class="si">%d</span><span class="s2"> infs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">replaceWithMin</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_nanmin</span>
            <span class="n">a</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_nanmin</span>
            <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a_nanmin</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">replaceWithZero</span><span class="p">):</span>
            <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">a</span><span class="p">[</span><span class="n">idx2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> NaNs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startLength</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
        <span class="n">startLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> infs&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">startLength</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></div>


<div class="viewcode-block" id="splitListIntoHomogeneousLists">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.splitListIntoHomogeneousLists">[docs]</a>
<span class="k">def</span> <span class="nf">splitListIntoHomogeneousLists</span><span class="p">(</span><span class="n">mylist</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called only by removeNaNs, and hence is not used in Cycle 6-onward pipeline.</span>
<span class="sd">    Converts [1,1,1,2,2,3] into [[1,1,1],[2,2],[3]], etc.</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mylists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">newlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">mylist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">mylist</span><span class="p">)):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">mylists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newlist</span><span class="p">)</span>
            <span class="n">newlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mylist</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">mylists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newlist</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">mylists</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="removeZeros">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.removeZeros">[docs]</a>
<span class="k">def</span> <span class="nf">removeZeros</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    +++++ This function is not used for meanSpectrumMethod=&#39;mom0mom8jointMask&#39;.</span>
<span class="sd">    Takes an array, and replaces all appearances of 0.0 with the minimum value</span>
<span class="sd">    of all channels not equal to 0.0.  This is used to reduce the bias caused</span>
<span class="sd">    by the edge channels being 0.0 in the profiles returned by ia.getprofile.</span>
<span class="sd">    If the absolute value of the minimum is greater than the absolute value of</span>
<span class="sd">    the maximum, then set the channels to the maximum value.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">a_nanmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">idx2</span><span class="p">])</span>
    <span class="n">a_nanmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">idx2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_nanmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">a_nanmax</span><span class="p">):</span>
        <span class="c1"># emission spectrum</span>
        <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_nanmin</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># absorption spectrum</span>
        <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_nanmax</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replaced </span><span class="si">%d</span><span class="s2"> zeros with </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">a_nanmin</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="plotStatisticalSpectrumFromMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.plotStatisticalSpectrumFromMask">[docs]</a>
<span class="k">def</span> <span class="nf">plotStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointMask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pbcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                    <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                    <span class="n">png</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple wrapper to call computeStatisticalSpectrumFromMask and plot it.</span>
<span class="sd">    jointMask: either a mask image, or an expression with &lt; or &gt; on an mask </span>
<span class="sd">          image</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cube</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find cube&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">statistics</span> <span class="o">=</span> <span class="n">statistic</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="n">jointMasks</span> <span class="o">=</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">jointMask</span> <span class="ow">in</span> <span class="n">jointMasks</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jointMask</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">jointMask</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jointMask</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find jointmask&quot;</span><span class="p">)</span>
                <span class="k">return</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">statistic</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">statistics</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jointMasks</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">jointMask</span> <span class="o">=</span> <span class="n">jointMasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">jointMask</span> <span class="o">=</span> <span class="n">jointMasks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">jointMaskForNormalize</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">myJointMaskForNormalize</span> <span class="o">=</span> <span class="n">jointMask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">myJointMaskForNormalize</span> <span class="o">=</span> <span class="n">jointMaskForNormalize</span>
        <span class="n">channels</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">normalized</span> <span class="o">=</span> <span class="n">computeStatisticalSpectrumFromMask</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">jointMask</span><span class="p">,</span> <span class="n">pbcube</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> <span class="n">normalizeByMAD</span><span class="o">=</span><span class="n">normalizeByMAD</span><span class="p">,</span> <span class="n">jointMaskForNormalize</span><span class="o">=</span><span class="n">myJointMaskForNormalize</span><span class="p">,</span> <span class="n">subimage</span><span class="o">=</span><span class="n">subimage</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span><span class="n">intensity</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">statistic</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;peak over MAD = &quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span><span class="o">/</span><span class="n">MAD</span><span class="p">(</span><span class="n">intensity</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">cube</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">jointMask</span><span class="p">)]))</span>
    <span class="k">if</span> <span class="n">png</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">png</span> <span class="o">=</span> <span class="n">cube</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">jointMask</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">statistic</span> <span class="o">+</span> <span class="s1">&#39;.png&#39;</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">png</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Wrote &quot;</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>

    
<div class="viewcode-block" id="pruneMask">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.pruneMask">[docs]</a>
<span class="k">def</span> <span class="nf">pruneMask</span><span class="p">(</span><span class="n">mymask</span><span class="p">,</span> <span class="n">psfcube</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">prunesize</span><span class="o">=</span><span class="mf">6.0</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
              <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">pbmom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    available in CASA &gt;= 5.4.0-X  (see CAS-11335)</span>
<span class="sd">    Removes any regions smaller than prunesize contiguous pixels.</span>
<span class="sd">    psfcube: if specified, then use minbeamfrac * pixelsPerBeam, otherwise use prunesize</span>
<span class="sd">    prunesize: value used if psfcube is None; use 6 because pipeline size mitigation could</span>
<span class="sd">        produce images that have only 3 pixels across the beam, meaning only ~7-8 pts/beam</span>
<span class="sd">    nchan: number of channels to process, will always be 1 in findContinuum&#39;s use case</span>
<span class="sd">    overwrite: if True, replaces mymask with pruned mask, putting original in mymask.prepruned</span>
<span class="sd">               if False, is simply creates: mymask.pruned, but only if it pruned anything</span>
<span class="sd">    If all regions are pruned, it checks if it is ACA7m (maxBaseline &lt; 60m) and if so, tries</span>
<span class="sd">    again with minbeamfrac*0.5.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">npruned</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mymask</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not find mask image&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npruned</span>
    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Pruning the joint mask&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">psfcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">myinfo</span> <span class="o">=</span> <span class="n">getImageInfo</span><span class="p">(</span><span class="n">psfcube</span><span class="p">)</span>
        <span class="c1"># np.log(2) standard factor for solid angle was not in Cycles0..7</span>
<span class="c1">#        pixelsPerBeam = myinfo[0]*myinfo[1]*np.pi/(4.*np.log(2))/np.abs(myinfo[3]*myinfo[4])</span>
        <span class="n">pixelsPerBeam</span> <span class="o">=</span> <span class="n">myinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">myinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">4.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">myinfo</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">myinfo</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">maxBaseline</span> <span class="o">=</span> <span class="n">myinfo</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="c1"># in meters</span>
        <span class="n">prunesize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">pixelsPerBeam</span><span class="o">*</span><span class="n">minbeamfrac</span><span class="p">)])</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Beam = </span><span class="si">%.3f</span><span class="s1">x</span><span class="si">%.3f</span><span class="s1">, pixels per beam = </span><span class="si">%.2f</span><span class="s1">, using prunesize = </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">myinfo</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">myinfo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">pixelsPerBeam</span><span class="p">,</span> <span class="n">prunesize</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">maskhandler</span> <span class="o">=</span> <span class="n">synthesismaskhandler</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;This casa does not contain the tool synthesismaskhandler(), so the joint mask cannot be pruned.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npruned</span>
    <span class="n">chanflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mymask</span> <span class="o">=</span> <span class="n">mymask</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="n">maskhandler</span><span class="o">.</span><span class="n">pruneregions</span><span class="p">(</span><span class="n">mymask</span><span class="p">,</span> <span class="n">prunesize</span><span class="p">,</span> <span class="n">chanflag</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;pruneregions failed, skipping the prune step&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">npruned</span>
    <span class="n">npruned</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;N_reg_pruned&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">newmask</span> <span class="o">=</span> <span class="n">mymask</span> <span class="o">+</span> <span class="s1">&#39;.pruned&#39;</span>
    <span class="k">if</span> <span class="n">npruned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Pruned </span><span class="si">%d</span><span class="s1"> regions.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npruned</span><span class="p">))</span>
        <span class="n">remainingPixels</span> <span class="o">=</span> <span class="n">countPixelsAboveZero</span><span class="p">(</span><span class="n">newmask</span><span class="p">,</span> <span class="n">pbmom</span><span class="p">)</span>
        <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;Remaining pixels = </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">remainingPixels</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">remainingPixels</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">psfcube</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Everything got pruned away, so check if ACA and reduce minbeamfrac by factor of 2</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;All regions were pruned.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">maxBaseline</span> <span class="o">&lt;=</span> <span class="n">ACA_MAX_BASELINE</span><span class="p">:</span>
                <span class="n">newprunesize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">pixelsPerBeam</span><span class="o">*</span><span class="n">minbeamfrac</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)])</span>
                <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;New prunesize = </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npruned</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">prunesize</span> <span class="o">!=</span> <span class="n">newprunesize</span><span class="p">:</span>
                    <span class="n">casalogPost</span><span class="p">(</span><span class="s1">&#39;All regions pruned and this looks like a 7m image (maxBaseline ~ </span><span class="si">%.0f</span><span class="s1">m), so setting new prunesize=</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxBaseline</span><span class="p">,</span><span class="n">newprunesize</span><span class="p">))</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">newmask</span><span class="p">)</span>
                    <span class="n">mydict</span> <span class="o">=</span> <span class="n">maskhandler</span><span class="o">.</span><span class="n">pruneregions</span><span class="p">(</span><span class="n">mymask</span><span class="p">,</span> <span class="n">newprunesize</span><span class="p">,</span> <span class="n">chanflag</span><span class="p">)</span>
                    <span class="n">npruned</span> <span class="o">=</span> <span class="n">mydict</span><span class="p">[</span><span class="s1">&#39;N_reg_pruned&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maskhandler</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">npruned</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">removeIfNecessary</span><span class="p">(</span><span class="n">mymask</span><span class="o">+</span><span class="s1">&#39;.prepruned&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">mymask</span><span class="p">,</span> <span class="n">mymask</span><span class="o">+</span><span class="s1">&#39;.prepruned&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">newmask</span><span class="p">,</span> <span class="n">mymask</span><span class="p">)</span>
            <span class="n">casalogPost</span><span class="p">(</span><span class="s2">&quot;Updated joint mask after pruning </span><span class="si">%d</span><span class="s2"> region(s)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npruned</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Remove newly-created file because it is identical to original</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">newmask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pruned </span><span class="si">%d</span><span class="s2"> regions&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">npruned</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">npruned</span></div>


<div class="viewcode-block" id="sortRangesByMax">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.sortRangesByMax">[docs]</a>
<span class="k">def</span> <span class="nf">sortRangesByMax</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">selection</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs imstat on each individual channel range of a selection string, sorts the</span>
<span class="sd">    result by &#39;max&#39; and returns a sorted list of tuples: [&#39;maxpos&#39;, &#39;max&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
    <span class="n">statsval</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">chans</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
        <span class="n">statsval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">imstat</span><span class="p">(</span><span class="n">cube</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="n">box</span><span class="p">))</span>
    <span class="n">sortedStats</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">statsval</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sortedStats</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;maxpos&#39;</span><span class="p">],</span><span class="n">stat</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%.4f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%4d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;maxpos&#39;</span><span class="p">]]),</span> <span class="n">stat</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="plotSigmaCorrectionFactor">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.plotSigmaCorrectionFactor">[docs]</a>
<span class="k">def</span> <span class="nf">plotSigmaCorrectionFactor</span><span class="p">(</span><span class="n">percentile</span><span class="o">=</span><span class="mi">19</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a plot of sigmaCorrectionFactor for the principle options</span>
<span class="sd">    for number of channels in an ALMA cube</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nchans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">240</span><span class="p">,</span><span class="mi">356</span><span class="p">,</span><span class="mi">480</span><span class="p">,</span><span class="mi">512</span><span class="p">,</span><span class="mi">960</span><span class="p">,</span><span class="mi">1024</span><span class="p">,</span><span class="mi">1920</span><span class="p">,</span><span class="mi">2048</span><span class="p">,</span><span class="mi">3840</span><span class="p">,</span><span class="mi">4096</span><span class="p">,</span><span class="mi">7680</span><span class="p">,</span><span class="mi">8192</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">nchan</span> <span class="ow">in</span> <span class="n">nchans</span><span class="p">:</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigmaCorrectionFactor</span><span class="p">(</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">percentile</span><span class="p">))</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nchans</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="n">nchans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">2.8</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="mf">128.</span><span class="p">)</span><span class="o">**</span><span class="mf">0.08</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.9</span><span class="p">)</span><span class="o">**-</span><span class="mf">0.25</span><span class="p">)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;k-&#39;</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">8300</span><span class="p">])</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channels in spw&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sigma correction factor&#39;</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="n">pl</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;sigmaCorrectionFactor.png&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="countMaskedPixels">
<a class="viewcode-back" href="../../../_apidoc/pipeline.extern.html#pipeline.extern.findContinuum.countMaskedPixels">[docs]</a>
<span class="k">def</span> <span class="nf">countMaskedPixels</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The mask internal to an image will have a value of False where masked, </span>
<span class="sd">    and True where not masked.</span>
<span class="sd">    To count non-zero pixels in a clean 1/0 mask, use au.nonzeroPixels.</span>
<span class="sd">    axes: set to [0,1,2] to get a per-channel count (only works for useImstat)</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">myia</span> <span class="o">=</span> <span class="n">iatool</span><span class="p">()</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">maskdata</span> <span class="o">=</span> <span class="n">myia</span><span class="o">.</span><span class="n">getregion</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">myia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">maskdata</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">maskedPixels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">maskdata</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> pixels (</span><span class="si">%f%%</span><span class="s2">) are masked&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">maskedPixels</span><span class="p">,</span><span class="n">pixels</span><span class="p">,</span><span class="mf">100.</span><span class="o">*</span><span class="n">maskedPixels</span><span class="o">/</span><span class="n">pixels</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">maskedPixels</span></div>

    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>