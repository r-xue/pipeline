

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.extern.SDcalatmcorr &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.extern.SDcalatmcorr</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.extern.SDcalatmcorr</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># [SCRIPT INFORMATION]</span>
<span class="c1"># GIT REPO: https://bitbucket.alma.cl/scm/~harold.francke/sd-atm-line-correction-prototype.git</span>
<span class="c1"># COMMIT: d563bd9cd29</span>
<span class="c1">#</span>
<span class="c1">#SDcalatmcorr: Casapipescript with wrapper for TS script &quot;atmcorr.py&quot; for the removal</span>
<span class="c1">#of atmospheric line residuals.</span>
<span class="c1">#2020 - T.Sawada, H. Francke</span>

<span class="c1"># 08/apr/2022: - (v2.6) Change logic of best model evaluation to be done inside the atmcor() method.</span>
<span class="c1">#              - Created a function makePlot() to clean up the plot generation par of the code.</span>
<span class="c1">#                This function added a label with Applied/Discarded to point out the used model.</span>
<span class="c1">#                Additionally, the atmospheric transmission was added to the plot, and the channels</span>
<span class="c1">#                selected for metric measurement.</span>
<span class="c1"># 31/mar/2022: - (v2.5) Added feature to automatically select representative science target for metric</span>
<span class="c1">#                measurements.</span>
<span class="c1">#              - Fixed issue with range of atmospheric line range selection.</span>
<span class="c1"># 25/feb/2022: - (v2.4) Added feature to automatically select least flagged antenna for doing the metric measurement.</span>
<span class="c1">#              - Changed default parameters to consider atmtype 1,2,3,4 only for models testing.</span>
<span class="c1">#              - Remove remaining dependencies on analysisUtils</span>
<span class="c1">#              - Cleaned up procedure to handle default model fallback case, including the return of </span>
<span class="c1">#                a &#39;fitstatus&#39; variable decribing whether a best fit or a fallback to default model happened.</span>
<span class="c1"># 27/jan/2022: - (v2.3) Fixed bug that made script crash with multiples EBs getting different</span>
<span class="c1">#                SPW selection with multiple ATM selected for model testing</span>
<span class="c1"># 25/jan/2022: - (v2.2) Added catch for case when skyline get fully confused with science line and script</span>
<span class="c1">#                ends with no data for model fit</span>
<span class="c1">#              - Changed Science target channel detection to previous version (selsource() task)</span>
<span class="c1">#              - Added EB uid to plots</span>
<span class="c1"># 24/jan/2021: - (v2.1) Fixed issue with spwstoprocess variable with smoothing</span>
<span class="c1"># 21/jan/2022: - (v2.0) Fixed several bugs, including handling crashes with fully flagged data pieces</span>
<span class="c1">#              - Handles cases where no result is possible when no significant skyline is present, to return default model</span>
<span class="c1">#              - Support for using multiple skylines for metric calculation</span>
<span class="c1">#              - Added plots for absolute value of derivative, to better assess &quot;*diff&quot; metrics</span>
<span class="c1">#              - Added ability to smooth derivative data to reduce noise</span>
<span class="c1">#              - Improved skyline range detection from model tau</span>
<span class="c1"># 15/dec/2021: - Converted to Python 3/CASA 6 (NOT COMPATIBLE WITH CASA&lt;6 ANYMORE!)</span>
<span class="c1">#              - Removed atmospheric correction calculation routine inherited from Sawada san&#39;s script and replaced</span>
<span class="c1">#                it by one mstransform and several sdatmcor call, in order to calculate the corrected data</span>
<span class="c1">#              - Added metrics &#39;intabsdiff&#39; (integral of absolute value of derivative) and</span>
<span class="c1">#                &#39;intsqdiff&#39; (integral of square value of derivative).</span>
<span class="c1">#              - Improved statistical estimation of data errors </span>
<span class="c1">#              - Changed data normalization routine and science emission detection.</span>
<span class="c1">#              - Uploaded to ALMA Bitbucket</span>
<span class="c1"># 03/mar/2021: - Fixed bug handling datasets having TDM SPWs</span>
<span class="c1">#              - Fixed metric calculation and plotting problem that got model data stuck in non-corrected data</span>
<span class="c1">#              - Rearranged code to move atmcorr core routine to separate function and moved auxiliary spectral setup data</span>
<span class="c1">#                into the &quot;spwsetup&quot; dictionary.</span>
<span class="c1"># 08/jan/2021: - Added functionality to run atmcorr routine in &quot;try&quot; mode and extract three different</span>
<span class="c1">#                metrics for a family of model parameters.</span>
<span class="c1"># 24/jul/2020: - Aligned with script atmcorr_20200722.py</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">path</span>

<span class="c1">#This is in order to be able to use cx_Oracle. Please set path to the correct</span>
<span class="c1">#folder in your system. If the cx_Oracle library is not available,</span>
<span class="c1">#set the variable accessarchive to False</span>
<span class="n">accessarchive</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">accessarchive</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/usr/lib/oracle/12.2/client64/lib:/opt/casa/packages/RHEL7/release/casa-6.2.1-7-pipeline-2021.2.0.128/lib&#39;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/lib64/python36.zip&#39;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/lib64/python3.6&#39;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/lib64/python3.6/lib-dynload&#39;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/local/lib64/python3.6/site-packages&#39;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/lib64/python3.6/site-packages&#39;</span><span class="p">)</span>
    <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/usr/lib/python3.6/site-packages&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">cx_Oracle</span> <span class="kn">import</span> <span class="n">connect</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pylab</span> <span class="k">as</span> <span class="nn">pl</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">systime</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">CubicSpline</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">msmetadata</span> <span class="k">as</span> <span class="n">msmdtool</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">table</span> <span class="k">as</span> <span class="n">tbtool</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">quanta</span> <span class="k">as</span> <span class="n">qatool</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">atmosphere</span> <span class="k">as</span> <span class="n">attool</span>
<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">agentflagger</span> <span class="k">as</span> <span class="n">aftool</span>
<span class="kn">from</span> <span class="nn">casaplotms</span> <span class="kn">import</span> <span class="n">plotms</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">sdatmcor</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">mstransform</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure.callibrary</span> <span class="k">as</span> <span class="nn">callibrary</span>
<span class="n">pipelineloaded</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># try:</span>
<span class="c1">#     from pipeline.h.cli import h_init</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_importdata</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_flagdata</span>
<span class="c1">#     from pipeline.h.cli import h_tsyscal</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_tsysflag</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_skycal</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_k2jycal</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_applycal</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_atmcor</span>
<span class="c1">#     from pipeline.h.cli import h_resume</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_baseline</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_blflag</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_imaging</span>
<span class="c1">#     from pipeline.hsd.cli import hsd_exportdata</span>
<span class="c1">#     from pipeline.h.cli import h_save</span>
<span class="c1">#     import pipeline.infrastructure.callibrary as callibrary</span>
<span class="c1">#     pipelineloaded = True</span>
<span class="c1"># except ImportError:</span>
<span class="c1">#     print(&#39;Could not load pipeline tasks! Please run CASA with --pipeline option.&#39;)</span>
<span class="c1">#     print(&#39;You will not be able to run the redPipeSDatmcorr() task.&#39;)</span>
<span class="c1">#     pipelineloaded = False</span>

<span class="c1">#Useful function for fully flattening array</span>
<span class="n">flattenlist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">l</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>

<span class="c1">#ALMA Oracle DB authetication</span>
<span class="n">almaoracleauth</span> <span class="o">=</span> <span class="s1">&#39;almasu/alma4dba@ora.sco.alma.cl:1521/ALMA.SCO.CL&#39;</span>

<div class="viewcode-block" id="createCasaTool">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.createCasaTool.html#pipeline.extern.SDcalatmcorr.createCasaTool">[docs]</a>
<span class="k">def</span> <span class="nf">createCasaTool</span><span class="p">(</span><span class="n">mytool</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper to handle the changing ways in which casa tools are invoked.</span>
<span class="sd">    For CASA &lt; 6, it relies on &quot;from taskinit import *&quot; in the preamble above.</span>
<span class="sd">    mytool: a tool name, like tbtool</span>
<span class="sd">    Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;casac&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">casac</span><span class="o">.</span><span class="n">Quantity</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">):</span>  <span class="c1"># casa 4.x and 5.x</span>
            <span class="n">myt</span> <span class="o">=</span> <span class="n">mytool</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># casa 3.x</span>
            <span class="n">myt</span> <span class="o">=</span> <span class="n">mytool</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this is CASA 6</span>
        <span class="n">myt</span> <span class="o">=</span> <span class="n">mytool</span><span class="p">()</span>
    <span class="k">return</span><span class="p">(</span><span class="n">myt</span><span class="p">)</span></div>


<div class="viewcode-block" id="robuststats">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.robuststats.html#pipeline.extern.SDcalatmcorr.robuststats">[docs]</a>
<span class="k">def</span> <span class="nf">robuststats</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return median and estimate standard deviation</span>
<span class="sd">    of numpy array A using median statistics.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#correction factor for obtaining sigma from MAD</span>
    <span class="n">madfactor</span> <span class="o">=</span> <span class="mf">1.482602218505602</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1">#Fitting parameters for sample size correction factor b(n)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">%</span><span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.32</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">1.32</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.9</span>
    <span class="n">bn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">bn</span><span class="p">)</span><span class="o">*</span><span class="n">madfactor</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">mu</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span></div>


<div class="viewcode-block" id="binnedstats">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.binnedstats.html#pipeline.extern.SDcalatmcorr.binnedstats">[docs]</a>
<span class="k">def</span> <span class="nf">binnedstats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">Aerr</span><span class="p">,</span> <span class="n">nbins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return a tuple of arrays (of size nbins) of median and sigmas </span>
<span class="sd">    calculated from robuststats() from chopping the array A in nbins pieces.</span>
<span class="sd">    Alternatively, bins can be explicitly be given with the bins parameter in the form:</span>
<span class="sd">    bins = [[x0, x1], [x2, x3], ...]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">binsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">nbins</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbins</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">bins</span>
    <span class="k">elif</span> <span class="p">((</span><span class="n">nbins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">==</span> <span class="kc">None</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">nbins</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Either set nbins=(integer) or give bins as a partition of channels!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">npart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">xbin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="n">mederr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="n">chi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="n">mskfrac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npart</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npart</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">nsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="n">xbin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">sel</span><span class="p">])</span>
        <span class="n">thisA</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">sel</span><span class="p">]</span>
        <span class="n">thisAerr</span> <span class="o">=</span> <span class="n">Aerr</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]][</span><span class="n">sel</span><span class="p">]</span>
        <span class="p">(</span><span class="n">thismu</span><span class="p">,</span> <span class="n">thissigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">thisA</span><span class="p">)</span>
        <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thismu</span>
        <span class="n">sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thissigma</span>
        <span class="p">(</span><span class="n">thismederr</span><span class="p">,</span> <span class="n">thiserrsigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">thisAerr</span><span class="p">)</span>
        <span class="n">mederr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">thismederr</span>
        <span class="n">chi2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">thisA</span> <span class="o">-</span> <span class="n">thismu</span><span class="p">)</span><span class="o">/</span><span class="n">thisAerr</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">nsel</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">mskfrac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span><span class="o">/</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">xbin</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">mederr</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">mskfrac</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>


<div class="viewcode-block" id="fitbaseline">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.fitbaseline.html#pipeline.extern.SDcalatmcorr.fitbaseline">[docs]</a>
<span class="k">def</span> <span class="nf">fitbaseline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">initialbins</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">detectionsigma</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
                <span class="n">minbinfracsize</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">targetchi2</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">maxoutlierfrac</span> <span class="o">=</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="n">outlierprobmu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">outlierprobsigma</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">bordertokeep</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Fit baseline to function y(x) (having error dy(x)).</span>
<span class="sd">    Starts partitioning domain in &#39;initialbins&#39; and the subdividing bins up to </span>
<span class="sd">    a fractional size &#39;minbinfracsize&#39; of the total number of channels.</span>
<span class="sd">    Returns PPoly instance with fit.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Initialize values for start</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">spwrange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">outliermu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">outlierprobmu</span><span class="o">*</span><span class="n">spwrange</span>
    <span class="n">outliersig</span> <span class="o">=</span> <span class="n">outlierprobsigma</span><span class="o">*</span><span class="n">spwrange</span>
    <span class="n">outlierprob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">outliermu</span><span class="p">)</span><span class="o">/</span><span class="n">outliersig</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitbaseline: len(x): &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; y.mask:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; dy.mask:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dy</span><span class="o">.</span><span class="n">mask</span><span class="p">)))</span>
    <span class="c1">#If initialbins &lt;2, that&#39;s too few, we need two points at least</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initialbins</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">minbinfracsize</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;initialbins cannot be less than 2!!! setting it to 2...&#39;</span><span class="p">)</span>
        <span class="n">initialbins</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">minbinfracsize</span> <span class="o">=</span> <span class="mf">0.45</span>
    <span class="c1">#Setting minimum bin size</span>
    <span class="n">minbinsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">minbinfracsize</span><span class="p">))</span>
    <span class="c1">#If initial number of bins is not consistent with minbinfracsize, augment</span>
    <span class="c1">#minbinsize to match it, but complain about it</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initialbins</span><span class="o">*</span><span class="n">minbinsize</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">minbinsize</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimal bin size and initial number of bins inconsistent!&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;setting minimal bin size to nchans/initialbins - 1...&#39;</span><span class="p">)</span>
        <span class="n">minbinsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">initialbins</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">minbinsize</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimal bin size &lt; 20 channels! setting it to 20 to avoid noisy statistics...&#39;</span><span class="p">)</span>
        <span class="n">minbinsize</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1">#Calculate border to keep</span>
    <span class="n">bordermin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bordertokeep</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    <span class="n">bordermax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">bordertokeep</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>

    <span class="c1">#Put value just to start</span>
    <span class="n">repchi2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">targetchi2</span>
    <span class="n">rerun</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1">#Initial stats per bin</span>
    <span class="n">binsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">n</span><span class="o">/</span><span class="n">initialbins</span><span class="p">))</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span> <span class="nb">min</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binsize</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initialbins</span><span class="p">)]</span>

    <span class="c1">#Loop while representative chi2 has not reached goal while</span>
    <span class="c1">#the minimum bin size has not shrunk below minimum allowed size</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">repchi2</span> <span class="o">&gt;</span> <span class="n">targetchi2</span><span class="p">):</span>
        <span class="c1">#Bin data according to partition p</span>
        <span class="p">(</span><span class="n">xbin</span><span class="p">,</span> <span class="n">ybin</span><span class="p">,</span> <span class="n">dybin</span><span class="p">,</span> <span class="n">meddybin</span><span class="p">,</span> <span class="n">chi2binaux</span><span class="p">,</span> <span class="n">mskfracbin</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">binnedstats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">p</span><span class="p">)</span>
        <span class="c1">#Check is there are bin with no valid results</span>
        <span class="n">allvalid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">xbin</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ybin</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nbins: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xbin</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; allvalid: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allvalid</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39; y.mask: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">mask</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;xbins: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">xbin</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">allvalid</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allvalid</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allvalid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="c1">#If we still have at least two datapoints, leave the nan&#39;s outside and continue</span>
            <span class="n">xbin</span> <span class="o">=</span> <span class="n">xbin</span><span class="p">[</span><span class="n">allvalid</span><span class="p">]</span>
            <span class="n">ybin</span> <span class="o">=</span> <span class="n">ybin</span><span class="p">[</span><span class="n">allvalid</span><span class="p">]</span>
            <span class="n">dybin</span> <span class="o">=</span> <span class="n">dybin</span><span class="p">[</span><span class="n">allvalid</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">allvalid</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not converge to fit!!!&#39;</span><span class="p">)</span>
            <span class="n">blfit</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="c1">#Calculate the residuals of the baseline fit and bin them</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
            <span class="n">chi2bin</span> <span class="o">=</span> <span class="n">chi2binaux</span>
            <span class="k">break</span>
        <span class="c1">#Calculate baseline fit</span>
        <span class="n">orderbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">xbin</span><span class="p">)</span>
        <span class="n">blfit</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">xbin</span><span class="p">[</span><span class="n">orderbins</span><span class="p">],</span> <span class="n">ybin</span><span class="p">[</span><span class="n">orderbins</span><span class="p">],</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;not-a-knot&#39;</span><span class="p">)</span>
        <span class="c1">#Calculate the residuals of the baseline fit and bin them</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">blfit</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="c1">#Calculate the median residual per bin</span>
        <span class="p">(</span><span class="n">xaux</span><span class="p">,</span> <span class="n">resbin</span><span class="p">,</span> <span class="n">dresbin</span><span class="p">,</span> <span class="n">mederrbin</span><span class="p">,</span> <span class="n">chi2bin</span><span class="p">,</span> <span class="n">mskfracres</span><span class="p">,</span> <span class="n">paux</span><span class="p">)</span> <span class="o">=</span> <span class="n">binnedstats</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">p</span><span class="p">)</span>
        <span class="c1">#Revise stats per bin and split them if residuals are too high</span>
        <span class="n">binsplitidx</span> <span class="o">=</span> <span class="n">chi2bin</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">chi2bin</span> <span class="o">&gt;</span> <span class="n">targetchi2</span><span class="p">,</span> <span class="n">mskfracres</span> <span class="o">&gt;</span> <span class="n">maxoutlierfrac</span><span class="p">])</span>
        <span class="n">bin2split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">binsplitidx</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#Save chi2 of bin with highest chi2</span>
        <span class="n">repchi2</span> <span class="o">=</span> <span class="n">chi2bin</span><span class="p">[</span><span class="n">bin2split</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;chi2bin=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chi2bin</span><span class="p">))</span>
        <span class="c1">#If chi^2 is too big, and bin is wide enough, split it.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">binsplitidx</span><span class="p">[</span><span class="n">bin2split</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">minbinsize</span><span class="p">):</span>
            <span class="n">midval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">1</span><span class="p">])))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">bin2split</span><span class="p">)]</span> <span class="o">+</span> \
                <span class="p">[[</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">midval</span><span class="p">],</span> <span class="p">[</span><span class="n">midval</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">1</span><span class="p">]]]</span> <span class="o">+</span> \
                <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bin2split</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">))]</span>
        <span class="c1">#If chi^2 is too big, but bin size has become too small, remove segment (unless it&#39;s in the border we keep)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binsplitidx</span><span class="p">[</span><span class="n">bin2split</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">minbinsize</span><span class="p">)</span> <span class="ow">and</span> \
             <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bordermin</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bordermax</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;p[bin2split]=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">]))</span>
            <span class="n">p</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">bin2split</span><span class="p">])</span>
        <span class="c1">#If there are no bins with chi^2 larger than target, stop here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1">#Detect outliers</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">res</span><span class="o">*</span><span class="n">outlierprob</span> <span class="o">&lt;</span> <span class="n">detectionsigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="n">res</span><span class="o">*</span><span class="n">outlierprob</span> <span class="o">&gt;</span> <span class="n">detectionsigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;blfit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">blfit</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;xbin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xbin</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;ybin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ybin</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;dybin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dybin</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;chi2bin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chi2bin</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;outliers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="segmentEdges">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.segmentEdges.html#pipeline.extern.SDcalatmcorr.segmentEdges">[docs]</a>
<span class="k">def</span> <span class="nf">segmentEdges</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">sortdata</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return edges of sequence of values with gaps</span>
<span class="sd">    Assumes 1D array &quot;seq&quot; is ordered. Otherwise one should sort it first.</span>
<span class="sd">    seq: Sequence of values to search gaps in.</span>
<span class="sd">    gap: Gap size to consider.</span>
<span class="sd">    label: Label to put in the numpy array returned.</span>
<span class="sd">    sortdata: Whether to sort data in the seq vector.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">sortdata</span><span class="p">:</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Array is not sorted, use sortdata = True&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">isgap</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="n">gap</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">isgap</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startseg</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">True</span><span class="p">],</span><span class="n">isgap</span><span class="p">)]</span>
        <span class="n">endseg</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">isgap</span><span class="p">,[</span><span class="kc">True</span><span class="p">])]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">startseg</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">enseg</span> <span class="o">=</span> <span class="n">seq</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">startseg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">endseg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">startseg</span><span class="p">))],</span><span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;tstart&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;tend&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;intent&#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">,</span><span class="mi">40</span><span class="p">)]))</span></div>


<div class="viewcode-block" id="selectRanges">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.selectRanges.html#pipeline.extern.SDcalatmcorr.selectRanges">[docs]</a>
<span class="k">def</span> <span class="nf">selectRanges</span><span class="p">(</span><span class="n">timeseq</span><span class="p">,</span> <span class="n">rangetable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return selection boolean array for a time sequence, given a table of time ranges.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nranges</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rangetable</span><span class="p">)</span>
    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">timeseq</span><span class="p">)</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nranges</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">timeseq</span> <span class="o">&gt;=</span> <span class="n">rangetable</span><span class="p">[</span><span class="s1">&#39;tstart&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">timeseq</span> <span class="o">&lt;=</span> <span class="n">rangetable</span><span class="p">[</span><span class="s1">&#39;tend&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sel</span></div>




<div class="viewcode-block" id="sigclipfit">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.sigclipfit.html#pipeline.extern.SDcalatmcorr.sigclipfit">[docs]</a>
<span class="k">def</span> <span class="nf">sigclipfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">Asig</span><span class="p">,</span> <span class="n">fitdeg</span><span class="p">,</span> <span class="n">nclips</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">,</span> <span class="n">bordertokeep</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">progdegree</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">smoothselbox</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Return polynomial model parameters done to vector A and residuals from the fit.</span>
<span class="sd">    x: x coordinate</span>
<span class="sd">    A: Data set vector.</span>
<span class="sd">    Asig: Data sigma vector. Should include variance due to skylines and science target emission.</span>
<span class="sd">    fitdeg: Fitting polynomial degree.</span>
<span class="sd">    nclips: Number of sigma clipping iterations.</span>
<span class="sd">    nsigma: Number of sigmas in sigma clipping iterations. Positive float or two-value tuple.</span>
<span class="sd">    bordertokeep: Fraction of channels to keep in the borders</span>
<span class="sd">    progdegree: Whether to increase polynomial fit progressively in each iteration.</span>
<span class="sd">    smoothselbox: Enlarge each outlier detection with a box of this size (as fraction of SPW).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nsigma</span><span class="p">)</span> <span class="o">==</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">nsigmahigh</span> <span class="o">=</span> <span class="n">nsigma</span>
        <span class="n">nsigmalow</span> <span class="o">=</span> <span class="n">nsigma</span>
    <span class="k">elif</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">nsigma</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">nsigma</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nsigma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">nsigmahigh</span> <span class="o">=</span> <span class="n">nsigma</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nsigmalow</span> <span class="o">=</span> <span class="n">nsigma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gooddata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)),</span> <span class="n">mask</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1">#Start data selection with all good data</span>
    <span class="n">sel</span> <span class="o">=</span> <span class="n">gooddata</span>
    <span class="n">minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">bordermin</span> <span class="o">=</span> <span class="n">minx</span> <span class="o">+</span> <span class="n">bordertokeep</span><span class="o">*</span><span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>
    <span class="n">bordermax</span> <span class="o">=</span> <span class="n">maxx</span> <span class="o">-</span> <span class="n">bordertokeep</span><span class="o">*</span><span class="p">(</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">minx</span><span class="p">)</span>
    <span class="c1">#Set border selection, avoiding any bad data</span>
    <span class="n">border</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">bordermin</span><span class="p">,</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">bordermax</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">gooddata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">progdegree</span><span class="p">:</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">degree</span> <span class="o">=</span> <span class="n">fitdeg</span>
    <span class="k">if</span> <span class="n">smoothselbox</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">smoothselbox</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">degree</span> <span class="o">&lt;=</span> <span class="n">fitdeg</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nclips</span><span class="p">):</span>
            <span class="c1">#Include constant border, if demanded</span>
            <span class="n">thissel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">sel</span><span class="p">,</span> <span class="n">border</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#If everything is flagged, continue with a default selection of everything</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">A</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">thissel</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">fitdeg</span><span class="p">:</span>
                <span class="n">thissel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">gooddata</span><span class="p">,</span> <span class="n">border</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">thissel</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">thissel</span><span class="p">],</span> <span class="n">fitdeg</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">Asig</span><span class="p">[</span><span class="n">thissel</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">coefs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No data!!!</span><span class="se">\n</span><span class="s1">x=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">thissel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">A=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">thissel</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Asig=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Asig</span><span class="p">[</span><span class="n">thissel</span><span class="p">]))</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">coefs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">degree</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">A</span> <span class="o">-</span> <span class="n">model</span>
            <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            <span class="c1">#Select pixels to use in the next iteration from pixels within nsigma of mean</span>
            <span class="c1">#including only non-masked data, but not in the border.</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">([((</span><span class="n">diff</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="n">nsigmalow</span><span class="p">),</span> <span class="p">((</span><span class="n">diff</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span> <span class="o">&lt;=</span> <span class="n">nsigmahigh</span><span class="p">),</span> <span class="n">gooddata</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#If boxcar smoothing of selection is chosen (smoothselbox &gt; 0), broadening non-selected pixels</span>
            <span class="k">if</span> <span class="n">box</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">enlargesel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">sel</span><span class="p">),</span> <span class="n">box</span><span class="p">))</span>
        <span class="n">degree</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;coefs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">coefs</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;residuals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;sel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;border&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">border</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="enlargesel">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.enlargesel.html#pipeline.extern.SDcalatmcorr.enlargesel">[docs]</a>
<span class="k">def</span> <span class="nf">enlargesel</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Enlarge selection by &quot;box&quot; pixels around each selected pixel</span>
<span class="sd">    in &quot;sel&quot; vector. </span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
    <span class="n">newsel</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">sel</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">startrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">box</span><span class="p">)</span>
        <span class="n">endrange</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">box</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">newsel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">sel</span><span class="p">[</span><span class="n">startrange</span><span class="p">:</span><span class="n">endrange</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">newsel</span></div>


<div class="viewcode-block" id="smooth">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.smooth.html#pipeline.extern.SDcalatmcorr.smooth">[docs]</a>
<span class="k">def</span> <span class="nf">smooth</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box_pts</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Smooth using boxcar convolution.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">box_pts</span><span class="p">)</span><span class="o">/</span><span class="n">box_pts</span>
    <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y_smooth</span></div>


<div class="viewcode-block" id="noisenormdata">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.noisenormdata.html#pipeline.extern.SDcalatmcorr.noisenormdata">[docs]</a>
<span class="k">def</span> <span class="nf">noisenormdata</span><span class="p">(</span><span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm</span><span class="p">,</span> <span class="n">antatm</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Compute a noise-normalized data for source selection. To be used by selsource() function.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">npol</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataon</span><span class="p">)</span>
    <span class="n">npolatm</span><span class="p">,</span> <span class="n">nchatm</span><span class="p">,</span> <span class="n">nlinesatm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tsys</span><span class="p">)</span>
    <span class="n">nant</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">antson</span><span class="p">))</span>
    <span class="n">natm</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">nlinesatm</span><span class="o">/</span><span class="n">nant</span><span class="p">)</span>
    <span class="c1">#Get skylines, if any</span>
    <span class="c1">#skylines = getskylines(tau, fraclevel = 0.5)</span>
    <span class="c1">#skymask = skysel(skylines, avoidpeak = 0.0)</span>
    <span class="c1">#Smooth Trx</span>
    <span class="n">smbox</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.01</span><span class="o">*</span><span class="n">nch</span><span class="p">)</span>
    <span class="n">smtrec</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">trec</span>
    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npolatm</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">atmline</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlinesatm</span><span class="p">):</span>
            <span class="n">smtrec</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="n">atmline</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">trec</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="n">atmline</span><span class="p">],</span> <span class="n">smbox</span><span class="p">)</span>
    <span class="c1">#Mask borders</span>
    <span class="n">minmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dataon</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">badborder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">nch</span><span class="p">)</span>
    <span class="n">minmask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">badborder</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">minmask</span><span class="p">[</span><span class="n">nch</span><span class="o">-</span><span class="n">badborder</span><span class="p">:</span><span class="n">nch</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">tmavelist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tmsigmalist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tavenorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">minmask</span><span class="p">)</span>
    <span class="n">tnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">minmask</span><span class="p">)</span>
    <span class="n">normdata</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">dataon</span>
    <span class="n">cx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">atmscan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">natm</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nant</span><span class="p">):</span>
                <span class="c1">#Select data for this pol, ATM scan and antenna</span>
                <span class="n">tstart</span> <span class="o">=</span> <span class="n">tmatm</span><span class="p">[</span><span class="n">atmscan</span><span class="o">*</span><span class="n">nant</span><span class="o">+</span><span class="n">ant</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">atmscan</span> <span class="o">&lt;</span> <span class="n">natm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">tend</span> <span class="o">=</span> <span class="n">tmatm</span><span class="p">[(</span><span class="n">atmscan</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nant</span><span class="o">+</span><span class="n">ant</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tend</span> <span class="o">=</span> <span class="n">tmdataon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">tmdataon</span> <span class="o">&gt;=</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tmdataon</span> <span class="o">&lt;=</span> <span class="n">tend</span><span class="p">,</span> <span class="n">antson</span> <span class="o">==</span> <span class="n">ant</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">nsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">nsel</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1">#Extract piece of data</span>
                    <span class="n">thisdata</span> <span class="o">=</span> <span class="n">dataon</span><span class="p">[</span><span class="n">pol</span><span class="p">,:,</span><span class="n">sel</span><span class="p">]</span>
                    <span class="n">normdata</span><span class="p">[</span><span class="n">pol</span><span class="p">,:,</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">thisdata</span><span class="o">/</span><span class="p">(</span><span class="n">tsys</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="n">atmscan</span><span class="o">*</span><span class="n">nant</span><span class="o">+</span><span class="n">ant</span><span class="p">]</span> <span class="o">-</span> <span class="n">smtrec</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="n">atmscan</span><span class="o">*</span><span class="n">nant</span><span class="o">+</span><span class="n">ant</span><span class="p">])</span>
    <span class="c1">#Renormalize fluctuations</span>
    <span class="c1">#Find median value for each integration and calculate data - median(data)</span>
    <span class="n">medmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">medmedian</span><span class="p">)):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">fqmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">fqmedianzeros</span> <span class="o">=</span> <span class="p">(</span><span class="n">fqmedian</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">fqmedian</span><span class="p">[</span><span class="n">fqmedianzeros</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">renormdata</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">normdata</span>
    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
        <span class="n">renormdata</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">normdata</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nch</span><span class="p">),</span> <span class="n">medmedian</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">/</span><span class="n">fqmedian</span><span class="p">[</span><span class="n">pol</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">renormdata</span></div>


<div class="viewcode-block" id="selsource2">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.selsource2.html#pipeline.extern.SDcalatmcorr.selsource2">[docs]</a>
<span class="k">def</span> <span class="nf">selsource2</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm</span><span class="p">,</span> <span class="n">antatm</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">smoothselbox</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">maxmasked</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
               <span class="n">ndegree</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nclips</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Select science target channels and return boolean vector with selection. Task attempts polynomial</span>
<span class="sd">    fits to a baseline of normalized (to Tsys) noise and detect upwards outliers (variance higher than expected</span>
<span class="sd">    from Tsys level). Final best fit gets determined by chi^2 (including extpenalty factor)</span>
<span class="sd">    Positional params: From MS selection:</span>
<span class="sd">                       nu: (freq. vector of SPW), tmdataon (time vector of dataon data selection),</span>
<span class="sd">                       antson: (vector of antenna column of dataon data selection),</span>
<span class="sd">                       dataon: (masked array of selected data),</span>
<span class="sd">                       Data from CALATMOSPHERE table:</span>
<span class="sd">                       tmatm: (vector of times of sel. rows), antatm (vector of antenna IDs of sel. rows)</span>
<span class="sd">                       tsys: (Tsys table), trec (T Receiver table), tau (optical depth table)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#Initialize variables</span>
    <span class="n">npol</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataon</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">smoothselbox</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">smoothselbox</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">nu</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#Get skylines, if any. Avoid peak of skylines in science target detection</span>
    <span class="n">skylines</span> <span class="o">=</span> <span class="n">getskylines</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">fraclevel</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">skymask</span> <span class="o">=</span> <span class="n">skysel</span><span class="p">(</span><span class="n">skylines</span><span class="p">,</span> <span class="n">avoidpeak</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">noskymask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">skymask</span><span class="p">)</span>
    <span class="c1">#Normalize the standard deviation of the data by Tsys</span>
    <span class="n">normdata</span> <span class="o">=</span> <span class="n">noisenormdata</span><span class="p">(</span><span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm</span><span class="p">,</span> <span class="n">antatm</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">normsigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#If normalized sigma data array is masked more than maxmasked fraction of data, return an empty selection</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">normdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normsigma</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxmasked</span><span class="o">*</span><span class="n">nch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span>
    <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">normsigma</span><span class="p">)</span>
    <span class="n">normsigmasigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">normsigma</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">basenoisefit</span> <span class="o">=</span> <span class="n">sigclipfit</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">normsigma</span><span class="p">,</span> <span class="n">normsigmasigma</span><span class="p">,</span> <span class="n">ndegree</span><span class="p">,</span> <span class="n">nclips</span><span class="p">,</span> <span class="p">(</span><span class="mf">99.0</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">),</span> <span class="n">bordertokeep</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">smoothselbox</span><span class="o">=</span><span class="n">smoothselbox</span><span class="p">)</span>
    <span class="n">blmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">basenoisefit</span><span class="p">[</span><span class="s1">&#39;coefs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="p">(</span><span class="n">ndegree</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndegree</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#Select the outliers as probable science target emission channels</span>
    <span class="n">srcsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">basenoisefit</span><span class="p">[</span><span class="s1">&#39;sel&#39;</span><span class="p">])</span>
    <span class="n">srcsel</span><span class="p">[</span><span class="n">skymask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">finalsrcsel</span> <span class="o">=</span> <span class="p">(</span><span class="n">enlargesel</span><span class="p">(</span><span class="n">srcsel</span><span class="p">,</span> <span class="n">box</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">#basenoisefit = fitbaseline(nu, normsigma, normsigmasigma)</span>
    <span class="c1">#srcsel = (enlargesel(basenoisefit[&#39;outliers&#39;], box) &gt; 0)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">normsigma</span><span class="p">,</span> <span class="s1">&#39;.k&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">blmodel</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">finalsrcsel</span><span class="p">],</span> <span class="n">normsigma</span><span class="p">[</span><span class="n">finalsrcsel</span><span class="p">],</span> <span class="s1">&#39;sr&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [GHz]&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Sigma Amp&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;selsource2_normsigma.png&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">finalsrcsel</span></div>


<div class="viewcode-block" id="selsource">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.selsource.html#pipeline.extern.SDcalatmcorr.selsource">[docs]</a>
<span class="k">def</span> <span class="nf">selsource</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm</span><span class="p">,</span> <span class="n">antatm</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span>
              <span class="n">ndegree</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nclips</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">smoothbox</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span> <span class="n">extpenalty</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">maxmasked</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Select science target channels and return boolean vector with selection. Task attempts polynomial</span>
<span class="sd">    fits to a baseline of normalized (to Tsys) noise and detect upwards outliers (variance higher than expected</span>
<span class="sd">    from Tsys level). Final best fit gets determined by chi^2 (including extpenalty factor)</span>
<span class="sd">    Positional params: From MS selection:</span>
<span class="sd">                       nu: (freq. vector of SPW), tmdataon (time vector of dataon data selection),</span>
<span class="sd">                       antson: (vector of antenna column of dataon data selection),</span>
<span class="sd">                       dataon: (masked array of selected data),</span>
<span class="sd">                       Data from CALATMOSPHERE table:</span>
<span class="sd">                       tmatm: (vector of times of sel. rows), antatm (vector of antenna IDs of sel. rows)</span>
<span class="sd">                       tsys: (Tsys table), trec (T Receiver table), tau (optical depth table)</span>
<span class="sd">    Keyword params:</span>
<span class="sd">    ndegree: Maximum degree of polynomial used to fit noise baseline (default=7)</span>
<span class="sd">    nclips: Maximum number of sigma clipping iterations to try in noise baseline fitting (default=5)</span>
<span class="sd">    nsigma: number of sigmas for science source channel selection. (default=3.0)</span>
<span class="sd">    smoothbox: Number of pixels to enlarge science target selection around pixels initially selected through</span>
<span class="sd">               the nsigma excess. Given as fraction of SPW width. (default=0.03)</span>
<span class="sd">    extpenalty: Factor to add a penalty to chi^2 of the fits, equal to extpenalty*(channel_range/number_of_channels)</span>
<span class="sd">    where channel_range is the range of channels of detected science sources. This factor aims at favoring more</span>
<span class="sd">    compact detections. (default=1.0)</span>
<span class="sd">    verbose: Return all fits&#39; selections, fit coefficient and chi^2&#39;s instead of only the best fit. Also produces</span>
<span class="sd">    plots for each fit. (default=False)</span>
<span class="sd">    maxmasked: Maximum fraction of data allowed to be masked. If higher than this, return a vector with no selection.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">npol</span><span class="p">,</span> <span class="n">nch</span><span class="p">,</span> <span class="n">nint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dataon</span><span class="p">)</span>
    <span class="c1">#Get skylines, if any. Avoid peak of skylines in science target detection</span>
    <span class="n">skylines</span> <span class="o">=</span> <span class="n">getskylines</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">fraclevel</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">)</span>
    <span class="n">skymask</span> <span class="o">=</span> <span class="n">skysel</span><span class="p">(</span><span class="n">skylines</span><span class="p">,</span> <span class="n">avoidpeak</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">noskymask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">skymask</span><span class="p">)</span>
    <span class="c1">#Normalize the standard deviation of the data by Tsys</span>
    <span class="n">normdata</span> <span class="o">=</span> <span class="n">noisenormdata</span><span class="p">(</span><span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm</span><span class="p">,</span> <span class="n">antatm</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
    <span class="n">normsigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">normdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">#If normalized sigma data array is masked more than maxmasked fraction of data, return an empty selection</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">normdata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">normsigma</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">maxmasked</span><span class="o">*</span><span class="n">nch</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span>
    <span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">normsigma</span><span class="p">)</span>
    <span class="p">(</span><span class="n">xbin</span><span class="p">,</span> <span class="n">mubin</span><span class="p">,</span> <span class="n">sigbin</span><span class="p">,</span> <span class="n">mederrbin</span><span class="p">,</span> <span class="n">chi2bin</span><span class="p">,</span> <span class="n">mskfracbin</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">binnedstats</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">normsigma</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span><span class="o">*</span><span class="n">sig</span><span class="p">,</span> <span class="n">nbins</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">minsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sigbin</span><span class="p">)</span>
    <span class="n">normsigmasigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nch</span><span class="p">)</span><span class="o">*</span><span class="n">minsig</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">normsigma</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">allbasenoisefit</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">allsel</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">allchi2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chi2idx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">invchi2idx</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">chi2cx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">onlyskysel</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">allressigma</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclips</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndegree</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">basenoisefit</span> <span class="o">=</span> <span class="n">sigclipfit</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">normsigma</span><span class="p">,</span> <span class="n">normsigmasigma</span><span class="p">,</span> <span class="n">deg</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="p">(</span><span class="mf">999.0</span><span class="p">,</span> <span class="n">nsigma</span><span class="p">),</span> <span class="n">bordertokeep</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">smoothselbox</span><span class="o">=</span><span class="n">smoothbox</span><span class="p">)</span>
            <span class="n">sourcesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">basenoisefit</span><span class="p">[</span><span class="s1">&#39;sel&#39;</span><span class="p">])</span>
            <span class="n">sourcesel</span><span class="p">[</span><span class="n">normsigma</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">sourcesel</span><span class="p">[</span><span class="n">skymask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#Measure full extent of selection</span>
            <span class="n">idxsourcesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sourcesel</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">extfactor</span> <span class="o">=</span> <span class="n">extpenalty</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">))</span><span class="o">/</span><span class="n">nch</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extfactor</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">allbasenoisefit</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">basenoisefit</span>
            <span class="n">allsel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sourcesel</span>
            <span class="n">noskylinesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">basenoisefit</span><span class="p">[</span><span class="s1">&#39;sel&#39;</span><span class="p">],</span> <span class="n">noskymask</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">onlyskysel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span><span class="n">deg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">noskylinesel</span><span class="p">,</span> <span class="n">sourcesel</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">(</span><span class="n">muaux</span><span class="p">,</span> <span class="n">sigaux</span><span class="p">)</span> <span class="o">=</span> <span class="n">robuststats</span><span class="p">(</span><span class="n">basenoisefit</span><span class="p">[</span><span class="s1">&#39;residuals&#39;</span><span class="p">][</span><span class="n">onlyskysel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span><span class="n">deg</span><span class="p">)]])</span>
            <span class="n">allressigma</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigaux</span><span class="p">)</span>
            <span class="n">chi2idx</span><span class="p">[</span><span class="n">chi2cx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)</span>
            <span class="n">invchi2idx</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)]</span> <span class="o">=</span> <span class="n">chi2cx</span>
            <span class="n">chi2cx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">bestsigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allressigma</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclips</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndegree</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1">#Measure full extent of selection</span>
            <span class="n">idxsourcesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">allsel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">extfactor</span> <span class="o">=</span> <span class="n">extpenalty</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">idxsourcesel</span><span class="p">))</span><span class="o">/</span><span class="n">nch</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">extfactor</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">allchi2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">allbasenoisefit</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)][</span><span class="s1">&#39;residuals&#39;</span><span class="p">][</span><span class="n">onlyskysel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span><span class="n">deg</span><span class="p">)]]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">bestsigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">onlyskysel</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span><span class="n">deg</span><span class="p">)])</span> <span class="o">-</span> <span class="n">deg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">extfactor</span><span class="p">)</span>
    <span class="n">allchi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">allchi2</span><span class="p">)</span>
    <span class="n">bestfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">allchi2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">(</span><span class="n">bestnc</span><span class="p">,</span> <span class="n">bestdeg</span><span class="p">)</span> <span class="o">=</span> <span class="n">chi2idx</span><span class="p">[</span><span class="n">bestfit</span><span class="p">]</span>
    <span class="n">sourcesel</span> <span class="o">=</span> <span class="n">allsel</span><span class="p">[(</span><span class="n">bestnc</span><span class="p">,</span> <span class="n">bestdeg</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nclips</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndegree</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">allbasenoisefit</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span> <span class="n">deg</span><span class="p">)][</span><span class="s1">&#39;coefs&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="p">(</span><span class="n">deg</span><span class="o">-</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">deg</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">normsigma</span><span class="p">,</span> <span class="s1">&#39;-k&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">sourcesel</span><span class="p">],</span> <span class="n">normsigma</span><span class="p">[</span><span class="n">sourcesel</span><span class="p">],</span> <span class="s1">&#39;sr&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="s1">&#39;:g&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nu</span><span class="p">)</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nu</span><span class="p">),</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">normsigma</span><span class="p">)</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">normsigma</span><span class="p">),</span> <span class="s1">&#39;chi2: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">allchi2</span><span class="p">[</span><span class="n">invchi2idx</span><span class="p">[(</span><span class="n">nc</span><span class="p">,</span><span class="n">deg</span><span class="p">)]]))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [GHz]&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Normalized Sigma(Amp)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nc</span> <span class="o">==</span> <span class="n">bestnc</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">deg</span> <span class="o">==</span> <span class="n">bestdeg</span><span class="p">):</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Normalized Noise plot (best fit)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Normalized Noise plot&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;selsource_output1_nc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_deg&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sourcesel</span></div>


<div class="viewcode-block" id="getskylines">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getskylines.html#pipeline.extern.SDcalatmcorr.getskylines">[docs]</a>
<span class="k">def</span> <span class="nf">getskylines</span><span class="p">(</span><span class="n">tauspec</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">fraclevel</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">spwbordertoavoid</span> <span class="o">=</span> <span class="mf">0.025</span><span class="p">,</span> <span class="n">taudeg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get position of sky lines and line widths from the optical depth.</span>
<span class="sd">    fraclevel: fraction of the maximum of the optical depth to look for.</span>
<span class="sd">    If fraclevel=0.5 (default), the width results will be the HWHM.</span>
<span class="sd">    minpeaklevel: Minimum relative opacity at a given peak (relative to median opacity)</span>
<span class="sd">    to consider a line. Lines smaller than this level are ignored. (default 0.05)</span>
<span class="sd">    spwbordertoavoid: Fractional border of the SPW to avoid for peak detection.</span>
<span class="sd">    Default is 0.025 (2.5% of SPW BW)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tauspec</span><span class="p">)</span>
    <span class="n">borderpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nch</span><span class="o">*</span><span class="n">spwbordertoavoid</span><span class="p">)))</span>
    <span class="n">noborder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">noborder</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">borderpix</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">noborder</span><span class="p">[</span><span class="n">nch</span><span class="o">-</span><span class="n">borderpix</span><span class="p">:</span><span class="n">nch</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">mintau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tauspec</span><span class="p">)</span>
    <span class="n">mediantau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tauspec</span><span class="p">)</span>
    <span class="n">tauzeroD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="mf">1.0</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">tauspec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">),</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_end</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">taunegDD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ediff1d</span><span class="p">(</span><span class="n">tauspec</span><span class="p">),</span> <span class="n">to_begin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">to_end</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">taugtminlevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">tauspec</span><span class="o">/</span><span class="n">mediantau</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">minpeaklevel</span><span class="p">))</span>
    <span class="n">taupeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">tauzeroD</span><span class="p">,</span> <span class="n">taunegDD</span><span class="p">,</span> <span class="n">taugtminlevel</span><span class="p">,</span> <span class="n">noborder</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tauvalley</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">tauzeroD</span><span class="p">,</span> <span class="o">~</span><span class="n">taunegDD</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">idxpeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">taupeak</span><span class="p">]</span>
    <span class="n">idxvalley</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nch</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)[</span><span class="n">tauvalley</span><span class="p">]</span>
    <span class="n">npeak</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">)</span>
    <span class="n">peaktau</span> <span class="o">=</span> <span class="n">tauspec</span><span class="p">[</span><span class="n">idxpeak</span><span class="p">]</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nch&#39;</span><span class="p">:</span> <span class="n">nch</span><span class="p">,</span> <span class="s1">&#39;npeak&#39;</span><span class="p">:</span> <span class="n">npeak</span><span class="p">,</span> <span class="s1">&#39;taumin&#39;</span><span class="p">:</span> <span class="n">mintau</span><span class="p">,</span> <span class="s1">&#39;fraclevel&#39;</span><span class="p">:</span> <span class="n">fraclevel</span><span class="p">,</span> <span class="s1">&#39;valley&#39;</span><span class="p">:</span> <span class="n">idxvalley</span><span class="p">,</span> <span class="s1">&#39;peaksinfo&#39;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="n">hwhmleft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npeak</span><span class="p">)</span>
    <span class="n">hwhmright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npeak</span><span class="p">)</span>
    <span class="n">widthratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">npeak</span><span class="p">)</span>
    <span class="c1">#Fit &quot;baseline&quot; to tau</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">1.e09</span>
    <span class="n">taufit</span> <span class="o">=</span> <span class="n">sigclipfit</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">tauspec</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">)),</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tauspec</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nch</span><span class="p">)),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
    <span class="n">taubline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">taufit</span><span class="p">[</span><span class="s1">&#39;coefs&#39;</span><span class="p">][</span><span class="n">deg</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">nu</span><span class="o">**</span><span class="p">(</span><span class="n">taudeg</span><span class="o">-</span><span class="n">deg</span><span class="p">))</span> <span class="k">for</span> <span class="n">deg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">taudeg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">subtau</span> <span class="o">=</span> <span class="n">tauspec</span> <span class="o">-</span> <span class="n">taubline</span>
    <span class="n">output</span><span class="p">[</span><span class="s1">&#39;taufit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">taufit</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">):</span>
        <span class="c1">#calculate the decrease from the tau depth relative to the minimum tau in the SPW</span>
        <span class="c1">#peakratioleft = np.array([(tauspec[idx - i]-mintau)/(peaktau[k]-mintau) for i in range(idx)])</span>
        <span class="c1">#peakratioright = np.array([(tauspec[idx + i]-mintau)/(peaktau[k]-mintau) for i in range(nch-idx)])</span>
        <span class="n">peakratioleft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subtau</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">subtau</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">)])</span>
        <span class="n">peakratioright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">subtau</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">subtau</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nch</span><span class="o">-</span><span class="n">idx</span><span class="p">)])</span>
        <span class="n">posrightneg</span> <span class="o">=</span> <span class="n">peakratioright</span> <span class="o">&lt;</span> <span class="n">fraclevel</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">posrightneg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posrightneg</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#search of peak to the right of this peak, select the border if none</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">npeak</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">nch</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">posleftneg</span> <span class="o">=</span> <span class="n">peakratioleft</span> <span class="o">&lt;</span> <span class="n">fraclevel</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">posleftneg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">posleftneg</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#search of peak to the left of this peak, select the border if none</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span>

    <span class="c1">#If the range of the skylines goes beyond a valley, shrink range around line using those valleys</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npeak</span><span class="p">):</span>
        <span class="n">valleypointsleft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">idxvalley</span> <span class="k">if</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">])])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valleypointsleft</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">valleypointsleft</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">valleypointsleft</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">valleypointsright</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">idxvalley</span> <span class="k">if</span> <span class="p">(</span><span class="n">point</span> <span class="o">&gt;</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">])])</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valleypointsright</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">valleypointsright</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">valleypointsright</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="c1">#Check if there is more than one peak and if so check if ranges overlap and correct in that case</span>
    <span class="k">if</span> <span class="n">npeak</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npeak</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">+</span><span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
                <span class="c1">#If there is an valley point detected between the peaks, choose that one.</span>
                <span class="c1">#If not, just pick the middle point between peaks</span>
                <span class="n">valleypoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">point</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">idxvalley</span> <span class="k">if</span> <span class="p">(</span><span class="n">point</span> <span class="o">&gt;</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">point</span> <span class="o">&lt;</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valleypoints</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">valleypoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">valleypoints</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">idxpeak</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="c1">#Create output dictionary</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxpeak</span><span class="p">):</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;peakpos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;taupeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tauspec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;hwhmleft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;hwhmright&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;minrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">-</span> <span class="n">hwhmleft</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;maxrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="n">hwhmright</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="gradeskylines">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.gradeskylines.html#pipeline.extern.SDcalatmcorr.gradeskylines">[docs]</a>
<span class="k">def</span> <span class="nf">gradeskylines</span><span class="p">(</span><span class="n">skylines</span><span class="p">,</span> <span class="n">cntrweight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
    <span class="n">spwlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">skylines</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">idxspw</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idxpeak</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">taupeak</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">centerdist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#Read values and calculate distance to SPW centers</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;npeak&#39;</span><span class="p">]):</span>
            <span class="n">taupeak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;taupeak&#39;</span><span class="p">])</span>
            <span class="n">centerdist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;peakpos&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
            <span class="n">idxspw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
            <span class="n">idxpeak</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">taupeak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">taupeak</span><span class="p">)</span>
    <span class="n">centerdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">centerdist</span><span class="p">)</span>
    <span class="c1">#Calculate grade</span>
    <span class="n">normtau</span> <span class="o">=</span> <span class="p">(</span><span class="n">taupeak</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">taupeak</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">taupeak</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">taupeak</span><span class="p">))</span>
    <span class="n">grade</span> <span class="o">=</span> <span class="n">normtau</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cntrweight</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">centerdist</span><span class="p">))</span>
    <span class="n">bestgrade</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">grade</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1">#Put grade back into skylines dictionary</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;npeak&#39;</span><span class="p">]):</span>
            <span class="n">skylines</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grade</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1">#Return SPW and index of higher grade peak</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">idxspw</span><span class="p">[</span><span class="n">bestgrade</span><span class="p">],</span> <span class="n">idxpeak</span><span class="p">[</span><span class="n">bestgrade</span><span class="p">])</span></div>


<div class="viewcode-block" id="skysel">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.skysel.html#pipeline.extern.SDcalatmcorr.skysel">[docs]</a>
<span class="k">def</span> <span class="nf">skysel</span><span class="p">(</span><span class="n">skylines</span><span class="p">,</span> <span class="n">linestouse</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">avoidpeak</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Create selection array from dictionary of skylines list.</span>
<span class="sd">    avoidpeak: Parameter to avoid a range around the line peak as fraction of FWHM</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">skysel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">linestouse</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="n">linestouse</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;npeak&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">linestouse</span><span class="p">:</span>
        <span class="n">skysel</span><span class="p">[</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;minrange&#39;</span><span class="p">]:</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;maxrange&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;maxrange&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;minrange&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avoidpeak</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">startrange</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;peakpos&#39;</span><span class="p">]</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">avoidpeak</span><span class="o">*</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;hwhmleft&#39;</span><span class="p">]))</span>
            <span class="n">endrange</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;peakpos&#39;</span><span class="p">]</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="n">avoidpeak</span><span class="o">*</span><span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;peaksinfo&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;hwhmright&#39;</span><span class="p">]),</span> <span class="n">skylines</span><span class="p">[</span><span class="s1">&#39;nch&#39;</span><span class="p">])</span>
            <span class="n">skysel</span><span class="p">[</span><span class="n">startrange</span><span class="p">:</span><span class="n">endrange</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">endrange</span><span class="o">-</span><span class="n">startrange</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">skysel</span></div>


<div class="viewcode-block" id="calcmetric">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.calcmetric.html#pipeline.extern.SDcalatmcorr.calcmetric">[docs]</a>
<span class="k">def</span> <span class="nf">calcmetric</span><span class="p">(</span><span class="n">rawsample</span><span class="p">,</span> <span class="n">rawsigmasample</span><span class="p">,</span> <span class="n">metrictype</span> <span class="o">=</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span> <span class="n">smoothbox</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
    <span class="p">(</span><span class="n">npols</span><span class="p">,</span> <span class="n">nch</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">rawsample</span><span class="p">)</span>
    <span class="c1">#Smooth if requested</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">smoothbox</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">smoothbox</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">rawsample</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">rawsample</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">smoothbox</span><span class="p">)</span>
        <span class="n">sigmasample</span> <span class="o">=</span> <span class="n">rawsigmasample</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">smoothbox</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">rawsample</span>
        <span class="n">sigmasample</span> <span class="o">=</span> <span class="n">rawsigmasample</span>
    <span class="c1">#Transform arrays to ma if not like that already</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">:</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="n">sigmasample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">sigmasample</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metrictype</span> <span class="o">==</span> <span class="s1">&#39;intabs&#39;</span><span class="p">:</span>
        <span class="n">auxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">goodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sigmagoodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodsample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">auxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="n">i</span><span class="p">,:])))</span>
                <span class="n">auxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">*</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">,:])))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metrictype</span> <span class="o">==</span> <span class="s1">&#39;maxabs&#39;</span><span class="p">:</span>
        <span class="n">auxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">goodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sigmagoodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodsample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">goodsample</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">auxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">goodsample</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span>
                <span class="n">auxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sigmagoodsample</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">auxval</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">auxval</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">auxerr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metrictype</span> <span class="o">==</span> <span class="s1">&#39;maxabsdiff&#39;</span><span class="p">:</span>
        <span class="n">auxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">goodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sigmagoodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodsample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">absdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">goodsample</span><span class="p">))</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">absdiff</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">auxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">absdiff</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">auxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigmagoodsample</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">sigmagoodsample</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">auxval</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">auxval</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">auxerr</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metrictype</span> <span class="o">==</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">:</span>
        <span class="n">auxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">goodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sigmasqgoodsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodsample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">absdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">goodsample</span><span class="p">))</span>
                <span class="n">absdiffsqerr</span> <span class="o">=</span> <span class="n">sigmasqgoodsample</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">sigmasqgoodsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">auxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">absdiff</span><span class="p">))</span>
                <span class="n">auxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">absdiffsqerr</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">metrictype</span> <span class="o">==</span> <span class="s1">&#39;intsqdiff&#39;</span><span class="p">:</span>
        <span class="n">auxval</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">auxerr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="n">goodsample</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">sigmasqgoodsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">((</span><span class="n">sigmasample</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="o">~</span><span class="n">sample</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">goodsample</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">absdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">goodsample</span><span class="p">))</span>
                <span class="n">sqdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">absdiff</span><span class="p">)</span>
                <span class="n">absdiffsqerr</span> <span class="o">=</span> <span class="n">sigmasqgoodsample</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">sigmasqgoodsample</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sqdifferr</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">absdiff</span><span class="o">*</span><span class="n">absdiff</span><span class="o">*</span><span class="p">(</span><span class="n">absdiffsqerr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">auxval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sqdiff</span><span class="p">))</span>
                <span class="n">auxerr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sqdifferr</span><span class="p">)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxval</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">auxerr</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span></div>


<div class="viewcode-block" id="bootstrap">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.bootstrap.html#pipeline.extern.SDcalatmcorr.bootstrap">[docs]</a>
<span class="k">def</span> <span class="nf">bootstrap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">metrictype</span> <span class="o">=</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span> <span class="n">nsample</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="n">calcmetric</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">metrictype</span> <span class="o">=</span> <span class="n">metrictype</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsample</span><span class="p">):</span>
        <span class="n">idxsample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">sample</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idxsample</span><span class="p">]</span>
        <span class="n">metric</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calcmetric</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="n">metrictype</span> <span class="o">=</span> <span class="n">metrictype</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metric</span></div>


<span class="c1">#Copied over from analysisUtils</span>
<div class="viewcode-block" id="getSpwList">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getSpwList.html#pipeline.extern.SDcalatmcorr.getSpwList">[docs]</a>
<span class="k">def</span> <span class="nf">getSpwList</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;OBSERVE_TARGET#ON_SOURCE&#39;</span><span class="p">,</span><span class="n">tdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">fdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sqld</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
    <span class="n">almaspws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">almaspws</span><span class="p">(</span><span class="n">tdm</span><span class="o">=</span><span class="n">tdm</span><span class="p">,</span><span class="n">fdm</span><span class="o">=</span><span class="n">fdm</span><span class="p">,</span><span class="n">sqld</span><span class="o">=</span><span class="n">sqld</span><span class="p">)</span>
    <span class="n">scienceSpws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span><span class="n">almaspws</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">scienceSpws</span><span class="p">))</span></div>


<span class="c1">#Copied over from analysisUtils</span>
<div class="viewcode-block" id="onlineChannelAveraging">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.onlineChannelAveraging.html#pipeline.extern.SDcalatmcorr.onlineChannelAveraging">[docs]</a>
<span class="k">def</span> <span class="nf">onlineChannelAveraging</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">spws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    For Cycle 3-onward data, determines the channel averaging factor from</span>
<span class="sd">    the ratio of the effective channel bandwidth to the channel width.</span>
<span class="sd">    spw: a single value, or a list; if Nonne, then uses science spws</span>
<span class="sd">    Returns: single value for a single spw, or a list for a list of spws</span>
<span class="sd">    -Todd Hunter</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hanning_effBw</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mf">2.667</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mf">3.200</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="mf">4.923</span><span class="p">,</span> <span class="mi">8</span><span class="p">:</span> <span class="mf">8.828</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span> <span class="mf">16.787</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">spws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">getSpwList</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">spws</span><span class="p">]</span>
    <span class="n">Ns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hanning_effBw</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">ratios</span> <span class="o">=</span> <span class="p">[</span><span class="n">hanning_effBw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Ns</span><span class="p">]</span>
    <span class="n">Nvalues</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
        <span class="n">chanwidths</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanwidths</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanwidths</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="n">chanwidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">chanwidths</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">chaneffwidth</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chaneffbws</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">chaneffwidth</span><span class="o">/</span><span class="n">chanwidth</span>
        <span class="n">Nvalues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ns</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ratios</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">))])</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Nvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Nvalues</span></div>


<span class="c1">#Obtain spectral setup</span>
<div class="viewcode-block" id="getSpecSetup">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getSpecSetup.html#pipeline.extern.SDcalatmcorr.getSpecSetup">[docs]</a>
<span class="k">def</span> <span class="nf">getSpecSetup</span><span class="p">(</span><span class="n">myms</span><span class="p">,</span> <span class="n">spwlist</span> <span class="o">=</span> <span class="p">[]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Task to gather spectral setup information.</span>
<span class="sd">    myms: MS to be processed.</span>
<span class="sd">    spwlist: List of SPW to be included in queries, if left empty, all science SPWs</span>
<span class="sd">    will be considered.</span>
<span class="sd">    intentlist: List of intents to be included in the queries. By default is *OBSERVE_TARGET*.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#Else read in the information from the MS</span>
    <span class="c1">#if spwlist is empty, get all science SPWs</span>
    <span class="n">intentlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*OBSERVE_TARGET#ON_SOURCE*&#39;</span><span class="p">,</span> <span class="s1">&#39;*OBSERVE_TARGET#OFF_SOURCE*&#39;</span><span class="p">]</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">msmdtool</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">myms</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">spwlist</span> <span class="o">=</span> <span class="n">getSpwList</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>
    <span class="n">spwsetup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlist</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;intentlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">intentlist</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforsources</span><span class="p">(</span><span class="n">asnames</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">intentlist</span><span class="p">:</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">intent</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">scansforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">))</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldname&#39;</span><span class="p">][</span><span class="n">intent</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="n">asnames</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldid&#39;</span><span class="p">][</span><span class="n">intent</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforintent</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span><span class="n">asnames</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scifieldidoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">fieldid</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldid&#39;</span><span class="p">][</span><span class="s1">&#39;*OBSERVE_TARGET#ON_SOURCE*&#39;</span><span class="p">]:</span>
        <span class="n">fieldname</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">listfieldnameoff</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="p">(</span><span class="n">fieldname</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;OFF&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">listfieldnameoff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fieldidoff</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">listfieldnameoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scifieldidoff&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fieldidoff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scifieldidoff&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">allscans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">flattenlist</span><span class="p">([</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">intent</span><span class="p">]</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">intentlist</span><span class="p">])))</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;allscans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">allscans</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">allscans</span><span class="p">:</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">][</span><span class="n">scan</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">intent</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;intentlist&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">intent</span><span class="p">]]</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennasforscan</span><span class="p">(</span><span class="n">scan</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">intentlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antnames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">antennanames</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antids&#39;</span><span class="p">]))</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;spwnames&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">namesforspws</span><span class="p">(</span><span class="n">spwlist</span><span class="p">))</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fdmspws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fdmspws</span><span class="p">()</span>
    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;tdmspws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">tdmspws</span><span class="p">()</span>

    <span class="n">nchanperbb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#Get SPW information: frequencies of each channel, etc.</span>
        <span class="n">chanfreqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">)</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chanfreqs</span><span class="p">)</span>
        <span class="n">fcenter</span> <span class="o">=</span> <span class="p">(</span><span class="n">chanfreqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="n">chanfreqs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">chansep</span> <span class="o">=</span> <span class="p">(</span><span class="n">chanfreqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">chanfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanfreqs</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchan</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;fcenter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fcenter</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chansep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chansep</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;Nave&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onlineChannelAveraging</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="c1">#Get data descriptor for each SPW</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;ddi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">datadescids</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;npol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">ncorrforpol</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">polidfordatadesc</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;ddi&#39;</span><span class="p">]))</span>
        <span class="c1">#Get baseband for each SPW</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">baseband</span><span class="p">(</span><span class="n">spwid</span><span class="p">))</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BBname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BB_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">])</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;istdm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;tdmspws&#39;</span><span class="p">])</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;nchan_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchan</span><span class="o">*</span><span class="mi">5</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chansep_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chansep</span><span class="o">/</span><span class="mf">5.</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs_high&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">chanfreqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">chansep</span><span class="o">/</span><span class="mf">5.</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nchan</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;fcenter_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs_high&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span><span class="o">+</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs_high&#39;</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">nchan</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span><span class="o">/</span><span class="mf">2.</span>
        <span class="n">nchanperbb</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span>

    <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;nchanperbb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchanperbb</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;istdm2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nchanperbb</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
        <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;dosmooth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">nchanperbb</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;npol&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">8192</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;dosmooth&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Spw </span><span class="si">%d</span><span class="s1"> in BB_</span><span class="si">%d</span><span class="s1"> (total Nchan within BB is </span><span class="si">%d</span><span class="s1">, sp avg likely not applied).  dosmooth=True&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">],</span> <span class="n">nchanperbb</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;npol&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Spw </span><span class="si">%d</span><span class="s1"> in BB_</span><span class="si">%d</span><span class="s1"> (total Nchan within BB is </span><span class="si">%d</span><span class="s1">, sp avg likely applied).  dosmooth=False&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">],</span> <span class="n">nchanperbb</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BB&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;npol&#39;</span><span class="p">]))</span>

    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">spwsetup</span></div>


<div class="viewcode-block" id="getAntennaFlagFrac">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getAntennaFlagFrac.html#pipeline.extern.SDcalatmcorr.getAntennaFlagFrac">[docs]</a>
<span class="k">def</span> <span class="nf">getAntennaFlagFrac</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get flagging fraction for each antenna, in a vector listed ordered by order given in spwsetup dictionary.</span>
<span class="sd">    ms: Input MS</span>
<span class="sd">    fieldid: Field ID used to select data</span>
<span class="sd">    spwid: SPW used to select data</span>
<span class="sd">    spwsetup: Spectral setup dictionary, as obtained from getSpecSetup()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">af</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">aftool</span><span class="p">)</span>
    <span class="n">af</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="n">af</span><span class="o">.</span><span class="n">selectdata</span><span class="p">(</span><span class="n">field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">),</span> <span class="n">spw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">))</span>
    <span class="n">af</span><span class="o">.</span><span class="n">parsesummaryparameters</span><span class="p">()</span>
    <span class="n">af</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">flag_stats_dict</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">af</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
    <span class="n">antflag</span> <span class="o">=</span> <span class="n">flag_stats_dict</span><span class="p">[</span><span class="s1">&#39;report0&#39;</span><span class="p">][</span><span class="s1">&#39;antenna&#39;</span><span class="p">]</span>
    <span class="n">antflag_frac</span> <span class="o">=</span> <span class="p">[</span><span class="n">antflag</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antnames&#39;</span><span class="p">][</span><span class="n">antid</span><span class="p">]][</span><span class="s1">&#39;flagged&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">antflag</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antnames&#39;</span><span class="p">][</span><span class="n">antid</span><span class="p">]][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">antid</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antids&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">antflag_frac</span></div>


<div class="viewcode-block" id="getCalAtmData">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getCalAtmData.html#pipeline.extern.SDcalatmcorr.getCalAtmData">[docs]</a>
<span class="k">def</span> <span class="nf">getCalAtmData</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spws</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">):</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">tbtool</span><span class="p">)</span>
    <span class="c1">#Open CALATMOSPHERE table</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="s1">&#39;ASDM_CALATMOSPHERE&#39;</span><span class="p">))</span>
    <span class="c1">#Get weather parameters</span>
    <span class="n">tground_all</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;groundTemperature&#39;</span><span class="p">)</span>
    <span class="n">pground_all</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;groundPressure&#39;</span><span class="p">)</span>
    <span class="n">hground_all</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;groundRelHumidity&#39;</span><span class="p">)</span>
    <span class="c1">#Get the spectra of the ATM measurements</span>
    <span class="n">tmatm_all</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tsys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">trec</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">antatm</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
        <span class="n">minfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">])</span>
        <span class="n">maxfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">])</span>
        <span class="n">midfreq</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">minfreq</span><span class="o">+</span><span class="n">maxfreq</span><span class="p">)</span>
        <span class="n">samebbspw</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;BBname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BBname&#39;</span><span class="p">]]</span>
        <span class="n">subtb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;basebandName==&quot;</span><span class="si">{0:s}</span><span class="s1">&quot; &amp;&amp; syscalType==&quot;TEMPERATURE_SCALE&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;BBname&#39;</span><span class="p">])))</span>
        <span class="n">tmatm_all</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;startValidTime&#39;</span><span class="p">)</span>
        <span class="c1">#Get frequency vector and find section belonging to this SPW</span>
        <span class="n">fullfreq</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;frequencySpectrum&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">sectionmid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">freqsection</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chansec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chanidx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">samebbspw</span><span class="p">:</span>
            <span class="n">chansec</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">chanidx</span><span class="p">,</span><span class="n">chanidx</span><span class="o">+</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]])</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">fullfreq</span><span class="p">[</span><span class="n">chanidx</span><span class="p">:</span><span class="n">chanidx</span><span class="o">+</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]]</span>
            <span class="n">chanidx</span> <span class="o">+=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span>
            <span class="n">sectionmid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">section</span><span class="p">))</span>
            <span class="n">freqsection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="n">thissection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sectionmid</span><span class="p">)</span> <span class="o">-</span> <span class="n">midfreq</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">freqsection</span><span class="p">[</span><span class="n">thissection</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="n">startchan</span> <span class="o">=</span> <span class="n">chansec</span><span class="p">[</span><span class="n">thissection</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endchan</span> <span class="o">=</span> <span class="n">chansec</span><span class="p">[</span><span class="n">thissection</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#Load Tsys and Trx tables</span>
        <span class="n">auxtsys</span> <span class="o">=</span> <span class="p">[</span><span class="n">subtb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;tSysSpectrum&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subtb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())]</span>
        <span class="n">auxtrec</span> <span class="o">=</span> <span class="p">[</span><span class="n">subtb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;tRecSpectrum&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subtb</span><span class="o">.</span><span class="n">nrows</span><span class="p">())]</span>
        <span class="c1"># (npols, nchantsys, nrowstsys) = np.shape(auxtsys)</span>
        <span class="n">npols</span> <span class="o">=</span> <span class="n">auxtsys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nrowstsys</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">auxtsys</span><span class="p">)</span>
        <span class="n">tsys</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npols</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">],</span> <span class="n">nrowstsys</span><span class="p">))</span>
        <span class="n">trec</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npols</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">],</span> <span class="n">nrowstsys</span><span class="p">))</span>
        <span class="c1">#Resample the curves to match the frequency of the data SPWs</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrowstsys</span><span class="p">):</span>
                <span class="n">tsysfit</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">auxtsys</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">pol</span><span class="p">][</span><span class="n">startchan</span><span class="p">:</span><span class="n">endchan</span><span class="p">][</span><span class="n">order</span><span class="p">],</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;not-a-knot&#39;</span><span class="p">)</span>
                <span class="n">trecfit</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">auxtrec</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">pol</span><span class="p">][</span><span class="n">startchan</span><span class="p">:</span><span class="n">endchan</span><span class="p">][</span><span class="n">order</span><span class="p">],</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;not-a-knot&#39;</span><span class="p">)</span>
                <span class="n">tsys</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="n">pol</span><span class="p">,:,</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysfit</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">])</span>
                <span class="n">trec</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="n">pol</span><span class="p">,:,</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">trecfit</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">])</span>
        <span class="n">antatm</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;antennaName&#39;</span><span class="p">)</span>
        <span class="c1">#To get the skyline list, pick index of first antenna, first entry of tau, for the first polarization</span>
        <span class="c1">#Resample according to the same procedure used for Tsys and Trx</span>
        <span class="n">auxtau</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;tauSpectrum&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">taufit</span> <span class="o">=</span> <span class="n">CubicSpline</span><span class="p">(</span><span class="n">freq</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">auxtau</span><span class="p">[</span><span class="n">startchan</span><span class="p">:</span><span class="n">endchan</span><span class="p">][</span><span class="n">order</span><span class="p">],</span> <span class="n">bc_type</span><span class="o">=</span><span class="s1">&#39;not-a-knot&#39;</span><span class="p">)</span>
        <span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">taufit</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">])</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">tground_all</span><span class="p">,</span> <span class="n">pground_all</span><span class="p">,</span> <span class="n">hground_all</span><span class="p">,</span> <span class="n">tmatm_all</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">antatm</span><span class="p">)</span></div>


<div class="viewcode-block" id="makeNANmetrics">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.makeNANmetrics.html#pipeline.extern.SDcalatmcorr.makeNANmetrics">[docs]</a>
<span class="k">def</span> <span class="nf">makeNANmetrics</span><span class="p">(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">nmodels</span><span class="p">):</span>
    <span class="n">metricdtypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;maxabs&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabserr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabs&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabserr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabsdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabsdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabsdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intsqdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intsqdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">fieldid</span><span class="p">:</span> <span class="p">{</span><span class="n">spwid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmodels</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">metricdtypes</span><span class="p">)}}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">):</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabserr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabserr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabsdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabsdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabsdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabsdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intsqdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intsqdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">metrics</span></div>


<div class="viewcode-block" id="makePlot">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.makePlot.html#pipeline.extern.SDcalatmcorr.makePlot">[docs]</a>
<span class="k">def</span> <span class="nf">makePlot</span><span class="p">(</span><span class="n">nu</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tmavedata</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">skychansel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scisrcsel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">bline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">isize</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">psize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
             <span class="n">highbuf</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">lowbuf</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">atmhighbuf</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
             <span class="n">diffsmoothbox</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ischosen</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">takediff</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">xlabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="p">(</span><span class="n">npol</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tmavedata</span><span class="p">)</span>
    <span class="c1">#Choose whether to plot data as-is or its derivative</span>
    <span class="k">if</span> <span class="n">takediff</span><span class="p">:</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nchan</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">ydata</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tmavedata</span><span class="p">[</span><span class="n">ipol</span><span class="p">]))</span>
            <span class="n">ydata</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmavedata</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">nu</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">seldata</span> <span class="o">=</span> <span class="n">scisrcsel</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Abs(Amp[i+1]-Amp[i])&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">tmavedata</span>
        <span class="n">xdata</span> <span class="o">=</span> <span class="n">nu</span>
        <span class="n">seldata</span> <span class="o">=</span> <span class="n">scisrcsel</span>
        <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Corr Amp [Jy]&#39;</span>
    <span class="c1">#Also apply smoothing if requested</span>
    <span class="k">if</span> <span class="n">diffsmoothbox</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">newnpol</span><span class="p">,</span> <span class="n">newnchan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">newydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newnpol</span><span class="p">,</span> <span class="n">newnchan</span><span class="p">)),</span> <span class="n">mask</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">newnpol</span><span class="p">,</span> <span class="n">newnchan</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">newydata</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">ydata</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="n">diffsmoothbox</span><span class="p">)</span>
            <span class="n">newydata</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">enlargesel</span><span class="p">(</span><span class="n">ydata</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="n">diffsmoothbox</span><span class="p">)</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">newydata</span>
        <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Freq [Ghz] (smooth:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">diffsmoothbox</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; ch)&#39;</span>
    <span class="k">elif</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Freq [Ghz]&#39;</span>

    <span class="c1">#Calculate data limit for plot</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mindata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">maxdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ydata</span><span class="p">)</span>
        <span class="n">datarange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxdata</span> <span class="o">-</span> <span class="n">mindata</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">mindata</span> <span class="o">-</span> <span class="n">lowbuf</span><span class="o">*</span><span class="n">datarange</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">maxdata</span> <span class="o">+</span> <span class="n">highbuf</span><span class="o">*</span><span class="n">datarange</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not determine normalization of data! is all of it flagged??&#39;</span><span class="p">)</span>
        <span class="n">datarange</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.02</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">))</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.02</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xdata</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xdata</span><span class="p">))</span>

    <span class="c1">#Plot data before correction</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="c1">#Data axis ax1</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
        <span class="n">thisstyle</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;blue&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">ipol</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">thisstyle</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">psize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scisrcsel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xdata</span><span class="p">[</span><span class="n">seldata</span><span class="p">],</span> <span class="n">ydata</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">seldata</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">psize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">bline</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">thisstyle</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">))</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">))</span>
    <span class="c1">#Add Accepted/Discarded text</span>
    <span class="k">if</span> <span class="n">ischosen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ischosen</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="o">*</span><span class="n">xmin</span><span class="o">+</span><span class="mf">0.85</span><span class="o">*</span><span class="n">xmax</span><span class="p">,</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ymin</span><span class="o">+</span><span class="mf">0.9</span><span class="o">*</span><span class="n">ymax</span><span class="p">,</span> <span class="s1">&#39;Applied&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.15</span><span class="o">*</span><span class="n">xmin</span><span class="o">+</span><span class="mf">0.85</span><span class="o">*</span><span class="n">xmax</span><span class="p">,</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ymin</span><span class="o">+</span><span class="mf">0.9</span><span class="o">*</span><span class="n">ymax</span><span class="p">,</span> <span class="s1">&#39;Discarded&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">fontweight</span> <span class="o">=</span> <span class="s1">&#39;normal&#39;</span><span class="p">)</span>

    <span class="c1">#Plot atmospheric transmission and skyline windows, if provided</span>
    <span class="k">if</span> <span class="n">tau</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">transm</span> <span class="o">=</span> <span class="mf">100.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">*</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">mintr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">transm</span><span class="p">)</span>
        <span class="n">maxtr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">transm</span><span class="p">)</span>
        <span class="n">trrange</span> <span class="o">=</span> <span class="n">maxtr</span> <span class="o">-</span> <span class="n">mintr</span>
        <span class="n">lowbuf2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">atmhighbuf</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">lowbuf</span><span class="p">)</span><span class="o">/</span><span class="n">highbuf</span>
        <span class="n">ymin2</span> <span class="o">=</span> <span class="n">mintr</span> <span class="o">-</span> <span class="n">lowbuf2</span><span class="o">*</span><span class="n">trrange</span>
        <span class="n">ymax2</span> <span class="o">=</span> <span class="n">maxtr</span> <span class="o">+</span> <span class="n">atmhighbuf</span><span class="o">*</span><span class="n">trrange</span>
        <span class="n">ywin</span> <span class="o">=</span> <span class="n">ymin2</span> <span class="o">+</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">lowbuf2</span><span class="o">*</span><span class="n">trrange</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span> 
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skychansel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">skychansel</span><span class="p">],</span> <span class="n">ywin</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skychansel</span><span class="p">)),</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">psize</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span> <span class="n">transm</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;magenta&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="n">ymin2</span><span class="p">,</span> <span class="n">ymax2</span><span class="p">))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">mintr</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">maxtr</span><span class="o">+</span><span class="n">mintr</span><span class="p">),</span> <span class="n">maxtr</span><span class="p">])</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;% ATM Transmission&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;magenta&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">isize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="k">return</span></div>


<div class="viewcode-block" id="atmcorr">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.atmcorr.html#pipeline.extern.SDcalatmcorr.atmcorr">[docs]</a>
<span class="k">def</span> <span class="nf">atmcorr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">datacolumn</span> <span class="o">=</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">,</span> <span class="n">iant</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">atmtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">maxalt</span> <span class="o">=</span> <span class="mf">120.0</span><span class="p">,</span> <span class="n">lapserate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">scaleht</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">jyperkfactor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dobackup</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">forcespws</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">forcefield</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">forcemetricline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">blinedeg</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">blinenclip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">blinensigma</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">maxonlyspw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plotsfolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">diffsmooth</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">,</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">isize</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">plotbline</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">defatmtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">defmaxalt</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">deflapserate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">defscaleht</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">decisionmetric</span> <span class="o">=</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Task to apply CSV-3320 correction for atmospheric lines.</span>
<span class="sd">    Parameter list:</span>
<span class="sd">    ms: (first argument) MS file to be processed</span>
<span class="sd">    output: Compute the metrics over the skyline residuals and return them</span>
<span class="sd">    for best parameter evaluation. Output in this case is a tuple (models, metrics) where models is an array</span>
<span class="sd">    of the models used, and metrics is a dictionary containing arrays of metric results for each one</span>
<span class="sd">    of the models for each field and SPW, structured like: metrics[FIELDID][SPW]</span>
<span class="sd">    Keyword arguments:</span>
<span class="sd">    datacolumn: Column to apply correction to, options: &#39;DATA&#39;, &#39;CORRECTED_DATA&#39;(default)</span>
<span class="sd">    iant: Antenna number to get pointing direction (antenna having mount issues should</span>
<span class="sd">    be avoided). Also used to test atmospheric residuals. Default is 0.</span>
<span class="sd">    jyperkfactor: Dictionary of Jy/K factors for each EB, antenna and SPW. Default will</span>
<span class="sd">    assume a factor of 1.0. To be obtained from getJyperKfromCSV() function</span>
<span class="sd">    dobackup: Whether to do a backup of the MS before applying the correction.</span>
<span class="sd">    (True/False) Default is True. </span>
<span class="sd">    forcespws: Force the list of SPWs to process. If not specified, task will do all SPWs.</span>
<span class="sd">    forcefield: Force the FIELD ID to process. If not specified task will pick the first one.</span>
<span class="sd">    blinedeg: Degree of the baseline fitting polynomial.</span>
<span class="sd">    blinenclip: Number of sigma clipping iterations to use in the baseline fitting routine.</span>
<span class="sd">    blinensigma: Significance in number of sigmas for the sigma clipping routine that fit the</span>
<span class="sd">    baseline polynomial.</span>
<span class="sd">    maxonlyspw: Whether to select the SPW with largest skyline only. (Default: True)</span>
<span class="sd">    timestamp: Timestamp string to use for the model plots folder</span>
<span class="sd">    plotsfolder: Explicit folder name for model plots folder. If given, timestamp will be ignored.</span>
<span class="sd">    Following parameters define the atmospheric model. For runmode = &#39;try&#39;, the parameters below</span>
<span class="sd">    can be vectors, in that case the task will try all combinations and return a tuple of the list</span>
<span class="sd">    of models and the results of the metrics for each model on the residual of skylines.</span>
<span class="sd">    amttype: Atmosphere type paremeter for model in at module (1: tropical, 2: mid lat summer,</span>
<span class="sd">    3: mid lat winter, etc). Default is 2</span>
<span class="sd">    maxalt: maxAltitude parameter for model, in km. default is 120 (km)</span>
<span class="sd">    lapserate: Lapse Rate dTem_dh parameter for at (lapse rate; K/km). Default is -5.6</span>
<span class="sd">    scaleht: h0 parameter for at (water scale height; km). Default is 2.0</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">qa</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">qatool</span><span class="p">)</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="c1">#Do a backup of the MS if requested</span>
    <span class="n">backupms</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span><span class="s1">&#39;.ms.backup&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dobackup</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">backupms</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">backupms</span><span class="p">)</span>
    <span class="c1">#If there is no timestamp, generate new one</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">getTimeStamp</span><span class="p">()</span>
    <span class="c1">#If there is no name for the results file, create one</span>
    <span class="k">if</span> <span class="n">plotsfolder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotsfolder</span> <span class="o">=</span> <span class="s1">&#39;modelplots_&#39;</span><span class="o">+</span><span class="n">timestamp</span>
    <span class="c1">#Make plot models folder, if needed</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plotsfolder</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">plotsfolder</span><span class="p">)</span>

    <span class="c1">################################################################</span>
    <span class="c1">### Get metadata</span>
    <span class="c1">################################################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Obtaining metadata for MS: &#39;</span><span class="o">+</span><span class="n">ms</span><span class="p">)</span>
    <span class="n">spwsetup</span> <span class="o">=</span> <span class="n">getSpecSetup</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="c1">#chanfreqs = {}</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">msmdtool</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
    <span class="c1">#Get data times for OBSERVE_TARGET</span>
    <span class="n">tmonsource</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforintent</span><span class="p">(</span><span class="s1">&#39;OBSERVE_TARGET#ON_SOURCE&#39;</span><span class="p">)</span>
    <span class="n">tmoffsource</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforintent</span><span class="p">(</span><span class="s1">&#39;OBSERVE_TARGET#OFF_SOURCE&#39;</span><span class="p">)</span>
    <span class="c1">#Make table of subscans while on source</span>
    <span class="n">onsourcetab</span> <span class="o">=</span> <span class="n">segmentEdges</span><span class="p">(</span><span class="n">tmonsource</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="s1">&#39;onsource&#39;</span><span class="p">)</span>
    <span class="c1">#Initialize list of all SPWs to work on</span>
    <span class="n">spws</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]</span>
    <span class="n">metricskylineids</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; forcespws=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">forcespws</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &gt;&gt;&gt; metricskylineids=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">forcemetricline</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&gt;&gt;&gt; spws=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; &gt;&gt;&gt; metricskylineids=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metricskylineids</span><span class="p">))</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1">#Set fields to correct</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">forcefield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">forcefield</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">forcefield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">forcefield</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#We could not receive the fieldid from calling method, default to first field</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;fieldid&#39;</span><span class="p">][</span><span class="s1">&#39;*OBSERVE_TARGET#ON_SOURCE*&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bnd</span> <span class="o">=</span> <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">tmoffsource</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">True</span><span class="p">],</span> <span class="n">bnd</span><span class="p">)</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bnd</span><span class="p">,</span> <span class="p">[</span><span class="kc">True</span><span class="p">])</span>
    <span class="n">tmoffsource</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmoffsource</span><span class="p">[</span><span class="n">w1</span><span class="p">]</span><span class="o">+</span><span class="n">tmoffsource</span><span class="p">[</span><span class="n">w2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>  <span class="c1">### midpoint of OFF subscan</span>

    <span class="c1">################################################################</span>
    <span class="c1">### Get atmospheric parameters for ATM</span>
    <span class="c1">################################################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Obtaining atmospheric parameters for MS: &#39;</span><span class="o">+</span><span class="n">ms</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">tbtool</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="s1">&#39;ASDM_CALWVR&#39;</span><span class="p">))</span>
    <span class="n">tmpwv_all</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;startValidTime&#39;</span><span class="p">)</span>
    <span class="n">pwv_all</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;water&#39;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#Open CALATMOSPHERE table</span>
    <span class="p">(</span><span class="n">tground_all</span><span class="p">,</span> <span class="n">pground_all</span><span class="p">,</span> <span class="n">hground_all</span><span class="p">,</span> <span class="n">tmatm_all</span><span class="p">,</span> <span class="n">tsys</span><span class="p">,</span> <span class="n">trec</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">antatm</span><span class="p">)</span> <span class="o">=</span> <span class="n">getCalAtmData</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spws</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">)</span>
    <span class="n">tmatm</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tmatm_all</span><span class="p">[</span><span class="n">spws</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

    <span class="c1">#Search for sky lines</span>
    <span class="n">skylines</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">skylinesbroad</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
        <span class="n">skylines</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">getskylines</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">fraclevel</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="n">minpeaklevel</span><span class="p">)</span>
        <span class="n">skylinesbroad</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">getskylines</span><span class="p">(</span><span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">fraclevel</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="n">minpeaklevel</span><span class="p">)</span>

    <span class="c1">#Select SPWs to process</span>
    <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">forcespws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">:</span>
            <span class="c1">#If there is at least one skyline in this SPW, add this spw to the ones to be processed</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;npeak&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">spwstoprocess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">forcespws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcespws</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="n">forcespws</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">forcespws</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcespws</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="p">[</span><span class="n">forcespws</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;initial spwstoprocess=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">))</span>

    <span class="c1">#If only one SPW is to be processed, pick the best one</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forcemetricline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">maxonlyspw</span><span class="p">:</span>
        <span class="p">(</span><span class="n">bestspw</span><span class="p">,</span> <span class="n">bestpeak</span><span class="p">)</span> <span class="o">=</span> <span class="n">gradeskylines</span><span class="p">(</span><span class="n">skylines</span><span class="p">)</span>
        <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="p">[</span><span class="n">bestspw</span><span class="p">]</span>
        <span class="n">metricskylineids</span> <span class="o">=</span> <span class="p">[</span><span class="n">bestpeak</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forcemetricline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maxonlyspw</span><span class="p">:</span>
        <span class="p">(</span><span class="n">bestspw</span><span class="p">,</span> <span class="n">bestpeak</span><span class="p">)</span> <span class="o">=</span> <span class="n">gradeskylines</span><span class="p">(</span><span class="n">skylines</span><span class="p">)</span>
        <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="p">[</span><span class="n">bestspw</span><span class="p">]</span>
        <span class="n">metricskylineids</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forcemetricline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcemetricline</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">metricskylineids</span> <span class="o">=</span> <span class="n">forcemetricline</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">forcemetricline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcespws</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">metricskylineids</span> <span class="o">=</span> <span class="p">[</span><span class="n">forcemetricline</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;selecting spwstoprocess=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; metricskylineids=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metricskylineids</span><span class="p">))</span>
    <span class="c1">#Smoothing box for diff metrics</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">diffsmoothbox</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">diffsmooth</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">]))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">diffsmoothbox</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">################################################################</span>
    <span class="c1">### Define list of models to try</span>
    <span class="c1">################################################################</span>
    <span class="n">defmodel</span> <span class="o">=</span> <span class="p">(</span><span class="n">defatmtype</span><span class="p">,</span> <span class="n">defmaxalt</span><span class="p">,</span> <span class="n">deflapserate</span><span class="p">,</span> <span class="n">defscaleht</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">atmtype</span><span class="p">)):</span>
        <span class="n">atmtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">atmtype</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">maxalt</span><span class="p">)))</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">maxalt</span><span class="p">))):</span>
        <span class="n">maxalt</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxalt</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lapserate</span><span class="p">)))</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">lapserate</span><span class="p">))):</span>
        <span class="n">lapserate</span> <span class="o">=</span> <span class="p">[</span><span class="n">lapserate</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;int&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">scaleht</span><span class="p">)))</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;float&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">scaleht</span><span class="p">))):</span>
        <span class="n">scaleht</span> <span class="o">=</span> <span class="p">[</span><span class="n">scaleht</span><span class="p">]</span>
    <span class="n">modtypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;atmtype&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxalt&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;lapserate&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;scaleht&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
    <span class="n">models</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">model</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">product</span><span class="p">(</span><span class="n">atmtype</span><span class="p">,</span> <span class="n">maxalt</span><span class="p">,</span> <span class="n">lapserate</span><span class="p">,</span> <span class="n">scaleht</span><span class="p">)],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">modtypes</span><span class="p">)</span>
    <span class="n">nmodels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span>
    <span class="n">metricdtypes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;maxabs&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabserr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabs&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabserr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabsdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;maxabsdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intabsdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intsqdiff&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;intsqdifferr&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fieldid: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; spwstoprocess: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">))</span>
    <span class="c1">#Create metric output dictionary</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">jyperkfactor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Case where we have at least one skyline available</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metricskylineids: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metricskylineids</span><span class="p">))</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">fieldid</span><span class="p">:</span> <span class="p">{</span><span class="n">spwid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmodels</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">metricdtypes</span><span class="p">)</span> <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">}}</span>
    <span class="c1">#If no peak, abort process!!</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#We either have no skylines or no jy/K factor. Return the correct message</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No skylines! Reverting to default model...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jyperkfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Jy/K factor!! Cannot perform calculation, reverting to default model...&#39;</span><span class="p">)</span>
        <span class="n">spwid</span> <span class="o">=</span> <span class="n">spws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">makeNANmetrics</span><span class="p">(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">nmodels</span><span class="p">)</span>
        <span class="n">bestmodels</span> <span class="o">=</span> <span class="n">defmodel</span>
        <span class="n">fitstatus</span> <span class="o">=</span> <span class="s1">&#39;defaultmodel&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">bestmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">fitstatus</span><span class="p">,</span> <span class="n">spwstoprocess</span><span class="p">,</span> <span class="n">metricskylineids</span><span class="p">)</span>

    <span class="n">pwv</span><span class="p">,</span> <span class="n">tground</span><span class="p">,</span> <span class="n">pground</span><span class="p">,</span> <span class="n">hground</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">tmatm</span><span class="p">:</span>
        <span class="n">deltat</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tmpwv_all</span><span class="o">-</span><span class="n">tt</span><span class="p">)</span>
        <span class="n">pwv</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pwv_all</span><span class="p">[</span><span class="n">deltat</span><span class="o">==</span><span class="n">deltat</span><span class="o">.</span><span class="n">min</span><span class="p">()]))</span>
        <span class="n">tground</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tground_all</span><span class="p">[</span><span class="n">tmatm_all</span><span class="o">==</span><span class="n">tt</span><span class="p">]))</span>
        <span class="n">pground</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">pground_all</span><span class="p">[</span><span class="n">tmatm_all</span><span class="o">==</span><span class="n">tt</span><span class="p">]))</span>
        <span class="n">hground</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">hground_all</span><span class="p">[</span><span class="n">tmatm_all</span><span class="o">==</span><span class="n">tt</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PWV = </span><span class="si">%f</span><span class="s1">m, T = </span><span class="si">%f</span><span class="s1">K, P = </span><span class="si">%f</span><span class="s1">Pa, H = </span><span class="si">%f%%</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pwv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">tground</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">pground</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hground</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">qa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">s&#39;</span> <span class="o">%</span> <span class="n">tt</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1">################################################################</span>
    <span class="c1">### Looping over spws</span>
    <span class="c1">################################################################</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;start processing &#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39; ...&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;will go over SPWs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwstoprocess</span><span class="p">))</span>

    <span class="c1">################################################################</span>
    <span class="c1">## Apply correction using all the different models</span>
    <span class="c1">################################################################</span>

    <span class="n">tmpfolder</span> <span class="o">=</span> <span class="s1">&#39;tmpapply_&#39;</span><span class="o">+</span><span class="n">timestamp</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir &#39;</span><span class="o">+</span><span class="n">tmpfolder</span><span class="p">)</span>
    <span class="n">tmpspwstr</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">])</span>
    <span class="c1">#If for the test field we have a separate OFF position, create list with both</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scifieldidoff&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">testfields</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)]</span><span class="o">+</span><span class="p">[</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;scifieldidoff&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)]])])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">testfields</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span>
    <span class="n">testspws</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">])</span>
    <span class="c1">#Split out the relevant fields and SPWs to a smaller MS for testing models</span>
    <span class="n">testms</span> <span class="o">=</span> <span class="n">ms</span> <span class="o">+</span> <span class="s1">&#39;.modeltest&#39;</span>
    <span class="c1">#mstransform(vis = ms, outputvis = tmpfolder+&#39;/&#39;+testms, field = testfields, spw = testspws, antenna = str(iant)+&#39;&amp;&amp;&#39;+str(iant), datacolumn = &#39;all&#39;, reindex = False)</span>

    <span class="c1">#Select antenna to be used, if not selected</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">iant</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">iant</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">iant</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">()):</span>
        <span class="n">iantsel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">iant</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test data selected forced to use antenna </span><span class="si">{0:d}</span><span class="s1"> (</span><span class="si">{1:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iantsel</span><span class="p">,</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antnames&#39;</span><span class="p">][</span><span class="n">iantsel</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">antflagfrac</span> <span class="o">=</span> <span class="n">getAntennaFlagFrac</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">testfields</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">)</span>
        <span class="n">iantsel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">antflagfrac</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test data selected automatically with antenna </span><span class="si">{0:d}</span><span class="s1"> (</span><span class="si">{1:s}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iantsel</span><span class="p">,</span><span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;antnames&#39;</span><span class="p">][</span><span class="n">iantsel</span><span class="p">]))</span>

    <span class="c1">#String with data column to be used in sdatmcor command</span>
    <span class="k">if</span> <span class="n">datacolumn</span> <span class="o">==</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">:</span>
        <span class="n">sddatacolumn</span> <span class="o">=</span> <span class="s1">&#39;corrected&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sddatacolumn</span> <span class="o">=</span> <span class="s1">&#39;float_data&#39;</span>

    <span class="c1">#cycle over all models, calling sdatmcor</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">:</span>
            <span class="n">strmodel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1">/</span><span class="si">{1:d}</span><span class="s1">: (atmType,maxAlt,scaleht,lapserate)=(</span><span class="si">{2:d}</span><span class="s1">,</span><span class="si">{3:.2f}</span><span class="s1">km,</span><span class="si">{4:.2f}</span><span class="s1">km,</span><span class="si">{5:.2f}</span><span class="s1">K/km)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;atmtype&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;maxalt&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;scaleht&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;lapserate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correcting data with model &#39;</span><span class="o">+</span><span class="n">strmodel</span><span class="p">)</span>
            <span class="n">outfname</span> <span class="o">=</span> <span class="n">tmpfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.model&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.ms&#39;</span><span class="p">)</span>
            <span class="n">sdatmcor</span><span class="p">(</span><span class="n">infile</span><span class="o">=</span><span class="n">ms</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="n">sddatacolumn</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfname</span><span class="p">,</span>
                     <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">),</span> <span class="n">antenna</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iantsel</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&amp;&amp;&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iantsel</span><span class="p">),</span> <span class="n">field</span> <span class="o">=</span> <span class="n">testfields</span><span class="p">,</span>
                     <span class="n">gainfactor</span><span class="o">=</span><span class="n">jyperkfactor</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)],</span>
                     <span class="n">dtem_dh</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;lapserate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;K/km&#39;</span><span class="p">,</span> <span class="n">h0</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;scaleht&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;km&#39;</span><span class="p">,</span>
                     <span class="n">atmtype</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="s1">&#39;atmtype&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]),</span> <span class="n">atmdetail</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#Open uncorrected data to measure skylines and presence of science target</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing spw &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">))</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e+09</span><span class="p">)</span>

        <span class="c1">################################################################</span>
        <span class="c1">### Calculate and apply correction values</span>
        <span class="c1">################################################################</span>
        <span class="n">querystr</span> <span class="o">=</span> <span class="s1">&#39;DATA_DESC_ID in </span><span class="si">{0:s}</span><span class="s1"> &amp;&amp; FIELD_ID in </span><span class="si">{1:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;ddi&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading data for TaQL query: &#39;</span><span class="o">+</span><span class="n">querystr</span><span class="p">)</span>
        <span class="n">subtb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystr</span><span class="p">)</span>
        <span class="n">tmdata</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">datacolumn</span><span class="p">)</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
        <span class="n">flagrow</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG_ROW&#39;</span><span class="p">)</span>
        <span class="n">ant1</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
        <span class="n">npol</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">#Add the flag ROW flag to the individual row flag arrays,</span>
        <span class="c1">#in order to use only one array.</span>
        <span class="n">flaggedrowlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flagrow</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">flaggedrowlist</span><span class="p">:</span>
            <span class="n">flag</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">flag</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">],</span><span class="o">~</span><span class="n">flag</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">])</span>
        <span class="c1">#Create selection vector for on-source rows</span>
        <span class="n">onsel</span> <span class="o">=</span> <span class="n">selectRanges</span><span class="p">(</span><span class="n">tmdata</span><span class="p">,</span> <span class="n">onsourcetab</span><span class="p">)</span>
        <span class="n">tmdataon</span> <span class="o">=</span> <span class="n">tmdata</span><span class="p">[</span><span class="n">onsel</span><span class="p">]</span>
        <span class="n">antson</span> <span class="o">=</span> <span class="n">ant1</span><span class="p">[</span><span class="n">onsel</span><span class="p">]</span>

        <span class="c1">#Create masked data numpy array for ease of use, cdata to contain the data before correction</span>
        <span class="c1">#and diffbuffer after correction</span>
        <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">mask</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="c1">#Search for science target channels</span>
        <span class="n">dataon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cdata</span><span class="p">)[</span><span class="n">onsel</span><span class="p">])</span>
        <span class="c1">#Pre-correction average</span>
        <span class="n">precorravedataon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataon</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">maskedchans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">precorravedataon</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1">#scisrcsel = selsource2(spwid, spwsetup, nu, tmdataon, antson, dataon, tmatm_all[spwid], antatm[spwid], tsys[spwid], trec[spwid], tau[spwid])</span>
        <span class="n">scisrcsel</span> <span class="o">=</span> <span class="n">selsource</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">spwsetup</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="n">tmdataon</span><span class="p">,</span> <span class="n">antson</span><span class="p">,</span> <span class="n">dataon</span><span class="p">,</span> <span class="n">tmatm_all</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">antatm</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">tsys</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">trec</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scisrcsel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scisrcsel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scisrcsel</span><span class="p">[</span><span class="n">maskedchans</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">nchsci</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scisrcsel</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nchsci</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">isscisrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">nchsci</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1">#Create a selection vector for baseline subtraction including the line but removing possible</span>
        <span class="c1">#overlap with science target channels</span>
        <span class="c1">#Narrow sky channels selection for measuring the metrics, broad for baseline fitting</span>
        <span class="n">skychansel</span> <span class="o">=</span> <span class="n">skysel</span><span class="p">(</span><span class="n">skylines</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">linestouse</span> <span class="o">=</span> <span class="n">metricskylineids</span><span class="p">)</span>
        <span class="n">skychansel</span><span class="p">[</span><span class="n">maskedchans</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">skychanselbroad</span> <span class="o">=</span> <span class="n">skysel</span><span class="p">(</span><span class="n">skylinesbroad</span><span class="p">[</span><span class="n">spwid</span><span class="p">])</span>
        <span class="n">skychanselbroad</span><span class="p">[</span><span class="n">maskedchans</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#Make baseline channel selection excluding both science target and sky lines</span>
        <span class="n">baselinesel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nu</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">isscisrc</span><span class="p">:</span>
            <span class="n">skychansel</span><span class="p">[</span><span class="n">scisrcsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchsci</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">skychanselbroad</span><span class="p">[</span><span class="n">scisrcsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchsci</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">baselinesel</span><span class="p">[</span><span class="n">scisrcsel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchsci</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">baselinesel</span><span class="p">[</span><span class="n">skychanselbroad</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skychanselbroad</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="c1">#Initialize variables for baseline subtraction</span>
        <span class="n">blinefit</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">blinemodel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metricnorm</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99</span>

        <span class="c1">#If we are left with no channels with skylines, we are in trouble</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">skychansel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not select skyline channels! Aborting...&#39;</span><span class="p">)</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">makeNANmetrics</span><span class="p">(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">nmodels</span><span class="p">)</span>
            <span class="n">bestmodels</span> <span class="o">=</span> <span class="n">defmodel</span>
            <span class="n">fitstatus</span> <span class="o">=</span> <span class="s1">&#39;defaultmodel&#39;</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">bestmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">fitstatus</span><span class="p">,</span> <span class="n">spwstoprocess</span><span class="p">,</span> <span class="n">metricskylineids</span><span class="p">)</span>

        <span class="c1">#Pre-correction average</span>
        <span class="c1">#precorrdataon = np.transpose(np.transpose(cdata)[onsel])</span>
        <span class="c1">#precorravedataon = np.ma.mean(precorrdataon, axis = 2)</span>
        <span class="n">normsample</span> <span class="o">=</span> <span class="n">dataon</span><span class="p">[:,</span><span class="n">skychansel</span><span class="p">]</span>
        <span class="c1">#Try to calculate the normalizing value for the metrics</span>
        <span class="c1">#If is cannot calculate it, fill default value of 1</span>
        <span class="c1">#similar thing for plot ranges</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">metricnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">normsample</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not determine normalization of data! is all of it flagged??&#39;</span><span class="p">)</span>
            <span class="n">metricnorm</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># xmin = np.min(nu) - 0.02*(np.max(nu)-np.min(nu))</span>
        <span class="c1"># xmax = np.max(nu) + 0.02*(np.max(nu)-np.min(nu))</span>
        <span class="c1"># try:</span>
        <span class="c1">#     mindata0 = np.ma.min(precorravedataon)</span>
        <span class="c1">#     maxdata0 = np.ma.max(precorravedataon)</span>
        <span class="c1">#     ymin0 = mindata0 - 1.0*np.abs(maxdata0 - mindata0)</span>
        <span class="c1">#     ymax0 = maxdata0 + 1.0*np.abs(maxdata0 - mindata0)</span>
        <span class="c1">#     yatm0 = maxdata0 + 0.5*np.abs(maxdata0 - mindata0)</span>
        <span class="c1"># except:</span>
        <span class="c1">#     print(&#39;Could not determine normalization of data! is all of it flagged??&#39;)</span>
        <span class="c1">#     ymin0 = -1.0</span>
        <span class="c1">#     ymax0 = 1.0</span>
        <span class="c1">#     yatm = 0.5</span>

        <span class="c1">#Plot data before correction</span>
        <span class="c1"># plt.clf()</span>
        <span class="c1"># for ipol in range(npol):</span>
        <span class="c1">#     thisstyle = (&#39;blue&#39; if (ipol == 0) else &#39;red&#39;)</span>
        <span class="c1">#     plt.plot(nu, precorravedataon[ipol], &#39;.&#39;, color=thisstyle, markersize=psize)</span>
        <span class="c1">#     if isscisrc:</span>
        <span class="c1">#         plt.plot(nu[scisrcsel], precorravedataon[ipol][scisrcsel], &#39;.&#39;, color=&#39;green&#39;, markersize=psize)</span>
        <span class="c1">#     #plt.plot(nu[skychansel], precorravedataon[ipol][skychansel], &#39;s&#39;, color=&#39;magenta&#39;, markersize=psize)</span>
        <span class="c1">#     plt.plot(nu[skychansel], yatm0*np.ones(np.sum(skychansel)), &#39;s&#39;, color=&#39;magenta&#39;, markersize=psize)</span>
        <span class="c1"># plt.xlabel(&#39;Freq [Ghz]&#39;)</span>
        <span class="c1"># plt.ylabel(&#39;Corr Amp [Jy]&#39;)</span>
        <span class="c1"># strmodel = &#39;EB:{0:s}\nSPW:{1:s}, Field:{2:s}&#39;.format(ms, str(spwid), spwsetup[&#39;namesfor&#39;][str(fieldid)][0])</span>
        <span class="c1"># plt.title(&#39;Uncorrected data &#39;+strmodel)</span>
        <span class="c1"># plt.xlim((xmin,xmax))</span>
        <span class="c1"># plt.ylim((ymin0,ymax0))</span>
        <span class="c1"># plt.savefig(plotsfolder+&#39;/&#39;+ms+&#39;.field&#39;+str(fieldid)+&#39;.spw&#39;+str(spwid)+&#39;.nocorr.&#39;+str(k)+&#39;.old.png&#39;,dpi=isize)</span>
        <span class="n">makePlot</span><span class="p">(</span><span class="n">nu</span><span class="o">=</span><span class="n">nu</span><span class="p">,</span> <span class="n">tmavedata</span><span class="o">=</span><span class="n">precorravedataon</span><span class="p">,</span> <span class="n">skychansel</span><span class="o">=</span><span class="n">skychansel</span><span class="p">,</span> <span class="n">scisrcsel</span><span class="o">=</span><span class="n">scisrcsel</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span>
                 <span class="n">title</span><span class="o">=</span><span class="n">strmodel</span><span class="p">,</span> <span class="n">diffsmoothbox</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">takediff</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ischosen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">isize</span> <span class="o">=</span> <span class="n">isize</span><span class="p">,</span> <span class="n">psize</span> <span class="o">=</span> <span class="n">psize</span><span class="p">,</span>
                 <span class="n">output</span><span class="o">=</span><span class="n">plotsfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;.field&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.nocorr.png&#39;</span><span class="p">)</span>

    <span class="c1">#End of processing uncorrected dataset, close it</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#Lists of plots to do after looping over all models</span>
    <span class="n">plotlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plotlistnobline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">plotlistdiff</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1">#Open uncorrected data to measure skylines and presence of science target</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwstoprocess</span><span class="p">:</span>
        <span class="c1">#cycle over all models</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">):</span>
            <span class="n">strmodel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1">/</span><span class="si">{1:d}</span><span class="s1">: (</span><span class="si">{2:d}</span><span class="s1">,</span><span class="si">{3:.2f}</span><span class="s1">km,</span><span class="si">{4:.2f}</span><span class="s1">km,</span><span class="si">{5:.2f}</span><span class="s1">K/km)</span><span class="se">\n</span><span class="s1">EB:</span><span class="si">{6:s}</span><span class="se">\n</span><span class="s1">SPW:</span><span class="si">{7:s}</span><span class="s1">, Field:</span><span class="si">{8:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;atmtype&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;maxalt&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;scaleht&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="s1">&#39;lapserate&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">ms</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">),</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Going over model &#39;</span><span class="o">+</span><span class="n">strmodel</span><span class="p">)</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">tmpfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.model&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.ms&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing spw &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">))</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;chanfreqs&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.e+09</span><span class="p">)</span>

            <span class="c1">################################################################</span>
            <span class="c1">### Read corrected data for model k</span>
            <span class="c1">################################################################</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msk</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">querystr</span> <span class="o">=</span> <span class="s1">&#39;DATA_DESC_ID in </span><span class="si">{0:s}</span><span class="s1"> &amp;&amp; FIELD_ID in </span><span class="si">{1:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spwsetup</span><span class="p">[</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;ddi&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Reading data for TaQL query: &#39;</span><span class="o">+</span><span class="n">querystr</span><span class="p">)</span>
            <span class="n">subtb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">querystr</span><span class="p">)</span>
            <span class="n">tmdatak</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="n">datak</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;DATA&#39;</span><span class="p">)</span>
            <span class="n">flagk</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
            <span class="n">flagrowk</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG_ROW&#39;</span><span class="p">)</span>
            <span class="c1">#Add the flag ROW flag to the individual row flag arrays,</span>
            <span class="c1">#in order to use only one array.</span>
            <span class="n">flaggedrowlistk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flagrowk</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">flaggedrowlistk</span><span class="p">:</span>
                <span class="n">flagk</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">flagk</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">],</span><span class="o">~</span><span class="n">flag</span><span class="p">[:,:,</span><span class="n">row</span><span class="p">])</span>

            <span class="c1">#Create selection vector for on-source rows</span>
            <span class="n">onselk</span> <span class="o">=</span> <span class="n">selectRanges</span><span class="p">(</span><span class="n">tmdatak</span><span class="p">,</span> <span class="n">onsourcetab</span><span class="p">)</span>

            <span class="c1">#Create masked data numpy array for ease of use, data after correction</span>
            <span class="n">cdatak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">datak</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">mask</span><span class="o">=</span><span class="n">flagk</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

            <span class="c1">#Calculate metrics for model k</span>
            <span class="c1">#First select channel range, and average over time</span>
            <span class="n">diffdataonk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">cdatak</span><span class="p">)[</span><span class="n">onselk</span><span class="p">])</span>
            <span class="n">npolk</span><span class="p">,</span> <span class="n">nchk</span><span class="p">,</span> <span class="n">nrowk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">diffdataonk</span><span class="p">)</span>
            <span class="n">tmavedataonk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diffdataonk</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">tmstddataonk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">diffdataonk</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nrowk</span><span class="p">)</span>

            <span class="c1">#Fit baseline</span>
            <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
                <span class="n">blinefit</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitbaseline</span><span class="p">(</span><span class="n">nu</span><span class="p">[</span><span class="n">baselinesel</span><span class="p">],</span> <span class="n">tmavedataonk</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">baselinesel</span><span class="p">],</span> <span class="n">tmstddataonk</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">baselinesel</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">blinefit</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="s1">&#39;blfit&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">blinemodel</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">blinefit</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="s1">&#39;blfit&#39;</span><span class="p">](</span><span class="n">nu</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blinemodel</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">tmavedataonk</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>
                <span class="c1">#blinefit[ipol] = sigclipfit(nu[baselinesel], tmavedataonk[ipol][baselinesel], tmstddataonk[ipol][baselinesel], blinedeg, blinenclip, blinensigma, bordertokeep = 0.05, smoothselbox = 0.0)</span>
                <span class="c1">#blinemodel[ipol] = np.ma.sum([blinefit[ipol][&#39;coefs&#39;][deg]*(nu**(blinedeg-deg)) for deg in range(blinedeg+1)], axis = 0)</span>
            <span class="c1">#Compute baseline subtracted data</span>
            <span class="n">blinesubdataon</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">*</span><span class="n">tmavedataonk</span>
            <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>                    
                <span class="n">blinesubdataon</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmavedataonk</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">-</span> <span class="n">blinemodel</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>

            <span class="c1">#Plot corrected data with baseline fit, etc.</span>
            <span class="k">if</span> <span class="n">plotbline</span><span class="p">:</span>
                <span class="n">bline</span> <span class="o">=</span> <span class="n">blinemodel</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bline</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plotlist</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;tmavedata&#39;</span><span class="p">:</span> <span class="n">tmavedataonk</span><span class="p">,</span> <span class="s1">&#39;skychansel&#39;</span><span class="p">:</span> <span class="n">skychansel</span><span class="p">,</span> <span class="s1">&#39;scisrcsel&#39;</span><span class="p">:</span> <span class="n">scisrcsel</span><span class="p">,</span>
                             <span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Model &#39;</span><span class="o">+</span><span class="n">strmodel</span><span class="p">,</span> <span class="s1">&#39;diffsmoothbox&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> 
                             <span class="s1">&#39;takediff&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ischosen&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;bline&#39;</span><span class="p">:</span> <span class="n">bline</span><span class="p">,</span>
                             <span class="s1">&#39;isize&#39;</span><span class="p">:</span> <span class="n">isize</span><span class="p">,</span> <span class="s1">&#39;psize&#39;</span><span class="p">:</span> <span class="n">psize</span><span class="p">,</span>
                             <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">plotsfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;.field&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.model.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">})</span>


            <span class="c1">#Plot corrected data without baseline</span>
            <span class="n">plotlistnobline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;tmavedata&#39;</span><span class="p">:</span> <span class="n">blinesubdataon</span><span class="p">,</span> <span class="s1">&#39;skychansel&#39;</span><span class="p">:</span> <span class="n">skychansel</span><span class="p">,</span>
                                    <span class="s1">&#39;scisrcsel&#39;</span><span class="p">:</span> <span class="n">scisrcsel</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Model &#39;</span><span class="o">+</span><span class="n">strmodel</span><span class="p">,</span>
                                    <span class="s1">&#39;diffsmoothbox&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;takediff&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;ischosen&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s1">&#39;isize&#39;</span><span class="p">:</span> <span class="n">isize</span><span class="p">,</span> <span class="s1">&#39;psize&#39;</span><span class="p">:</span> <span class="n">psize</span><span class="p">,</span> <span class="s1">&#39;ylabel&#39;</span><span class="p">:</span> <span class="s1">&#39;Corr Amp (-baseline) [Jy]&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">plotsfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;.field&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.model.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.nobline.png&#39;</span><span class="p">})</span>

            <span class="c1">#Plot corrected data absolute value of derivative</span>
            <span class="n">plotlistdiff</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;nu&#39;</span><span class="p">:</span> <span class="n">nu</span><span class="p">,</span> <span class="s1">&#39;tmavedata&#39;</span><span class="p">:</span> <span class="n">tmavedataonk</span><span class="p">,</span> <span class="s1">&#39;skychansel&#39;</span><span class="p">:</span> <span class="n">skychansel</span><span class="p">,</span>
                                    <span class="s1">&#39;scisrcsel&#39;</span><span class="p">:</span> <span class="n">scisrcsel</span><span class="p">,</span> <span class="s1">&#39;tau&#39;</span><span class="p">:</span> <span class="n">tau</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Model &#39;</span><span class="o">+</span><span class="n">strmodel</span><span class="p">,</span>
                                    <span class="s1">&#39;diffsmoothbox&#39;</span><span class="p">:</span> <span class="n">diffsmoothbox</span><span class="p">,</span> <span class="s1">&#39;takediff&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;ischosen&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                    <span class="s1">&#39;isize&#39;</span><span class="p">:</span> <span class="n">isize</span><span class="p">,</span> <span class="s1">&#39;psize&#39;</span><span class="p">:</span> <span class="n">psize</span><span class="p">,</span>
                                    <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="n">plotsfolder</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;.field&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fieldid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.spw&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.model.&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.absdiff.png&#39;</span><span class="p">})</span>

            <span class="c1">#Select sample data for metrics</span>
            <span class="n">skysamplenobline</span> <span class="o">=</span> <span class="n">blinesubdataon</span><span class="p">[:,</span><span class="n">skychansel</span><span class="p">]</span><span class="o">/</span><span class="n">metricnorm</span>
            <span class="n">skysample</span> <span class="o">=</span> <span class="n">tmavedataonk</span><span class="p">[:,</span><span class="n">skychansel</span><span class="p">]</span><span class="o">/</span><span class="n">metricnorm</span>
            <span class="n">skysamplesigma</span> <span class="o">=</span> <span class="n">tmstddataonk</span><span class="p">[:,</span><span class="n">skychansel</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">metricnorm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nrowk</span><span class="p">))</span>
            <span class="c1">#Calculate metrics</span>
            <span class="p">(</span><span class="n">maxabs</span><span class="p">,</span> <span class="n">maxabserr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calcmetric</span><span class="p">(</span><span class="n">skysamplenobline</span><span class="p">,</span> <span class="n">skysamplesigma</span><span class="p">,</span> <span class="n">metrictype</span><span class="o">=</span><span class="s1">&#39;maxabs&#39;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxabs</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabserr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxabserr</span>
            <span class="p">(</span><span class="n">intabs</span><span class="p">,</span> <span class="n">intabserr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calcmetric</span><span class="p">(</span><span class="n">skysamplenobline</span><span class="p">,</span> <span class="n">skysamplesigma</span><span class="p">,</span> <span class="n">metrictype</span><span class="o">=</span><span class="s1">&#39;intabs&#39;</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intabs</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabserr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intabserr</span>
            <span class="p">(</span><span class="n">maxabsdiff</span><span class="p">,</span> <span class="n">maxabsdifferr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calcmetric</span><span class="p">(</span><span class="n">skysample</span><span class="p">,</span> <span class="n">skysamplesigma</span><span class="p">,</span> <span class="n">metrictype</span><span class="o">=</span><span class="s1">&#39;maxabsdiff&#39;</span><span class="p">,</span> <span class="n">smoothbox</span> <span class="o">=</span> <span class="n">diffsmoothbox</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabsdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxabsdiff</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;maxabsdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxabsdifferr</span>
            <span class="p">(</span><span class="n">intabsdiff</span><span class="p">,</span> <span class="n">intabsdifferr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calcmetric</span><span class="p">(</span><span class="n">skysample</span><span class="p">,</span> <span class="n">skysamplesigma</span><span class="p">,</span> <span class="n">metrictype</span><span class="o">=</span><span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span> <span class="n">smoothbox</span> <span class="o">=</span> <span class="n">diffsmoothbox</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabsdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intabsdiff</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intabsdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intabsdifferr</span>
            <span class="p">(</span><span class="n">intsqdiff</span><span class="p">,</span> <span class="n">intsqdifferr</span><span class="p">)</span> <span class="o">=</span> <span class="n">calcmetric</span><span class="p">(</span><span class="n">skysample</span><span class="p">,</span> <span class="n">skysamplesigma</span><span class="p">,</span> <span class="n">metrictype</span><span class="o">=</span><span class="s1">&#39;intsqdiff&#39;</span><span class="p">,</span> <span class="n">smoothbox</span> <span class="o">=</span> <span class="n">diffsmoothbox</span><span class="p">)</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intsqdiff&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intsqdiff</span>
            <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="s1">&#39;intsqdifferr&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">intsqdifferr</span>

            <span class="c1">#End of processing corrected dataset k, close it</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1">#Pick best model</span>
    <span class="n">chosenspw</span> <span class="o">=</span> <span class="n">spwstoprocess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">chosenmetric</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="n">fieldid</span><span class="p">][</span><span class="n">chosenspw</span><span class="p">][</span><span class="n">decisionmetric</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;for ms: </span><span class="si">{0:s}</span><span class="s1">, chosenmetric = </span><span class="si">{1:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">chosenmetric</span><span class="p">)))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chosenmetric</span><span class="p">)):</span>
        <span class="n">idxbestmodel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">chosenmetric</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bestmodels</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">idxbestmodel</span><span class="p">]</span>
        <span class="n">fitstatus</span> <span class="o">=</span> <span class="s1">&#39;bestfitmodel&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">idxbestmodel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bestmodels</span> <span class="o">=</span> <span class="n">defmodel</span>
        <span class="n">fitstatus</span> <span class="o">=</span> <span class="s1">&#39;defaultmodel&#39;</span>
    <span class="c1">#Set best model plot parameter as &quot;Accepted&quot;</span>
    <span class="k">if</span> <span class="n">idxbestmodel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotlist</span><span class="p">[</span><span class="n">idxbestmodel</span><span class="p">][</span><span class="s1">&#39;ischosen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">plotlistnobline</span><span class="p">[</span><span class="n">idxbestmodel</span><span class="p">][</span><span class="s1">&#39;ischosen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">plotlistdiff</span><span class="p">[</span><span class="n">idxbestmodel</span><span class="p">][</span><span class="s1">&#39;ischosen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1">#Create all model plots</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plotlist</span><span class="p">)):</span>
        <span class="n">makePlot</span><span class="p">(</span><span class="o">**</span><span class="n">plotlist</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">makePlot</span><span class="p">(</span><span class="o">**</span><span class="n">plotlistnobline</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">makePlot</span><span class="p">(</span><span class="o">**</span><span class="n">plotlistdiff</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">bestmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">fitstatus</span><span class="p">,</span> <span class="n">spwstoprocess</span><span class="p">,</span> <span class="n">metricskylineids</span><span class="p">)</span></div>


<div class="viewcode-block" id="getJyperKfromCSV">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getJyperKfromCSV.html#pipeline.extern.SDcalatmcorr.getJyperKfromCSV">[docs]</a>
<span class="k">def</span> <span class="nf">getJyperKfromCSV</span><span class="p">(</span><span class="n">jyperkfile</span> <span class="o">=</span> <span class="s1">&#39;jyperk.csv&#39;</span><span class="p">,</span> <span class="n">mssuffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Get Jy/K factor from the indicated CSV file.</span>
<span class="sd">    Assumes columns in the file are MS,Antenna,Spwid,Polarization,Factor</span>
<span class="sd">    and that the first line is the header.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jyperkfile</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">mslist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spwlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">jyperklist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">jyperkfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">jyperk</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">mslist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span> <span class="o">+</span> <span class="n">mssuffix</span><span class="p">)</span>
            <span class="n">spwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
            <span class="n">jyperklist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">jyperk</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)))</span>
    <span class="n">mslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mslist</span><span class="p">)</span>
    <span class="n">spwlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)</span>
    <span class="n">jyperklist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jyperklist</span><span class="p">)</span>
    <span class="n">uniquems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">mslist</span><span class="p">)</span>
    <span class="n">uniquespw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="p">:{</span><span class="n">spw</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jyperklist</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">mslist</span> <span class="o">==</span> <span class="n">ms</span><span class="p">,</span> <span class="n">spwlist</span> <span class="o">==</span> <span class="n">spw</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)])</span>
               <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">uniquespw</span><span class="p">}</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">uniquems</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="getJyperKfromCaltable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getJyperKfromCaltable.html#pipeline.extern.SDcalatmcorr.getJyperKfromCaltable">[docs]</a>
<span class="k">def</span> <span class="nf">getJyperKfromCaltable</span><span class="p">(</span><span class="n">mslist</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Get Jy/K factors from pipeline caltables. Will determine the MS list and tables from pipeline context.</span>

<span class="sd">    This method could raise RuntimeError when Jy/K caltable associated with any of given MS does not exist.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">createCasaTool</span><span class="p">(</span><span class="n">tbtool</span><span class="p">)</span>
    <span class="n">callib</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">callibrary</span>

    <span class="k">def</span> <span class="nf">_extract_jyperk_table</span><span class="p">(</span><span class="n">vis</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract name of Jy/K caltable from callibrary.</span>

<span class="sd">        Args:</span>
<span class="sd">            vis: name of MS</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: No Jy/K caltable is available.</span>
<span class="sd">            RuntimeError: Found more than one Jy/K caltable.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Name of Jy/K caltable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">caltables</span> <span class="o">=</span> <span class="n">callib</span><span class="o">.</span><span class="n">get_calstate</span><span class="p">(</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalTo</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span><span class="o">.</span><span class="n">get_caltable</span><span class="p">(</span><span class="n">caltypes</span><span class="o">=</span><span class="s1">&#39;amp&#39;</span><span class="p">)</span>
        <span class="c1"># there should be only one Jy/K caltable in callibrary</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">caltables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No Jy/K caltable for </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">caltables</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Detected more than one Jy/K caltables for </span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="si">}</span><span class="s1">. Something went wrong.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">caltables</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">jyperktables</span> <span class="o">=</span> <span class="p">[</span><span class="n">_extract_jyperk_table</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">]</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mslist</span><span class="p">):</span>
        <span class="c1">#Get SPW info for this MS</span>
        <span class="n">spwsetup</span> <span class="o">=</span> <span class="n">getSpecSetup</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="c1">#Open Jy/K Amp table</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">jyperktables</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ant1</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
        <span class="n">cparam</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>
        <span class="n">jyperk</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">cparam</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">output</span><span class="p">[</span><span class="n">ms</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">str</span><span class="p">(</span><span class="n">thisspw</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">jyperk</span><span class="p">[(</span><span class="n">spw</span> <span class="o">==</span> <span class="n">thisspw</span><span class="p">)])</span> <span class="k">for</span> <span class="n">thisspw</span> <span class="ow">in</span> <span class="n">spw</span> <span class="k">if</span> <span class="n">thisspw</span> <span class="ow">in</span> <span class="n">spwsetup</span><span class="p">[</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="selectModelParams">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.selectModelParams.html#pipeline.extern.SDcalatmcorr.selectModelParams">[docs]</a>
<span class="k">def</span> <span class="nf">selectModelParams</span><span class="p">(</span><span class="n">mslist</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">jyperkfactor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">decisionmetric</span> <span class="o">=</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span>
                      <span class="n">iant</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">atmtype</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="n">maxalt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">120</span><span class="p">],</span> 
                      <span class="n">lapserate</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">5.6</span><span class="p">],</span> <span class="n">scaleht</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="p">],</span> <span class="n">resultsfile</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plotsfolder</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">forcespws</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">forcefield</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">forcemetricline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">blinedeg</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">blinenclip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
                      <span class="n">blinensigma</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">maxonlyspw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                      <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">diffsmooth</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">,</span> <span class="n">psize</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">isize</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
                      <span class="n">defatmtype</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">defmaxalt</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">deflapserate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">defscaleht</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                      <span class="n">plotbline</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Positional parameters: mslist, context</span>
<span class="sd">    mslist: List of MS filenames to be processed.</span>
<span class="sd">    context: Pipeline context associated to this reduction.</span>
<span class="sd">    decisionmetric: Metric to use to take the decision on best model selection,</span>
<span class="sd">    options:&#39;maxabs&#39; (Maximum of absolute residual value, calculated after baseline subtraction),</span>
<span class="sd">            &#39;intabs&#39; (integral of absolute residual value, calculated after baseline subtraction),</span>
<span class="sd">            &#39;maxabsdiff&#39; (Maximum absolute value of residual derivative)</span>
<span class="sd">            &#39;intabsdiff&#39; (integral of absolute value of residual derivative)</span>
<span class="sd">            &#39;intsqdiff&#39; (integral of square value of residual derivative)</span>
<span class="sd">    Quantities are calculate over a selection of channels around the skylines.</span>
<span class="sd">    iant, atmtype, maxalt, lapserate, scaleht: see parameters description in atmcorr()</span>
<span class="sd">    defatmtype, defmaxalt, deflapserate, defscaleht: Parameters for default model in case no best fit is possible.</span>
<span class="sd">    minpeaklevel: Comparative minimum depth of an atmospheric line (as measured in the optical depth tau)</span>
<span class="sd">                  to be considered while searching for sky lines. Will only consider lines above this threshold.</span>
<span class="sd">                  This parameters is given in units relative to the median value of tau over the SPW.</span>
<span class="sd">    diffsmooth: Size of smoothing box applied during the calculation of the metrics that use derivatives.</span>
<span class="sd">                Size if given as a fraction of SPW.</span>
<span class="sd">    psize, isize: Point size and image size used for making diagnostic plots.</span>
<span class="sd">    resultsfile: Text output file containing models, metrics calculated and chosen best model.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#Obtain Jy/K factor</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">jyperkfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#from context</span>
        <span class="n">jyperkfactor</span> <span class="o">=</span> <span class="n">getJyperKfromCaltable</span><span class="p">(</span><span class="n">mslist</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">jyperkfactor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Neither jy/K factor dictionary nor pipeline context given as input!!&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not measure atmospheric line residuals, exiting to default...&#39;</span><span class="p">)</span>

    <span class="c1">#Output dictionaries</span>
    <span class="n">models</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bestmodels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fitstatus</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#Default model</span>
    <span class="c1">#Set default atmospheric model in case determination is not possible</span>
    <span class="n">defmodel</span> <span class="o">=</span> <span class="p">(</span><span class="n">defatmtype</span><span class="p">,</span> <span class="n">defmaxalt</span><span class="p">,</span> <span class="n">deflapserate</span><span class="p">,</span> <span class="n">defscaleht</span><span class="p">)</span>

    <span class="c1">#If there is no timestamp, generate new one</span>
    <span class="k">if</span> <span class="n">timestamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">getTimeStamp</span><span class="p">()</span>
    <span class="c1">#If there is no name for the results file, create one</span>
    <span class="k">if</span> <span class="n">resultsfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">resultsfile</span> <span class="o">=</span> <span class="s1">&#39;modelparam_&#39;</span><span class="o">+</span><span class="n">timestamp</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span>
    <span class="c1">#Get info from first MS</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Obtaining metadata for First MS: &#39;</span><span class="o">+</span><span class="n">mslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">spwsetup1</span> <span class="o">=</span> <span class="n">getSpecSetup</span><span class="p">(</span><span class="n">mslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#Set fields to correct</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">forcefield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#Try to obtain representative Field ID, if not possible,</span>
        <span class="c1">#the task will just pick first Field ID</span>
        <span class="n">msobj</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">mslist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">repfield</span><span class="p">,</span> <span class="n">repspw</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_representative_source_spw</span><span class="p">()</span>
        <span class="n">forcefield</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">spwsetup1</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">spwsetup1</span><span class="p">[</span><span class="s1">&#39;namesfor&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="n">repfield</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">forcefield</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
        <span class="c1">#We could not get the fieldid from the context, default to first field</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No context to obtain the representative field from! using first field...&#39;</span><span class="p">)</span>
        <span class="n">forcefield</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">forcefield</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">fieldid</span> <span class="o">=</span> <span class="n">forcefield</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not understand FIELDID=&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">forcefield</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;! Taking first instead...&#39;</span><span class="p">)</span>
        <span class="n">forcefield</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#If the SPW and/or the metric line is force to a value, will keep using it for all MSs</span>
    <span class="n">spwstoprocess</span> <span class="o">=</span> <span class="n">forcespws</span>
    <span class="n">metricskylineids</span> <span class="o">=</span> <span class="n">forcemetricline</span>
    <span class="c1">#Execute correction for all MSes</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="p">(</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">],</span> <span class="n">models</span><span class="p">[</span><span class="n">ms</span><span class="p">],</span> <span class="n">metrics</span><span class="p">[</span><span class="n">ms</span><span class="p">],</span> <span class="n">fitstatus</span><span class="p">[</span><span class="n">ms</span><span class="p">],</span> <span class="n">spwstoprocess</span><span class="p">,</span> <span class="n">metricskylineids</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">atmcorr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">datacolumn</span> <span class="o">=</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">,</span> <span class="n">iant</span> <span class="o">=</span> <span class="n">iant</span><span class="p">,</span> <span class="n">atmtype</span> <span class="o">=</span> <span class="n">atmtype</span><span class="p">,</span> <span class="n">maxalt</span> <span class="o">=</span> <span class="n">maxalt</span><span class="p">,</span> <span class="n">lapserate</span> <span class="o">=</span> <span class="n">lapserate</span><span class="p">,</span>
                    <span class="n">scaleht</span> <span class="o">=</span> <span class="n">scaleht</span><span class="p">,</span> <span class="n">jyperkfactor</span> <span class="o">=</span> <span class="n">jyperkfactor</span><span class="p">,</span> <span class="n">dobackup</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">forcespws</span> <span class="o">=</span> <span class="n">spwstoprocess</span><span class="p">,</span> <span class="n">plotsfolder</span> <span class="o">=</span> <span class="n">plotsfolder</span><span class="p">,</span>
                    <span class="n">forcefield</span> <span class="o">=</span> <span class="n">forcefield</span><span class="p">,</span> <span class="n">forcemetricline</span> <span class="o">=</span> <span class="n">metricskylineids</span><span class="p">,</span> <span class="n">blinedeg</span> <span class="o">=</span> <span class="n">blinedeg</span><span class="p">,</span> <span class="n">blinenclip</span> <span class="o">=</span> <span class="n">blinenclip</span><span class="p">,</span>
                    <span class="n">blinensigma</span> <span class="o">=</span> <span class="n">blinensigma</span><span class="p">,</span> <span class="n">maxonlyspw</span> <span class="o">=</span> <span class="n">maxonlyspw</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="n">minpeaklevel</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">,</span>
                    <span class="n">diffsmooth</span> <span class="o">=</span> <span class="n">diffsmooth</span><span class="p">,</span> <span class="n">psize</span> <span class="o">=</span> <span class="n">psize</span><span class="p">,</span> <span class="n">isize</span> <span class="o">=</span> <span class="n">isize</span><span class="p">,</span> <span class="n">plotbline</span> <span class="o">=</span> <span class="n">plotbline</span><span class="p">,</span>
                    <span class="n">defatmtype</span><span class="o">=</span><span class="n">defatmtype</span><span class="p">,</span> <span class="n">defmaxalt</span><span class="o">=</span><span class="n">defmaxalt</span><span class="p">,</span> <span class="n">deflapserate</span><span class="o">=</span><span class="n">deflapserate</span><span class="p">,</span> <span class="n">defscaleht</span><span class="o">=</span><span class="n">defscaleht</span><span class="p">,</span>
                    <span class="n">decisionmetric</span> <span class="o">=</span> <span class="n">decisionmetric</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;metrics: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bestmodels: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">bestmodels</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fitstatus: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">fitstatus</span><span class="p">))</span>

    <span class="n">ms1</span> <span class="o">=</span> <span class="n">mslist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">ms1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">f1</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">paramnames</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
    <span class="n">metricnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">f1</span><span class="p">][</span><span class="n">s1</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="k">if</span> <span class="s1">&#39;err&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
    <span class="n">nmodels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">])</span>

    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resultsfile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="c1">#Write summary of results</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#Summary of resulting best models</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#MS,FieldID,SPW,&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paramnames</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,fitstatus&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1">,</span><span class="si">{1:d}</span><span class="s1">,</span><span class="si">{2:d}</span><span class="s1">,</span><span class="si">{3:d}</span><span class="s1">,</span><span class="si">{4:.6f}</span><span class="s1">,</span><span class="si">{5:.6f}</span><span class="s1">,</span><span class="si">{6:.6f}</span><span class="s1">,</span><span class="si">{7:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span><span class="n">f1</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">fitstatus</span><span class="p">[</span><span class="n">ms</span><span class="p">]))</span>

    <span class="c1">#All models should be the same for all MSs, so let&#39;s just print the first one (?)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#List of models attempted</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#Nmodel,&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">paramnames</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:d}</span><span class="s1">,</span><span class="si">{1:d}</span><span class="s1">,</span><span class="si">{2:.6f}</span><span class="s1">,</span><span class="si">{3:.6f}</span><span class="s1">,</span><span class="si">{4:.6f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span><span class="n">models</span><span class="p">[</span><span class="n">ms1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">3</span><span class="p">]))</span>

    <span class="c1">#Write results for the metrics</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#Metrics results</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#MS,Nmodel,&#39;</span><span class="o">+</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1">,</span><span class="si">{1:s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">met</span><span class="p">,</span> <span class="n">met</span><span class="o">+</span><span class="s1">&#39;err&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metricnames</span><span class="p">]))</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">):</span>
            <span class="n">mdata</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{0:.6f}</span><span class="s1">,</span><span class="si">{1:.8f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metrics</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="n">f1</span><span class="p">][</span><span class="n">s1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">met</span><span class="p">],</span><span class="n">metrics</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="n">f1</span><span class="p">][</span><span class="n">s1</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="n">met</span><span class="o">+</span><span class="s1">&#39;err&#39;</span><span class="p">])</span> <span class="k">for</span> <span class="n">met</span> <span class="ow">in</span> <span class="n">metricnames</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ms,m,mdata=</span><span class="si">{0:s}</span><span class="s1"> </span><span class="si">{1:d}</span><span class="s1"> </span><span class="si">{2:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">mdata</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0:s}</span><span class="s1">,</span><span class="si">{1:d}</span><span class="s1">,</span><span class="si">{2:s}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">mdata</span><span class="p">))</span>

    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">bestmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">fitstatus</span><span class="p">)</span></div>


<div class="viewcode-block" id="getSBData">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getSBData.html#pipeline.extern.SDcalatmcorr.getSBData">[docs]</a>
<span class="k">def</span> <span class="nf">getSBData</span><span class="p">(</span><span class="n">asdm</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">asdm</span><span class="o">+</span><span class="s1">&#39;/SBSummary.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">sbuid</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;EntityRef&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;SchedBlock&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
            <span class="n">sbuid</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">sqlfmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;SELECT PRJ_ARCHIVE_UID, PRJ_CODE, MOUS_STATUS_UID, ARCHIVE_UID AS SB_UID, SB_NAME FROM (SELECT PRJ_ARCHIVE_UID, PRJ_CODE FROM ALMA.BMMV_OBSPROJECT) JOIN (SELECT ARCHIVE_UID, PRJ_REF, MOUS_STATUS_UID, SB_STATUS_UID, SB_NAME FROM ALMA.BMMV_SCHEDBLOCK WHERE ARCHIVE_UID = &#39;*SBUID*&#39;) ON PRJ_ARCHIVE_UID = PRJ_REF&quot;&quot;&quot;</span>
    <span class="n">sql</span> <span class="o">=</span> <span class="n">sqlfmt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*SBUID*&#39;</span><span class="p">,</span> <span class="n">sbuid</span><span class="p">)</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">almaoracleauth</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Querying the archive for : &#39;</span><span class="o">+</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="getTimeStamp">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.getTimeStamp.html#pipeline.extern.SDcalatmcorr.getTimeStamp">[docs]</a>
<span class="k">def</span> <span class="nf">getTimeStamp</span><span class="p">(</span><span class="n">timefmt</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:04d}{1:02d}{2:02d}{3:02d}{4:02d}{5:02d}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="c1">#Get timestamp for output folders and files</span>
    <span class="n">aux</span> <span class="o">=</span> <span class="n">systime</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timefmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aux</span><span class="o">.</span><span class="n">tm_year</span><span class="p">,</span> <span class="n">aux</span><span class="o">.</span><span class="n">tm_mon</span><span class="p">,</span> <span class="n">aux</span><span class="o">.</span><span class="n">tm_mday</span><span class="p">,</span> <span class="n">aux</span><span class="o">.</span><span class="n">tm_hour</span><span class="p">,</span> <span class="n">aux</span><span class="o">.</span><span class="n">tm_min</span><span class="p">,</span> <span class="n">aux</span><span class="o">.</span><span class="n">tm_sec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timestamp</span></div>


<div class="viewcode-block" id="redPipeSDatmcorr">
<a class="viewcode-back" href="../../../_autosummary/pipeline.extern.SDcalatmcorr.redPipeSDatmcorr.html#pipeline.extern.SDcalatmcorr.redPipeSDatmcorr">[docs]</a>
<span class="k">def</span> <span class="nf">redPipeSDatmcorr</span><span class="p">(</span><span class="n">iant</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">atmtype</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                     <span class="n">maxalt</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">lapserate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.6</span><span class="p">,</span> <span class="n">scaleht</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">decisionmetric</span> <span class="o">=</span> <span class="s1">&#39;intabsdiff&#39;</span><span class="p">,</span>
                     <span class="n">dobackup</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">pcode</span> <span class="o">=</span> <span class="s1">&#39;0000.1.00000.S&#39;</span><span class="p">,</span> <span class="n">mousstatusuid</span> <span class="o">=</span> <span class="s1">&#39;uid://A000/X000/X000&#39;</span><span class="p">,</span>
                     <span class="n">metricspws</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metricfield</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metricline</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">diffsmooth</span> <span class="o">=</span> <span class="mf">0.002</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39; Task to run SD pipeline, applying CSV-3320 correction for atmospheric lines</span>
<span class="sd">    between stage hsd_applycal and hsd_baseline.</span>
<span class="sd">    Keyword arguments:</span>
<span class="sd">    iant: Antenna number to get pointing direction (antenna having mount issues should</span>
<span class="sd">    be avoided). Default is 0.</span>
<span class="sd">    amttype: Atmosphere type paremeter for model in at module (1: tropical, 2: mid lat summer,</span>
<span class="sd">    3: mid lat winter, etc). Default is list [1, 2, 3, 4]</span>
<span class="sd">    maxalt: maxAltitude parameter for model, in km. default is 120 (km)</span>
<span class="sd">    lapserate: Lapse Rate dTem_dh parameter for at (lapse rate; K/km). Default is -5.6</span>
<span class="sd">    scaleht: h0 parameter for at (water scale height; km). Default is 2.0</span>
<span class="sd">    decisionmetric: Metric to use to take the decision on best model selection (see selectModelParams())</span>
<span class="sd">    metricspws: List of SPWs to use for model selection. Parameter gets passed to task selectModelParams() as forcespws.</span>
<span class="sd">    metricfield: List of Field to use for model selection. Currently only supported one. </span>
<span class="sd">    Parameter gets passed to task selectModelParams() as forcefield.</span>
<span class="sd">    dobackup: Whether to do a backup of the MS before applying the correction.</span>
<span class="sd">    (True/False) Default is True</span>
<span class="sd">    pcode: Project Code to enter into the pipeline context.</span>
<span class="sd">    mousstatusuid: MOUS status uid to enter into the pipeline context.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pipeline.h.cli</span> <span class="kn">import</span> <span class="n">h_init</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_importdata</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_flagdata</span>
    <span class="kn">from</span> <span class="nn">pipeline.h.cli</span> <span class="kn">import</span> <span class="n">h_tsyscal</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_tsysflag</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_skycal</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_k2jycal</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_applycal</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_atmcor</span>
    <span class="kn">from</span> <span class="nn">pipeline.h.cli</span> <span class="kn">import</span> <span class="n">h_resume</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_baseline</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_blflag</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_imaging</span>
    <span class="kn">from</span> <span class="nn">pipeline.hsd.cli</span> <span class="kn">import</span> <span class="n">hsd_exportdata</span>
    <span class="kn">from</span> <span class="nn">pipeline.h.cli</span> <span class="kn">import</span> <span class="n">h_save</span>

    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">getTimeStamp</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pipelineloaded</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pipeline tasks not available!&#39;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">uidfilelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;uid___*&#39;</span><span class="p">)</span>
    <span class="n">asdmlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">uidfilelist</span> <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Found the following ASDMs: &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">asdmlist</span><span class="p">))</span>
    <span class="c1">#Create the working folder...</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mkdir working&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">asdm</span> <span class="ow">in</span> <span class="n">asdmlist</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;ln -s ../&#39;</span><span class="o">+</span><span class="n">asdm</span><span class="o">+</span><span class="s1">&#39; working/&#39;</span><span class="o">+</span><span class="n">asdm</span><span class="p">)</span>
    <span class="c1">#es = aU.stuffForScienceDataReduction()</span>
    <span class="c1">#Get Project Code and MOUS uid to enter dat into the context</span>
    <span class="k">if</span> <span class="n">accessarchive</span><span class="p">:</span>
        <span class="p">(</span><span class="n">prjuid</span><span class="p">,</span> <span class="n">pcode</span><span class="p">,</span> <span class="n">mousstatusuid</span><span class="p">,</span> <span class="n">sbuid</span><span class="p">,</span> <span class="n">sbname</span><span class="p">)</span> <span class="o">=</span> <span class="n">getSBData</span><span class="p">(</span><span class="n">asdmlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Could not access ALMA oracle database, set Project Code and MOUS uid manually.&#39;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;working&#39;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">h_init</span><span class="p">()</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s1">&#39;ProjectSummary&#39;</span><span class="p">,</span> <span class="s1">&#39;proposal_code&#39;</span><span class="p">,</span> <span class="n">pcode</span><span class="p">)</span>
    <span class="c1">#context.set_state(&#39;ProjectSummary&#39;, &#39;piname&#39;, &#39;unknown&#39;)</span>
    <span class="c1">#context.set_state(&#39;ProjectSummary&#39;, &#39;proposal_title&#39;, &#39;unknown&#39;)</span>
    <span class="c1">#context.set_state(&#39;ProjectStructure&#39;, &#39;ous_part_id&#39;, &#39;X0&#39;)</span>
    <span class="c1">#context.set_state(&#39;ProjectStructure&#39;, &#39;ous_title&#39;, &#39;Undefined&#39;)</span>
    <span class="c1">#context.set_state(&#39;ProjectStructure&#39;, &#39;ppr_file&#39;, &#39;&#39;)</span>
    <span class="c1">#context.set_state(&#39;ProjectStructure&#39;, &#39;ps_entity_id&#39;, &#39;&#39;)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s1">&#39;ProjectStructure&#39;</span><span class="p">,</span> <span class="s1">&#39;recipe_name&#39;</span><span class="p">,</span> <span class="s1">&#39;hsd_calimage&#39;</span><span class="p">)</span>
    <span class="c1">#context.set_state(&#39;ProjectStructure&#39;, &#39;ous_entity_id&#39;, &#39;&#39;)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="s1">&#39;ProjectStructure&#39;</span><span class="p">,</span> <span class="s1">&#39;ousstatus_entity_id&#39;</span><span class="p">,</span> <span class="n">mousstatusuid</span><span class="p">)</span>

    <span class="c1">#Import ASDM and start pipeline</span>
    <span class="n">hsd_importdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">asdmlist</span><span class="p">)</span>
    <span class="c1">#Obtain the Jy/K factors</span>
    <span class="c1">#mslist = glob.glob(&#39;uid___*.ms&#39;)</span>
    <span class="n">mslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">]</span>

    <span class="c1">#Deactivated Jy/K factor from es.</span>
    <span class="c1">#print(&#39;Obtaining Jy/K factors for MSs: &#39;+str(mslist))</span>
    <span class="c1">#es.getJyPerK(mslist)</span>
    <span class="c1">#Continue pipeline</span>
    <span class="n">hsd_flagdata</span><span class="p">()</span>
    <span class="n">h_tsyscal</span><span class="p">()</span>
    <span class="n">hsd_tsysflag</span><span class="p">()</span>
    <span class="n">hsd_skycal</span><span class="p">()</span>
    <span class="n">hsd_k2jycal</span><span class="p">()</span>
    <span class="n">hsd_applycal</span><span class="p">()</span>

    <span class="c1">###Correct atmospheric ozone lines###</span>
    <span class="c1">### following recipe in CSV-3320  ###</span>
    <span class="c1">#Read in Jy/K factor from the CSV file (DEACTIVATED)</span>
    <span class="c1">#jyperkfactor = getJyperKfromCSV()</span>

    <span class="c1">###Run correction routine in &#39;try&#39; mode to compute best model to use among the list given###</span>
    <span class="p">(</span><span class="n">bestmodels</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">fitstatus</span><span class="p">)</span> <span class="o">=</span> <span class="n">selectModelParams</span><span class="p">(</span><span class="n">mslist</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="p">,</span> <span class="n">decisionmetric</span> <span class="o">=</span> <span class="n">decisionmetric</span><span class="p">,</span>
                                                                 <span class="n">iant</span> <span class="o">=</span> <span class="n">iant</span><span class="p">,</span> <span class="n">atmtype</span> <span class="o">=</span> <span class="n">atmtype</span><span class="p">,</span>
                                                                 <span class="n">maxalt</span> <span class="o">=</span> <span class="n">maxalt</span><span class="p">,</span> <span class="n">lapserate</span> <span class="o">=</span> <span class="n">lapserate</span><span class="p">,</span> <span class="n">scaleht</span> <span class="o">=</span> <span class="n">scaleht</span><span class="p">,</span>
                                                                 <span class="n">forcespws</span> <span class="o">=</span> <span class="n">metricspws</span><span class="p">,</span> <span class="n">forcefield</span> <span class="o">=</span> <span class="n">metricfield</span><span class="p">,</span>
                                                                 <span class="n">forcemetricline</span> <span class="o">=</span> <span class="n">metricline</span><span class="p">,</span> <span class="n">diffsmooth</span> <span class="o">=</span> <span class="n">diffsmooth</span><span class="p">,</span>
                                                                 <span class="n">minpeaklevel</span> <span class="o">=</span> <span class="n">minpeaklevel</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">)</span>

    <span class="c1">#NEW, using hsd_atmcor()</span>
    <span class="n">atmtypelist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">]</span>
    <span class="n">dtem_dhlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;K/km&#39;</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">]</span>
    <span class="n">h0list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">bestmodels</span><span class="p">[</span><span class="n">ms</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;km&#39;</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mslist</span><span class="p">]</span>
    <span class="n">hsd_atmcor</span><span class="p">(</span><span class="n">infiles</span><span class="o">=</span><span class="n">mslist</span><span class="p">,</span><span class="n">atmtype</span><span class="o">=</span><span class="n">atmtypelist</span><span class="p">,</span><span class="n">dtem_dh</span><span class="o">=</span><span class="n">dtem_dhlist</span><span class="p">,</span><span class="n">h0</span><span class="o">=</span><span class="n">h0list</span><span class="p">)</span>

    <span class="c1">### Finish ATM correction ###</span>

    <span class="c1">#Continue pipeline execution from sdbaseline stage</span>
    <span class="n">hsd_baseline</span><span class="p">()</span>
    <span class="n">hsd_blflag</span><span class="p">()</span>
    <span class="n">hsd_baseline</span><span class="p">()</span>
    <span class="n">hsd_blflag</span><span class="p">()</span>
    <span class="n">hsd_imaging</span><span class="p">()</span>
    <span class="n">hsd_exportdata</span><span class="p">()</span>
    <span class="n">h_save</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>

    <span class="k">return</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>