

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hsd.tasks.baselineflag.worker &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hsd.tasks.baselineflag.worker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hsd.tasks.baselineflag.worker</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.vdp</span> <span class="k">as</span> <span class="nn">vdp</span>
<span class="kn">from</span> <span class="nn">pipeline.domain</span> <span class="kn">import</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">MeasurementSet</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.datatable</span> <span class="kn">import</span> <span class="n">OnlineFlagIndex</span><span class="p">,</span> <span class="n">TsysFlagIndex</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">sdutils</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tasks</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">.SDFlagRule</span> <span class="kn">import</span> <span class="n">INVALID_STAT</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SDBLFlagWorkerInputs">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorkerInputs">[docs]</a>
<span class="k">class</span> <span class="nc">SDBLFlagWorkerInputs</span><span class="p">(</span><span class="n">vdp</span><span class="o">.</span><span class="n">StandardInputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inputs for imaging worker</span>
<span class="sd">    NOTE: infile should be a complete list of MSes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Search order of input vis</span>
    <span class="n">processing_data_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">DataType</span><span class="o">.</span><span class="n">BASELINED</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">ATMCORR</span><span class="p">,</span>
                            <span class="n">DataType</span><span class="o">.</span><span class="n">REGCAL_CONTLINE_ALL</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">RAW</span> <span class="p">]</span>

    <span class="n">edge</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">clip_niteration</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">antenna_list</span><span class="p">,</span> <span class="n">fieldid_list</span><span class="p">,</span> <span class="n">spwid_list</span><span class="p">,</span> <span class="n">pols_list</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span>
                 <span class="n">flagRule</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SDBLFlagWorkerInputs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_niteration</span> <span class="o">=</span> <span class="n">clip_niteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antenna_list</span> <span class="o">=</span> <span class="n">antenna_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldid_list</span> <span class="o">=</span> <span class="n">fieldid_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spwid_list</span> <span class="o">=</span> <span class="n">spwid_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pols_list</span> <span class="o">=</span> <span class="n">pols_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flagRule</span> <span class="o">=</span> <span class="n">flagRule</span>
        <span class="c1"># not used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">nchan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">bl_ms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MeasurementSet domain object of baselined MS.&quot;&quot;&quot;</span>
        <span class="n">bl_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">([</span><span class="n">DataType</span><span class="o">.</span><span class="n">BASELINED</span><span class="p">])</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">match_origin_ms</span><span class="p">(</span><span class="n">bl_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match</span></div>


<div class="viewcode-block" id="SDBLFlagWorkerResults">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorkerResults">[docs]</a>
<span class="k">class</span> <span class="nc">SDBLFlagWorkerResults</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SingleDishResults</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outcome</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SDBLFlagWorkerResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">outcome</span><span class="p">)</span>

<div class="viewcode-block" id="SDBLFlagWorkerResults.merge_with_context">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorkerResults.merge_with_context">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_with_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SDBLFlagWorkerResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">merge_with_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_outcome_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>



<div class="viewcode-block" id="BLFlagTableContainer">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.BLFlagTableContainer">[docs]</a>
<span class="k">class</span> <span class="nc">BLFlagTableContainer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container class to store table tools of two MSes.</span>

<span class="sd">    The class stores two table tools for two MSes normally for calibrated and</span>
<span class="sd">    baselined ones.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ms: A MS domain object (normally calibrated MS)</span>
<span class="sd">        bl_ms: A MS domain object (normally baselined MS)</span>
<span class="sd">        tb1: A table tool instance that accesses ms</span>
<span class="sd">        tb2: A table tool instance that accesses bl_ms</span>
<span class="sd">        is_baselined: True if ms has baselined at least once</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tb1</span><span class="p">,</span> <span class="n">tb2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize BLFlagTableContainer class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span> <span class="o">=</span> <span class="n">tb1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span> <span class="o">=</span> <span class="n">tb2</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">calvis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a name of calibrated MS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb1</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">blvis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a name of baselined MS.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tb2</span><span class="o">.</span><span class="n">name</span><span class="p">()</span></div>


<div class="viewcode-block" id="open_cal_bl_tables">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.open_cal_bl_tables">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">open_cal_bl_tables</span><span class="p">(</span>
        <span class="n">ms</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">,</span><span class="n">bl_ms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MeasurementSet</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">BLFlagTableContainer</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield BLFlagTableContainer.</span>

<span class="sd">    BLflagTableContainer contains two tables of MSes before and after baseline</span>
<span class="sd">    subtraction. The tables will be closed in the second iteration.</span>

<span class="sd">    Args:</span>
<span class="sd">        ms: MS domain object of MS before baseline subtraction</span>
<span class="sd">        bl_ms: MS domain object of MS after baseline subtraction</span>

<span class="sd">    Yields:</span>
<span class="sd">        BLFlagTableContainer instance that holds table tool instances</span>
<span class="sd">        of given ms and bl_ms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tb1</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">_logging_table_cls</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">bl_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tb2</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">_logging_table_cls</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tb2</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tb1</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tb2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tb2</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">bl_ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">yield</span> <span class="n">BLFlagTableContainer</span><span class="p">(</span><span class="n">tb1</span><span class="p">,</span> <span class="n">tb2</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">tb1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tb2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tb2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="SDBLFlagWorker">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker">[docs]</a>
<span class="k">class</span> <span class="nc">SDBLFlagWorker</span><span class="p">(</span><span class="n">basetask</span><span class="o">.</span><span class="n">StandardTaskTemplate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The worker class of single dish flagging task.</span>
<span class="sd">    This class defines per spwid flagging operation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">SDBLFlagWorkerInputs</span>

    <span class="n">is_multi_vis_task</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_search_datacol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns data column name to process. Returns None if not found.</span>
<span class="sd">        The search order is [&#39;CORRECTED_DATA&#39;, &#39;FLOAT_DATA&#39;, &#39;DATA&#39;]</span>

<span class="sd">        Argument: table tool object of MS to search a data column for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">col_found</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">col_list</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOAT_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_list</span><span class="p">:</span>
                <span class="n">col_found</span> <span class="o">=</span> <span class="n">col</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">col_found</span>

<div class="viewcode-block" id="SDBLFlagWorker.prepare">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.prepare">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invoke single dish flagging based on statistics of spectra.</span>
<span class="sd">        Iterates over antenna and polarization for a certain spw ID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span>
        <span class="n">clip_niteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">clip_niteration</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ms</span>
        <span class="n">antid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna_list</span>
        <span class="n">fieldid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fieldid_list</span>
        <span class="n">spwid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spwid_list</span>
        <span class="n">pols_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">pols_list</span>
        <span class="n">flagRule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">flagRule</span>
        <span class="n">edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">edge</span>
        <span class="n">datatable_name</span> <span class="o">=</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">get_data_table_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">datatable</span> <span class="o">=</span> <span class="n">DataTable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">datatable_name</span><span class="p">,</span> <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">bl_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bl_ms</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bl_ms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ms</span>
        <span class="n">bl_name</span> <span class="o">=</span> <span class="n">bl_ms</span><span class="o">.</span><span class="n">name</span>
        <span class="n">row_map_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_row_map</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">row_map_bl_ms</span> <span class="o">=</span> <span class="n">row_map_ms</span> <span class="k">if</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="n">bl_name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_row_map</span><span class="p">(</span><span class="n">bl_name</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Members to be processed in worker class:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">antid_list</span><span class="p">,</span> <span class="n">fieldid_list</span><span class="p">,</span> <span class="n">spwid_list</span><span class="p">,</span> <span class="n">pols_list</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">%s</span><span class="s1">: Antenna </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%d</span><span class="s1"> Spw </span><span class="si">%d</span><span class="s1"> Pol </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="c1"># TODO: make sure baseline subtraction is already done</span>
        <span class="c1"># filename for before/after baseline</span>
        <span class="n">ThreNewRMS</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;RmsPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">ThreOldRMS</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;RmsPreFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">ThreNewDiff</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;RunMeanPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">ThreOldDiff</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;RunMeanPreFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">ThreTsys</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;TsysFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">Threshold</span> <span class="o">=</span> <span class="p">[</span><span class="n">ThreNewRMS</span><span class="p">,</span> <span class="n">ThreOldRMS</span><span class="p">,</span> <span class="n">ThreNewDiff</span><span class="p">,</span> <span class="n">ThreOldDiff</span><span class="p">,</span> <span class="n">ThreTsys</span><span class="p">]</span>
        <span class="c1">#ThreExpectedRMSPreFit = flagRule[&#39;RmsExpectedPreFitFlag&#39;][&#39;Threshold&#39;]</span>
        <span class="c1">#ThreExpectedRMSPostFit = flagRule[&#39;RmsExpectedPostFitFlag&#39;][&#39;Threshold&#39;]</span>
        <span class="c1"># WARN: ignoring the value set as flagRule[&#39;RunMeanPostFitFlag&#39;][&#39;Nmean&#39;]</span>
        <span class="n">nmean</span> <span class="o">=</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;RunMeanPreFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Nmean&#39;</span><span class="p">]</span>
<span class="c1">#         # out table name</span>
<span class="c1">#         namer = filenamer.BaselineSubtractedTable()</span>
<span class="c1">#         namer.spectral_window(spwid)</span>

        <span class="n">flagSummary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">inpfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">with_masklist</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># loop over members (practically, per antenna loop in an MS)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">pollist</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">antid_list</span><span class="p">,</span> <span class="n">fieldid_list</span><span class="p">,</span> <span class="n">spwid_list</span><span class="p">,</span> <span class="n">pols_list</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Performing flag for </span><span class="si">%s</span><span class="s1"> Antenna </span><span class="si">%d</span><span class="s1"> Field </span><span class="si">%d</span><span class="s1"> Spw </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>

            <span class="n">filename_in</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span>
            <span class="n">filename_out</span> <span class="o">=</span> <span class="n">bl_name</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span><span class="o">.</span><span class="n">num_channels</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;*** Processing: </span><span class="si">{}</span><span class="s2"> ***&quot;</span> <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Field </span><span class="si">{}</span><span class="s1"> Antenna </span><span class="si">{}</span><span class="s1"> Spw </span><span class="si">{}</span><span class="s1"> Pol </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pollist</span><span class="p">)))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">pre-fit table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename_in</span><span class="p">)))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">post-fit table: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename_out</span><span class="p">)))</span>

            <span class="c1"># deviation mask</span>
            <span class="n">deviation_mask</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">deviation_mask</span><span class="p">[(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)]</span> \
                <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="s1">&#39;deviation_mask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;deviation mask for </span><span class="si">%s</span><span class="s1"> antenna </span><span class="si">%d</span><span class="s1"> field </span><span class="si">%d</span><span class="s1"> spw </span><span class="si">%d</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                      <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">deviation_mask</span><span class="p">))</span>

            <span class="n">time_table</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">get_timetable</span><span class="p">(</span><span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">),</span> <span class="n">fieldid</span><span class="p">)</span>
            <span class="c1"># Select time gap list: &#39;subscan&#39;: large gap; &#39;raster&#39;: small gap</span>
            <span class="k">if</span> <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;Flagging&#39;</span><span class="p">][</span><span class="s1">&#39;ApplicableDuration&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;subscan&quot;</span><span class="p">:</span>
                <span class="n">TimeTable</span> <span class="o">=</span> <span class="n">time_table</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">TimeTable</span> <span class="o">=</span> <span class="n">time_table</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Applied time bin for the running mean calculation: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                     <span class="n">flagRule</span><span class="p">[</span><span class="s1">&#39;Flagging&#39;</span><span class="p">][</span><span class="s1">&#39;ApplicableDuration&#39;</span><span class="p">])</span>
            <span class="n">flagRule_local</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">flagRule</span><span class="p">)</span>
            <span class="c1"># Set is_baselined flag when processing not yet baselined data.</span>
            <span class="n">is_baselined</span> <span class="o">=</span> <span class="p">(</span><span class="n">_get_iteration</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">ms_reduction_group</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;is_baselined = </span><span class="si">{</span><span class="n">is_baselined</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># open table via container</span>
            <span class="k">with</span> <span class="n">open_cal_bl_tables</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">bl_ms</span><span class="p">)</span> <span class="k">as</span> <span class="n">container</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_baselined</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No baseline subtraction operated to </span><span class="si">{}</span><span class="s2"> Field </span><span class="si">{}</span><span class="s2"> Antenna </span><span class="si">{}</span><span class="s2"> Spw </span><span class="si">{}</span><span class="s2">. Skipping flag by post fit&quot;</span>
                                <span class="s2">&quot; spectra.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
                    <span class="c1"># Reset MASKLIST for the non-baselined DataTable</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ResetDataTableMaskList</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">TimeTable</span><span class="p">)</span>
                    <span class="c1"># force disable post fit flagging (not really effective except for flagSummary)</span>
                    <span class="n">flagRule_local</span><span class="p">[</span><span class="s1">&#39;RmsPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;isActive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">flagRule_local</span><span class="p">[</span><span class="s1">&#39;RunMeanPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;isActive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">flagRule_local</span><span class="p">[</span><span class="s1">&#39;RmsExpectedPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;isActive&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># include MASKLIST to cache</span>
                    <span class="n">with_masklist</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;FLAGRULE = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flagRule_local</span><span class="p">))</span>

                <span class="c1"># Calculate Standard Deviation and Diff from running mean</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">ddobj</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">)</span>
                <span class="n">polids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ddobj</span><span class="o">.</span><span class="n">get_polarization_id</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span> <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pollist</span><span class="p">]</span>
                <span class="n">dt_idx</span><span class="p">,</span> <span class="n">tmpdict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcStatistics</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">nmean</span><span class="p">,</span>
                                                         <span class="n">TimeTable</span><span class="p">,</span> <span class="n">polids</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span>
                                                         <span class="n">is_baselined</span><span class="p">,</span> <span class="n">deviation_mask</span><span class="p">,</span>
                                                         <span class="n">row_map_ms</span><span class="p">,</span> <span class="n">row_map_bl_ms</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Standard Deviation and diff calculation End: Elapse time = </span><span class="si">%.1f</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">pol</span><span class="p">,</span> <span class="n">polid</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pollist</span><span class="p">,</span> <span class="n">polids</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;[ POL=</span><span class="si">%s</span><span class="s2"> ]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pol</span><span class="p">))</span>

                <span class="n">tmpdata</span> <span class="o">=</span> <span class="n">tmpdict</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;tmpdata.shape=</span><span class="si">%s</span><span class="s1">, len(Threshold)=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmpdata</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">Threshold</span><span class="p">)))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating the thresholds by Standard Deviation and Diff from running mean of Pre/Post fit.&#39;</span>
                         <span class="s1">&#39; (Iterate </span><span class="si">%d</span><span class="s1"> times)&#39;</span> <span class="o">%</span> <span class="n">clip_niteration</span><span class="p">)</span>
                <span class="n">stat_flag</span><span class="p">,</span> <span class="n">final_thres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flag_from_stats</span><span class="p">(</span><span class="n">tmpdata</span><span class="p">,</span> <span class="n">Threshold</span><span class="p">,</span> <span class="n">clip_niteration</span><span class="p">,</span> <span class="n">is_baselined</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;final threshold shape = </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_thres</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final thresholds: StdDev (pre-/post-fit) = </span><span class="si">%.2f</span><span class="s1"> / </span><span class="si">%.2f</span><span class="s1"> , Diff StdDev (pre-/post-fit) =&#39;</span>
                         <span class="s1">&#39; </span><span class="si">%.2f</span><span class="s1"> / </span><span class="si">%.2f</span><span class="s1"> , Tsys=</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">final_thres</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]))</span>
                <span class="c1">#del tmpdata, _</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_apply_stat_flag</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">stat_flag</span><span class="p">)</span>

                <span class="c1"># flag by Expected RMS</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flagExpectedRMS</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span>
                                     <span class="n">FlagRule</span><span class="o">=</span><span class="n">flagRule_local</span><span class="p">,</span> <span class="n">is_baselined</span><span class="o">=</span><span class="n">is_baselined</span><span class="p">)</span>

                <span class="c1"># Check every flags to create summary flag</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">flagSummary</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">dt_idx</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">flagRule_local</span><span class="p">)</span>
                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Apply flags End: Elapse time = </span><span class="si">%.1f</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>

<span class="c1">#                 # store statistics and flag information to bl.tbl</span>
<span class="c1">#                 self.save_outtable(datatable, dt_idx, out_table_name)</span>
                <span class="n">flagSummary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;msname&#39;</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;antenna&#39;</span><span class="p">:</span> <span class="n">antid</span><span class="p">,</span>
                                    <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">fieldid</span><span class="p">,</span> <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="n">spwid</span><span class="p">,</span> <span class="s1">&#39;pol&#39;</span><span class="p">:</span> <span class="n">pol</span><span class="p">,</span>
                                    <span class="s1">&#39;result_threshold&#39;</span><span class="p">:</span> <span class="n">final_thres</span><span class="p">,</span>
                                    <span class="s1">&#39;baselined&#39;</span><span class="p">:</span> <span class="n">is_baselined</span><span class="p">})</span>

            <span class="c1"># Generate flag command file</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_ant</span><span class="si">%d</span><span class="s2">_field</span><span class="si">%d</span><span class="s2">_spw</span><span class="si">%d</span><span class="s2">_blflag.txt&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">bl_ms</span><span class="o">.</span><span class="n">basename</span><span class="p">),</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
            <span class="n">do_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generateFlagCommandFile</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="n">bl_ms</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">pollist</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Failed to create flag command file </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">do_flag</span><span class="p">:</span>
                <span class="n">inpfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No flag command in </span><span class="si">%s</span><span class="s2">. Skip flagging.&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inpfiles</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">flagdata_apply_job</span> <span class="o">=</span> <span class="n">casa_tasks</span><span class="o">.</span><span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">filename_out</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                                                     <span class="n">inpfile</span><span class="o">=</span><span class="n">inpfiles</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;apply&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flagdata_apply_job</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No flag command for </span><span class="si">{}</span><span class="s2">. Skip flagging.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;PROFILE execute: elapsed time is </span><span class="si">%s</span><span class="s1"> sec&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">))</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="s1">&#39;NMASK&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">with_masklist</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">)</span>
        <span class="c1"># Need to flush changes to disk</span>
        <span class="n">datatable</span><span class="o">.</span><span class="n">exportdata</span><span class="p">(</span><span class="n">minimal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">SDBLFlagWorkerResults</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
                                       <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">outcome</span><span class="o">=</span><span class="n">flagSummary</span><span class="p">)</span>
<span class="c1">#         return flagSummary</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.analyse">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.analyse">[docs]</a>
    <span class="k">def</span> <span class="nf">analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.get_row_map">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.get_row_map">[docs]</a>
    <span class="k">def</span> <span class="nf">get_row_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return row map between vis and origin_ms&quot;&quot;&quot;</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">origin_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">make_row_map_between_ms</span><span class="p">(</span><span class="n">origin_ms</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.calcStatistics">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.calcStatistics">[docs]</a>
    <span class="k">def</span> <span class="nf">calcStatistics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">:</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">BLFlagTableContainer</span><span class="p">,</span>
                       <span class="n">NCHAN</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Nmean</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">TimeTable</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]],</span>
                       <span class="n">polids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">edge</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">is_baselined</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                       <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">rowmapIn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">rowmapOut</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                       <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                  <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate statistics of spectra before and after baseline subtaction.</span>

<span class="sd">        Args:</span>
<span class="sd">            DataTable: DataTable instance of MSes to calculate statistics.</span>
<span class="sd">            container: A BLFlagTableContainer instance that holds table objects</span>
<span class="sd">                of MSes before and after baseline subtaction.</span>
<span class="sd">            NCHAN: Number of channels in a spectrum.</span>
<span class="sd">            Nmean: Number of channels to average to calculate running mean.</span>
<span class="sd">            TimeTable: A grouped list of row IDs in DataTable in a same raster</span>
<span class="sd">                row.</span>
<span class="sd">            polids: Polarization IDs selection.</span>
<span class="sd">            edge: Number of left and right edge channels to be excluded from</span>
<span class="sd">                statistics.</span>
<span class="sd">            is_baselined: Whether or not baseline subtraction has been performed.</span>
<span class="sd">            deviation_mask: Deviation mask ranges. The ranges will be excluded</span>
<span class="sd">                from statistics.</span>
<span class="sd">            rowmapIn: Row map of dictionary of baselined MS.</span>
<span class="sd">            rowmapOut: Row map dictionary of baselined MS.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of DataTable indices, and corresponding statistics and</span>
<span class="sd">            number of flagged channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">DataIn</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">calvis</span>
        <span class="n">DataOut</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">blvis</span>
        <span class="k">if</span> <span class="n">rowmapIn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rowmapIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_row_map</span><span class="p">(</span><span class="n">DataIn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rowmapOut</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rowmapOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_row_map</span><span class="p">(</span><span class="n">DataOut</span><span class="p">)</span>
        <span class="c1"># Calculate Standard Deviation and Diff from running mean</span>
        <span class="n">NROW</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">series</span> <span class="k">for</span> <span class="n">series</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">TimeTable</span><span class="p">)])</span><span class="o">//</span><span class="mi">2</span>
        <span class="c1"># parse edge</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">)</span> <span class="o">=</span> <span class="n">edge</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edgeL</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">edgeR</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculate Standard Deviation and Diff from running mean for Pre/Post fit...&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Processing </span><span class="si">%d</span><span class="s1"> spectra...&#39;</span> <span class="o">%</span> <span class="n">NROW</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nchan for running mean=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Nmean</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Standard deviation and diff calculation Start&#39;</span><span class="p">)</span>

        <span class="n">tbIn</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">tb1</span>
        <span class="n">tbOut</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">tb2</span>
        <span class="n">datacolIn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_datacol</span><span class="p">(</span><span class="n">tbIn</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">datacolIn</span><span class="p">:</span>
            <span class="n">DataIn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">calvis</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Could not find any data column in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">DataIn</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
            <span class="n">datacolOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_search_datacol</span><span class="p">(</span><span class="n">tbOut</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">datacolOut</span><span class="p">:</span>
                <span class="n">DataOut</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">container</span><span class="o">.</span><span class="n">blvis</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Could not find any data column in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">DataOut</span><span class="p">)</span>

        <span class="c1"># Create progress timer</span>
        <span class="c1">#Timer = ProgressTimer(80, NROW, LogLevel)</span>

        <span class="c1"># number of polarizations</span>
        <span class="n">npol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polids</span><span class="p">)</span>

        <span class="c1"># A priori evaluation of output array size</span>
        <span class="n">output_array_size</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">TimeTable</span><span class="p">))</span>
        <span class="n">output_array_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">datatable_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">output_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">statistics_array</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="n">output_array_size</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polids</span><span class="p">)</span>
        <span class="n">num_masked_array</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">p</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">output_array_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polids</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunks</span> <span class="ow">in</span> <span class="n">TimeTable</span><span class="p">:</span>
            <span class="c1"># chunks[0]: row, chunks[1]: index</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Before Fit: Processing spectra = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">chunk</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;chunks[0]= </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">START</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1">### 2011/05/26 shrink the size of data on memory</span>
            <span class="n">SpIn</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">NCHAN</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">SpOut</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">NCHAN</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">FlIn</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">NCHAN</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="n">FlOut</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">NCHAN</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">origin_row</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">data_row_in</span> <span class="o">=</span> <span class="n">rowmapIn</span><span class="p">[</span><span class="n">origin_row</span><span class="p">]</span>
                <span class="n">tmpd</span> <span class="o">=</span> <span class="n">tbIn</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">datacolIn</span><span class="p">,</span> <span class="n">data_row_in</span><span class="p">)</span>
                <span class="n">tmpf</span> <span class="o">=</span> <span class="n">tbIn</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">data_row_in</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">polid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polids</span><span class="p">):</span>
                    <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpd</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
                    <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpf</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
                    <span class="n">data_row_out</span> <span class="o">=</span> <span class="n">rowmapOut</span><span class="p">[</span><span class="n">origin_row</span><span class="p">]</span>
                    <span class="n">tmpd</span> <span class="o">=</span> <span class="n">tbOut</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">datacolOut</span><span class="p">,</span> <span class="n">data_row_out</span><span class="p">)</span>
                    <span class="n">tmpf</span> <span class="o">=</span> <span class="n">tbOut</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">data_row_out</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">polid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polids</span><span class="p">):</span>
                        <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpd</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
                        <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmpf</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span>
                <span class="n">SpIn</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:</span><span class="n">edgeL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">SpOut</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:</span><span class="n">edgeL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">FlIn</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:</span><span class="n">edgeL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span>
                <span class="n">FlOut</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="p">:</span><span class="n">edgeL</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span>
                <span class="k">if</span> <span class="n">edgeR</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">SpIn</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">edgeR</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">SpOut</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">edgeR</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">FlIn</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">edgeR</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">128</span>
                    <span class="n">FlOut</span><span class="p">[:,</span> <span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">edgeR</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">128</span>
            <span class="c1">### loading of the data for one chunk is done</span>

            <span class="n">datatable_index</span><span class="p">[</span><span class="n">output_array_index</span><span class="p">:</span><span class="n">output_array_index</span><span class="o">+</span><span class="n">nrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># loop over polarizations</span>
            <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">polid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">polids</span><span class="p">):</span>

                <span class="n">START</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="c1"># list of valid rows in this chunk</span>
                <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">valid_nrow</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>

                    <span class="c1"># check if current row is valid or not</span>
                    <span class="n">isvalid</span> <span class="o">=</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">valid_indices</span>

                    <span class="c1"># Countup progress timer</span>
                    <span class="c1">#Timer.count()</span>

                    <span class="c1"># Mask out line and edge channels</span>
                    <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="n">tStats</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="n">tStats</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span>

                    <span class="c1"># Calculate Standard Deviation (NOT RMS)</span>
                    <span class="c1">### 2011/05/26 shrink the size of data on memory</span>
                    <span class="n">mask_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">],</span> <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                    <span class="n">mask_out</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">isvalid</span><span class="p">:</span>
                        <span class="c1">#mask_in = self._get_mask_array(masklist, (edgeL, edgeR), FlIn[index])</span>
                        <span class="n">OldRMS</span><span class="p">,</span> <span class="n">Nmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_masked_stddev</span><span class="p">(</span><span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">],</span> <span class="n">mask_in</span><span class="p">)</span>
                        <span class="c1">#stats[2] = OldRMS</span>
                        <span class="k">del</span> <span class="n">Nmask</span>

                        <span class="n">NewRMS</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
                            <span class="n">mask_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">],</span>
                                                            <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                            <span class="n">NewRMS</span><span class="p">,</span> <span class="n">Nmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_masked_stddev</span><span class="p">(</span><span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">],</span> <span class="n">mask_out</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">Nmask</span>
                        <span class="c1">#stats[1] = NewRMS</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">OldRMS</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                        <span class="n">NewRMS</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                    <span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMS</span>
                    <span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMS</span>

                    <span class="c1"># Calculate Diff from the running mean</span>
                    <span class="c1">### 2011/05/26 shrink the size of data on memory</span>
                    <span class="c1">### modified to calculate Old and New statistics in a single cycle</span>
                    <span class="k">if</span> <span class="n">isvalid</span><span class="p">:</span>
                        <span class="n">START</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">nrow</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">OldRMSdiff</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMSdiff</span>
                        <span class="n">NewRMSdiff</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMSdiff</span>
                        <span class="n">Nmask</span> <span class="o">=</span> <span class="n">NCHAN</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask_out</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">isvalid</span><span class="p">:</span>
                        <span class="c1"># Mean spectra of row = row+1 ~ row+Nmean</span>
                        <span class="k">if</span> <span class="n">START</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">RmaskOld</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                            <span class="n">RdataOld0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">RmaskNew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                            <span class="n">RdataNew0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">NR</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">_x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">valid_nrow</span><span class="p">):</span>
                                <span class="n">x</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">_x</span><span class="p">]</span>
                                <span class="n">NR</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="n">RdataOld0</span> <span class="o">+=</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                                <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">x</span><span class="p">])</span>
                                <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span>
                                                             <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                                <span class="n">RmaskOld</span> <span class="o">+=</span> <span class="n">mask0</span>
                                <span class="n">RdataNew0</span> <span class="o">+=</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
                                <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span>
                                                             <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                                <span class="n">RmaskNew</span> <span class="o">+=</span> <span class="n">mask0</span>

                                <span class="k">if</span> <span class="n">NR</span> <span class="o">&gt;=</span> <span class="n">Nmean</span><span class="p">:</span>
                                    <span class="c1"># accumulated enough number of spectra</span>
                                    <span class="k">break</span>

                        <span class="k">elif</span> <span class="n">START</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">valid_nrow</span> <span class="o">-</span> <span class="n">Nmean</span><span class="p">):</span>
                            <span class="n">NR</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="n">RdataOld0</span> <span class="o">-=</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                            <span class="n">RmaskOld</span> <span class="o">-=</span> <span class="n">mask_in</span>
                            <span class="n">RdataNew0</span> <span class="o">-=</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                            <span class="n">RmaskNew</span> <span class="o">-=</span> <span class="n">mask_out</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">box_edge</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">START</span> <span class="o">+</span> <span class="n">Nmean</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">box_edge</span><span class="p">])</span>
                            <span class="n">RdataOld0</span> <span class="o">-=</span> <span class="p">(</span><span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">])</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                            <span class="n">RmaskOld</span> <span class="o">+=</span> <span class="p">(</span><span class="n">mask0</span> <span class="o">-</span> <span class="n">mask_in</span><span class="p">)</span>
                            <span class="n">RdataNew0</span> <span class="o">-=</span> <span class="p">(</span><span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">])</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                            <span class="n">RmaskNew</span> <span class="o">+=</span> <span class="p">(</span><span class="n">mask0</span> <span class="o">-</span> <span class="n">mask_out</span><span class="p">)</span>
                        <span class="c1"># Mean spectra of row = row-Nmean ~ row-1</span>
                        <span class="k">if</span> <span class="n">START</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">LmaskOld</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                            <span class="n">LdataOld0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">LmaskNew</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
                            <span class="n">LdataNew0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                            <span class="n">NL</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">elif</span> <span class="n">START</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">Nmean</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">NL</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">box_edge</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">START</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                            <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">box_edge</span><span class="p">])</span>
                            <span class="n">LdataOld0</span> <span class="o">+=</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">]</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                            <span class="n">LmaskOld</span> <span class="o">+=</span> <span class="n">mask0</span>
                            <span class="n">LdataNew0</span> <span class="o">+=</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">]</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                            <span class="n">LmaskNew</span> <span class="o">+=</span> <span class="n">mask0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">box_edge_right</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">START</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                            <span class="n">box_edge_left</span> <span class="o">=</span> <span class="n">valid_indices</span><span class="p">[</span><span class="n">START</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">Nmean</span><span class="p">]</span>
                            <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">box_edge_right</span><span class="p">])</span>
                            <span class="n">LdataOld0</span> <span class="o">+=</span> <span class="p">(</span><span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_right</span><span class="p">]</span> <span class="o">-</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_left</span><span class="p">])</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_right</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                            <span class="n">LmaskOld</span> <span class="o">+=</span> <span class="n">mask0</span>
                            <span class="n">LdataNew0</span> <span class="o">+=</span> <span class="p">(</span><span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_right</span><span class="p">]</span> <span class="o">-</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_left</span><span class="p">])</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_right</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                            <span class="n">LmaskNew</span> <span class="o">+=</span> <span class="n">mask0</span>
                            <span class="n">masklist</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">box_edge_left</span><span class="p">])</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_left</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span>
                            <span class="n">LmaskOld</span> <span class="o">-=</span> <span class="n">mask0</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask_array</span><span class="p">(</span><span class="n">masklist</span><span class="p">,</span> <span class="p">(</span><span class="n">edgeL</span><span class="p">,</span> <span class="n">edgeR</span><span class="p">),</span> <span class="n">FlOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">box_edge_left</span><span class="p">],</span>
                                                         <span class="n">deviation_mask</span><span class="o">=</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NCHAN</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                            <span class="n">LmaskNew</span> <span class="o">-=</span> <span class="n">mask0</span>

                        <span class="k">if</span> <span class="n">NL</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">NR</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># current spectrum is valid but no other valid specrtra in this group</span>
                            <span class="c1"># which typically represents single raster row</span>
                            <span class="n">OldRMSdiff</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                            <span class="n">NewRMSdiff</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                            <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMSdiff</span>
                            <span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMSdiff</span>
                            <span class="n">Nmask</span> <span class="o">=</span> <span class="n">NCHAN</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">diffOld0</span> <span class="o">=</span> <span class="p">(</span><span class="n">LdataOld0</span> <span class="o">+</span> <span class="n">RdataOld0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">NL</span> <span class="o">+</span> <span class="n">NR</span><span class="p">)</span> <span class="o">-</span> <span class="n">SpIn</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                            <span class="n">diffNew0</span> <span class="o">=</span> <span class="p">(</span><span class="n">LdataNew0</span> <span class="o">+</span> <span class="n">RdataNew0</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">NL</span> <span class="o">+</span> <span class="n">NR</span><span class="p">)</span> <span class="o">-</span> <span class="n">SpOut</span><span class="p">[</span><span class="n">ip</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>

                            <span class="c1"># Calculate Standard Deviation (NOT RMS)</span>
                            <span class="n">mask0</span> <span class="o">=</span> <span class="p">(</span><span class="n">RmaskOld</span> <span class="o">+</span> <span class="n">LmaskOld</span> <span class="o">+</span> <span class="n">mask_in</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">NL</span> <span class="o">+</span> <span class="n">NR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">OldRMSdiff</span><span class="p">,</span> <span class="n">Nmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_masked_stddev</span><span class="p">(</span><span class="n">diffOld0</span><span class="p">,</span> <span class="n">mask0</span><span class="p">)</span>
                            <span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMSdiff</span>

                            <span class="n">NewRMSdiff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
                                <span class="n">mask0</span> <span class="o">=</span> <span class="p">(</span><span class="n">RmaskNew</span> <span class="o">+</span> <span class="n">LmaskNew</span> <span class="o">+</span> <span class="n">mask_out</span><span class="p">)</span> <span class="o">//</span> <span class="p">(</span><span class="n">NL</span> <span class="o">+</span> <span class="n">NR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">NewRMSdiff</span><span class="p">,</span> <span class="n">Nmask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_masked_stddev</span><span class="p">(</span><span class="n">diffNew0</span><span class="p">,</span> <span class="n">mask0</span><span class="p">)</span>
                            <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMSdiff</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># invalid data</span>
                        <span class="n">OldRMSdiff</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                        <span class="n">NewRMSdiff</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
                        <span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMSdiff</span>
                        <span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMSdiff</span>
                        <span class="n">Nmask</span> <span class="o">=</span> <span class="n">NCHAN</span>

                    <span class="c1"># Fit STATISTICS and NMASK columns in DataTable (post-Fit statistics will be -1 when is_baselined=F)</span>
                    <span class="n">tStats</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>
                    <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tStats</span><span class="p">)</span>
                    <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;NMASK&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">Nmask</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Row=</span><span class="si">%d</span><span class="s1">, Pol </span><span class="si">%d</span><span class="s1">: pre-fit StdDev= </span><span class="si">%.2f</span><span class="s1"> pre-fit diff StdDev= </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">OldRMS</span><span class="p">,</span> <span class="n">OldRMSdiff</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Row=</span><span class="si">%d</span><span class="s1">, Pol </span><span class="si">%d</span><span class="s1">: post-fit StdDev= </span><span class="si">%.2f</span><span class="s1"> post-fit diff StdDev= </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">NewRMS</span><span class="p">,</span> <span class="n">NewRMSdiff</span><span class="p">))</span>
                    <span class="n">output_serial_index</span> <span class="o">=</span> <span class="n">output_array_index</span> <span class="o">+</span> <span class="n">index</span>
                    <span class="n">statistics_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMS</span>
                    <span class="n">statistics_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMS</span>
                    <span class="n">statistics_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">NewRMSdiff</span>
                    <span class="n">statistics_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="mi">3</span><span class="p">,</span> <span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">OldRMSdiff</span>
                    <span class="n">statistics_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="mi">4</span><span class="p">,</span> <span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TSYS&#39;</span><span class="p">,</span> <span class="n">idx</span><span class="p">)[</span><span class="n">polid</span><span class="p">]</span>
                    <span class="n">num_masked_array</span><span class="p">[</span><span class="n">polid</span><span class="p">][</span><span class="n">output_serial_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nmask</span>
            <span class="k">del</span> <span class="n">SpIn</span><span class="p">,</span> <span class="n">SpOut</span><span class="p">,</span> <span class="n">FlIn</span><span class="p">,</span> <span class="n">FlOut</span>
            <span class="n">output_array_index</span> <span class="o">+=</span> <span class="n">nrow</span>
        <span class="c1">#tbIn.close()</span>
        <span class="c1">#tbOut.close()</span>
        <span class="k">return</span> <span class="n">datatable_index</span><span class="p">,</span> <span class="n">statistics_array</span><span class="p">,</span> <span class="n">num_masked_array</span></div>


    <span class="k">def</span> <span class="nf">_calculate_masked_stddev</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculated standard deviation of data array with mask array (1=valid, 0=flagged)&quot;&quot;&quot;</span>
        <span class="n">Ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">Nmask</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ndata</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
        <span class="c1">#20190726 make it simple</span>
        <span class="c1">#MaskedData = data * mask</span>
        <span class="c1">#StddevMasked = MaskedData.std()</span>
        <span class="c1">#MeanMasked = MaskedData.mean()</span>
        <span class="k">if</span> <span class="n">Ndata</span> <span class="o">==</span> <span class="n">Nmask</span><span class="p">:</span>
            <span class="c1"># all channels are masked</span>
            <span class="n">RMS</span> <span class="o">=</span> <span class="n">INVALID_STAT</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">RMS</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
            <span class="c1">#RMS = math.sqrt(abs(Ndata * StddevMasked ** 2 / (Ndata - Nmask)</span>
            <span class="c1">#                    - Ndata * Nmask * MeanMasked ** 2 / ((Ndata - Nmask) ** 2)))</span>
        <span class="k">return</span> <span class="n">RMS</span><span class="p">,</span> <span class="n">Nmask</span>

    <span class="k">def</span> <span class="nf">_get_mask_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">masklist</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">flagchan</span><span class="p">,</span> <span class="n">flagrow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">deviation_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a list of channel mask (1=valid 0=flagged)&quot;&quot;&quot;</span>
        <span class="n">array_type</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">flagchan</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;flagchan should be an array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flagrow</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">flagchan</span><span class="p">)</span>
        <span class="c1"># Not row flagged</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">masklist</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;masklist should be an array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">masklist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">masklist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;masklist should be an array of array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># convert FLAGTRA to mask (1=valid channel, 0=flagged channel)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sdutils</span><span class="o">.</span><span class="n">get_mask_from_flagtra</span><span class="p">(</span><span class="n">flagchan</span><span class="p">))</span>
        <span class="c1"># masklist</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">[</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">masklist</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># deviation mask</span>
        <span class="k">if</span> <span class="n">deviation_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;deviation_mask should be an array or None&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deviation_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">deviation_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">array_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;deviation_mask should be an array of array or None&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span> <span class="ow">in</span> <span class="n">deviation_mask</span><span class="p">:</span>
                <span class="n">mask</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">m0</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">m1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># edge channels</span>
        <span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">flagchan</span><span class="p">)</span><span class="o">-</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">_get_flag_from_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">Threshold</span><span class="p">,</span> <span class="n">clip_niteration</span><span class="p">,</span> <span class="n">is_baselined</span><span class="p">):</span>
        <span class="n">skip_flag</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">Ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">Nflag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nflag</span><span class="p">,</span> <span class="n">Ndata</span><span class="p">),</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cycle</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clip_niteration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nflag</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">skip_flag</span><span class="p">:</span>  <span class="c1"># for not baselined data</span>
                    <span class="n">threshold</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="c1"># Leave mask all 1 (no need to modify)</span>
                    <span class="k">continue</span>
                <span class="n">valid_data_index</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INVALID_STAT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;valid_data_index=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">valid_data_index</span><span class="p">)</span>
                <span class="c1">#mask[x][numpy.where(stat[x] == INVALID_STAT)] = 0</span>
                <span class="n">Unflag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">valid_data_index</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">Unflag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># all data are invalid</span>
                    <span class="n">threshold</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="n">FlaggedData</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">valid_data_index</span><span class="p">)</span>
                <span class="n">StddevFlagged</span> <span class="o">=</span> <span class="n">FlaggedData</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">StddevFlagged</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">StddevFlagged</span> <span class="o">=</span> <span class="n">FlaggedData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
                <span class="n">MeanFlagged</span> <span class="o">=</span> <span class="n">FlaggedData</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="c1">#LOG.debug(&quot;Ndata = %s, Unflag = %s, shape(FlaggedData) = %s, Std = %s, mean = %s&quot; \</span>
                <span class="c1">#      % (str(Ndata), str(Unflag), str(FlaggedData.shape), str(StddevFlagged), str(MeanFlagged)))</span>
                <span class="c1"># 20190728 BugFix (PIPE-404):</span>
                <span class="c1"># FlaggedData does not include flagged data anymore. In older history,</span>
                <span class="c1"># flagged value in the FlaggedData was set to be 0, that why the following</span>
                <span class="c1"># scaling was necessary</span>
                <span class="c1">#AVE = MeanFlagged / float(Unflag) * float(Ndata)</span>
                <span class="c1">#RMS = math.sqrt(abs(Ndata * StddevFlagged ** 2 / Unflag</span>
                <span class="c1">#                    - Ndata * (Ndata - Unflag) * MeanFlagged ** 2 / (Unflag ** 2)))</span>
                <span class="n">AVE</span> <span class="o">=</span> <span class="n">MeanFlagged</span>
                <span class="n">RMS</span> <span class="o">=</span> <span class="n">StddevFlagged</span>
                <span class="c1">#print(&#39;x=%d, AVE=%f, RMS=%f, Thres=%s&#39; % (x, AVE, RMS, str(Threshold[x])))</span>
                <span class="n">ThreP</span> <span class="o">=</span> <span class="n">AVE</span> <span class="o">+</span> <span class="n">RMS</span> <span class="o">*</span> <span class="n">Threshold</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="c1"># Tsys case</span>
                    <span class="n">ThreM</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ThreM</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">threshold</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">ThreM</span><span class="p">,</span> <span class="n">ThreP</span><span class="p">])</span>
                <span class="c1"># for y in range(Ndata):</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">valid_data_index</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ThreM</span> <span class="o">&lt;</span> <span class="n">stat</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ThreP</span><span class="p">:</span>
                        <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mask</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;threshold=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span><span class="p">,</span> <span class="n">threshold</span>

    <span class="k">def</span> <span class="nf">_apply_stat_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">stat_flag</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating flags in data table&quot;</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">pflags</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_flag</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_flag</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_flag</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_flag</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">pflags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat_flag</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">N</span><span class="p">]</span>
            <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
            <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">pflags</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="SDBLFlagWorker.flagExpectedRMS">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.flagExpectedRMS">[docs]</a>
    <span class="k">def</span> <span class="nf">flagExpectedRMS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">msname</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">FlagRule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rawFileIdx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">is_baselined</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># FLagging based on expected RMS</span>
        <span class="c1"># TODO: Include in normal flags scheme</span>

        <span class="c1"># The expected RMS according to the radiometer formula sometimes needs</span>
        <span class="c1"># special scaling factors to account for meta data conventions (e.g.</span>
        <span class="c1"># whether Tsys is given for DSB or SSB mode) and for backend specific</span>
        <span class="c1"># setups (e.g. correlator, AOS, etc. noise scaling). These factors are</span>
        <span class="c1"># not saved in the data sets&#39; meta data. Thus we have to read them from</span>
        <span class="c1"># a special file. TODO: This needs to be changed for ALMA later on.</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Flagging spectra by Expected RMS&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.exp_rms_factors&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">sc_fact_list</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sc_fact_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">sc_fact</span> <span class="ow">in</span> <span class="n">sc_fact_list</span><span class="p">:</span>
                <span class="n">sc_fact_key</span><span class="p">,</span> <span class="n">sc_fact_value</span> <span class="o">=</span> <span class="n">sc_fact</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">sc_fact_dict</span><span class="p">[</span><span class="n">sc_fact_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sc_fact_value</span><span class="p">)</span>
            <span class="n">tsys_fact</span> <span class="o">=</span> <span class="n">sc_fact_dict</span><span class="p">[</span><span class="s1">&#39;tsys_fact&#39;</span><span class="p">]</span>
            <span class="n">nebw_fact</span> <span class="o">=</span> <span class="n">sc_fact_dict</span><span class="p">[</span><span class="s1">&#39;nebw_fact&#39;</span><span class="p">]</span>
            <span class="n">integ_time_fact</span> <span class="o">=</span> <span class="n">sc_fact_dict</span><span class="p">[</span><span class="s1">&#39;integ_time_fact&#39;</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using scaling factors tsys_fact=</span><span class="si">%f</span><span class="s2">, nebw_fact=</span><span class="si">%f</span><span class="s2"> and integ_time_fact=</span><span class="si">%f</span><span class="s2"> for flagging based on expected RMS.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tsys_fact</span><span class="p">,</span> <span class="n">nebw_fact</span><span class="p">,</span> <span class="n">integ_time_fact</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cannot read scaling factors for flagging based on expected RMS. Using 1.0.&quot;</span><span class="p">)</span>
            <span class="n">tsys_fact</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">nebw_fact</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">integ_time_fact</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># TODO: Make threshold a parameter</span>
        <span class="c1"># This needs to be quite strict to catch the ripples in the bad Orion</span>
        <span class="c1"># data. Maybe this is due to underestimating the total integration time.</span>
        <span class="c1"># Check again later.</span>
        <span class="c1"># 2008/10/31 divided the category into two</span>
        <span class="n">ThreExpectedRMSPreFit</span> <span class="o">=</span> <span class="n">FlagRule</span><span class="p">[</span><span class="s1">&#39;RmsExpectedPreFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>
        <span class="n">ThreExpectedRMSPostFit</span> <span class="o">=</span> <span class="n">FlagRule</span><span class="p">[</span><span class="s1">&#39;RmsExpectedPostFitFlag&#39;</span><span class="p">][</span><span class="s1">&#39;Threshold&#39;</span><span class="p">]</span>

        <span class="c1"># The noise equivalent bandwidth is proportional to the channel width</span>
        <span class="c1"># but may need a scaling factor. This factor was read above.</span>
        <span class="n">msobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
        <span class="n">noiseEquivBW</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_effbws</span><span class="p">))</span> <span class="o">*</span> <span class="n">nebw_fact</span>

        <span class="c1">#tEXPT = DataTable.getcol(&#39;EXPOSURE&#39;)</span>
        <span class="c1">#tTSYS = DataTable.getcol(&#39;TSYS&#39;)</span>

        <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="c1"># The HHT and APEX test data show the &quot;on&quot; time only in the CLASS</span>
            <span class="c1"># header. To get the total time, at least a factor of 2 is needed,</span>
            <span class="c1"># for OTFs and rasters with several on per off even higher, but this</span>
            <span class="c1"># cannot be automatically determined due to lacking meta data. We</span>
            <span class="c1"># thus use a manually supplied scaling factor.</span>
            <span class="n">tEXPT</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">integTimeSec</span> <span class="o">=</span> <span class="n">tEXPT</span> <span class="o">*</span> <span class="n">integ_time_fact</span>
            <span class="c1"># The Tsys value can be saved for DSB or SSB mode. A scaling factor</span>
            <span class="c1"># may be needed. This factor was read above.</span>
            <span class="n">tTSYS</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TSYS&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)[</span><span class="n">polid</span><span class="p">]</span>
            <span class="c1"># K-&gt;Jy factor</span>
            <span class="n">tAnt</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;ANTENNA&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">antname</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">tAnt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">polname</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">)</span><span class="o">.</span><span class="n">get_polarization_label</span><span class="p">(</span><span class="n">polid</span><span class="p">)</span>
            <span class="n">k2jy_fact</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">k2jy_factor</span><span class="p">[(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">antname</span><span class="p">,</span> <span class="n">polname</span><span class="p">)]</span> <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">msobj</span><span class="p">,</span> <span class="s1">&#39;k2jy_factor&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">antname</span><span class="p">,</span> <span class="n">polname</span><span class="p">)</span> <span class="ow">in</span> <span class="n">msobj</span><span class="o">.</span><span class="n">k2jy_factor</span><span class="p">)</span> <span class="k">else</span> <span class="mf">1.0</span>

            <span class="n">currentTsys</span> <span class="o">=</span> <span class="n">tTSYS</span> <span class="o">*</span> <span class="n">tsys_fact</span> <span class="o">*</span> <span class="n">k2jy_fact</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">noiseEquivBW</span> <span class="o">*</span> <span class="n">integTimeSec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">expectedRMS</span> <span class="o">=</span> <span class="n">currentTsys</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">noiseEquivBW</span> <span class="o">*</span> <span class="n">integTimeSec</span><span class="p">)</span>
                <span class="c1"># 2008/10/31</span>
                <span class="c1"># Comparison with both pre- and post-BaselineFit RMS</span>
                <span class="n">stats</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="n">PostFitRMS</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">PreFitRMS</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;DEBUG_DM: Row: </span><span class="si">%d</span><span class="s1"> Expected RMS: </span><span class="si">%f</span><span class="s1"> PostFit RMS: </span><span class="si">%f</span><span class="s1"> PreFit RMS: </span><span class="si">%f</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">expectedRMS</span><span class="p">,</span> <span class="n">PostFitRMS</span><span class="p">,</span> <span class="n">PreFitRMS</span><span class="p">))</span>
                <span class="n">stats</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">expectedRMS</span> <span class="o">*</span> <span class="n">ThreExpectedRMSPostFit</span> <span class="k">if</span> <span class="n">is_baselined</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">stats</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">expectedRMS</span> <span class="o">*</span> <span class="n">ThreExpectedRMSPreFit</span>
                <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;STATISTICS&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span>
                <span class="n">flags</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="c1">#if (PostFitRMS &gt; ThreExpectedRMSPostFit * expectedRMS) or PostFitRMS == INVALID_STAT:</span>
                <span class="k">if</span> <span class="n">PostFitRMS</span> <span class="o">!=</span> <span class="n">INVALID_STAT</span> <span class="ow">and</span> <span class="p">(</span><span class="n">PostFitRMS</span> <span class="o">&gt;</span> <span class="n">ThreExpectedRMSPostFit</span> <span class="o">*</span> <span class="n">expectedRMS</span><span class="p">):</span>
                    <span class="c1">#LOG.debug(&quot;Row=%d flagged by expected RMS postfit: %f &gt; %f (expected)&quot; %(ID, PostFitRMS, ThreExpectedRMSPostFit * expectedRMS))</span>
                    <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="c1">#if is_baselined and (PreFitRMS == INVALID_STAT or PreFitRMS &gt; ThreExpectedRMSPreFit * expectedRMS):</span>
                <span class="k">if</span> <span class="n">is_baselined</span> <span class="ow">and</span> <span class="n">PreFitRMS</span> <span class="o">!=</span> <span class="n">INVALID_STAT</span> <span class="ow">and</span> <span class="p">(</span><span class="n">PreFitRMS</span> <span class="o">&gt;</span> <span class="n">ThreExpectedRMSPreFit</span> <span class="o">*</span> <span class="n">expectedRMS</span><span class="p">):</span>
                    <span class="c1">#LOG.debug(&quot;Row=%d flagged by expected RMS postfit: %f &gt; %f (expected)&quot; %(ID, PreFitRMS, ThreExpectedRMSPreFit * expectedRMS))</span>
                    <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flags</span><span class="p">[</span><span class="n">polid</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.flagSummary">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.flagSummary">[docs]</a>
    <span class="k">def</span> <span class="nf">flagSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">ids</span><span class="p">,</span> <span class="n">polid</span><span class="p">,</span> <span class="n">FlagRule</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="c1"># Check every flags to create summary flag</span>
            <span class="n">tFLAG</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)[</span><span class="n">polid</span><span class="p">]</span>
            <span class="n">tPFLAG</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)[</span><span class="n">polid</span><span class="p">]</span>
            <span class="n">tSFLAG</span> <span class="o">=</span> <span class="n">DataTable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
            <span class="n">pflag</span> <span class="o">=</span> <span class="n">_get_permanent_flag_summary</span><span class="p">(</span><span class="n">tPFLAG</span><span class="p">,</span> <span class="n">FlagRule</span><span class="p">)</span>
            <span class="n">sflag</span> <span class="o">=</span> <span class="n">_get_stat_flag_summary</span><span class="p">(</span><span class="n">tFLAG</span><span class="p">,</span> <span class="n">FlagRule</span><span class="p">)</span>
            <span class="n">tSFLAG</span><span class="p">[</span><span class="n">polid</span><span class="p">]</span> <span class="o">=</span> <span class="n">pflag</span><span class="o">*</span><span class="n">sflag</span>
            <span class="n">DataTable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">tSFLAG</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.ResetDataTableMaskList">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.ResetDataTableMaskList">[docs]</a>
    <span class="k">def</span> <span class="nf">ResetDataTableMaskList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatable</span><span class="p">,</span> <span class="n">TimeTable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset MASKLIST column of DataTable for row indices in TimeTable&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">chunks</span> <span class="ow">in</span> <span class="n">TimeTable</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">chunks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
                <span class="n">datatable</span><span class="o">.</span><span class="n">putcell</span><span class="p">(</span><span class="s2">&quot;MASKLIST&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># OR more precisely, [[-1,-1]]</span></div>


<div class="viewcode-block" id="SDBLFlagWorker.generateFlagCommandFile">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.baselineflag.html#pipeline.hsd.tasks.baselineflag.worker.SDBLFlagWorker.generateFlagCommandFile">[docs]</a>
    <span class="k">def</span> <span class="nf">generateFlagCommandFile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datatable</span><span class="p">,</span> <span class="n">msobj</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">pollist</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize FLAG status in DataTable and generate flag command file</span>

<span class="sd">        Arguments:</span>
<span class="sd">            datatable: DataTable instance</span>
<span class="sd">            msobj: MS instance to summarize flag</span>
<span class="sd">            antid, fieldid, spwid: ANTENNA, FIELD_ID and IF to summarize</span>
<span class="sd">            filename: output flag command file name</span>
<span class="sd">        Returns if there is any valid flag command in file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dt_ids</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_index_list_for_ms</span><span class="p">(</span><span class="n">datatable</span><span class="p">,</span> <span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">],</span>
                                              <span class="p">[</span><span class="n">antid</span><span class="p">],</span> <span class="p">[</span><span class="n">fieldid</span><span class="p">],</span> <span class="p">[</span><span class="n">spwid</span><span class="p">])</span>
        <span class="n">ant_name</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">antid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ddobj</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">)</span>
        <span class="n">polids</span> <span class="o">=</span> <span class="p">[</span><span class="n">ddobj</span><span class="o">.</span><span class="n">get_polarization_id</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span> <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pollist</span><span class="p">]</span>
        <span class="n">base_selection</span> <span class="o">=</span> <span class="s2">&quot;antenna=&#39;</span><span class="si">%s</span><span class="s2">&amp;&amp;&amp;&#39; spw=&#39;</span><span class="si">%d</span><span class="s2">&#39; field=&#39;</span><span class="si">%d</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">)</span>
        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
        <span class="n">valid_flag_commands</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fout</span><span class="p">:</span>
            <span class="c1"># header part</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Flag command file for Statistic Flags</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Filename: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# MS name: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Antenna: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ant_name</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Field ID: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">fieldid</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# SPW: </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">spwid</span><span class="p">)</span>
            <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="o">*</span><span class="mi">60</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># data part</span>
            <span class="c1"># Flag status by Active flag type is summarized in FLAG_SUMMARY column</span>
            <span class="c1"># NOTE Elements in FLAG and FLAG_PERMANENT have 0 (flagged) even if the</span>
            <span class="c1"># flag category is inactive.</span>
            <span class="c1"># We want avoid generating flag commands if online flag is the only reason for the flag.</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dt_ids</span><span class="p">)):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="n">base_selection</span><span class="p">]</span>
                <span class="n">ID</span> <span class="o">=</span> <span class="n">dt_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tSFLAG</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_SUMMARY&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="n">tFLAG</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="n">tPFLAG</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG_PERMANENT&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="n">flag_sum</span> <span class="o">=</span> <span class="n">tFLAG</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">tPFLAG</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">online</span> <span class="o">=</span> <span class="n">tPFLAG</span><span class="p">[:,</span> <span class="n">OnlineFlagIndex</span><span class="p">]</span>
                <span class="c1"># num_flag: the number of flag types.</span>
                <span class="c1"># data are valid (unflagged) only if all elements of flags are 1.</span>
                <span class="c1"># Hence sum of flag == num_flag</span>
                <span class="n">num_flag</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tFLAG</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tPFLAG</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># Ignore the case only online flag is active (0).</span>
                <span class="c1"># in that case, flag_sum = num_flag (if online=1)</span>
                <span class="c1">#                          num_flag-1 (if online=0)</span>
                <span class="c1"># if online = 1 (valid) =&gt; sflag = flag_sum == num_flag</span>
                <span class="c1"># if online = 0 (invalid)</span>
                <span class="c1">#     =&gt; sflag = flag_sum+1 == num_flag if no other flag</span>
                <span class="c1">#        is active</span>
                <span class="n">sflag</span> <span class="o">=</span> <span class="n">flag_sum</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">flag_sum</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">-</span><span class="n">online</span>
                <span class="n">flagged_pols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polids</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">tSFLAG</span><span class="p">[</span><span class="n">polids</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sflag</span><span class="p">[</span><span class="n">polids</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">num_flag</span><span class="p">:</span>
                        <span class="n">flagged_pols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pollist</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagged_pols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no flag in selcted pols</span>
                    <span class="k">continue</span>
                <span class="n">valid_flag_commands</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagged_pols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pollist</span><span class="p">):</span>
                    <span class="n">line</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;correlation=&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">flagged_pols</span><span class="p">))</span>
                <span class="n">timeval</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span>
                <span class="n">tbuff</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="mf">86400.0</span>
                <span class="n">qtime_s</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">timeval</span> <span class="o">-</span> <span class="n">tbuff</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">)</span>
                <span class="n">qtime_e</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">timeval</span> <span class="o">+</span> <span class="n">tbuff</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">)</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;timerange=&#39;</span><span class="si">%s</span><span class="s2">~</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">qtime_s</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s2">&quot;ymd&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">qtime_e</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s2">&quot;ymd&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
                         <span class="s2">&quot;reason=&#39;blflag&#39;&quot;</span><span class="p">]</span>
                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid_flag_commands</span></div>
</div>



<span class="k">def</span> <span class="nf">_get_permanent_flag_summary</span><span class="p">(</span> <span class="n">pflag</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">FlagRule</span><span class="p">:</span><span class="n">Dict</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get permanent flag summary</span>

<span class="sd">    Args:</span>
<span class="sd">        pflag    : list of  permanent flags</span>
<span class="sd">                     [0] --- &#39;WeatherFlag&#39; --&gt; not used</span>
<span class="sd">                     [1] --- &#39;TsysFlag&#39;</span>
<span class="sd">                     [2] --- &#39;UserFlag&#39;    --&gt; not used</span>
<span class="sd">                     [3] --- &#39;OnlineFlag&#39; (fixed)</span>
<span class="sd">        FlagRule : Flag rule</span>
<span class="sd">    Returns:</span>
<span class="sd">        mask</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="c1"># OnlineFlag is always active</span>
    <span class="k">if</span> <span class="n">pflag</span><span class="p">[</span><span class="n">OnlineFlagIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># PIPE-1114: WeatherFlag and UserFlag are removed, only TsysFlag remains.</span>
    <span class="k">elif</span> <span class="n">FlagRule</span><span class="p">[</span><span class="s1">&#39;TsysFlag&#39;</span><span class="p">][</span><span class="s1">&#39;isActive&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">pflag</span><span class="p">[</span><span class="n">TsysFlagIndex</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">mask</span>


<span class="k">def</span> <span class="nf">_get_stat_flag_summary</span><span class="p">(</span> <span class="n">tflag</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">FlagRule</span><span class="p">:</span><span class="n">Dict</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get stat flag summary</span>

<span class="sd">    Args:</span>
<span class="sd">        tFlag    : List of flags</span>
<span class="sd">                      [0] --- &#39;LowFrRMSFlag&#39; (OBSOLETE)</span>
<span class="sd">                      [1] --- &#39;RmsPostFitFlag&#39;</span>
<span class="sd">                      [2] --- &#39;RmsPreFitFlag&#39;</span>
<span class="sd">                      [3] --- &#39;RunMeanPostFitFlag&#39;</span>
<span class="sd">                      [4] --- &#39;RunMeanPreFitFlag&#39;</span>
<span class="sd">                      [5] --- &#39;RmsExpectedPostFitFlag&#39;</span>
<span class="sd">                      [6] --- &#39;RmsExpectedPreFitFlag&#39;</span>
<span class="sd">        FlagRule : Flag rule</span>
<span class="sd">    Returns:</span>
<span class="sd">        mask</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RmsPostFitFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;RmsPreFitFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;RunMeanPostFitFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;RunMeanPreFitFlag&#39;</span><span class="p">,</span>
             <span class="s1">&#39;RmsExpectedPostFitFlag&#39;</span><span class="p">,</span> <span class="s1">&#39;RmsExpectedPreFitFlag&#39;</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">types</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">FlagRule</span><span class="p">[</span><span class="n">types</span><span class="p">[</span><span class="n">idx</span><span class="p">]][</span><span class="s1">&#39;isActive&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">tflag</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">mask</span>


<span class="c1"># validity check in _get_iteration is not necessary since group_member</span>
<span class="c1"># has already been validated at upper level (baselineflag.py)</span>
<span class="k">def</span> <span class="nf">_get_iteration</span><span class="p">(</span><span class="n">reduction_group</span><span class="p">:</span><span class="n">Dict</span><span class="p">,</span> <span class="n">msobj</span><span class="p">:</span><span class="n">MeasurementSet</span><span class="p">,</span> <span class="n">antid</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwid</span><span class="p">:</span><span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get iteration </span>

<span class="sd">    Args:</span>
<span class="sd">        reduction_group : Reduction group dictionary.</span>
<span class="sd">        msobj           : measurment set</span>
<span class="sd">        antid           : ant id</span>
<span class="sd">        fieldid         : field id</span>
<span class="sd">        spwid           : spw id</span>
<span class="sd">    Returns:</span>
<span class="sd">        iteration</span>
<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError when group_desc does not hold multiple members</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">members</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group_desc</span> <span class="ow">in</span> <span class="n">reduction_group</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="c1">#memids = common.get_valid_ms_members(group_desc, [msobj.name], antid, fieldid, spwid)</span>
        <span class="c1">#members.extend([group_desc[i] for i in memids])</span>
        <span class="n">member_id</span> <span class="o">=</span> <span class="n">group_desc</span><span class="o">.</span><span class="n">_search_member</span><span class="p">(</span><span class="n">msobj</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">member_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">members</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_desc</span><span class="p">[</span><span class="n">member_id</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">members</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">iteration</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Given (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) is not in reduction group.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Given (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">) is in more than one reduction groups.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>