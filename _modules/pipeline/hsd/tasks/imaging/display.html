

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hsd.tasks.imaging.display &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task (sphinx-autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Pipeline Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <cite>Pipeline</cite></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Task Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html">pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif.tasks">pipeline-l2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif">pipeline-l3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#pipeline-diagram">pipeline-diagram</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/releases.html">Pipeline Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hsd.tasks.imaging.display</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hsd.tasks.imaging.display</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Set of plotting classes for hsd_imaging task.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.axes</span> <span class="k">as</span> <span class="nn">axes</span>
<span class="kn">import</span> <span class="nn">matplotlib.figure</span> <span class="k">as</span> <span class="nn">figure</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.displays.pointing</span> <span class="k">as</span> <span class="nn">pointing</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.renderer.logger</span> <span class="k">as</span> <span class="nn">logger</span>
<span class="kn">from</span> <span class="nn">pipeline.domain</span> <span class="kn">import</span> <span class="n">DataType</span>
<span class="kn">from</span> <span class="nn">pipeline.h.tasks.common</span> <span class="kn">import</span> <span class="n">atmutil</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common.display</span> <span class="kn">import</span> <span class="n">DPIDetail</span><span class="p">,</span> <span class="n">SDImageDisplay</span><span class="p">,</span> <span class="n">SDImageDisplayInputs</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common.display</span> <span class="kn">import</span> <span class="n">sd_polmap</span> <span class="k">as</span> <span class="n">polmap</span><span class="p">,</span> <span class="n">SpectralImage</span><span class="p">,</span> <span class="n">ChannelSelection</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common.display</span> <span class="kn">import</span> <span class="n">SDSparseMapPlotter</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common.display</span> <span class="kn">import</span> <span class="n">NoData</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.imaging.resultobjects</span> <span class="kn">import</span> <span class="n">SDImagingResultItem</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tasks</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.displays.pointing</span> <span class="kn">import</span> <span class="n">MapAxesManagerBase</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.displays.plotstyle</span> <span class="kn">import</span> <span class="n">casa5style_plot</span>

<span class="n">RArotation</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">RArotation</span>
<span class="n">DECrotation</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">DECrotation</span>
<span class="n">DDMMSSs</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">DDMMSSs</span>
<span class="n">HHMMSSss</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">HHMMSSss</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ImageAxesManager">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.ImageAxesManager">[docs]</a>
<span class="k">class</span> <span class="nc">ImageAxesManager</span><span class="p">(</span><span class="n">MapAxesManagerBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Axes manager for figure containing ImageAxes instance.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
                 <span class="n">xformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span> <span class="n">yformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span>
                 <span class="n">xlocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span> <span class="n">ylocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span>
                 <span class="n">xrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">yrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">ticksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct ImageAxesManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: matplotlib.figure.Figure instance</span>
<span class="sd">            xformatter: tick formatter for x-axis</span>
<span class="sd">            yformatter: tick formatter for y-axis</span>
<span class="sd">            xlocator: tick locator for x-axis</span>
<span class="sd">            ylocator: tick locator for y-axis</span>
<span class="sd">            xrotation: rotation angle of x-axis label</span>
<span class="sd">            yrotation: rotation angle of y-axis label</span>
<span class="sd">            ticksize: tick label size</span>
<span class="sd">            colormap: colormap to use. &#39;gray&#39; for gray scale. Otherwise, &#39;jet&#39; is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ImageAxesManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xformatter</span> <span class="o">=</span> <span class="n">xformatter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yformatter</span> <span class="o">=</span> <span class="n">yformatter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xlocator</span> <span class="o">=</span> <span class="n">xlocator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ylocator</span> <span class="o">=</span> <span class="n">ylocator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xrotation</span> <span class="o">=</span> <span class="n">xrotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yrotation</span> <span class="o">=</span> <span class="n">yrotation</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">=</span> <span class="n">ticksize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span> <span class="k">if</span> <span class="n">colormap</span> <span class="o">==</span> <span class="s1">&#39;gray&#39;</span> <span class="k">else</span> <span class="s1">&#39;jet&#39;</span>

<div class="viewcode-block" id="ImageAxesManager.set_colorbar_for">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.ImageAxesManager.set_colorbar_for">[docs]</a>
    <span class="k">def</span> <span class="nf">set_colorbar_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span>
                         <span class="n">value_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">value_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">value_unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">shrink</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set colorbar associated with given Axes instance.</span>

<span class="sd">        Axes is supposed to contain ImageAxes inside. If Axes already has colorbar,</span>
<span class="sd">        it reuses the existing one rather than creating new instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            axes: Axes instance</span>
<span class="sd">            value_min: minimum value of the range of colorbar</span>
<span class="sd">            value_max: maximum value of the range of colorbar</span>
<span class="sd">            value_unit: unit of the value</span>
<span class="sd">            shrink: shrink parameter for colorbar. Defaults to 1.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># axes should contain one AxesImage</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;colorbar&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colorbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">value_min</span><span class="p">,</span> <span class="n">value_max</span><span class="p">)</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap</span><span class="p">),</span> <span class="n">shrink</span><span class="o">=</span><span class="n">shrink</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">():</span>
                <span class="n">fontsize</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_fontsize</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span>
                <span class="n">t</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">colorbar</span> <span class="o">=</span> <span class="n">colorbar</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">mappable</span><span class="o">.</span><span class="n">set_clim</span><span class="p">((</span><span class="n">value_min</span><span class="p">,</span> <span class="n">value_max</span><span class="p">))</span>
            <span class="c1"># it is recommended to call figure.draw_without_rendering() instead of colorbar.draw_all()</span>
            <span class="c1"># colorbar.draw_all()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">draw_without_rendering</span><span class="p">()</span>
            <span class="c1"># set_clim and draw_all clears y-label</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_fontsize</span><span class="p">()</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">value_unit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SingleImageAxesManager">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SingleImageAxesManager">[docs]</a>
<span class="k">class</span> <span class="nc">SingleImageAxesManager</span><span class="p">(</span><span class="n">ImageAxesManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Axes manager for figure containing single ImageAxes instance.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
                 <span class="n">xformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span> <span class="n">yformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span>
                 <span class="n">xlocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span> <span class="n">ylocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span>
                 <span class="n">xrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">yrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">ticksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SingleImageAxesManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: matplotlib.figure.Figure instance</span>
<span class="sd">            xformatter: tick formatter for x-axis</span>
<span class="sd">            yformatter: tick formatter for y-axis</span>
<span class="sd">            xlocator: tick locator for x-axis</span>
<span class="sd">            ylocator: tick locator for y-axis</span>
<span class="sd">            xrotation: rotation angle of x-axis label</span>
<span class="sd">            yrotation: rotation angle of y-axis label</span>
<span class="sd">            ticksize: tick label size</span>
<span class="sd">            colormap: colormap to use. &#39;gray&#39; for gray scale. Otherwise, &#39;jet&#39; is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SingleImageAxesManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">xformatter</span><span class="p">,</span> <span class="n">yformatter</span><span class="p">,</span> <span class="n">xlocator</span><span class="p">,</span> <span class="n">ylocator</span><span class="p">,</span> <span class="n">xrotation</span><span class="p">,</span> <span class="n">yrotation</span><span class="p">,</span> <span class="n">ticksize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_axes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Axes instance for the image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes instance. The instance is created only once and</span>
<span class="sd">            return existing one for the subsequent access.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xformatter</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yformatter</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xlocator</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ylocator</span><span class="p">)</span>
            <span class="n">xlabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xrotation</span><span class="p">)</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yrotation</span><span class="p">)</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_labels</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_image_axes</span> <span class="o">=</span> <span class="n">axes</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_axes</span></div>



<div class="viewcode-block" id="SDChannelAveragedImageDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDChannelAveragedImageDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDChannelAveragedImageDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter to create a color map for channel averaged spw.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SDChannelAveragedImageDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDChannelAveragedImageDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of color maps for channel averaged spw.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of plot objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="n">Extent</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">span</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="p">(</span><span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">)</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">XYlabel</span><span class="p">(</span><span class="n">span</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># 2008/9/20 Dec Effect has been taken into account</span>
        <span class="c1">#Aspect = 1.0 / math.cos(0.5 * (self.dec_max + self.dec_min) / 180. * 3.141592653)</span>

        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;color&#39;</span>
        <span class="n">TickSize</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="n">axes_manager</span> <span class="o">=</span> <span class="n">SingleImageAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">,</span>
                                              <span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span>
                                              <span class="n">RArotation</span><span class="p">,</span> <span class="n">DECrotation</span><span class="p">,</span>
                                              <span class="n">TickSize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="n">axes_manager</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span>
        <span class="n">axes_tpmap</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">image_axes</span>
        <span class="n">beam_circle</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">Total</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">Total</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">Total</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">tmin</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">tmax</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># 2008/9/20 DEC Effect</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Total</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">Extent</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">Total</span>

            <span class="n">xlim</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="c1"># colorbar</span>
            <span class="c1">#print &quot;min=%s, max of Total=%s&quot; % (tmin,tmax)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">==</span> <span class="n">tmax</span><span class="p">):</span>
                <span class="c1">#if not ((Ymax == Ymin) and (Xmax == Xmin)):</span>
                <span class="c1">#if not all(image_shape[id_direction] &lt;= 1):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">axes_manager</span><span class="o">.</span><span class="n">set_colorbar_for</span><span class="p">(</span><span class="n">axes_tpmap</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

            <span class="c1"># draw beam pattern</span>
            <span class="k">if</span> <span class="n">beam_circle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">beam_circle</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">draw_beam</span><span class="p">(</span><span class="n">axes_tpmap</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">)</span>

            <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Total Power&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>
            <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

            <span class="n">FigFileRoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span><span class="o">+</span><span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
            <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">FigFileRoot</span><span class="o">+</span><span class="s1">&#39;_TP.png&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>

            <span class="n">im</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span> <span class="c1">#polmap[pol]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span>
            <span class="c1">#parameters[&#39;type&#39;] = &#39;sd_channel-averaged&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd_integrated_map&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
            <span class="c1">#if self.inputs.vis is not None:</span>
            <span class="c1">#    parameters[&#39;vis&#39;] = self.inputs.vis</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                               <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;R.A.&#39;</span><span class="p">,</span>
                               <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Dec.&#39;</span><span class="p">,</span>
                               <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                               <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>
</div>



<div class="viewcode-block" id="SDMomentMapDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDMomentMapDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDMomentMapDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter to create a moment map.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">SDImageDisplayInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create SDMomentMapDisplay instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            Inputs instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment_images</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="SDMomentMapDisplay.init">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDMomentMapDisplay.init">[docs]</a>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do some initialization for moment map.</span>

<span class="sd">        Execute immoments task to generate moment image as well as</span>
<span class="sd">        performing generic initialization defined in the super class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moment_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">MomentMapList</span><span class="p">:</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">create_channel_mask</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;chans = &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">chans</span><span class="p">)</span>
            <span class="n">moment_imagename_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">moment_imagename</span><span class="p">(</span><span class="n">moment</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">)</span> <span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">moments</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">imagename</span> <span class="ow">in</span> <span class="n">moment_imagename_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imagename</span><span class="p">):</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">removefile</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
            <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">moment_imagename</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">moments</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">chans</span><span class="p">)</span>
            <span class="n">moments</span> <span class="o">=</span> <span class="p">[</span><span class="n">moment</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">moment</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">moments</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moment_imagename_list=</span><span class="si">{</span><span class="n">moment_imagename_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;moments=</span><span class="si">{</span><span class="n">moments</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;outfile=</span><span class="si">{</span><span class="n">outfile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">casa_tasks</span><span class="o">.</span><span class="n">immoments</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="n">moments</span><span class="p">,</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">)</span>
            <span class="n">job</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">imagename</span> <span class="ow">in</span> <span class="n">moment_imagename_list</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">moment_images</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">moment_imagename_list</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">()</span></div>


<div class="viewcode-block" id="SDMomentMapDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDMomentMapDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of moment maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of plot objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="n">Extent</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">span</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="p">(</span><span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">)</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">XYlabel</span><span class="p">(</span><span class="n">span</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span><span class="p">)</span>

        <span class="c1"># Plotting</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span>

        <span class="c1"># 2008/9/20 Dec Effect has been taken into account</span>
        <span class="c1">#Aspect = 1.0 / math.cos(0.5 * (self.dec_max + self.dec_min) / 180. * 3.141592653)</span>

        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;color&#39;</span>
        <span class="n">TickSize</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="n">axes_manager</span> <span class="o">=</span> <span class="n">SingleImageAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">,</span>
                                              <span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span>
                                              <span class="n">RArotation</span><span class="p">,</span> <span class="n">DECrotation</span><span class="p">,</span>
                                              <span class="n">TickSize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="n">axes_manager</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span>
        <span class="n">axes_tpmap</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">image_axes</span>
        <span class="n">beam_circle</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">imagename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">moment_images</span><span class="p">:</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">imagename</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">split_imagename</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">moment_type</span> <span class="o">=</span> <span class="n">split_imagename</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">chans</span> <span class="o">=</span> <span class="n">split_imagename</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">moment_type</span> <span class="o">==</span> <span class="s1">&#39;maximum&#39;</span><span class="p">:</span>
                <span class="n">map_title</span> <span class="o">=</span> <span class="s1">&#39;Max Intensity Map&#39;</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># &#39;integrated&#39;</span>
                <span class="n">map_title</span> <span class="o">=</span> <span class="s1">&#39;Integrated Intensity Map&#39;</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">SpectralImage</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">mask</span>

            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>

                <span class="n">masked_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="n">Total</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                <span class="k">del</span> <span class="n">masked_data</span>

                <span class="k">if</span> <span class="n">moment_type</span> <span class="o">==</span> <span class="s1">&#39;maximum&#39;</span> <span class="ow">and</span> <span class="n">chans</span> <span class="o">==</span> <span class="s1">&#39;line_free&#39;</span><span class="p">:</span>
                    <span class="c1"># adjust color scale according to the logic described in PIPE-373/PIPE-197</span>
                    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
                        <span class="c1"># cf. hif/tasks/tclean/tclean.py mom8_stats</span>
                        <span class="n">stats</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">tmin</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">per_channel_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">compute_per_channel_stats</span><span class="p">()</span>
                    <span class="n">line_free_channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">get_line_free_channels</span><span class="p">()</span>
                    <span class="n">sigma</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">per_channel_stats</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="n">line_free_channels</span><span class="p">])</span>
                    <span class="n">tmax</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">sigma</span>

                    <span class="c1"># Since there is no guarantee in the above logic that tmax</span>
                    <span class="c1"># is always larger than tmin, or both tmin and tmax are</span>
                    <span class="c1"># finite value, this if-block is placed as a safeguard to</span>
                    <span class="c1"># make sure tmax &gt;= tmin.</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">([</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">])))</span> <span class="ow">or</span> <span class="n">tmin</span> <span class="o">&gt;</span> <span class="n">tmax</span><span class="p">:</span>
                        <span class="n">tmin</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                        <span class="n">tmax</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tmin</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                    <span class="n">tmax</span> <span class="o">=</span> <span class="n">Total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

                <span class="c1"># 2008/9/20 DEC Effect</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                    <span class="n">Total</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">Extent</span><span class="p">,</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">tmax</span>
                <span class="p">)</span>
                <span class="k">del</span> <span class="n">Total</span>

                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

                <span class="c1"># colorbar</span>
                <span class="c1">#print &quot;min=%s, max of Total=%s&quot; % (tmin,tmax)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tmin</span> <span class="o">==</span> <span class="n">tmax</span><span class="p">):</span>
                    <span class="c1">#if not ((Ymax == Ymin) and (Xmax == Xmin)):</span>
                    <span class="c1">#if not all(image_shape[id_direction] &lt;= 1):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">axes_manager</span><span class="o">.</span><span class="n">set_colorbar_for</span><span class="p">(</span><span class="n">axes_tpmap</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

                <span class="c1"># draw beam pattern</span>
                <span class="k">if</span> <span class="n">beam_circle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">beam_circle</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">draw_beam</span><span class="p">(</span><span class="n">axes_tpmap</span><span class="p">,</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">)</span>

                <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">map_title</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>
                <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                <span class="n">axes_tpmap</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

                <span class="n">figfile</span> <span class="o">=</span> <span class="n">imagename</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;.pol</span><span class="si">{</span><span class="n">pol</span><span class="si">}</span><span class="s1">.png&#39;</span>
                <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">figfile</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>

                <span class="n">im</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

                <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span> <span class="c1">#polmap[pol]</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd_moment_map&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;moment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">moment_type</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;chans&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chans</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

                <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                                   <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;R.A.&#39;</span><span class="p">,</span>
                                   <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Dec.&#39;</span><span class="p">,</span>
                                   <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                   <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>
</div>



<div class="viewcode-block" id="ChannelMapAxesManager">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.ChannelMapAxesManager">[docs]</a>
<span class="k">class</span> <span class="nc">ChannelMapAxesManager</span><span class="p">(</span><span class="n">ImageAxesManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates and manages Axes instances for channel map.</span>

<span class="sd">    Channel map consists of the following Axes:</span>

<span class="sd">        - Integrated intensity map (top right)</span>
<span class="sd">        - Integrated spectrum with spectral line location (top center)</span>
<span class="sd">        - Close up of integrated spectrum with ranges for each channel map (top left)</span>
<span class="sd">        - Tiled channel map</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
                 <span class="n">xformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span> <span class="n">yformatter</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Formatter</span><span class="p">,</span>
                 <span class="n">xlocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span> <span class="n">ylocator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span>
                 <span class="n">xrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">yrotation</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">ticksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">colormap</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">nh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct ChannelMapAxesManager instance.</span>

<span class="sd">        The constructor generates (nh * nv) axes for channel map.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: matplotlib.figure.Figure instance</span>
<span class="sd">            xformatter: tick formatter for x-axis</span>
<span class="sd">            yformatter: tick formatter for y-axis</span>
<span class="sd">            xlocator: tick locator for x-axis</span>
<span class="sd">            ylocator: tick locator for y-axis</span>
<span class="sd">            xrotation: rotation angle of x-axis label</span>
<span class="sd">            yrotation: rotation angle of y-axis label</span>
<span class="sd">            ticksize: tick label size</span>
<span class="sd">            colormap: colormap to use. &#39;gray&#39; for gray scale. Otherwise, &#39;jet&#39; is used.</span>
<span class="sd">            nh: number of channel maps in horizontal direction</span>
<span class="sd">            nv: number of channel maps in vertical direction</span>
<span class="sd">            brightnessunit: unit of the data to be displayed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ChannelMapAxesManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">xformatter</span><span class="p">,</span> <span class="n">yformatter</span><span class="p">,</span>
                                                    <span class="n">xlocator</span><span class="p">,</span> <span class="n">ylocator</span><span class="p">,</span>
                                                    <span class="n">xrotation</span><span class="p">,</span> <span class="n">yrotation</span><span class="p">,</span>
                                                    <span class="n">ticksize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">=</span> <span class="n">nh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">=</span> <span class="n">nv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">=</span> <span class="n">brightnessunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchmap</span> <span class="o">=</span> <span class="n">nh</span> <span class="o">*</span> <span class="n">nv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">left</span> <span class="o">=</span> <span class="mf">2.10</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">0.75</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="mf">0.7</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_full</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_zoom</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chmap</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_integmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for integrated intensity map.</span>

<span class="sd">        Creates and returns Axes instance for integrated intensity</span>
<span class="sd">        map, which is located at the top right of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes instance for integrated intensity map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="mf">0.98</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>

            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xformatter</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yformatter</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xlocator</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ylocator</span><span class="p">)</span>
            <span class="n">xlabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xrotation</span><span class="p">)</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">yrotation</span><span class="p">)</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_labels</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integmap</span> <span class="o">=</span> <span class="n">axes</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_integsp_full</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for integrated spectrum.</span>

<span class="sd">        Creates and returns Axes instance for integrated spectrum,</span>
<span class="sd">        which is located at the top center of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes instance for integrated spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_full</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">0.6</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Integrated Spectrum&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_full</span> <span class="o">=</span> <span class="n">axes</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_full</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_integsp_zoom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for close up view of integrated spectrum.</span>

<span class="sd">        Creates and returns Axes instance for close up view of</span>
<span class="sd">        integrated spectrum, which is located at the top left of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes instance for close up view of integrated spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_zoom</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">0.3</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Relative Velocity w.r.t. Window Center (km/s)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Integrated Spectrum (zoom)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_zoom</span> <span class="o">=</span> <span class="n">axes</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp_zoom</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_chmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instances for channel map.</span>

<span class="sd">        Creates and returns Axes instance for channel map,</span>
<span class="sd">        which is tiled at the bottom of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Axes instances for channel map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chmap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__axes_chmap</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chmap</span>

    <span class="k">def</span> <span class="nf">__axes_chmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instances for channel map.</span>

<span class="sd">        Axes instances are tiled at the bottom of the figure.</span>
<span class="sd">        Total number of instances is self.nh * self.nv.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Axes instances corresponding to individual map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
<span class="c1">#         chmap_hfrac = 0.92 # leave some room for colorbar</span>
<span class="c1">#         offset = 0.01</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchmap</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span>
            <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span> <span class="o">*</span> <span class="n">x</span> <span class="c1">#(x + 0.05)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.85</span> <span class="c1">#0.9</span>
<span class="c1">#             # an attempt to mitigate uneven plot size of panels in the right most column.</span>
<span class="c1">#             left = chmap_hfrac / float(self.nh) * x + offset</span>
<span class="c1">#             width = chmap_hfrac / float(self.nh)-offset</span>
<span class="c1">#             if x==self.nh-1: # add width for colorbar to panels in the right most column</span>
<span class="c1">#                 width = min(width*1.25, 1-offset-left)</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="n">height</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.85</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">])</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>

            <span class="k">yield</span> <span class="n">a</span></div>



<div class="viewcode-block" id="SDSparseMapDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSparseMapDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDSparseMapDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter to create a sparse profile map.&quot;&quot;&quot;</span>

    <span class="n">MaxPanel</span> <span class="o">=</span> <span class="mi">8</span>

<div class="viewcode-block" id="SDSparseMapDisplay.enable_atm">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSparseMapDisplay.enable_atm">[docs]</a>
    <span class="k">def</span> <span class="nf">enable_atm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable overlay of ATM transmission curve.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showatm</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SDSparseMapDisplay.disable_atm">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSparseMapDisplay.disable_atm">[docs]</a>
    <span class="k">def</span> <span class="nf">disable_atm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable overlay of ATM transmission curve.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">showatm</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SDSparseMapDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSparseMapDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of sparse profile maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__plot_sparse_map</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__plot_sparse_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of sparse profile maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Plotting routine</span>
        <span class="n">num_panel</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaxPanel</span><span class="p">)</span>
        <span class="n">STEP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_panel</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">NH</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">)</span> <span class="o">//</span> <span class="n">STEP</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">NV</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span> <span class="o">//</span> <span class="n">STEP</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;num_panel=</span><span class="si">%s</span><span class="s1">, STEP=</span><span class="si">%s</span><span class="s1">, NH=</span><span class="si">%s</span><span class="s1">, NV=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_panel</span><span class="p">,</span> <span class="n">STEP</span><span class="p">,</span> <span class="n">NH</span><span class="p">,</span> <span class="n">NV</span><span class="p">))</span>

        <span class="n">chan0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chan1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span>

        <span class="n">plotter</span> <span class="o">=</span> <span class="n">SDSparseMapPlotter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="p">,</span> <span class="n">NH</span><span class="p">,</span> <span class="n">NV</span><span class="p">,</span> <span class="n">STEP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">refpix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">refval</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">refpix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">refval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">increment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">direction_axis</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">refpix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">refval</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">increment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">direction_axis</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">setup_labels_relative</span><span class="p">(</span><span class="n">refpix</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;showatm&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">showatm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">msid_list</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">msid_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ms_id</span> <span class="ow">in</span> <span class="n">msid_list</span><span class="p">:</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">[</span><span class="n">ms_id</span><span class="p">]</span>
                <span class="n">vis</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span>
                <span class="n">antenna_id</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># nominal</span>
                <span class="n">vspw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
                <span class="n">spw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">vspw_id</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                <span class="n">atm_freq</span><span class="p">,</span> <span class="n">atm_transmission</span> <span class="o">=</span> <span class="n">atmutil</span><span class="o">.</span><span class="n">get_transmission</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">antenna_id</span><span class="o">=</span><span class="n">antenna_id</span><span class="p">,</span>
                                                                      <span class="n">spw_id</span><span class="o">=</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency_frame</span>
                <span class="k">if</span> <span class="n">frame</span> <span class="o">!=</span> <span class="s1">&#39;TOPO&#39;</span><span class="p">:</span>
                    <span class="c1"># do conversion</span>
                    <span class="n">assoc_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">msid_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ms_id</span><span class="p">)</span>
                    <span class="n">field_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fieldid_list</span><span class="p">[</span><span class="n">assoc_id</span><span class="p">]</span>
                    <span class="n">field</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span>
                    <span class="n">direction_ref</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">mdirection</span>
                    <span class="n">start_time</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">start_time</span>
                    <span class="n">end_time</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">end_time</span>
                    <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
                    <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
                    <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
                    <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qmid_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
                    <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">qmid_time</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
                    <span class="n">time_ref</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">],</span>
                                        <span class="n">v0</span><span class="o">=</span><span class="n">qmid_time</span><span class="p">)</span>
                    <span class="n">position_ref</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>

                    <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s1">&#39;REST&#39;</span><span class="p">:</span>
                        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="p">)</span> <span class="k">as</span> <span class="n">mse</span><span class="p">:</span>
                            <span class="c1"># use &#39;SOURCE&#39; to get &#39;REST&#39;, Unit of atm_freq is GHz</span>
                            <span class="n">v_to</span>   <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">cvelfreqs</span><span class="p">(</span> <span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">outframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span> <span class="p">)</span> <span class="o">/</span> <span class="mf">1.0E+9</span>
                            <span class="n">v_from</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">cvelfreqs</span><span class="p">(</span> <span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">outframe</span><span class="o">=</span><span class="s1">&#39;TOPO&#39;</span>   <span class="p">)</span> <span class="o">/</span> <span class="mf">1.0E+9</span>
                        <span class="n">_frameconv</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span> <span class="n">v_from</span><span class="p">,</span> <span class="n">v_to</span><span class="p">,</span>
                                                           <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                                           <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                           <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span> <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># initialize</span>
                        <span class="n">me</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                        <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">time_ref</span><span class="p">)</span>
                        <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">direction_ref</span><span class="p">)</span>
                        <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">position_ref</span><span class="p">)</span>

                        <span class="k">def</span> <span class="nf">_frameconv</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                            <span class="c1"># ATM is always in TOPO</span>
                            <span class="n">m</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="s1">&#39;TOPO&#39;</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;GHz&#39;</span><span class="p">))</span>
                            <span class="n">converted</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
                            <span class="n">qout</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">converted</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">outunit</span><span class="o">=</span><span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
                            <span class="k">return</span> <span class="n">qout</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

                    <span class="n">atm_freq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_frameconv</span><span class="p">,</span> <span class="n">atm_freq</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">atm_freq</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                    <span class="n">me</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">set_atm_transmission</span><span class="p">(</span><span class="n">atm_transmission</span><span class="p">,</span> <span class="n">atm_freq</span><span class="p">)</span>

        <span class="c1"># loop over pol</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">Plot</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_panel</span><span class="p">,</span> <span class="n">num_panel</span><span class="p">,</span> <span class="p">(</span><span class="n">chan1</span> <span class="o">-</span> <span class="n">chan0</span><span class="p">)),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="n">NoData</span>
            <span class="n">TotalSP</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">isvalid</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">Nsp</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">isvalid</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Nsp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">Nsp</span><span class="p">)</span>
            <span class="n">TotalSP</span> <span class="o">/=</span> <span class="n">Nsp</span>

            <span class="n">slice_axes</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NH</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">STEP</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">STEP</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NV</span><span class="p">):</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">STEP</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">STEP</span>
                    <span class="n">valid_index</span> <span class="o">=</span> <span class="n">isvalid</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">]</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
                    <span class="n">chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_chunk</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">pol</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">pol</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">slice_axes</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_array_chunk</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">pol</span><span class="p">),</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">pol</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">slice_axes</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span>
                    <span class="n">valid_sp</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[</span><span class="n">valid_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
                    <span class="n">Plot</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">valid_sp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">valid_index</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">valid_sp</span>
            <span class="k">del</span> <span class="n">isvalid</span>

            <span class="n">FigFileRoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span><span class="o">+</span><span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">_Sparse&#39;</span> <span class="o">%</span> <span class="n">pol</span>
            <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">FigFileRoot</span><span class="o">+</span><span class="s1">&#39;_0.png&#39;</span><span class="p">)</span>

            <span class="n">status</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Plot</span><span class="p">,</span> <span class="n">TotalSP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span><span class="p">],</span>
                                  <span class="n">figfile</span><span class="o">=</span><span class="n">plotfile</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">Plot</span><span class="p">,</span> <span class="n">TotalSP</span>

            <span class="k">if</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span> <span class="c1">#polmap[pol]</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd_sparse_map&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

                <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                                   <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
                                   <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
                                   <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                   <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">plotter</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">plot_list</span>

    <span class="k">def</span> <span class="nf">_get_array_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">blc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">trc</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">axes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a slice of an array.</span>

<span class="sd">        data : an array that could be sliced</span>
<span class="sd">        blc : a list of minimum index in each dimention of axes to slice</span>
<span class="sd">        trc : a list of maximum index in each dimention of axes to slice</span>
<span class="sd">              Note trc is used for the second parameter to construct slice.</span>
<span class="sd">              Hence, the indices of last elements in returned array is trc-1</span>
<span class="sd">        axes : a list of dimention of axes in cube blc and trc corresponds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array_shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array_shape</span><span class="p">)</span>
        <span class="n">full_blc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">full_trc</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array_shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
            <span class="n">iax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">full_blc</span><span class="p">[</span><span class="n">iax</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">blc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">full_trc</span><span class="p">[</span><span class="n">iax</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">trc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">array_shape</span><span class="p">[</span><span class="n">iax</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">slice</span><span class="p">,</span> <span class="n">full_blc</span><span class="p">,</span> <span class="n">full_trc</span><span class="p">)))]</span></div>



<div class="viewcode-block" id="SDChannelMapDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDChannelMapDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDChannelMapDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter to create a channel map.&quot;&quot;&quot;</span>

    <span class="n">NUM_CHANNELMAP</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">NhPanel</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">NvPanel</span> <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="SDChannelMapDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDChannelMapDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of channel maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes_string</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__plot_channel_map</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__get_integrated_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute integrated spectrum from the image.</span>

<span class="sd">        Image weights provided by the weight image is taken into account.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Integrated spectrum as masked array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">imagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
        <span class="n">weightname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;.weight&#39;</span>
        <span class="n">new_id_stokes</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_spectral</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="c1"># un-weighted image</span>
        <span class="n">unweight_ia</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">imagecalc</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pixels</span><span class="o">=</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; * &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">weightname</span><span class="p">))</span>

        <span class="c1"># if all pixels are masked, return fully masked array</span>
        <span class="n">unweight_mask</span> <span class="o">=</span> <span class="n">unweight_ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">unweight_mask</span><span class="p">)):</span>
            <span class="n">unweight_ia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">sp_ave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                                           <span class="n">mask</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">sp_ave</span>

        <span class="c1"># average image spectra over map area taking mask into account</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">collapsed_ia</span> <span class="o">=</span> <span class="n">unweight_ia</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_direction</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">unweight_ia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data_integ</span> <span class="o">=</span> <span class="n">collapsed_ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">dropdeg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mask_integ</span> <span class="o">=</span> <span class="n">collapsed_ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">dropdeg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">collapsed_ia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># set mask to weight image</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">maskname</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">weightname</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">maskname</span> <span class="o">!=</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>  <span class="c1"># &#39;T&#39; is no mask (usually an image from completely flagged MSes)</span>
                <span class="n">ia</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">maskname</span><span class="p">])</span>
                <span class="n">ia</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">maskname</span><span class="p">),</span> <span class="n">maskname</span><span class="p">])</span>
                <span class="n">ia</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">maskname</span><span class="p">)</span>
            <span class="c1"># average weight over map area taking the mask into account</span>
            <span class="n">collapsed_ia</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">collapse</span><span class="p">(</span><span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_direction</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">weight_integ</span> <span class="o">=</span> <span class="n">collapsed_ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">dropdeg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">collapsed_ia</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># devive averaged image by averaged weight</span>
        <span class="n">data_weight_integ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">((</span><span class="n">data_integ</span> <span class="o">/</span> <span class="n">weight_integ</span><span class="p">),</span> <span class="p">[</span><span class="ow">not</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">mask_integ</span><span class="p">],</span>
                                                  <span class="n">fill_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">sp_ave</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_weight_integ</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">:</span>
                <span class="n">sp_ave</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data_weight_integ</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
                <span class="n">curr_sp</span> <span class="o">=</span> <span class="n">data_weight_integ</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">new_id_stokes</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">curr_sp</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">:</span>
                    <span class="n">sp_ave</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">curr_sp</span>
        <span class="k">return</span> <span class="n">sp_ave</span>

    <span class="k">def</span> <span class="nf">__plot_channel_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of channel maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;color&#39;</span>
        <span class="n">scale_max</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">scale_min</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">is_freq_chan_reversed_image</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">SDImagingResultItem</span><span class="p">):</span>
            <span class="n">is_freq_chan_reversed_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">frequency_channel_reversed</span>

        <span class="c1"># retrieve line list from reduction group</span>
        <span class="c1"># key is antenna and spw id</span>
        <span class="n">line_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">valid_lines</span><span class="p">(</span><span class="n">is_freq_chan_reversed_image</span><span class="p">)</span>

        <span class="c1"># 2010/6/9 in the case of non-detection of the lines</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plot_list</span>

        <span class="c1"># Set data</span>
        <span class="n">Map</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span><span class="p">,</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                          <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="c1"># Swap (x,y) to match the clustering result</span>
        <span class="n">grid_size_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">*</span> <span class="mf">3600.0</span>
        <span class="n">ExtentCM</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size_arcsec</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size_arcsec</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size_arcsec</span><span class="p">,</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">grid_size_arcsec</span><span class="p">)</span>
        <span class="n">Extent</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">span</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="p">(</span><span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">)</span> <span class="o">=</span> \
            <span class="n">pointing</span><span class="o">.</span><span class="n">XYlabel</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span><span class="p">)</span>

        <span class="c1"># How to coordinate the map</span>
        <span class="n">TickSize</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="c1"># Initialize axes</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span>
        <span class="n">axes_manager</span> <span class="o">=</span> <span class="n">ChannelMapAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">,</span>
                                             <span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span>
                                             <span class="n">RArotation</span><span class="p">,</span> <span class="n">DECrotation</span><span class="p">,</span>
                                             <span class="n">TickSize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">NhPanel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NvPanel</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">)</span>
        <span class="n">axes_manager</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span>
        <span class="n">axes_integmap</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">axes_integmap</span>
        <span class="n">beam_circle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">axes_integsp1</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">axes_integsp_full</span>
        <span class="n">axes_integsp2</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">axes_integsp_zoom</span>
        <span class="n">axes_chmap</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">axes_chmap</span>

        <span class="n">Sp_integ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_integrated_spectra</span><span class="p">()</span>
        <span class="c1"># loop over detected lines</span>
        <span class="n">ValidCluster</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>

        <span class="c1"># If the frequency channel of the image cube has been reversed to ascending,</span>
        <span class="c1"># indices of frequency and velocity must have an offset to get a center value of them.</span>
        <span class="k">if</span> <span class="n">is_freq_chan_reversed_image</span><span class="p">:</span>
            <span class="n">_offset</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">_left_edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">_left_edge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># NOTE: Variable names MUST be easy to understand.</span>
        <span class="c1"># The variables with the prefixes, &#39;idx_&#39; and &#39;indices_&#39;, indicate they are an index or</span>
        <span class="c1"># sequence (list, set, array, etc.) of indices in the loop below.</span>

        <span class="k">for</span> <span class="n">line_window</span> <span class="ow">in</span> <span class="n">line_list</span><span class="p">:</span>
            <span class="n">_line_center</span> <span class="o">=</span> <span class="n">line_window</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">_line_width</span> <span class="o">=</span> <span class="n">line_window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">_line_center_shifted</span> <span class="o">=</span> <span class="n">_line_center</span> <span class="o">-</span> <span class="n">_left_edge</span>

            <span class="c1"># Offset calculation of index(int) from line(float) when the line has a decimal point of 0.5</span>
            <span class="c1"># and frequency channel of the image is reversed;</span>
            <span class="c1"># ex) n=107.5, nchan=128, reversed_n = nchan-1-n = 19.5</span>
            <span class="c1"># when the real numeric cut-edge is 0.5 then the calculation of index 1-0.5 is to be neary 0.5 and not 0.5.</span>
            <span class="c1"># So, the cut-edge which has 0.5 + offset 0.5 like int(19.5 + 0.5) must be 19, not 20.</span>
            <span class="n">_cut_edge_offset</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">is_freq_chan_reversed_image</span> <span class="ow">and</span> <span class="n">_line_center_shifted</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">_line_center_shifted</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">_cut_edge_offset</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1"># shift channel according to the edge parameter</span>
            <span class="n">idx_line_center</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_line_center_shifted</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-</span> <span class="n">_cut_edge_offset</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">idx_line_center</span><span class="p">)</span> <span class="o">==</span> <span class="n">_line_center_shifted</span><span class="p">:</span>
                <span class="n">velocity_line_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_freq_chan_reversed_image</span><span class="p">:</span>
                    <span class="n">velocity_line_center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">velocity_line_center</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">]</span> <span class="o">+</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;center velocity[</span><span class="si">{</span><span class="n">idx_line_center</span><span class="si">}</span><span class="s1">]: </span><span class="si">{</span><span class="n">velocity_line_center</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx_line_center</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ChanVelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ChanVelWidth</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_line_center</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;center frequency[</span><span class="si">{</span><span class="n">idx_line_center</span><span class="si">}</span><span class="s2">]: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># 2007/9/13 Change the magnification factor 1.2 to your preference (to Dirk)</span>
            <span class="c1"># be sure the width of one channel map is integer</span>
            <span class="c1"># 2014/1/12 factor 1.4 -&gt; 1.0 since velocity structure was taken into account for the range in validation.py</span>
            <span class="n">indices_slice_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">_line_width</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_left_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_line_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">indices_slice_width</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="n">_offset</span><span class="p">)</span>
            <span class="c1"># 2007/9/10 remedy for &#39;out of index&#39; error</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;idx_left_end, indices_slice_width, NchanMap : &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">idx_left_end</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">indices_slice_width</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx_left_end</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">indices_slice_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_line_center</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indices_slice_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">idx_left_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_line_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">indices_slice_width</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">idx_left_end</span> <span class="o">+</span> <span class="n">indices_slice_width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">:</span>
                <span class="n">indices_slice_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">idx_line_center</span><span class="p">)</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">indices_slice_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">idx_left_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">idx_line_center</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">indices_slice_width</span><span class="p">)</span>

            <span class="n">chan0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx_left_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">chan1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">idx_left_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">*</span> <span class="n">indices_slice_width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">V0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">chan0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">chan1</span><span class="p">])</span> <span class="o">-</span> <span class="n">velocity_line_center</span>
            <span class="n">V1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">chan0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">chan1</span><span class="p">])</span> <span class="o">-</span> <span class="n">velocity_line_center</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;chan0, chan1, V0, V1, velocity_line_center : &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">chan0</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">chan1</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">V0</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">V1</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">velocity_line_center</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">vertical_lines</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># vertical lines for integrated spectrum #1</span>
            <span class="n">vertical_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">axes_integsp1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan0</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">vertical_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">axes_integsp1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Drawing red vertical lines for integrated spectrum #2</span>
            <span class="c1"># For detail, see the MEMO below.</span>
            <span class="n">_indices_width_of_emission_line</span> <span class="o">=</span> <span class="n">indices_slice_width</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span>
            <span class="n">_x_chan</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">idx_left_end</span><span class="p">,</span> <span class="n">idx_left_end</span> <span class="o">+</span> <span class="n">_indices_width_of_emission_line</span><span class="p">)</span>
            <span class="n">_y_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">idx_left_end</span><span class="p">:</span><span class="n">idx_left_end</span> <span class="o">+</span> <span class="n">_indices_width_of_emission_line</span><span class="p">]</span>
            <span class="n">chan2vel</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">_x_chan</span><span class="p">,</span> <span class="n">_y_vel</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>

            <span class="c1"># calculate relative velocities for red vertical lines</span>
            <span class="n">_chans</span> <span class="o">=</span> <span class="p">[</span><span class="n">idx_left_end</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">indices_slice_width</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">vertlines</span> <span class="o">=</span> <span class="n">chan2vel</span><span class="p">(</span><span class="n">_chans</span><span class="p">)</span> <span class="o">-</span> <span class="n">velocity_line_center</span>

            <span class="n">vertical_lines</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">(</span><span class="n">axes_integsp2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vertlines</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Relative velocities of the vertical lines: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">vertlines</span><span class="p">)</span>

            <span class="c1"># MEMO:</span>
            <span class="c1"># - For the velocity plot #2, the red vertical lines are drawn at the relative velocity</span>
            <span class="c1">#   values calculated by linear interpolation.</span>
            <span class="c1">#   These lines indicate the boundaries of NUM_CHANNELMAP slices, with each slice having</span>
            <span class="c1">#   a number of indices_slice_width channels. The velocity values at the boundaries are</span>
            <span class="c1">#   calculated by linear interpolating the channel-center velocity values (self.velocity[]).</span>
            <span class="c1">#   Extrapolation for 1/2 channels will be done to calculate the velocity values at the</span>
            <span class="c1">#   very end of the line_window.</span>
            <span class="c1"># - On the other hand, for the frequency plot #1, the channel-center velocity values</span>
            <span class="c1">#   (self.velocity[]) are directly used to indicate the bounderies of the line_window as two</span>
            <span class="c1">#   red vertical lines, hence no interpolations. Therefore the positions of the red lines of</span>
            <span class="c1">#   plot #1 are slightly shifted by 0.5 ch compared to the corresponding lines in plot #2.</span>

            <span class="c1"># loop over polarizations</span>
            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
                <span class="n">plotted_objects</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">masked_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span>
                               <span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

                <span class="c1"># Integrated Spectrum</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Draw Total Intensity Map</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">masked_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ChanVelWidth</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

                <span class="c1"># 2008/9/20 DEC Effect</span>
                <span class="n">plotted_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">axes_integmap</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                         <span class="n">aspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">Extent</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">xlim</span> <span class="o">=</span> <span class="n">axes_integmap</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
                <span class="n">ylim</span> <span class="o">=</span> <span class="n">axes_integmap</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

                <span class="c1"># colorbar</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;total min:</span><span class="si">{</span><span class="n">total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s1">, total max:</span><span class="si">{</span><span class="n">total</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">total</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="n">total</span><span class="o">.</span><span class="n">max</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">)):</span>
                        <span class="n">axes_manager</span><span class="o">.</span><span class="n">set_colorbar_for</span><span class="p">(</span><span class="n">axes_integmap</span><span class="p">,</span> <span class="n">total</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">total</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="si">}</span><span class="s1"> km/s&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

                <span class="c1"># draw beam pattern</span>
                <span class="k">if</span> <span class="n">beam_circle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">beam_circle</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">draw_beam</span><span class="p">(</span><span class="n">axes_integmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">)</span>

                <span class="n">axes_integmap</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Total Intensity: CenterFreq.= </span><span class="si">%.3f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">idx_line_center</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>
                <span class="n">axes_integmap</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
                <span class="n">axes_integmap</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>

                <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Plot Integrated Spectrum #1</span>
                <span class="n">Sp</span> <span class="o">=</span> <span class="n">Sp_integ</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:]</span>
                <span class="p">(</span><span class="n">F0</span><span class="p">,</span> <span class="n">F1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">spmin</span> <span class="o">=</span> <span class="n">Sp</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">spmax</span> <span class="o">=</span> <span class="n">Sp</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">dsp</span> <span class="o">=</span> <span class="n">spmax</span> <span class="o">-</span> <span class="n">spmin</span>
                <span class="n">spmin</span> <span class="o">-=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="n">spmax</span> <span class="o">+=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Freq0, Freq1: </span><span class="si">{</span><span class="n">F0</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">F1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">axes_integsp1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">Sp</span><span class="p">,</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                   <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                <span class="n">axes_integsp1</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">F0</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">spmin</span><span class="p">,</span> <span class="n">spmax</span><span class="p">])</span>

                <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Plot Integrated Spectrum #2</span>
                <span class="n">axes_integsp2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">velocity_line_center</span><span class="p">,</span>
                                   <span class="n">Sp</span><span class="p">[</span><span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;-b&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                                   <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                <span class="c1"># adjust Y-axis range to the current line</span>
                <span class="n">spmin_zoom</span> <span class="o">=</span> <span class="n">Sp</span><span class="p">[</span><span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="n">spmax_zoom</span> <span class="o">=</span> <span class="n">Sp</span><span class="p">[</span><span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">dsp</span> <span class="o">=</span> <span class="n">spmax_zoom</span> <span class="o">-</span> <span class="n">spmin_zoom</span>
                <span class="n">spmin_zoom</span> <span class="o">-=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="n">spmax_zoom</span> <span class="o">+=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="n">axes_integsp2</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">spmin_zoom</span><span class="p">,</span> <span class="n">spmax_zoom</span><span class="p">])</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Velo0, Velo1: </span><span class="si">{</span><span class="n">V0</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">V1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

                <span class="c1"># Draw Channel Map</span>
                <span class="n">NMap</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">Vmax0</span> <span class="o">=</span> <span class="n">Vmin0</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">Title</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span><span class="p">):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_CHANNELMAP</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">C0</span> <span class="o">=</span> <span class="n">idx_left_end</span> <span class="o">+</span> <span class="n">indices_slice_width</span> <span class="o">*</span> <span class="n">ii</span>
                    <span class="n">C1</span> <span class="o">=</span> <span class="n">C0</span> <span class="o">+</span> <span class="n">indices_slice_width</span>
                    <span class="k">if</span> <span class="n">C0</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">C1</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">velo</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">C0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">C1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">velocity_line_center</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">C0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">[</span><span class="n">C1</span><span class="p">])</span>
                    <span class="n">Title</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(Vel,Wid) = (</span><span class="si">%.1f</span><span class="s1">, </span><span class="si">%.1f</span><span class="s1">) (km/s)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">velo</span><span class="p">,</span> <span class="n">width</span><span class="p">))</span>
                    <span class="n">NMap</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">_mask</span> <span class="o">=</span> <span class="n">masked_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">C0</span><span class="p">:</span><span class="n">C1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ChanVelWidth</span>
                    <span class="n">Map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">_mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
                <span class="k">del</span> <span class="n">masked_data</span>
                <span class="n">Vmax0</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">Vmin0</span> <span class="o">=</span> <span class="n">Map</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_max</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">Vmax</span> <span class="o">=</span> <span class="n">Vmax0</span> <span class="o">-</span> <span class="p">(</span><span class="n">Vmax0</span> <span class="o">-</span> <span class="n">Vmin0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Vmax</span> <span class="o">=</span> <span class="n">scale_max</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scale_min</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">Vmin</span> <span class="o">=</span> <span class="n">Vmin0</span> <span class="o">+</span> <span class="p">(</span><span class="n">Vmax0</span> <span class="o">-</span> <span class="n">Vmin0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Vmin</span> <span class="o">=</span> <span class="n">scale_min</span>

                <span class="k">if</span> <span class="n">Vmax</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Vmin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data to create channel maps. Check the flagging criteria.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">plot_list</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NMap</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">Vmax</span> <span class="o">!=</span> <span class="n">Vmin</span><span class="p">:</span>
                        <span class="n">axes_chmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">Map</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="n">Vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">Vmax</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span>
                                             <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">ExtentCM</span><span class="p">)</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">NhPanel</span>
                        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NhPanel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                            <span class="n">axes_manager</span><span class="o">.</span><span class="n">set_colorbar_for</span><span class="p">(</span><span class="n">axes_chmap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vmin</span><span class="p">,</span> <span class="n">Vmax</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="si">}</span><span class="s1"> km/s&#39;</span><span class="p">)</span>

                        <span class="n">axes_chmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">Title</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>

                <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;PROFILE: integrated intensity map: </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t0</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;PROFILE: integrated spectrum #1: </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;PROFILE: integrated spectrum #2: </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t3</span> <span class="o">-</span> <span class="n">t2</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;PROFILE: channel map: </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t4</span> <span class="o">-</span> <span class="n">t3</span><span class="p">))</span>

                <span class="n">FigFileRoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pol</span><span class="p">)</span>
                <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">FigFileRoot</span> <span class="o">+</span> <span class="s1">&#39;_ChannelMap_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ValidCluster</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">axes_integmap</span><span class="p">,</span> <span class="n">axes_integsp1</span><span class="p">,</span> <span class="n">axes_integsp2</span><span class="p">],</span> <span class="n">axes_chmap</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">_a</span><span class="o">.</span><span class="n">lines</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">texts</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">patches</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">images</span><span class="p">[:]):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vertical_lines</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">obj</span> <span class="o">!=</span> <span class="n">beam_circle</span><span class="p">):</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

                <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>  <span class="c1"># polmap[pol]</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;channel_map&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>
                <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan0</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span><span class="p">]</span>  <span class="c1"># GHz -&gt; Hz</span>

                <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                                   <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;R.A.&#39;</span><span class="p">,</span>
                                   <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Dec.&#39;</span><span class="p">,</span>
                                   <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                   <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
                <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

            <span class="n">ValidCluster</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">vertical_lines</span><span class="p">:</span>
                <span class="n">line</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="k">del</span> <span class="n">axes_manager</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>



<div class="viewcode-block" id="SDRmsMapDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDRmsMapDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDRmsMapDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter to create a baseline rms map.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SDRmsMapDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDRmsMapDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of baseline rms maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">()</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;__plot: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>


    <span class="k">def</span> <span class="nf">__get_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute baseline rms for each spatial pixel.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two-dimensional array of baseline rms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reshape rms to a 3d array in shape, (nx_im, ny_im, npol_data)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reshape_grid_table_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_num_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute number of valid spectra associated with each spatial pixel.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Two-dimentional array of number of valid spectra</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reshape validsp to a 3d array in shape, (nx_im, ny_im, npol_data)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reshape_grid_table_values</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;validsp&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__reshape_grid_table_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array2d</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reshape input 2-D array into 3-D array.</span>

<span class="sd">        The input two-dimensional array with shape (npol, nx * ny) into</span>
<span class="sd">        three-dimensional array with shape (nx, ny, npol).</span>

<span class="sd">        Args:</span>
<span class="sd">            array2d: Input two-dimensional array.</span>
<span class="sd">            dtype: Array data type. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reshaped array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reshape 2d array in shape, (npol, nx*ny), to (nx, ny, npol)</span>
        <span class="n">npol_data</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array2d</span><span class="p">)</span>
        <span class="c1"># retruned value will be transposed</span>
        <span class="n">array3d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npol_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array2d</span><span class="p">[</span><span class="n">pol</span><span class="p">])</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">:</span>
                <span class="n">array3d</span><span class="p">[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array2d</span><span class="p">[</span><span class="n">pol</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">array3d</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of baseline rms maps.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="n">colormap</span> <span class="o">=</span> <span class="s1">&#39;color&#39;</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 2008/9/20 Dec Effect has been taken into account</span>
        <span class="c1">#Aspect = 1.0 / math.cos(0.5 * (self.dec_min + self.dec_max) / 180.0 * 3.141592653)</span>

        <span class="c1"># Draw RMS Map</span>
        <span class="n">TickSize</span> <span class="o">=</span> <span class="mi">6</span>

        <span class="n">Extent</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
        <span class="n">span</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
        <span class="p">(</span><span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">)</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">XYlabel</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span><span class="p">)</span>

        <span class="n">axes_manager</span> <span class="o">=</span> <span class="n">SingleImageAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">RAformatter</span><span class="p">,</span> <span class="n">DECformatter</span><span class="p">,</span>
                                              <span class="n">RAlocator</span><span class="p">,</span> <span class="n">DEClocator</span><span class="p">,</span>
                                              <span class="n">RArotation</span><span class="p">,</span> <span class="n">DECrotation</span><span class="p">,</span>
                                              <span class="n">TickSize</span><span class="p">,</span> <span class="n">colormap</span><span class="p">)</span>
        <span class="n">axes_manager</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span>
        <span class="n">rms_axes</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">image_axes</span>
        <span class="n">beam_circle</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rms</span><span class="p">()</span>
        <span class="n">nvalid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_num_valid</span><span class="p">()</span>

        <span class="c1"># threshold percentages (minimum and maximum)</span>
        <span class="n">beam_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span> <span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">))</span>
        <span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">thres_min</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 percent</span>
        <span class="n">thres_max</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">length</span><span class="o">*</span><span class="n">beam_pix</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span>

        <span class="n">npol_data</span> <span class="o">=</span> <span class="n">rms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="c1">#        for pol in xrange(self.npol):</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol_data</span><span class="p">):</span>
            <span class="n">rms_map</span> <span class="o">=</span> <span class="n">rms</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">pol</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvalid</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">pol</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">rms_map</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">rms_map</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span>
            <span class="n">rms_map_v</span> <span class="o">=</span> <span class="n">rms_map</span><span class="p">[</span><span class="o">~</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rms_map</span><span class="p">)]</span>
            <span class="n">rms_map_v</span> <span class="o">=</span> <span class="n">rms_map</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">rms_map</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rms_map_v</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># threshold values (minimum and maximum)</span>
            <span class="n">q_min</span><span class="p">,</span> <span class="n">q_max</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">rms_map_v</span><span class="p">,</span> <span class="p">[</span><span class="n">thres_min</span><span class="p">,</span> <span class="n">thres_max</span><span class="p">])</span>
            <span class="c1"># 2008/9/20 DEC Effect</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">rms_axes</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rms_map</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">q_min</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">Extent</span><span class="p">)</span>
            <span class="n">xlim</span> <span class="o">=</span> <span class="n">rms_axes</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">rms_axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="c1"># colorbar</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">q_min</span> <span class="o">==</span> <span class="n">q_max</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">)):</span>
                    <span class="n">axes_manager</span><span class="o">.</span><span class="n">set_colorbar_for</span><span class="p">(</span><span class="n">rms_axes</span><span class="p">,</span> <span class="n">q_min</span><span class="p">,</span> <span class="n">q_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

            <span class="k">del</span> <span class="n">rms_map</span>

            <span class="c1"># draw beam pattern</span>
            <span class="k">if</span> <span class="n">beam_circle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">beam_circle</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">draw_beam</span><span class="p">(</span><span class="n">rms_axes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">)</span>

            <span class="n">rms_axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
            <span class="n">rms_axes</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">rms_axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Baseline RMS Map&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>

            <span class="n">FigFileRoot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">pol</span>
            <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">FigFileRoot</span><span class="o">+</span><span class="s1">&#39;_rmsmap.png&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>

            <span class="n">image</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polmap</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rms_map&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

            <span class="n">plot2</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                                <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;R.A.&#39;</span><span class="p">,</span>
                                <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Dec.&#39;</span><span class="p">,</span>
                                <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot2</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>



<div class="viewcode-block" id="SpectralMapAxesManager">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SpectralMapAxesManager">[docs]</a>
<span class="k">class</span> <span class="nc">SpectralMapAxesManager</span><span class="p">(</span><span class="n">MapAxesManagerBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates and manages Axes instances for detailed spectral map.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">nh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">locator</span><span class="p">:</span> <span class="n">ticker</span><span class="o">.</span><span class="n">Locator</span><span class="p">,</span> <span class="n">ticksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create SpectralMapAxesManager instance.</span>

<span class="sd">        Total number of Axes instances in the figure is nh * nv.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: figure.Figure instance</span>
<span class="sd">            nh: number of Axes instances in horizontal direction</span>
<span class="sd">            nv: number of Axes instances in vertical direction</span>
<span class="sd">            brightnessunit: unit for the image</span>
<span class="sd">            locator: locator for x-axis</span>
<span class="sd">            ticksize: tick label size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpectralMapAxesManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">=</span> <span class="n">nh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">=</span> <span class="n">nv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">=</span> <span class="n">brightnessunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">locator</span> <span class="o">=</span> <span class="n">locator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">=</span> <span class="n">ticksize</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of Axes instances for the profile map.</span>

<span class="sd">        Translation of one-dimensional list into two-dimensional location</span>
<span class="sd">        is needed.</span>

<span class="sd">          - The first Axes corresponds to the bottom left panel</span>
<span class="sd">          - The first to (nh-1)-th Axes form the bottom row of the profile map</span>
<span class="sd">          - The nh-th to (2*nh-1)-th Axes form the next row, which is right above</span>
<span class="sd">            the bottom row</span>
<span class="sd">          - Similarly, the list is translated into nv rows in total</span>
<span class="sd">          - The last Axes corresponds to the top right panel</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Axes instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__axes_list</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes</span>

    <span class="k">def</span> <span class="nf">__axes_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">axes</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create list of Axes instances for detailed profile map.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Axes instance corresponding to each panel of profile map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">npanel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nv</span>
        <span class="k">for</span> <span class="n">ipanel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npanel</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">ipanel</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span>
            <span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipanel</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span>
            <span class="c1">#x0 = 1.0 / float(self.nh) * (x + 0.1)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mf">0.22</span><span class="p">)</span>
            <span class="c1">#x1 = 1.0 / float(self.nh) * 0.8</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.75</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">0.15</span><span class="p">)</span>
            <span class="c1">#y1 = 1.0 / float(self.nv) * 0.7</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.65</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">locator</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="o">-</span><span class="mf">0.22</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_y</span><span class="p">(</span><span class="mf">0.95</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">a</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>

            <span class="k">yield</span> <span class="n">a</span></div>



<div class="viewcode-block" id="SDSpectralMapDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSpectralMapDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDSpectralMapDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter for detailed spectral map.&quot;&quot;&quot;</span>

    <span class="n">MaxNhPanel</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">MaxNvPanel</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="SDSpectralMapDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSpectralMapDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create detailed profile map.</span>

<span class="sd">        If provided image is so large that its number of spatial pixels</span>
<span class="sd">        exceed the number of panels for single sparse map, multiple</span>
<span class="sd">        image files are created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of detailed profile maps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__plot_spectral_map</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">__get_strides</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the stride for creating profile map.</span>

<span class="sd">        The stride represents the number of spatial pixels that are combined into</span>
<span class="sd">        single profile map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of strides in horizontal and vertical directions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">units</span>
        <span class="n">factors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_direction</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">increments</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">units</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">factors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">/</span> <span class="n">cell</span><span class="p">))))</span>
        <span class="k">return</span> <span class="n">factors</span>

    <span class="k">def</span> <span class="nf">__plot_spectral_map</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create detailed profile map.</span>

<span class="sd">        If provided image is so large that its number of spatial pixels</span>
<span class="sd">        exceed the number of panels for single sparse map, multiple</span>
<span class="sd">        image files are created.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of detailed profile maps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="p">(</span><span class="n">STEPX</span><span class="p">,</span> <span class="n">STEPY</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_strides</span><span class="p">()</span>

        <span class="c1"># Raster Case: re-arrange spectra to match RA-DEC orientation</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;raster&#39;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;RASTER&#39;</span><span class="p">:</span>
            <span class="c1"># the number of panels in each page</span>
            <span class="n">NhPanel</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">STEPX</span><span class="p">,</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">STEPY</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaxNhPanel</span><span class="p">)</span>
            <span class="n">NvPanel</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">STEPX</span><span class="p">,</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">STEPY</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">MaxNvPanel</span><span class="p">)</span>
            <span class="c1"># total number of pages in horizontal and vertical directions</span>
            <span class="n">NH</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span><span class="p">)</span> <span class="o">//</span> <span class="n">STEPX</span> <span class="o">//</span> <span class="n">NhPanel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">NV</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span><span class="p">)</span> <span class="o">//</span> <span class="n">STEPY</span> <span class="o">//</span> <span class="n">NvPanel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># an array with length of total number of spectra to be plotted (initialized by -1)</span>
            <span class="n">ROWS</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">NH</span> <span class="o">*</span> <span class="n">NV</span> <span class="o">*</span> <span class="n">NhPanel</span> <span class="o">*</span> <span class="n">NvPanel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="c1"># 2010/6/15 GK Change the plotting direction: UpperLeft-&gt;UpperRight-&gt;OneLineDown repeat...</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">STEPX</span><span class="p">):</span>
                <span class="n">posx</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="n">STEPX</span> <span class="o">//</span> <span class="n">NhPanel</span>
                <span class="n">offsetx</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">//</span><span class="n">STEPX</span> <span class="p">)</span> <span class="o">%</span> <span class="n">NhPanel</span>
                <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">STEPY</span><span class="p">):</span>
                    <span class="n">posy</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">//</span><span class="n">STEPY</span> <span class="o">//</span> <span class="n">NvPanel</span>
                    <span class="n">offsety</span> <span class="o">=</span> <span class="n">NvPanel</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">//</span><span class="n">STEPY</span> <span class="o">%</span> <span class="n">NvPanel</span>
                    <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">+</span> <span class="n">y</span>
                    <span class="n">ROWS</span><span class="p">[(</span><span class="n">posy</span><span class="o">*</span><span class="n">NH</span><span class="o">+</span><span class="n">posx</span><span class="p">)</span><span class="o">*</span><span class="n">NvPanel</span><span class="o">*</span><span class="n">NhPanel</span> <span class="o">+</span> <span class="n">offsety</span><span class="o">*</span><span class="n">NhPanel</span> <span class="o">+</span> <span class="n">offsetx</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">### This block is currently broken (2016/06/23 KS)</span>
            <span class="c1">#ROWS = rows[:]</span>
            <span class="c1">#NROW = len(rows)</span>
            <span class="c1">#Npanel = (NROW - 1) / (self.MaxNhPanel * self.MaxNvPanel) + 1</span>
            <span class="c1">#if Npanel &gt; 1:  (NhPanel, NvPanel) = (self.MaxNhPanel, self.MaxNvPanel)</span>
            <span class="c1">#else: (NhPanel, NvPanel) = (int((NROW - 0.1) ** 0.5) + 1, int((NROW - 0.1) ** 0.5) + 1)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;non-Raster map is not supported yet.&quot;</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating spectral map&quot;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Stride: [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">STEPX</span><span class="p">,</span> <span class="n">STEPY</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Number of panels: [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NhPanel</span><span class="p">,</span> <span class="n">NvPanel</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Number of pages: [</span><span class="si">%d</span><span class="s2">, </span><span class="si">%d</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">NH</span><span class="p">,</span> <span class="n">NV</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;- Number of spcetra to be plotted: </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)))</span>

        <span class="n">Npanel</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">TickSize</span> <span class="o">=</span> <span class="mi">11</span> <span class="o">-</span> <span class="n">NhPanel</span>

        <span class="c1"># Plotting routine</span>
        <span class="n">connect</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">connect</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">Mark</span> <span class="o">=</span> <span class="s1">&#39;-b&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Mark</span> <span class="o">=</span> <span class="s1">&#39;bo&#39;</span>
        <span class="n">chan0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">chan1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">chan1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">chan0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">chan1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan1</span><span class="p">])</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="n">chan1</span><span class="p">])</span>

        <span class="n">NSp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xtick</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span>
        <span class="n">Order</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xtick</span><span class="p">)))</span>
        <span class="n">NewTick</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xtick</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">Order</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">Order</span><span class="p">)</span>
        <span class="n">FreqLocator</span> <span class="o">=</span> <span class="n">MultipleLocator</span><span class="p">(</span><span class="n">NewTick</span><span class="p">)</span>

        <span class="p">(</span><span class="n">xrp</span><span class="p">,</span> <span class="n">xrv</span><span class="p">,</span> <span class="n">xic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">direction_axis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">(</span><span class="n">yrp</span><span class="p">,</span> <span class="n">yrv</span><span class="p">,</span> <span class="n">yic</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">direction_axis</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">axes_manager</span> <span class="o">=</span> <span class="n">SpectralMapAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">NhPanel</span><span class="p">,</span> <span class="n">NvPanel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span>
                                              <span class="n">FreqLocator</span><span class="p">,</span>
                                              <span class="n">TickSize</span><span class="p">)</span>
        <span class="n">axes_list</span> <span class="o">=</span> <span class="n">axes_manager</span><span class="o">.</span><span class="n">axes_list</span>

        <span class="c1"># MS-based procedure</span>
        <span class="n">reference_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">msid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">is_baselined</span> <span class="o">=</span> <span class="n">reference_data</span><span class="o">.</span><span class="n">get_data_column</span><span class="p">(</span><span class="n">DataType</span><span class="o">.</span><span class="n">BASELINED</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span> <span class="o">*</span> <span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">))</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
            <span class="n">Npanel</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># to eliminate max/min value due to bad pixel or bad fitting,</span>
            <span class="c1">#  1/10-th value from max and min are used instead</span>
<span class="c1">#             valid_index = numpy.where(self.num_valid_spectrum[:,:,pol] &gt; 0)</span>
            <span class="n">mask2d</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">take</span><span class="p">([</span><span class="n">pol</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">valid_index</span> <span class="o">=</span> <span class="n">mask2d</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">valid_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">chan0</span><span class="p">:</span><span class="n">chan1</span><span class="p">]</span>
            <span class="n">ListMax</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ListMin</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">valid_index</span><span class="p">,</span> <span class="n">valid_data</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">is_baselined</span><span class="p">:</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)</span><span class="o">//</span><span class="mi">10</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ymax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ymin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ymin=</span><span class="si">%s</span><span class="s1">, ymax=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
            <span class="k">del</span> <span class="n">ListMax</span><span class="p">,</span> <span class="n">ListMin</span>

            <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)):</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">ROWS</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span>

                <span class="n">_x</span> <span class="o">=</span> <span class="n">row</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span>
                <span class="n">_y</span> <span class="o">=</span> <span class="n">row</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span>

                <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span><span class="o">+</span><span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">_Result&#39;</span> <span class="o">%</span> <span class="n">pol</span>
                <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">Npanel</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plotfile</span><span class="p">):</span>
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">_x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="ow">and</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">_y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">axes_list</span><span class="p">[</span><span class="n">NSp</span><span class="p">]</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">set_axis_on</span><span class="p">()</span>
                        <span class="n">world_x</span> <span class="o">=</span> <span class="n">xrv</span> <span class="o">+</span> <span class="p">(</span><span class="n">_x</span> <span class="o">-</span> <span class="n">xrp</span><span class="p">)</span> <span class="o">*</span> <span class="n">xic</span>
                        <span class="n">world_y</span> <span class="o">=</span> <span class="n">yrv</span> <span class="o">+</span> <span class="p">(</span><span class="n">_y</span> <span class="o">-</span> <span class="n">yrp</span><span class="p">)</span> <span class="o">*</span> <span class="n">yic</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;(IF, POL, X, Y) = (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">HHMMSSss</span><span class="p">(</span><span class="n">world_x</span><span class="p">),</span> <span class="n">DDMMSSs</span><span class="p">(</span><span class="n">world_y</span><span class="p">))</span>
<span class="c1">#                         if self.num_valid_spectrum[_x][_y][pol] &gt; 0:</span>
                        <span class="k">if</span> <span class="n">mask2d</span><span class="p">[</span><span class="n">_x</span><span class="p">][</span><span class="n">_y</span><span class="p">]:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">_x</span><span class="p">][</span><span class="n">_y</span><span class="p">],</span> <span class="n">Mark</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markeredgecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span>
                                   <span class="n">markerfacecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;NO DATA&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                   <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">TickSize</span><span class="p">)</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">axes_list</span><span class="p">[</span><span class="n">NSp</span><span class="p">]</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
                        <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">NSp</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">NSp</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">NhPanel</span> <span class="o">*</span> <span class="n">NvPanel</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">irow</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROWS</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;RASTER&#39;</span><span class="p">):</span>
                    <span class="n">NSp</span> <span class="o">=</span> <span class="mi">0</span>

                    <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span><span class="o">+</span><span class="s1">&#39;.pol</span><span class="si">%s</span><span class="s1">_Result&#39;</span> <span class="o">%</span> <span class="n">pol</span>
                    <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">Npanel</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plotfile</span><span class="p">):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Regenerate plot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">plotfile</span><span class="p">)</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Use existing plot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">plotfile</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">_a</span> <span class="ow">in</span> <span class="n">axes_list</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">_a</span><span class="o">.</span><span class="n">lines</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">texts</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">patches</span><span class="p">[:],</span> <span class="n">_a</span><span class="o">.</span><span class="n">images</span><span class="p">[:]):</span>
                            <span class="n">obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                            <span class="k">del</span> <span class="n">obj</span>

                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span> <span class="c1">#polmap[pol]</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd_spectral_map&#39;</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
                    <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

                    <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                                       <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
                                       <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
                                       <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                                       <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
                    <span class="n">plot_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>

                    <span class="n">Npanel</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask2d</span>
        <span class="k">del</span> <span class="n">ROWS</span>
        <span class="k">del</span> <span class="n">axes_manager</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Returning </span><span class="si">{}</span><span class="s2"> plots from spectralmap&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">plot_list</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">plot_list</span></div>



<div class="viewcode-block" id="SDSpectralImageDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSpectralImageDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDSpectralImageDisplay</span><span class="p">(</span><span class="n">SDImageDisplay</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter for science spectral window.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">display_cls</span><span class="p">:</span> <span class="n">SDImageDisplay</span><span class="p">,</span>
               <span class="n">prologue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">SDImageDisplay</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">epilogue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">SDImageDisplay</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate Plot list using given display class.</span>

<span class="sd">        Args:</span>
<span class="sd">            display_cls: display class</span>
<span class="sd">            prologue: Function to execute before plot method is called.</span>
<span class="sd">                      The function must take SDImageDisplay instance as its argument.</span>
<span class="sd">                      Defaults to None.</span>
<span class="sd">            epilogue: Function to execute after plot method is called.</span>
<span class="sd">                      The function must take SDImageDisplay instance as its argument.</span>
<span class="sd">                      Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="n">display_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prologue</span><span class="p">:</span>
            <span class="n">prologue</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">epilogue</span><span class="p">:</span>
            <span class="n">epilogue</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plot_list</span>

    <span class="nd">@casa5style_plot</span>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Plot instances for science spectral windows.</span>

<span class="sd">        It creates the following plots from the single inputs.</span>
<span class="sd">        They are returned as a plain list.</span>

<span class="sd">          - sparse spectral map</span>
<span class="sd">          - channel map</span>
<span class="sd">          - detailed spectral map</span>
<span class="sd">          - baseline rms map</span>
<span class="sd">          - moment map (max intensity map)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">(</span><span class="n">SDSparseMapDisplay</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">enable_atm</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;sparse_map: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="p">))</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">(</span><span class="n">SDChannelMapDisplay</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;channel_map: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">t1</span><span class="p">))</span>
        <span class="c1"># skip spectral map (detailed profile map) if the data is NRO</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">isnro</span><span class="p">:</span>
            <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">(</span><span class="n">SDSpectralMapDisplay</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;spectral_map: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t3</span><span class="o">-</span><span class="n">t2</span><span class="p">))</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">(</span><span class="n">SDRmsMapDisplay</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;rms_map: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t4</span><span class="o">-</span><span class="n">t3</span><span class="p">))</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__plot</span><span class="p">(</span><span class="n">SDMomentMapDisplay</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;moment_map: elapsed time </span><span class="si">%s</span><span class="s1"> sec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t5</span><span class="o">-</span><span class="n">t4</span><span class="p">))</span>

        <span class="c1"># contamination plots</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_contamination_plot</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">plot_list</span>

<div class="viewcode-block" id="SDSpectralImageDisplay.add_contamination_plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDSpectralImageDisplay.add_contamination_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">add_contamination_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of Plot instances for contamination plot.</span>

<span class="sd">        Plot instance is created only when input has valid file</span>
<span class="sd">        name of contamination plot for &quot;combined&quot; image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">contamination_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span> <span class="o">==</span> <span class="s1">&#39;COMBINED&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">plotfile</span><span class="p">):</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;intent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;pol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;ant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;COMBINED&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd_contamination_map&#39;</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span>
            <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ALL&#39;</span>

            <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">plotfile</span><span class="p">,</span>
                               <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
                               <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
                               <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                               <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">plot</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span></div>
</div>



<div class="viewcode-block" id="SDImageDisplayFactory">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.imaging.html#pipeline.hsd.tasks.imaging.display.SDImageDisplayFactory">[docs]</a>
<span class="k">def</span> <span class="nf">SDImageDisplayFactory</span><span class="p">(</span><span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">SDChannelAveragedImageDisplay</span><span class="p">,</span> <span class="n">SDSpectralImageDisplay</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return appropriate display class for plotting.</span>

<span class="sd">    If mode is &quot;TP&quot;, SDChannelAveragedImageDisplay is returned.</span>
<span class="sd">    Otherwise, SDSpectralImageDisplay is returned.</span>

<span class="sd">    Args:</span>
<span class="sd">        mode: Type of the spectral window.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Appropriate display class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;MODE=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mode</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;TP&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SDChannelAveragedImageDisplay</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># mode should be &#39;SP&#39;</span>
        <span class="k">return</span> <span class="n">SDSpectralImageDisplay</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>