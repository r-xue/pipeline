

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hsd.tasks.imaging.imaging &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hsd.tasks.imaging.imaging</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hsd.tasks.imaging.imaging</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Imaging stage.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.callibrary</span> <span class="k">as</span> <span class="nn">callibrary</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.filenamer</span> <span class="k">as</span> <span class="nn">filenamer</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.imageheader</span> <span class="k">as</span> <span class="nn">imageheader</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.vdp</span> <span class="k">as</span> <span class="nn">vdp</span>
<span class="kn">from</span> <span class="nn">pipeline.domain</span> <span class="kn">import</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">MeasurementSet</span>
<span class="kn">from</span> <span class="nn">pipeline.h.heuristics</span> <span class="kn">import</span> <span class="n">fieldnames</span>
<span class="kn">from</span> <span class="nn">pipeline.h.tasks.common.sensitivity</span> <span class="kn">import</span> <span class="n">Sensitivity</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.heuristics</span> <span class="kn">import</span> <span class="n">rasterscan</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.heuristics.rasterscan</span> <span class="kn">import</span> <span class="n">RasterScanHeuristicsResult</span><span class="p">,</span> <span class="n">RasterScanHeuristicsFailure</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks</span> <span class="kn">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.baseline</span> <span class="kn">import</span> <span class="n">baseline</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common</span> <span class="kn">import</span> <span class="n">compress</span><span class="p">,</span> <span class="n">direction_utils</span><span class="p">,</span> <span class="n">observatory_policy</span><span class="p">,</span> <span class="n">rasterutil</span><span class="p">,</span> <span class="n">sdtyping</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.common</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">sdutils</span>
<span class="kn">from</span> <span class="nn">pipeline.hsd.tasks.imaging</span> <span class="kn">import</span> <span class="p">(</span><span class="n">detectcontamination</span><span class="p">,</span> <span class="n">gridding</span><span class="p">,</span>
                                        <span class="n">imaging_params</span><span class="p">,</span> <span class="n">resultobjects</span><span class="p">,</span>
                                        <span class="n">sdcombine</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">worker</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tasks</span><span class="p">,</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">task_registry</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">coordsys</span>
    <span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">Context</span>
    <span class="kn">from</span> <span class="nn">resultobjects</span> <span class="kn">import</span> <span class="n">SDImagingResults</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># SensitivityInfo:</span>
<span class="c1">#     sensitivity: Sensitivity of an image</span>
<span class="c1">#     frequency_range: frequency ranges from which the sensitivity is calculated</span>
<span class="c1">#     to_export: True if the sensitivity shall be exported to aqua report. (to avoid exporting NRO sensitivity in K)</span>
<span class="n">SensitivityInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;SensitivityInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;sensitivity frequency_range to_export&#39;</span><span class="p">)</span>
<span class="c1"># RasterInfo: center_ra, center_dec = R.A. and Declination of map center</span>
<span class="c1">#             width=map extent along scan, height=map extent perpendicular to scan</span>
<span class="c1">#             angle=scan direction w.r.t. horizontal coordinate, row_separation=separation between raster rows.</span>
<span class="n">RasterInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;RasterInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;center_ra center_dec width height &#39;</span>
                                                  <span class="s1">&#39;scan_angle row_separation row_duration&#39;</span><span class="p">)</span>
<span class="c1"># Reference MS in combined list</span>
<span class="n">REF_MS_ID</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="SDImagingInputs">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.SDImagingInputs.html#pipeline.hsd.tasks.SDImagingInputs">[docs]</a>
<span class="k">class</span> <span class="nc">SDImagingInputs</span><span class="p">(</span><span class="n">vdp</span><span class="o">.</span><span class="n">StandardInputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inputs for imaging task class.&quot;&quot;&quot;</span>

    <span class="c1"># Search order of input vis</span>
    <span class="n">processing_data_type</span> <span class="o">=</span> <span class="p">[</span><span class="n">DataType</span><span class="o">.</span><span class="n">BASELINED</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">ATMCORR</span><span class="p">,</span>
                            <span class="n">DataType</span><span class="o">.</span><span class="n">REGCAL_CONTLINE_ALL</span><span class="p">,</span> <span class="n">DataType</span><span class="o">.</span><span class="n">RAW</span><span class="p">]</span>

    <span class="n">infiles</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">null_input</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]])</span>
    <span class="n">spw</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">field</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">)</span>

    <span class="nd">@field</span><span class="o">.</span><span class="n">postprocess</span>
    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unprocessed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get fields as a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            unprocessed : Unprocessed fields</span>

<span class="sd">        Returns:</span>
<span class="sd">            fields as a string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># LOG.info(&#39;field.postprocess: unprocessed = &quot;{0}&quot;&#39;.format(unprocessed))</span>
        <span class="k">if</span> <span class="n">unprocessed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">unprocessed</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unprocessed</span>

        <span class="c1"># filters field with intents in self.intent</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">fieldnames</span><span class="o">.</span><span class="n">IntentFieldnames</span><span class="p">()</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">vislist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="c1"># This assumes the same fields in all MSes</span>
            <span class="n">msobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
            <span class="c1"># this will give something like &#39;0542+3243,0343+242&#39;</span>
            <span class="n">intent_fields</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">msobj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">safe_split</span><span class="p">(</span><span class="n">intent_fields</span><span class="p">))</span>

        <span class="c1"># LOG.info(&#39;field.postprocess: fields = &quot;{0}&quot;&#39;.format(fields))</span>

        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">intent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;TARGET&#39;</span>

    <span class="c1"># Synchronization between infiles and vis is still necessary</span>
    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">infiles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_ampcal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;AMPCAL&#39;</span>

    <span class="c1"># TODO: Replace the decorator with @functools.cached_property</span>
    <span class="c1">#       when we completely get rid of python 3.6 support</span>
    <span class="nd">@property</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">datatype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataType</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return datatype enum corresponding to dataset returned by vis/infiles attribute.&quot;&quot;&quot;</span>
        <span class="c1"># TODO: It would be ideal to integrate datatype stuff into vdp.</span>
        <span class="c1">#       Since this is urgent fix for PIPE-1480, it is better for now</span>
        <span class="c1">#       to confine the change into single file to avoid unexpected</span>
        <span class="c1">#       side effect.</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_datatype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processing_data_type</span><span class="p">,</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_datatype</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restfreq</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">infiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">org_direction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;sdtyping.Direction&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an object.</span>

<span class="sd">        Args:</span>
<span class="sd">            context : Pipeline context</span>
<span class="sd">            mode : Spectrum mode. Defaults to None, but in effect to &#39;line&#39;.</span>
<span class="sd">            restfreq : Rest frequency. Defaults to None, it executes without rest frequency.</span>
<span class="sd">            infiles : String joined infiles list. Defaults to None.</span>
<span class="sd">            field : Field ID. Defaults to None, all fields are used.</span>
<span class="sd">            spw : Spectral window. Defaults to None, all spws are used.</span>
<span class="sd">            org_direction : Directions of the origin for moving targets.</span>
<span class="sd">                            Defaults to None, it doesn&#39;t have some moving targets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SDImagingInputs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="n">restfreq</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restfreq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">infiles</span> <span class="o">=</span> <span class="n">infiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">org_direction</span> <span class="o">=</span> <span class="n">org_direction</span></div>



<div class="viewcode-block" id="SDImaging">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging">[docs]</a>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_equivalent_casa_task</span><span class="p">(</span><span class="s1">&#39;hsd_imaging&#39;</span><span class="p">)</span>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_casa_commands_comment</span><span class="p">(</span><span class="s1">&#39;Perform single dish imaging.&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">SDImaging</span><span class="p">(</span><span class="n">basetask</span><span class="o">.</span><span class="n">StandardTaskTemplate</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;SDImaging processing class.&quot;&quot;&quot;</span>

    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">SDImagingInputs</span>
    <span class="c1"># stokes to image and requred POLs for it</span>
    <span class="n">stokes</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
    <span class="c1"># for linear feed in ALMA. this affects pols passed to gridding module</span>
    <span class="n">required_pols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;XX&#39;</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">]</span>

    <span class="n">is_multi_vis_task</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="SDImaging.prepare">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging.prepare">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">resultobjects</span><span class="o">.</span><span class="n">SDImagingResults</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute imaging process. This is the main method of imaging.</span>

<span class="sd">        Returns:</span>
<span class="sd">            result object of imaging</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_cp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_common_parameters</span><span class="p">()</span>

        <span class="c1"># loop over reduction group (spw and source combination)</span>
        <span class="k">for</span> <span class="n">__group_id</span><span class="p">,</span> <span class="n">__group_desc</span> <span class="ow">in</span> <span class="n">_cp</span><span class="o">.</span><span class="n">reduction_group</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">_rgp</span> <span class="o">=</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">(</span><span class="n">__group_id</span><span class="p">,</span> <span class="n">__group_desc</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_reduction_group_parameters</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">image_group</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__set_image_group_item_into_reduction_group_patameters</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

                <span class="c1"># Step 1: initialize weight column</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_weight_column_based_on_baseline_rms</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

                <span class="c1"># Step 2: imaging</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_imaging</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_imager_result_outcome</span><span class="p">(</span><span class="n">_rgp</span><span class="p">):</span>
                    <span class="c1"># Imaging was successful, proceed following steps</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">__add_image_list_to_combine</span><span class="p">(</span><span class="n">_rgp</span><span class="p">)</span>

                    <span class="c1"># Additional Step.</span>
                    <span class="c1"># Make grid_table and put rms and valid spectral number array</span>
                    <span class="c1"># to the outcome.</span>
                    <span class="c1"># The rms and number of valid spectra is used to create RMS maps.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__make_grid_table</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__define_rms_range_in_image</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__set_asdm_to_outcome_vis_if_imagemode_is_ampcal</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

                    <span class="c1"># NRO doesn&#39;t need per-antenna Stokes I images</span>
                    <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_not_nro</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__append_result</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_nro_imager_result_outcome</span><span class="p">(</span><span class="n">_rgp</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__additional_imaging_process_for_nro</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__skip_this_loop</span><span class="p">(</span><span class="n">_rgp</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__prepare_for_combine_images</span><span class="p">(</span><span class="n">_rgp</span><span class="p">)</span>

            <span class="c1"># Step 3: imaging of all antennas</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__execute_combine_images</span><span class="p">(</span><span class="n">_rgp</span><span class="p">)</span>

            <span class="n">_pp</span> <span class="o">=</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_imager_result_outcome</span><span class="p">(</span><span class="n">_rgp</span><span class="p">):</span>

                <span class="c1"># Imaging was successful, proceed following steps</span>

                <span class="c1"># Additional Step.</span>
                <span class="c1"># Make grid_table and put rms and valid spectral number array</span>
                <span class="c1"># to the outcome</span>
                <span class="c1"># The rms and number of valid spectra is used to create RMS maps</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__make_post_grid_table</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">)</span>

                <span class="c1"># calculate RMS of line free frequencies in a combined image</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__generate_parameters_for_calculate_sensitivity</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">__set_representative_flag</span><span class="p">(</span><span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">__warn_if_early_cycle</span><span class="p">(</span><span class="n">_rgp</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">__calculate_sensitivity</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">_pp</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__detect_contamination</span><span class="p">(</span><span class="n">_rgp</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">__append_result</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

            <span class="c1"># NRO specific: generate combined image for each correlation</span>
            <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_nro</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_combine_images_for_nro</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">):</span>
                <span class="k">continue</span>

        <span class="k">return</span> <span class="n">_cp</span><span class="o">.</span><span class="n">results</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_finalize_worker_result</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                                <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span>
                                <span class="n">result</span><span class="p">:</span> <span class="s1">&#39;SDImagingResults&#39;</span><span class="p">,</span>
                                <span class="n">session</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">sourcename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">spwlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">antenna</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">specmode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">imagemode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">stokes</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">datatype</span><span class="p">:</span> <span class="n">DataType</span><span class="p">,</span>
                                <span class="n">datamin</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                <span class="n">datamax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                <span class="n">datarms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                <span class="n">validsp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
                                <span class="n">rms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
                                <span class="n">edge</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">reduction_group_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                <span class="n">file_index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">assoc_antennas</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">assoc_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">assoc_spws</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                                <span class="n">sensitivity_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SensitivityInfo</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">theoretical_rms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">effbw</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fanalize the worker result.</span>

<span class="sd">        Args:</span>
<span class="sd">            context            : Pipeline context</span>
<span class="sd">            result             : SDImagingResults instance</span>
<span class="sd">            session            : Session name</span>
<span class="sd">            sourcename         : Name of the source</span>
<span class="sd">            spwlist            : List of SpWs</span>
<span class="sd">            antenna            : Antenna name</span>
<span class="sd">            specmode           : Specmode for tsdimaging</span>
<span class="sd">            imagemode          : Image mode</span>
<span class="sd">            stokes             : Stokes parameter</span>
<span class="sd">            datatype           : Datatype enum</span>
<span class="sd">            datamin            : Minimum value of the image</span>
<span class="sd">            datamax            : Maximum value of the image</span>
<span class="sd">            datarms            : Rms of the image</span>
<span class="sd">            validsp            : # of combined spectra</span>
<span class="sd">            rms                : Rms values</span>
<span class="sd">            edge               : Edge channels</span>
<span class="sd">            reduction_group_id : Reduction group ID</span>
<span class="sd">            file_index         : MS file index</span>
<span class="sd">            assoc_antennas     : List of associated antennas</span>
<span class="sd">            assoc_fields       : List of associated fields</span>
<span class="sd">            assoc_spws         : List of associated SpWs</span>
<span class="sd">            sensitivity_info   : Sensitivity information</span>
<span class="sd">            theoretical_rms    : Theoretical RMS</span>
<span class="sd">            effbw              : Effective channel bandwidth in Hz</span>
<span class="sd">        Returns:</span>
<span class="sd">            (none)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># override attributes for image item</span>
        <span class="c1"># the following attribute is currently hard-coded</span>
        <span class="n">sourcetype</span> <span class="o">=</span> <span class="s1">&#39;TARGET&#39;</span>

        <span class="n">_locals</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span>
        <span class="n">image_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sourcename&#39;</span><span class="p">,</span> <span class="s1">&#39;spwlist&#39;</span><span class="p">,</span> <span class="s1">&#39;antenna&#39;</span><span class="p">,</span> <span class="s1">&#39;ant_name&#39;</span><span class="p">,</span> <span class="s1">&#39;specmode&#39;</span><span class="p">,</span> <span class="s1">&#39;sourcetype&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">image_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_locals</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">_locals</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># fill outcomes</span>
        <span class="n">outcome_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;imagemode&#39;</span><span class="p">,</span> <span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;validsp&#39;</span><span class="p">,</span> <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="s1">&#39;reduction_group_id&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;file_index&#39;</span><span class="p">,</span> <span class="s1">&#39;assoc_antennas&#39;</span><span class="p">,</span> <span class="s1">&#39;assoc_fields&#39;</span><span class="p">,</span> <span class="s1">&#39;assoc_spws&#39;</span><span class="p">,</span> <span class="s1">&#39;assoc_spws&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">outcome_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_locals</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">_locals</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>

        <span class="c1"># attach sensitivity_info if available</span>
        <span class="k">if</span> <span class="n">sensitivity_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">sensitivity_info</span> <span class="o">=</span> <span class="n">sensitivity_info</span>
        <span class="c1"># attach theoretical RMS if available</span>
        <span class="k">if</span> <span class="n">theoretical_rms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">theoretical_rms</span> <span class="o">=</span> <span class="n">theoretical_rms</span>

        <span class="c1"># set some information to image header</span>
        <span class="n">image_item</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>
        <span class="n">imagename</span> <span class="o">=</span> <span class="n">image_item</span><span class="o">.</span><span class="n">imagename</span>

        <span class="c1"># Virtual spws are not applicable for NRO data.</span>
        <span class="c1"># So if is_nro() returns True, the &#39;virtspw&#39; flag is set to False.</span>
        <span class="n">virtspw</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">is_nro</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;.weight&#39;</span><span class="p">):</span>
            <span class="n">imageheader</span><span class="o">.</span><span class="n">set_miscinfo</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                     <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">)),</span>
                                     <span class="n">virtspw</span><span class="o">=</span><span class="n">virtspw</span><span class="p">,</span>
                                     <span class="n">field</span><span class="o">=</span><span class="n">image_item</span><span class="o">.</span><span class="n">sourcename</span><span class="p">,</span>
                                     <span class="n">nfield</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                     <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;singledish&#39;</span><span class="p">,</span>
                                     <span class="nb">iter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># nominal</span>
                                     <span class="n">intent</span><span class="o">=</span><span class="n">sourcetype</span><span class="p">,</span>
                                     <span class="n">specmode</span><span class="o">=</span><span class="n">specmode</span><span class="p">,</span>
                                     <span class="n">is_per_eb</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

            <span class="c1"># update miscinfo</span>
            <span class="c1"># TODO: Eventually, the following code together with</span>
            <span class="c1">#       Tclean.update_miscinfo should be merged into</span>
            <span class="c1">#       imageheader.set_miscinfo.</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">miscinfo</span><span class="p">()</span>

                <span class="k">if</span> <span class="s1">&#39;.weight&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">datamin</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;datamin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datamin</span>

                    <span class="k">if</span> <span class="n">datamax</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;datamax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datamax</span>

                    <span class="k">if</span> <span class="n">datarms</span><span class="p">:</span>
                        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;datarms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datarms</span>

                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;stokes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stokes</span>

                <span class="k">if</span> <span class="n">effbw</span><span class="p">:</span>
                    <span class="n">info</span><span class="p">[</span><span class="s1">&#39;effbw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">effbw</span>

                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;member&#39;</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;obspatt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;sd&#39;</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;arrays&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;TP&#39;</span>
                <span class="n">info</span><span class="p">[</span><span class="s1">&#39;modifier&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                <span class="c1"># PIPE-2148, limiting &#39;sessionX&#39; keyword length to 68 characters</span>
                <span class="c1"># due to FITS header keyword string length limit.</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">imageheader</span><span class="o">.</span><span class="n">wrap_key</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;sessio&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>

                <span class="n">image</span><span class="o">.</span><span class="n">setmiscinfo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="c1"># finally replace task attribute with the top-level one</span>
        <span class="n">result</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="bp">cls</span>

    <span class="k">def</span> <span class="nf">__get_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search results and retrieve edge parameter from the most recent SDBaselineResults if it exists.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of edge</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__getresult</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">r</span>
        <span class="n">__registered_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">__getresult</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>
        <span class="n">__baseline_stage</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">__stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">__registered_results</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">__registered_results</span><span class="p">[</span><span class="n">__stage</span><span class="p">],</span> <span class="n">baseline</span><span class="o">.</span><span class="n">SDBaselineResults</span><span class="p">):</span>
                <span class="n">__baseline_stage</span> <span class="o">=</span> <span class="n">__stage</span>
        <span class="k">if</span> <span class="n">__baseline_stage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">__registered_results</span><span class="p">[</span><span class="n">__baseline_stage</span><span class="p">]</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">])</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retrieved edge information from SDBaselineResults: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No SDBaselineResults available. Set edge as [0,0]&#39;</span><span class="p">)</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">__initialize_common_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize common parameters of prepare().</span>

<span class="sd">        Returns:</span>
<span class="sd">            common parameters object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">initialize_common_parameters</span><span class="p">(</span>
            <span class="n">reduction_group</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">ms_reduction_group</span><span class="p">,</span>
            <span class="n">infiles</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span>
            <span class="n">restfreq_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">restfreq</span><span class="p">,</span>
            <span class="n">ms_list</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span>
            <span class="n">ms_names</span><span class="o">=</span><span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">msobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ms</span><span class="p">],</span>
            <span class="n">session_names</span><span class="o">=</span><span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">session</span> <span class="k">for</span> <span class="n">msobj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ms</span><span class="p">],</span>
            <span class="n">args_spw</span><span class="o">=</span><span class="n">sdutils</span><span class="o">.</span><span class="n">convert_spw_virtual2real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span><span class="p">),</span>
            <span class="n">in_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">field</span><span class="p">,</span>
            <span class="n">imagemode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="n">is_nro</span><span class="o">=</span><span class="n">sdutils</span><span class="o">.</span><span class="n">is_nro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
            <span class="n">results</span><span class="o">=</span><span class="n">resultobjects</span><span class="o">.</span><span class="n">SDImagingResults</span><span class="p">(),</span>
            <span class="n">edge</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__get_edge</span><span class="p">(),</span>
            <span class="n">dt_dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">((</span><span class="n">__ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">DataTable</span><span class="p">(</span><span class="n">sdutils</span><span class="o">.</span><span class="n">get_data_table_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">__ms</span><span class="p">)))</span>
                         <span class="k">for</span> <span class="n">__ms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_correlations_if_nro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                  <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If data is from NRO, then get correlations.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameters object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>

<span class="sd">        Returns:</span>
<span class="sd">            joined list of correlations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_nro</span><span class="p">:</span>
            <span class="n">__correlations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">pols_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">__correlations</span><span class="p">:</span>
                    <span class="n">__correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">__correlations</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__correlations</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__get_rgp_image_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                              <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get image group of reduction group.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameters object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>

<span class="sd">        Returns:</span>
<span class="sd">            image group dictionary, value is list of [ms, antenna, spwid,</span>
<span class="sd">            fieldid, pollist, channelmap]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__image_group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">__msobj</span><span class="p">,</span> <span class="n">__ant</span><span class="p">,</span> <span class="n">__spwid</span><span class="p">,</span> <span class="n">__fieldid</span><span class="p">,</span> <span class="n">__pollist</span><span class="p">,</span> <span class="n">__chanmap</span> <span class="ow">in</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">ms_list</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">antenna_list</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwid_list</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldid_list</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">pols_list</span><span class="p">,</span>
                    <span class="n">_rgp</span><span class="o">.</span><span class="n">channelmap_range_list</span><span class="p">):</span>
            <span class="n">__identifier</span> <span class="o">=</span> <span class="n">__msobj</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">__fieldid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">__antenna</span> <span class="o">=</span> <span class="n">__msobj</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">__ant</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
            <span class="n">__identifier</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">__antenna</span>
            <span class="c1"># create image per asdm and antenna for ampcal</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
                <span class="n">__asdm_name</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">asdm_name_from_ms</span><span class="p">(</span><span class="n">__msobj</span><span class="p">)</span>
                <span class="n">__identifier</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">__asdm_name</span>
            <span class="k">if</span> <span class="n">__identifier</span> <span class="ow">in</span> <span class="n">__image_group</span><span class="p">:</span>
                <span class="n">__image_group</span><span class="p">[</span><span class="n">__identifier</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">__msobj</span><span class="p">,</span> <span class="n">__ant</span><span class="p">,</span> <span class="n">__spwid</span><span class="p">,</span> <span class="n">__fieldid</span><span class="p">,</span> <span class="n">__pollist</span><span class="p">,</span> <span class="n">__chanmap</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">__image_group</span><span class="p">[</span><span class="n">__identifier</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">__msobj</span><span class="p">,</span> <span class="n">__ant</span><span class="p">,</span> <span class="n">__spwid</span><span class="p">,</span> <span class="n">__fieldid</span><span class="p">,</span> <span class="n">__pollist</span><span class="p">,</span> <span class="n">__chanmap</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">__image_group</span>

    <span class="k">def</span> <span class="nf">__initialize_reduction_group_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default values into the instance of imaging_params.ReductionGroupParameters.</span>

<span class="sd">        Note: _cp.ms_list is set in this function.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Processing Reduction Group </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Group Summary:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">__group</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">: Antenna </span><span class="si">{:d}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">) Spw </span><span class="si">{:d}</span><span class="s1"> Field </span><span class="si">{:d}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__group</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">__group</span><span class="o">.</span><span class="n">antenna_id</span><span class="p">,</span>
                                                                                <span class="n">__group</span><span class="o">.</span><span class="n">antenna_name</span><span class="p">,</span> <span class="n">__group</span><span class="o">.</span><span class="n">spw_id</span><span class="p">,</span>
                                                                                <span class="n">__group</span><span class="o">.</span><span class="n">field_id</span><span class="p">,</span> <span class="n">__group</span><span class="o">.</span><span class="n">field_name</span><span class="p">))</span>

        <span class="c1"># Which group in group_desc list should be processed</span>
        <span class="c1"># fix for CAS-9747</span>
        <span class="c1"># There may be the case that observation didn&#39;t complete so that some of</span>
        <span class="c1"># target fields are missing in MS. In this case, directly pass in_field</span>
        <span class="c1"># to get_valid_ms_members causes trouble. As a workaround, ad hoc pre-selection</span>
        <span class="c1"># of field name is applied here.</span>
        <span class="c1"># 2017/02/23 TN</span>
        <span class="n">__field_sel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">in_field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># fine, just go ahead</span>
            <span class="n">__field_sel</span> <span class="o">=</span> <span class="n">_cp</span><span class="o">.</span><span class="n">in_field</span>
        <span class="k">elif</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="o">.</span><span class="n">field_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_cp</span><span class="o">.</span><span class="n">in_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]:</span>
            <span class="c1"># pre-selection of the field name</span>
            <span class="n">__field_sel</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="o">.</span><span class="n">field_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skip reduction group </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># no field name is included in in_field, skip</span>

        <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">get_valid_ms_members</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">ms_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span><span class="p">,</span>
                                <span class="n">__field_sel</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">args_spw</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;group </span><span class="si">{}</span><span class="s1">: member_list=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">))</span>

        <span class="c1"># skip this group if valid member list is empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Skip reduction group </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># list of group_desc IDs to image</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">antenna_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">antenna_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">spwid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">spw_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">]</span>
        <span class="n">_cp</span><span class="o">.</span><span class="n">ms_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ms</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">field_id</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">]</span>
        <span class="n">__temp_dd_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_cp</span><span class="o">.</span><span class="n">ms_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwid_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">))]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">channelmap_range_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">channelmap_range</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">]</span>
        <span class="c1"># this becomes list of list [[poltypes for ms0], [poltypes for ms1], ...]</span>
        <span class="c1">#             polids_list = [[ddobj.get_polarization_id(corr) for corr in ddobj.corr_axis \</span>
        <span class="c1">#                             if corr in self.required_pols ] for ddobj in temp_dd_list]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">pols_list</span> <span class="o">=</span> <span class="p">[[</span><span class="n">__corr</span> <span class="k">for</span> <span class="n">__corr</span> <span class="ow">in</span> <span class="n">__ddobj</span><span class="o">.</span><span class="n">corr_axis</span> <span class="k">if</span>
                           <span class="n">__corr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">required_pols</span><span class="p">]</span> <span class="k">for</span> <span class="n">__ddobj</span> <span class="ow">in</span> <span class="n">__temp_dd_list</span><span class="p">]</span>

        <span class="c1"># NRO specific</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">correlations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_correlations_if_nro</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Members to be processed:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">member_list</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1">: Antenna </span><span class="si">{}</span><span class="s1"> Spw </span><span class="si">{}</span><span class="s1"> Field </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">ms_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">antenna_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                                <span class="n">_rgp</span><span class="o">.</span><span class="n">spwid_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldid_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="c1"># image is created per antenna (science) or per asdm and antenna (ampcal)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">image_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_rgp_image_group</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;image_group=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">image_group</span><span class="p">))</span>

        <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span> <span class="o">=</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CombinedImageParameters</span><span class="p">()</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span> <span class="o">=</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ToCombineImageParameters</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__pick_restfreq_from_restfreq_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                           <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pick restfreq from restfreq_list.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">__v_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">__v_spwid_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span>
                <span class="n">i</span> <span class="ow">in</span> <span class="n">_cp</span><span class="o">.</span><span class="n">args_spw</span><span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
            <span class="n">__v_idx</span> <span class="o">=</span> <span class="n">__v_spwid_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">__v_spwid</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">__v_idx</span><span class="p">:</span>
                <span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span><span class="p">[</span><span class="n">__v_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Picked restfreq = &#39;</span><span class="si">{}</span><span class="s2">&#39; from </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No restfreq for spw </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">. Applying default value.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__v_spwid</span><span class="p">,</span>
                                                                                           <span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span> <span class="o">=</span> <span class="n">_cp</span><span class="o">.</span><span class="n">restfreq_list</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing with restfreq = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__set_image_name_based_on_virtual_spwid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate image name based on virtual spw id and set it to RGP.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__v_spwids_unique</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">__v_spwids_unique</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_imagename</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">__v_spwids_unique</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span><span class="p">,</span>
                                            <span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output image name: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">))</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_nro</span><span class="p">:</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_imagename</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">__v_spwids_unique</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span><span class="p">,</span>
                                                    <span class="n">stokes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">correlations</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Output image name for NRO: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__set_image_group_item_into_reduction_group_patameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                               <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set values for imaging into RGP.</span>

<span class="sd">        This method does (1)get parameters from image group in RGP to do gridding(imaging) and set them into RGP,</span>
<span class="sd">        and (2)generate an image name and pick the rest frequency.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">polslist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">chanmap_range_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing image group: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\t</span><span class="si">{}</span><span class="s2">: Antenna </span><span class="si">{:d}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">) Spw </span><span class="si">{}</span><span class="s2"> Field </span><span class="si">{:d}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span>
                <span class="s2">&quot;&quot;</span><span class="o">.</span>
                <span class="nb">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                       <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="c1"># reference data is first MS</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># for ampcal</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">asdm_name_from_ms</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="p">)</span>

        <span class="c1"># source name</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">group_desc</span><span class="o">.</span><span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

        <span class="c1"># specmode</span>
        <span class="n">__ref_field</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">__is_eph_obj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">__ref_field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">is_eph_obj</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span> <span class="o">=</span> <span class="s1">&#39;cubesource&#39;</span> <span class="k">if</span> <span class="n">__is_eph_obj</span> <span class="k">else</span> <span class="s1">&#39;cube&#39;</span>

        <span class="c1"># filenames for gridding</span>
        <span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">__ms</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">__ms</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;infiles=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">))</span>

        <span class="c1"># virtual spw ids</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
                         <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">)]</span>

        <span class="c1"># image name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__set_image_name_based_on_virtual_spwid</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

        <span class="c1"># restfreq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pick_restfreq_from_restfreq_list</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__initialize_weight_column_based_on_baseline_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                         <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize weight column of MS.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__origin_ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span> <span class="k">for</span> <span class="n">msobj</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">]</span>
        <span class="n">__work_ms</span> <span class="o">=</span> <span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">msobj</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">]</span>
        <span class="n">__weighting_inputs</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">InputsContainer</span><span class="p">(</span><span class="n">weighting</span><span class="o">.</span><span class="n">WeightMS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                                 <span class="n">infiles</span><span class="o">=</span><span class="n">__origin_ms</span><span class="p">,</span> <span class="n">outfiles</span><span class="o">=</span><span class="n">__work_ms</span><span class="p">,</span>
                                                 <span class="n">antenna</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">spwid</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">)</span>
        <span class="n">__weighting_task</span> <span class="o">=</span> <span class="n">weighting</span><span class="o">.</span><span class="n">WeightMS</span><span class="p">(</span><span class="n">__weighting_inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__weighting_task</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatable_dict</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">dt_dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__initialize_coord_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                               <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize coordinate set of MS.</span>

<span class="sd">        if initialize is fault, current loop of reduction group goes to next loop immediately.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        Returns:</span>
<span class="sd">            A flag initialize succeeded or not</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PIPE-313: evaluate map extent using pointing data from all the antenna in the data</span>
        <span class="n">__dummyids</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">]</span>
        <span class="n">__image_coord</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">ImageCoordinateUtil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span>
                                                   <span class="n">__dummyids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">__image_coord</span><span class="p">:</span>  <span class="c1"># No valid data is found</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">coord_set</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">cellx</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">celly</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">org_direction</span> <span class="o">=</span> <span class="n">__image_coord</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__execute_imaging_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                 <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute imaging worker.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># register data for combining</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">stokes_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">]</span>
        <span class="n">__imagename_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_nro</span><span class="p">:</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">stokes_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">correlations</span><span class="p">)</span>
            <span class="n">__imagename_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span><span class="p">)</span>

        <span class="n">__imager_results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">__stokes</span><span class="p">,</span> <span class="n">__imagename</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">stokes_list</span><span class="p">,</span> <span class="n">__imagename_list</span><span class="p">):</span>
            <span class="n">__imager_inputs</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">SDImagingWorker</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span>
                                                            <span class="n">outfile</span><span class="o">=</span><span class="n">__imagename</span><span class="p">,</span>
                                                            <span class="n">mode</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">imagemode</span><span class="p">,</span>
                                                            <span class="n">antids</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span>
                                                            <span class="n">spwids</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">,</span>
                                                            <span class="n">fieldids</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                                                            <span class="n">restfreq</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">restfreq</span><span class="p">,</span>
                                                            <span class="n">stokes</span><span class="o">=</span><span class="n">__stokes</span><span class="p">,</span>
                                                            <span class="n">edge</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span>
                                                            <span class="n">phasecenter</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">,</span>
                                                            <span class="n">cellx</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">cellx</span><span class="p">,</span>
                                                            <span class="n">celly</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">celly</span><span class="p">,</span>
                                                            <span class="n">nx</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span>
                                                            <span class="n">org_direction</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">org_direction</span><span class="p">)</span>
            <span class="n">__imager_task</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">SDImagingWorker</span><span class="p">(</span><span class="n">__imager_inputs</span><span class="p">)</span>
            <span class="n">__imager_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__imager_task</span><span class="p">)</span>
            <span class="n">__imager_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__imager_result</span><span class="p">)</span>

        <span class="c1"># per-antenna image (usually Stokes I)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span> <span class="o">=</span> <span class="n">__imager_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># per-antenna correlation image (XXYY/RRLL)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result_nro</span> <span class="o">=</span> <span class="n">__imager_results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">is_nro</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__make_grid_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make grid table for gridding.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Additional Step. Make grid_table&#39;</span><span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">imagename</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">__cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
            <span class="n">__dircoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">__cs</span><span class="o">.</span><span class="n">naxes</span><span class="p">())</span> <span class="k">if</span> <span class="n">__cs</span><span class="o">.</span><span class="n">axiscoordinatetypes</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span>
            <span class="n">__cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">__dircoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">__dircoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">__observing_pattern</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observing_pattern</span><span class="p">[</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">__grid_task_class</span> <span class="o">=</span> <span class="n">gridding</span><span class="o">.</span><span class="n">gridding_factory</span><span class="p">(</span><span class="n">__observing_pattern</span><span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">validsps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">rmss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">__grid_input_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">__msobj</span><span class="p">,</span> <span class="n">__antid</span><span class="p">,</span> <span class="n">__spwid</span><span class="p">,</span> <span class="n">__fieldid</span><span class="p">,</span> <span class="n">__poltypes</span><span class="p">,</span> <span class="n">_dummy</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">members</span><span class="p">:</span>
            <span class="n">__msname</span> <span class="o">=</span> <span class="n">__msobj</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># Use parent ms</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">__poltypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">__grid_input_dict</span><span class="p">:</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">__msname</span><span class="p">],</span> <span class="p">[</span><span class="n">__antid</span><span class="p">],</span> <span class="p">[</span><span class="n">__fieldid</span><span class="p">],</span> <span class="p">[</span><span class="n">__spwid</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__msname</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__antid</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__fieldid</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>

        <span class="c1"># Generate grid table for each POL in image (per ANT,</span>
        <span class="c1"># FIELD, and SPW, over all MSes)</span>
        <span class="k">for</span> <span class="n">__pol</span><span class="p">,</span> <span class="n">__member</span> <span class="ow">in</span> <span class="n">__grid_input_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">__mses</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">__antids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">__fieldids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">__spwids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">__pols</span> <span class="o">=</span> <span class="p">[</span><span class="n">__pol</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">__mses</span><span class="p">))]</span>
            <span class="n">__gridding_inputs</span> <span class="o">=</span> <span class="n">__grid_task_class</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">infiles</span><span class="o">=</span><span class="n">__mses</span><span class="p">,</span>
                                                         <span class="n">antennaids</span><span class="o">=</span><span class="n">__antids</span><span class="p">,</span>
                                                         <span class="n">fieldids</span><span class="o">=</span><span class="n">__fieldids</span><span class="p">,</span>
                                                         <span class="n">spwids</span><span class="o">=</span><span class="n">__spwids</span><span class="p">,</span>
                                                         <span class="n">poltypes</span><span class="o">=</span><span class="n">__pols</span><span class="p">,</span>
                                                         <span class="n">nx</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">__gridding_task</span> <span class="o">=</span> <span class="n">__grid_task_class</span><span class="p">(</span><span class="n">__gridding_inputs</span><span class="p">)</span>
            <span class="n">__gridding_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__gridding_task</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                       <span class="n">datatable_dict</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">dt_dict</span><span class="p">)</span>
            <span class="c1"># Extract RMS and number of spectra from grid_tables</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">compress</span><span class="o">.</span><span class="n">CompressedObj</span><span class="p">):</span>
                <span class="n">__grid_table</span> <span class="o">=</span> <span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">decompress</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">__grid_table</span> <span class="o">=</span> <span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">validsps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">__grid_table</span><span class="p">])</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">rmss</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">__grid_table</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__add_image_list_to_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add image list to combine.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">+</span> <span class="s1">&#39;.weight&#39;</span><span class="p">):</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">org_directions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">org_direction</span><span class="p">)</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">specmodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__define_rms_range_in_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                    <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define RMS range and finalize worker result.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculate spectral line and deviation mask frequency ranges in image.&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">__cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
            <span class="n">__frequency_frame</span> <span class="o">=</span> <span class="n">__cs</span><span class="o">.</span><span class="n">getconversiontype</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)</span>
            <span class="n">__cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="n">__rms_exclude_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_rms_exclude_freq_range_image</span><span class="p">(</span><span class="n">__frequency_frame</span><span class="p">,</span> <span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;The spectral line and deviation mask frequency ranges = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">__rms_exclude_freq</span><span class="p">)))</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">rms_exclude</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">__rms_exclude_freq</span><span class="p">)</span>
        <span class="n">__file_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">get_ms_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">]</span>
        <span class="n">__spwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">])</span>
        <span class="n">__spwobj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>
        <span class="n">__effective_bw</span> <span class="o">=</span> <span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__spwobj</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_effbws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">effbw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">__cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">__effective_bw</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_worker_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">session_names</span><span class="p">),</span> <span class="n">sourcename</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                     <span class="n">spwlist</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span><span class="p">,</span> <span class="n">antenna</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                     <span class="n">imagemode</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">imagemode</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">,</span>
                                     <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">datamin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datarms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">validsp</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">validsps</span><span class="p">,</span>
                                     <span class="n">rms</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">rmss</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span> <span class="n">reduction_group_id</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span>
                                     <span class="n">file_index</span><span class="o">=</span><span class="n">__file_index</span><span class="p">,</span> <span class="n">assoc_antennas</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">assoc_fields</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                                     <span class="n">assoc_spws</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span><span class="p">,</span> <span class="n">effbw</span><span class="o">=</span><span class="n">effbw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__additional_imaging_process_for_nro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                             <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add image list to combine and finalize worker result.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># Imaging was successful, proceed following steps</span>
        <span class="c1"># add image list to combine</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span> <span class="o">+</span> <span class="s1">&#39;.weight&#39;</span><span class="p">):</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images_nro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename_nro</span><span class="p">)</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">org_directions_nro</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">org_direction</span><span class="p">)</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">specmodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>
        <span class="n">__file_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">get_ms_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">]</span>
        <span class="n">__spwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">])</span>
        <span class="n">__spwobj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>
        <span class="n">__effective_bw</span> <span class="o">=</span> <span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__spwobj</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_effbws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">effbw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">__cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">__effective_bw</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_worker_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result_nro</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">session_names</span><span class="p">),</span> <span class="n">sourcename</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                     <span class="n">spwlist</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span><span class="p">,</span> <span class="n">antenna</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                     <span class="n">imagemode</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">imagemode</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">stokes_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">datamin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datarms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                     <span class="n">validsp</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">validsps</span><span class="p">,</span>
                                     <span class="n">rms</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">rmss</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span> <span class="n">reduction_group_id</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span>
                                     <span class="n">file_index</span><span class="o">=</span><span class="n">__file_index</span><span class="p">,</span> <span class="n">assoc_antennas</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">assoc_fields</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                                     <span class="n">assoc_spws</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">v_spwids</span><span class="p">,</span> <span class="n">effbw</span><span class="o">=</span><span class="n">effbw</span><span class="p">)</span>
        <span class="n">_cp</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result_nro</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__make_post_grid_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                               <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                               <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make grid table on post process.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Additional Step. Make grid_table&#39;</span><span class="p">)</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">imagename</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">org_direction</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">org_direction</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">__cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
            <span class="n">__dircoords</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">__cs</span><span class="o">.</span><span class="n">naxes</span><span class="p">())</span> <span class="k">if</span> <span class="n">__cs</span><span class="o">.</span><span class="n">axiscoordinatetypes</span><span class="p">()[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Direction&#39;</span><span class="p">]</span>
            <span class="n">__cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">__dircoords</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">__dircoords</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">__antid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]</span>
        <span class="n">__spwid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]</span>
        <span class="n">__fieldid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]</span>
        <span class="n">__observing_pattern</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">observing_pattern</span><span class="p">[</span><span class="n">__antid</span><span class="p">][</span><span class="n">__spwid</span><span class="p">][</span><span class="n">__fieldid</span><span class="p">]</span>
        <span class="n">__grid_task_class</span> <span class="o">=</span> <span class="n">gridding</span><span class="o">.</span><span class="n">gridding_factory</span><span class="p">(</span><span class="n">__observing_pattern</span><span class="p">)</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">validsps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">rmss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">__grid_input_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">__msname</span><span class="p">,</span> <span class="n">__antid</span><span class="p">,</span> <span class="n">__spwid</span><span class="p">,</span> <span class="n">__fieldid</span><span class="p">,</span> <span class="n">__poltypes</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span>
                                                                     <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span>
                                                                     <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">,</span>
                                                                     <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                                                                     <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">pols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">__poltypes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">__grid_input_dict</span><span class="p">:</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">__msname</span><span class="p">],</span> <span class="p">[</span><span class="n">__antid</span><span class="p">],</span> <span class="p">[</span><span class="n">__fieldid</span><span class="p">],</span> <span class="p">[</span><span class="n">__spwid</span><span class="p">]]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__msname</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__antid</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__fieldid</span><span class="p">)</span>
                    <span class="n">__grid_input_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">__pol</span><span class="p">,</span> <span class="n">__member</span> <span class="ow">in</span> <span class="n">__grid_input_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">__mses</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">__antids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">__fieldids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">__spwids</span> <span class="o">=</span> <span class="n">__member</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">__pols</span> <span class="o">=</span> <span class="p">[</span><span class="n">__pol</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">__mses</span><span class="p">))]</span>
            <span class="n">__gridding_inputs</span> <span class="o">=</span> <span class="n">__grid_task_class</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">infiles</span><span class="o">=</span><span class="n">__mses</span><span class="p">,</span> <span class="n">antennaids</span><span class="o">=</span><span class="n">__antids</span><span class="p">,</span>
                                                         <span class="n">fieldids</span><span class="o">=</span><span class="n">__fieldids</span><span class="p">,</span> <span class="n">spwids</span><span class="o">=</span><span class="n">__spwids</span><span class="p">,</span> <span class="n">poltypes</span><span class="o">=</span><span class="n">__pols</span><span class="p">,</span>
                                                         <span class="n">nx</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">ny</span><span class="p">)</span>
            <span class="n">__gridding_task</span> <span class="o">=</span> <span class="n">__grid_task_class</span><span class="p">(</span><span class="n">__gridding_inputs</span><span class="p">)</span>
            <span class="n">__gridding_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__gridding_task</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">datatable_dict</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">dt_dict</span><span class="p">)</span>
            <span class="c1"># Extract RMS and number of spectra from grid_tables</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">,</span> <span class="n">compress</span><span class="o">.</span><span class="n">CompressedObj</span><span class="p">):</span>
                <span class="n">__grid_table</span> <span class="o">=</span> <span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span><span class="o">.</span><span class="n">decompress</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">__grid_table</span> <span class="o">=</span> <span class="n">__gridding_result</span><span class="o">.</span><span class="n">outcome</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">validsps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">__grid_table</span><span class="p">])</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">rmss</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">__grid_table</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__generate_parameters_for_calculate_sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                        <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                                        <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate parameters to calculate sensitivity.</span>

<span class="sd">        Note: If it fails to calculate image statistics for some reason, it sets the RMS value to -1.0.</span>
<span class="sd">              -1.0 is the special value in image statistics calculation of all tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculate sensitivity of combined image&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">faxis</span> <span class="o">=</span> <span class="n">_pp</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">findaxisbyname</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">chan_width</span> <span class="o">=</span> <span class="n">_pp</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">_pp</span><span class="o">.</span><span class="n">faxis</span><span class="p">]</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">()</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">beam</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">qcell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">increment</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;direction&#39;</span><span class="p">)[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="c1"># cs.increment(format=&#39;s&#39;, type=&#39;direction&#39;)[&#39;string&#39;]</span>

        <span class="c1"># Define image channels to calculate statistics</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">include_channel_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stat_chans</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">rms_exclude</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">)</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">stat_chans</span> <span class="o">=</span> <span class="n">convert_range_list_to_string</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">include_channel_range</span><span class="p">)</span>
        <span class="c1"># Define region to calculate statistics</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_raster_info_list</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_stat_region</span><span class="p">(</span><span class="n">_pp</span><span class="p">)</span>

        <span class="c1"># Image statistics</span>
        <span class="k">if</span> <span class="n">_pp</span><span class="o">.</span><span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not get valid region of interest to calculate image statistics.&#39;</span><span class="p">)</span>
            <span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">__statval</span> <span class="o">=</span> <span class="n">calc_image_statistics</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">stat_chans</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">region</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">__statval</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">]):</span>
                <span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span> <span class="o">=</span> <span class="n">__statval</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Statistics of line free channels (</span><span class="si">{}</span><span class="s2">): RMS = </span><span class="si">{:f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, Stddev = </span><span class="si">{:f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">, &quot;</span>
                         <span class="s2">&quot;Mean = </span><span class="si">{:f}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">stat_chans</span><span class="p">,</span> <span class="n">__statval</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span>
                                                 <span class="n">__statval</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">,</span>
                                                 <span class="n">__statval</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not get image statistics. Potentially no valid pixel in region of interest.&#39;</span><span class="p">)</span>
                <span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

            <span class="k">for</span> <span class="n">__stat_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;min&#39;</span><span class="p">]:</span>
                <span class="n">__val</span> <span class="o">=</span> <span class="n">__statval</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">__stat_name</span><span class="p">,</span> <span class="p">[])</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">_pp</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;image_</span><span class="si">{</span><span class="n">__stat_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">__val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">__val</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># Theoretical RMS</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calculating theoretical RMS of image, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">))</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">theoretical_rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_theoretical_image_rms</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_pp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__execute_combine_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine images.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combine images of Source </span><span class="si">{}</span><span class="s1"> Spw </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]))</span>
        <span class="n">__combine_inputs</span> <span class="o">=</span> <span class="n">sdcombine</span><span class="o">.</span><span class="n">SDImageCombineInputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inimages</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images</span><span class="p">,</span>
                                                          <span class="n">outfile</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span>
                                                          <span class="n">org_directions</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">org_directions</span><span class="p">,</span>
                                                          <span class="n">specmodes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">specmodes</span><span class="p">)</span>
        <span class="n">__combine_task</span> <span class="o">=</span> <span class="n">sdcombine</span><span class="o">.</span><span class="n">SDImageCombine</span><span class="p">(</span><span class="n">__combine_inputs</span><span class="p">)</span>
        <span class="n">__freq_chan_reversed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">,</span> <span class="n">resultobjects</span><span class="o">.</span><span class="n">SDImagingResultItem</span><span class="p">):</span>
            <span class="n">__freq_chan_reversed</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">frequency_channel_reversed</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__combine_task</span><span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">frequency_channel_reversed</span> <span class="o">=</span> <span class="n">__freq_chan_reversed</span>

    <span class="k">def</span> <span class="nf">__set_representative_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                  <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                  <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set is_representative_source_and_spw flag.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__rep_source_name</span><span class="p">,</span> <span class="n">__rep_spw_id</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_representative_source_spw</span><span class="p">()</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">is_representative_source_and_spw</span> <span class="o">=</span> \
            <span class="n">__rep_spw_id</span> <span class="o">==</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]</span> <span class="ow">and</span> \
            <span class="n">__rep_source_name</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__warn_if_early_cycle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Warn when it processes MeasurementSet of ALMA Cycle 2 and earlier.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp (imaging_params.ReductionGroupParameters): Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="k">if</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">and</span> \
           <span class="n">__cqa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ymd&#39;</span><span class="p">,</span> <span class="s1">&#39;no_time&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="s1">&#39;2015/10/01&#39;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ALMA Cycle 2 and earlier project does not have a valid effective bandwidth. &quot;</span>
                        <span class="s2">&quot;Therefore, a nominal value of channel separation loaded from the MS &quot;</span>
                        <span class="s2">&quot;is used as an effective bandwidth for RMS estimation.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__calculate_sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate channel and frequency ranges of line free channels.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__ref_pixel</span> <span class="o">=</span> <span class="n">_pp</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">referencepixel</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">]</span>
        <span class="n">__freqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">__cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="k">for</span> <span class="n">__ichan</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">include_channel_range</span><span class="p">:</span>
            <span class="n">__ref_pixel</span><span class="p">[</span><span class="n">_pp</span><span class="o">.</span><span class="n">faxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">__ichan</span>
            <span class="n">__freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">cs</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="n">__ref_pixel</span><span class="p">)[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">_pp</span><span class="o">.</span><span class="n">faxis</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">__freqs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">__freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">__freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># LSB</span>
            <span class="n">__freqs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">stat_freqs</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:f}</span><span class="s1">~</span><span class="si">{:f}</span><span class="s1">GHz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__freqs</span><span class="p">[</span><span class="n">__iseg</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-9</span><span class="p">,</span> <span class="n">__freqs</span><span class="p">[</span><span class="n">__iseg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.e-9</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">__iseg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">__freqs</span><span class="p">),</span> <span class="mi">2</span><span class="p">)])</span>
        <span class="n">__file_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">get_ms_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">]</span>
        <span class="n">__bw</span> <span class="o">=</span> <span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">chan_width</span><span class="p">,</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">__spwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">])</span>
        <span class="n">__spwobj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>
        <span class="n">__effective_bw</span> <span class="o">=</span> <span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__spwobj</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_effbws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
        <span class="n">__sensitivity</span> <span class="o">=</span> <span class="n">Sensitivity</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                    <span class="n">spw</span><span class="o">=</span><span class="n">__spwid</span><span class="p">,</span> <span class="n">is_representative</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">is_representative_source_and_spw</span><span class="p">,</span>
                                    <span class="n">bandwidth</span><span class="o">=</span><span class="n">__bw</span><span class="p">,</span> <span class="n">bwmode</span><span class="o">=</span><span class="s1">&#39;cube&#39;</span><span class="p">,</span> <span class="n">beam</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">qcell</span><span class="p">,</span>
                                    <span class="n">sensitivity</span><span class="o">=</span><span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">),</span>
                                    <span class="n">effective_bw</span><span class="o">=</span><span class="n">__effective_bw</span><span class="p">,</span> <span class="n">imagename</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span>
                                    <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">__theoretical_noise</span> <span class="o">=</span> <span class="n">Sensitivity</span><span class="p">(</span><span class="n">array</span><span class="o">=</span><span class="s1">&#39;TP&#39;</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                          <span class="n">spw</span><span class="o">=</span><span class="n">__spwid</span><span class="p">,</span> <span class="n">is_representative</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">is_representative_source_and_spw</span><span class="p">,</span>
                                          <span class="n">bandwidth</span><span class="o">=</span><span class="n">__bw</span><span class="p">,</span> <span class="n">bwmode</span><span class="o">=</span><span class="s1">&#39;cube&#39;</span><span class="p">,</span> <span class="n">beam</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">qcell</span><span class="p">,</span>
                                          <span class="n">sensitivity</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">theoretical_rms</span><span class="p">)</span>
        <span class="n">__sensitivity_info</span> <span class="o">=</span> <span class="n">SensitivityInfo</span><span class="p">(</span><span class="n">__sensitivity</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">stat_freqs</span><span class="p">,</span> <span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">is_not_nro</span><span class="p">()))</span>
        <span class="n">effbw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">__cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">__effective_bw</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_worker_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">session_names</span><span class="p">),</span> <span class="n">sourcename</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                     <span class="n">spwlist</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">,</span> <span class="n">antenna</span><span class="o">=</span><span class="s1">&#39;COMBINED&#39;</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                     <span class="n">imagemode</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">imagemode</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stokes</span><span class="p">,</span>
                                     <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">datamin</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_min</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_max</span><span class="p">,</span>
                                     <span class="n">datarms</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span><span class="p">,</span> <span class="n">validsp</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">validsps</span><span class="p">,</span> <span class="n">rms</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">rmss</span><span class="p">,</span>
                                     <span class="n">edge</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span> <span class="n">reduction_group_id</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="n">file_index</span><span class="o">=</span><span class="n">__file_index</span><span class="p">,</span>
                                     <span class="n">assoc_antennas</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">assoc_fields</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                                     <span class="n">assoc_spws</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">,</span> <span class="n">sensitivity_info</span><span class="o">=</span><span class="n">__sensitivity_info</span><span class="p">,</span>
                                     <span class="n">theoretical_rms</span><span class="o">=</span><span class="n">__theoretical_noise</span><span class="p">,</span> <span class="n">effbw</span><span class="o">=</span><span class="n">effbw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__execute_combine_images_for_nro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                         <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                         <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Combine images for NRO data.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">        Returns:</span>
<span class="sd">            False if a valid image to combine does not exist for a specified source or spw.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images_nro</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid image to combine for Source </span><span class="si">{}</span><span class="s2">, Spw </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># image name</span>
        <span class="c1"># image name should be based on virtual spw id</span>
        <span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_imagename</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws_unique</span><span class="p">,</span>
                                           <span class="n">stokes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">correlations</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>

        <span class="c1"># Imaging of all antennas</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Combine images of Source </span><span class="si">{}</span><span class="s1"> Spw </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">]))</span>
        <span class="n">__combine_inputs</span> <span class="o">=</span> <span class="n">sdcombine</span><span class="o">.</span><span class="n">SDImageCombineInputs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inimages</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images_nro</span><span class="p">,</span>
                                                          <span class="n">outfile</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">imagename</span><span class="p">,</span>
                                                          <span class="n">org_directions</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">org_directions_nro</span><span class="p">,</span>
                                                          <span class="n">specmodes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">specmodes</span><span class="p">)</span>
        <span class="n">__combine_task</span> <span class="o">=</span> <span class="n">sdcombine</span><span class="o">.</span><span class="n">SDImageCombine</span><span class="p">(</span><span class="n">__combine_inputs</span><span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">__combine_task</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Imaging was successful, proceed following steps</span>
            <span class="n">__file_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">get_ms_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">]</span>
            <span class="n">__spwid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">])</span>
            <span class="n">__spwobj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">__spwid</span><span class="p">)</span>
            <span class="n">__effective_bw</span> <span class="o">=</span> <span class="n">__cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__spwobj</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_effbws</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
            <span class="n">effbw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">__cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">__effective_bw</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_worker_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">session_names</span><span class="p">),</span> <span class="n">sourcename</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span>
                                         <span class="n">spwlist</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">,</span> <span class="n">antenna</span><span class="o">=</span><span class="s1">&#39;COMBINED&#39;</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                         <span class="n">imagemode</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">imagemode</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">stokes_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="n">datatype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span> <span class="n">datamin</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_min</span><span class="p">,</span> <span class="n">datamax</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_max</span><span class="p">,</span>
                                         <span class="n">datarms</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">image_rms</span><span class="p">,</span> <span class="n">validsp</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">validsps</span><span class="p">,</span>
                                         <span class="n">rms</span><span class="o">=</span><span class="n">_pp</span><span class="o">.</span><span class="n">rmss</span><span class="p">,</span> <span class="n">edge</span><span class="o">=</span><span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">,</span> <span class="n">reduction_group_id</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span>
                                         <span class="n">file_index</span><span class="o">=</span><span class="n">__file_index</span><span class="p">,</span> <span class="n">assoc_antennas</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span>
                                         <span class="n">assoc_fields</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span> <span class="n">assoc_spws</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">,</span> <span class="n">effbw</span><span class="o">=</span><span class="n">effbw</span><span class="p">)</span>
            <span class="n">_cp</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__prepare_for_combine_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare before combining images.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># reference MS</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">ref_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">[</span><span class="n">REF_MS_ID</span><span class="p">])</span>
        <span class="c1"># image name</span>
        <span class="c1"># image name should be based on virtual spw id</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws_unique</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws_unique</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_imagename</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">v_spws_unique</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">_rgp</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__skip_this_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether combine should be skipped.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>

<span class="sd">        Returns:</span>
<span class="sd">            A boolean flag of determination whether the loop should be skipped or not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping combined image for the amplitude calibrator.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="c1"># Make combined image</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">tocombine</span><span class="o">.</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No valid image to combine for Source </span><span class="si">{}</span><span class="s2">, Spw </span><span class="si">{:d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__execute_imaging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                          <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute imaging per antenna, source.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        Returns:</span>
<span class="sd">            False if coordinate setting fails before imaging is executed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Imaging Source </span><span class="si">{}</span><span class="s1">, Ant </span><span class="si">{}</span><span class="s1"> Spw </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">ant_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="c1"># map coordinate (use identical map coordinate per spw)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">coord_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__initialize_coord_set</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute_imaging_worker</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__set_asdm_to_outcome_vis_if_imagemode_is_ampcal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                         <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set ASDM to vis.outcome if imagemode of the vis is AMPCAL.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_cp</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>
                <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">asdm</span>

    <span class="k">def</span> <span class="nf">__has_imager_result_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check whether imager_result.outcome has some value or not.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if imager_result.outcome has some value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__has_nro_imager_result_outcome</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check whether imager_result_nro.outcome has some value or not.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        Returns:</span>
<span class="sd">            True if imager_result_nro.outcome has some value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result_nro</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result_nro</span><span class="o">.</span><span class="n">outcome</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__detect_contamination</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Detect contamination of image.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># PIPE-251: detect contamination</span>
        <span class="n">do_plot</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span>
        <span class="n">contaminated</span> <span class="o">=</span> <span class="n">detectcontamination</span><span class="o">.</span><span class="n">detect_contamination</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">],</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">frequency_channel_reversed</span><span class="p">,</span>
            <span class="n">do_plot</span>
        <span class="p">)</span>
        <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;contaminated&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contaminated</span>

    <span class="k">def</span> <span class="nf">__append_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append result to RGP.</span>

<span class="sd">        Args:</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_cp</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="p">)</span>

<div class="viewcode-block" id="SDImaging.analyse">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging.analyse">[docs]</a>
    <span class="k">def</span> <span class="nf">analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="s1">&#39;SDImagingResults&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;SDImagingResults&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override method of basetask.</span>

<span class="sd">        Args:</span>
<span class="sd">            result : Result object</span>

<span class="sd">        Returns:</span>
<span class="sd">            Result object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_get_rms_exclude_freq_range_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_frame</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                          <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a combined list of frequency ranges.</span>

<span class="sd">        This method combines deviation mask, channel map ranges, and edges.</span>

<span class="sd">        Args</span>
<span class="sd">            to_frame : The frequency frame of output</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>

<span class="sd">        Returns:</span>
<span class="sd">            a list of combined frequency ranges in output frequency frame (to_frame),</span>
<span class="sd">            e.g., [ [minfreq0,maxfreq0], [minfreq1,maxfreq1], ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">image_rms_freq_range</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channelmap_range</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># LOG.info(&quot;#####Raw chanmap_range={}&quot;.format(str(_rgp.chanmap_range_list)))</span>
        <span class="k">for</span> <span class="n">chanmap_range</span> <span class="ow">in</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">chanmap_range_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">map_range</span> <span class="ow">in</span> <span class="n">chanmap_range</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">map_range</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">min_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">map_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">max_chan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">map_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">map_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>
                    <span class="n">channelmap_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">min_chan</span><span class="p">,</span> <span class="n">max_chan</span><span class="p">])</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#####CHANNEL MAP RANGE = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">channelmap_range</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">)):</span>
            <span class="c1"># define channel ranges of lines and deviation mask for each MS</span>
            <span class="n">msobj</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">msobjs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">fieldid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">fieldids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">antid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">antids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">spwid</span> <span class="o">=</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">spwids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">spwobj</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
            <span class="n">deviation_mask</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">msobj</span><span class="p">,</span> <span class="s1">&#39;deviation_mask&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">exclude_range</span> <span class="o">=</span> <span class="n">deviation_mask</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">),</span> <span class="p">[])</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#####</span><span class="si">{}</span><span class="s2"> : DEVIATION MASK = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exclude_range</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">exclude_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">spwobj</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># deviation mask is full channel range when all data are flagged</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Ignoring DEVIATION MASK of </span><span class="si">{}</span><span class="s2"> (SPW </span><span class="si">{:d}</span><span class="s2">, FIELD </span><span class="si">{:d}</span><span class="s2">, ANT </span><span class="si">{:d}</span><span class="s2">). &quot;</span>
                            <span class="s2">&quot;Possibly all data flagged&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">antid</span><span class="p">))</span>
                <span class="n">exclude_range</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">exclude_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">exclude_range</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwobj</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="n">_cp</span><span class="o">.</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spwobj</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channelmap_range</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">exclude_range</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">channelmap_range</span><span class="p">)</span>
            <span class="c1"># check the validity of channel number and fix it when out of range</span>
            <span class="n">min_chan</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">max_chan</span> <span class="o">=</span> <span class="n">spwobj</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">exclude_channel_range</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">max</span><span class="p">(</span><span class="n">min_chan</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_chan</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
                                     <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">merge_ranges</span><span class="p">(</span><span class="n">exclude_range</span><span class="p">)]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> : channel map and deviation mask channel ranges &quot;</span>
                     <span class="s2">&quot;in MS frame = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exclude_channel_range</span><span class="p">)))</span>
            <span class="c1"># define frequency ranges of RMS</span>
            <span class="n">exclude_freq_range</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_channel_range</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">jseg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exclude_channel_range</span><span class="p">)):</span>
                <span class="p">(</span><span class="n">lfreq</span><span class="p">,</span> <span class="n">rfreq</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">spwobj</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">chan_freqs</span><span class="p">[</span><span class="n">jchan</span><span class="p">]</span> <span class="k">for</span> <span class="n">jchan</span> <span class="ow">in</span> <span class="n">exclude_channel_range</span><span class="p">[</span><span class="n">jseg</span><span class="p">])</span>
                <span class="c1"># handling of LSB</span>
                <span class="n">exclude_freq_range</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">jseg</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">jseg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">lfreq</span><span class="p">,</span> <span class="n">rfreq</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">lfreq</span><span class="p">,</span> <span class="n">rfreq</span><span class="p">)]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;#####CHANNEL MAP AND DEVIATION MASK FREQ RANGE = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exclude_freq_range</span><span class="p">)))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exclude_freq_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># no ranges to add</span>
            <span class="c1"># convert MS freqency ranges to image frame</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">fieldid</span><span class="p">]</span>
            <span class="n">direction_ref</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">mdirection</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">start_time</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">end_time</span>
            <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
            <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
            <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
            <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">qmid_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
            <span class="n">qmid_time</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">qmid_time</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">time_ref</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">],</span>
                                <span class="n">v0</span><span class="o">=</span><span class="n">qmid_time</span><span class="p">)</span>
            <span class="n">position_ref</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">antid</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>

            <span class="k">if</span> <span class="n">to_frame</span> <span class="o">==</span> <span class="s1">&#39;REST&#39;</span><span class="p">:</span>
                <span class="n">mse</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ms</span>
                <span class="n">mse</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">obstime</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">qmid_time</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;ymd&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v_to</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">cvelfreqs</span><span class="p">(</span><span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span> <span class="n">outframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">)</span>
                <span class="n">v_from</span> <span class="o">=</span> <span class="n">mse</span><span class="o">.</span><span class="n">cvelfreqs</span><span class="p">(</span><span class="n">spwids</span><span class="o">=</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obstime</span><span class="p">,</span> <span class="n">outframe</span><span class="o">=</span><span class="n">spwobj</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                <span class="n">mse</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">_to_imageframe</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">v_from</span><span class="p">,</span> <span class="n">v_to</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                                                      <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># initialize</span>
                <span class="n">me</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">time_ref</span><span class="p">)</span>
                <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">direction_ref</span><span class="p">)</span>
                <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">position_ref</span><span class="p">)</span>

                <span class="k">def</span> <span class="nf">_to_imageframe</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="n">rf</span><span class="o">=</span><span class="n">spwobj</span><span class="o">.</span><span class="n">frame</span><span class="p">,</span> <span class="n">v0</span><span class="o">=</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;Hz&#39;</span><span class="p">))</span>
                    <span class="n">converted</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">to_frame</span><span class="p">)</span>
                    <span class="n">qout</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">converted</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">outunit</span><span class="o">=</span><span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">qout</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

            <span class="n">image_rms_freq_range</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_to_imageframe</span><span class="p">,</span> <span class="n">exclude_freq_range</span><span class="p">))</span>
            <span class="n">me</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="c1"># LOG.info(&quot;#####Overall LINE CHANNELS IN IMAGE FRAME = {}&quot;.format(str(image_rms_freq_range)))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_rms_freq_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">image_rms_freq_range</span>

        <span class="k">return</span> <span class="n">merge_ranges</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">image_rms_freq_range</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">image_rms_freq_range</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;C&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="SDImaging.get_imagename">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging.get_imagename">[docs]</a>
    <span class="k">def</span> <span class="nf">get_imagename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">spwids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                      <span class="n">antenna</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">asdm</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stokes</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;cube&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a filename of the image.</span>

<span class="sd">        Args:</span>
<span class="sd">            source : Source name</span>
<span class="sd">            spwids : SpW IDs</span>
<span class="sd">            antenna : Antenna name. Defaults to None.</span>
<span class="sd">            asdm : ASDM. Defaults to None.</span>
<span class="sd">            stokes : Stokes parameter. Defaults to None.</span>
<span class="sd">            specmode : specmode for tsdimaging. Defaults to &#39;cube&#39;.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: if asdm is not provided for ampcal</span>

<span class="sd">        Returns:</span>
<span class="sd">            A filename of the image</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span>
        <span class="n">is_nro</span> <span class="o">=</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">is_nro</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_nro</span><span class="p">:</span>
            <span class="n">namer</span> <span class="o">=</span> <span class="n">filenamer</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">virtspw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namer</span> <span class="o">=</span> <span class="n">filenamer</span><span class="o">.</span><span class="n">Image</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="n">asdm</span>
            <span class="k">if</span> <span class="n">nameroot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ASDM uid must be provided to construct ampcal image name&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">is_nro</span><span class="p">:</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span>
            <span class="k">if</span> <span class="n">nameroot</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                <span class="n">nameroot</span> <span class="o">=</span> <span class="s1">&#39;oussid&#39;</span>
        <span class="n">nameroot</span> <span class="o">=</span> <span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">nameroot</span><span class="p">)</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">_associations</span><span class="o">.</span><span class="n">asdm</span><span class="p">(</span><span class="n">nameroot</span><span class="p">)</span>
        <span class="c1"># output_dir = context.output_dir</span>
        <span class="c1"># if output_dir:</span>
        <span class="c1">#    namer.output_dir(output_dir)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_nro</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">stage</span><span class="p">)</span>

        <span class="n">namer</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">is_ampcal</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">intent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">mode</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">is_nro</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">science</span><span class="p">()</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">spectral_window</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">stokes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stokes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">polarization</span><span class="p">(</span><span class="n">stokes</span><span class="p">)</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">specmode</span><span class="p">(</span><span class="n">specmode</span><span class="p">)</span>
        <span class="c1"># so far we always create native resolution, full channel image</span>
        <span class="c1"># namer.spectral_image()</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">_associations</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;image.sd&#39;</span><span class="p">)</span>
        <span class="c1"># namer.single_dish()</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">antenna</span><span class="p">(</span><span class="n">antenna</span><span class="p">)</span>
        <span class="c1"># iteration is necessary for exportdata</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">iteration</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">imagename</span> <span class="o">=</span> <span class="n">namer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">imagename</span></div>


    <span class="k">def</span> <span class="nf">_get_stat_chans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                        <span class="n">combined_rms_exclude</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
                        <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a list of channel ranges to calculate image statistics.</span>

<span class="sd">        Args:</span>
<span class="sd">            imagename : A filename of the image</span>
<span class="sd">            combined_rms_exclude : A list of frequency ranges to exclude</span>
<span class="sd">            edge : The left and right edge channels to exclude. Defaults to (0, 0).</span>
<span class="sd">        Retruns:</span>
<span class="sd">            A 1-d list of channel ranges to INCLUDE in calculation of image</span>
<span class="sd">            statistics, e.g., [imin0, imax0, imin0, imax0, ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
                <span class="n">faxis</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">findaxisbyname</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)</span>
                <span class="n">num_chan</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="n">faxis</span><span class="p">]</span>
                <span class="n">exclude_chan_ranges</span> <span class="o">=</span> <span class="n">convert_frequency_ranges_to_channels</span><span class="p">(</span><span class="n">combined_rms_exclude</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Merged spectral line channel ranges of combined image = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exclude_chan_ranges</span><span class="p">)))</span>
        <span class="n">include_chan_ranges</span> <span class="o">=</span> <span class="n">invert_ranges</span><span class="p">(</span><span class="n">exclude_chan_ranges</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Line free channel ranges of image to calculate RMS = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">include_chan_ranges</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">include_chan_ranges</span>

    <span class="k">def</span> <span class="nf">_get_stat_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrun region to calculate statistics.</span>

<span class="sd">        Median width, height, and position angle is adopted as a reference</span>
<span class="sd">        map extent and then the width and height will be shrinked by 2 beam</span>
<span class="sd">        size in each direction.</span>

<span class="sd">        Arg:</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>

<span class="sd">        Retruns:</span>
<span class="sd">            Region expression string of a rotating box.</span>
<span class="sd">            Returns None if no valid region of interest is defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">beam_unit</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">beam_unit</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">center_unit</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span>
        <span class="n">angle_unit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">angle_unit</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">scan_angle</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">angle_unit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No valid raster information available.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">def</span> <span class="nf">__value_in_unit</span><span class="p">(</span><span class="n">quantity</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
            <span class="c1"># Get value(s) of quantity in a specified unit</span>
            <span class="k">return</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">__extract_values</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Number</span><span class="p">:</span>
            <span class="c1"># Extract valid values of specified attributes in list</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">__value_in_unit</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">unit</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">rep_width</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">__extract_values</span><span class="p">(</span><span class="s1">&#39;width&#39;</span><span class="p">,</span> <span class="n">beam_unit</span><span class="p">))</span>
        <span class="n">rep_height</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">__extract_values</span><span class="p">(</span><span class="s1">&#39;height&#39;</span><span class="p">,</span> <span class="n">beam_unit</span><span class="p">))</span>
        <span class="n">rep_angle</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">([</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">scan_angle</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span> <span class="k">if</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">center_ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">__extract_values</span><span class="p">(</span><span class="s1">&#39;center_ra&#39;</span><span class="p">,</span> <span class="n">center_unit</span><span class="p">))</span>
        <span class="n">center_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">__extract_values</span><span class="p">(</span><span class="s1">&#39;center_dec&#39;</span><span class="p">,</span> <span class="n">center_unit</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">rep_width</span> <span class="o">-</span> <span class="n">beam_size</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">rep_height</span> <span class="o">-</span> <span class="n">beam_size</span>
        <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No valid region selected.</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">_pp</span><span class="o">.</span><span class="n">org_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">center_ra</span><span class="p">,</span> <span class="n">center_dec</span><span class="p">)</span> <span class="o">=</span> <span class="n">direction_utils</span><span class="o">.</span><span class="n">direction_recover</span><span class="p">(</span><span class="n">center_ra</span><span class="p">,</span>
                                                                        <span class="n">center_dec</span><span class="p">,</span>
                                                                        <span class="n">_pp</span><span class="o">.</span><span class="n">org_direction</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">center_ra</span><span class="p">,</span> <span class="n">center_unit</span><span class="p">)),</span>
                  <span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">center_dec</span><span class="p">,</span> <span class="n">center_unit</span><span class="p">))]</span>

        <span class="n">region</span> <span class="o">=</span> <span class="s2">&quot;rotbox[</span><span class="si">{}</span><span class="s2">, [</span><span class="si">{}{}</span><span class="s2">, </span><span class="si">{}{}</span><span class="s2">], </span><span class="si">{}{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">center</span><span class="p">,</span>
                                                         <span class="n">width</span><span class="p">,</span> <span class="n">beam_unit</span><span class="p">,</span>
                                                         <span class="n">height</span><span class="p">,</span> <span class="n">beam_unit</span><span class="p">,</span>
                                                         <span class="n">rep_angle</span><span class="p">,</span> <span class="n">angle_unit</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">region</span>

<div class="viewcode-block" id="SDImaging.get_raster_info_list">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging.get_raster_info_list">[docs]</a>
    <span class="k">def</span> <span class="nf">get_raster_info_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                             <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">RasterInfo</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrun a list of raster information.</span>

<span class="sd">        Each raster infromation is analyzed for element wise combination of</span>
<span class="sd">        infile, antenna, field, and SpW IDs in input parameter lists.</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of RasterInfo. If raster information could not be obtained,</span>
<span class="sd">            the corresponding elements in the list will be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">)</span>
        <span class="n">raster_info_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span> <span class="ow">in</span> \
                <span class="nb">zip</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">):</span>
            <span class="n">msobj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">infile</span><span class="p">)</span>
            <span class="c1"># Non raster data set.</span>
            <span class="k">if</span> <span class="n">msobj</span><span class="o">.</span><span class="n">observing_pattern</span><span class="p">[</span><span class="n">antid</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="n">fieldid</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;RASTER&#39;</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Not a raster map: field </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">raster_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">_cp</span><span class="o">.</span><span class="n">dt_dict</span><span class="p">[</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">raster_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_analyze_raster_pattern</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">msobj</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">msobj</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">antid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not get raster information of field </span><span class="si">{}</span><span class="s1">, Spw </span><span class="si">{}</span><span class="s1">, Ant </span><span class="si">{}</span><span class="s1">, MS </span><span class="si">{}</span><span class="s1">. &#39;</span>
                         <span class="s1">&#39;Potentially be because all data are flagged.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">raster_info_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">raster_info_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">raster_info_list</span></div>


<div class="viewcode-block" id="SDImaging.calculate_theoretical_image_rms">
<a class="viewcode-back" href="../../../../../_automodapi/pipeline.hsd.tasks.SDImaging.html#pipeline.hsd.tasks.SDImaging.calculate_theoretical_image_rms">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_theoretical_image_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                        <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                        <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate theoretical RMS of an image (PIPE-657).</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>

<span class="sd">        Note: the number of elements in _rgp.combined.antids, fieldids, spws, and pols should be equal</span>
<span class="sd">              to that of infiles</span>

<span class="sd">        Returns:</span>
<span class="sd">            A quantum value of theoretical image RMS.</span>
<span class="sd">            The value of quantity will be negative when calculation is aborted, i.e., -1.0 Jy/beam</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_tirp</span> <span class="o">=</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">(</span><span class="n">_pp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No MS given to calculate a theoretical RMS. Aborting calculation of theoretical thermal noise.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">failed_rms</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">pols</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span><span class="p">)</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">infile</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">pol_names</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span><span class="p">)</span> <span class="ow">in</span> \
            <span class="nb">zip</span><span class="p">(</span><span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">infiles</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">antids</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">fieldids</span><span class="p">,</span>
                <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">pols</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">raster_infos</span><span class="p">):</span>
            <span class="n">halt</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__loop_initializer_of_theoretical_image_rms</span><span class="p">(</span><span class="n">_cp</span><span class="p">,</span> <span class="n">_rgp</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">halt</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">failed_rms</span>
            <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># effective BW</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_effective_BW</span><span class="p">(</span><span class="n">_tirp</span><span class="p">)</span>
            <span class="c1"># obtain average Tsys</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_average_tsys</span><span class="p">(</span><span class="n">_tirp</span><span class="p">)</span>
            <span class="c1"># obtain Wx, and Wy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_wx_and_wy</span><span class="p">(</span><span class="n">_tirp</span><span class="p">)</span>
            <span class="c1"># obtain T_ON</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_t_on_actual</span><span class="p">(</span><span class="n">_tirp</span><span class="p">)</span>
            <span class="c1"># obtain calibration tables applied</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_calibration_tables_applied</span><span class="p">(</span><span class="n">_tirp</span><span class="p">)</span>
            <span class="c1"># obtain T_sub,on, T_sub,off</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_t_sub_on_off</span><span class="p">(</span><span class="n">_tirp</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">failed_rms</span>
            <span class="c1"># obtain factors by convolution function</span>
            <span class="c1"># (THIS ASSUMES SF kernel with either convsupport = 6 (ALMA) or 3 (NRO)</span>
            <span class="c1"># TODO: Ggeneralize factor for SF, and Gaussian convolution function</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_and_set_factors_by_convolution_function</span><span class="p">(</span><span class="n">_pp</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">failed_rms</span>

        <span class="k">if</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No rms estimate is available.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">failed_rms</span>

        <span class="n">__theoretical_rms</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">sq_rms</span><span class="p">)</span> <span class="o">/</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">N</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Theoretical RMS of image = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__theoretical_rms</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__theoretical_rms</span><span class="p">,</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__obtain_t_sub_on_off</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain TsubON and TsubOFF. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>

<span class="sd">        Returns:</span>
<span class="sd">            False if it cannot get Tsub On/Off values by some error.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException : raises when it cannot find a sky caltable applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_on</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span><span class="o">.</span><span class="n">row_duration</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">__sky_field</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">calmsobj</span><span class="o">.</span><span class="n">calibration_strategy</span><span class="p">[</span><span class="s1">&#39;field_strategy&#39;</span><span class="p">][</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">__skytab</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">__caltabs</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">callibrary</span><span class="o">.</span><span class="n">applied</span><span class="o">.</span><span class="n">get_caltable</span><span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">)</span>
            <span class="c1"># For some reasons, sky caltable is not registered to calstate</span>
            <span class="k">for</span> <span class="n">__cto</span><span class="p">,</span> <span class="n">__cfrom</span> <span class="ow">in</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">callibrary</span><span class="o">.</span><span class="n">applied</span><span class="o">.</span><span class="n">merged</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">__cto</span><span class="o">.</span><span class="n">vis</span> <span class="o">==</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">calmsobj</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="p">(</span><span class="n">__cto</span><span class="o">.</span><span class="n">field</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span>
                                                         <span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span> <span class="ow">in</span>
                                                         <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">calmsobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">__cto</span><span class="o">.</span><span class="n">field</span><span class="p">)]):</span>
                    <span class="k">for</span> <span class="n">__cf</span> <span class="ow">in</span> <span class="n">__cfrom</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">__cf</span><span class="o">.</span><span class="n">gaintable</span> <span class="ow">in</span> <span class="n">__caltabs</span><span class="p">:</span>
                            <span class="n">__skytab</span> <span class="o">=</span> <span class="n">__cf</span><span class="o">.</span><span class="n">gaintable</span>
                            <span class="k">break</span>
        <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find a sky caltable applied. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">__skytab</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find a sky caltable applied. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Searching OFF scans in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__skytab</span><span class="p">)))</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">__skytab</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">__interval_unit</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">,</span> <span class="s1">&#39;QuantumUnits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">__t</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID==</span><span class="si">{}</span><span class="s1">&amp;&amp;ANTENNA1==</span><span class="si">{}</span><span class="s1">&amp;&amp;FIELD_ID==</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">,</span>
                                                                                       <span class="n">__sky_field</span><span class="p">),</span>
                           <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">__t</span><span class="o">.</span><span class="n">nrows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No sky caltable row found for spw </span><span class="si">{}</span><span class="s1">, antenna </span><span class="si">{}</span><span class="s1">, field </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">. </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">,</span> <span class="n">__sky_field</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__skytab</span><span class="p">),</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">))</span>
                <span class="n">__t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">__interval</span> <span class="o">=</span> <span class="n">__t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">__t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_off</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">__interval</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
                                                                                  <span class="n">__interval_unit</span><span class="p">),</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Subscan Time ON = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">, OFF = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_on</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">,</span>
                 <span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_off</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__obtain_jy_per_k</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">,</span>
                          <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain Jy/K. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>

<span class="sd">        Returns:</span>
<span class="sd">            Jy/K value or failure flag</span>

<span class="sd">        Raises:</span>
<span class="sd">            BaseException : raises when it cannot find a Jy/K caltable applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">_pp</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span><span class="p">:</span>
            <span class="n">__jy_per_k</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No Jy/K conversion was performed to the image.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">__k2jytab</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">__caltabs</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">callibrary</span><span class="o">.</span><span class="n">applied</span><span class="o">.</span><span class="n">get_caltable</span><span class="p">((</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;gaincal&#39;</span><span class="p">))</span>
                <span class="n">__found</span> <span class="o">=</span> <span class="n">__caltabs</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">calst</span><span class="o">.</span><span class="n">get_caltable</span><span class="p">((</span><span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;gaincal&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">__found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find a Jy/K caltable applied. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">__found</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;More than one Jy/K caltables are found.&#39;</span><span class="p">)</span>
                <span class="n">__k2jytab</span> <span class="o">=</span> <span class="n">__found</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Searching Jy/K factor in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__k2jytab</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not find a Jy/K caltable applied. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">__k2jytab</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find a Jy/K caltable applied. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">__k2jytab</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">__t</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID==</span><span class="si">{}</span><span class="s1">&amp;&amp;ANTENNA1==</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">),</span>
                               <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">__t</span><span class="o">.</span><span class="n">nrows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No Jy/K caltable row found for spw </span><span class="si">{}</span><span class="s1">, antenna </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">. </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span>
                                <span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__k2jytab</span><span class="p">),</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">))</span>
                    <span class="n">__t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="k">return</span> <span class="kc">False</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tc</span> <span class="o">=</span> <span class="n">__t</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">__t</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">__jy_per_k</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">tc</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Jy/K factor = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__jy_per_k</span><span class="p">))</span>  <span class="c1"># obtain Jy/k factor</span>
        <span class="k">return</span> <span class="n">__jy_per_k</span>

    <span class="k">def</span> <span class="nf">__obtain_and_set_factors_by_convolution_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_pp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">PostProcessParameters</span><span class="p">,</span>
                                                         <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain factors by convolution function, and set it into TIRP. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _pp : Imaging post process parameters of prepare()</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>

<span class="sd">        Returns:</span>
<span class="sd">            False if it cannot get Jy/K</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">observatory_policy</span><span class="o">.</span><span class="n">get_imaging_policy</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="p">)</span>
        <span class="n">jy_per_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__obtain_jy_per_k</span><span class="p">(</span><span class="n">_pp</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jy_per_k</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">ang</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span><span class="o">.</span><span class="n">scan_angle</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">c_proj</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cy_val</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cx_val</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ang</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">inv_variant_on</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">effBW</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cx_val</span> <span class="o">*</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cy_val</span><span class="p">)</span> <span class="o">*</span> \
            <span class="n">_tirp</span><span class="o">.</span><span class="n">t_on_act</span> <span class="o">/</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">height</span>
        <span class="n">inv_variant_off</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">effBW</span> <span class="o">*</span> <span class="n">c_proj</span> <span class="o">*</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_off</span> <span class="o">*</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">t_on_act</span> <span class="o">/</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">t_sub_on</span> <span class="o">/</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">height</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">polids</span><span class="p">:</span>
            <span class="n">_tirp</span><span class="o">.</span><span class="n">sq_rms</span> <span class="o">+=</span> <span class="p">(</span><span class="n">jy_per_k</span> <span class="o">*</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">mean_tsys_per_pol</span><span class="p">[</span><span class="n">ipol</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">get_conv2d</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">inv_variant_on</span> <span class="o">+</span> <span class="n">policy</span><span class="o">.</span><span class="n">get_conv1d</span><span class="p">()</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">inv_variant_off</span><span class="p">)</span>
            <span class="n">_tirp</span><span class="o">.</span><span class="n">N</span> <span class="o">+=</span> <span class="mf">1.0</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__obtain_t_on_actual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain T_on actual. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
        <span class="n">t_on_tot</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span>
            <span class="n">_tirp</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">unit</span><span class="p">),</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># flagged fraction</span>
        <span class="n">full_intent</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">to_CASA_intent</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">)</span>
        <span class="n">flagdata_summary_job</span> <span class="o">=</span> <span class="n">casa_tasks</span><span class="o">.</span><span class="n">flagdata</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">_tirp</span><span class="o">.</span><span class="n">infile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span>
                                                   <span class="n">antenna</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&amp;&amp;&amp;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">),</span>
                                                   <span class="n">field</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">),</span>
                                                   <span class="n">spw</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">),</span> <span class="n">intent</span><span class="o">=</span><span class="n">full_intent</span><span class="p">,</span>
                                                   <span class="n">spwcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fieldcnt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">name</span><span class="o">=</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span>
        <span class="n">flag_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flagdata_summary_job</span><span class="p">)</span>
        <span class="n">frac_flagged</span> <span class="o">=</span> <span class="n">flag_stats</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">)][</span><span class="s1">&#39;flagged&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">flag_stats</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">)][</span><span class="s1">&#39;total&#39;</span><span class="p">]</span>
        <span class="c1"># the actual time on source</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">t_on_act</span> <span class="o">=</span> <span class="n">t_on_tot</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">frac_flagged</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The actual on source time = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">t_on_act</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- total time on source = </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t_on_tot</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">time_unit</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- flagged Fraction = </span><span class="si">{}</span><span class="s1"> %&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">frac_flagged</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__obtain_calibration_tables_applied</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain calibration tables applied. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">__calto</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalTo</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">_tirp</span><span class="o">.</span><span class="n">calmsobj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">))</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">calst</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">callibrary</span><span class="o">.</span><span class="n">applied</span><span class="o">.</span><span class="n">trimmed</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">__calto</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__obtain_wx_and_wy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain Wx and Wy. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">ang_unit</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">ang_unit</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__obtain_average_tsys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain average Tsys. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">mean_tsys_per_pol</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TSYS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">index_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Mean Tsys = </span><span class="si">{}</span><span class="s1"> K&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">mean_tsys_per_pol</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">__obtain_effective_BW</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Obtain effective BW. A sub method of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSMDReader</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">__msmd</span><span class="p">:</span>
            <span class="n">_tirp</span><span class="o">.</span><span class="n">effBW</span> <span class="o">=</span> <span class="n">__msmd</span><span class="o">.</span><span class="n">chaneffbws</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using an MS effective bandwidth, </span><span class="si">{}</span><span class="s1"> kHz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">effBW</span> <span class="o">*</span> <span class="mf">0.001</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__loop_initializer_of_theoretical_image_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_cp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">CommonParameters</span><span class="p">,</span>
                                                    <span class="n">_rgp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">ReductionGroupParameters</span><span class="p">,</span>
                                                    <span class="n">_tirp</span><span class="p">:</span> <span class="n">imaging_params</span><span class="o">.</span><span class="n">TheoreticalImageRmsParameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize imaging_params.TheoreticalImageRmsParameters for the loop of calculate_theoretical_image_rms().</span>

<span class="sd">        Args:</span>
<span class="sd">            _cp : Common parameter object of prepare()</span>
<span class="sd">            _rgp : Reduction group parameter object of prepare()</span>
<span class="sd">            _tirp : Parameter object of calculate_theoretical_image_rms()</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tupled flag to describe the loop action [go|halt|skip].</span>
<span class="sd">                GO   : (False, False)</span>
<span class="sd">                HALT : (True,  True)</span>
<span class="sd">                SKIP : (False, True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">_tirp</span><span class="o">.</span><span class="n">infile</span><span class="p">)</span>
        <span class="n">__callist</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">([</span><span class="n">DataType</span><span class="o">.</span><span class="n">REGCAL_CONTLINE_ALL</span><span class="p">])</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">calmsobj</span> <span class="o">=</span> <span class="n">sdutils</span><span class="o">.</span><span class="n">match_origin_ms</span><span class="p">(</span><span class="n">__callist</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
        <span class="n">__dd_corrs</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">)</span><span class="o">.</span><span class="n">corr_axis</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">polids</span> <span class="o">=</span> <span class="p">[</span><span class="n">__dd_corrs</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">pol_names</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">__dd_corrs</span><span class="p">]</span>
        <span class="n">__field_name</span> <span class="o">=</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;Aborting calculation of theoretical thermal noise of &#39;</span> <span class="o">+</span> \
                          <span class="s1">&#39;Field </span><span class="si">{}</span><span class="s1"> and SpW </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__field_name</span><span class="p">,</span> <span class="n">_rgp</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">spws</span><span class="p">)</span>
        <span class="n">__HALT</span> <span class="o">=</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">__SKIP</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">__GO</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">observing_pattern</span><span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">][</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">][</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;RASTER&#39;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to calculate RMS of non-Raster map. &#39;</span> <span class="o">+</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">__HALT</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;Processing MS </span><span class="si">{}</span><span class="s1">, Field </span><span class="si">{}</span><span class="s1">, SpW </span><span class="si">{}</span><span class="s1">, &#39;</span>
            <span class="s1">&#39;Antenna </span><span class="si">{}</span><span class="s1">, Pol </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
            <span class="nb">format</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">__field_name</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span>
                   <span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">pol_names</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">raster_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">__rsres</span> <span class="o">=</span> <span class="n">RasterScanHeuristicsResult</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="p">)</span>
            <span class="n">_rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_incomp</span> \
                              <span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">,</span> <span class="p">[])</span> \
                              <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__rsres</span><span class="p">)</span>
            <span class="n">__rsres</span><span class="o">.</span><span class="n">set_result_fail</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">,</span> <span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Raster scan analysis incomplete. Skipping calculation of theoretical image RMS : EB:</span><span class="si">{</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">execblock_id</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">__SKIP</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">_cp</span><span class="o">.</span><span class="n">dt_dict</span><span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">basename</span><span class="p">]</span>
        <span class="n">_tirp</span><span class="o">.</span><span class="n">index_list</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_index_list_for_ms</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">],</span>
                                                        <span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">antid</span><span class="p">],</span> <span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">fieldid</span><span class="p">],</span> <span class="p">[</span><span class="n">_tirp</span><span class="o">.</span><span class="n">spwid</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">_tirp</span><span class="o">.</span><span class="n">index_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># this happens when permanent flag is set to all selection.</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No unflagged row in DataTable. Skipping further calculation.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">__SKIP</span>
        <span class="k">return</span> <span class="n">__GO</span></div>



<span class="k">def</span> <span class="nf">_analyze_raster_pattern</span><span class="p">(</span><span class="n">datatable</span><span class="p">:</span> <span class="n">DataTable</span><span class="p">,</span> <span class="n">msobj</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">,</span>
                            <span class="n">fieldid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spwid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">antid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">rgp</span><span class="p">:</span> <span class="s1">&#39;imaging_params.ReductionGroupParameters&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RasterInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyze raster scan pattern from pointing in DataTable.</span>

<span class="sd">    Args:</span>
<span class="sd">        datatable : DataTable instance</span>
<span class="sd">        msobj : MS class instance to process</span>
<span class="sd">        fieldid : A field ID to process</span>
<span class="sd">        spwid : An SpW ID to process</span>
<span class="sd">        antid : An antenna ID to process</span>
<span class="sd">        rgp : Reduction group parameter object of prepare()</span>

<span class="sd">    Returns:</span>
<span class="sd">        A named Tuple of RasterInfo</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">origin_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">rasterutil</span><span class="o">.</span><span class="n">read_datatable</span><span class="p">(</span><span class="n">datatable</span><span class="p">)</span>
    <span class="n">pflag</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">pflag</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">ra</span>
    <span class="n">dec</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">dec</span>
    <span class="n">exposure</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">)</span>
    <span class="n">timetable</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">get_timetable</span><span class="p">(</span><span class="n">ant</span><span class="o">=</span><span class="n">antid</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> <span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="n">origin_basename</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="c1"># dtrow_list is a list of numpy array holding datatable rows separated by raster rows</span>
    <span class="c1"># [[r00, r01, r02, ...], [r10, r11, r12, ...], ...]</span>
    <span class="n">dtrow_list_nomask</span> <span class="o">=</span> <span class="n">rasterutil</span><span class="o">.</span><span class="n">extract_dtrow_list</span><span class="p">(</span><span class="n">timetable</span><span class="p">)</span>
    <span class="n">dtrow_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="n">pflag</span><span class="p">[</span><span class="n">rows</span><span class="p">]]</span> <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">dtrow_list_nomask</span> <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">pflag</span><span class="p">[</span><span class="n">rows</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)]</span>
    <span class="n">radec_unit</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;OFS_RA&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">radec_unit</span> <span class="o">==</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;OFS_DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
    <span class="n">exp_unit</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;EXPOSURE&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
    <span class="n">_rsres</span> <span class="o">=</span> <span class="n">RasterScanHeuristicsResult</span><span class="p">(</span><span class="n">msobj</span><span class="p">)</span>
    <span class="n">rgp</span><span class="o">.</span><span class="n">imager_result</span><span class="o">.</span><span class="n">rasterscan_heuristics_results_rgap</span> \
                     <span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">,</span> <span class="p">[])</span> \
                     <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_rsres</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">gap_r</span> <span class="o">=</span> <span class="n">rasterscan</span><span class="o">.</span><span class="n">find_raster_gap</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">dtrow_list</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">RasterScanHeuristicsFailure</span><span class="p">):</span>
            <span class="n">_rsres</span><span class="o">.</span><span class="n">set_result_fail</span><span class="p">(</span><span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> : EB:</span><span class="si">{}</span><span class="s1">:</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">msobj</span><span class="o">.</span><span class="n">execblock_id</span><span class="p">,</span> <span class="n">msobj</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">antid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtrow_list_large</span> <span class="o">=</span> <span class="n">rasterutil</span><span class="o">.</span><span class="n">extract_dtrow_list</span><span class="p">(</span><span class="n">timetable</span><span class="p">,</span> <span class="n">for_small_gap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">se_small</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dtrow_list</span><span class="p">]</span>
            <span class="n">se_large</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dtrow_list_large</span><span class="p">]</span>
            <span class="n">gap_r</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sl</span><span class="p">,</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">se_large</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ss</span><span class="p">,</span> <span class="n">es</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">se_small</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ss</span> <span class="o">==</span> <span class="n">sl</span><span class="p">:</span>
                        <span class="n">gap_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="k">break</span>
            <span class="n">gap_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dtrow_list</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find gaps between raster scans. No result is produced.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
    <span class="n">idx_all</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">dtrow_list</span><span class="p">)</span>
    <span class="n">mean_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">datatable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;DEC&#39;</span><span class="p">)[</span><span class="n">idx_all</span><span class="p">])</span>
    <span class="n">dec_unit</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcolkeyword</span><span class="p">(</span><span class="s1">&#39;DEC&#39;</span><span class="p">,</span> <span class="s1">&#39;UNIT&#39;</span><span class="p">)</span>
    <span class="n">map_center_dec</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span>
        <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">mean_dec</span><span class="p">,</span> <span class="n">dec_unit</span><span class="p">),</span> <span class="s1">&#39;rad&#39;</span><span class="p">)</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dec_factor</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">map_center_dec</span><span class="p">))</span>

    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dtrow_list</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">exposure</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">dtrow_list</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">num_integration</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">dtrow_list</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">center_ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">ra</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">dtrow_list</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">center_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dec</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">dtrow_list</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">delta_ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">ra</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">*</span> <span class="n">dec_factor</span><span class="p">,</span> <span class="n">dtrow_list</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">delta_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dec</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">dec</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtrow_list</span><span class="p">),</span>
        <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">ndata</span>
    <span class="p">)</span>
    <span class="n">height_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gap_r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">gap_r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">start_ra</span> <span class="o">=</span> <span class="n">center_ra</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">start_dec</span> <span class="o">=</span> <span class="n">center_dec</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">end_ra</span> <span class="o">=</span> <span class="n">center_ra</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">end_dec</span> <span class="o">=</span> <span class="n">center_dec</span><span class="p">[</span><span class="n">e</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">height_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">numpy</span><span class="o">.</span><span class="n">hypot</span><span class="p">((</span><span class="n">start_ra</span> <span class="o">-</span> <span class="n">end_ra</span><span class="p">)</span> <span class="o">*</span> <span class="n">dec_factor</span><span class="p">,</span> <span class="n">start_dec</span> <span class="o">-</span> <span class="n">end_dec</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: ant </span><span class="si">%s</span><span class="s1">, spw </span><span class="si">%s</span><span class="s1">, field </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">antid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldid</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: map_center_dec=</span><span class="si">%s</span><span class="s1">, dec_factor=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">map_center_dec</span><span class="p">,</span> <span class="n">dec_factor</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: duration=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: num_integration=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">num_integration</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: delta_ra=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">delta_ra</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: delta_dec=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">delta_dec</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: center_ra=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">center_ra</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: center_dec=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">center_dec</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: height_list=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">height_list</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR: dtrows&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">dtrow_list</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;REFACTOR:   </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
    <span class="n">center_ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center_ra</span><span class="p">)</span>
    <span class="n">center_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center_dec</span><span class="p">)</span>
    <span class="n">row_sep_ra</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_ra</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">center_ra</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">dec_factor</span>
    <span class="n">row_sep_dec</span> <span class="o">=</span> <span class="n">center_dec</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">center_dec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">row_separation</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">row_sep_ra</span><span class="p">,</span> <span class="n">row_sep_dec</span><span class="p">))</span>
    <span class="c1"># find complate raster</span>
    <span class="n">num_row_int</span> <span class="o">=</span> <span class="n">rasterutil</span><span class="o">.</span><span class="n">find_most_frequent</span><span class="p">(</span><span class="n">num_integration</span><span class="p">)</span>
    <span class="n">complete_idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num_integration</span> <span class="o">&gt;=</span> <span class="n">num_row_int</span><span class="p">)</span>
    <span class="c1"># raster scan parameters</span>
    <span class="n">row_duration</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">duration</span><span class="p">)[</span><span class="n">complete_idx</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">row_delta_ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_ra</span><span class="p">)[</span><span class="n">complete_idx</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">row_delta_dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_dec</span><span class="p">)[</span><span class="n">complete_idx</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">row_delta_ra</span><span class="p">,</span> <span class="n">row_delta_dec</span><span class="p">)</span>
    <span class="n">sign_ra</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">delta_ra</span><span class="p">[</span><span class="n">complete_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">sign_dec</span> <span class="o">=</span> <span class="o">+</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">delta_dec</span><span class="p">[</span><span class="n">complete_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">scan_angle</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">sign_dec</span> <span class="o">*</span> <span class="n">row_delta_dec</span><span class="p">,</span> <span class="n">sign_ra</span> <span class="o">*</span> <span class="n">row_delta_ra</span><span class="p">)</span>
    <span class="n">hight</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">height_list</span><span class="p">)</span>
    <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">center_ra</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">center_ra</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">radec_unit</span><span class="p">),</span>
              <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">center_dec</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">center_dec</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="n">radec_unit</span><span class="p">))</span>
    <span class="n">raster_info</span> <span class="o">=</span> <span class="n">RasterInfo</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                             <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">radec_unit</span><span class="p">),</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">hight</span><span class="p">,</span> <span class="n">radec_unit</span><span class="p">),</span>
                             <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">scan_angle</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">),</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">row_separation</span><span class="p">,</span> <span class="n">radec_unit</span><span class="p">),</span>
                             <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">row_duration</span><span class="p">,</span> <span class="n">exp_unit</span><span class="p">))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Raster Information&#39;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- Map Center: [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">center_ra</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">center_dec</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">8</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- Scan Extent: [</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">] (scan direction: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">width</span><span class="p">),</span>
                                                                   <span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">height</span><span class="p">),</span>
                                                                   <span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">scan_angle</span><span class="p">)))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- Raster row separation = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">row_separation</span><span class="p">)))</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;- Raster row scan duration = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">tos</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">raster_info</span><span class="o">.</span><span class="n">row_duration</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">raster_info</span>


<div class="viewcode-block" id="calc_image_statistics">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.calc_image_statistics.html#pipeline.hsd.tasks.calc_image_statistics">[docs]</a>
<span class="k">def</span> <span class="nf">calc_image_statistics</span><span class="p">(</span><span class="n">imagename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chans</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">region</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return image statistics with channel and region selection.</span>

<span class="sd">    Args:</span>
<span class="sd">        imagename : Path to image to calculate statistics</span>
<span class="sd">        chans : Channel range selection string, e.g., &#39;0~110;240~300&#39;</span>
<span class="sd">        region : Region definition string.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary of statistic values returned by ia.statistics.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Calculateing image statistics of chans=&#39;</span><span class="si">{}</span><span class="s2">&#39;, region=&#39;</span><span class="si">{}</span><span class="s2">&#39; in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chans</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">imagename</span><span class="p">))</span>
    <span class="n">rg</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">regionmanager</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chan_sel</span> <span class="o">=</span> <span class="n">rg</span><span class="o">.</span><span class="n">frombcs</span><span class="p">(</span><span class="n">csys</span><span class="o">=</span><span class="n">cs</span><span class="o">.</span><span class="n">torecord</span><span class="p">(),</span> <span class="n">shape</span><span class="o">=</span><span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">(),</span> <span class="n">chans</span><span class="o">=</span><span class="n">chans</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="n">rg</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
        <span class="n">subim</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">subimage</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">chan_sel</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">subim</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">subim</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">stat</span></div>



<span class="c1"># Utility methods to calcluate channel ranges</span>
<div class="viewcode-block" id="convert_frequency_ranges_to_channels">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.convert_frequency_ranges_to_channels.html#pipeline.hsd.tasks.convert_frequency_ranges_to_channels">[docs]</a>
<span class="k">def</span> <span class="nf">convert_frequency_ranges_to_channels</span><span class="p">(</span><span class="n">range_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
                                         <span class="n">cs</span><span class="p">:</span> <span class="s1">&#39;coordsys&#39;</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert frequency ranges to channel ones.</span>

<span class="sd">    Args:</span>
<span class="sd">        range_list : A list of min/max frequency ranges,</span>
<span class="sd">            e.g., [[fmin0,fmax0],[fmin1, fmax1],...]</span>
<span class="sd">        cs : A coordinate system to convert world values to pixel one</span>
<span class="sd">        num_chan : The number of channels in frequency axis</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of min/max channels, e.g., [[imin0, imax0],[imin1,imax1],...]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">faxis</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">findaxisbyname</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)</span>
    <span class="n">ref_world</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">]</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aggregated spectral line frequency ranges of combined image = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">range_list</span><span class="p">)))</span>
    <span class="n">channel_ranges</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># should be list for sort</span>
    <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">range_list</span><span class="p">:</span>
        <span class="n">ref_world</span><span class="p">[</span><span class="n">faxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">start_chan</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">topixel</span><span class="p">(</span><span class="n">ref_world</span><span class="p">)[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">faxis</span><span class="p">]</span>
        <span class="n">ref_world</span><span class="p">[</span><span class="n">faxis</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">end_chan</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">topixel</span><span class="p">(</span><span class="n">ref_world</span><span class="p">)[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="n">faxis</span><span class="p">]</span>
        <span class="c1"># handling of LSB</span>
        <span class="n">min_chan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_chan</span><span class="p">,</span> <span class="n">end_chan</span><span class="p">)</span>
        <span class="n">max_chan</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start_chan</span><span class="p">,</span> <span class="n">end_chan</span><span class="p">)</span>
        <span class="c1"># LOG.info(&quot;#####Freq to Chan: [{:f}, {:f}] -&gt; [{:f}, {:f}]&quot;.format(segment[0], segment[1], min_chan, max_chan))</span>
        <span class="k">if</span> <span class="n">max_chan</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span> <span class="ow">or</span> <span class="n">min_chan</span> <span class="o">&gt;</span> <span class="n">num_chan</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">:</span>  <span class="c1"># out of range</span>
            <span class="c1"># LOG.info(&quot;#####Omitting channel range [{:f}, {:f}]&quot;.format(min_chan, max_chan))</span>
            <span class="k">continue</span>
        <span class="n">channel_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_chan</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
                               <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_chan</span><span class="p">),</span> <span class="n">num_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">channel_ranges</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">merge_ranges</span><span class="p">(</span><span class="n">channel_ranges</span><span class="p">)</span></div>



<div class="viewcode-block" id="convert_range_list_to_string">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.convert_range_list_to_string.html#pipeline.hsd.tasks.convert_range_list_to_string">[docs]</a>
<span class="k">def</span> <span class="nf">convert_range_list_to_string</span><span class="p">(</span><span class="n">range_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a list of index ranges to string.</span>

<span class="sd">    Args:</span>
<span class="sd">        range_list : A list of ranges, e.g., [imin0, imax0, imin1, imax1, ...]</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string in form, e.g., &#39;imin0~imax0;imin1~imax1&#39;</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; convert_range_list_to_string( [5, 10, 15, 20] )</span>
<span class="sd">        &#39;5~10;15~20&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stat_chans</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{:d}</span><span class="s1">~</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">range_list</span><span class="p">[</span><span class="n">iseg</span><span class="p">],</span> <span class="n">range_list</span><span class="p">[</span><span class="n">iseg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                               <span class="k">for</span> <span class="n">iseg</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_list</span><span class="p">),</span> <span class="mi">2</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">stat_chans</span></div>



<div class="viewcode-block" id="merge_ranges">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.merge_ranges.html#pipeline.hsd.tasks.merge_ranges">[docs]</a>
<span class="k">def</span> <span class="nf">merge_ranges</span><span class="p">(</span><span class="n">range_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="n">Number</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge overlapping ranges in range_list.</span>

<span class="sd">    Args:</span>
<span class="sd">        range_list : A list of ranges to merge, e.g., [ [min0,max0], [min1,max1], .... ]</span>
<span class="sd">                    Each range in the list should be in ascending order (min0 &lt;= max0)</span>
<span class="sd">                    There is no assumption in the order of ranges, e.g., min0 w.r.t min1</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: too few elements in the range description, such as [] or [min0]</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of merged ranges</span>
<span class="sd">        e.g., [[min_merged0,max_marged0], [min_merged1,max_merged1], ....]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># LOG.info(&quot;#####Merge ranges: {}&quot;.format(str(range_list)))</span>
    <span class="n">num_range</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">num_range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[</span><span class="n">range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_range</span><span class="p">):</span>
        <span class="n">segment</span> <span class="o">=</span> <span class="n">range_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;segments in range list must have 2 elements&quot;</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>  <span class="c1"># no overlap</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">overlap</span> <span class="o">=</span> <span class="n">j</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">overlap</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">segment</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">segment</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1"># Check if further merge is necessary</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_range</span><span class="p">:</span>
        <span class="n">num_range</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
        <span class="n">merged</span> <span class="o">=</span> <span class="n">merge_ranges</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="c1"># LOG.info(&quot;#####Merged: {}&quot;.format(str(merged)))</span>
    <span class="k">return</span> <span class="n">merged</span></div>



<div class="viewcode-block" id="invert_ranges">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.imaging.imaging.invert_ranges.html#pipeline.hsd.tasks.invert_ranges">[docs]</a>
<span class="k">def</span> <span class="nf">invert_ranges</span><span class="p">(</span><span class="n">id_range_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span>
                  <span class="n">num_ids</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return inverted ID ranges.</span>

<span class="sd">    Args:</span>
<span class="sd">        id_range_list : A list of min/max ID ranges to invert. The list should</span>
<span class="sd">            be sorted in the ascending order of min IDs.</span>
<span class="sd">        num_ids : Number of IDs to consider</span>
<span class="sd">        edge : The left and right edges to exclude</span>

<span class="sd">    Returns:</span>
<span class="sd">        A 1-d list of inverted ranges</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; id_range_list = [[5,10],[15,20]]</span>
<span class="sd">        &gt;&gt;&gt; num_ids = 30</span>
<span class="sd">        &gt;&gt;&gt; edge = (2,3)</span>
<span class="sd">        &gt;&gt;&gt; invert_ranges(id_range_list, num_ids, edge)</span>
<span class="sd">        [2, 4, 11, 14, 21, 26]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inverted_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">id_range_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">inverted_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_ids</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">id_range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">inverted_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id_range_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">id_range_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">start_include</span> <span class="o">=</span> <span class="n">id_range_list</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">end_include</span> <span class="o">=</span> <span class="n">id_range_list</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">start_include</span> <span class="o">&lt;=</span> <span class="n">end_include</span><span class="p">:</span>
                <span class="n">inverted_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">start_include</span><span class="p">,</span> <span class="n">end_include</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">id_range_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">num_ids</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">inverted_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">id_range_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_ids</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">inverted_list</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>