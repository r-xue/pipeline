

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hsd.tasks.common.display &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task (sphinx-autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Task Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html"><code class="docutils literal notranslate"><span class="pre">pipeline.hifa.tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif.tasks"><code class="docutils literal notranslate"><span class="pre">pipeline.hif.tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif"><code class="docutils literal notranslate"><span class="pre">pipeline.hif</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#pipeline-inheritance-diagrams">Pipeline Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hsd.tasks.common.display</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hsd.tasks.common.display</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Set of base classes and utility functions for display modules.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">casatools</span> <span class="kn">import</span> <span class="n">coordsys</span> <span class="k">as</span> <span class="n">casa_coordsys</span>  <span class="c1"># Used for annotation purpose.</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.figure</span> <span class="k">as</span> <span class="nn">figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.axes</span> <span class="kn">import</span> <span class="n">Axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.dates</span> <span class="kn">import</span> <span class="n">date2num</span><span class="p">,</span> <span class="n">DateFormatter</span><span class="p">,</span> <span class="n">MinuteLocator</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.displays.pointing</span> <span class="k">as</span> <span class="nn">pointing</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.singledish</span> <span class="kn">import</span> <span class="n">MSReductionGroupDesc</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.renderer.logger</span> <span class="kn">import</span> <span class="n">Plot</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="kn">import</span> <span class="n">absolute_path</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">mjd_to_datetime</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">DPISummary</span> <span class="o">=</span> <span class="mi">90</span>
<span class="c1"># DPIDetail = 120</span>
<span class="c1"># DPIDetail = 130</span>
<span class="n">DPIDetail</span> <span class="o">=</span> <span class="mi">260</span>
<span class="n">LightSpeedQuantity</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">constants</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">LightSpeed</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">LightSpeedQuantity</span><span class="p">,</span> <span class="s1">&#39;km/s&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>  <span class="c1"># speed of light in km/s</span>

<span class="n">sd_polmap</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;XX&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;YY&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;YX&#39;</span><span class="p">}</span>

<span class="n">NoData</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>
<span class="n">NoDataThreshold</span> <span class="o">=</span> <span class="n">NoData</span> <span class="o">+</span> <span class="mf">10000.0</span>


<div class="viewcode-block" id="mjd_to_plotval">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.mjd_to_plotval">[docs]</a>
<span class="k">def</span> <span class="nf">mjd_to_plotval</span><span class="p">(</span><span class="n">mjd_list</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert list of MJD values to Matplotlib dates.</span>

<span class="sd">    Args:</span>
<span class="sd">        mjd_list: Sequence of MJD values in day.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: Sequence of Matplotlib dates.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">datetime_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">mjd_to_datetime</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mjd_list</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">date2num</span><span class="p">(</span><span class="n">datetime_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="is_invalid_axis_range">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.is_invalid_axis_range">[docs]</a>
<span class="k">def</span> <span class="nf">is_invalid_axis_range</span><span class="p">(</span><span class="n">xmin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">xmax</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ymax</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if given range is valid.</span>

<span class="sd">    Args:</span>
<span class="sd">        xmin: lower limit of the x-axis. Can be NaN or Inf.</span>
<span class="sd">        xmax: upper limit of the x-axis. Can be NaN or Inf.</span>
<span class="sd">        ymin: lower limit of the y-axis. Can be NaN or Inf.</span>
<span class="sd">        ymax: upper limit of the y-axis. Can be NaN or Inf.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Return False if any of xmin, xmax, ymin, ymax is NaN or Inf.</span>
<span class="sd">        Otherwise, True is returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis_ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_is_invalid</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="c1"># check if given value is Inf or NaN or masked</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="n">zero_range_x</span> <span class="o">=</span> <span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">zero_range_y</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="n">invalid_values</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_invalid</span><span class="p">,</span> <span class="n">axis_ranges</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">zero_range_x</span> <span class="ow">or</span> <span class="n">zero_range_y</span> <span class="ow">or</span> <span class="n">invalid_values</span></div>



<div class="viewcode-block" id="CustomDateFormatter">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.CustomDateFormatter">[docs]</a>
<span class="k">class</span> <span class="nc">CustomDateFormatter</span><span class="p">(</span><span class="n">DateFormatter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Customized date formatter.</span>

<span class="sd">    Default format of the label is same as DateFormtter.</span>
<span class="sd">    For the leftmost label as well as when date is changed,</span>
<span class="sd">    this formatter puts extra label &#39;%Y/%m/%d&#39; beneath the</span>
<span class="sd">    deafult one.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the label for tick value x at position pos.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: tick value</span>
<span class="sd">            pos: position. Defaults to 0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: tick label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fmt_saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="s1">&#39;%H:%M</span><span class="se">\n</span><span class="s1">%Y/%m/</span><span class="si">%d</span><span class="s1">&#39;</span>
        <span class="n">tick</span> <span class="o">=</span> <span class="n">DateFormatter</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt_saved</span>
        <span class="k">return</span> <span class="n">tick</span></div>



<div class="viewcode-block" id="utc_formatter">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.utc_formatter">[docs]</a>
<span class="k">def</span> <span class="nf">utc_formatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CustomDateFormatter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate CustomDateFormatter instance.</span>

<span class="sd">    Generate CustomDateFormatter instance with the format</span>
<span class="sd">    given by fmt.</span>

<span class="sd">    Args:</span>
<span class="sd">        fmt: Tick format. Defaults to &#39;%H:%M&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        CustomDateFormatter: formatter instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">CustomDateFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span></div>



<div class="viewcode-block" id="utc_locator">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.utc_locator">[docs]</a>
<span class="k">def</span> <span class="nf">utc_locator</span><span class="p">(</span><span class="n">start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">end_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MinuteLocator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate MinuteLocator instance.</span>

<span class="sd">    Generate MinuteLocator instance. If either start_time or end_time is None,</span>
<span class="sd">    default MinuteLocator instance is returned. Otherwise, tick interval is</span>
<span class="sd">    adjusted according to start_time and end_time.</span>

<span class="sd">    Args:</span>
<span class="sd">        start_time: Leftmost value of time sequence.</span>
<span class="sd">                    Can be minimum or maximum. Defaults to None.</span>
<span class="sd">        end_time: Rightmost value of time sequence.</span>
<span class="sd">                  Can be minimum or maximum. Defaults to None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        MinuteLocator: locator instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">end_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MinuteLocator</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1440.0</span>  <span class="c1"># day -&gt; minutes</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">tick_interval</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tick_interval</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dt</span> <span class="o">/</span> <span class="mi">10</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">tick_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">61</span><span class="p">)</span> <span class="k">if</span> <span class="mi">60</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">tick_interval</span> <span class="o">=</span> <span class="n">tick_candidates</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">tick_candidates</span> <span class="o">-</span> <span class="n">tick_interval</span><span class="p">))]</span>

        <span class="c1"># print tick_interval</span>
        <span class="k">return</span> <span class="n">MinuteLocator</span><span class="p">(</span><span class="n">byminute</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="n">tick_interval</span><span class="p">)))</span></div>



<div class="viewcode-block" id="SingleDishDisplayInputs">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SingleDishDisplayInputs">[docs]</a>
<span class="k">class</span> <span class="nc">SingleDishDisplayInputs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents inputs to Display classes.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
                 <span class="n">result</span><span class="p">:</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Results</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SingleDishDisplayInputs instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            context: Pipeline context.</span>
<span class="sd">            result: Pipeline task execution result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">isnro</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if given datasets are taken by NRO45m telescope.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: Data from two or more observatories are mixed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if data is from NRO45m, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">arrays</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;array name is not unique: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">arrays</span><span class="p">)))</span>

        <span class="k">return</span> <span class="s1">&#39;NRO&#39;</span> <span class="ow">in</span> <span class="n">arrays</span></div>



<div class="viewcode-block" id="SpectralImage">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SpectralImage">[docs]</a>
<span class="k">class</span> <span class="nc">SpectralImage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Representation of four-dimensional spectral image.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrun image data.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return boolean image mask.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">getchunk</span><span class="p">(</span><span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imagename</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SpectralImage instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            imagename: Name of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;imagename must be string&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">imagename</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;imagename must be a name of the image (CASA image or FITS).&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">imagename</span>
        <span class="c1"># read data to storage</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>
            <span class="n">coordsys</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_coordsys</span><span class="p">(</span><span class="n">coordsys</span><span class="p">)</span>
            <span class="n">coordsys</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="s1">&#39;q&#39;</span><span class="p">)[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">toworld</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">)[</span><span class="s1">&#39;quantity&#39;</span><span class="p">]</span>
            <span class="n">direction_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;*</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span><span class="p">]</span>
            <span class="n">ra_min</span> <span class="o">=</span> <span class="n">bottom</span><span class="p">[</span><span class="n">direction_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">ra_max</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="n">direction_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">qa</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">ra_min</span><span class="p">,</span> <span class="n">ra_max</span><span class="p">):</span>
                <span class="n">ra_min</span><span class="p">,</span> <span class="n">ra_max</span> <span class="o">=</span> <span class="n">ra_max</span><span class="p">,</span> <span class="n">ra_min</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">=</span> <span class="n">ra_min</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">=</span> <span class="n">ra_max</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">=</span> <span class="n">bottom</span><span class="p">[</span><span class="n">direction_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">=</span> <span class="n">top</span><span class="p">[</span><span class="n">direction_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_brightnessunit</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">()</span>
            <span class="n">beam</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_beamsize_in_deg</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">])),</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_coordsys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordsys</span><span class="p">:</span> <span class="n">casa_coordsys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load axes information of coordinate system.</span>

<span class="sd">        Args:</span>
<span class="sd">            coordsys: coordsys instance of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">coord_types</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">axiscoordinatetypes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_id_coord_types</span><span class="p">(</span><span class="n">coord_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">units</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">referencecode</span><span class="p">(</span><span class="s1">&#39;dir&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_frame</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">getconversiontype</span><span class="p">(</span><span class="s1">&#39;spectral&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coordsys</span><span class="o">.</span><span class="n">stokes</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">stokes</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rest_frequency</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">restfrequency</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refpixs</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">referencepixel</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refvals</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">referencevalue</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increments</span> <span class="o">=</span> <span class="n">coordsys</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_load_id_coord_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coord_types</span><span class="p">:</span> <span class="n">casa_coordsys</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load indices for coordinate axes.</span>

<span class="sd">        Args:</span>
<span class="sd">            coord_types: coordsys instance of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">id_direction</span> <span class="o">=</span> <span class="n">coord_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Direction&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span> <span class="o">=</span> <span class="p">[</span><span class="n">id_direction</span><span class="p">,</span> <span class="n">id_direction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_spectral</span> <span class="o">=</span> <span class="n">coord_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Spectral&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span> <span class="o">=</span> <span class="n">coord_types</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Stokes&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;id_direction=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;id_spectral=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_spectral</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;id_stokes=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nx</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of pixels for horizontal (longitude) axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ny</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of pixels for vertical (latitude) axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nchan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of pixels (channels) for spectral axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spectral</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">npol</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of pixels (polarizations or correlations) for Stokes axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_stokes</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">brightnessunit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return brightness unit of the image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brightnessunit</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">beam_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return beam diameter in degree.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_beamsize_in_deg</span>

<div class="viewcode-block" id="SpectralImage.to_velocity">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SpectralImage.to_velocity">[docs]</a>
    <span class="k">def</span> <span class="nf">to_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">frequency</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                    <span class="n">freq_unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert frequency or array of frequency to velocity.</span>

<span class="sd">        Args:</span>
<span class="sd">            frequency: Frequency value(s).</span>
<span class="sd">            freq_unit: Frequency Unit. Defaults to &#39;GHz&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[float, np.ndarray]: Velocity value(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_frequency</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">freq_unit</span><span class="p">:</span>
            <span class="n">vrf</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rest_frequency</span><span class="p">,</span> <span class="n">freq_unit</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vrf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rest_frequency</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">/</span> <span class="n">vrf</span><span class="p">))</span> <span class="o">*</span> <span class="n">LightSpeed</span></div>


<div class="viewcode-block" id="SpectralImage.spectral_axis">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SpectralImage.spectral_axis">[docs]</a>
    <span class="k">def</span> <span class="nf">spectral_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return conversion information for spectral axis.</span>

<span class="sd">        Three-tuple required for conversion between pixel and world spectral</span>
<span class="sd">        axis is returned. The tuple consists of reference pixel, reverence value,</span>
<span class="sd">        and increment for spectral axis.</span>

<span class="sd">        Args:</span>
<span class="sd">            unit: Frequency unit. Defaults to &#39;GHz&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, float, float]: (refpix, refval, increment) for spectral axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_spectral</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpectralImage.direction_axis">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SpectralImage.direction_axis">[docs]</a>
    <span class="k">def</span> <span class="nf">direction_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;deg&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return conversion information for direction axes.</span>

<span class="sd">        Three-tuple required for conversion between pixel and world direction</span>
<span class="sd">        axes is returned. The tuple consists of reference pixel, refrence value,</span>
<span class="sd">        and increment for direction axis. Direction index must be given to specify</span>
<span class="sd">        either longitude (0) or latitude (1) axis.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Index for direction axes.</span>
<span class="sd">            unit: Direction unit. Defaults to &#39;deg&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, float, float]: (refpix, refval, increment) for direction axis</span>
<span class="sd">                                        specified by idx.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id_direction</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return conversion information for specified image axis.</span>

<span class="sd">        Three-tuple required for conversion between pixel and world direction</span>
<span class="sd">        axes is returned. The tuple consists of reference pixel, refrence value,</span>
<span class="sd">        and increment for the axis specified by idx.</span>

<span class="sd">        Args:</span>
<span class="sd">            idx: Axis index.</span>
<span class="sd">            unit: Unit string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, float, float]: (refpix, refval, increment) for</span>
<span class="sd">                                        the axis specified by idx.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">refpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refpixs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">refval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refvals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">increments</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">_unit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_unit</span> <span class="o">!=</span> <span class="n">unit</span><span class="p">:</span>
            <span class="n">refval</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">refval</span><span class="p">,</span> <span class="n">_unit</span><span class="p">),</span> <span class="n">unit</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">increment</span><span class="p">,</span> <span class="n">_unit</span><span class="p">),</span> <span class="n">unit</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">refpix</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span></div>



<span class="n">ChannelSelection</span> <span class="o">=</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;ChannelSelection&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;LINE_ONLY&#39;</span><span class="p">,</span> <span class="s1">&#39;LINE_FREE&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="Moment">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.Moment">[docs]</a>
<span class="k">class</span> <span class="nc">Moment</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="n">INTEGRATED</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">MAXIMUM</span> <span class="o">=</span> <span class="mi">8</span></div>



<span class="n">MomentSpec</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MomentSpec&#39;</span><span class="p">,</span> <span class="s1">&#39;moments chans&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SDImageDisplayInputs">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs">[docs]</a>
<span class="k">class</span> <span class="nc">SDImageDisplayInputs</span><span class="p">(</span><span class="n">SingleDishDisplayInputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages input data for plotter classes for single dish images.&quot;&quot;&quot;</span>

    <span class="n">MomentMapList</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">MomentSpec</span><span class="p">(</span><span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="n">Moment</span><span class="o">.</span><span class="n">MAXIMUM</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">ChannelSelection</span><span class="o">.</span><span class="n">ALL</span><span class="p">),</span>
        <span class="n">MomentSpec</span><span class="p">(</span><span class="n">moments</span><span class="o">=</span><span class="p">[</span><span class="n">Moment</span><span class="o">.</span><span class="n">INTEGRATED</span><span class="p">,</span> <span class="n">Moment</span><span class="o">.</span><span class="n">MAXIMUM</span><span class="p">],</span> <span class="n">chans</span><span class="o">=</span><span class="n">ChannelSelection</span><span class="o">.</span><span class="n">LINE_FREE</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">context</span><span class="p">:</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span>
                 <span class="n">result</span><span class="p">:</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Results</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SDImageDisplayInputs instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            context: Pipeline context.</span>
<span class="sd">            result: Pipeline task execution result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SDImageDisplayInputs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">SpectralImage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imagename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of the single dish image.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">imagename</span>

<div class="viewcode-block" id="SDImageDisplayInputs.moment_imagename">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs.moment_imagename">[docs]</a>
    <span class="k">def</span> <span class="nf">moment_imagename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Moment</span><span class="p">],</span> <span class="n">Moment</span><span class="p">],</span> <span class="n">chans</span><span class="p">:</span> <span class="n">ChannelSelection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of the moment image.</span>

<span class="sd">        If number of moments is 1, moment image name will include moment</span>
<span class="sd">        type. On the other hand, moment image name will not contain</span>
<span class="sd">        moment type if multiple moment types are specified. That is</span>
<span class="sd">        because immoments treats given image name as a prefix when</span>
<span class="sd">        the task computes multiple moments at once.</span>

<span class="sd">        Args:</span>
<span class="sd">            moments: Type of moment or list of them</span>
<span class="sd">            chans: Channel selection spec</span>

<span class="sd">        Returns:</span>
<span class="sd">            Name of moment image name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">chans</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">moments</span><span class="p">,</span> <span class="n">Moment</span><span class="p">):</span>
            <span class="n">moments</span> <span class="o">=</span> <span class="p">[</span><span class="n">moments</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">moments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">moments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">name</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return spectral window (spw) id for the image.&quot;&quot;&quot;</span>
        <span class="n">spwlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">spwlist</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spwlist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spwlist</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of the MeasurementSet if available.</span>

<span class="sd">        If no MeasurementSet is associated with the result,</span>
<span class="sd">        None is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;vis&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of the antenna registered to the image.</span>

<span class="sd">        In single dish pipeline, per-antenna images are created</span>
<span class="sd">        first, and then combined them into one image. For the</span>
<span class="sd">        former case, antenna name is returned while the special</span>
<span class="sd">        string &quot;COMBINED&quot; is returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: Name of the antenna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">antenna</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reduction_group</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MSReductionGroupDesc</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return ReductionGroupDesc instance.</span>

<span class="sd">        Return ReductionGroupDesc instance corresponding to the reduction group</span>
<span class="sd">        associated to the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">group_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;reduction_group_id&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">ms_reduction_group</span><span class="p">[</span><span class="n">group_id</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">msid_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of indices for MeasurementSets.</span>

<span class="sd">        The list specifies the MeasurementSets that are used to</span>
<span class="sd">        generate the image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: index list for MeasurementSets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;file_index&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antennaid_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of antenna ids.</span>

<span class="sd">        Return list of antenna ids corresponding to antenna</span>
<span class="sd">        name returned by self.antenna. Order of the index is</span>
<span class="sd">        consistent with self.msid_list, i.e. antnenaid_list[0]</span>
<span class="sd">        corresponds to the antenna id for the MeasurementSet</span>
<span class="sd">        specified by msid_list[0]. For &#39;COMBINED&#39; antenna,</span>
<span class="sd">        indices for all the antennas are returned.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: List of antenna ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_antennas&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fieldid_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of field ids.</span>

<span class="sd">        Return list of field ids. Order of the index is</span>
<span class="sd">        consistent with self.msid_list, i.e. fieldid_list[0]</span>
<span class="sd">        corresponds to the field id for the MeasurementSet</span>
<span class="sd">        specified by msid_list[0].</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: List of field ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_fields&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spwid_list</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of spectral windo (spw) ids.</span>

<span class="sd">        Return list of spw ids. Order of the index is</span>
<span class="sd">        consistent with self.msid_list, i.e. spwid_list[0]</span>
<span class="sd">        corresponds to the spw id for the MeasurementSet</span>
<span class="sd">        specified by msid_list[0].</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[int]: List of spw ids.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;assoc_spws&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stage_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Processing stage id.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stage_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return weblog subdirectory name for the stage.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                            <span class="s1">&#39;stage</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_number</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of the target source.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sourcename</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contamination_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return file name of the contamination plot.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.contamination.png&#39;</span>

<div class="viewcode-block" id="SDImageDisplayInputs.valid_lines">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs.valid_lines">[docs]</a>
    <span class="k">def</span> <span class="nf">valid_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_freq_chan_reversed_image</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of chnnel ranges of valid spectral lines.&quot;&quot;&quot;</span>
        <span class="n">group_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction_group</span>
        <span class="n">ant_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennaid_list</span>
        <span class="n">spwid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spwid_list</span>
        <span class="n">msid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msid_list</span>
        <span class="n">fieldid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldid_list</span>

        <span class="n">line_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">msobj_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span>
        <span class="n">msname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">absolute_path</span><span class="p">(</span><span class="n">msobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">msobj</span> <span class="ow">in</span> <span class="n">msobj_list</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">group_desc</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">msid</span><span class="p">,</span> <span class="n">ant</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">msid_list</span><span class="p">,</span> <span class="n">ant_index</span><span class="p">,</span> <span class="n">fieldid_list</span><span class="p">,</span> <span class="n">spwid_list</span><span class="p">):</span>
                <span class="n">group_msid</span> <span class="o">=</span> <span class="n">msname_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">group_msid</span> <span class="o">==</span> <span class="n">msid</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">antenna_id</span> <span class="o">==</span> <span class="n">ant</span> <span class="ow">and</span> \
                   <span class="n">g</span><span class="o">.</span><span class="n">field_id</span> <span class="o">==</span> <span class="n">fid</span> <span class="ow">and</span> <span class="n">g</span><span class="o">.</span><span class="n">spw_id</span> <span class="o">==</span> <span class="n">spw</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">channelmap_range</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ll</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line_list</span> <span class="ow">and</span> <span class="n">ll</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">line_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ll</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_freq_chan_reversed_image</span><span class="p">:</span>
            <span class="n">_right_edge</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nchan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">line_list</span><span class="p">:</span>
                <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_right_edge</span> <span class="o">-</span> <span class="n">ll</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">line_list</span></div>


<div class="viewcode-block" id="SDImageDisplayInputs.create_channel_mask">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs.create_channel_mask">[docs]</a>
    <span class="k">def</span> <span class="nf">create_channel_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_selection</span><span class="p">:</span> <span class="n">ChannelSelection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate channel mask for immoments according to channel selection enum.</span>

<span class="sd">        Args:</span>
<span class="sd">            channel_selection: Channel selection enum.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Channel selection string.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">channel_selection</span> <span class="o">==</span> <span class="n">ChannelSelection</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span>
            <span class="c1"># use all channels</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># convert line list into (start, end) list</span>
        <span class="n">range_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_lines</span><span class="p">():</span>
            <span class="n">line_center</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">line_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">line_center</span> <span class="o">-</span> <span class="n">line_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">line_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">line_width</span><span class="p">))</span>
            <span class="n">range_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">line_start</span><span class="p">,</span> <span class="n">line_end</span><span class="p">))</span>

        <span class="c1"># invert range if line-free channels are requested</span>
        <span class="k">if</span> <span class="n">channel_selection</span> <span class="o">==</span> <span class="n">ChannelSelection</span><span class="o">.</span><span class="n">LINE_FREE</span><span class="p">:</span>
            <span class="n">range_list</span> <span class="o">=</span> <span class="n">invert_range_list</span><span class="p">(</span><span class="n">range_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nchan</span><span class="p">)</span>

        <span class="c1"># convert line list into channel selection string</span>
        <span class="c1"># range_list is inclusive at the start while exclusive</span>
        <span class="c1"># at the end, i.e., [start, end)</span>
        <span class="c1"># On the other hand, CASA&#39;s channel selection is inclusive</span>
        <span class="c1"># at both ends, i.e., [start, end]</span>
        <span class="k">return</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">~</span><span class="si">{</span><span class="n">e</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">range_list</span><span class="p">])</span></div>


<div class="viewcode-block" id="SDImageDisplayInputs.get_line_free_channels">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs.get_line_free_channels">[docs]</a>
    <span class="k">def</span> <span class="nf">get_line_free_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get list of line-free channels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Indices of line-free channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># per-channel mask to diffentiate line/line-free regions</span>
        <span class="c1"># line regions: False</span>
        <span class="c1"># line-free regions: True</span>
        <span class="n">is_line_free</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nchan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># invalidate line regions</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_lines</span><span class="p">():</span>
            <span class="n">line_center</span><span class="p">,</span> <span class="n">line_width</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">line_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">line_center</span> <span class="o">-</span> <span class="n">line_width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">line_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">line_start</span> <span class="o">+</span> <span class="n">line_width</span><span class="p">))</span>
            <span class="n">is_line_free</span><span class="p">[</span><span class="n">line_start</span><span class="p">:</span><span class="n">line_end</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_line_free</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="SDImageDisplayInputs.compute_per_channel_stats">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplayInputs.compute_per_channel_stats">[docs]</a>
    <span class="k">def</span> <span class="nf">compute_per_channel_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute per-channel statistics of cube image.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Statistics dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spectral_axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_spectral</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">image_shape</span><span class="p">)))</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">spectral_axis</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ia</span><span class="p">:</span>
            <span class="c1"># cf. hif/tasks/tclean/tclean.py cube_stats_masked</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">ia</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span>
                <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stretch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span></div>
</div>



<div class="viewcode-block" id="invert_range_list">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.invert_range_list">[docs]</a>
<span class="k">def</span> <span class="nf">invert_range_list</span><span class="p">(</span><span class="n">range_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">nchan</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invert channel range list.</span>

<span class="sd">    Overlap among ranges is handled properly.</span>

<span class="sd">    Args:</span>
<span class="sd">        range_list: List of (start, end) ranges.</span>
<span class="sd">        nchan: Length of target array.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Inverted list of ranges.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># merge range</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">range_list</span><span class="p">:</span>
        <span class="c1"># range_list is inclusive at the beginning while exclusive</span>
        <span class="c1"># at the end, i.e., [start, end)</span>
        <span class="n">arr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># detect change of value</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">!=</span> <span class="n">arr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>

    <span class="n">inverted</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">inverted</span></div>



<div class="viewcode-block" id="SDCalibrationDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDCalibrationDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDCalibrationDisplay</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base plotter class for single-dish calibration tasks.&quot;&quot;&quot;</span>

    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">SingleDishDisplayInputs</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">SingleDishDisplayInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SDCalibrationDisplay instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: Inputs instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>

<div class="viewcode-block" id="SDCalibrationDisplay.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDCalibrationDisplay.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Plot</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate plots according to the provided results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Plot]: List of Plot instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span>
        <span class="n">report_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span>
        <span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;stage</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">stage_number</span><span class="p">))</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">outcome</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plot</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doplot</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">stage_dir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plots</span></div>


<div class="viewcode-block" id="SDCalibrationDisplay.doplot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDCalibrationDisplay.doplot">[docs]</a>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">doplot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Results</span><span class="p">,</span> <span class="n">stage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate plot from the result instance.</span>

<span class="sd">        This method must be implemented in the subclasses.</span>
<span class="sd">        The result should be single Results instance rather than ResultsList.</span>

<span class="sd">        Args:</span>
<span class="sd">            result: Pipeline task execution result.</span>
<span class="sd">            stage_dir: Name of pipeline weblog subdirectory.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: This method is not implemented in the base class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="SDImageDisplay">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplay">[docs]</a>
<span class="k">class</span> <span class="nc">SDImageDisplay</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="n">metaclass</span><span class="o">=</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base plotter class for imaging tasks.&quot;&quot;&quot;</span>

    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">SDImageDisplayInputs</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">SDImageDisplayInputs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SDImageDisplay instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            inputs: Inputs instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>

        <span class="c1"># Figure instance for plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

<div class="viewcode-block" id="SDImageDisplay.init">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDImageDisplay.init">[docs]</a>
    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize plotter using specifiec image.&quot;&quot;&quot;</span>
        <span class="c1"># self.image = SpectralImage(self.imagename)</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nchan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">nx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ny</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">npol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">brightnessunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">direction_reference</span>
        <span class="p">(</span><span class="n">refpix</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">spectral_axis</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">refval</span> <span class="o">+</span> <span class="n">increment</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">refpix</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nchan</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">to_velocity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">freq_unit</span><span class="o">=</span><span class="s1">&#39;GHz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">frequency_frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_min</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">ra_max</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dec_min</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">dec_max</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stokes_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">stokes_string</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;(ra_min,ra_max)=(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra_max</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;(dec_min,dec_max)=(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">beam_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beam_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_size</span> <span class="o">/</span> <span class="mf">3.0</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;beam_radius=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beam_radius</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;grid_size=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

        <span class="c1"># 2008/9/20 Dec Effect has been taken into account</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aspect</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec_max</span><span class="p">)</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="mf">3.141592653</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">launcher</span><span class="o">.</span><span class="n">Context</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Pipeline context.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stage_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return weblog subdirectory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">stage_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpectralImage</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return SpectralImage instance.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return spw id.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return antenna name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">antenna</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return MS name.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return image data as numpy float array.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">data</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return image mask as numpy bool array.</span>

<span class="sd">        Mask is True for valid pixels while False for invalid pixels.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[np.ndarray]: Image mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">mask</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id_spectral</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return axis index for spectral axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_spectral</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id_stokes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return axis index for Stokes or polarization axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">id_stokes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_valid_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return Number of valid spectral data accumulated to each position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reshape2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;validsp&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return rms for each position.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__reshape2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;rms&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">edge</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return edge channels to exclude.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">outcome</span><span class="p">[</span><span class="s1">&#39;edge&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__reshape2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array2d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reshape input two-dimensional array into three-dimensional array.</span>

<span class="sd">        Returned array should have the shape (nx, ny, npol) where nx is</span>
<span class="sd">        number of pixels along horizontal direction (longitude) axis,</span>
<span class="sd">        ny is number of pixels along vertical direction (latitude) axis,</span>
<span class="sd">        and npol is number of polarizations or correlations.</span>

<span class="sd">        Args:</span>
<span class="sd">            array2d: Two-dimensional array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: Resheped array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">array3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array2d</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">array2d</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">:</span>
            <span class="n">each_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">array2d</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">each_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="c1"># no valid data in the pixel</span>
                <span class="n">array3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array2d</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">each_len</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
                <span class="c1"># all polarizations has valid data in each pixel</span>
                <span class="n">array3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array2d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">each_len</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">):</span>
                <span class="c1"># probably one of the polarization components has no valid data</span>
                <span class="n">invalid_pols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">each_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_array2d</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">invalid_pols</span><span class="p">:</span>
                        <span class="n">_array2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ny</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">array2d</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_array2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array2d</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">array3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_array2d</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">npol</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nx</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">array3d</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span></div>



<span class="c1">#</span>
<span class="c1"># sparse profile map</span>
<div class="viewcode-block" id="form3">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.form3">[docs]</a>
<span class="k">def</span> <span class="nf">form3</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a factor for calculation of panel position.</span>

<span class="sd">    For given integer, form4 provide a factor for the</span>
<span class="sd">    calculation of vertical panel position for sparse</span>
<span class="sd">    profile map.</span>

<span class="sd">    Args:</span>
<span class="sd">        n: Number of panels along vertical axis.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Factor for panel position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">5</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">7</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">8</span></div>



<div class="viewcode-block" id="form4">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.form4">[docs]</a>
<span class="k">def</span> <span class="nf">form4</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a factor for calculation of panel position.</span>

<span class="sd">    For given integer, form4 provide a factor for the</span>
<span class="sd">    calculation of vertical panel position for sparse</span>
<span class="sd">    profile map.</span>

<span class="sd">    Args:</span>
<span class="sd">        n: Number of panels along vertical axis.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Factor for panel position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">4</span>
    <span class="k">elif</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">5.5</span></div>



<div class="viewcode-block" id="SparseMapAxesManager">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SparseMapAxesManager">[docs]</a>
<span class="k">class</span> <span class="nc">SparseMapAxesManager</span><span class="p">(</span><span class="n">pointing</span><span class="o">.</span><span class="n">MapAxesManagerBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates and manages Axes instances for sparse profile map.</span>

<span class="sd">    Sparse profile map consists of the following Axes:</span>

<span class="sd">        - Integrated spectrum</span>
<span class="sd">        - Atmospheric transmission (overlays integrated spectrum)</span>
<span class="sd">        - Channel axis (optional, overlays integrated spectrum)</span>
<span class="sd">        - Sparse profile map</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">nh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">ticksize</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">clearpanel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SparseMapAxesManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: matplotlib.figure.Figure instance</span>
<span class="sd">            nh: Number of panels along vertical axis.</span>
<span class="sd">            nv: Number of panels along horizontal axis.</span>
<span class="sd">            brightnessunit: Brightness unit.</span>
<span class="sd">            ticksize: Size of tick label.</span>
<span class="sd">            clearpanel: Clear existing Axes. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SparseMapAxesManager</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figure</span> <span class="o">=</span> <span class="n">fig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">=</span> <span class="n">nh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">=</span> <span class="n">nv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">=</span> <span class="n">ticksize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span> <span class="o">=</span> <span class="n">brightnessunit</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">_f</span> <span class="o">=</span> <span class="n">form4</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gs_top</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">left</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span>
                                        <span class="n">bottom</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">_f</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">0.96</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gs_bottom</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span>
                                           <span class="n">bottom</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">_f</span> <span class="o">-</span> <span class="mf">0.07</span><span class="p">)</span>
<span class="c1">#         self.gs_top = gridspec.GridSpec(1, 1,</span>
<span class="c1">#                                         bottom=1.0 - 1.0/form3(self.nv), top=0.96)</span>
<span class="c1">#         self.gs_bottom = gridspec.GridSpec(self.nv+1, self.nh+1,</span>
<span class="c1">#                                            hspace=0, wspace=0,</span>
<span class="c1">#                                            left=0, right=0.95,</span>
<span class="c1">#                                            bottom=0.01, top=1.0 - 1.0/form3(self.nv)-0.07)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_integsp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for integrated spectrum.</span>

<span class="sd">        Creates and returns Axes instance for integrated or averaged</span>
<span class="sd">        spectrum, which is located at the top of the figure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes: Axes instance for integrated spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_top</span><span class="p">[:,</span> <span class="p">:])</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency(GHz)&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Intensity(</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brightnessunit</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">xlabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">ylabels</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_yticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ylabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Spatially Averaged Spectrum&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span> <span class="o">=</span> <span class="n">axes</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_spmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instances for profile map.</span>

<span class="sd">        Creates and returns list of Axes instances that constitutes</span>
<span class="sd">        sparse profile map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List[Axes]: List of Axes instances for profile map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__axes_spmap</span><span class="p">())</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_atm</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for Atmospheric transmission profile.</span>

<span class="sd">        Creates and returns Axes instance for Atmospheric transmission</span>
<span class="sd">        profile that is calculated by Atmopheric Transmission at</span>
<span class="sd">        Microwaves (ATM) model. The Axes overlays integrated spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes: Axes instance for ATM transmission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_integsp</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_integsp</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;ATM Transmission&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="n">ylabel</span><span class="o">.</span><span class="n">set_color</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_n_ticks</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span>
                <span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">%&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">axes_chan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Axes</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instance for channel axis.</span>

<span class="sd">        Creates and returns Axes instance for channel axis on</span>
<span class="sd">        integrated spectrum.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Axes: Axes for channel axis.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__adjust_integsp_for_chan</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_integsp</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_integsp</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="o">.</span><span class="n">set_position</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">axes_integsp</span><span class="o">.</span><span class="n">get_position</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_coords</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.11</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">xlabels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">xlabels</span><span class="p">:</span>
                <span class="n">label</span><span class="o">.</span><span class="n">set_fontsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span>

    <span class="k">def</span> <span class="nf">__adjust_integsp_for_chan</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjust size of Axes for integrated spectrum for channel axis.</span>

<span class="sd">        Adjust size of Axes for integrated spectrum to locate channel axis</span>
<span class="sd">        at the top of the panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">get_points</span><span class="p">()</span>
        <span class="n">blc</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">trc</span> <span class="o">=</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># gives [left, bottom, width, height]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">blc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bottom</span> <span class="o">=</span> <span class="n">blc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">trc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">blc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">trc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">blc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.03</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">))</span>
        <span class="n">a</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_position</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__axes_spmap</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">Axes</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create Axes instances for sparse profile map.</span>

<span class="sd">        Yields:</span>
<span class="sd">            Generator[Axes, None, None]:</span>
<span class="sd">                Axes instances corresponding to individual profile.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">):</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_bottom</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">-</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">-</span> <span class="n">x</span><span class="p">])</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">NullLocator</span><span class="p">())</span>

                <span class="k">yield</span> <span class="n">axes</span>

<div class="viewcode-block" id="SparseMapAxesManager.setup_labels">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SparseMapAxesManager.setup_labels">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">label_ra</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                     <span class="n">label_dec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up position labels for sparse profile map.</span>

<span class="sd">        Set up position (longitude and latitude) labels for sparse</span>
<span class="sd">        profile map according to label_ra and label_dec, which are</span>
<span class="sd">        the arrays with shape of (nh, 2) and (nv, 2) that hold</span>
<span class="sd">        minimum and maximum positions for each panel, where nh and nv</span>
<span class="sd">        are number of panels along horizontal and vertical axes.</span>
<span class="sd">        Label value is the mean of minimum and maximum values of</span>
<span class="sd">        positions and is converted to position string (HMS or DMS</span>
<span class="sd">        format).</span>

<span class="sd">        Args:</span>
<span class="sd">            label_ra: min/max horizontal positions for each panel.</span>
<span class="sd">            label_dec: min/max vertical positions for each panel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction_reference</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;GALACTIC&#39;</span><span class="p">:</span>
            <span class="n">xaxislabel</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">DDMMSSs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xaxislabel</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">HHMMSSss</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">):</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_bottom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">-</span> <span class="n">x</span><span class="p">])</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">xaxislabel</span><span class="p">((</span><span class="n">label_ra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">label_ra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">xaxislabel</span><span class="p">((</span><span class="n">label_ra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">label_ra</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">):</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_bottom</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span> <span class="o">-</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">a1</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">pointing</span><span class="o">.</span><span class="n">DDMMSSs</span><span class="p">((</span><span class="n">label_dec</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">label_dec</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span>
                        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">a1</span><span class="o">.</span><span class="n">texts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="n">pointing</span><span class="o">.</span><span class="n">DDMMSSs</span><span class="p">((</span><span class="n">label_dec</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">label_dec</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs_bottom</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
        <span class="n">ralabel</span><span class="p">,</span> <span class="n">declabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_labels</span><span class="p">()</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">declabel</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">a1</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">ralabel</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span></div>


<div class="viewcode-block" id="SparseMapAxesManager.clear_plot_objects">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SparseMapAxesManager.clear_plot_objects">[docs]</a>
    <span class="k">def</span> <span class="nf">clear_plot_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove all plot objects from Axes.</span>

<span class="sd">        Remove all plot objects, which includes lines, patches, and texts,</span>
<span class="sd">        from the Axes objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_axes_integsp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_atm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_chan</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">all_axes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_axes_spmap</span><span class="p">)</span>
        <span class="n">active_axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_axes</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;There are </span><span class="si">%s</span><span class="s1"> active axes objects&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_axes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">active_axes</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Axes: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Lines: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">lines</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Patches: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">patches</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Texts: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">texts</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lines</span><span class="p">[:],</span> <span class="n">a</span><span class="o">.</span><span class="n">patches</span><span class="p">[:],</span> <span class="n">a</span><span class="o">.</span><span class="n">texts</span><span class="p">[:],</span> <span class="n">a</span><span class="o">.</span><span class="n">images</span><span class="p">[:]):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Removing </span><span class="si">%s</span><span class="s1">...&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="SDSparseMapPlotter">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter">[docs]</a>
<span class="k">class</span> <span class="nc">SDSparseMapPlotter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plotter for sparse spectral map.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">nh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nv</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">clearpanel</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct SDSparseMapPlotter instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            fig: matplotlib.figure.Figure instance</span>
<span class="sd">            nh: Number of panels along vertical axis.</span>
<span class="sd">            nv: Number of panels along horizontal axis.</span>
<span class="sd">            brightnessunit: Brightness unit.</span>
<span class="sd">            clearpanel: Clear existing Axes. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">nv</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span> <span class="o">//</span> <span class="p">(</span><span class="n">step</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ticksize</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nh</span><span class="p">,</span> <span class="n">nv</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">ticksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ticksize</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="n">DPIDetail</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="n">SparseMapAxesManager</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">nh</span><span class="p">,</span> <span class="n">nv</span><span class="p">,</span> <span class="n">brightnessunit</span><span class="p">,</span> <span class="n">ticksize</span><span class="p">,</span> <span class="n">clearpanel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_averaged</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_scaling</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviation_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atm_frequency</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of panels along horizontal axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">nh</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nv</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return number of panels along vertical axis.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">nv</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ticksize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return tick label size.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">ticksize</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">direction_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return direction reference string.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">direction_reference</span>

    <span class="nd">@direction_reference</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">direction_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set direction reference string.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="SDSparseMapPlotter.setup_labels_relative">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.setup_labels_relative">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_labels_relative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">refpix_list</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                              <span class="n">refval_list</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                              <span class="n">increment_list</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up position labels.</span>

<span class="sd">        Set up position labels for both horizontal and vertical axes</span>
<span class="sd">        according to reference pixels (refpix_list), reference values</span>
<span class="sd">        (refval_list), and increments (increment_list), which should</span>
<span class="sd">        be given as two-tuples or lists with at least two elements.</span>

<span class="sd">        Args:</span>
<span class="sd">            refpix_list: reference pixels.</span>
<span class="sd">            refval_list: reference values.</span>
<span class="sd">            increment_list: increments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LabelRA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="n">NoData</span>
        <span class="n">LabelDEC</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="n">NoData</span>
        <span class="n">refpix</span> <span class="o">=</span> <span class="n">refpix_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">refval</span> <span class="o">=</span> <span class="n">refval_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">increment_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;axis 0: refpix,refval,increment=</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">refpix</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">LabelRA</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">refval</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">refpix</span><span class="p">)</span> <span class="o">*</span> <span class="n">increment</span>
            <span class="n">LabelRA</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">refval</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">refpix</span><span class="p">)</span> <span class="o">*</span> <span class="n">increment</span>
        <span class="n">refpix</span> <span class="o">=</span> <span class="n">refpix_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">refval</span> <span class="o">=</span> <span class="n">refval_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">increment_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;axis 1: refpix,refval,increment=</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">refpix</span><span class="p">,</span> <span class="n">refval</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">):</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">LabelDEC</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">refval</span> <span class="o">+</span> <span class="p">(</span><span class="n">y0</span> <span class="o">-</span> <span class="n">refpix</span><span class="p">)</span> <span class="o">*</span> <span class="n">increment</span>
            <span class="n">LabelDEC</span><span class="p">[</span><span class="n">y</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">refval</span> <span class="o">+</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">refpix</span><span class="p">)</span> <span class="o">*</span> <span class="n">increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">setup_labels</span><span class="p">(</span><span class="n">LabelRA</span><span class="p">,</span> <span class="n">LabelDEC</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.setup_labels_absolute">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.setup_labels_absolute">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_labels_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ralist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">declist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set up position labels.</span>

<span class="sd">        Set up position labels for both horizontal and vertical axes</span>
<span class="sd">        according to the list of positions along horizontal (ralist)</span>
<span class="sd">        and vertical (declist) axes.</span>

<span class="sd">        Args:</span>
<span class="sd">            ralist: List of horizontal position.</span>
<span class="sd">            declist: List of vertical positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span> <span class="o">==</span> <span class="mi">1</span>  <span class="c1"># this function is used only for step=1</span>
        <span class="n">LabelRA</span> <span class="o">=</span> <span class="p">[[</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ralist</span><span class="p">]</span>
        <span class="n">LabelDEC</span> <span class="o">=</span> <span class="p">[[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">declist</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">setup_labels</span><span class="p">(</span><span class="n">LabelRA</span><span class="p">,</span> <span class="n">LabelDEC</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.setup_lines">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.setup_lines">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">lines_averaged</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                    <span class="n">lines_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set detected lines.</span>

<span class="sd">        Provided lines are displayed as shaded area. Lines given to</span>
<span class="sd">        lines_averaged are displayed in the Axes for integrated</span>
<span class="sd">        spectrum. Lines given to lines_map are interpreted as lines</span>
<span class="sd">        for each panel of sparse profile map.</span>

<span class="sd">        Args:</span>
<span class="sd">            lines_averaged: Lines for integrated spectrum.</span>
<span class="sd">            lines_map: Lines for sparse profile map. Defaults to None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_averaged</span> <span class="o">=</span> <span class="n">lines_averaged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_map</span> <span class="o">=</span> <span class="n">lines_map</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.setup_reference_level">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.setup_reference_level">[docs]</a>
    <span class="k">def</span> <span class="nf">setup_reference_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set reference level of the sparse profile map.</span>

<span class="sd">        If float value is given, red horizontal line at the value is</span>
<span class="sd">        displayed to each panel. If None is given, no line is diaplayed.</span>

<span class="sd">        Args:</span>
<span class="sd">            level: Reference level. Defaults to 0.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span> <span class="o">=</span> <span class="n">level</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.set_global_scaling">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.set_global_scaling">[docs]</a>
    <span class="k">def</span> <span class="nf">set_global_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable global scaling.</span>

<span class="sd">        Enable global scanling. Applies the same y-axis</span>
<span class="sd">        range to all panels in sparse profile map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_scaling</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.unset_global_scaling">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.unset_global_scaling">[docs]</a>
    <span class="k">def</span> <span class="nf">unset_global_scaling</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable global scaling.</span>

<span class="sd">        Disable global scaling. Y-axis ranges of panels</span>
<span class="sd">        in sparse profile map are adjusted individually.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_scaling</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.set_deviation_mask">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.set_deviation_mask">[docs]</a>
    <span class="k">def</span> <span class="nf">set_deviation_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set deviation mask.</span>

<span class="sd">        Deviation mask ranges are displayed as red bar at</span>
<span class="sd">        the top of integrated spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviation_mask</span> <span class="o">=</span> <span class="n">mask</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.set_edge">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.set_edge">[docs]</a>
    <span class="k">def</span> <span class="nf">set_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set edge parameter.</span>

<span class="sd">        Edge region specified by edge parameter is shaded with grey.</span>

<span class="sd">        Args:</span>
<span class="sd">            edge: Edge area to be shaded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.set_atm_transmission">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.set_atm_transmission">[docs]</a>
    <span class="k">def</span> <span class="nf">set_atm_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transmission</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set atmospheric transmission data.</span>

<span class="sd">        If trasnmission and frequency are given properly, atmospheric</span>
<span class="sd">        transmission is overlaid to integrated spectrum as magenta line.</span>
<span class="sd">        Number of elements for transmission and frequency must be the same.</span>

<span class="sd">        Args:</span>
<span class="sd">            transmission: Atmospheric transmission.</span>
<span class="sd">            frequency: Frequency label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span> <span class="o">=</span> <span class="p">[</span><span class="n">transmission</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atm_frequency</span> <span class="o">=</span> <span class="p">[</span><span class="n">frequency</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transmission</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atm_frequency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.unset_atm_transmission">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.unset_atm_transmission">[docs]</a>
    <span class="k">def</span> <span class="nf">unset_atm_transmission</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable displaying atmospheric transmission.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atm_frequency</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.set_channel_axis">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.set_channel_axis">[docs]</a>
    <span class="k">def</span> <span class="nf">set_channel_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable channel axis for integrated spectrum.</span>

<span class="sd">        Channel axis is displayed in the upper side of the Axes</span>
<span class="sd">        for integrated spectrum.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.unset_channel_axis">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.unset_channel_axis">[docs]</a>
    <span class="k">def</span> <span class="nf">unset_channel_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disable channel axis for integrated spectrum.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span> <span class="o">=</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.add_channel_axis">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.add_channel_axis">[docs]</a>
    <span class="k">def</span> <span class="nf">add_channel_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add channel axis to integrated spectrum.</span>

<span class="sd">        Args:</span>
<span class="sd">            frequency: Frequency label.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">axes_chan</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">f</span><span class="p">)))</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.plot">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.plot">[docs]</a>
    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">map_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">],</span>
             <span class="n">averaged_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">],</span>
             <span class="n">frequency</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">figfile</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate sparse profile map.</span>

<span class="sd">        Generates sparse profile map. If fit_result is given, it is</span>
<span class="sd">        indicated as red lines in sparse profile map. If figfile is</span>
<span class="sd">        provided, the plot is exported to the file.</span>

<span class="sd">        Args:</span>
<span class="sd">            map_data: Data for sparse profile map.</span>
<span class="sd">            averaged_data: Data for integrated spectrum.</span>
<span class="sd">            frequency: Frequency label.</span>
<span class="sd">            fit_result: Data for fit result. Defaults to None.</span>
<span class="sd">            figfile: Name of the plot file. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: Whether or not if plot is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">figfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skip creating sparse profile map&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">overlay_atm_transmission</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;overlay_atm_transmission = </span><span class="si">{</span><span class="n">overlay_atm_transmission</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">spmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">averaged_data</span><span class="p">)</span>
        <span class="n">spmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">averaged_data</span><span class="p">)</span>
        <span class="n">dsp</span> <span class="o">=</span> <span class="n">spmax</span> <span class="o">-</span> <span class="n">spmin</span>
        <span class="n">spmin</span> <span class="o">-=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="k">if</span> <span class="n">overlay_atm_transmission</span><span class="p">:</span>
            <span class="n">spmax</span> <span class="o">+=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.4</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spmax</span> <span class="o">+=</span> <span class="n">dsp</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;spmin=</span><span class="si">%s</span><span class="s1">, spmax=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spmin</span><span class="p">,</span> <span class="n">spmax</span><span class="p">)</span>

        <span class="n">global_xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">global_xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># NOTE: we assume channels are equally binned</span>
        <span class="n">channel_width</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">spw_width</span> <span class="o">=</span> <span class="n">channel_width</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">global_xmin</span> <span class="o">-=</span> <span class="n">spw_width</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="n">global_xmax</span> <span class="o">+=</span> <span class="n">spw_width</span> <span class="o">*</span> <span class="mf">0.01</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;global_xmin=</span><span class="si">%s</span><span class="s1">, global_xmax=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">global_xmin</span><span class="p">,</span> <span class="n">global_xmax</span><span class="p">)</span>

        <span class="c1"># Auto scaling</span>
        <span class="c1"># to eliminate max/min value due to bad pixel or bad fitting,</span>
        <span class="c1">#  1/10-th value from max and min are used instead</span>
        <span class="n">valid_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">map_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">NoDataThreshold</span><span class="p">)</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">map_data</span><span class="p">[</span><span class="n">valid_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valid_index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;valid_data.shape=</span><span class="si">{shape}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">valid_data</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">valid_index</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">stat_per_spectra</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">oper</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spectra</span><span class="p">:</span>
                    <span class="n">unmasked</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">mask</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">oper</span><span class="p">(</span><span class="n">unmasked</span><span class="p">)</span>
            <span class="n">ListMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">stat_per_spectra</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">ListMin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">stat_per_spectra</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="c1">#             ListMax = np.fromiter((np.max(v.data[v.mask == False]) for v in valid_data),</span>
<span class="c1">#                                      dtype=np.float64)</span>
<span class="c1">#             ListMin = np.fromiter((np.min(v.data[v.mask == False]) for v in valid_data),</span>
<span class="c1">#                                      dtype=np.float64)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ListMax from masked_array=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ListMax</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ListMin from masked_array=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ListMin</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ListMax</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ListMin</span> <span class="o">=</span> <span class="n">valid_data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">valid_data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="c1"># if isinstance(ListMin, np.ma.masked_array):</span>
        <span class="c1">#     ListMin = ListMin.data[ListMin.mask == False]</span>
        <span class="c1"># if isinstance(ListMax, np.ma.masked_array):</span>
        <span class="c1">#     ListMax = ListMax.data[ListMax.mask == False]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ListMax=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ListMax</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ListMin=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ListMin</span><span class="p">))</span>
        <span class="n">global_ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">ListMax</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">global_ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)[</span><span class="nb">len</span><span class="p">(</span><span class="n">ListMin</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span><span class="p">]</span>
        <span class="n">global_ymax</span> <span class="o">=</span> <span class="n">global_ymax</span> <span class="o">+</span> <span class="p">(</span><span class="n">global_ymax</span> <span class="o">-</span> <span class="n">global_ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">global_ymin</span> <span class="o">=</span> <span class="n">global_ymin</span> <span class="o">-</span> <span class="p">(</span><span class="n">global_ymax</span> <span class="o">-</span> <span class="n">global_ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
        <span class="k">del</span> <span class="n">ListMax</span><span class="p">,</span> <span class="n">ListMin</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">axes_integsp</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">averaged_data</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_axis</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_channel_axis</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="p">(</span><span class="n">_xmin</span><span class="p">,</span> <span class="n">_xmax</span><span class="p">,</span> <span class="n">_ymin</span><span class="p">,</span> <span class="n">_ymax</span><span class="p">)</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">()</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;global_ymin=</span><span class="si">%s</span><span class="s1">, global_ymax=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">global_ymin</span><span class="p">,</span> <span class="n">global_ymax</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spmin=</span><span class="si">%s</span><span class="s1">, spmax=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spmin</span><span class="p">,</span> <span class="n">spmax</span><span class="p">)</span>

        <span class="c1"># do not create plots if any of specified axis ranges</span>
        <span class="c1"># are invalid</span>
        <span class="k">if</span> <span class="n">is_invalid_axis_range</span><span class="p">(</span><span class="n">global_xmin</span><span class="p">,</span> <span class="n">global_xmax</span><span class="p">,</span> <span class="n">spmin</span><span class="p">,</span> <span class="n">spmax</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Invalid axis range for averaged spectrum. Plot </span><span class="si">%s</span><span class="s1"> will not be created.&#39;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">figfile</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># PIPE-1140</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">global_xmin</span><span class="p">,</span> <span class="n">global_xmax</span><span class="p">,</span> <span class="n">spmin</span><span class="p">,</span> <span class="n">spmax</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Axis configuration for </span><span class="si">%s</span><span class="s1"> failed. Plot will not be created.&#39;</span><span class="p">,</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">figfile</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">fedge_span</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ch1, ch2: [</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">ch1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fedge_span</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ch1</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge_span</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fedge_span</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ch2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fedge_span</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ch2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span>
                    <span class="n">frequency</span>
                <span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge_span</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fedge_span</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_averaged</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_averaged</span><span class="p">:</span>
                <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">([</span><span class="n">chmin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">chmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;plotting line range for mean spectrum: [</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviation_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;plotting deviation mask </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviation_mask</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviation_mask</span><span class="p">:</span>
                <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">([</span><span class="n">chmin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">chmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">overlay_atm_transmission</span><span class="p">:</span>
            <span class="n">axes_atm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">axes_atm</span>
            <span class="n">amin</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">amax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">_t</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atm_transmission</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">atm_frequency</span><span class="p">):</span>
                <span class="c1"># fraction -&gt; percentage</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">_t</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">axes_atm</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
                <span class="n">amin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">amin</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">amax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">amax</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

            <span class="c1"># trick to make transmission curve is shown in the upper part</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="mi">60</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">amin</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">Y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">amax</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">amax</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>

            <span class="c1"># to make sure y-range is more than 2 (for MaxNLocator)</span>
            <span class="k">if</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ymin</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">ymin</span> <span class="o">-=</span> <span class="mi">2</span>
                <span class="k">elif</span> <span class="n">ymax</span> <span class="o">&lt;</span> <span class="mi">98</span><span class="p">:</span>
                    <span class="n">ymax</span> <span class="o">+=</span> <span class="mi">2</span>

            <span class="n">axes_atm</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">global_xmin</span><span class="p">,</span> <span class="n">global_xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>

        <span class="n">is_valid_fit_result</span> <span class="o">=</span> <span class="p">(</span><span class="n">fit_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">map_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_scaling</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">xmin</span> <span class="o">=</span> <span class="n">global_xmin</span>
                    <span class="n">xmax</span> <span class="o">=</span> <span class="n">global_xmax</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">global_ymin</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">global_ymax</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xmin</span> <span class="o">=</span> <span class="n">global_xmin</span>
                    <span class="n">xmax</span> <span class="o">=</span> <span class="n">global_xmax</span>
                    <span class="k">if</span> <span class="n">map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">NoDataThreshold</span><span class="p">:</span>
                        <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">])</span>
                        <span class="c1"># mad = np.median(map_data[x][y] - median)</span>
                        <span class="n">sigma</span> <span class="o">=</span> <span class="n">map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="n">median</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">sigma</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="n">median</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">sigma</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ymin</span> <span class="o">=</span> <span class="n">global_ymin</span>
                        <span class="n">ymax</span> <span class="o">=</span> <span class="n">global_ymax</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Per panel scaling turned on: ymin=</span><span class="si">%s</span><span class="s1">, ymax=</span><span class="si">%s</span><span class="s1"> (global ymin=</span><span class="si">%s</span><span class="s1">, ymax=</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span>
                              <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">global_ymin</span><span class="p">,</span> <span class="n">global_ymax</span><span class="p">)</span>
                <span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">axes_spmap</span><span class="p">[</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nh</span> <span class="o">-</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nv</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">NoDataThreshold</span><span class="p">:</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_map</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines_map</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]:</span>
                            <span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">([</span><span class="n">chmin</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">chmax</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">frequency</span><span class="p">)</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;plotting line range for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">: [</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">]&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span><span class="p">)</span>
                            <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fedge_span</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge_span</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fedge_span</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge_span</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fedge_span</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>

                    <span class="c1"># elif self.lines_averaged is not None:</span>
                    <span class="c1">#     for chmin, chmax in self.lines_averaged:</span>
                    <span class="c1">#         fmin = ch_to_freq(chmin, frequency)</span>
                    <span class="c1">#         fmax = ch_to_freq(chmax, frequency)</span>
                    <span class="c1">#         LOG.debug(&#39;plotting line range for %s, %s (reuse lines_averaged): [%s, %s]&#39;,</span>
                    <span class="c1">#                   x, y, chmin, chmax)</span>
                    <span class="c1">#        plot_helper.axvspan(fmin, fmax, color=&#39;cyan&#39;)</span>
                    <span class="k">if</span> <span class="n">is_valid_fit_result</span><span class="p">:</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">fit_result</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ymin</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span> <span class="o">&lt;</span> <span class="n">ymax</span><span class="p">:</span>
                        <span class="n">axes</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_level</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">xmax</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">ymax</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="s1">&#39;NO DATA&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                                     <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ticksize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;figfile=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">figfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">clear_plot_objects</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="SDSparseMapPlotter.done">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.SDSparseMapPlotter.done">[docs]</a>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up plot.&quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">figure</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">fig</span></div>
</div>



<div class="viewcode-block" id="ch_to_freq">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hsd.tasks.common.html#pipeline.hsd.tasks.baseline.display.ch_to_freq">[docs]</a>
<span class="k">def</span> <span class="nf">ch_to_freq</span><span class="p">(</span><span class="n">ch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert channel into frequency.</span>

<span class="sd">    Args:</span>
<span class="sd">        ch: Channel value, or list of channel values.</span>
<span class="sd">        frequency: Frequency labels.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Frequency value(s) corresponding to ch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)),</span>
        <span class="n">frequency</span><span class="p">,</span>
        <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
        <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolator</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>