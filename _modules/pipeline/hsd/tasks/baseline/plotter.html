

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hsd.tasks.baseline.plotter &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hsd.tasks.baseline.plotter</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hsd.tasks.baseline.plotter</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Plotter for baseline subtraction result.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Generator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">matplotlib.figure</span> <span class="k">as</span> <span class="nn">figure</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">numpy.ma.core</span> <span class="kn">import</span> <span class="n">MaskedArray</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.renderer.logger</span> <span class="k">as</span> <span class="nn">logger</span>
<span class="kn">from</span> <span class="nn">pipeline.h.tasks.common</span> <span class="kn">import</span> <span class="n">atmutil</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.displays.plotstyle</span> <span class="kn">import</span> <span class="n">casa5style_plot</span>
<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">compress</span>
<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">..common.display</span> <span class="kn">import</span> <span class="n">DPIDetail</span><span class="p">,</span> <span class="n">ch_to_freq</span><span class="p">,</span> <span class="n">sd_polmap</span>
<span class="kn">from</span> <span class="nn">..common</span> <span class="kn">import</span> <span class="n">direction_utils</span> <span class="k">as</span> <span class="n">dirutil</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pipeline.infrastructure.launcher</span> <span class="kn">import</span> <span class="n">Context</span>
    <span class="kn">from</span> <span class="nn">pipeline.domain.datatable</span> <span class="kn">import</span> <span class="n">DataTableImpl</span> <span class="k">as</span> <span class="n">DataTable</span>
    <span class="kn">from</span> <span class="nn">pipeline.domain.measurementset</span> <span class="kn">import</span> <span class="n">MeasurementSet</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># A named tuple to store statistics of baseline quality</span>
<span class="n">BinnedStat</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;BinnedStat&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bin_min_ratio bin_max_ratio bin_diff_ratio nbin nbin_factor valid&#39;</span>
<span class="p">)</span>
<span class="n">QualityStat</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;QualityStat&#39;</span><span class="p">,</span> <span class="s1">&#39;vis field spw ant pol stat&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="PlotterPool">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.PlotterPool.html#pipeline.hsd.tasks.baseline.plotter.PlotterPool">[docs]</a>
<span class="k">class</span> <span class="nc">PlotterPool</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pool class to hold resources for plotting.</span>

<span class="sd">    TODO: this class is not useful. Should be removed in future.</span>
<span class="sd">          create_plotter must be separated from the class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct PlotterPool instance.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="PlotterPool.create_plotter">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.PlotterPool.html#pipeline.hsd.tasks.baseline.plotter.PlotterPool.create_plotter">[docs]</a>
    <span class="k">def</span> <span class="nf">create_plotter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                       <span class="n">ralist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                       <span class="n">declist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                       <span class="n">direction_reference</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;Jy/beam&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">display</span><span class="o">.</span><span class="n">SDSparseMapPlotter</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create plotter instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            ralist: List of RA values for labeling</span>
<span class="sd">            declist: List of Dec values for labeling</span>
<span class="sd">            direction_reference: Directon reference string. Defaults to None.</span>
<span class="sd">            brightnessunit: Brightness unit string. Defaults to &#39;Jy/beam&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Plotter instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figure</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">SDSparseMapPlotter</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">nh</span><span class="o">=</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">nv</span><span class="o">=</span><span class="n">num_dec</span><span class="p">,</span>
                                             <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">brightnessunit</span><span class="o">=</span><span class="n">brightnessunit</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">direction_reference</span> <span class="o">=</span> <span class="n">direction_reference</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">setup_labels_absolute</span><span class="p">(</span><span class="n">ralist</span><span class="p">,</span> <span class="n">declist</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plotter</span></div>


<div class="viewcode-block" id="PlotterPool.done">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.PlotterPool.html#pipeline.hsd.tasks.baseline.plotter.PlotterPool.done">[docs]</a>
    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close plotters registered to the pool.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">plotter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="PlotDataStorage">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.PlotDataStorage.html#pipeline.hsd.tasks.baseline.plotter.PlotDataStorage">[docs]</a>
<span class="k">class</span> <span class="nc">PlotDataStorage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Storage class to hold array data for plotting.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct PlotDataStorage instance.</span>

<span class="sd">        This class holds three sets of data storage, one dimensional</span>
<span class="sd">        numpy array with a certain length, and the data array that refers</span>
<span class="sd">        whole or part of data storage. They are assigned to map data (float),</span>
<span class="sd">        associated mask (bool), and integrated data (float), respectively.</span>

<span class="sd">        Each data array is multi-dimensional array with (npol, nchan) for</span>
<span class="sd">        integrated data while (nh, nv, npol, nchan) for other arrays.</span>
<span class="sd">        Each data storage is one-dimensional array whose length should be</span>
<span class="sd">        larger than the total number of elements for associated data array.</span>

<span class="sd">        Intension is to minimize the number of memory allocation/de-allocation.</span>
<span class="sd">        To do that, data storage (memory for array) and data array (actual array</span>
<span class="sd">        accessed by the user) are separated so that allocated memory is reused</span>
<span class="sd">        if possible. Data storage is resized only when size of data storage is</span>
<span class="sd">        smaller than the size of data array which can vary upon request from</span>
<span class="sd">        the user.</span>

<span class="sd">        The constructor initializes data storage as zero-length array, which</span>
<span class="sd">        effectively means no memory allocation for the data array, and data</span>
<span class="sd">        array nominally refers to empty data storage. Actual memory allocation</span>
<span class="sd">        will be performed when the user first provides the array shape.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_mask_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">integrated_mask_storage</span>

<div class="viewcode-block" id="PlotDataStorage.resize_storage">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.PlotDataStorage.html#pipeline.hsd.tasks.baseline.plotter.PlotDataStorage.resize_storage">[docs]</a>
    <span class="k">def</span> <span class="nf">resize_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize storage.</span>

<span class="sd">        Resize storage array if necessary, i.e., only when current size is less than</span>
<span class="sd">        requested size calculated from input args. Data array refers storage but is</span>
<span class="sd">        reshaped to match the number of panels of sparse profile map.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            num_pol: Number of polarizations</span>
<span class="sd">            num_chan: Number of spectral channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_integrated</span> <span class="o">=</span> <span class="n">num_pol</span> <span class="o">*</span> <span class="n">num_chan</span>
        <span class="n">num_map</span> <span class="o">=</span> <span class="n">num_ra</span> <span class="o">*</span> <span class="n">num_dec</span> <span class="o">*</span> <span class="n">num_integrated</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span><span class="p">,</span> <span class="n">num_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_data_storage</span><span class="p">[:</span><span class="n">num_map</span><span class="p">],</span> <span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_map</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span><span class="p">,</span> <span class="n">num_map</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_mask_storage</span><span class="p">[:</span><span class="n">num_map</span><span class="p">],</span> <span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">num_integrated</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span><span class="p">,</span> <span class="n">num_integrated</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">integrated_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_data_storage</span><span class="p">[:</span><span class="n">num_integrated</span><span class="p">],</span> <span class="p">(</span><span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">))</span></div>
</div>



<div class="viewcode-block" id="BaselineSubtractionDataManager">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager">[docs]</a>
<span class="k">class</span> <span class="nc">BaselineSubtractionDataManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to produce data of baseline subtraction plot and quality statistics.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="s1">&#39;MeasurementSet&#39;</span><span class="p">,</span> <span class="n">blvis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">datatable</span><span class="p">:</span> <span class="s1">&#39;DataTable&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct BaselineSubtractionDataManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            ms: Domain object for the MS before baseline subtraction</span>
<span class="sd">            blvis: Name of the MS after baseline subtraction</span>
<span class="sd">            context: Pipeline context</span>
<span class="sd">            datatable: DataTable instance</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_data</span> <span class="o">=</span> <span class="n">blvis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatable</span> <span class="o">=</span> <span class="n">datatable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_storage</span> <span class="o">=</span> <span class="n">PlotDataStorage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_storage</span> <span class="o">=</span> <span class="n">PlotDataStorage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_integrated_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_map_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_integrated_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_map_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_averaged_data</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaselineSubtractionDataManager.resize_storage">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.resize_storage">[docs]</a>
    <span class="k">def</span> <span class="nf">resize_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resize storage as necessary.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            num_pol: Number of polarizations</span>
<span class="sd">            num_chan: Number of spectral channels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prefit_storage</span><span class="o">.</span><span class="n">resize_storage</span><span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_storage</span><span class="o">.</span><span class="n">resize_storage</span><span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaselineSubtractionDataManager.store_result_get_data">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.store_result_get_data">[docs]</a>
    <span class="k">def</span> <span class="nf">store_result_get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                              <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]],</span>
                              <span class="n">npol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">nchan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">out_rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                              <span class="n">in_rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
                                         <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
                                         <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">],</span>
                                         <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">],</span>
                                         <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            rowlist: List of datatable row ids per sparse map panel with metadata</span>
<span class="sd">            npol: Number of polarizations</span>
<span class="sd">            nchan: Number of spectral channels</span>
<span class="sd">            out_rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                        after baseline subtraction.</span>
<span class="sd">            in_rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                       before baseline subtraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple containing five masked arrays; postfit integrated spectrum data,</span>
<span class="sd">            postfit sparse map data, prefit integrated spectrum data, prefit sparse map</span>
<span class="sd">            data, and prefit averaged sparse map data.</span>
<span class="sd">            Each element of postfit or prefit integrated spectrum data: (npol, nchan).</span>
<span class="sd">            Each element of postfit, prefit sparse map data or prefit averaged sparse map</span>
<span class="sd">            data: (nx, ny, npol, nchan).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dtrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">)</span>

        <span class="c1"># get prefit data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_integrated_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefit_integrated_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_map_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_averaged_data</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefit_data</span><span class="p">,</span> <span class="n">dtrows</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">npol</span><span class="p">,</span>
                                <span class="n">rowlist</span><span class="p">,</span> <span class="n">rowmap</span><span class="o">=</span><span class="n">in_rowmap</span><span class="p">,</span>
                                <span class="n">integrated_data_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefit_storage</span><span class="o">.</span><span class="n">integrated_data</span><span class="p">,</span>
                                <span class="n">map_data_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefit_storage</span><span class="o">.</span><span class="n">map_data</span><span class="p">,</span>
                                <span class="n">map_mask_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prefit_storage</span><span class="o">.</span><span class="n">map_mask</span><span class="p">,</span>
                                <span class="n">produce_averaged_data</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>

        <span class="c1"># get postfit data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_integrated_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">postfit_integrated_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_map_data</span> \
                <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postfit_data</span><span class="p">,</span> <span class="n">dtrows</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">npol</span><span class="p">,</span>
                                <span class="n">rowlist</span><span class="p">,</span> <span class="n">rowmap</span><span class="o">=</span><span class="n">out_rowmap</span><span class="p">,</span>
                                <span class="n">integrated_data_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postfit_storage</span><span class="o">.</span><span class="n">integrated_data</span><span class="p">,</span>
                                <span class="n">map_data_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postfit_storage</span><span class="o">.</span><span class="n">map_data</span><span class="p">,</span>
                                <span class="n">map_mask_storage</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">postfit_storage</span><span class="o">.</span><span class="n">map_mask</span><span class="p">,</span>
                                <span class="n">produce_averaged_data</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_integrated_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_map_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_integrated_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_map_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_averaged_data</span></div>


<div class="viewcode-block" id="BaselineSubtractionDataManager.analyze_plot_table">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.analyze_plot_table">[docs]</a>
    <span class="k">def</span> <span class="nf">analyze_plot_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">origin_ms_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">antid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">virtual_spwid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">polids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
        <span class="n">org_direction</span><span class="p">:</span> <span class="n">dirutil</span><span class="o">.</span><span class="n">Direction</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create and analyze plot table.</span>

<span class="sd">        Extract datatable row ids that match the selection given by</span>
<span class="sd">        MS id, antenna id, (virtual) spw id, and polarization ids, and</span>
<span class="sd">        associate them with the sparse map panels.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin_ms_id: MS id for selection</span>
<span class="sd">            antid: Antenna id for selection</span>
<span class="sd">            virtual_spwid: Virtual spw id for selection</span>
<span class="sd">            polids: List of polarization ids for selection</span>
<span class="sd">            grid_table: grid_table created by simplegrid module</span>
<span class="sd">            org_direction: direction of the origin</span>

<span class="sd">        Returns:</span>
<span class="sd">            Position information and associated datatable row ids</span>
<span class="sd">            for each sparse map positions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># plot table is separated into two parts: meta data part and row list part</span>
        <span class="c1"># plot_table layout: [RA_ID, DEC_ID, RA_DIR, DEC_DIR]</span>
        <span class="c1"># [[0, 0, RA0, DEC0], &lt;- plane 0</span>
        <span class="c1">#  [0, 0, RA0, DEC0], &lt;- plane 1</span>
        <span class="c1">#  [0, 0, RA0, DEC0], &lt;- plane 2</span>
        <span class="c1">#  [1, 0, RA1, DEC0], &lt;- plane 0</span>
        <span class="c1">#   ...</span>
        <span class="c1">#  [M, 0, RAM, DEC0], &lt;- plane 2</span>
        <span class="c1">#  [0, 1, RA0, DEC1], &lt;- plane 0</span>
        <span class="c1">#  ...</span>
        <span class="c1">#  [M, N, RAM, DECN]] &lt;- plane 2</span>

        <span class="n">plot_table</span> <span class="o">=</span> <span class="n">BaselineSubtractionPlotManager</span><span class="o">.</span><span class="n">generate_plot_meta_table</span><span class="p">(</span><span class="n">virtual_spwid</span><span class="p">,</span>
                                                                             <span class="n">polids</span><span class="p">,</span>
                                                                             <span class="n">grid_table</span><span class="p">)</span>
        <span class="n">num_grid_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_table</span><span class="p">)</span>  <span class="c1"># num_plane * num_grid_ra * num_grid_dec</span>
        <span class="k">assert</span> <span class="n">num_grid_rows</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">num_grid_dec</span> <span class="o">=</span> <span class="n">plot_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_grid_ra</span> <span class="o">=</span> <span class="n">plot_table</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">num_plane</span> <span class="o">=</span> <span class="n">num_grid_rows</span> <span class="o">//</span> <span class="p">(</span><span class="n">num_grid_dec</span> <span class="o">*</span> <span class="n">num_grid_ra</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;num_grid_ra=</span><span class="si">%a</span><span class="s1">, num_grid_dec=</span><span class="si">%s</span><span class="s1">, num_plane=</span><span class="si">%s</span><span class="s1">, num_grid_rows=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="n">num_grid_ra</span><span class="p">,</span> <span class="n">num_grid_dec</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">,</span> <span class="n">num_grid_rows</span><span class="p">)</span>
        <span class="n">xpanel</span><span class="p">,</span> <span class="n">ypanel</span> <span class="o">=</span> <span class="n">configure_1d_panel</span><span class="p">(</span><span class="n">num_grid_ra</span><span class="p">,</span> <span class="n">num_grid_dec</span><span class="p">)</span>
        <span class="n">num_ra</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xpanel</span><span class="p">)</span>
        <span class="n">num_dec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ypanel</span><span class="p">)</span>
        <span class="n">each_grid</span> <span class="o">=</span> <span class="n">configure_2d_panel</span><span class="p">(</span><span class="n">xpanel</span><span class="p">,</span> <span class="n">ypanel</span><span class="p">,</span> <span class="n">num_grid_ra</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">)</span>
        <span class="n">rowlist</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_dec</span> <span class="o">*</span> <span class="n">num_ra</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">row_index</span><span class="p">,</span> <span class="n">each_plane</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">each_grid</span><span class="p">):</span>
            <span class="n">dataids</span> <span class="o">=</span> <span class="n">BaselineSubtractionPlotManager</span><span class="o">.</span><span class="n">generate_plot_rowlist</span><span class="p">(</span><span class="n">origin_ms_id</span><span class="p">,</span>
                                                                           <span class="n">antid</span><span class="p">,</span>
                                                                           <span class="n">virtual_spwid</span><span class="p">,</span>
                                                                           <span class="n">polids</span><span class="p">,</span>
                                                                           <span class="n">grid_table</span><span class="p">,</span>
                                                                           <span class="n">plot_table</span><span class="p">,</span>
                                                                           <span class="n">each_plane</span><span class="p">)</span>

            <span class="n">raid</span> <span class="o">=</span> <span class="n">row_index</span> <span class="o">%</span> <span class="n">num_ra</span>
            <span class="n">decid</span> <span class="o">=</span> <span class="n">row_index</span> <span class="o">//</span> <span class="n">num_ra</span>
            <span class="n">ralist</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">each_plane</span><span class="p">]</span>
            <span class="n">declist</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_table</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">each_plane</span><span class="p">]</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ralist</span><span class="p">)</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">declist</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">org_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">dirutil</span><span class="o">.</span><span class="n">direction_recover</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">org_direction</span><span class="p">)</span>

            <span class="n">rowlist</span><span class="p">[</span><span class="n">row_index</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;RAID&quot;</span><span class="p">:</span> <span class="n">raid</span><span class="p">,</span> <span class="s2">&quot;DECID&quot;</span><span class="p">:</span> <span class="n">decid</span><span class="p">,</span> <span class="s2">&quot;RA&quot;</span><span class="p">:</span> <span class="n">ra</span><span class="p">,</span> <span class="s2">&quot;DEC&quot;</span><span class="p">:</span> <span class="n">dec</span><span class="p">,</span>
                     <span class="s2">&quot;IDS&quot;</span><span class="p">:</span> <span class="n">dataids</span><span class="p">})</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;RA </span><span class="si">%s</span><span class="s1"> DEC </span><span class="si">%s</span><span class="s1">: dataids=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                      <span class="n">raid</span><span class="p">,</span> <span class="n">decid</span><span class="p">,</span> <span class="n">dataids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">,</span> <span class="n">rowlist</span></div>


<div class="viewcode-block" id="BaselineSubtractionDataManager.get_data">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionDataManager.get_data">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">infile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dtrows</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_chan</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_pol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]],</span>
        <span class="n">rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">integrated_data_storage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">map_data_storage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">map_mask_storage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">produce_averaged_data</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create array data for sparse map.</span>

<span class="sd">        Computes the following masked array data for sparse map:</span>
<span class="sd">        1. The integrated spectrum averaged over entire spectral data</span>
<span class="sd">           regardless of their spatial position, which is displayed in</span>
<span class="sd">           the top panel of the figure.</span>
<span class="sd">        2. The &#39;representative&#39; spectrum for each panel of the sparse map.</span>
<span class="sd">           rowlist holds the Spatial grouping information of the panels.</span>
<span class="sd">        3. Averaged spectra for each panel of the sparse map</span>
<span class="sd">           rowlist holds the Spatial grouping information of the panels.</span>
<span class="sd">           Returned only when produce_averaged_data is specified as True.</span>

<span class="sd">        Args:</span>
<span class="sd">            infile: Name of the MS</span>
<span class="sd">            dtrows: List of datatable rows</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            num_chan: Number of spectral channels</span>
<span class="sd">            num_pol: Number of polarizaionts</span>
<span class="sd">            rowlist: List of datatable row ids per sparse map panel with metadata</span>
<span class="sd">            rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                    specified by infile. It will be EchoDictionary if None is given.</span>
<span class="sd">            integrated_data_storage: Storage for integrated spectrum. If None is given,</span>
<span class="sd">                                     new array is created.</span>
<span class="sd">            map_data_storage: Storage for sparse map. If None is given, new array is created.</span>
<span class="sd">            map_mask_storage: Storage for sparse map mask. If None is given, new array is created.</span>
<span class="sd">            produce_averaged_data: Whether to produce averaged data for each panel. Defaut is False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Integrated spectrum averaged over entire spectral data</span>
<span class="sd">            Representative spectrum for each panel of the sparse map</span>
<span class="sd">            Averaged spectra for each panel of the sparse map (only if produce_averaged_data is True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default rowmap is EchoDictionary</span>
        <span class="k">if</span> <span class="n">rowmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rowmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">EchoDictionary</span><span class="p">()</span>

        <span class="n">integrated_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">)</span>
        <span class="n">map_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">integrated_data_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">integrated_data_storage</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">integrated_shape</span>
            <span class="k">assert</span> <span class="n">integrated_data_storage</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span>
            <span class="n">integrated_data</span> <span class="o">=</span> <span class="n">integrated_data_storage</span>
            <span class="n">integrated_data</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">integrated_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">num_integrated</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">map_data_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">map_data_storage</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">map_shape</span>
            <span class="k">assert</span> <span class="n">map_data_storage</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">float</span>
            <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_data_storage</span>
            <span class="n">map_data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">NoDataThreshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">display</span><span class="o">.</span><span class="n">NoDataThreshold</span>
        <span class="k">if</span> <span class="n">map_mask_storage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">map_mask_storage</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">map_shape</span>
            <span class="k">assert</span> <span class="n">map_mask_storage</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span>
            <span class="n">map_mask</span> <span class="o">=</span> <span class="n">map_mask_storage</span>
            <span class="n">map_mask</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">produce_averaged_data</span><span class="p">:</span>
            <span class="n">num_to_average</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">map_data_to_average</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">map_mask_to_average</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">num_pol</span><span class="p">,</span> <span class="n">num_chan</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># go through infile and pack the data</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="c1"># column name for spectral data</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOAT_DATA&#39;</span><span class="p">]</span>
            <span class="n">colname</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">():</span>
                    <span class="n">colname</span> <span class="o">=</span> <span class="n">name</span>
                    <span class="k">break</span>
            <span class="k">assert</span> <span class="n">colname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

            <span class="c1"># loop for &#39;panels&#39; of profile map</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rowlist</span><span class="p">:</span>
                <span class="n">midxperpol</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ix</span> <span class="o">=</span> <span class="n">num_ra</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;RAID&#39;</span><span class="p">]</span>
                <span class="n">iy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;DECID&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;IDS&#39;</span><span class="p">]</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># create index table</span>
                    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">ids_idx</span><span class="p">,</span> <span class="n">dt_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;IDS&#39;</span><span class="p">]</span> <span class="p">):</span>
                        <span class="n">index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">{</span>
                                <span class="s1">&#39;ids_idx&#39;</span>     <span class="p">:</span> <span class="n">ids_idx</span><span class="p">,</span>                 <span class="c1"># index within the &#39;IDS&#39;</span>
                                <span class="s1">&#39;datatable_id&#39;</span><span class="p">:</span> <span class="n">dt_id</span><span class="p">,</span>                   <span class="c1"># datatable id</span>
                                <span class="s1">&#39;orig_row&#39;</span>    <span class="p">:</span> <span class="n">dtrows</span><span class="p">[</span><span class="n">dt_id</span><span class="p">],</span>           <span class="c1"># row of original MS</span>
                                <span class="s1">&#39;mapped_row&#39;</span>  <span class="p">:</span> <span class="n">rowmap</span><span class="p">[</span> <span class="n">dtrows</span><span class="p">[</span><span class="n">dt_id</span><span class="p">]</span> <span class="p">],</span> <span class="c1"># row of the MS for baseline subtraction</span>
                                <span class="s1">&#39;valid&#39;</span>       <span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_pol</span>         <span class="c1"># valid flag for each pol</span>
                            <span class="p">}</span>                                            <span class="c1">#  --True if not fully flagged</span>
                        <span class="p">)</span>

                    <span class="c1"># fill the &#39;valid&#39; column of the index table, and counts for averaging/integrating.</span>
                    <span class="c1"># sort the index_list with orig_row, to avoid jumping back and forth to access the infile.</span>
                    <span class="k">for</span> <span class="n">this_index</span> <span class="ow">in</span> <span class="n">sort_with_key</span><span class="p">(</span> <span class="n">index_list</span><span class="p">,</span> <span class="s1">&#39;orig_row&#39;</span> <span class="p">):</span>

                        <span class="c1"># get the data and mask</span>
                        <span class="n">mapped_row</span> <span class="o">=</span> <span class="n">this_index</span><span class="p">[</span><span class="s1">&#39;mapped_row&#39;</span><span class="p">]</span>
                        <span class="n">this_data</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">mapped_row</span><span class="p">)</span>
                        <span class="n">this_mask</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">mapped_row</span><span class="p">)</span>

                        <span class="c1"># mark each rows whether it is fully flagged for each pol</span>
                        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">):</span>
                            <span class="n">allflagged</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span> <span class="n">this_mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">)</span>
                            <span class="n">this_index</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">allflagged</span>

                        <span class="c1"># used later to calculate integrated/averaged data</span>
                        <span class="n">binary_mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">this_mask</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                        <span class="n">integrated_data</span> <span class="o">+=</span> <span class="n">this_data</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">binary_mask</span>
                        <span class="n">num_integrated</span> <span class="o">+=</span> <span class="n">binary_mask</span>
                        <span class="k">if</span> <span class="n">produce_averaged_data</span><span class="p">:</span>
                            <span class="n">map_data_to_average</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">+=</span> <span class="n">this_data</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">binary_mask</span>
                            <span class="n">num_to_average</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">]</span> <span class="o">+=</span> <span class="n">binary_mask</span>

                    <span class="c1"># pick one &#39;representative&#39; row for each ipol, and prepare storage data</span>
                    <span class="c1"># the &#39;representative&#39; row is given by the &#39;median index&#39; (i.e. ids_idx to the median of selected ids)</span>
                    <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">):</span>
                        <span class="c1"># pick index of &#39;valid&#39; (not fully flagged) rows for each pol</span>
                        <span class="n">valid_index_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">index_list</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;valid&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="p">]</span>

                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">valid_index_list</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># get the row number (mapped_row) corresponding to the &#39;median index&#39;</span>
                            <span class="n">sorted_valid_index_list</span> <span class="o">=</span> <span class="n">sort_with_key</span><span class="p">(</span> <span class="n">valid_index_list</span><span class="p">,</span> <span class="s1">&#39;datatable_id&#39;</span> <span class="p">)</span>

                            <span class="c1"># patch to get similar behaviors with those before PIPE-2064</span>
                            <span class="n">choice</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_valid_index_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_valid_index_list</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

                            <span class="n">median_index</span> <span class="o">=</span> <span class="n">sorted_valid_index_list</span><span class="p">[</span> <span class="n">choice</span> <span class="p">]</span>
                            <span class="n">mapped_row</span> <span class="o">=</span> <span class="n">median_index</span><span class="p">[</span><span class="s1">&#39;mapped_row&#39;</span><span class="p">]</span>

                            <span class="c1"># get data and mask for mapped_row, and prepare for storage data</span>
                            <span class="n">this_data</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="n">mapped_row</span><span class="p">)</span>
                            <span class="n">this_mask</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">mapped_row</span><span class="p">)</span>
                            <span class="n">map_data</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span><span class="o">.</span><span class="n">real</span>
                            <span class="n">map_mask</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_mask</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>

                            <span class="c1"># save the &#39;median index&#39; with its ids_idx : to be used in get_lines() later</span>
                            <span class="n">midxperpol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">median_index</span><span class="p">[</span><span class="s1">&#39;ids_idx&#39;</span><span class="p">]</span> <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">midxperpol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;no data is available for (</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">)</span>
                    <span class="n">midxperpol</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">)]</span>
                <span class="c1"># push median_index into the specific component of rowlist</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;MEDIAN_INDEX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">midxperpol</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;MEDIAN_INDEX for </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">midxperpol</span><span class="p">)</span>

        <span class="c1"># calculate integrated data</span>
        <span class="n">integrated_data_masked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">integrated_data</span><span class="p">,</span> <span class="n">num_integrated</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">integrated_data_masked</span> <span class="o">/=</span> <span class="n">num_integrated</span>
        <span class="n">map_data_masked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">map_data</span><span class="p">,</span> <span class="n">map_mask</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">produce_averaged_data</span><span class="p">:</span>
            <span class="c1"># calculate averaged data for each panel</span>
            <span class="n">map_mask_to_average</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">num_to_average</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">map_data_to_average</span><span class="p">[</span><span class="n">map_mask_to_average</span><span class="p">]</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">NoDataThreshold</span>
            <span class="n">map_data_averaged_masked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">map_data_to_average</span><span class="p">,</span> <span class="n">map_mask_to_average</span><span class="p">)</span>
            <span class="n">map_data_averaged_masked</span> <span class="o">/=</span> <span class="n">num_to_average</span>
            <span class="k">return</span> <span class="n">integrated_data_masked</span><span class="p">,</span> <span class="n">map_data_masked</span><span class="p">,</span> <span class="n">map_data_averaged_masked</span>

        <span class="k">return</span> <span class="n">integrated_data_masked</span><span class="p">,</span> <span class="n">map_data_masked</span></div>
</div>



<div class="viewcode-block" id="BaselineSubtractionPlotManager">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager">[docs]</a>
<span class="k">class</span> <span class="nc">BaselineSubtractionPlotManager</span><span class="p">(</span><span class="n">BaselineSubtractionDataManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages any operation necessary to produce baseline subtraction plot.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="s1">&#39;MeasurementSet&#39;</span><span class="p">,</span> <span class="n">blvis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">datatable</span><span class="p">:</span> <span class="s1">&#39;DataTable&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct BaselineSubtractionPlotManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            ms: Domain object for the MS before baseline subtraction</span>
<span class="sd">            blvis: Name of the MS after baseline subtraction</span>
<span class="sd">            context: Pipeline context</span>
<span class="sd">            datatable: DataTable instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">blvis</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">datatable</span><span class="p">)</span>

        <span class="n">stage_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">task_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s2">&quot;stage</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stage_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   <span class="c1"># handle race condition in Tier-0 operation gracefully</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">PlotterPool</span><span class="p">()</span>

<div class="viewcode-block" id="BaselineSubtractionPlotManager.finalize">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.finalize">[docs]</a>
    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Finalize plot manager.</span>

<span class="sd">        Release resources allocated for plotting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">done</span><span class="p">()</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_plot_meta_table</span><span class="p">(</span>
        <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">polarization_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract necessary data from grid_table.</span>

<span class="sd">        Rows of grid_table are filtered by spw and polarization ids,</span>
<span class="sd">        and only spatial location of the grid are extracted.</span>

<span class="sd">        Args:</span>
<span class="sd">            spw_id: spw id for filtering</span>
<span class="sd">            polarization_ids: polarization ids for filtering</span>
<span class="sd">            grid_table: grid_table generated by simplegrid module</span>

<span class="sd">        Yields:</span>
<span class="sd">            List of spatial position information (pixel and world)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grid_table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spw_id</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">polarization_ids</span><span class="p">:</span>
                <span class="n">new_row_entry</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">new_row_entry</span>

<div class="viewcode-block" id="BaselineSubtractionPlotManager.generate_plot_meta_table">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.generate_plot_meta_table">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_plot_meta_table</span><span class="p">(</span>
        <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">polarization_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return metadata table for plotting.</span>

<span class="sd">        Metadata table for given spw and polarization ids contains</span>
<span class="sd">        spatial position information in both pixel and world coordinates.</span>

<span class="sd">        Args:</span>
<span class="sd">            spw_id: spw id for filtering</span>
<span class="sd">            polarization_ids: polarization ids for filtering</span>
<span class="sd">            grid_table: grid_table generated by simplegrid module</span>

<span class="sd">        Returns:</span>
<span class="sd">            Metadata table (plot_table). The table is intended to be used jointly</span>
<span class="sd">            with the return value of generate_plot_rowlist.</span>
<span class="sd">            plot_table layout: [RA_ID, DEC_ID, RA_DIR, DEC_DIR]</span>

<span class="sd">                [[0, 0, RA0, DEC0], &lt;- plane 0</span>
<span class="sd">                 [0, 0, RA0, DEC0], &lt;- plane 1</span>
<span class="sd">                 [0, 0, RA0, DEC0], &lt;- plane 2</span>
<span class="sd">                 [1, 0, RA1, DEC0], &lt;- plane 0</span>
<span class="sd">                  ...</span>
<span class="sd">                 [M, 0, RAM, DEC0], &lt;- plane 2</span>
<span class="sd">                 [0, 1, RA0, DEC1], &lt;- plane 0</span>
<span class="sd">                 ...</span>
<span class="sd">                 [M, N, RAM, DECN]] &lt;- plane 2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">BaselineSubtractionPlotManager</span><span class="o">.</span><span class="n">_generate_plot_meta_table</span><span class="p">(</span><span class="n">spw_id</span><span class="p">,</span>
                                                                                  <span class="n">polarization_ids</span><span class="p">,</span>
                                                                                  <span class="n">grid_table</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">new_table</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_generate_plot_rowlist</span><span class="p">(</span>
        <span class="n">origin_ms_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">antenna_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">polarization_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
        <span class="n">grid_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield list of datatable row ids that match selection.</span>

<span class="sd">        Extract list of datatable row ids that match the selection for</span>
<span class="sd">        MS, spw, polarization, and spatial grid location. Yield row</span>
<span class="sd">        ids as numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin_ms_id: MS id for selection</span>
<span class="sd">            antenna_id: Antenna id for selection</span>
<span class="sd">            spw_id: Spw id for selection</span>
<span class="sd">            polarization_ids: List of polarization ids</span>
<span class="sd">            grid_table: grid_table generated by simplegrid module</span>
<span class="sd">            grid_list: Spatial grid indices (ix, iy) for selection</span>

<span class="sd">        Yields:</span>
<span class="sd">            List of datatable row ids that matches selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grid_table</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spw_id</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">polarization_ids</span> <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">in</span> <span class="n">grid_list</span><span class="p">:</span>
                <span class="n">new_row_entry</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">origin_ms_id</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">antenna_id</span><span class="p">),</span>
                                               <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">new_row_entry</span>

<div class="viewcode-block" id="BaselineSubtractionPlotManager.generate_plot_rowlist">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.generate_plot_rowlist">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">generate_plot_rowlist</span><span class="p">(</span>
        <span class="n">origin_ms_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">antenna_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">polarization_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]],</span>
        <span class="n">plot_table</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span>
        <span class="n">each_plane</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate list of datatable row ids for plotting.</span>

<span class="sd">        Extract list of datatable row ids that matches selection for</span>
<span class="sd">        MS, spw, polarization, and spatial grid location. Return</span>
<span class="sd">        one-dimensional list of row ids to process.</span>

<span class="sd">        Args:</span>
<span class="sd">            origin_ms_id: MS id for selection</span>
<span class="sd">            antenna_id: Antenna id for selection</span>
<span class="sd">            spw_id: Spw id for selection</span>
<span class="sd">            polarization_ids: List of polarization ids for selection</span>
<span class="sd">            grid_table: grid_table generated by simplegrid module</span>
<span class="sd">            plot_table: Metadata table generated by generate_plot_meta_table</span>
<span class="sd">            each_plane: List of indices for grid_table/plot_table</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of datatable row ids for plotting. Return value is intended</span>
<span class="sd">            to be used jointly with the table returned by generate_plot_meta_table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_table</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">each_plane</span><span class="p">]</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="p">[</span><span class="n">plot_table</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">each_plane</span><span class="p">]</span>
        <span class="n">grid_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span><span class="p">))</span>
        <span class="n">new_table</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">BaselineSubtractionPlotManager</span><span class="o">.</span><span class="n">_generate_plot_rowlist</span><span class="p">(</span><span class="n">origin_ms_id</span><span class="p">,</span>
                                                                               <span class="n">antenna_id</span><span class="p">,</span>
                                                                               <span class="n">spw_id</span><span class="p">,</span>
                                                                               <span class="n">polarization_ids</span><span class="p">,</span>
                                                                               <span class="n">grid_table</span><span class="p">,</span>
                                                                               <span class="n">grid_list</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">new_table</span><span class="p">))</span></div>


    <span class="nd">@casa5style_plot</span>
    <span class="k">def</span> <span class="nf">plot_spectra_with_fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">field_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">antenna_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">postfit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">postfit_map_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_map_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_averaged_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]],</span>
        <span class="n">npol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">grid_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">channelmap_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">showatm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">in_rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">compress</span><span class="o">.</span><span class="n">CompressedObj</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create various types of plots.</span>

<span class="sd">        For given set of field, antenna, and spw ids, this method generates</span>
<span class="sd">        plots of the following types:</span>

<span class="sd">            - sparse profile map for raw spectra before baseline subtraction</span>
<span class="sd">            - sparse profile map for spatially averaged spectra before baseline subtraction</span>
<span class="sd">            - sparse profile map for raw spectra after baseline subtraction</span>
<span class="sd">            - sparse profile map for spatially averaged spectra after baseline subtraction</span>
<span class="sd">            - visual illustration of baseline flatness after baseline subtraction</span>

<span class="sd">        Args:</span>
<span class="sd">            field_id: Field id to process</span>
<span class="sd">            antenna_id: Antenna id to process</span>
<span class="sd">            spw_id: Spw id to process. Should be the real spw id.</span>
<span class="sd">            postfit_integrated_data: integrated spectral data after baseline subtraction.</span>
<span class="sd">            postfit_map_data: sparse map spectral data after baseline subtraction.</span>
<span class="sd">            prefit_integrated_data: integrated spectral data before baseline subtraction.</span>
<span class="sd">            prefit_map_data: sparse map spectral data after baseline subtraction.</span>
<span class="sd">            prefit_averaged_data: averaged spectral data with each grid before baseline subtraction.</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            rowlist: List of datatable row ids per sparse map panel with metadata</span>
<span class="sd">            npol: Number of polarizations</span>
<span class="sd">            frequency: Frequency values of each element in spectrum.</span>
<span class="sd">            grid_table: grid_table generated by simplegrid module</span>
<span class="sd">            deviation_mask: List of channel ranges identified as &quot;deviation mask&quot;. Each range</span>
<span class="sd">                            is represented as a tuple of start and end channels. Those ranges</span>
<span class="sd">                            are shown as red rectangle to indicate they are excluded from the fit.</span>
<span class="sd">                            None means no deviation mask is provided.</span>
<span class="sd">            channelmap_range: List of channel ranges identified as astronomical lines by</span>
<span class="sd">                              line detection and validation process. Channel range is represented</span>
<span class="sd">                              as a tuple of line center channel, line width in channel, and</span>
<span class="sd">                              validation result (boolean). Those ranges are shown as cyan rectangle</span>
<span class="sd">                              to indicate they are excluded from the fit. None means no line ranges</span>
<span class="sd">                              are provided.</span>
<span class="sd">            edge: Edge channels to exclude. Plot whole channels if None is given.</span>
<span class="sd">            showatm: Whether or not overlay ATM transmission curve. Defaults to True.</span>
<span class="sd">            in_rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                       before baseline subtraction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Invalid plot type (maybe internal error)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of compressed Plot objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">grid_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="c1"># convert channelmap_range to plotter-aware format</span>
        <span class="k">if</span> <span class="n">channelmap_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_range</span> <span class="o">=</span> <span class="p">[[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channelmap_range</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line_range</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">field_id</span> <span class="o">=</span> <span class="n">field_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antenna_id</span> <span class="o">=</span> <span class="n">antenna_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spw_id</span> <span class="o">=</span> <span class="n">spw_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virtual_spw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spw_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">data_desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw_id</span><span class="p">)</span>
        <span class="n">num_pol</span> <span class="o">=</span> <span class="n">data_desc</span><span class="o">.</span><span class="n">num_polarizations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol_list</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Generating plots for source </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                  <span class="n">source_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw_id</span><span class="p">)</span>

        <span class="n">outprefix_template</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;spectral_plot_</span><span class="si">%s</span><span class="s1">_subtraction_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_ant</span><span class="si">%s</span><span class="s1">_spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span>
                                                                                           <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                                                                           <span class="n">source_name</span><span class="p">,</span>
                                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">antenna_id</span><span class="p">,</span>
                                                                                           <span class="bp">self</span><span class="o">.</span><span class="n">virtual_spw_id</span><span class="p">)</span>
        <span class="n">prefit_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">outprefix_template</span><span class="p">(</span><span class="s1">&#39;before&#39;</span><span class="p">))</span>
        <span class="n">postfit_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">outprefix_template</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;prefit_prefix=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">prefit_prefix</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;postfit_prefix=</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">postfit_prefix</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">showatm</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">atm_freq</span><span class="p">,</span> <span class="n">atm_transmission</span> <span class="o">=</span> <span class="n">atmutil</span><span class="o">.</span><span class="n">get_transmission</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">antenna_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_id</span><span class="p">,</span>
                                                                  <span class="n">spw_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">doplot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atm_transmission</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">atm_freq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_profile_map_with_fit</span><span class="p">(</span><span class="n">prefit_prefix</span><span class="p">,</span> <span class="n">postfit_prefix</span><span class="p">,</span>
                                                   <span class="n">postfit_integrated_data</span><span class="p">,</span> <span class="n">postfit_map_data</span><span class="p">,</span>
                                                   <span class="n">prefit_integrated_data</span><span class="p">,</span> <span class="n">prefit_map_data</span><span class="p">,</span>
                                                   <span class="n">prefit_averaged_data</span><span class="p">,</span>
                                                   <span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">rowlist</span><span class="p">,</span>
                                                   <span class="n">npol</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span>
                                                   <span class="n">deviation_mask</span><span class="p">,</span> <span class="n">line_range</span><span class="p">,</span>
                                                   <span class="n">atm_transmission</span><span class="p">,</span> <span class="n">atm_freq</span><span class="p">,</span>
                                                   <span class="n">edge</span><span class="p">,</span> <span class="n">in_rowmap</span><span class="o">=</span><span class="n">in_rowmap</span><span class="p">)</span>
        <span class="n">plot_flatness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_flatness_profile</span><span class="p">(</span><span class="n">postfit_prefix</span><span class="p">,</span>
                                                   <span class="n">postfit_integrated_data</span><span class="p">,</span>
                                                   <span class="n">npol</span><span class="p">)</span>
        <span class="n">plot_list</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_flatness</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">plots</span> <span class="ow">in</span> <span class="n">plot_list</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;pre_fit&#39;</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;sd_sparse_map_before_subtraction_raw&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_data</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;post_fit&#39;</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;sd_sparse_map_after_subtraction_raw&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_data</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;pre_fit_avg&#39;</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;sd_sparse_map_before_subtraction_avg&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_data</span>
            <span class="k">elif</span> <span class="n">plot_type</span> <span class="o">==</span> <span class="s1">&#39;post_fit_flatness&#39;</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="s1">&#39;sd_spectrum_after_subtraction_flatness&#39;</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unrecognized plot type.&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">pol</span><span class="p">,</span> <span class="n">figfile</span> <span class="ow">in</span> <span class="n">plots</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">figfile</span><span class="p">):</span>
                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">virtual_spw_id</span><span class="p">,</span>  <span class="c1"># parameter for plots are virtual spw id</span>
                                  <span class="s1">&#39;pol&#39;</span><span class="p">:</span> <span class="n">sd_polmap</span><span class="p">[</span><span class="n">pol</span><span class="p">],</span>
                                  <span class="s1">&#39;ant&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                  <span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">),</span>
                                  <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">ptype</span><span class="p">,</span>
                                  <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>
                    <span class="n">plot</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span>
                                       <span class="n">x_axis</span><span class="o">=</span><span class="s1">&#39;Frequency&#39;</span><span class="p">,</span>
                                       <span class="n">y_axis</span><span class="o">=</span><span class="s1">&#39;Intensity&#39;</span><span class="p">,</span>
                                       <span class="n">field</span><span class="o">=</span><span class="n">source_name</span><span class="p">,</span>
                                       <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">compress</span><span class="o">.</span><span class="n">CompressedObj</span><span class="p">(</span><span class="n">plot</span><span class="p">))</span>
                    <span class="k">del</span> <span class="n">plot</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="BaselineSubtractionPlotManager.plot_profile_map_with_fit">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.plot_profile_map_with_fit">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_profile_map_with_fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">prefit_figfile_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">postfit_figfile_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">postfit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">postfit_map_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_map_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">prefit_averaged_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_dec</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]],</span>
        <span class="n">npol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">line_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
        <span class="n">atm_transmission</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">atm_frequency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
        <span class="n">edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">in_rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create various type of plots.</span>

<span class="sd">        This method produces the following plots.</span>

<span class="sd">            - sparse profile map for raw spectra before baseline subtraction</span>
<span class="sd">            - sparse profile map for spatially averaged spectra before baseline subtraction</span>
<span class="sd">            - sparse profile map for raw spectra after baseline subtraction</span>
<span class="sd">            - sparse profile map for spatially averaged spectra after baseline subtraction</span>

<span class="sd">        Args:</span>
<span class="sd">            prefit_figfile_prefix: Prefix string for the filename (before baseline subtraction)</span>
<span class="sd">            postfit_figfile_prefix: Prefix for the filename (after baseline subtraction)</span>
<span class="sd">            postfit_integrated_data: integrated spectral data after baseline subtraction.</span>
<span class="sd">            postfit_map_data: sparse map spectral data after baseline subtraction.</span>
<span class="sd">            prefit_integrated_data: integrated spectral data before baseline subtraction.</span>
<span class="sd">            prefit_map_data: sparse map spectral data after baseline subtraction.</span>
<span class="sd">            prefit_averaged_data: averaged spectral data with each grid before baseline subtraction.</span>
<span class="sd">            num_ra: Number of panels along horizontal axis</span>
<span class="sd">            num_dec: Number of panels along vertical axis</span>
<span class="sd">            rowlist: List of datatable row indices per sparse map panel with metadata</span>
<span class="sd">            npol: Number of polarizations</span>
<span class="sd">            frequency: Frequency values of each element in spectrum</span>
<span class="sd">            deviation_mask: List of channel ranges identified as the &quot;deviation mask&quot;</span>
<span class="sd">            line_range: List of channel ranges identified as astronomical line</span>
<span class="sd">            atm_transmission: ATM transmission data</span>
<span class="sd">            atm_frequency: frequency label associated with ATM transmission</span>
<span class="sd">            edge: Edge channels excluded from the baseline fitting</span>
<span class="sd">            in_rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                       before baseline subtraction.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing names of the figure with plot type and</span>
<span class="sd">            polarization id as keys</span>

<span class="sd">                plot_list[plot_type][polarization_id] = figfile</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">polids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_list</span>
        <span class="n">prefit_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefit_data</span>

        <span class="c1"># get brightnessunit from MS</span>
        <span class="c1"># default is Jy/beam</span>
        <span class="n">bunit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_brightness_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">defaultunit</span><span class="o">=</span><span class="s1">&#39;Jy/beam&#39;</span><span class="p">)</span>

        <span class="c1"># ralist/declist holds coordinates for axis labels (center of each panel)</span>
        <span class="n">ralist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;RA&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rowlist</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;DECID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">declist</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;DEC&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rowlist</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;RAID&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">create_plotter</span><span class="p">(</span><span class="n">num_ra</span><span class="p">,</span> <span class="n">num_dec</span><span class="p">,</span> <span class="n">ralist</span><span class="p">,</span> <span class="n">declist</span><span class="p">,</span>
                                           <span class="n">direction_reference</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datatable</span><span class="o">.</span><span class="n">direction_ref</span><span class="p">,</span>
                                           <span class="n">brightnessunit</span><span class="o">=</span><span class="n">bunit</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">line_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines_map</span> <span class="o">=</span> <span class="n">get_lines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datatable</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">,</span> <span class="n">npol</span><span class="p">,</span> <span class="n">rowlist</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines_map</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># plot post-fit spectra</span>
        <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;post_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">setup_reference_level</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">set_deviation_mask</span><span class="p">(</span><span class="n">deviation_mask</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">set_edge</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">set_atm_transmission</span><span class="p">(</span><span class="n">atm_transmission</span><span class="p">,</span> <span class="n">atm_frequency</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">set_global_scaling</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_nro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">):</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">set_channel_axis</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">postfit_figfile</span> <span class="o">=</span> <span class="n">postfit_figfile_prefix</span> <span class="o">+</span> <span class="s1">&#39;_pol</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">ipol</span>
            <span class="c1"># LOG.info(&#39;#TIMING# Begin SDSparseMapPlotter.plot(postfit,pol%s)&#39;%(ipol))</span>
            <span class="k">if</span> <span class="n">lines_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">,</span> <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">postfit_map_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ipol</span><span class="p">,</span> <span class="p">:],</span>
                         <span class="n">postfit_integrated_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span>
                         <span class="n">frequency</span><span class="p">,</span> <span class="n">figfile</span><span class="o">=</span><span class="n">postfit_figfile</span><span class="p">)</span>
            <span class="c1"># LOG.info(&#39;#TIMING# End SDSparseMapPlotter.plot(postfit,pol%s)&#39;%(ipol))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">postfit_figfile</span><span class="p">):</span>
                <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;post_fit&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">postfit_figfile</span>

        <span class="c1"># fit_result shares its storage with postfit_map_data to reduce memory usage</span>
        <span class="n">fit_result</span> <span class="o">=</span> <span class="n">postfit_map_data</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_ra</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_dec</span><span class="p">):</span>
                <span class="n">prefit</span> <span class="o">=</span> <span class="n">prefit_map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">prefit</span> <span class="o">==</span> <span class="n">display</span><span class="o">.</span><span class="n">NoDataThreshold</span><span class="p">):</span>
                    <span class="n">postfit</span> <span class="o">=</span> <span class="n">postfit_map_data</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="n">y</span><span class="p">]</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefit</span> <span class="o">-</span> <span class="n">postfit</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fit_result</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">::]</span> <span class="o">=</span> <span class="n">display</span><span class="o">.</span><span class="n">NoDataThreshold</span>

        <span class="c1"># plot pre-fit spectra</span>
        <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;pre_fit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">setup_reference_level</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">unset_global_scaling</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">prefit_figfile</span> <span class="o">=</span> <span class="n">prefit_figfile_prefix</span> <span class="o">+</span> <span class="s1">&#39;_pol</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ipol</span><span class="p">)</span>
            <span class="c1"># LOG.info(&#39;#TIMING# Begin SDSparseMapPlotter.plot(prefit,pol%s)&#39;%(ipol))</span>
            <span class="k">if</span> <span class="n">lines_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">,</span> <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prefit_map_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ipol</span><span class="p">,</span> <span class="p">:],</span>
                         <span class="n">prefit_integrated_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span>
                         <span class="n">frequency</span><span class="p">,</span> <span class="n">fit_result</span><span class="o">=</span><span class="n">fit_result</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ipol</span><span class="p">,</span> <span class="p">:],</span> <span class="n">figfile</span><span class="o">=</span><span class="n">prefit_figfile</span><span class="p">)</span>
            <span class="c1"># LOG.info(&#39;#TIMING# End SDSparseMapPlotter.plot(prefit,pol%s)&#39;%(ipol))</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prefit_figfile</span><span class="p">):</span>
                <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;pre_fit&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefit_figfile</span>

        <span class="k">del</span> <span class="n">prefit_map_data</span><span class="p">,</span> <span class="n">postfit_map_data</span><span class="p">,</span> <span class="n">fit_result</span>

        <span class="k">if</span> <span class="n">line_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lines_map_avg</span> <span class="o">=</span> <span class="n">get_lines2</span><span class="p">(</span><span class="n">prefit_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">datatable</span><span class="p">,</span> <span class="n">num_ra</span><span class="p">,</span>
                                       <span class="n">rowlist</span><span class="p">,</span> <span class="n">polids</span><span class="p">,</span> <span class="n">rowmap</span><span class="o">=</span><span class="n">in_rowmap</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lines_map_avg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># plot pre-fit averaged spectra</span>
        <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;pre_fit_avg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">setup_reference_level</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">plotter</span><span class="o">.</span><span class="n">unset_global_scaling</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">prefit_avg_figfile</span> <span class="o">=</span> <span class="n">prefit_figfile_prefix</span> <span class="o">+</span> <span class="s1">&#39;_avg_pol</span><span class="si">{}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ipol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines_map_avg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">,</span> <span class="n">lines_map_avg</span><span class="p">[</span><span class="n">ipol</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">setup_lines</span><span class="p">(</span><span class="n">line_range</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">prefit_averaged_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ipol</span><span class="p">,</span> <span class="p">:],</span>
                         <span class="n">prefit_integrated_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span>
                         <span class="n">frequency</span><span class="p">,</span> <span class="n">fit_result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figfile</span><span class="o">=</span><span class="n">prefit_avg_figfile</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">prefit_avg_figfile</span><span class="p">):</span>
                <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;pre_fit_avg&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefit_avg_figfile</span>

        <span class="k">del</span> <span class="n">prefit_integrated_data</span><span class="p">,</span> <span class="n">prefit_averaged_data</span>

        <span class="n">plotter</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>


<div class="viewcode-block" id="BaselineSubtractionPlotManager.plot_flatness_profile">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionPlotManager.plot_flatness_profile">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_flatness_profile</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">postfit_figfile_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">postfit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
        <span class="n">npol</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create plots of baseline flatness profile of a spectrum (after baseline subtraction).</span>

<span class="sd">        Args:</span>
<span class="sd">            postfit_figfile_prefix: Prefix for the filename (after baseline subtraction)</span>
<span class="sd">            postfit_integrated_data: integrated spectral data after baseline subtraction.</span>
<span class="sd">            npol: Number of polarizations</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary containing names of the figure with plot type and</span>
<span class="sd">            polarization id as keys</span>

<span class="sd">                plot_list[plot_type][polarization_id] = figfile</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plot_list</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># baseline flatness plots</span>
        <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;post_fit_flatness&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">postfit_qa_figfile</span> <span class="o">=</span> <span class="n">postfit_figfile_prefix</span> <span class="o">+</span> <span class="s1">&#39;_flatness_pol</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">ipol</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">postfit_qa_figfile</span><span class="p">):</span>
                <span class="n">plot_list</span><span class="p">[</span><span class="s1">&#39;post_fit_flatness&#39;</span><span class="p">][</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">postfit_qa_figfile</span>

        <span class="k">del</span> <span class="n">postfit_integrated_data</span>

        <span class="k">return</span> <span class="n">plot_list</span></div>
</div>



<div class="viewcode-block" id="BaselineSubtractionQualityManager">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager">[docs]</a>
<span class="k">class</span> <span class="nc">BaselineSubtractionQualityManager</span><span class="p">(</span><span class="n">BaselineSubtractionDataManager</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to calculate quality statistics.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="s1">&#39;MeasurementSet&#39;</span><span class="p">,</span> <span class="n">blvis</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="s1">&#39;Context&#39;</span><span class="p">,</span> <span class="n">datatable</span><span class="p">:</span> <span class="s1">&#39;DataTable&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct BaselineSubtractionQualityManager instance.</span>

<span class="sd">        Args:</span>
<span class="sd">            ms: Domain object for the MS before baseline subtraction</span>
<span class="sd">            blvis: Name of the MS after baseline subtraction</span>
<span class="sd">            context: Pipeline context</span>
<span class="sd">            datatable: DataTable instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">blvis</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">datatable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_freq</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_data</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="BaselineSubtractionQualityManager.analyze_flatness">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.analyze_flatness">[docs]</a>
    <span class="k">def</span> <span class="nf">analyze_flatness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                         <span class="n">line_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span>
                         <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
                         <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">BinnedStat</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a data of baseline flatness of a spectrum.</span>

<span class="sd">        Also, this method computes statistics of binned spectrum.</span>

<span class="sd">        Args:</span>
<span class="sd">            spectrum: A spectrum to analyze baseline flatness and plot.</span>
<span class="sd">            frequency: Frequency values of each element in spectrum.</span>
<span class="sd">            line_range: ID ranges in spectrum array that should be considered</span>
<span class="sd">                as spectral lines and eliminated from inspection of baseline</span>
<span class="sd">                flatness.</span>
<span class="sd">            deviation_mask: ID ranges of deviation mask. These ranges are also</span>
<span class="sd">                eliminated from inspection of baseline flatness.</span>
<span class="sd">            edge: Number of elements in left and right edges that should be</span>
<span class="sd">                eliminates from inspection of baseline flatness.</span>

<span class="sd">        Return:</span>
<span class="sd">            Statistics of binned spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">masked_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">)</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ch1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">masked_data</span><span class="p">)</span><span class="o">-</span><span class="n">ch2</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">num_masked_1</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of newly masked channels with edge parameter: </span><span class="si">{</span><span class="n">num_masked_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="n">line_range</span><span class="p">:</span>
                <span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">chmin</span><span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">chmax</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">num_masked_2</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of newly masked channels with line mask: </span><span class="si">{</span><span class="n">num_masked_2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num_masked_1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deviation_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="n">deviation_mask</span><span class="p">:</span>
                <span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">chmin</span><span class="p">:</span><span class="n">chmax</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">num_masked_3</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of newly masked channels with deviation mask: </span><span class="si">{</span><span class="n">num_masked_3</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num_masked_2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span> <span class="o">=</span> <span class="n">masked_data</span>

        <span class="n">stddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="n">stat_valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">nbin_factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">nbin</span> <span class="o">=</span> <span class="mi">20</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="k">else</span> <span class="mi">10</span>

        <span class="n">binned_freq</span><span class="p">,</span> <span class="n">binned_data</span> <span class="o">=</span> <span class="n">binned_mean_ma</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;nbin </span><span class="si">{</span><span class="n">nbin</span><span class="si">}</span><span class="s1">: len(binned_data) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">binned_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="sa">f</span><span class="s1">&#39; count = </span><span class="si">{</span><span class="n">binned_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stddev</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">stddev</span><span class="p">):</span>
            <span class="c1"># stddev is invalid, i.e., masked_data doesn&#39;t contain valid data</span>
            <span class="n">stat_valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="n">binned_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># not enough valid data, increase nbin and try again</span>
            <span class="n">nbin_org</span> <span class="o">=</span> <span class="n">nbin</span>
            <span class="n">nbin_factor</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">nbin</span> <span class="o">*=</span> <span class="n">nbin_factor</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Calculation of baseline flatness QA metrics with nbin=</span><span class="si">{</span><span class="n">nbin_org</span><span class="si">}</span><span class="s1"> has failed. &#39;</span>
                <span class="sa">f</span><span class="s1">&#39;Increase nbin to </span><span class="si">{</span><span class="n">nbin</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="p">)</span>
            <span class="n">binned_freq</span><span class="p">,</span> <span class="n">binned_data</span> <span class="o">=</span> <span class="n">binned_mean_ma</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span><span class="p">,</span> <span class="n">nbin</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;nbin </span><span class="si">{</span><span class="n">nbin</span><span class="si">}</span><span class="s1">: len(binned_data) = </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">binned_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; count = </span><span class="si">{</span><span class="n">binned_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">binned_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># not enough valid data even for larger number of bins</span>
                <span class="n">stat_valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">binned_freq</span> <span class="o">=</span> <span class="n">binned_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">binned_data</span> <span class="o">=</span> <span class="n">binned_data</span>

        <span class="k">if</span> <span class="n">stat_valid</span><span class="p">:</span>
            <span class="n">bin_min</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">binned_data</span><span class="p">)</span>
            <span class="n">bin_max</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">binned_data</span><span class="p">)</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">BinnedStat</span><span class="p">(</span><span class="n">bin_min_ratio</span><span class="o">=</span><span class="n">bin_min</span><span class="o">/</span><span class="n">stddev</span><span class="p">,</span>
                              <span class="n">bin_max_ratio</span><span class="o">=</span><span class="n">bin_max</span><span class="o">/</span><span class="n">stddev</span><span class="p">,</span>
                              <span class="n">bin_diff_ratio</span><span class="o">=</span><span class="p">(</span><span class="n">bin_max</span><span class="o">-</span><span class="n">bin_min</span><span class="p">)</span><span class="o">/</span><span class="n">stddev</span><span class="p">,</span>
                              <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span>
                              <span class="n">nbin_factor</span><span class="o">=</span><span class="n">nbin_factor</span><span class="p">,</span>
                              <span class="n">valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="n">BinnedStat</span><span class="p">(</span><span class="n">bin_min_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">bin_max_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">bin_diff_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span>
                              <span class="n">nbin_factor</span><span class="o">=</span><span class="n">nbin_factor</span><span class="p">,</span>
                              <span class="n">valid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stat</span></div>


<div class="viewcode-block" id="BaselineSubtractionQualityManager.plot_flatness">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.plot_flatness">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_flatness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                      <span class="n">line_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]],</span>
                      <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
                      <span class="n">edge</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">brightnessunit</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">stat</span><span class="p">:</span> <span class="n">BinnedStat</span><span class="p">,</span>
                      <span class="n">figfile</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a plot of baseline flatness of a spectrum.</span>

<span class="sd">        Args:</span>
<span class="sd">            spectrum: A spectrum to analyze baseline flatness and plot.</span>
<span class="sd">            frequency: Frequency values of each element in spectrum.</span>
<span class="sd">            line_range: ID ranges in spectrum array that should be considered</span>
<span class="sd">                as spectral lines and eliminated from inspection of baseline</span>
<span class="sd">                flatness.</span>
<span class="sd">            deviation_mask: ID ranges of deviation mask. These ranges are also</span>
<span class="sd">                eliminated from inspection of baseline flatness.</span>
<span class="sd">            edge: Number of elements in left and right edges that should be</span>
<span class="sd">                eliminated from inspection of baseline flatness.</span>
<span class="sd">            brightnessunit: Brightness unit of spectrum.</span>
<span class="sd">            stat: Binned statistics data</span>
<span class="sd">            figfile: A file name to save figure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stddev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">masked_data</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">stddev</span> <span class="ow">is</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">stddev</span><span class="p">):</span>
            <span class="c1"># not enough valid data or stddev is invalid</span>
            <span class="k">return</span>

        <span class="c1"># create a plot</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">frequency</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frequency</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="o">*</span><span class="n">stddev</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">stddev</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Spatially Averaged Spectrum&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Intensity (</span><span class="si">{</span><span class="n">brightnessunit</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency (GHz)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">edge</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ch1</span><span class="p">,</span> <span class="n">ch2</span><span class="p">)</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="n">fedge0</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">fedge1</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="n">ch1</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">fedge2</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span><span class="o">-</span><span class="n">ch2</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">fedge3</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge0</span><span class="p">,</span> <span class="n">fedge1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fedge2</span><span class="p">,</span> <span class="n">fedge3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgray&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="n">line_range</span><span class="p">:</span>
                <span class="n">fmin</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="n">chmin</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">fmax</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="n">chmax</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cyan&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deviation_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chmin</span><span class="p">,</span> <span class="n">chmax</span> <span class="ow">in</span> <span class="n">deviation_mask</span><span class="p">:</span>
                <span class="n">fmin</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="n">chmin</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">fmax</span> <span class="o">=</span> <span class="n">ch_to_freq</span><span class="p">(</span><span class="n">chmax</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">fmin</span><span class="p">,</span> <span class="n">fmax</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mf">0.97</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="o">-</span><span class="n">stddev</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">stddev</span><span class="p">],</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">binned_freq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_data</span><span class="p">,</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">nbin_factor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">note_nbin</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;applied default number of bins (</span><span class="si">{</span><span class="n">stat</span><span class="o">.</span><span class="n">nbin</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">note_nbin</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;applied </span><span class="si">{</span><span class="n">stat</span><span class="o">.</span><span class="n">nbin_factor</span><span class="si">}</span><span class="s1"> times default number of bins (</span><span class="si">{</span><span class="n">stat</span><span class="o">.</span><span class="n">nbin</span><span class="si">}</span><span class="s1">)&#39;</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">note_nbin</span> <span class="o">=</span> <span class="s1">&#39;NO BINNED SPECTRUM AVAILABLE&#39;</span>
            <span class="n">facecolor</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.98</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="n">note_nbin</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;boxstyle&#39;</span><span class="p">:</span> <span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="s1">&#39;facecolor&#39;</span><span class="p">:</span> <span class="n">facecolor</span><span class="p">,</span> <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">DPIDetail</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaselineSubtractionQualityManager.calculate_baseline_quality_stat">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.html#pipeline.hsd.tasks.baseline.plotter.BaselineSubtractionQualityManager.calculate_baseline_quality_stat">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_baseline_quality_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">ant_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                        <span class="n">postfit_integrated_data</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">,</span>
                                        <span class="n">npol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                        <span class="n">deviation_mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]],</span>
                                        <span class="n">channelmap_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]],</span>
                                        <span class="n">edge</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">QualityStat</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate quality statistics after baseline subtraction.</span>

<span class="sd">        Args:</span>
<span class="sd">            field_id: Field id to process</span>
<span class="sd">            ant_id: Antnena id to process</span>
<span class="sd">            spw_id: Spw id to process. Should be the real spw id.</span>
<span class="sd">            postfit_integrated_data: integrated spectral data after baseline subtraction.</span>
<span class="sd">            npol: Number of polarizations</span>
<span class="sd">            frequency: Frequency values of each element in spectrum</span>
<span class="sd">            deviation_mask: List of channel ranges identified as the &quot;deviation mask&quot;</span>
<span class="sd">            channelmap_range: List of channel ranges identified as astronomical lines by</span>
<span class="sd">                              line detection and validation process. Channel range is represented</span>
<span class="sd">                              as a tuple of line center channel, line width in channel, and</span>
<span class="sd">                              validation result (boolean). Those ranges are shown as cyan rectangle</span>
<span class="sd">                              to indicate they are excluded from the fit. None means no line ranges</span>
<span class="sd">                              are provided.</span>
<span class="sd">            edge: Edge channels excluded from the baseline fitting</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of namedtuple &#39;QualityStat&#39; containing &#39;vis field spw ant pol stat&#39;.</span>
<span class="sd">            The &#39;stat&#39; is also namedtuple &#39;BinnedStat&#39;. (see method analyze_flatness.)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">virtual_spw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">spw_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">stage_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">task_counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s2">&quot;stage</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">stage_number</span><span class="p">)</span>
        <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="n">outprefix_template</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;spectral_plot_</span><span class="si">%s</span><span class="s1">_subtraction_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_ant</span><span class="si">%s</span><span class="s1">_spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span>
                                                                                           <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                                                                                           <span class="n">source_name</span><span class="p">,</span>
                                                                                           <span class="n">ant_id</span><span class="p">,</span>
                                                                                           <span class="n">virtual_spw_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postfit_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stage_dir</span><span class="p">,</span> <span class="n">outprefix_template</span><span class="p">(</span><span class="s1">&#39;after&#39;</span><span class="p">))</span>
        <span class="n">baseline_quality_stat</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert channelmap_range to plotter-aware format</span>
        <span class="k">if</span> <span class="n">channelmap_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">line_range</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">line_range</span> <span class="o">=</span> <span class="p">[[</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">channelmap_range</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">line_range</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get brightnessunit from MS</span>
        <span class="c1"># default is Jy/beam</span>
        <span class="n">bunit</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_brightness_unit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">defaultunit</span><span class="o">=</span><span class="s1">&#39;Jy/beam&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npol</span><span class="p">):</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_flatness</span><span class="p">(</span><span class="n">postfit_integrated_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">line_range</span><span class="p">,</span> <span class="n">deviation_mask</span><span class="p">,</span> <span class="n">edge</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">nbin_factor</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;Default number of bins for baseline flatness QA &#39;</span>
                        <span class="s1">&#39;metrics did not work for vis </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1">. &#39;</span>
                        <span class="s1">&#39;Applied </span><span class="si">%s</span><span class="s1"> times larger number of bins instead.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">ant_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">ipol</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">nbin_factor</span>
                    <span class="p">)</span>
                <span class="n">quality_stat</span> <span class="o">=</span> <span class="n">QualityStat</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">),</span> <span class="n">field</span><span class="o">=</span><span class="n">source_name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">virtual_spw_id</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="n">ant_id</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">sd_polmap</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="n">stat</span><span class="o">=</span><span class="p">[</span><span class="n">stat</span><span class="p">])</span>
                <span class="n">baseline_quality_stat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quality_stat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s1">&#39;Failed to evaluate baseline flatness QA metrics for &#39;</span>
                    <span class="s1">&#39;vis </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1">. &#39;</span>
                    <span class="s1">&#39;Baseline flatness plot will be incomplete.&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">ant_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">ipol</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">basetask</span><span class="o">.</span><span class="n">DISABLE_WEBLOG</span><span class="p">:</span>
                <span class="n">postfit_qa_figfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postfit_prefix</span> <span class="o">+</span> <span class="s1">&#39;_flatness_pol</span><span class="si">%s</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">ipol</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_flatness</span><span class="p">(</span><span class="n">postfit_integrated_data</span><span class="p">[</span><span class="n">ipol</span><span class="p">],</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">line_range</span><span class="p">,</span>
                                   <span class="n">deviation_mask</span><span class="p">,</span> <span class="n">edge</span><span class="p">,</span> <span class="n">bunit</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">postfit_qa_figfile</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">postfit_qa_figfile</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;No valid spectra in vis </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> pol </span><span class="si">%s</span><span class="s1">. &#39;</span>
                        <span class="s1">&#39;Neither baseline flatness QA metrics nor baseline &#39;</span>
                        <span class="s1">&#39;flatness plot are available.&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">ant_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">ipol</span>
                    <span class="p">)</span>

        <span class="k">del</span> <span class="n">postfit_integrated_data</span>

        <span class="k">return</span> <span class="n">baseline_quality_stat</span></div>
</div>


<div class="viewcode-block" id="generate_grid_panel_map">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.generate_grid_panel_map.html#pipeline.hsd.tasks.baseline.plotter.generate_grid_panel_map">[docs]</a>
<span class="k">def</span> <span class="nf">generate_grid_panel_map</span><span class="p">(</span><span class="n">ngrid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">npanel</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Yield list of grid table indices that belong to the sparse map panel.</span>

<span class="sd">    Args:</span>
<span class="sd">        ngrid: Number of grid positions</span>
<span class="sd">        npanel: Number of panels</span>
<span class="sd">        num_plane: Number of planes per grid position. Defaults to 1.</span>

<span class="sd">    Yields:</span>
<span class="sd">        List of indices for the grid table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">//</span> <span class="n">npanel</span>
    <span class="n">mg</span> <span class="o">=</span> <span class="n">ngrid</span> <span class="o">%</span> <span class="n">npanel</span>
    <span class="n">ng_per_panel</span> <span class="o">=</span> <span class="p">[</span><span class="n">ng</span> <span class="o">*</span> <span class="n">num_plane</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npanel</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mg</span><span class="p">):</span>
        <span class="n">ng_per_panel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">num_plane</span>

    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npanel</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">e</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ng_per_panel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>



<div class="viewcode-block" id="configure_1d_panel">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.configure_1d_panel.html#pipeline.hsd.tasks.baseline.plotter.configure_1d_panel">[docs]</a>
<span class="k">def</span> <span class="nf">configure_1d_panel</span><span class="p">(</span>
    <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Configure linear mapping between grid table index and sparse map panel.</span>

<span class="sd">    When number of grid positions, nx * ny, exceeds 50, neighboring positions</span>
<span class="sd">    are combined so that number of sparse map panels does not exceed 50.</span>

<span class="sd">    Args:</span>
<span class="sd">        nx: Number of grid positions along horizontal axis</span>
<span class="sd">        ny: Number of grid positions along vertical axis</span>
<span class="sd">        num_plane: Number of planes per grid position. Defaults to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Linear mapping between grid table index and sparse map panel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_panels</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">num_panels</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">*</span> <span class="n">ny</span>

    <span class="n">nnx</span> <span class="o">=</span> <span class="n">nx</span>
    <span class="n">nny</span> <span class="o">=</span> <span class="n">ny</span>
    <span class="k">if</span> <span class="n">num_panels</span> <span class="o">&gt;</span> <span class="n">max_panels</span><span class="p">:</span>
        <span class="n">div</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;original: </span><span class="si">{}</span><span class="s1"> x </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">num_panels</span><span class="p">))</span>
        <span class="n">ndiv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">nnp</span> <span class="o">=</span> <span class="n">num_panels</span>
        <span class="k">while</span> <span class="n">nnp</span> <span class="o">&gt;</span> <span class="n">max_panels</span><span class="p">:</span>
            <span class="n">nnx</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">nnx</span><span class="p">)</span>
            <span class="n">nny</span> <span class="o">=</span> <span class="n">div</span><span class="p">(</span><span class="n">nny</span><span class="p">)</span>
            <span class="n">nnp</span> <span class="o">=</span> <span class="n">nnx</span> <span class="o">*</span> <span class="n">nny</span>
            <span class="n">ndiv</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;div </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1"> x </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndiv</span><span class="p">,</span> <span class="n">nnx</span><span class="p">,</span> <span class="n">nny</span><span class="p">,</span> <span class="n">nnp</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;processed: </span><span class="si">{}</span><span class="s1"> x </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nnx</span><span class="p">,</span> <span class="n">nny</span><span class="p">,</span> <span class="n">nnp</span><span class="p">))</span>

    <span class="n">xpanel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_grid_panel_map</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">nnx</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">))</span>
    <span class="n">ypanel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">generate_grid_panel_map</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nny</span><span class="p">,</span> <span class="n">num_plane</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">xpanel</span><span class="p">,</span> <span class="n">ypanel</span></div>



<div class="viewcode-block" id="configure_2d_panel">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.configure_2d_panel.html#pipeline.hsd.tasks.baseline.plotter.configure_2d_panel">[docs]</a>
<span class="k">def</span> <span class="nf">configure_2d_panel</span><span class="p">(</span>
    <span class="n">xpanel</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ypanel</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
    <span class="n">ngridx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Confure two-dimensional mapping between grid table and sparse map panel.</span>

<span class="sd">    Args:</span>
<span class="sd">        xpanel: Linear mapping result returned by configure_1d_panel</span>
<span class="sd">        ypanel: Linear mapping result returned by configure_1d_panel</span>
<span class="sd">        ngridx: Number of grid positions along horizontal axis</span>
<span class="sd">        num_plane: Number of planes per grid position. Defaults to 3.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Two-dimensional mapping between grid table and sparse map panel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xypanel</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ygrid</span> <span class="ow">in</span> <span class="n">ypanel</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xgrid</span> <span class="ow">in</span> <span class="n">xpanel</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">ygrid</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xgrid</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">ngridx</span> <span class="o">*</span> <span class="n">num_plane</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">num_plane</span> <span class="o">*</span> <span class="n">x</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">num_plane</span><span class="p">)))</span>
            <span class="n">xypanel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xypanel</span></div>



<div class="viewcode-block" id="get_lines">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.get_lines.html#pipeline.hsd.tasks.baseline.plotter.get_lines">[docs]</a>
<span class="k">def</span> <span class="nf">get_lines</span><span class="p">(</span>
    <span class="n">datatable</span><span class="p">:</span> <span class="s1">&#39;DataTable&#39;</span><span class="p">,</span>
    <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_pol</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get detected line ranges per sparse map panel.</span>

<span class="sd">    Line information is taken from the datatable row specified</span>
<span class="sd">    by &#39;MEDIAN_INDEX&#39; value of each item in rowlist.</span>

<span class="sd">    Args:</span>
<span class="sd">        datatable  Datatable instance</span>
<span class="sd">        num_ra: Number of panels along horizontal axis</span>
<span class="sd">        num_pol: Number of polarizations</span>
<span class="sd">        rowlist: List of datatable row indices per sparse map panel with metadata</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of detected line ranges per panel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lines_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_pol</span>
    <span class="c1"># with casa_tools.TableReader(rwtablename) as tb:</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rowlist</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">num_ra</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;RAID&#39;</span><span class="p">]</span>
        <span class="n">iy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;DECID&#39;</span><span class="p">]</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;IDS&#39;</span><span class="p">]</span>
        <span class="n">midx</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;MEDIAN_INDEX&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">midx</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">midx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">midx</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">masklist</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">midx</span><span class="p">[</span><span class="n">ipol</span><span class="p">]])</span>
                    <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">masklist</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="k">else</span> <span class="n">masklist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">lines_map</span></div>



<div class="viewcode-block" id="get_lines2">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.get_lines2.html#pipeline.hsd.tasks.baseline.plotter.get_lines2">[docs]</a>
<span class="k">def</span> <span class="nf">get_lines2</span><span class="p">(</span>
    <span class="n">infile</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">datatable</span><span class="p">:</span> <span class="s1">&#39;DataTable&#39;</span><span class="p">,</span>
    <span class="n">num_ra</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">rowlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]],</span>
    <span class="n">polids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="n">rowmap</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get detected line ranges per sparse map panel.</span>

<span class="sd">    get_lines2 performs the same operation with get_lines from</span>
<span class="sd">    the different input arguments.</span>

<span class="sd">    Args:</span>
<span class="sd">        infile: Name of MS before baseline subtraction</span>
<span class="sd">        datatable: Datatable instance</span>
<span class="sd">        num_ra: Number of panels along horizontal axis</span>
<span class="sd">        rowlist: List of datatable row ids per sparse map panel with metadata</span>
<span class="sd">        polids: List of polarization ids</span>
<span class="sd">        rowmap: Row mapping between original (calibrated) MS and the MS</span>
<span class="sd">                before baseline subtraction. It will be EchoDictionary if</span>
<span class="sd">                None is given.</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of detected line ranges per panel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">rowmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rowmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">EchoDictionary</span><span class="p">()</span>

    <span class="n">num_pol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">polids</span><span class="p">)</span>
    <span class="n">lines_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_pol</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">rowlist</span><span class="p">:</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">num_ra</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;RAID&#39;</span><span class="p">]</span>
            <span class="n">iy</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;DECID&#39;</span><span class="p">]</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;IDS&#39;</span><span class="p">]</span>
            <span class="n">ref_ra</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;RA&#39;</span><span class="p">]</span>
            <span class="n">ref_dec</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;DEC&#39;</span><span class="p">]</span>
            <span class="n">rep_ids</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">)]</span>
            <span class="n">min_distance</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1e30</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">dt_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">rowmap</span><span class="p">[</span><span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;ROW&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">)]</span>
                <span class="n">flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="n">ra</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;OFS_RA&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">)</span>
                <span class="n">dec</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;OFS_DEC&#39;</span><span class="p">,</span> <span class="n">dt_id</span><span class="p">)</span>
                <span class="n">sqdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">ref_ra</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ra</span> <span class="o">-</span> <span class="n">ref_ra</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">dec</span> <span class="o">-</span> <span class="n">ref_dec</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">dec</span> <span class="o">-</span> <span class="n">ref_dec</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">flag</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">):</span>
                        <span class="c1"># LOG.info(&#39;TN: ({}, {}) row {} pol {} is all flagged&#39;.format(ix, iy, row, ipol))</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">sqdist</span> <span class="o">&lt;=</span> <span class="n">min_distance</span><span class="p">[</span><span class="n">ipol</span><span class="p">]:</span>
                        <span class="n">rep_ids</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_id</span>

            <span class="c1"># LOG.info(&#39;TN: rep_ids for ({}, {}) is {}&#39;.format(ix, iy, rep_ids))</span>
            <span class="k">for</span> <span class="n">ipol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pol</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">rep_ids</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">masklist</span> <span class="o">=</span> <span class="n">datatable</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s1">&#39;MASKLIST&#39;</span><span class="p">,</span> <span class="n">rep_ids</span><span class="p">[</span><span class="n">ipol</span><span class="p">])</span>
                    <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">masklist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">masklist</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="k">else</span> <span class="n">masklist</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lines_map</span><span class="p">[</span><span class="n">ipol</span><span class="p">][</span><span class="n">ix</span><span class="p">][</span><span class="n">iy</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">lines_map</span></div>



<div class="viewcode-block" id="binned_mean_ma">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.binned_mean_ma.html#pipeline.hsd.tasks.baseline.plotter.binned_mean_ma">[docs]</a>
<span class="k">def</span> <span class="nf">binned_mean_ma</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">masked_data</span><span class="p">:</span> <span class="n">MaskedArray</span><span class="p">,</span>
                   <span class="n">nbin</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">MaskedArray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bin an array.</span>

<span class="sd">    Return an array of averaged values of masked_data in each bin.</span>
<span class="sd">    An element of binned_data is masked if any of elements in masked_data that</span>
<span class="sd">    contribute to the bin is masked.</span>

<span class="sd">    Args:</span>
<span class="sd">        x: Abcissa value of each element in masked_data.</span>
<span class="sd">        masked_data: Data to be binned. The length of array must be equal to that of x.</span>
<span class="sd">        nbin: Number of bins.</span>
<span class="sd">    Returns:</span>
<span class="sd">        Arrays of binned abcissa and binned data</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ndata</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masked_data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">nbin</span> <span class="o">&lt;</span> <span class="n">ndata</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">ndata</span>
    <span class="n">bin_width</span> <span class="o">=</span> <span class="n">ndata</span><span class="o">/</span><span class="n">nbin</span>  <span class="c1"># float</span>
    <span class="c1"># Prepare return values</span>
    <span class="n">binned_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">),</span> <span class="n">mask</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">binned_x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nbin</span><span class="p">)</span>
    <span class="n">min_i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nbin</span><span class="p">):</span>
        <span class="n">max_i</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">bin_width</span><span class="p">)),</span> <span class="n">ndata</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">num_masked</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">min_i</span><span class="p">:</span><span class="n">max_i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">num_masked</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;valid for flatness QA&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;will be excluded from the flatness QA&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;bin </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: masked channels </span><span class="si">{</span><span class="n">num_masked</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">binned_x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">min_i</span><span class="p">:</span><span class="n">max_i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">masked_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">min_i</span><span class="p">:</span><span class="n">max_i</span><span class="o">+</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">binned_data</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binned_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">masked_data</span><span class="p">[</span><span class="n">min_i</span><span class="p">:</span><span class="n">max_i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">min_i</span> <span class="o">=</span> <span class="n">max_i</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1"># mask NaN or Inf value</span>
    <span class="n">binned_data</span><span class="o">.</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">binned_data</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">binned_x</span><span class="p">,</span> <span class="n">binned_data</span></div>



<div class="viewcode-block" id="sort_with_key">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hsd.tasks.baseline.plotter.sort_with_key.html#pipeline.hsd.tasks.baseline.plotter.sort_with_key">[docs]</a>
<span class="k">def</span> <span class="nf">sort_with_key</span><span class="p">(</span> <span class="n">arr</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">reverse</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sort the list of dictionaries with the value of the specified key in each list component</span>

<span class="sd">    Args:</span>
<span class="sd">        arr     : input list of dictionaries</span>
<span class="sd">        key     : key to the value to sort with</span>
<span class="sd">        reverse : True to sort in reversed order, defaults to False</span>
<span class="sd">    Returns:</span>
<span class="sd">        sorted list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span> <span class="n">arr</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="n">reverse</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>