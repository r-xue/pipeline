

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hif.heuristics.auto_selfcal.selfcal_helpers &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Tasks (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hif.heuristics.auto_selfcal.selfcal_helpers</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hif.heuristics.auto_selfcal.selfcal_helpers</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module is an adaptation from the original auto_selfcal prototype.</span>

<span class="sd">see: https://github.com/jjtobin/auto_selfcal</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">casatools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">casatasks</span> <span class="kn">import</span> <span class="n">casalog</span>

<span class="kn">import</span> <span class="nn">pipeline.hif.heuristics.findrefant</span> <span class="k">as</span> <span class="nn">findrefant</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.casa_tasks</span> <span class="kn">import</span> <span class="n">casa_tasks</span> <span class="k">as</span> <span class="n">cts</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.casa_tools</span> <span class="kn">import</span> <span class="n">imager</span> <span class="k">as</span> <span class="n">im</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.casa_tools</span> <span class="kn">import</span> <span class="n">msmd</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.casa_tools</span> <span class="kn">import</span> <span class="n">table</span> <span class="k">as</span> <span class="n">tb</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.contfilehandler</span> <span class="kn">import</span> <span class="n">ContFileHandler</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="copy_products">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.copy_products">[docs]</a>
<span class="k">def</span> <span class="nf">copy_products</span><span class="p">(</span><span class="n">imagename_src</span><span class="p">,</span> <span class="n">imagename_dst</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Link the tclean products.</span>

<span class="sd">    This function is used to link the tclean products.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;copy tclean products: src- </span><span class="si">%s</span><span class="s1"> -&gt; dst- </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">imagename_src</span><span class="p">,</span> <span class="n">imagename_dst</span><span class="p">)</span>

    <span class="n">src_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">imagename_src</span><span class="o">+</span><span class="s1">&#39;.*&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">src_list</span><span class="p">:</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">imagename_src</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">imagename_dst</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dst</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_selfcal_logger">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_selfcal_logger">[docs]</a>
<span class="k">def</span> <span class="nf">get_selfcal_logger</span><span class="p">(</span><span class="n">loggername</span><span class="o">=</span><span class="s1">&#39;auto_selfcal&#39;</span><span class="p">,</span> <span class="n">loglevel</span><span class="o">=</span><span class="s1">&#39;DEBUG&#39;</span><span class="p">,</span> <span class="n">logfile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a named logger for auto_selfcal.</span>
<span class="sd">    </span>
<span class="sd">    When auto_selfcal runs outside of Pipeline, this function is a custom Python logger object</span>
<span class="sd">    as constructed below.</span>
<span class="sd">    When auto_selfcal runs as a Pipeline &quot;extern&quot; module, this function directly wraps around </span>
<span class="sd">    pipeline.infrastructure.get_logger</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">casalog</span><span class="o">.</span><span class="n">showconsole</span><span class="p">(</span><span class="n">onconsole</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logfile</span> <span class="o">=</span> <span class="n">casalog</span><span class="o">.</span><span class="n">logfile</span><span class="p">()</span>

    <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)s</span><span class="s1">    </span><span class="si">%(module)s</span><span class="s1">.</span><span class="si">%(funcName)s</span><span class="s1">     </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
    <span class="n">datefmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="nb">format</span><span class="p">,</span> <span class="n">datefmt</span><span class="p">)</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">converter</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">gmtime</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">loggername</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

    <span class="n">logfile_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">logfile_handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span>
    <span class="n">logfile_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logfile_handler</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">logger</span></div>



<div class="viewcode-block" id="fetch_scan_times">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.fetch_scan_times">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_scan_times</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="n">scantimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationtimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">n_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">min_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">spwslist_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spws_set_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scansdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">integrationsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">scantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]:</span>
                <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">scan</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="n">spws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforscan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">scan</span><span class="p">]</span> <span class="o">=</span> <span class="n">spws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">n_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">),</span> <span class="n">n_spws</span><span class="p">)</span>
                <span class="n">min_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spws</span><span class="p">),</span> <span class="n">min_spws</span><span class="p">)</span>
                <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span>
                <span class="n">integrationtime</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">exposuretime</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">spwid</span><span class="o">=</span><span class="n">spws</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">integrationtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrationtimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">integrationtime</span><span class="p">]))</span>
                <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">scantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="n">integrationtime</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
                <span class="n">ints_per_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scantime</span><span class="o">/</span><span class="n">integrationtimes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">scantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scantimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scantime</span><span class="p">]))</span>
                <span class="n">integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ints_per_scan</span><span class="p">]))</span>

            <span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">scantimes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># assume each band only has a single integration time</span>
            <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">integrationtimes</span><span class="p">)</span>
            <span class="n">integrationsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n_spws</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_spws</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Inconsistent number of spws in scans/MSes (possibly expected if multi-band VLA data or ALMA spectral scan)&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">min_spws</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_spws</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Inconsistent minimum spwid in scans/MSes (possibly expected if multi-band VLA data or ALMA spectral scan)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># jump through some hoops to get the dictionary that has spws per scan into a dictionary of unique</span>
    <span class="c1"># spw sets per vis file</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_list</span><span class="p">]</span>
        <span class="n">unique_spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_list</span><span class="p">)]</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_spws_set_list</span><span class="p">]</span>
        <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spws_set_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">integrationsdict</span><span class="p">,</span> <span class="n">integrationtimesdict</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_spws</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_spws</span><span class="p">),</span> <span class="n">spwslist_dict</span><span class="p">,</span> <span class="n">spws_set_dict</span></div>



<div class="viewcode-block" id="fetch_scan_times_band_aware">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.fetch_scan_times_band_aware">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_scan_times_band_aware</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">):</span>
    <span class="n">scantimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scanstartsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scanendsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationtimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">n_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">min_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">spwslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">spws_set_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mosaic_field</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scansdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scanendsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">integrationsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">scansforfield</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="c1"># scansforspw = msmd.scansforspw(band_properties[vis][band][&#39;spwarray&#39;][0])</span>
            <span class="c1"># scansdict[vis][target] = list(set(scansforfield) &amp; set(scansforspw))</span>
            <span class="c1"># scansdict[vis][target].sort()</span>
            <span class="c1"># only valid because we are assuming vislist is a single band/field</span>
            <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">scansforfield</span><span class="p">))</span>
            <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;field_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;mosaic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># mosaic_field[target][&#39;field_ids&#39;]=msmd.fieldsforname(target)</span>
            <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;field_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforscans</span><span class="p">(</span><span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;field_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;field_ids&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;field_ids&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mosaic_field</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;mosaic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">scantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">scanstarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">scanends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scansdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]:</span>
                <span class="n">spws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforscan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">scan</span><span class="p">]</span> <span class="o">=</span> <span class="n">spws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">n_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws</span><span class="p">),</span> <span class="n">n_spws</span><span class="p">)</span>
                <span class="n">min_spws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spws</span><span class="p">),</span> <span class="n">min_spws</span><span class="p">)</span>
                <span class="n">spwslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="n">spwslist</span><span class="p">)</span>
                <span class="n">integrationtime</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">exposuretime</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan</span><span class="p">,</span> <span class="n">spwid</span><span class="o">=</span><span class="n">spws</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">integrationtimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrationtimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">integrationtime</span><span class="p">]))</span>
                <span class="n">times</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                <span class="n">scantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="n">integrationtime</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
                <span class="n">scanstarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scanstarts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">/</span><span class="mf">86400.0</span><span class="p">]))</span>
                <span class="n">scanends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scanends</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">+</span><span class="n">integrationtime</span><span class="p">)</span><span class="o">/</span><span class="mf">86400.0</span><span class="p">]))</span>
                <span class="n">ints_per_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">scantime</span><span class="o">/</span><span class="n">integrationtimes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">scantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scantimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scantime</span><span class="p">]))</span>
                <span class="n">integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">integrations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ints_per_scan</span><span class="p">]))</span>

            <span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">scantimes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanstarts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">scanendsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanends</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># assume each band only has a single integration time</span>
            <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">integrationtimes</span><span class="p">)</span>
            <span class="n">integrationsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrations</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="c1"># jump through some hoops to get the dictionary that has spws per scan into a dictionary of unique</span>
    <span class="c1"># spw sets per vis file</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_list</span><span class="p">]</span>
        <span class="n">unique_spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spws_set_list</span><span class="p">)]</span>
        <span class="n">spws_set_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unique_spws_set_list</span><span class="p">]</span>
        <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spws_set_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">n_spws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n_spws</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_spws</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Inconsistent number of spws in scans/MSes (possibly expected if multi-band VLA data or ALMA spectral scan)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">min_spws</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">min_spws</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Inconsistent minimum spwid in scans/MSes (possibly expected if multi-band VLA data or ALMA spectral scan)&#39;</span><span class="p">)</span>
        <span class="n">spwslist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spwslist</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">scanstartsdict</span><span class="p">,</span> <span class="n">scanendsdict</span><span class="p">,</span> <span class="n">integrationsdict</span><span class="p">,</span> <span class="n">integrationtimesdict</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="o">-</span><span class="mi">99</span><span class="p">,</span> <span class="n">spwslist</span><span class="p">,</span> <span class="n">spws_set_dict</span><span class="p">,</span> <span class="n">mosaic_field</span>
    <span class="k">return</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">scanstartsdict</span><span class="p">,</span> <span class="n">scanendsdict</span><span class="p">,</span> <span class="n">integrationsdict</span><span class="p">,</span> <span class="n">integrationtimesdict</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_spws</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
        <span class="n">min_spws</span><span class="p">),</span> <span class="n">spwslist</span><span class="p">,</span> <span class="n">spws_set_dict</span><span class="p">,</span> <span class="n">mosaic_field</span></div>



<span class="c1"># actual routine used for getting solints</span>
<div class="viewcode-block" id="get_solints_simple">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_solints_simple">[docs]</a>
<span class="k">def</span> <span class="nf">get_solints_simple</span><span class="p">(</span>
        <span class="n">vislist</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">scanstartsdict</span><span class="p">,</span> <span class="n">scanendsdict</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">,</span> <span class="n">inf_EB_gaincal_combine</span><span class="p">,</span> <span class="n">spwcombine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">solint_decrement</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">,</span> <span class="n">solint_divider</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">n_solints</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">do_amp_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mosaic</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">all_integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">all_nscans_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">all_time_between_scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">all_times_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">allscantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>  <span class="c1"># we put all scan times from all MSes into single array</span>
    <span class="c1"># mix of short and long baseline data could have differing integration times and hence solints</span>
    <span class="c1"># could do solints per vis file, but too complex for now at least use perhaps keep scan groups different</span>
    <span class="c1"># per MOUS</span>
    <span class="n">nscans_per_obs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">time_per_vis</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">time_between_scans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">nscans_per_obs</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">time_between_scans</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">time_per_vis</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">integrationtimes</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">earliest_start</span> <span class="o">=</span> <span class="mf">1.0e10</span>
        <span class="n">latest_end</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
            <span class="n">nscans_per_obs</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="n">allscantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="c1"># way to get length of an EB with multiple targets without writing new functions; I could be more clever with np.where()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">earliest_start</span><span class="p">:</span>
                    <span class="n">earliest_start</span> <span class="o">=</span> <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">scanendsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">latest_end</span><span class="p">:</span>
                    <span class="n">latest_end</span> <span class="o">=</span> <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">integrationtimes</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">]):</span>
                <span class="n">all_integrations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_integrations</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="n">all_nscans_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_nscans_per_obs</span><span class="p">,</span> <span class="n">nscans_per_obs</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="c1"># determine time between scans</span>
            <span class="c1"># scan list isn&#39;t sorted, so sort these so they&#39;re in order and we can subtract them from each other</span>
            <span class="n">sortedstarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="n">sortedends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">scanstartsdict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
            <span class="c1"># delta_scan=(sortedends[:-1]-sortedstarts[1:])*86400.0*-1.0</span>
            <span class="n">delta_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortedends</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sortedstarts</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">delta_scan</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sortedends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">sortedstarts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">86400.0</span><span class="o">*-</span><span class="mf">1.0</span>
            <span class="n">all_time_between_scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_time_between_scans</span><span class="p">,</span> <span class="n">delta_scan</span><span class="p">)</span>
        <span class="n">time_per_vis</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">latest_end</span> <span class="o">-</span> <span class="n">earliest_start</span><span class="p">)</span><span class="o">*</span><span class="mf">86400.0</span>    <span class="c1"># calculate length of EB</span>
        <span class="n">all_times_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_times_per_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">time_per_vis</span><span class="p">[</span><span class="n">vis</span><span class="p">]]))</span>
    <span class="n">integration_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_integrations</span><span class="p">)</span>  <span class="c1"># use the longest integration time from all MS files</span>

    <span class="n">max_scantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">)</span>
    <span class="n">median_scantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">)</span>
    <span class="n">min_scantime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">)</span>
    <span class="n">median_scans_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_nscans_per_obs</span><span class="p">)</span>
    <span class="n">median_time_per_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_times_per_obs</span><span class="p">)</span>
    <span class="n">median_time_between_scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">all_time_between_scans</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;median scan length: </span><span class="si">{</span><span class="n">median_scantime</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;median time between target scans: </span><span class="si">{</span><span class="n">median_time_between_scans</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;median scans per observation: </span><span class="si">{</span><span class="n">median_scans_per_obs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;median length of observation: </span><span class="si">{</span><span class="n">median_time_per_obs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">solints_gt_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">gaincal_combine</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># commented completely, no solints between inf_EB and inf</span>
    <span class="c1"># make solints between inf_EB and inf if more than one scan per source and scans are short</span>
    <span class="c1"># if median_scans_per_obs &gt; 1 and median_scantime &lt; 150.0:</span>
    <span class="c1">#   # add one solint that is meant to combine 2 short scans, otherwise go to inf_EB</span>
    <span class="c1">#   solint=(median_scantime*2.0+median_time_between_scans)*1.1</span>
    <span class="c1">#   if solint &lt; 300.0:  # only allow solutions that are less than 5 minutes in duration</span>
    <span class="c1">#      solints_gt_scan=np.append(solints_gt_scan,[solint])</span>

    <span class="c1"># code below would make solints between inf_EB and inf by combining scans</span>
    <span class="c1"># sometimes worked ok, but many times selfcal would quit before solint=inf</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    solint=median_time_per_obs/4.05 # divides slightly unevenly if lengths of observation are exactly equal, but better than leaving a small out of data remaining</span>
<span class="sd">    while solint &gt; (median_scantime*2.0+median_time_between_scans)*1.05:      #solint should be greater than the length of time between two scans + time between to be better than inf</span>
<span class="sd">        solints_gt_scan=np.append(solints_gt_scan,[solint])                       # add solint to list of solints now that it is an integer number of integrations</span>
<span class="sd">        solint = solint/2.0  </span>
<span class="sd">        # LOG.info(&#39;Next solint: {solint}&#39;)                                        #divide solint by 2.0 for next solint</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">max_scantime</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">integration_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">solint_decrement</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
        <span class="n">solint_divider</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n_solints</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">max_scantime</span><span class="o">/</span><span class="n">integration_time</span><span class="p">)))</span>
    <span class="c1"># division never less than 2.0</span>
    <span class="k">if</span> <span class="n">solint_divider</span> <span class="o">&lt;</span> <span class="mf">2.0</span><span class="p">:</span>
        <span class="n">solint_divider</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="n">solints_lt_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="n">n_scans</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">)</span>
    <span class="n">solint</span> <span class="o">=</span> <span class="n">max_scantime</span><span class="o">/</span><span class="n">solint_divider</span>
    <span class="c1"># 1.1*integration_time will ensure that a single int will not be returned such that solint=&#39;int&#39; can be appended to the final list.</span>
    <span class="k">while</span> <span class="n">solint</span> <span class="o">&gt;</span> <span class="mf">1.90</span><span class="o">*</span><span class="n">integration_time</span><span class="p">:</span>
        <span class="n">ints_per_solint</span> <span class="o">=</span> <span class="n">solint</span><span class="o">/</span><span class="n">integration_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ints_per_solint</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
            <span class="c1"># calculate delta_T greater than an a fixed multile of integrations</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">ints_per_solint</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ints_per_solint</span><span class="p">))</span>
            <span class="n">solint</span> <span class="o">=</span> <span class="n">solint</span><span class="o">-</span><span class="n">remainder</span><span class="o">*</span><span class="n">integration_time</span>  <span class="c1"># add remainder to make solint a fixed number of integrations</span>

        <span class="n">ints_per_solint</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ints_per_solint</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Checking solint = </span><span class="si">{</span><span class="n">ints_per_solint</span><span class="o">*</span><span class="n">integration_time</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">test_truncated_scans</span><span class="p">(</span><span class="n">ints_per_solint</span><span class="p">,</span> <span class="n">allscantimes</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">)</span>
        <span class="n">solint</span> <span class="o">=</span> <span class="p">(</span><span class="n">ints_per_solint</span><span class="o">+</span><span class="n">delta</span><span class="p">)</span><span class="o">*</span><span class="n">integration_time</span>
        <span class="k">if</span> <span class="n">solint</span> <span class="o">&gt;</span> <span class="mf">1.90</span><span class="o">*</span><span class="n">integration_time</span><span class="p">:</span>
            <span class="c1"># add solint to list of solints now that it is an integer number of integrations</span>
            <span class="n">solints_lt_scan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solints_lt_scan</span><span class="p">,</span> <span class="p">[</span><span class="n">solint</span><span class="p">])</span>

        <span class="n">solint</span> <span class="o">=</span> <span class="n">solint</span><span class="o">/</span><span class="n">solint_divider</span>
        <span class="c1"># LOG.info(f&#39;Next solint: {solint}&#39;)                                        #divide solint by 2.0 for next solint</span>

    <span class="n">solints_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">solints_gt_scan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">solint</span> <span class="ow">in</span> <span class="n">solints_gt_scan</span><span class="p">:</span>
            <span class="n">solint_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solint</span><span class="p">)</span>
            <span class="n">solints_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solint_string</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
                <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;spw,scan&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;scan&#39;</span><span class="p">)</span>

    <span class="c1"># insert inf_EB</span>
    <span class="n">solints_list</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">)</span>
    <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inf_EB_gaincal_combine</span><span class="p">)</span>

    <span class="c1"># insert solint = inf</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">mosaic</span> <span class="ow">and</span> <span class="p">(</span><span class="n">median_scans_per_obs</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">median_scans_per_obs</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">max_scantime</span> <span class="o">/</span> <span class="n">min_scantime</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="ow">or</span> <span class="n">mosaic</span><span class="p">:</span>
        <span class="c1"># if only a single scan per target, redundant with inf_EB and do not include</span>
        <span class="n">solints_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
            <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">solint</span> <span class="ow">in</span> <span class="n">solints_lt_scan</span><span class="p">:</span>
        <span class="n">solint_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solint</span><span class="p">)</span>
        <span class="n">solints_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solint_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
            <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># append solint = int to end</span>
    <span class="n">solints_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
        <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;spw&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gaincal_combine</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">solmode_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">solints_list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">do_amp_selfcal</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">median_time_between_scans</span> <span class="o">&gt;</span> <span class="mf">150.0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">median_time_between_scans</span><span class="p">):</span>
            <span class="n">amp_solints_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;inf_ap&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
                <span class="n">amp_gaincal_combine</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">amp_gaincal_combine</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">amp_solints_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;300s_ap&#39;</span><span class="p">,</span> <span class="s1">&#39;inf_ap&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">spwcombine</span><span class="p">:</span>
                <span class="n">amp_gaincal_combine</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scan,spw&#39;</span><span class="p">,</span> <span class="s1">&#39;spw&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">amp_gaincal_combine</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">solints_list</span> <span class="o">=</span> <span class="n">solints_list</span><span class="o">+</span><span class="n">amp_solints_list</span>
        <span class="n">gaincal_combine</span> <span class="o">=</span> <span class="n">gaincal_combine</span><span class="o">+</span><span class="n">amp_gaincal_combine</span>
        <span class="n">solmode_list</span> <span class="o">=</span> <span class="n">solmode_list</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ap&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">amp_solints_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">solints_list</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">gaincal_combine</span><span class="p">,</span> <span class="n">solmode_list</span></div>



<div class="viewcode-block" id="test_truncated_scans">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.test_truncated_scans">[docs]</a>
<span class="k">def</span> <span class="nf">test_truncated_scans</span><span class="p">(</span><span class="n">ints_per_solint</span><span class="p">,</span> <span class="n">allscantimes</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">):</span>
    <span class="n">delta_ints_per_solint</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">n_truncated_scans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delta_ints_per_solint</span><span class="p">))</span>
    <span class="n">n_remaining_ints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">delta_ints_per_solint</span><span class="p">))</span>
    <span class="n">min_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">delta_ints</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">delta_ints_per_solint</span><span class="p">):</span>
        <span class="n">diff_ints_per_scan</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">allscantimes</span><span class="o">-</span><span class="p">((</span><span class="n">ints_per_solint</span><span class="o">+</span><span class="n">delta_ints</span><span class="p">)</span><span class="o">*</span><span class="n">integration_time</span><span class="p">))</span><span class="o">/</span><span class="n">integration_time</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">diff_ints_per_scan</span> <span class="o">=</span> <span class="n">diff_ints_per_scan</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">trimmed_scans</span> <span class="o">=</span> <span class="p">((</span><span class="n">diff_ints_per_scan</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">diff_ints_per_scan</span> <span class="o">&lt;</span>
                         <span class="n">ints_per_solint</span><span class="o">+</span><span class="n">delta_ints</span><span class="p">))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trimmed_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">n_remaining_ints</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">diff_ints_per_scan</span><span class="p">[</span><span class="n">trimmed_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_remaining_ints</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">n_truncated_scans</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trimmed_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n_truncated_scans</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">n_truncated_scans</span><span class="p">[</span><span class="n">min_index</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n_remaining_ints</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">n_remaining_ints</span><span class="p">[</span><span class="n">min_index</span><span class="p">])):</span>
            <span class="n">min_index</span> <span class="o">=</span> <span class="n">idx</span>

    <span class="k">return</span> <span class="n">delta_ints_per_solint</span><span class="p">[</span><span class="n">min_index</span><span class="p">]</span></div>



<div class="viewcode-block" id="fetch_targets">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.fetch_targets">[docs]</a>
<span class="k">def</span> <span class="nf">fetch_targets</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">fieldnames</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldnames</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">fieldnames</span><span class="p">:</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>  <span class="c1"># convert to set to only get unique items</span>
    <span class="k">return</span> <span class="n">fields</span></div>



<div class="viewcode-block" id="checkmask">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.checkmask">[docs]</a>
<span class="k">def</span> <span class="nf">checkmask</span><span class="p">(</span><span class="n">imagename</span><span class="p">):</span>
    <span class="n">maskImage</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tt0&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">maskImage</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">image_stats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">image_stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>



<div class="viewcode-block" id="estimate_SNR">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.estimate_SNR">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_SNR</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">MADtoRMS</span> <span class="o">=</span> <span class="mf">1.4826</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image_stats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">beammajor</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beamminor</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beampa</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">maskname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maskImage</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tt0&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maskImage</span> <span class="o">=</span> <span class="n">maskname</span>
    <span class="n">residualImage</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;residual&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf temp.mask temp.residual&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maskImage</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">maskImage</span> <span class="o">+</span> <span class="s1">&#39; temp.mask&#39;</span><span class="p">)</span>
        <span class="n">maskImage</span> <span class="o">=</span> <span class="s1">&#39;temp.mask&#39;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">residualImage</span> <span class="o">+</span> <span class="s1">&#39; temp.residual&#39;</span><span class="p">)</span>
    <span class="n">residualImage</span> <span class="o">=</span> <span class="s1">&#39;temp.residual&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;dirty&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">imagename</span><span class="p">:</span>
        <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">goodMask</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maskImage</span><span class="p">)</span> <span class="ow">and</span> <span class="n">goodMask</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">residualImage</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">calcmask</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">maskImage</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s2">&quot; &lt;0.5&quot;</span><span class="o">+</span><span class="s2">&quot;&amp;&amp; mask(&quot;</span><span class="o">+</span><span class="n">residualImage</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;madpbmask0&#39;</span><span class="p">)</span>
            <span class="n">mask0Stats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">image</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;madpbmask0&#39;</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">mask0Stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">MADtoRMS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;residual&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;chauvenet&#39;</span><span class="p">)[</span><span class="s1">&#39;rms&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">peak_intensity</span> <span class="o">=</span> <span class="n">image_stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SNR</span> <span class="o">=</span> <span class="n">peak_intensity</span><span class="o">/</span><span class="n">rms</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">imagename</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Beam </span><span class="si">%.3f</span><span class="s2"> arcsec x </span><span class="si">%.3f</span><span class="s2"> arcsec (</span><span class="si">%.2f</span><span class="s2"> deg)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beammajor</span><span class="p">,</span> <span class="n">beamminor</span><span class="p">,</span> <span class="n">beampa</span><span class="p">))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Peak intensity of source: </span><span class="si">%.2f</span><span class="s2"> mJy/beam&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_intensity</span><span class="o">*</span><span class="mi">1000</span><span class="p">,))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#rms: </span><span class="si">%.2e</span><span class="s2"> mJy/beam&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rms</span><span class="o">*</span><span class="mi">1000</span><span class="p">,))</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Peak SNR: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SNR</span><span class="p">,))</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;temp.mask&#39;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="s1">&#39;temp.residual&#39;</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">rms</span></div>



<div class="viewcode-block" id="estimate_near_field_SNR">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.estimate_near_field_SNR">[docs]</a>
<span class="k">def</span> <span class="nf">estimate_near_field_SNR</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">MADtoRMS</span> <span class="o">=</span> <span class="mf">1.4826</span>

    <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;temp.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.residual&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.border.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.smooth.ceiling.mask&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;temp.smooth.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.nearfield.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.big.smooth.ceiling.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.radius&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;temp.delta&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.nearfield.prepb.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.big.smooth.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.beam.extent.image&#39;</span><span class="p">]</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">image_stats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">beammajor</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beamminor</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beampa</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">maskname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">maskImage</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tt0&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maskImage</span> <span class="o">=</span> <span class="n">maskname</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maskImage</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Does not exist&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

    <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">maskImage</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">goodMask</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The mask file </span><span class="si">%s</span><span class="s1"> is empty.&#39;</span><span class="p">,</span> <span class="n">maskImage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>

    <span class="c1"># PIPE-2258: use restored image for SNR calculation (GH:419a80a)</span>
    <span class="n">residualImage</span> <span class="o">=</span> <span class="n">imagename</span>

    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">temp_list</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">maskImage</span> <span class="o">+</span> <span class="s1">&#39; temp.mask&#39;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">residualImage</span> <span class="o">+</span> <span class="s1">&#39; temp.residual&#39;</span><span class="p">)</span>
    <span class="n">residualImage</span> <span class="o">=</span> <span class="s1">&#39;temp.residual&#39;</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">imsmooth</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="s1">&#39;temp.mask&#39;</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">beammajor</span><span class="o">*</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span>
                 <span class="n">minor</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">beammajor</span><span class="o">*</span><span class="mf">1.0</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="s1">&#39;0deg&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.smooth.mask&#39;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp.smooth.mask&#39;</span><span class="p">],</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;iif(IM0 &gt; 0.1*max(IM0),1.0,0.0)&#39;</span><span class="p">,</span>
               <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.smooth.ceiling.mask&#39;</span><span class="p">)</span>

    <span class="c1"># Check the extent of the beam as well.</span>
    <span class="n">psfImage</span> <span class="o">=</span> <span class="n">maskImage</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;psf&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.tt0&#39;</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">psfImage</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;evalexpr&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;iif(IM0==1,IM0,0)&quot;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;temp.delta&quot;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">imsmooth</span><span class="p">(</span><span class="s2">&quot;temp.delta&quot;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">npix</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;pix&quot;</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">npix</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;pix&quot;</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="s2">&quot;0deg&quot;</span><span class="p">,</span>
                 <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;temp.radius&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">imhead</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="s2">&quot;temp.radius&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;put&quot;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s2">&quot;BMIN&quot;</span><span class="p">,</span> <span class="n">hdvalue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">beamminor</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;arcsec&quot;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">imhead</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="s2">&quot;temp.radius&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;put&quot;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s2">&quot;BMAJ&quot;</span><span class="p">,</span> <span class="n">hdvalue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">beammajor</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;arcsec&quot;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">imhead</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="s2">&quot;temp.radius&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;put&quot;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s2">&quot;BPA&quot;</span><span class="p">,</span> <span class="n">hdvalue</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">beampa</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="n">psfImage</span><span class="p">,</span> <span class="s1">&#39;temp.radius&#39;</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;evalexpr&quot;</span><span class="p">,</span> <span class="n">expr</span><span class="o">=</span><span class="s2">&quot;iif(IM0 &gt; 0.1,1/IM1,0.0)&quot;</span><span class="p">,</span>
               <span class="n">outfile</span><span class="o">=</span><span class="s2">&quot;temp.beam.extent.image&quot;</span><span class="p">)</span>

    <span class="n">centerpos</span> <span class="o">=</span> <span class="n">cts</span><span class="o">.</span><span class="n">imhead</span><span class="p">(</span><span class="n">psfImage</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s2">&quot;maxpixpos&quot;</span><span class="p">)</span>
    <span class="n">maxpos</span> <span class="o">=</span> <span class="n">cts</span><span class="o">.</span><span class="n">imhead</span><span class="p">(</span><span class="s2">&quot;temp.beam.extent.image&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="n">hdkey</span><span class="o">=</span><span class="s2">&quot;maxpixpos&quot;</span><span class="p">)</span>
    <span class="n">center_coords</span> <span class="o">=</span> <span class="n">cts</span><span class="o">.</span><span class="n">imval</span><span class="p">(</span><span class="n">psfImage</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">centerpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">centerpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>
    <span class="n">max_coords</span> <span class="o">=</span> <span class="n">cts</span><span class="o">.</span><span class="n">imval</span><span class="p">(</span><span class="n">psfImage</span><span class="p">,</span> <span class="n">box</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">maxpos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s2">&quot;,&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">maxpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span>

    <span class="n">beam_extent_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">center_coords</span> <span class="o">-</span> <span class="n">max_coords</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="mi">360</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="c1"># use the maximum of the three possibilities as the outer extent of the mask.</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;beammajor*5 = </span><span class="si">%f</span><span class="s2">, LAS = </span><span class="si">%f</span><span class="s2">, beam_extent = </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">beammajor</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">las</span><span class="p">,</span> <span class="n">beam_extent_size</span><span class="p">)</span>
    <span class="n">outer_major</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">beammajor</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">beam_extent_size</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">las</span> <span class="k">if</span> <span class="n">las</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">imsmooth</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="s1">&#39;temp.smooth.ceiling.mask&#39;</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">outer_major</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span>
                 <span class="n">minor</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">outer_major</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;arcsec&#39;</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="s1">&#39;0deg&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.big.smooth.mask&#39;</span><span class="p">)</span>

    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp.big.smooth.mask&#39;</span><span class="p">],</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;iif(IM0 &gt; 0.01*max(IM0),1.0,0.0)&#39;</span><span class="p">,</span>
               <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.big.smooth.ceiling.mask&#39;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp.big.smooth.ceiling.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;temp.smooth.ceiling.mask&#39;</span><span class="p">],</span>
               <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;((IM0-IM1)-1.0)*-1.0&#39;</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.nearfield.prepb.mask&#39;</span><span class="p">)</span>
    <span class="n">cts</span><span class="o">.</span><span class="n">immath</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="p">[</span><span class="n">imagename</span><span class="p">,</span> <span class="s1">&#39;temp.nearfield.prepb.mask&#39;</span><span class="p">],</span> <span class="n">expr</span><span class="o">=</span><span class="s1">&#39;iif(MASK(IM0),IM1,1.0)&#39;</span><span class="p">,</span>
               <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;temp.nearfield.mask&#39;</span><span class="p">)</span>

    <span class="n">maskImage</span> <span class="o">=</span> <span class="s1">&#39;temp.nearfield.mask&#39;</span>
    <span class="n">mask_stats</span> <span class="o">=</span> <span class="n">cts</span><span class="o">.</span><span class="n">imstat</span><span class="p">(</span><span class="n">maskImage</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_stats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;checkmask&#39;</span><span class="p">)</span>
        <span class="n">SNR</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="o">-</span><span class="mf">99.0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">residualImage</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">calcmask</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="n">maskImage</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="o">+</span><span class="s2">&quot; &lt;0.5&quot;</span><span class="o">+</span><span class="s2">&quot;&amp;&amp; mask(&quot;</span><span class="o">+</span><span class="n">residualImage</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;madpbmask0&#39;</span><span class="p">)</span>
            <span class="n">mask0Stats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">image</span><span class="o">.</span><span class="n">maskhandler</span><span class="p">(</span><span class="n">op</span><span class="o">=</span><span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;madpbmask0&#39;</span><span class="p">)</span>
        <span class="n">rms</span> <span class="o">=</span> <span class="n">mask0Stats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">MADtoRMS</span>
        <span class="n">peak_intensity</span> <span class="o">=</span> <span class="n">image_stats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">SNR</span> <span class="o">=</span> <span class="n">peak_intensity</span><span class="o">/</span><span class="n">rms</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">imagename</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Beam </span><span class="si">%.3f</span><span class="s2"> arcsec x </span><span class="si">%.3f</span><span class="s2"> arcsec (</span><span class="si">%.2f</span><span class="s2"> deg)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">beammajor</span><span class="p">,</span> <span class="n">beamminor</span><span class="p">,</span> <span class="n">beampa</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Peak intensity of source: </span><span class="si">%.2f</span><span class="s2"> mJy/beam&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peak_intensity</span><span class="o">*</span><span class="mi">1000</span><span class="p">,))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Near Field rms: </span><span class="si">%.2e</span><span class="s2"> mJy/beam&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rms</span><span class="o">*</span><span class="mi">1000</span><span class="p">,))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;#Peak Near Field SNR: </span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">SNR</span><span class="p">,))</span>

    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp -r &#39;</span><span class="o">+</span><span class="n">maskImage</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;nearfield.mask&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tt0&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="n">temp_list</span><span class="p">:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">rms</span></div>



<div class="viewcode-block" id="get_intflux">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_intflux">[docs]</a>
<span class="k">def</span> <span class="nf">get_intflux</span><span class="p">(</span><span class="n">imagename</span><span class="p">,</span> <span class="n">rms</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bmaj_arcsec</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">bmin_arcsec</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="n">cdelt12_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span><span class="o">.</span><span class="n">increment</span><span class="p">()[</span><span class="s1">&#39;numeric&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span><span class="o">*</span><span class="mf">3600.0</span>
        <span class="n">beamarea</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">bmaj_arcsec</span><span class="o">*</span><span class="n">bmin_arcsec</span><span class="o">/</span><span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="n">cellarea</span> <span class="o">=</span> <span class="n">cdelt12_arcsec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">cdelt12_arcsec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pix_per_beam</span> <span class="o">=</span> <span class="n">beamarea</span><span class="o">/</span><span class="n">cellarea</span>

        <span class="k">if</span> <span class="n">maskname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">try_mask</span> <span class="o">=</span> <span class="n">imagename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;image.tt0&quot;</span><span class="p">,</span> <span class="s2">&quot;mask&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">try_mask</span> <span class="o">=</span> <span class="n">maskname</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">try_mask</span><span class="p">):</span>
            <span class="c1"># PIPE-2144: wrap the mask image name with quotation marks and avoid the ambiguity</span>
            <span class="c1"># when casatools evaluates the lattice expression.</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">try_mask</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The integrated flux is being calculated without a valid external mask file.&#39;</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">imagestats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imagestats</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">imagestats</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">n_beams</span> <span class="o">=</span> <span class="n">imagestats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">pix_per_beam</span>
        <span class="n">e_flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_beams</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="n">rms</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">e_flux</span> <span class="o">=</span> <span class="n">rms</span>

    <span class="k">return</span> <span class="n">flux</span><span class="p">,</span> <span class="n">e_flux</span></div>



<div class="viewcode-block" id="get_n_ants">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_n_ants">[docs]</a>
<span class="k">def</span> <span class="nf">get_n_ants</span><span class="p">(</span><span class="n">vislist</span><span class="p">):</span>
    <span class="c1"># Examines number of antennas in each ms file and returns the minimum number of antennas</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">msmetadata</span><span class="p">()</span>

    <span class="n">n_ants</span> <span class="o">=</span> <span class="mf">50.0</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennanames</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">n_ant_vis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_ant_vis</span> <span class="o">&lt;</span> <span class="n">n_ants</span><span class="p">:</span>
            <span class="n">n_ants</span> <span class="o">=</span> <span class="n">n_ant_vis</span>
    <span class="k">return</span> <span class="n">n_ants</span></div>



<div class="viewcode-block" id="get_ant_list">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_ant_list">[docs]</a>
<span class="k">def</span> <span class="nf">get_ant_list</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
    <span class="c1"># Examines number of antennas in each ms file and returns the minimum number of antennas</span>
    <span class="n">msmd</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">msmetadata</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennanames</span><span class="p">()</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">names</span></div>



<div class="viewcode-block" id="rank_refants">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.rank_refants">[docs]</a>
<span class="k">def</span> <span class="nf">rank_refants</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">refantignore</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rank the reference antenna for a measurement set.&quot;&quot;&quot;</span>

    <span class="n">refantobj</span> <span class="o">=</span> <span class="n">findrefant</span><span class="o">.</span><span class="n">RefAntHeuristics</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                            <span class="n">geometry</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flagging</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                            <span class="n">refantignore</span><span class="o">=</span><span class="n">refantignore</span><span class="p">)</span>
    <span class="n">refant_list</span> <span class="o">=</span> <span class="n">refantobj</span><span class="o">.</span><span class="n">calculate</span><span class="p">()</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;refant list for </span><span class="si">{</span><span class="n">vis</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">refant_list</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refant_list</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_SNR_self">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_SNR_self">[docs]</a>
<span class="k">def</span> <span class="nf">get_SNR_self</span><span class="p">(</span>
        <span class="n">all_targets</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">n_ant</span><span class="p">,</span> <span class="n">solints</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">inf_EB_gaincal_combine</span><span class="p">,</span>
        <span class="n">inf_EB_gaintype</span><span class="p">):</span>
    <span class="n">solint_snr</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">solint_snr_per_spw</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">inf_EB_gaintype</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span>
        <span class="n">polscale</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">polscale</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
        <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">solint</span> <span class="ow">in</span> <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">]:</span>
                <span class="c1"># code to work around some VLA data not having the same number of spws due to missing BlBPs</span>
                <span class="c1"># selects spwlist from the visibilities with the greates number of spws</span>
                <span class="n">maxspws</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">maxspwvis</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_spws&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">maxspws</span><span class="p">:</span>
                        <span class="n">maxspws</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_spws&#39;</span><span class="p">]</span>
                        <span class="n">maxspwvis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                    <span class="n">SNR_self_EB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">))</span>
                    <span class="n">SNR_self_EB_spw</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)):</span>
                        <span class="n">SNR_self_EB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="n">n_ant</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;TOS&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                        <span class="n">SNR_self_EB_spw</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">SNR_self_EB_spw</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">SNR_self_EB_spw</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">polscale</span><span class="p">)</span> <span class="o">**</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                    <span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span>
                                                         <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span>
                                                          <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;TOS&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>
                                    <span class="p">[</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">/</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
                        <span class="n">mean_SNR</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)):</span>
                            <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">SNR_self_EB_spw</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">mean_SNR</span> <span class="o">+=</span> <span class="n">SNR_self_EB_spw</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">j</span><span class="p">]][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span>
                        <span class="n">mean_SNR</span> <span class="o">=</span> <span class="n">mean_SNR</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)</span>
                        <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mean_SNR</span>
                    <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">SNR_self_EB</span><span class="p">)</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_EB_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">SNR_self_EB</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">or</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_ap&#39;</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_scan_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">((</span><span class="n">n_ant</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Median_scan_time&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_scan_SNR&#39;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
                        <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                            <span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span>
                                           <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span>
                                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Median_scan_time&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">/</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="k">elif</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
                    <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> \
                        <span class="p">((</span><span class="n">n_ant</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">integration_time</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
                        <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                            <span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span>
                                           <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">integration_time</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">/</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">solint_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_ap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> \
                        <span class="p">((</span><span class="n">n_ant</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">solint_float</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
                        <span class="n">solint_snr_per_spw</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">solint_float</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">/</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">maxspwvis</span><span class="p">][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">solint_snr</span><span class="p">,</span> <span class="n">solint_snr_per_spw</span></div>



<div class="viewcode-block" id="get_SNR_self_update">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_SNR_self_update">[docs]</a>
<span class="k">def</span> <span class="nf">get_SNR_self_update</span><span class="p">(</span>
        <span class="n">all_targets</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">n_ant</span><span class="p">,</span> <span class="n">solint_curr</span><span class="p">,</span> <span class="n">solint_next</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">solint_snr</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">solint_next</span> <span class="o">==</span> <span class="s1">&#39;inf&#39;</span> <span class="ow">or</span> <span class="n">solint_next</span> <span class="o">==</span> <span class="s1">&#39;inf_ap&#39;</span><span class="p">:</span>
            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_scan_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint_curr</span><span class="p">][</span><span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span>
                <span class="p">(</span><span class="n">n_ant</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Median_scan_time&#39;</span><span class="p">])</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint_next</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_scan_SNR&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">solint_next</span> <span class="o">==</span> <span class="s1">&#39;int&#39;</span><span class="p">:</span>
            <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint_next</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint_curr</span><span class="p">][</span>
                <span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">integration_time</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">solint_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solint_next</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_ap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint_next</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint_curr</span><span class="p">][</span>
                <span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">((</span><span class="n">n_ant</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">solint_float</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_sensitivity">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_sensitivity">[docs]</a>
<span class="k">def</span> <span class="nf">get_sensitivity</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="n">virtual_spw</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                    <span class="n">chan</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="s1">&#39;0.025arcsec&#39;</span><span class="p">,</span> <span class="n">imsize</span><span class="o">=</span><span class="mi">1600</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>

    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">virtual_spw</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">selectvis</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">selectvis</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="s1">&#39;spw_map&#39;</span><span class="p">][</span><span class="n">virtual_spw</span><span class="p">][</span><span class="n">vis</span><span class="p">])</span>

    <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">defineimage</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">specmode</span><span class="p">,</span> <span class="n">stokes</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">cellx</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">celly</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">nx</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span> <span class="n">ny</span><span class="o">=</span><span class="n">imsize</span><span class="p">)</span>
    <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;briggs&#39;</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uvtaper</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;klambda&#39;</span> <span class="ow">in</span> <span class="n">uvtaper</span><span class="p">:</span>
            <span class="n">uvtaper</span> <span class="o">=</span> <span class="n">uvtaper</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;klambda&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">uvtaperflt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="mf">206.0</span><span class="o">/</span><span class="n">uvtaperflt</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;arcsec&#39;</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="n">bmaj</span>
            <span class="n">bpa</span> <span class="o">=</span> <span class="s1">&#39;0.0deg&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;arcsec&#39;</span> <span class="ow">in</span> <span class="n">uvtaper</span><span class="p">:</span>
            <span class="n">bmaj</span> <span class="o">=</span> <span class="n">uvtaper</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="n">uvtaper</span>
            <span class="n">bpa</span> <span class="o">=</span> <span class="s1">&#39;0.0deg&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;uvtaper: &#39;</span><span class="o">+</span><span class="n">bmaj</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">bmin</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">bpa</span><span class="p">)</span>
        <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="o">=</span><span class="n">bpa</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">estsens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">apparentsens</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# Sensisitivity Calculation failed for </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">vislist</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;# Data in MS may be flagged&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Estimated Sensitivity: </span><span class="si">{</span><span class="n">estsens</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">estsens</span></div>



<div class="viewcode-block" id="parse_contdotdat">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.parse_contdotdat">[docs]</a>
<span class="k">def</span> <span class="nf">parse_contdotdat</span><span class="p">(</span><span class="n">contdotdat_file</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse the continuum frequency range specified in cont.dat.</span>

<span class="sd">    This function mimics the output of the &quot;parse_contdot_dat&quot; helper function </span>
<span class="sd">    from GH:auto_selfcal.selfcal_helpers.</span>

<span class="sd">    Args:</span>
<span class="sd">        contdotdat_file (str): Path to the cont.dat file.</span>
<span class="sd">        target (str): The target field to parse from the cont.dat file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A dictionary where keys are virtual spw ids (integers) and values are </span>
<span class="sd">        numpy arrays of frequency ranges.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        CASA &lt;30&gt;: from pipeline.hif.heuristics.auto_selfcal.selfcal_helpers import parse_contdotdat</span>
<span class="sd">            ...: contfile=&#39;cont.dat&#39;</span>
<span class="sd">            ...: contdotdat=parse_contdotdat(contfile,&#39;helms30&#39;)</span>
<span class="sd">            ...: pprint(contdotdat)</span>
<span class="sd">        {16: array([[214.48924823, 215.08298911],</span>
<span class="sd">                    [215.28611099, 216.19234708]]),</span>
<span class="sd">         18: array([[216.36433767, 218.0986862 ]]),</span>
<span class="sd">         20: array([[232.48638245, 234.22073239]]),</span>
<span class="sd">         22: array([[230.61129118, 232.34564096]])}</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contfile_handler</span> <span class="o">=</span> <span class="n">ContFileHandler</span><span class="p">(</span><span class="n">contdotdat_file</span><span class="p">)</span>
    <span class="n">contdict</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">warn_nonexist</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span>

    <span class="n">contdotdat</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">contdict</span><span class="p">:</span>
        <span class="n">contdict_field</span> <span class="o">=</span> <span class="n">contdict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
        <span class="n">contdotdat</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rg</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;ranges&#39;</span><span class="p">]])</span>
                      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">contdict_field</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">return</span> <span class="n">contdotdat</span></div>



<div class="viewcode-block" id="get_spw_chanwidths">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_chanwidths">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_chanwidths</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spwarray</span><span class="p">):</span>
    <span class="n">widtharray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwarray</span><span class="p">))</span>
    <span class="n">bwarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwarray</span><span class="p">))</span>
    <span class="n">nchanarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwarray</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwarray</span><span class="p">)):</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span>
        <span class="n">widtharray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CHAN_WIDTH&#39;</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">spwarray</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">bwarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TOTAL_BANDWIDTH&#39;</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">spwarray</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">nchanarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NUM_CHAN&#39;</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">spwarray</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">widtharray</span><span class="p">,</span> <span class="n">bwarray</span><span class="p">,</span> <span class="n">nchanarray</span></div>



<div class="viewcode-block" id="get_spw_bandwidth">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_bandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_bandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">vislist</span><span class="p">):</span>
    <span class="n">spwbws</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwsarray_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]:</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span>
        <span class="n">spwbws</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TOTAL_BANDWIDTH&#39;</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)))[</span>
            <span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">1.0e9</span>  <span class="c1"># put bandwidths into GHz</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">spweffbws</span> <span class="o">=</span> <span class="n">spwbws</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;cont.dat&quot;</span><span class="p">):</span>
        <span class="n">spweffbws</span> <span class="o">=</span> <span class="n">get_spw_eff_bandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spwbws</span><span class="p">,</span> <span class="n">spweffbws</span></div>



<div class="viewcode-block" id="get_spw_eff_bandwidth">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_eff_bandwidth">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_eff_bandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">):</span>
    <span class="n">spweffbws</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">contdotdat</span> <span class="o">=</span> <span class="n">parse_contdotdat</span><span class="p">(</span><span class="s1">&#39;cont.dat&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">spwvisref</span> <span class="o">=</span> <span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">contdotdat</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">spwvisref</span><span class="p">)</span>
        <span class="n">spwname</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">namesforspws</span><span class="p">(</span><span class="n">key</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsfornames</span><span class="p">(</span><span class="n">spwname</span><span class="p">)</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">trans_spw</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># must directly cast to int, otherwise the CASA tool call does not like numpy.uint64</span>
        <span class="c1"># loop through returned spws to see which is in the spw array rather than assuming, because assumptions be damned</span>
        <span class="k">for</span> <span class="n">check_spw</span> <span class="ow">in</span> <span class="n">spws</span><span class="p">[</span><span class="n">spwname</span><span class="p">]:</span>
            <span class="n">matching_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">check_spw</span> <span class="o">==</span> <span class="n">spwsarray_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trans_spw</span> <span class="o">=</span> <span class="n">check_spw</span>
                <span class="k">break</span>
        <span class="c1"># trans_spw=int(np.max(spws[spwname])) # assume higher number spw is the correct one, generally true with ALMA data structure</span>
        <span class="n">cumulat_bw</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contdotdat</span><span class="p">[</span><span class="n">key</span><span class="p">])):</span>
            <span class="n">cumulat_bw</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">contdotdat</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">contdotdat</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">spweffbws</span><span class="p">[</span><span class="n">trans_spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulat_bw</span><span class="o">+</span><span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">spweffbws</span></div>



<div class="viewcode-block" id="get_spw_chanavg">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_chanavg">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_chanavg</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">widtharray</span><span class="p">,</span> <span class="n">bwarray</span><span class="p">,</span> <span class="n">chanarray</span><span class="p">,</span> <span class="n">desiredWidth</span><span class="o">=</span><span class="mf">15.625e6</span><span class="p">):</span>
    <span class="n">avgarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">widtharray</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">widtharray</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">desiredWidth</span> <span class="o">&gt;</span> <span class="n">bwarray</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">bwarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">desiredWidth</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>
            <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">chanarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">nchan</span>
        <span class="k">if</span> <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">avgarray</span></div>



<div class="viewcode-block" id="get_spw_map">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_map">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_map</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="p">):</span>
    <span class="c1"># Get the list of EBs from the selfcal_library</span>
    <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># If we are looking at VLA data, find the EB with the maximum number of SPWs so that we have the fewest &quot;odd man out&quot; SPWs hanging out at the end as possible.</span>
    <span class="k">if</span> <span class="s2">&quot;VLA&quot;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
        <span class="n">maxspws</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maxspwvis</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_spws&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">maxspws</span><span class="p">:</span>
                <span class="n">maxspws</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_spws&#39;</span><span class="p">]</span>
                <span class="n">maxspwvis</span> <span class="o">=</span> <span class="n">vis</span><span class="o">+</span><span class="s1">&#39;&#39;</span>

        <span class="n">vislist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">maxspwvis</span><span class="p">)</span>
        <span class="n">vislist</span> <span class="o">=</span> <span class="p">[</span><span class="n">maxspwvis</span><span class="p">]</span> <span class="o">+</span> <span class="n">vislist</span>

    <span class="n">spw_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">virtual_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># This code is meant to be generic in order to prepare for cases where multiple EBs might have unique SPWs in them (e.g. inhomogeneous data),</span>
    <span class="c1"># but the criterea for which SPWs match will need to be updated for this to truly generalize.</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]:</span>
            <span class="n">found_match</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">spw_map</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">vis</span> <span class="o">==</span> <span class="n">v</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s2">&quot;ALMA&quot;</span> <span class="ow">or</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s2">&quot;ACA&quot;</span><span class="p">:</span>
                        <span class="c1"># NOTE: This assumes that matching based on SPW name is ok. Fine for now... but will need to update this for inhomogeneous data.</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                        <span class="n">spwname</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">namesforspws</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">sname</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">namesforspws</span><span class="p">(</span><span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">spwname</span> <span class="o">==</span> <span class="n">sname</span><span class="p">:</span>
                            <span class="n">found_match</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                        <span class="n">bandwidth1</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
                        <span class="n">chanwidth1</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanwidths</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">chanfreq1</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">bandwidth2</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">(</span><span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">v</span><span class="p">])</span>
                        <span class="n">chanwidth2</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanwidths</span><span class="p">(</span><span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">chanfreq2</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">v</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">bandwidth1</span> <span class="o">==</span> <span class="n">bandwidth2</span> <span class="ow">and</span> <span class="n">chanwidth1</span> <span class="o">==</span> <span class="n">chanwidth2</span> <span class="ow">and</span> <span class="n">chanfreq1</span> <span class="o">==</span> <span class="n">chanfreq2</span><span class="p">:</span>
                            <span class="n">found_match</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">found_match</span><span class="p">:</span>
                        <span class="n">spw_map</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="n">found_match</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_match</span><span class="p">:</span>
                <span class="n">spw_map</span><span class="p">[</span><span class="n">virtual_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">spw_map</span><span class="p">[</span><span class="n">virtual_index</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw</span>
                <span class="n">virtual_index</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;spw_map: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">spw_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">spw_map</span></div>



<div class="viewcode-block" id="get_image_parameters">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_image_parameters">[docs]</a>
<span class="k">def</span> <span class="nf">get_image_parameters</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">telescope</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">):</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)):</span>
        <span class="c1"># im.open(vislist[i])</span>
        <span class="n">im</span><span class="o">.</span><span class="n">selectvis</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">spw</span><span class="o">=</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">])</span>
        <span class="n">adviseparams</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">advise</span><span class="p">()</span>
        <span class="n">cells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adviseparams</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">im</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
    <span class="n">cellsize</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:0.3f}</span><span class="s1">arcsec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
    <span class="n">nterms</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">nterms</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">if</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mf">45.0e9</span><span class="o">/</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">60.0</span><span class="o">*</span><span class="mf">1.5</span>
        <span class="k">if</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">12.0e9</span><span class="p">:</span>
            <span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span><span class="o">*</span><span class="mf">2.0</span>
    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mf">63.0</span><span class="o">*</span><span class="mf">100.0e9</span><span class="o">/</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span>
    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="mf">108.0</span><span class="o">*</span><span class="mf">100.0e9</span><span class="o">/</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.5</span>
    <span class="n">npixels</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fov</span><span class="o">/</span><span class="n">cell</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">if</span> <span class="n">npixels</span> <span class="o">&gt;</span> <span class="mi">16384</span><span class="p">:</span>
        <span class="n">npixels</span> <span class="o">=</span> <span class="mi">16384</span>
    <span class="k">return</span> <span class="n">cellsize</span><span class="p">,</span> <span class="n">npixels</span><span class="p">,</span> <span class="n">nterms</span></div>



<div class="viewcode-block" id="get_nterms">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_nterms">[docs]</a>
<span class="k">def</span> <span class="nf">get_nterms</span><span class="p">(</span><span class="n">fracbw</span><span class="p">,</span> <span class="n">nt1snr</span><span class="o">=</span><span class="mf">3.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get nterm based on fracbw and nt1snr.</span>

<span class="sd">    see PIPE-1772.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">func_cubic</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="n">B</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="n">C</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">D</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">E</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">F</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">G</span><span class="o">*</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">H</span>

    <span class="n">nterms</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">fracbw</span> <span class="o">&gt;=</span> <span class="mf">0.1</span><span class="p">:</span>
        <span class="n">nterms</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nt1snr</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">:</span>
            <span class="c1"># Estimate the gain of going to nterms=2 based on nterms=1 S/N and fracbw</span>
            <span class="c1"># The coefficients come from a empirical fit using simulated data with a spectral index of 3</span>
            <span class="n">A1</span> <span class="o">=</span> <span class="mf">2336.415</span>
            <span class="n">B1</span> <span class="o">=</span> <span class="mf">0.051</span>
            <span class="n">C1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">306.590</span>
            <span class="n">D1</span> <span class="o">=</span> <span class="mf">5.654</span>
            <span class="n">E1</span> <span class="o">=</span> <span class="mf">28.220</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">23.598</span>
            <span class="n">G1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.594</span>
            <span class="n">H1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.413</span>
            <span class="c1"># Note that we fit the log10 of S/N_nt1 and [S/N_nt2 - S/N_nt1]/(S/N_nt1)</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">func_cubic</span><span class="p">([</span><span class="n">fracbw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">nt1snr</span><span class="p">)],</span> <span class="n">A1</span><span class="p">,</span> <span class="n">B1</span><span class="p">,</span> <span class="n">C1</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span> <span class="n">E1</span><span class="p">,</span> <span class="n">F1</span><span class="p">,</span> <span class="n">G1</span><span class="p">,</span> <span class="n">H1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">Z</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
                <span class="n">nterms</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fracbw = </span><span class="si">{:0.3f}</span><span class="s1">, nt1snr = </span><span class="si">{:0.3f}</span><span class="s1">: nterms = </span><span class="si">{:d}</span><span class="s1"> will be used&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fracbw</span><span class="p">,</span> <span class="n">nt1snr</span><span class="p">,</span> <span class="n">nterms</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nterms</span></div>



<div class="viewcode-block" id="get_mean_freq">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_mean_freq">[docs]</a>
<span class="k">def</span> <span class="nf">get_mean_freq</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">spwsarray</span><span class="p">):</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span>
    <span class="n">freqarray</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;REF_FREQUENCY&#39;</span><span class="p">)</span>
    <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">meanfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">freqarray</span><span class="p">[</span><span class="n">spwsarray</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">minfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">freqarray</span><span class="p">[</span><span class="n">spwsarray</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">maxfreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">freqarray</span><span class="p">[</span><span class="n">spwsarray</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]])</span>
    <span class="n">fracbw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxfreq</span><span class="o">-</span><span class="n">minfreq</span><span class="p">)</span><span class="o">/</span><span class="n">meanfreq</span>
    <span class="k">return</span> <span class="n">meanfreq</span><span class="p">,</span> <span class="n">maxfreq</span><span class="p">,</span> <span class="n">minfreq</span><span class="p">,</span> <span class="n">fracbw</span></div>



<div class="viewcode-block" id="get_spw_chanbin">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_spw_chanbin">[docs]</a>
<span class="k">def</span> <span class="nf">get_spw_chanbin</span><span class="p">(</span><span class="n">bwarray</span><span class="p">,</span> <span class="n">chanarray</span><span class="p">,</span> <span class="n">desiredWidth</span><span class="o">=</span><span class="mf">15.625e6</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the number of channels to average over for each spw.</span>
<span class="sd">    </span>
<span class="sd">    note: mstransform only accept chanbin as integer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">avgarray</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bwarray</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bwarray</span><span class="p">)):</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">bwarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">desiredWidth</span>
        <span class="n">nchan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>
        <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">chanarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">nchan</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">avgarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">avgarray</span></div>



<div class="viewcode-block" id="get_desired_width">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_desired_width">[docs]</a>
<span class="k">def</span> <span class="nf">get_desired_width</span><span class="p">(</span><span class="n">meanfreq</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">50.0e9</span><span class="p">:</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">15.625e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">50.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">40.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">16.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">40.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">26.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">8.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">26.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">18.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">16.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">18.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">8.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">8.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">8.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">4.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">4.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">4.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">2.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">4.0e6</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">2.0e9</span><span class="p">):</span>
        <span class="n">desiredWidth</span> <span class="o">=</span> <span class="mf">2.0e6</span>
    <span class="k">return</span> <span class="n">desiredWidth</span></div>



<div class="viewcode-block" id="get_ALMA_bands">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_ALMA_bands">[docs]</a>
<span class="k">def</span> <span class="nf">get_ALMA_bands</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">spwstring</span><span class="p">,</span> <span class="n">spwarray</span><span class="p">):</span>
    <span class="n">meanfreq</span><span class="p">,</span> <span class="n">maxfreq</span><span class="p">,</span> <span class="n">minfreq</span><span class="p">,</span> <span class="n">fracbw</span> <span class="o">=</span> <span class="n">get_mean_freq</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">spwarray</span><span class="p">)</span>
    <span class="n">observed_bands</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">950.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">787.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_10&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">720.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">602.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_9&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">500.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">385.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_8&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">373.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">275.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_7&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">275.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">211.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_6&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">211.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">163.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_5&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">163.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">125.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_4&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">116.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">84.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_3&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">84.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">67.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_2&#39;</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&lt;</span> <span class="mf">50.0e9</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">&gt;=</span> <span class="mf">30.0e9</span><span class="p">):</span>
        <span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;Band_1&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;meanfreq is ouside the allowed range in get_ALMA_bands()&#39;</span><span class="p">)</span>
    <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSMDReader</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="k">as</span> <span class="n">msmd</span><span class="p">:</span>
            <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">band</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
                <span class="c1"># reject spws that do not exist in the MS.</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwarray</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwstring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwstring</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meanfreq</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;maxfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxfreq</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;minfreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">minfreq</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fracbw</span>
    <span class="n">get_max_uvdist</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">observed_bands</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bands</span><span class="p">,</span> <span class="n">observed_bands</span></div>



<div class="viewcode-block" id="get_VLA_bands">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_VLA_bands">[docs]</a>
<span class="k">def</span> <span class="nf">get_VLA_bands</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
    <span class="n">observed_bands</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">spws_for_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
            <span class="n">spws_temp</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforfield</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">spws_for_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">spws_for_field</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spws_temp</span><span class="p">)))</span>
        <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">spws_for_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spws_for_field</span><span class="p">)</span>
        <span class="n">spws_for_field</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">spws_for_field</span> <span class="o">=</span> <span class="n">spws_for_field</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="c1"># visheader=vishead(vis,mode=&#39;list&#39;,listitems=[])</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span>
        <span class="n">spw_names</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)</span>
        <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># spw_names=visheader[&#39;spw_name&#39;][0]</span>
        <span class="n">spw_names_band</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_for_field</span><span class="p">)</span>
        <span class="n">spw_names_band</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_for_field</span><span class="p">)</span>
        <span class="n">spw_names_bb</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_for_field</span><span class="p">)</span>
        <span class="n">spw_names_spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spw_names_band</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_for_field</span><span class="p">)):</span>
            <span class="n">spw_names_band</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_names</span><span class="p">[</span><span class="n">spws_for_field</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">spw_names_bb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_names</span><span class="p">[</span><span class="n">spws_for_field</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">spw_names_spw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spws_for_field</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">all_bands</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spw_names_band</span><span class="p">)</span>
        <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_bands&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_bands</span><span class="p">)</span>
        <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_bands</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">all_bands</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spw_names_band</span><span class="p">)</span> <span class="o">==</span> <span class="n">band</span><span class="p">)</span>
            <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># logic below removes the VLA standard pointing setups at X and C-bands</span>
            <span class="c1"># the code is mostly immune to this issue since we get the spws for only</span>
            <span class="c1"># the science targets above; however, should not ignore the possibility</span>
            <span class="c1"># that someone might also do pointing on what is the science target</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_X&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># ignore pointing band</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_names_spw</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">])):</span>
                    <span class="n">meanfreq</span><span class="p">,</span> <span class="n">maxfreq</span><span class="p">,</span> <span class="n">minfreq</span><span class="p">,</span> <span class="n">fracbw</span> <span class="o">=</span> <span class="n">get_mean_freq</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="p">{</span><span class="n">vis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]])})</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">==</span> <span class="mf">8.332e9</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">==</span> <span class="mf">8.460e9</span><span class="p">):</span>
                        <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices_to_remove</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">],</span>
                    <span class="n">indices_to_remove</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_C&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># ignore pointing band</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_names_spw</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">])):</span>
                    <span class="n">meanfreq</span><span class="p">,</span> <span class="n">maxfreq</span><span class="p">,</span> <span class="n">minfreq</span><span class="p">,</span> <span class="n">fracbw</span> <span class="o">=</span> <span class="n">get_mean_freq</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="p">{</span><span class="n">vis</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]])})</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">==</span> <span class="mf">4.832e9</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">meanfreq</span> <span class="o">==</span> <span class="mf">4.960e9</span><span class="p">):</span>
                        <span class="n">indices_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indices_to_remove</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span>
                    <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">],</span>
                    <span class="n">indices_to_remove</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_names_spw</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">spwslist</span> <span class="o">=</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">spwstring</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwslist</span><span class="p">)</span>
            <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwstring&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwstring</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
            <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">],</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;maxfreq&#39;</span><span class="p">],</span> \
                <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;minfreq&#39;</span><span class="p">],</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">]</span> \
                <span class="o">=</span> <span class="n">get_mean_freq</span><span class="p">([</span><span class="n">vis</span><span class="p">],</span> <span class="p">{</span><span class="n">vis</span><span class="p">:</span> <span class="p">[</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]]})</span>
    <span class="n">bands_match</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)):</span>
            <span class="n">bandlist_match</span> <span class="o">=</span> <span class="p">(</span><span class="n">observed_bands</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;bands&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bandlist_match</span><span class="p">:</span>
                <span class="n">bands_match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bands_match</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Inconsistent VLA bands are detected in the input MSs.&#39;</span><span class="p">)</span>
    <span class="n">get_max_uvdist</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">observed_bands</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;VLA&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">observed_bands</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">observed_bands</span></div>



<div class="viewcode-block" id="get_dr_correction">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_dr_correction">[docs]</a>
<span class="k">def</span> <span class="nf">get_dr_correction</span><span class="p">(</span><span class="n">telescope</span><span class="p">,</span> <span class="n">dirty_peak</span><span class="p">,</span> <span class="n">theoretical_sens</span><span class="p">,</span> <span class="n">vislist</span><span class="p">):</span>
    <span class="n">dirty_dynamic_range</span> <span class="o">=</span> <span class="n">dirty_peak</span><span class="o">/</span><span class="n">theoretical_sens</span>
    <span class="n">n_dr_max</span> <span class="o">=</span> <span class="mf">2.5</span>
    <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">tlimit</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dirty_dynamic_range</span> <span class="o">&gt;</span> <span class="mf">150.</span><span class="p">:</span>
            <span class="n">maxSciEDR</span> <span class="o">=</span> <span class="mf">150.0</span>
            <span class="n">new_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">n_dr_max</span> <span class="o">*</span> <span class="n">theoretical_sens</span><span class="p">,</span> <span class="n">dirty_peak</span> <span class="o">/</span> <span class="n">maxSciEDR</span> <span class="o">*</span> <span class="n">tlimit</span><span class="p">])</span>
            <span class="n">n_dr</span> <span class="o">=</span> <span class="n">new_threshold</span><span class="o">/</span><span class="n">theoretical_sens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dirty_dynamic_range</span> <span class="o">&gt;</span> <span class="mf">100.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">2.5</span>
            <span class="k">elif</span> <span class="mf">50.</span> <span class="o">&lt;</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">100.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="mf">20.</span> <span class="o">&lt;</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">50.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="k">elif</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">20.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
        <span class="n">numberEBs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numberEBs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># single-EB 7m array datasets have limited dynamic range</span>
            <span class="n">maxSciEDR</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">dirtyDRthreshold</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">n_dr_max</span> <span class="o">=</span> <span class="mf">2.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># multi-EB 7m array datasets will have better dynamic range and can be cleaned somewhat deeper</span>
            <span class="n">maxSciEDR</span> <span class="o">=</span> <span class="mi">55</span>
            <span class="n">dirtyDRthreshold</span> <span class="o">=</span> <span class="mi">75</span>
            <span class="n">n_dr_max</span> <span class="o">=</span> <span class="mf">3.5</span>

        <span class="k">if</span> <span class="n">dirty_dynamic_range</span> <span class="o">&gt;</span> <span class="n">dirtyDRthreshold</span><span class="p">:</span>
            <span class="n">new_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">n_dr_max</span> <span class="o">*</span> <span class="n">theoretical_sens</span><span class="p">,</span> <span class="n">dirty_peak</span> <span class="o">/</span> <span class="n">maxSciEDR</span> <span class="o">*</span> <span class="n">tlimit</span><span class="p">])</span>
            <span class="n">n_dr</span> <span class="o">=</span> <span class="n">new_threshold</span><span class="o">/</span><span class="n">theoretical_sens</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dirty_dynamic_range</span> <span class="o">&gt;</span> <span class="mf">40.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">3.0</span>
            <span class="k">elif</span> <span class="n">dirty_dynamic_range</span> <span class="o">&gt;</span> <span class="mf">20.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">2.5</span>
            <span class="k">elif</span> <span class="mf">10.</span> <span class="o">&lt;</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">20.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="k">elif</span> <span class="mf">4.</span> <span class="o">&lt;</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">10.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">1.5</span>
            <span class="k">elif</span> <span class="n">dirty_dynamic_range</span> <span class="o">&lt;=</span> <span class="mf">4.</span><span class="p">:</span>
                <span class="n">n_dr</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">n_dr</span></div>



<div class="viewcode-block" id="get_baseline_dist">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_baseline_dist">[docs]</a>
<span class="k">def</span> <span class="nf">get_baseline_dist</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
    <span class="c1"># Get the antenna names and offsets.</span>

    <span class="n">msmd</span> <span class="o">=</span> <span class="n">casatools</span><span class="o">.</span><span class="n">msmetadata</span><span class="p">()</span>

    <span class="n">msmd</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennanames</span><span class="p">()</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">antennaoffset</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
    <span class="n">msmd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">baselines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">offset</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">offset</span><span class="p">)):</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;longitude offset&quot;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;longitude offset&quot;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;latitude offset&quot;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s2">&quot;latitude offset&quot;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">baselines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">baselines</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">baseline</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">baselines</span></div>



<div class="viewcode-block" id="get_max_uvdist">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_max_uvdist">[docs]</a>
<span class="k">def</span> <span class="nf">get_max_uvdist</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;VLA&#39;</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
        <span class="n">all_baselines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="n">baselines</span> <span class="o">=</span> <span class="n">get_baseline_dist</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">all_baselines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">,</span> <span class="n">baselines</span><span class="p">)</span>
        <span class="n">max_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">)</span>
        <span class="n">min_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
            <span class="n">baseline_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">[</span><span class="n">all_baselines</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">all_baselines</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="mf">5.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ALMA</span>
            <span class="n">baseline_5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>

        <span class="n">baseline_75</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">,</span> <span class="mf">75.0</span><span class="p">)</span>
        <span class="n">baseline_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">all_baselines</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="n">meanlam</span> <span class="o">=</span> <span class="mf">3.0e8</span><span class="o">/</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span>
            <span class="n">max_uv_dist</span> <span class="o">=</span> <span class="n">max_baseline</span>  <span class="c1"># leave maxuv in meters like the other uv entries /meanlam/1000.0</span>
            <span class="n">min_uv_dist</span> <span class="o">=</span> <span class="n">min_baseline</span>
            <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;maxuv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_uv_dist</span>
            <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;minuv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_uv_dist</span>
            <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;75thpct_uv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline_75</span>
            <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;median_uv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">baseline_median</span>
            <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="p">(</span><span class="n">meanlam</span><span class="o">/</span><span class="n">baseline_5</span><span class="p">)</span> <span class="o">*</span> <span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">3600.</span></div>



<div class="viewcode-block" id="get_uv_range">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_uv_range">[docs]</a>
<span class="k">def</span> <span class="nf">get_uv_range</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">vislist</span><span class="p">):</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_C&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_X&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_S&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;EVLA_L&#39;</span><span class="p">):</span>
        <span class="n">n_vis</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">)</span>
        <span class="n">mean_max_uv</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="n">mean_max_uv</span> <span class="o">+=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;maxuv&#39;</span><span class="p">]</span>
        <span class="n">mean_max_uv</span> <span class="o">=</span> <span class="n">mean_max_uv</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n_vis</span><span class="p">)</span>
        <span class="n">min_uv</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">mean_max_uv</span>
        <span class="n">uvrange</span> <span class="o">=</span> <span class="s1">&#39;&gt;</span><span class="si">{:0.2f}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_uv</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">uvrange</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">uvrange</span></div>



<div class="viewcode-block" id="compare_beams">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.compare_beams">[docs]</a>
<span class="k">def</span> <span class="nf">compare_beams</span><span class="p">(</span><span class="n">image1</span><span class="p">,</span> <span class="n">image2</span><span class="p">):</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">image1</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">bm1</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">image2</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">bm2</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">beammajor_1</span> <span class="o">=</span> <span class="n">bm1</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beamminor_1</span> <span class="o">=</span> <span class="n">bm1</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="n">beammajor_2</span> <span class="o">=</span> <span class="n">bm2</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">beamminor_2</span> <span class="o">=</span> <span class="n">bm2</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="n">beamarea_1</span> <span class="o">=</span> <span class="n">beammajor_1</span><span class="o">*</span><span class="n">beamminor_1</span>
    <span class="n">beamarea_2</span> <span class="o">=</span> <span class="n">beammajor_2</span><span class="o">*</span><span class="n">beamminor_2</span>
    <span class="n">delta_beamarea</span> <span class="o">=</span> <span class="p">(</span><span class="n">beamarea_2</span><span class="o">-</span><span class="n">beamarea_1</span><span class="p">)</span><span class="o">/</span><span class="n">beamarea_1</span>
    <span class="k">return</span> <span class="n">delta_beamarea</span></div>



<div class="viewcode-block" id="gaussian_norm">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.gaussian_norm">[docs]</a>
<span class="k">def</span> <span class="nf">gaussian_norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="n">gauss_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">norm_gauss_dist</span> <span class="o">=</span> <span class="n">gauss_dist</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">gauss_dist</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_gauss_dist</span></div>



<div class="viewcode-block" id="importdata">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.importdata">[docs]</a>
<span class="k">def</span> <span class="nf">importdata</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">,</span> <span class="n">telescope</span><span class="p">):</span>
    <span class="n">spectral_scan</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">integrationsdict</span><span class="p">,</span> <span class="n">integrationtimesdict</span><span class="p">,</span> <span class="n">integrationtimes</span><span class="p">,</span> <span class="n">n_spws</span><span class="p">,</span> <span class="n">minspw</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">,</span> <span class="n">spws_set</span> <span class="o">=</span> <span class="n">fetch_scan_times</span><span class="p">(</span>
        <span class="n">vislist</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">)</span>

    <span class="n">spwslist_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spwstring_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
        <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwsarray_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">spwstring_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwslist_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">nspws_sets</span> <span class="o">=</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nspws_sets</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
        <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span> <span class="o">=</span> <span class="n">get_VLA_bands</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
        <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span> <span class="o">=</span> <span class="n">get_ALMA_bands</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">spwstring_dict</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nspws_sets</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">spectral_scan</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">scantimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scanstartsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">scanendsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationsdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">integrationtimesdict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mosaic_field_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">bands_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">spws_set_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">nspws_sets_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="n">scantimesdict_temp</span><span class="p">,</span> <span class="n">scanstartsdict_temp</span><span class="p">,</span> <span class="n">scanendsdict_temp</span><span class="p">,</span> <span class="n">integrationsdict_temp</span><span class="p">,</span> <span class="n">integrationtimesdict_temp</span><span class="p">,</span> \
            <span class="n">integrationtimes_temp</span><span class="p">,</span> <span class="n">n_spws_temp</span><span class="p">,</span> <span class="n">minspw_temp</span><span class="p">,</span> <span class="n">spwsarray_temp</span><span class="p">,</span> <span class="n">spws_set_dict_temp</span><span class="p">,</span> <span class="n">mosaic_field_temp</span> <span class="o">=</span> <span class="n">fetch_scan_times_band_aware</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">)</span>

        <span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">scantimesdict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanstartsdict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">scanendsdict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanendsdict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">integrationsdict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrationsdict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mosaic_field_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">mosaic_field_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrationtimesdict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">spws_set_dict_temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nspws_sets_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">spws_set_dict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nspws_sets_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">n_spws_temp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">99</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
                <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;bands&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Removing &#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39; bands from list due to no observations&#39;</span><span class="p">)</span>
            <span class="n">bands_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>

        <span class="n">loopcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
                <span class="n">check_target</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">integrationsdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">check_target</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">integrationsdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="n">scanendsdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">loopcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">mosaic_field_dict</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="n">loopcount</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bands_to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">delband</span> <span class="ow">in</span> <span class="n">bands_to_remove</span><span class="p">:</span>
            <span class="n">bands</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">delband</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">scanstartsdict</span><span class="p">,</span> <span class="n">scanendsdict</span><span class="p">,</span> <span class="n">integrationtimesdict</span><span class="p">,</span> \
        <span class="n">spwslist_dict</span><span class="p">,</span> <span class="n">spwstring_dict</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">,</span> <span class="n">mosaic_field_dict</span><span class="p">,</span> <span class="n">spectral_scan</span><span class="p">,</span> <span class="n">spws_set_dict</span></div>



<div class="viewcode-block" id="get_flagged_solns_per_spw">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.get_flagged_solns_per_spw">[docs]</a>
<span class="k">def</span> <span class="nf">get_flagged_solns_per_spw</span><span class="p">(</span><span class="n">spwlist</span><span class="p">,</span> <span class="n">gaintable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the number of flagged and unflagged solutions per spectral window (spw).</span>

<span class="sd">    This function examines a gain table and calculates the number of flagged and unflagged </span>
<span class="sd">    solutions for each spectral window (spw) provided in the spwlist. It also calculates </span>
<span class="sd">    the fraction of flagged solutions.</span>

<span class="sd">    Args:</span>
<span class="sd">        spwlist (list): List of spectral window IDs to examine.</span>
<span class="sd">        gaintable (str): Path to the gain table directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: A tuple containing three elements:</span>
<span class="sd">            - nflags (list): Number of flagged solutions per spw.</span>
<span class="sd">            - nunflagged (list): Number of unflagged solutions per spw.</span>
<span class="sd">            - fracflagged (numpy.ndarray): Fraction of flagged solutions per spw.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the specified gain table directory does not exist.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">gaintable</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The gaintable to be examined </span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">gaintable</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>

    <span class="n">gaintable_temp</span> <span class="o">=</span> <span class="s1">&#39;tempgaintable.g&#39;</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">gaintable</span><span class="p">,</span> <span class="n">gaintable_temp</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">tb</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">table</span>
    <span class="n">nflags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tb</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s1">&#39;[select from &#39;</span><span class="o">+</span><span class="n">gaintable_temp</span><span class="o">+</span><span class="s1">&#39; where SPECTRAL_WINDOW_ID==&#39;</span> <span class="o">+</span>
                      <span class="n">spwlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; giving  [ntrue(FLAG)]]&#39;</span><span class="p">)[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
              <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">))]</span>
    <span class="n">nunflagged</span> <span class="o">=</span> <span class="p">[</span><span class="n">tb</span><span class="o">.</span><span class="n">calc</span><span class="p">(</span><span class="s1">&#39;[select from &#39;</span><span class="o">+</span><span class="n">gaintable_temp</span><span class="o">+</span><span class="s1">&#39; where SPECTRAL_WINDOW_ID==&#39;</span> <span class="o">+</span>
                          <span class="n">spwlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; giving  [nfalse(FLAG)]]&#39;</span><span class="p">)[</span><span class="s1">&#39;0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                  <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">))]</span>

    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">gaintable_temp</span><span class="p">,</span> <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">fracflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nunflagged</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nflags</span><span class="p">,</span> <span class="n">nunflagged</span><span class="p">,</span> <span class="n">fracflagged</span></div>



<div class="viewcode-block" id="analyze_inf_EB_flagging">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.heuristics.auto_selfcal.html#pipeline.hif.heuristics.auto_selfcal.selfcal_helpers.analyze_inf_EB_flagging">[docs]</a>
<span class="k">def</span> <span class="nf">analyze_inf_EB_flagging</span><span class="p">(</span>
        <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">,</span> <span class="n">gaintable</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">spw_combine_test_gaintable</span><span class="p">,</span> <span class="n">spectral_scan</span><span class="p">,</span> <span class="n">telescope</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
        <span class="c1"># if more than two antennas are fully flagged relative to the combinespw results, fallback to combinespw</span>
        <span class="n">max_flagged_ants_combspw</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="c1"># if only a single (or few) spw(s) has flagging, allow at most this number of antennas to be flagged before mapping</span>
        <span class="n">max_flagged_ants_spwmap</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For the ACA, don&#39;t allow any flagging of antennas before trying fallbacks, because it is more damaging due to the smaller</span>
        <span class="c1"># number of antennas</span>
        <span class="n">max_flagged_ants_combspw</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">max_flagged_ants_spwmap</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">map_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">min_spwmap_bw</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">spwmap</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)</span>
    <span class="n">nflags</span><span class="p">,</span> <span class="n">nunflagged</span><span class="p">,</span> <span class="n">fracflagged</span> <span class="o">=</span> <span class="n">get_flagged_solns_per_spw</span><span class="p">(</span><span class="n">spwlist</span><span class="p">,</span> <span class="n">gaintable</span><span class="p">)</span>
    <span class="n">nflags_spwcomb</span><span class="p">,</span> <span class="n">nunflagged_spwcomb</span><span class="p">,</span> <span class="n">fracflagged_spwcomb</span> <span class="o">=</span> <span class="n">get_flagged_solns_per_spw</span><span class="p">(</span>
        <span class="p">[</span><span class="n">spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">spw_combine_test_gaintable</span><span class="p">)</span>
    <span class="n">eff_bws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">))</span>
    <span class="n">total_bws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">))</span>
    <span class="n">keylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)):</span>
        <span class="n">eff_bws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">keylist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span>
        <span class="n">total_bws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">keylist</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span>
    <span class="n">minimum_flagged_ants_per_spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="c1"># account for the fact that some antennas might be completely flagged and give</span>
    <span class="n">minimum_flagged_ants_spwcomb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">nflags_spwcomb</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="c1"># the impression of a lot of flagging</span>
    <span class="n">maximum_flagged_ants_per_spw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">delta_nflags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">-</span><span class="n">minimum_flagged_ants_spwcomb</span>  <span class="c1"># minimum_flagged_ants_per_spw</span>

    <span class="c1"># if there are more than 3 flagged antennas for all spws (minimum_flagged_ants_spwcomb, fallback to doing spw combine for inf_EB fitting</span>
    <span class="c1"># use the spw combine number of flagged ants to set the minimum otherwise could misinterpret fully flagged antennas for flagged solutions</span>
    <span class="c1"># captures case where no one spws has sufficient S/N, only together do they have enough</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">minimum_flagged_ants_per_spw</span><span class="o">-</span><span class="n">minimum_flagged_ants_spwcomb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_flagged_ants_combspw</span><span class="p">:</span>
        <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;combinespw&#39;</span>

    <span class="c1"># if certain spws have more than max_flagged_ants_spwmap flagged solutions that the least flagged spws, set those to spwmap</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">delta_nflags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">max_flagged_ants_spwmap</span><span class="p">:</span>
            <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;spwmap&#39;</span>
            <span class="n">spwmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">total_bws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">min_spwmap_bw</span><span class="p">:</span>
                <span class="n">min_spwmap_bw</span> <span class="o">=</span> <span class="n">total_bws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># also spwmap spws with similar bandwidths to the others that are getting mapped, avoid low S/N solutions</span>
    <span class="k">if</span> <span class="n">fallback</span> <span class="o">==</span> <span class="s1">&#39;spwmap&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwlist</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">total_bws</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_spwmap_bw</span><span class="p">:</span>
                <span class="n">spwmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">spwmap</span><span class="p">):</span>
            <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;combinespw&#39;</span>
    <span class="c1"># want the widest bandwidth window that also has the minimum flags to use for spw mapping</span>
    <span class="n">applycal_spwmap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">fallback</span> <span class="o">==</span> <span class="s1">&#39;spwmap&#39;</span><span class="p">:</span>
        <span class="n">minflagged_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nflags</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">==</span> <span class="n">minimum_flagged_ants_per_spw</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="n">max_bw_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">eff_bws</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">eff_bws</span><span class="p">[</span><span class="n">minflagged_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="n">max_bw_min_flags_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="n">minflagged_index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">max_bw_index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># if len(max_bw_min_flags_index) &gt; 1:</span>
        <span class="c1"># don&#39;t need the conditional since this works with array lengths of 1</span>
        <span class="n">map_index</span> <span class="o">=</span> <span class="n">max_bw_min_flags_index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">eff_bws</span><span class="p">[</span><span class="n">max_bw_min_flags_index</span><span class="p">])]</span>
        <span class="c1"># else:</span>
        <span class="c1">#   map_index=max_bw_min_flags_index[0]</span>

        <span class="c1"># make spwmap list that first maps everything to itself, need max spw to make that list</span>
        <span class="n">maxspw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">applycal_spwmap_int_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">maxspw</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">applycal_spwmap_int_list</span><span class="p">)):</span>
            <span class="n">applycal_spwmap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">applycal_spwmap_int_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># replace the elements that require spwmapping (spwmap[i] == True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spwmap</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spwlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">spwmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">spwmap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">applycal_spwmap</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spwlist</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwlist</span><span class="p">[</span><span class="n">map_index</span><span class="p">])</span>
        <span class="c1"># always fallback to combinespw for spectral scans</span>
        <span class="k">if</span> <span class="n">fallback</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">spectral_scan</span><span class="p">:</span>
            <span class="n">fallback</span> <span class="o">=</span> <span class="s1">&#39;combinespw&#39;</span>
    <span class="k">return</span> <span class="n">fallback</span><span class="p">,</span> <span class="n">map_index</span><span class="p">,</span> <span class="n">spwmap</span><span class="p">,</span> <span class="n">applycal_spwmap</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>