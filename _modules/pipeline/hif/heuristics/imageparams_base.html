

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hif.heuristics.imageparams_base &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task (sphinx-autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Pipeline Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dependencies.html">Dependencies of <cite>Pipeline</cite></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.launcher">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Task Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../task_classes.html">pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../task_classes.html#module-pipeline.hif.tasks">pipeline-l2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../task_classes.html#module-pipeline.hif">pipeline-l3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../task_classes.html#pipeline-diagram">pipeline-diagram</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hif.heuristics.imageparams_base</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hif.heuristics.imageparams_base</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span> <span class="nn">casatasks.private.imagerhelpers.imager_base</span> <span class="kn">import</span> <span class="n">PySynthesisImager</span>
<span class="kn">from</span> <span class="nn">casatasks.private.imagerhelpers.imager_parallel_continuum</span> <span class="kn">import</span> \
    <span class="n">PyParallelContSynthesisImager</span>
<span class="kn">from</span> <span class="nn">casatasks.private.imagerhelpers.input_parameters</span> <span class="kn">import</span> <span class="n">ImagerParameters</span>

<span class="kn">import</span> <span class="nn">pipeline.domain.measures</span> <span class="k">as</span> <span class="nn">measures</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.contfilehandler</span> <span class="k">as</span> <span class="nn">contfilehandler</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.filenamer</span> <span class="k">as</span> <span class="nn">filenamer</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.mpihelpers</span> <span class="k">as</span> <span class="nn">mpihelpers</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">pipeline.hif.heuristics</span> <span class="kn">import</span> <span class="n">mosaicoverlap</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.utils.conversion</span> <span class="kn">import</span> <span class="p">(</span><span class="n">phasecenter_to_skycoord</span><span class="p">,</span>
                                                      <span class="n">refcode_to_skyframe</span><span class="p">)</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ImageParamsHeuristics">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics">[docs]</a>
<span class="k">class</span> <span class="nc">ImageParamsHeuristics</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Image parameters heuristics base class. One instance is made per make/editimlist</span>
<span class="sd">    call. There are subclasses for different imaging modes such as ALMA</span>
<span class="sd">    or VLASS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memodict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Save memory by using a shallow copy of the ObservingRun</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">),</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spw</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imagename_prefix</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contfile</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linesfile</span><span class="p">,</span>
            <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imaging_params</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">observing_run</span><span class="p">,</span> <span class="n">imagename_prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">proj_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">linesfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imaging_params</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param vislist: the list of MS names</span>
<span class="sd">        :type vislist: list of strings</span>
<span class="sd">        :param spw: the virtual spw specification (list of virtual spw IDs)</span>
<span class="sd">        :type spw: string or list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imaging_mode</span> <span class="o">=</span> <span class="s1">&#39;BASE&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span> <span class="o">=</span> <span class="n">observing_run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imagename_prefix</span> <span class="o">=</span> <span class="n">imagename_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span> <span class="o">=</span> <span class="n">proj_params</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span> <span class="o">=</span> <span class="n">vislist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span> <span class="o">=</span> <span class="p">[</span><span class="n">vislist</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="n">contfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="n">linesfile</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imaging_params</span> <span class="o">=</span> <span class="n">imaging_params</span>

        <span class="c1"># split spw into list of spw parameters for &#39;clean&#39;</span>
        <span class="n">spwlist</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">spwlist</span> <span class="o">=</span> <span class="n">spwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;,&#39;&quot;</span><span class="p">)</span>
        <span class="n">spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="n">spwlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># a list of spw selection string, e.g. [&#39;2,3&#39;,&#39;4&#39;,&#39;5&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spwlist</span> <span class="o">=</span> <span class="n">spwlist</span>

        <span class="c1"># find all the spwids present in the list</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ,]+(\d+)&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">spwclean</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
            <span class="n">spwidsclean</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spwclean</span><span class="p">)</span>
            <span class="n">spwidsclean</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwidsclean</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spwids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spwidsclean</span><span class="p">)</span>

<div class="viewcode-block" id="ImageParamsHeuristics.get_ref_msname">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_ref_msname">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ref_msname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the first MS name that contains data for the given spw ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">real_spwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">msname</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Vis list </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="si">}</span><span class="s1"> does not contain any MS with data for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.primary_beam_size">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.primary_beam_size">[docs]</a>
    <span class="k">def</span> <span class="nf">primary_beam_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&#39;&#39;&#39;Calculate primary beam size in arcsec.&#39;&#39;&#39;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># get the diameter of the smallest antenna used among all vis sets</span>
        <span class="n">antenna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_ids</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
        <span class="n">diameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">antennas</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span>
            <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="n">antennas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">antenna</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]:</span>
                    <span class="n">diameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span><span class="p">)</span>
        <span class="n">smallest_diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">diameters</span><span class="p">))</span>

        <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
        <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>

        <span class="n">ref_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">spw</span><span class="o">.</span><span class="n">ref_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">))</span>

        <span class="c1"># use the smallest antenna diameter and the reference frequency</span>
        <span class="c1"># to estimate the primary beam radius -</span>
        <span class="c1"># radius of first null in arcsec = 1.22*lambda/D</span>
        <span class="n">primary_beam_size</span> <span class="o">=</span> \
            <span class="mf">1.22</span> \
            <span class="o">*</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">constants</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">),</span> <span class="s1">&#39;m/s&#39;</span><span class="p">))</span> \
            <span class="o">/</span> <span class="n">ref_frequency</span> \
            <span class="o">/</span> <span class="n">smallest_diameter</span> \
            <span class="o">*</span> <span class="p">(</span><span class="mf">180.0</span> <span class="o">*</span> <span class="mf">3600.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">primary_beam_size</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.cont_ranges_spwsel">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.cont_ranges_spwsel">[docs]</a>
    <span class="k">def</span> <span class="nf">cont_ranges_spwsel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine spw selection parameters to exclude lines for mfs and cont images.&quot;&quot;&quot;</span>

        <span class="c1"># initialize lookup dictionary for all possible source names</span>
        <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">all_continuum_spwsel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">low_bandwidth_spwsel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">low_spread_spwsel</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ms_ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms_ref</span><span class="o">.</span><span class="n">sources</span><span class="p">]:</span>
                <span class="n">cont_ranges_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">all_continuum_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">low_bandwidth_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">low_spread_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spwids</span><span class="p">:</span>
                    <span class="n">cont_ranges_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;NONE&#39;</span>
                    <span class="n">all_continuum_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">low_bandwidth_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">low_spread_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">contfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contfile</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="n">linesfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linesfile</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">linesfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="c1"># read and merge continuum regions if contfile exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">contfile</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using continuum frequency ranges from </span><span class="si">%s</span><span class="s1"> to calculate continuum frequency selections.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">contfile</span><span class="p">))</span>

            <span class="n">contfile_handler</span> <span class="o">=</span> <span class="n">contfilehandler</span><span class="o">.</span><span class="n">ContFileHandler</span><span class="p">(</span><span class="n">contfile</span><span class="p">,</span> <span class="n">warn_nonexist</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Collect the merged the ranges</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">cont_ranges_spwsel</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">cont_ranges_spwsel</span><span class="p">[</span><span class="n">field_name</span><span class="p">]:</span>
                    <span class="n">spw_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)]</span>
                    <span class="n">cont_ranges_spwsel</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">all_continuum_spwsel</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">low_bandwidth_spwsel</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">low_spread_spwsel</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="n">spw_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">get_merged_selection</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">)</span>

        <span class="c1"># alternatively read and merge line regions and calculate continuum regions</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">linesfile</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using line frequency ranges from </span><span class="si">%s</span><span class="s1"> to calculate continuum frequency selections.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">linesfile</span><span class="p">))</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([\d.]*)(~)([\d.]*)(\D*)&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line_regions</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">linesfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">line_regions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line_ranges_GHz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">line_region</span> <span class="ow">in</span> <span class="n">line_regions</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fLow</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">line_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">fHigh</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line_region</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                    <span class="n">line_ranges_GHz</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fLow</span><span class="p">,</span> <span class="n">fHigh</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">merged_line_ranges_GHz</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_ranges</span><span class="p">(</span><span class="n">line_ranges_GHz</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spwids</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                    <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
                    <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
                    <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
                    <span class="c1"># assemble continuum spw selection</span>
                    <span class="n">min_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">GIGAHERTZ</span><span class="p">))</span>
                    <span class="n">max_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">GIGAHERTZ</span><span class="p">))</span>
                    <span class="n">spw_sel_intervals</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">spw_intersect</span><span class="p">([</span><span class="n">min_frequency</span><span class="p">,</span> <span class="n">max_frequency</span><span class="p">],</span> <span class="n">merged_line_ranges_GHz</span><span class="p">)</span>
                    <span class="n">spw_selection</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spw_sel_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_sel_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">spw_sel_interval</span> <span class="ow">in</span> <span class="n">spw_sel_intervals</span><span class="p">])</span>

                    <span class="c1"># Skip selection syntax completely if the whole spw is selected</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">spw_selection</span> <span class="o">==</span> <span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">min_frequency</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_frequency</span><span class="p">))):</span>
                        <span class="n">spw_selection</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                    <span class="k">for</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span><span class="p">]:</span>
                        <span class="n">cont_ranges_spwsel</span><span class="p">[</span><span class="n">source_name</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> LSRK&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw_selection</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine continuum ranges for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cont_ranges_spwsel</span><span class="p">,</span> <span class="n">all_continuum_spwsel</span><span class="p">,</span> <span class="n">low_bandwidth_spwsel</span><span class="p">,</span> <span class="n">low_spread_spwsel</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.field_intent_list">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.field_intent_list">[docs]</a>
    <span class="k">def</span> <span class="nf">field_intent_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="n">intent_list</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">field_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">safe_split</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="n">field_intent_result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>

            <span class="k">if</span> <span class="n">intent</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">eachintent</span> <span class="ow">in</span> <span class="n">intent_list</span><span class="p">:</span>
                    <span class="n">re_intent</span> <span class="o">=</span> <span class="n">eachintent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
                    <span class="n">field_intent_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eachintent</span><span class="p">)</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span>
                         <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">intents</span><span class="p">))])</span>

                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="c1"># remove items from field_intent_result that are not</span>
                    <span class="c1"># consistent with the fields in field_list</span>
                    <span class="n">temp_result</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">eachfield</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
                        <span class="n">re_field</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">eachfield</span><span class="p">)</span>
                        <span class="n">temp_result</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">fir</span> <span class="k">for</span> <span class="n">fir</span> <span class="ow">in</span> <span class="n">field_intent_result</span> <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">fir</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">re_field</span><span class="p">])</span>
                    <span class="n">field_intent_result</span> <span class="o">=</span> <span class="n">temp_result</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
                        <span class="n">fintents_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">intents</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">f</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">fintents</span> <span class="ow">in</span> <span class="n">fintents_list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">fintent</span> <span class="ow">in</span> <span class="n">fintents</span><span class="p">:</span>
                                <span class="n">field_intent_result</span><span class="o">.</span><span class="n">update</span><span class="p">([(</span><span class="n">f</span><span class="p">,</span> <span class="n">fintent</span><span class="p">)])</span>

        <span class="c1"># eliminate redundant copies of field/intent keys that map to the</span>
        <span class="c1"># same data - to prevent duplicate images being produced</span>

        <span class="n">done_vis_scanids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Loop through a reverse sorted list to make sure that the AMPLITUDE</span>
        <span class="c1"># intent is removed for cases of shared BANDPASS and AMPLITUDE intents</span>
        <span class="c1"># (PIPE-199). This should be done more explicitly rather than relying</span>
        <span class="c1"># on the alphabetical order, but as it requires more refactoring, there</span>
        <span class="c1"># was no time for this before the Cycle 7 deadline.</span>
        <span class="c1"># TODO: Save duplicate intents for weblog rendering.</span>
        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">field_intent_result</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">intent</span> <span class="o">=</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">re_field</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

            <span class="n">vis_scanids</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>

                <span class="n">scanids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span>
                     <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span> <span class="ow">and</span> <span class="n">re_field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]])</span>

                <span class="n">vis_scanids</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">scanids</span>

            <span class="k">if</span> <span class="n">vis_scanids</span> <span class="ow">in</span> <span class="n">done_vis_scanids</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;field: </span><span class="si">%s</span><span class="s1"> intent: </span><span class="si">%s</span><span class="s1"> is a duplicate - removing from imlist&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">))</span>
                <span class="n">field_intent_result</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">field_intent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">done_vis_scanids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis_scanids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field_intent_result</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_scanidlist">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_scanidlist">[docs]</a>
    <span class="k">def</span> <span class="nf">get_scanidlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">):</span>
        <span class="c1"># Use scanids to select data with the specified intent</span>
        <span class="c1"># Note CASA clean now supports intent selection but leave</span>
        <span class="c1"># this logic in place and use it to eliminate vis that</span>
        <span class="c1"># don&#39;t contain the requested data.</span>
        <span class="n">scanidlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visindexlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)):</span>
            <span class="n">allscanids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                <span class="n">re_field</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">fieldname</span><span class="p">)</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">scanids</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span>
                           <span class="n">intent</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span> <span class="ow">and</span>
                           <span class="p">((</span><span class="n">re_field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">])</span> <span class="ow">or</span>
                            <span class="p">(</span><span class="n">re_field</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]))]</span>
                <span class="k">if</span> <span class="n">scanids</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="k">continue</span>
                <span class="n">allscanids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scanids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">allscanids</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">allscanids</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">allscanids</span><span class="p">)))))</span>
                <span class="n">scanidlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allscanids</span><span class="p">)</span>
                <span class="n">visindexlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scanidlist</span><span class="p">,</span> <span class="n">visindexlist</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.largest_primary_beam_size">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.largest_primary_beam_size">[docs]</a>
    <span class="k">def</span> <span class="nf">largest_primary_beam_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">,</span> <span class="n">intent</span><span class="p">):</span>

        <span class="c1"># get the spwids in spwspec</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ,]+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">spwids</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spwspec</span><span class="p">)</span>
        <span class="n">spwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwids</span><span class="p">))</span>

        <span class="c1"># find largest beam among spws in spwspec</span>
        <span class="n">largest_primary_beam_size</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">largest_primary_beam_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">largest_primary_beam_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_beam_size</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine primary beam size for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">largest_primary_beam_size</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.synthesized_beam">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.synthesized_beam">[docs]</a>
    <span class="k">def</span> <span class="nf">synthesized_beam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_intent_list</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="p">[],</span> <span class="n">pixperbeam</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">known_beams</span><span class="o">=</span><span class="p">{},</span>
                         <span class="n">force_calc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="s1">&#39;automatic&#39;</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate synthesized beam for a given field / spw selection.&quot;&quot;&quot;</span>

        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">suTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">synthesisutils</span>

        <span class="c1"># Need to work on a local copy of known_beams to avoid setting the</span>
        <span class="c1"># method default value inadvertently</span>
        <span class="n">local_known_beams</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">known_beams</span><span class="p">)</span>

        <span class="c1"># reset state of imager</span>
        <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="c1"># get the spwids in spwspec - imager tool likes these rather than</span>
        <span class="c1"># a string</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ,]+(\d+)&quot;</span><span class="p">)</span>
        <span class="n">spwids</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spwspec</span><span class="p">)</span>
        <span class="n">spwids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwids</span><span class="p">))</span>

        <span class="c1"># Select only the highest frequency spw to get the smallest beam</span>
        <span class="c1"># NOTE: If this code gets reactivated, one will need to use</span>
        <span class="c1"># &quot;ref_ms = self.get_ref_msname(spwid)&quot; within the loop and try/except</span>
        <span class="c1"># ref_ms = self.observing_run.get_ms(self.vislist[0])</span>
        <span class="c1"># max_freq = 0.0</span>
        <span class="c1"># max_freq_spwid = -1</span>
        <span class="c1"># for spwid in spwids:</span>
        <span class="c1">#    real_spwid = self.observing_run.virtual2real_spw_id(spwid, ref_ms)</span>
        <span class="c1">#    spwid_centre_freq = ref_ms.get_spectral_window(real_spwid).centre_frequency.to_units(measures.FrequencyUnits.HERTZ)</span>
        <span class="c1">#    if spwid_centre_freq &gt; max_freq:</span>
        <span class="c1">#        max_freq = spwid_centre_freq</span>
        <span class="c1">#        max_freq_spwid = spwid</span>
        <span class="c1"># spwids = [max_freq_spwid]</span>

        <span class="c1"># find largest primary beam size among spws in spwspec</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">largest_primary_beam_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">largest_primary_beam_size</span><span class="p">(</span><span class="n">spwspec</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">largest_primary_beam_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">largest_primary_beam_size</span><span class="p">(</span><span class="n">spwspec</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">)</span>

        <span class="c1"># put code in try-block to ensure that imager.done gets</span>
        <span class="c1"># called at the end</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">makepsf_beams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">force_calc</span><span class="p">:</span>
                        <span class="c1"># Reset flag to avoid clearing the dictionary several times</span>
                        <span class="n">force_calc</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">local_known_beams</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got manual request to recalculate beams.&#39;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Got manual request to recalculate beams.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">robust</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">logMsg</span> <span class="o">=</span> <span class="s1">&#39;robust value changed (old: None, new: </span><span class="si">%.1f</span><span class="s1">). Re-calculating beams.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">robust</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logMsg</span> <span class="o">=</span> <span class="s1">&#39;robust value changed (old: </span><span class="si">%.1f</span><span class="s1">, new: </span><span class="si">%.1f</span><span class="s1">). Re-calculating beams.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">],</span> <span class="n">robust</span><span class="p">)</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">logMsg</span><span class="p">)</span>
                        <span class="n">local_known_beams</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">logMsg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">uvtaper</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;uvtaper value changed (old: </span><span class="si">%s</span><span class="s1">, new: </span><span class="si">%s</span><span class="s1">). Re-calculating beams.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)))</span>
                        <span class="n">local_known_beams</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;uvtaper value changed (old: </span><span class="si">%s</span><span class="s1">, new: </span><span class="si">%s</span><span class="s1">). Re-calculating beams.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)))</span>
                    <span class="n">makepsf_beam</span> <span class="o">=</span> <span class="n">local_known_beams</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">)))][</span><span class="s1">&#39;beam&#39;</span><span class="p">]</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using previously calculated beam of </span><span class="si">%s</span><span class="s1"> for Field </span><span class="si">%s</span><span class="s1"> Intent </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">makepsf_beam</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">)))))</span>
                    <span class="k">if</span> <span class="n">makepsf_beam</span> <span class="o">!=</span> <span class="s1">&#39;invalid&#39;</span><span class="p">:</span>
                        <span class="n">makepsf_beams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">makepsf_beam</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;recalc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robust</span>
                    <span class="n">local_known_beams</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvtaper</span>

                    <span class="n">valid_data</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">valid_vis_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_scanids_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_real_spwid_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_virtual_spwid_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_antenna_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># select data to be imaged</span>
                    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
                        <span class="n">antenna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_ids</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)])</span>
                        <span class="n">valid_data_for_vis</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">valid_real_spwid_list_for_vis</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">valid_virtual_spwid_list_for_vis</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
                        <span class="n">scan_dos</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span>
                                    <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span>
                                    <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">}]</span>
                        <span class="n">scanids</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">({</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_dos</span><span class="p">})</span>

                        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">:</span>
                            <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                            <span class="c1"># continue if the spw was not used for these scans</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_dos</span> <span class="k">if</span> <span class="n">real_spwid</span> <span class="ow">in</span> <span class="p">{</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">spws</span><span class="p">}]:</span>
                                <span class="k">continue</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">taql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA1==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&amp;&amp;&quot;</span> \
                                       <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA2==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&quot;</span>
                                <span class="n">rtn</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">selectvis</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span>
                                                                  <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">real_spwid</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="n">scanids</span><span class="p">,</span>
                                                                  <span class="n">taql</span><span class="o">=</span><span class="n">taql</span><span class="p">,</span> <span class="n">usescratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writeaccess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">rtn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                    <span class="c1"># flag to say that imager has some valid data to work</span>
                                    <span class="c1"># on</span>
                                    <span class="n">valid_data_for_vis</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">valid_data</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">valid_real_spwid_list_for_vis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
                                    <span class="n">valid_virtual_spwid_list_for_vis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>

                        <span class="k">if</span> <span class="n">valid_data_for_vis</span><span class="p">:</span>
                            <span class="n">valid_vis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                            <span class="n">valid_scanids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scanids</span><span class="p">)</span>
                            <span class="n">valid_real_spwid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">valid_real_spwid_list_for_vis</span><span class="p">)))</span>
                            <span class="n">valid_virtual_spwid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">valid_virtual_spwid_list_for_vis</span><span class="p">)))</span>
                            <span class="n">valid_antenna_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]))</span><span class="si">}</span><span class="s2">&amp;&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_data</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">)]:</span>
                        <span class="c1"># no point carrying on for this field/intent</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No data for field </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">))</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">,</span>
                                              <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">))),</span> <span class="s1">&#39;beam&#39;</span><span class="p">),</span>
                                              <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># use imager.advise to get the maximum cell size</span>
                    <span class="n">aipsfieldofview</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%4.1f</span><span class="s1">arcsec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">largest_primary_beam_size</span><span class="p">)</span>
                    <span class="n">rtn</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">advise</span><span class="p">(</span><span class="n">takeadvice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amplitudeloss</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fieldofview</span><span class="o">=</span><span class="n">aipsfieldofview</span><span class="p">)</span>
                    <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rtn</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="c1"># advise can fail if all selected data are flagged</span>
                        <span class="c1"># - not documented but assuming bool in first field of returned</span>
                        <span class="c1"># record indicates success or failure</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;imager.advise failed for field/intent </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> spw </span><span class="si">%s</span><span class="s1"> - no valid data?&#39;</span>
                                    <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
                        <span class="n">valid_data</span><span class="p">[(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">,</span>
                                              <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">))),</span> <span class="s1">&#39;beam&#39;</span><span class="p">),</span>
                                              <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">cellv</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">rtn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">cellu</span> <span class="o">=</span> <span class="s1">&#39;arcsec&#39;</span>
                        <span class="n">cellv</span> <span class="o">/=</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">pixperbeam</span><span class="p">)</span>

                        <span class="c1"># Now get better estimate from makePSF</span>
                        <span class="n">tmp_psf_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

                        <span class="n">gridder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridder</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">spwspec</span><span class="p">)</span>
                        <span class="n">mosweight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mosweight</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                        <span class="n">field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">valid_vis_list</span><span class="p">)</span>
                        <span class="c1"># Get single field imsize</span>
                        <span class="n">imsize_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2g%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cellv</span><span class="p">,</span> <span class="n">cellu</span><span class="p">)],</span> <span class="n">primary_beam</span><span class="o">=</span><span class="n">largest_primary_beam_size</span><span class="p">,</span> <span class="n">centreonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">valid_vis_list</span><span class="p">)</span>
                        <span class="c1"># If it is a mosaic, adjust the size to be somewhat larger than one PB, but not the full</span>
                        <span class="c1"># mosaic size to limit the makePSF run times. The resulting beam is still very close to</span>
                        <span class="c1"># what tclean calculates later in the full mosaic size cleaning.</span>
                        <span class="k">if</span> <span class="n">gridder</span> <span class="o">==</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">:</span>
                            <span class="n">imsize_mosaic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2g%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cellv</span><span class="p">,</span> <span class="n">cellu</span><span class="p">)],</span> <span class="n">primary_beam</span><span class="o">=</span><span class="n">largest_primary_beam_size</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">valid_vis_list</span><span class="p">)</span>
                            <span class="n">nxpix_sf</span><span class="p">,</span> <span class="n">nypix_sf</span> <span class="o">=</span> <span class="n">imsize_sf</span>
                            <span class="n">nxpix_mosaic</span><span class="p">,</span> <span class="n">nypix_mosaic</span> <span class="o">=</span> <span class="n">imsize_mosaic</span>
                            <span class="k">if</span> <span class="n">nxpix_mosaic</span> <span class="o">&lt;=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">nxpix_sf</span> <span class="ow">and</span> <span class="n">nypix_mosaic</span> <span class="o">&lt;=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">nypix_sf</span><span class="p">:</span>
                                <span class="n">imsize</span> <span class="o">=</span> <span class="n">imsize_mosaic</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nxpix</span> <span class="o">=</span> <span class="n">suTool</span><span class="o">.</span><span class="n">getOptimumSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">nxpix_sf</span><span class="p">))</span>
                                <span class="n">nypix</span> <span class="o">=</span> <span class="n">suTool</span><span class="o">.</span><span class="n">getOptimumSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">nypix_sf</span><span class="p">))</span>
                                <span class="n">suTool</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                                <span class="n">imsize</span> <span class="o">=</span> <span class="p">[</span><span class="n">nxpix</span><span class="p">,</span> <span class="n">nypix</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">imsize</span> <span class="o">=</span> <span class="n">imsize_sf</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eph_obj</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
                            <span class="n">phasecenter</span> <span class="o">=</span> <span class="s1">&#39;TRACKFIELD&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Note that the local phasecenter variable is intentionally set to the</span>
                            <span class="c1"># second return parameter which is psf_phasecenter. In case &quot;shift&quot; is</span>
                            <span class="c1"># True this may be a different coordinate of the mosaic pointing closest</span>
                            <span class="c1"># to the original phase center value.</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">phasecenter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">valid_vis_list</span><span class="p">,</span> <span class="n">shift_to_nearest_field</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span>
                                                              <span class="n">primary_beam</span><span class="o">=</span><span class="n">largest_primary_beam_size</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                        <span class="n">do_parallel</span> <span class="o">=</span> <span class="n">mpihelpers</span><span class="o">.</span><span class="n">parse_mpi_input_parameter</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
                        <span class="n">paramList</span> <span class="o">=</span> <span class="n">ImagerParameters</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">valid_vis_list</span><span class="p">,</span>
                                                     <span class="n">scan</span><span class="o">=</span><span class="n">valid_scanids_list</span><span class="p">,</span>
                                                     <span class="n">antenna</span><span class="o">=</span><span class="n">valid_antenna_ids_list</span><span class="p">,</span>
                                                     <span class="n">spw</span><span class="o">=</span><span class="n">valid_real_spwid_list</span><span class="p">,</span>
                                                     <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                                                     <span class="n">phasecenter</span><span class="o">=</span><span class="n">phasecenter</span><span class="p">,</span>
                                                     <span class="n">imagename</span><span class="o">=</span><span class="n">tmp_psf_filename</span><span class="p">,</span>
                                                     <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                                                     <span class="n">cell</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.2g%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cellv</span><span class="p">,</span> <span class="n">cellu</span><span class="p">),</span>
                                                     <span class="n">gridder</span><span class="o">=</span><span class="n">gridder</span><span class="p">,</span>
                                                     <span class="n">mosweight</span><span class="o">=</span><span class="n">mosweight</span><span class="p">,</span>
                                                     <span class="n">weighting</span><span class="o">=</span><span class="s1">&#39;briggs&#39;</span><span class="p">,</span>
                                                     <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span>
                                                     <span class="n">uvtaper</span><span class="o">=</span><span class="n">uvtaper</span><span class="p">,</span>
                                                     <span class="n">specmode</span><span class="o">=</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span>
                                                     <span class="n">conjbeams</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">psterm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">mterm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">dopbcorr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">parallel</span><span class="o">=</span><span class="n">do_parallel</span>
                                                     <span class="p">)</span>
                        <span class="k">if</span> <span class="n">do_parallel</span><span class="p">:</span>
                            <span class="n">makepsf_imager</span> <span class="o">=</span> <span class="n">PyParallelContSynthesisImager</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">paramList</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">makepsf_imager</span> <span class="o">=</span> <span class="n">PySynthesisImager</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">paramList</span><span class="p">)</span>
                        <span class="n">makepsf_imager</span><span class="o">.</span><span class="n">initializeImagers</span><span class="p">()</span>
                        <span class="n">makepsf_imager</span><span class="o">.</span><span class="n">initializeNormalizers</span><span class="p">()</span>
                        <span class="n">makepsf_imager</span><span class="o">.</span><span class="n">setWeighting</span><span class="p">()</span>
                        <span class="n">makepsf_imager</span><span class="o">.</span><span class="n">makePSF</span><span class="p">()</span>
                        <span class="n">makepsf_imager</span><span class="o">.</span><span class="n">deleteTools</span><span class="p">()</span>

                        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.psf&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmp_psf_filename</span><span class="p">))</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                            <span class="c1"># Avoid bad PSFs</span>
                            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">):</span>
                                <span class="n">restoringbeam</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()</span>
                                <span class="c1"># CAS-11193: Round to 3 digits to avoid confusion when comparing</span>
                                <span class="c1"># heuristics against the beam weblog display (also using 3 digits)</span>
                                <span class="n">restoringbeam_major_rounded</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">restoringbeam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))))</span>
                                <span class="n">restoringbeam_minor_rounded</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.3g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">restoringbeam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))))</span>
                                <span class="n">restoringbeam_rounded</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;major&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">restoringbeam_major_rounded</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">},</span>
                                                         <span class="s1">&#39;minor&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">restoringbeam_minor_rounded</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">},</span>
                                                         <span class="s1">&#39;positionangle&#39;</span><span class="p">:</span> <span class="n">restoringbeam</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">]}</span>
                                <span class="n">makepsf_beams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">restoringbeam_rounded</span><span class="p">)</span>
                                <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">,</span>
                                                      <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">))),</span> <span class="s1">&#39;beam&#39;</span><span class="p">),</span>
                                                      <span class="n">restoringbeam_rounded</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">,</span>
                                                      <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spwids</span><span class="p">))),</span> <span class="s1">&#39;beam&#39;</span><span class="p">),</span>
                                                      <span class="s1">&#39;invalid&#39;</span><span class="p">)</span>

                        <span class="n">tmp_psf_images</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">glob_ordered</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.*&#39;</span> <span class="o">%</span> <span class="n">tmp_psf_filename</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">tmp_psf_image</span> <span class="ow">in</span> <span class="n">tmp_psf_images</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_psf_image</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">makepsf_beams</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># beam that&#39;s good for all field/intents</span>
            <span class="n">smallest_beam</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;minor&#39;</span><span class="p">:</span> <span class="s1">&#39;1e9arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;major&#39;</span><span class="p">:</span> <span class="s1">&#39;1e9arcsec&#39;</span><span class="p">,</span> <span class="s1">&#39;positionangle&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0deg&#39;</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">beam</span> <span class="ow">in</span> <span class="n">makepsf_beams</span><span class="p">:</span>
                <span class="n">bmin_v</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">bmin_v</span> <span class="o">&lt;</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">smallest_beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)):</span>
                    <span class="n">smallest_beam</span> <span class="o">=</span> <span class="n">beam</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">smallest_beam</span> <span class="o">=</span> <span class="s1">&#39;invalid&#39;</span>

        <span class="k">return</span> <span class="n">smallest_beam</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">local_known_beams</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.cell">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.cell">[docs]</a>
    <span class="k">def</span> <span class="nf">cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">pixperbeam</span><span class="o">=</span><span class="mf">5.0</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate cell size.&quot;&quot;&quot;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cell_size</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span> <span class="o">/</span> <span class="n">pixperbeam</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">arcsec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cell_size</span><span class="p">)]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;invalid&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.nchan_and_width">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.nchan_and_width">[docs]</a>
    <span class="k">def</span> <span class="nf">nchan_and_width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">field_intent</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">:</span>
            <span class="c1"># get the spwids in spwspec</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ,]+(\d+)&quot;</span><span class="p">)</span>
            <span class="n">spwids</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spwspec</span><span class="p">)</span>
            <span class="n">spwids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwids</span><span class="p">)))</span>

            <span class="c1"># Use the first spw for the time being. TBD if this needs to be improved.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
                <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">bandwidth</span>
                <span class="n">chan_widths</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">]</span>

                <span class="c1"># Currently imaging with a channel width of 15 MHz or the native</span>
                <span class="c1"># width if larger and at least 8 channels</span>
                <span class="n">image_chan_width</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">Frequency</span><span class="p">(</span><span class="s1">&#39;15e6&#39;</span><span class="p">,</span> <span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span>
                <span class="n">min_nchan</span> <span class="o">=</span> <span class="mi">8</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">chan_width</span> <span class="o">&gt;=</span> <span class="n">image_chan_width</span> <span class="k">for</span> <span class="n">chan_width</span> <span class="ow">in</span> <span class="n">chan_widths</span><span class="p">])):</span>
                    <span class="n">nchan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">bandwidth</span> <span class="o">&gt;=</span> <span class="n">min_nchan</span> <span class="o">*</span> <span class="n">image_chan_width</span><span class="p">):</span>
                        <span class="n">nchan</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">))</span> <span class="o">/</span>
                                                        <span class="nb">float</span><span class="p">(</span><span class="n">image_chan_width</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">))))</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">image_chan_width</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nchan</span> <span class="o">=</span> <span class="n">min_nchan</span>
                        <span class="n">width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bandwidth</span> <span class="o">/</span> <span class="n">nchan</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine nchan and width for spw </span><span class="si">{</span><span class="n">spwids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">nchan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">nchan</span><span class="p">,</span> <span class="n">width</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.has_data">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.has_data">[docs]</a>
    <span class="k">def</span> <span class="nf">has_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_intent_list</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>

        <span class="c1"># reset state of imager</span>
        <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="c1"># put code in try-block to ensure that imager.done gets</span>
        <span class="c1"># called at the end</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># select data to be imaged</span>
            <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                <span class="n">valid_data</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                    <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
                    <span class="n">scanids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span>
                               <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span> <span class="ow">and</span>
                               <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">scanids</span> <span class="o">!=</span> <span class="p">[]:</span>
                        <span class="n">scanids</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scanids</span><span class="p">)</span>
                        <span class="n">real_spwspec</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ms</span><span class="p">))</span> <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">antenna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_ids</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)])</span>
                            <span class="n">taql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA1==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&amp;&amp;&quot;</span> \
                                   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA2==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="n">rtn</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">selectvis</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                              <span class="n">taql</span><span class="o">=</span><span class="n">taql</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">real_spwspec</span><span class="p">,</span>
                                                              <span class="n">scan</span><span class="o">=</span><span class="n">scanids</span><span class="p">,</span> <span class="n">usescratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">writeaccess</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">rtn</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">aipsfieldofview</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%4.1f</span><span class="s1">arcsec&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">largest_primary_beam_size</span><span class="p">(</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                <span class="c1"># Need to run advise to check if the current selection is completely flagged</span>
                                <span class="n">rtn</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">advise</span><span class="p">(</span><span class="n">takeadvice</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amplitudeloss</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                                               <span class="n">fieldofview</span><span class="o">=</span><span class="n">aipsfieldofview</span><span class="p">)</span>
                                <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">rtn</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">valid_data</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No data for SpW </span><span class="si">%s</span><span class="s1"> field </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                              <span class="p">(</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">casa_tools</span><span class="o">.</span><span class="n">imager</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">valid_data</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.gridder">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.gridder">[docs]</a>
    <span class="k">def</span> <span class="nf">gridder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the gridder to use for the given intent and field.&quot;&quot;&quot;</span>

        <span class="n">field_str_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>

        <span class="c1"># use mosaic gridder for mosaic imaging and/or het.array data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mosaic</span><span class="p">(</span><span class="n">field_str_list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_diameters</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;mosaic&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;standard&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.phasecenter">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.phasecenter">[docs]</a>
    <span class="k">def</span> <span class="nf">phasecenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">centreonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift_to_nearest_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">primary_beam</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">):</span>

        <span class="n">cme</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># Return None for each return value if no fields are input</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">centreonly</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>

        <span class="n">mdirections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sdirections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ivis</span><span class="p">,</span> <span class="n">vis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vislist</span><span class="p">):</span>

            <span class="c1"># Get the visibilities</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">visfields</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="n">ivis</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">visfields</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">visfields</span> <span class="o">=</span> <span class="n">visfields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">visfields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">visfields</span><span class="p">))</span>

            <span class="c1"># Get the phase directions and convert to ICRS</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">visfields</span><span class="p">:</span>
                <span class="c1"># get field centres as measures</span>
                <span class="n">fieldobj</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ref</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getref</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">mdirection</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;ICRS&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;J2000&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;B1950&#39;</span><span class="p">:</span>
                    <span class="n">phase_dir</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">mdirection</span><span class="p">,</span> <span class="s1">&#39;ICRS&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">phase_dir</span> <span class="o">=</span> <span class="n">fieldobj</span><span class="o">.</span><span class="n">mdirection</span>
                <span class="n">mdirections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_dir</span><span class="p">)</span>
                <span class="c1"># Store source direction for ephemeris objects</span>
                <span class="c1"># for later correction of mosaic center position.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_eph_obj</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getref</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;ICRS&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;J2000&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;B1950&#39;</span><span class="p">:</span>
                        <span class="n">phase_dir</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span> <span class="s1">&#39;ICRS&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">phase_dir</span> <span class="o">=</span> <span class="n">fieldobj</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">direction</span>
                    <span class="n">sdirections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phase_dir</span><span class="p">)</span>
                <span class="n">field_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># Correct field directions for ephemeris source motion</span>
        <span class="k">if</span> <span class="n">sdirections</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="n">sdirection_m0_rad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sdirection_m1_rad</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sdirection</span> <span class="ow">in</span> <span class="n">sdirections</span><span class="p">:</span>
                <span class="n">sdirection_m0_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">sdirection</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">)))</span>
                <span class="n">sdirection_m1_rad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">sdirection</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="s1">&#39;rad&#39;</span><span class="p">)))</span>
            <span class="n">avg_sdirection_m0_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sdirection_m0_rad</span><span class="p">)</span>
            <span class="n">avg_sdirection_m1_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">sdirection_m1_rad</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mdirections</span><span class="p">)):</span>
                <span class="n">mdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">sdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">avg_sdirection_m0_rad</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)))</span>
                <span class="n">mdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">sdirections</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;m1&#39;</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">avg_sdirection_m1_rad</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">)))</span>

        <span class="c1"># sanity check - for single field images the field centres from</span>
        <span class="c1"># different measurement sets should be coincident and can</span>
        <span class="c1"># collapse the list</span>
        <span class="c1"># Set the maximum separation to 200 microarcsec and test via</span>
        <span class="c1"># a tolerance rather than an equality.</span>
        <span class="n">max_separation</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="s1">&#39;200uarcsec&#39;</span><span class="p">)</span>

        <span class="n">is_mos_or_het</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mosaic</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_diameters</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_mos_or_het</span><span class="p">:</span>
            <span class="n">max_separation_uarcsec</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">max_separation</span><span class="p">,</span> <span class="s2">&quot;uarcsec&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># in micro arcsec</span>
            <span class="c1"># PIPE-1504: only issue this message at the WARNING level if it&#39;s executed by hifa_imageprecheck</span>
            <span class="k">if</span> <span class="s1">&#39;hifa_imageprecheck&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fn_name</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()]:</span>
                <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>
            <span class="k">for</span> <span class="n">mdirection</span> <span class="ow">in</span> <span class="n">mdirections</span><span class="p">:</span>
                <span class="n">separation</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">mdirection</span><span class="p">,</span> <span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="n">max_separation</span><span class="p">):</span>
                    <span class="n">separation_arcsec</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">separation</span><span class="p">,</span> <span class="s2">&quot;arcsec&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
                        <span class="n">log_level</span><span class="p">,</span>
                        <span class="s2">&quot;The separation between </span><span class="si">%s</span><span class="s2"> field centers across EBs is </span><span class="si">%f</span><span class="s2"> arcseconds (larger than the limit of </span><span class="si">%.1f</span><span class="s2"> microarcseconds). &quot;</span>
                        <span class="s2">&quot;This is only normal for an ephemeris source or a source with a large proper motion or parallax.&quot;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">field_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="n">separation_arcsec</span><span class="p">,</span> <span class="n">max_separation_uarcsec</span><span class="p">))</span>
            <span class="n">mdirections</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

        <span class="c1"># it should be easy to calculate some &#39;average&#39; direction</span>
        <span class="c1"># from the contributing fields but it doesn&#39;t seem to be</span>
        <span class="c1"># at the moment - no conversion between direction measures,</span>
        <span class="c1"># no calculation of a direction from a direction and an</span>
        <span class="c1"># offset. Consequently, what follows is a bit crude.</span>

        <span class="c1"># First, find the offset of all field from field 0.</span>
        <span class="n">xsep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ysep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mdirection</span> <span class="ow">in</span> <span class="n">mdirections</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">posangle</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mdirection</span><span class="p">)</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mdirection</span><span class="p">)</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">cqa</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">pa</span><span class="p">))</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">sep</span><span class="p">,</span> <span class="n">cqa</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">pa</span><span class="p">))</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
            <span class="n">ys</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">ys</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
            <span class="n">xsep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
            <span class="n">ysep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span>

        <span class="n">xsep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xsep</span><span class="p">)</span>
        <span class="n">ysep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ysep</span><span class="p">)</span>
        <span class="n">xspread</span> <span class="o">=</span> <span class="n">xsep</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">xsep</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">yspread</span> <span class="o">=</span> <span class="n">ysep</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">ysep</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">xcen</span> <span class="o">=</span> <span class="n">xsep</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">xspread</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ycen</span> <span class="o">=</span> <span class="n">ysep</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="n">yspread</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># get direction of image centre crudely by adding offset</span>
        <span class="c1"># of centre to ref values of first field.</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getref</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">mdirections</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">])</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">])</span>

        <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">cqa</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">arcsec&#39;</span> <span class="o">%</span> <span class="n">xcen</span><span class="p">,</span> <span class="n">cqa</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">m1</span><span class="p">)))</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">arcsec&#39;</span> <span class="o">%</span> <span class="n">ycen</span><span class="p">)</span>

        <span class="c1"># convert to strings (CASA 4.0 returns as list for some reason</span>
        <span class="c1"># hence 0 index)</span>
        <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;ICRS&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;J2000&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;B1950&#39;</span><span class="p">:</span>
            <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">center</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">direction</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
        <span class="n">phase_center</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
        <span class="n">psf_phase_center</span> <span class="o">=</span> <span class="n">phase_center</span>

        <span class="c1"># If the image center is outside of the mosaic pointings, calculate a PSF phase center</span>
        <span class="c1"># pointing to the nearest field. Both the actual and the PSF phase centers are returned.</span>
        <span class="k">if</span> <span class="n">shift_to_nearest_field</span><span class="p">:</span>
            <span class="n">nearest_field_to_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_field_ids</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">field_names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intent</span><span class="p">,</span> <span class="n">phase_center</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">nearest</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_id</span><span class="o">=</span><span class="n">nearest_field_to_center</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mdirection</span>
            <span class="k">if</span> <span class="n">primary_beam</span><span class="p">:</span>
                <span class="n">pb_dist</span> <span class="o">=</span> <span class="mf">0.408</span>
                <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cme</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">nearest</span><span class="p">),</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pb_dist</span> <span class="o">*</span> <span class="n">primary_beam</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The nearest pointing is &gt; </span><span class="si">{pb_dist}</span><span class="s1">pb away from image center.  &#39;</span>
                             <span class="s1">&#39;Shifting the PSF phase center to the &#39;</span>
                             <span class="s1">&#39;nearest field (id = </span><span class="si">{nf}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pb_dist</span><span class="o">=</span><span class="n">pb_dist</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="n">nearest_field_to_center</span><span class="p">))</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Old phasecenter: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase_center</span><span class="p">))</span>
                    <span class="c1"># convert to strings (CASA 4.0 returns as list for some reason hence 0 index)</span>
                    <span class="n">m0</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">nearest</span><span class="p">)[</span><span class="s1">&#39;m0&#39;</span><span class="p">]</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">nearest</span><span class="p">)[</span><span class="s1">&#39;m1&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;ICRS&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;J2000&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;B1950&#39;</span><span class="p">:</span>
                        <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">10</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">m0</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">m0</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="mi">9</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">psf_phase_center</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;New PSF phasecenter: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">phase_center</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No primary beam supplied.  Will not attempt to shift PSF phasecenter to &#39;</span>
                            <span class="s1">&#39;nearest field w/o a primary beam distance check.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">centreonly</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phase_center</span><span class="p">,</span> <span class="n">psf_phase_center</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">phase_center</span><span class="p">,</span> <span class="n">psf_phase_center</span><span class="p">,</span> <span class="n">xspread</span><span class="p">,</span> <span class="n">yspread</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.field">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.field">[docs]</a>
    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">exclude_intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>

        <span class="n">field_str_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>

            <span class="n">field_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># field set explicitly</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_names</span> <span class="o">=</span> <span class="n">field</span>

                <span class="c1"># convert to field ids</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">field_names</span><span class="p">:</span>
                    <span class="n">field_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span>
                                   <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">fld</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>

            <span class="k">if</span> <span class="n">intent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># pattern matching to allow intents of form *TARGET* to work</span>
                <span class="n">re_intent</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exclude_intent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">re_exclude_intent</span> <span class="o">=</span> <span class="n">exclude_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
                    <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span>
                                  <span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_list</span> <span class="ow">and</span> <span class="n">re_intent</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">intents</span> <span class="ow">and</span> <span class="n">re_exclude_intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">fields</span> <span class="k">if</span>
                                  <span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_list</span> <span class="ow">and</span> <span class="n">re_intent</span> <span class="ow">in</span> <span class="n">fld</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>

            <span class="n">field_string</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fld_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">fld_id</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">)</span>
            <span class="n">field_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_string</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field_str_list</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.select_fields">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.select_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">select_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phasecenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Select fields id based on intent, field name, or separation constrains from the phasecenter</span>

<span class="sd">        This method selects fields based on the following search rules:</span>
<span class="sd">            intent: restrict the search by the field intent</span>
<span class="sd">            name: restrict the search id by the field name.</span>
<span class="sd">            phasecenter, offsets: restrict the search area in an on-sky box centered around phasecenter</span>

<span class="sd">        Args:</span>
<span class="sd">            intent (str, optional): intent string. Defaults to &#39;TARGET&#39;.</span>
<span class="sd">            name (str, optional): name string, which could be a wildcard like &#39;1*,2*,0*&#39; Defaults to None.</span>
<span class="sd">            phasecenter (str, optional): center of the search box. Defaults to None.</span>
<span class="sd">            offsets (optional): sky offsets search limits along the longitude/ latitude direction in the reference frame. </span>
<span class="sd">                Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: a list; each element is the selected field id list per measurement sets.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fields_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">select</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">intent_set</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">intent_set</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="n">name_pats</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name_pat</span><span class="p">)</span> <span class="k">for</span> <span class="n">name_pat</span> <span class="ow">in</span> <span class="n">name_pats</span><span class="p">])</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

                <span class="n">coord_phasecenter</span> <span class="o">=</span> <span class="n">phasecenter_to_skycoord</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">)</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">refcode_to_skyframe</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                <span class="n">coord_phasecenter</span> <span class="o">=</span> <span class="n">coord_phasecenter</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>

                <span class="n">coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">],</span>
                    <span class="n">frame</span><span class="o">=</span><span class="n">frame</span><span class="p">,</span>
                    <span class="n">unit</span><span class="o">=</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">longitude</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">],</span> <span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latitude</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]))</span>
                <span class="n">dra</span><span class="p">,</span> <span class="n">ddec</span> <span class="o">=</span> <span class="n">coord_phasecenter</span><span class="o">.</span><span class="n">spherical_offsets_to</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">offsets_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">offsets</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">offsets_limit</span> <span class="o">=</span> <span class="n">offsets</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Searching for fields within the maximum sky offsets of </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> .&#39;</span><span class="p">,</span> <span class="n">offsets_limit</span><span class="p">,</span> <span class="n">phasecenter</span><span class="p">)</span>
                <span class="n">select</span> <span class="o">=</span> <span class="n">select</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dra</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">offsets_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ddec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">offsets_limit</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">%s</span><span class="s1"> of </span><span class="si">%s</span><span class="s1"> fields out meeting the selection rule(s) in </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">select</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">select</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span>
            <span class="n">fields_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="k">if</span> <span class="n">select</span><span class="p">[</span><span class="n">idx</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">fields_list</span></div>


    <span class="k">def</span> <span class="nf">_is_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_str_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if it&#39;s a mosaic or not.</span>

<span class="sd">        We consider imaging to be a mosaic if there is more than 1 field_id for any ms.</span>
<span class="sd">        field_str_list is a list of strings, one for each ms, containing the field_ids joined by commas.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">is_mosaic</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">field_str</span> <span class="ow">in</span> <span class="n">field_str_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">field_str</span><span class="p">:</span>
                <span class="n">is_mosaic</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">is_mosaic</span>

<div class="viewcode-block" id="ImageParamsHeuristics.is_mosaic">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.is_mosaic">[docs]</a>
    <span class="k">def</span> <span class="nf">is_mosaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determines if the given field/intent from a MS list is considered as a mosaic or not.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>

        <span class="n">field_str_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vislist</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mosaic</span><span class="p">(</span><span class="n">field_str_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.is_eph_obj">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.is_eph_obj">[docs]</a>
    <span class="k">def</span> <span class="nf">is_eph_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">]:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">ms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Image Heuristics Ephemeris Object Check: Field </span><span class="si">%s</span><span class="s1"> not found.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Image Heuristics Ephemeris Object Check: Field </span><span class="si">%s</span><span class="s1"> not found.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span>
            <span class="n">is_eph_obj</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">source_name</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">is_eph_obj</span><span class="p">):</span>
                    <span class="n">is_eph_obj</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">is_eph_obj</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.aggregate_bandwidth">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.aggregate_bandwidth">[docs]</a>
    <span class="k">def</span> <span class="nf">aggregate_bandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">spwids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_spwids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spwids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_spwids</span> <span class="o">=</span> <span class="n">spwids</span>


        <span class="n">spw_frequency_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">local_spwids</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
                <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                <span class="c1"># PIPE-1886</span>
                <span class="c1"># real_spwid can be NONE when the original B2B dataset read in</span>
                <span class="c1"># with low and high freq spectral specs has all SPW in the</span>
                <span class="c1"># list passed to this function (cont_spw_ids, from function</span>
                <span class="c1"># representative_target, BELOW)</span>
                <span class="c1"># if it is a None and we do have B2B data, use continue to</span>
                <span class="c1"># ignore this spw which doesnt exist in the _target MS</span>

                <span class="c1"># PIPE-1935 reported the same error for cases of fully</span>
                <span class="c1"># flagged spws where the new hif_uvcontsub skipped the</span>
                <span class="c1"># spw in the subsequent MSes. Thus this patch should</span>
                <span class="c1"># be applied to all cases, not just B2B.</span>

                <span class="c1"># PIPE-1947 uncovered a wider problem of subsets of vis lists</span>
                <span class="c1"># not containing data for a given spw ID. The new get_ref_msname</span>
                <span class="c1"># method will throw an exception if there is no MS available,</span>
                <span class="c1"># so one should never have the following case, but as it is</span>
                <span class="c1"># close to finishing PL2023, we leave this statement for the</span>
                <span class="c1"># time being.</span>
                <span class="k">if</span> <span class="n">real_spwid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
                <span class="n">min_frequency_Hz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">max_frequency_Hz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">spw_frequency_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">min_frequency_Hz</span><span class="p">,</span> <span class="n">max_frequency_Hz</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># The warning message should only be logged if not in ALMA B2B mode (PIPE-832).</span>
                <span class="c1"># Eventually, the &quot;aggregrate_bandwidth&quot; method should not even be called for</span>
                <span class="c1"># spws that do not have data for a given field. This requires more elaborate</span>
                <span class="c1"># refactoring of standard science spws given to the heuristics and in particular</span>
                <span class="c1"># to the &quot;representative_target&quot; method.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># One can not try the above &quot;ms&quot; object as it will be undefined when checking</span>
                    <span class="c1"># LF spws. So here just trying the first in the list.</span>
                    <span class="n">checkMS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">b2bMode</span> <span class="o">=</span> <span class="n">checkMS</span><span class="o">.</span><span class="n">is_band_to_band</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">b2bMode</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">b2bMode</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine aggregate bandwidth frequency range for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">aggregate_bandwidth_Hz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_ranges</span><span class="p">(</span><span class="n">spw_frequency_ranges</span><span class="p">)])</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">aggregate_bandwidth_Hz</span><span class="p">,</span> <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="s1">&#39;Hz&#39;</span><span class="p">}</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.representative_target">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.representative_target">[docs]</a>
    <span class="k">def</span> <span class="nf">representative_target</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">repr_ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">repr_target</span> <span class="o">=</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">representative_target</span>

        <span class="n">reprBW_mode</span> <span class="o">=</span> <span class="s1">&#39;nbin&#39;</span>
        <span class="k">if</span> <span class="n">repr_target</span> <span class="o">!=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">repr_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
            <span class="n">real_repr_target</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">repr_freq</span> <span class="o">=</span> <span class="n">repr_target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Get representative source and spw</span>
            <span class="n">repr_source</span><span class="p">,</span> <span class="n">repr_spw</span> <span class="o">=</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">get_representative_source_spw</span><span class="p">()</span>
            <span class="c1"># Check if representative bandwidth is larger than spw bandwidth. If so, switch to fullcont.</span>
            <span class="n">repr_spw_obj</span> <span class="o">=</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">repr_spw</span><span class="p">)</span>
            <span class="n">repr_spw_bw</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">repr_spw_obj</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
            <span class="n">cont_spw_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_ids</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">agg_bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_bandwidth</span><span class="p">(</span><span class="n">cont_spw_ids</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">repr_target</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">agg_bw</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)):</span>
                <span class="n">reprBW_mode</span> <span class="o">=</span> <span class="s1">&#39;all_spw&#39;</span>
            <span class="k">elif</span> <span class="n">cqa</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">repr_target</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">repr_spw_bw</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cqa</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">repr_target</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">agg_bw</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)):</span>
                <span class="n">reprBW_mode</span> <span class="o">=</span> <span class="s1">&#39;multi_spw&#39;</span>
            <span class="k">elif</span> <span class="n">cqa</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">repr_target</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">repr_spw_bw</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)):</span>
                <span class="n">reprBW_mode</span> <span class="o">=</span> <span class="s1">&#39;repr_spw&#39;</span>

            <span class="n">science_goals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">science_goals</span>

            <span class="c1"># Check if there is a non-zero min/max angular resolution</span>
            <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span><span class="o">.</span><span class="n">min_angular_resolution</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
            <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span><span class="o">.</span><span class="n">max_angular_resolution</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">minAcceptableAngResolution</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">maxAcceptableAngResolution</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">desired_angular_resolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span><span class="o">.</span><span class="n">desired_angular_resolution</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">desired_angular_resolution</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">desired_angular_resolution</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
                    <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">desired_angular_resolution</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>
                    <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)</span>

            <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">]</span>

            <span class="c1"># Check if there is a non-zero sensitivity goal</span>
            <span class="n">sensitivityGoal</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj_params</span><span class="o">.</span><span class="n">desired_sensitivity</span><span class="p">,</span> <span class="s1">&#39;mJy&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">sensitivityGoal</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">sensitivityGoal</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">],</span> <span class="s1">&#39;mJy&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">real_repr_target</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Fall back to existing source</span>
            <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">target_sources</span> <span class="o">==</span> <span class="p">[]:</span>
                <span class="k">if</span> <span class="n">repr_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No TARGET intent found. Trying to select a representative source from calibration intents.&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">repr_intent</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span> <span class="s1">&#39;BANDPASS&#39;</span><span class="p">]:</span>
                        <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="n">repr_intent</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">target_sources</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">target_sources</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot select any representative target from calibration intents.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot select any representative target from TARGET intent.&#39;</span><span class="p">)</span>

            <span class="n">repr_source</span> <span class="o">=</span> <span class="n">target_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">repr_spw_obj</span> <span class="o">=</span> <span class="n">repr_ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">repr_spw</span> <span class="o">=</span> <span class="n">repr_spw_obj</span><span class="o">.</span><span class="n">id</span>
            <span class="n">repr_chan_obj</span> <span class="o">=</span> <span class="n">repr_spw_obj</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">repr_spw_obj</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="n">repr_freq</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">repr_chan_obj</span><span class="o">.</span><span class="n">getCentreFrequency</span><span class="p">()</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
            <span class="n">repr_bw</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">repr_chan_obj</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)</span>
            <span class="n">repr_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">repr_source</span><span class="p">,</span> <span class="n">repr_freq</span><span class="p">,</span> <span class="n">repr_bw</span><span class="p">)</span>

            <span class="n">minAcceptableAngResolution</span> <span class="o">=</span> <span class="s1">&#39;0.0arcsec&#39;</span>
            <span class="n">maxAcceptableAngResolution</span> <span class="o">=</span> <span class="s1">&#39;0.0arcsec&#39;</span>
            <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="s1">&#39;0.0&#39;</span>
            <span class="n">sensitivityGoal</span> <span class="o">=</span> <span class="s1">&#39;0.0mJy&#39;</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Image Heuristics: No representative target found. Choosing </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%d</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">repr_source</span><span class="p">,</span> <span class="n">repr_spw</span><span class="p">))</span>

        <span class="n">virtual_repr_spw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">repr_spw</span><span class="p">,</span> <span class="n">repr_ms</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">repr_target</span><span class="p">,</span> <span class="n">repr_source</span><span class="p">,</span> <span class="n">virtual_repr_spw</span><span class="p">,</span> <span class="n">repr_freq</span><span class="p">,</span> <span class="n">reprBW_mode</span><span class="p">,</span> <span class="n">real_repr_target</span><span class="p">,</span> <span class="n">minAcceptableAngResolution</span><span class="p">,</span> <span class="n">maxAcceptableAngResolution</span><span class="p">,</span> <span class="n">maxAllowedBeamAxialRatio</span><span class="p">,</span> <span class="n">sensitivityGoal</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.imsize">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.imsize">[docs]</a>
    <span class="k">def</span> <span class="nf">imsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">primary_beam</span><span class="p">,</span> <span class="n">sfpblimit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_pixels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">centreonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">joint_intents</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Image size heuristics for single fields and mosaics. The pixel count along x and y image dimensions</span>
<span class="sd">        is determined by the cell size, primary beam size and the spread of phase centers in case of mosaics.</span>

<span class="sd">        :param fields: list of comma separated strings of field IDs per MS.</span>
<span class="sd">        :param cell: pixel (cell) size in arcsec.</span>
<span class="sd">        :param primary_beam: primary beam width in arcsec.</span>
<span class="sd">        :param sfpblimit: single field primary beam response. If provided then imsize is chosen such that the image</span>
<span class="sd">            edge is at normalised primary beam level equals to sfpblimit.</span>
<span class="sd">        :param max_pixels: maximum allowed pixel count, integer. The same limit is applied along both image axes.</span>
<span class="sd">        :param centreonly: if True, then ignore the spread of field centers.</span>
<span class="sd">        :param vislist: list of visibility path string to be used for imaging. If not set then use all visibilities</span>
<span class="sd">            in the context.</span>
<span class="sd">        :param spwspec: ID list of spectral windows used to create image product. List or string containing comma</span>
<span class="sd">            separated spw IDs list. Not used in the base method.</span>
<span class="sd">        :param intent: field/source intent</span>
<span class="sd">        :param joint_intents: stage intents</span>
<span class="sd">        :return: two element list of pixel count along x and y image axes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># For the time being PIPE-1829 asks for a fixed imsize</span>
        <span class="c1"># for polarization calibrators. The subsequent image</span>
        <span class="c1"># analysis depends on the exact numbers. The IQUV imaging</span>
        <span class="c1"># and analysis is only performed if the stage asks for</span>
        <span class="c1"># polarization intent only.</span>
        <span class="k">if</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;POLARIZATION&#39;</span> <span class="ow">and</span> <span class="n">joint_intents</span> <span class="o">==</span> <span class="s1">&#39;POLARIZATION&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>

        <span class="c1"># get spread of beams</span>
        <span class="k">if</span> <span class="n">centreonly</span><span class="p">:</span>
            <span class="n">xspread</span> <span class="o">=</span> <span class="n">yspread</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">xspread</span><span class="p">,</span> <span class="n">yspread</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">centreonly</span><span class="o">=</span><span class="n">centreonly</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vislist</span><span class="p">)</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">csu</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">synthesisutils</span>

        <span class="n">cellx</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">celly</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">celly</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">cellx</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">celly</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get cell and beam sizes in arcsec</span>
        <span class="n">cellx_v</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cellx</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span>
        <span class="n">celly_v</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">celly</span><span class="p">,</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span>
        <span class="n">beam_radius_v</span> <span class="o">=</span> <span class="n">primary_beam</span>

        <span class="c1"># set size of image to spread of field centres plus a</span>
        <span class="c1"># border of 0.75 (0.825) * beam radius (radius is to</span>
        <span class="c1"># first null) wide</span>
        <span class="n">nfields</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">field_ids</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">field_ids</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">]))</span>
        <span class="n">is_mos_or_het</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_mosaic</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_diameters</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">is_mos_or_het</span> <span class="ow">and</span> <span class="n">nfields</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># PIPE-209 asks for a slightly larger size for small (2-3 field) mosaics.</span>
            <span class="n">nxpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.65</span> <span class="o">*</span> <span class="n">beam_radius_v</span> <span class="o">+</span> <span class="n">xspread</span><span class="p">)</span> <span class="o">/</span> <span class="n">cellx_v</span><span class="p">)</span>
            <span class="n">nypix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.65</span> <span class="o">*</span> <span class="n">beam_radius_v</span> <span class="o">+</span> <span class="n">yspread</span><span class="p">)</span> <span class="o">/</span> <span class="n">celly_v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nxpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">beam_radius_v</span> <span class="o">+</span> <span class="n">xspread</span><span class="p">)</span> <span class="o">/</span> <span class="n">cellx_v</span><span class="p">)</span>
            <span class="n">nypix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">beam_radius_v</span> <span class="o">+</span> <span class="n">yspread</span><span class="p">)</span> <span class="o">/</span> <span class="n">celly_v</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">is_mos_or_het</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sfpblimit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">beam_fwhp</span> <span class="o">=</span> <span class="mf">1.12</span> <span class="o">/</span> <span class="mf">1.22</span> <span class="o">*</span> <span class="n">beam_radius_v</span>
            <span class="n">nxpix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">beam_fwhp</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sfpblimit</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">/</span> <span class="n">cellx_v</span><span class="p">))</span>
            <span class="n">nypix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">(</span><span class="mf">1.1</span> <span class="o">*</span> <span class="n">beam_fwhp</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sfpblimit</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">/</span> <span class="n">celly_v</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">max_pixels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nxpix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nxpix</span><span class="p">,</span> <span class="n">max_pixels</span><span class="p">)</span>
            <span class="n">nypix</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nypix</span><span class="p">,</span> <span class="n">max_pixels</span><span class="p">)</span>

        <span class="c1"># set nxpix, nypix to next highest &#39;composite number&#39;</span>
        <span class="n">nxpix</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">getOptimumSize</span><span class="p">(</span><span class="n">nxpix</span><span class="p">)</span>
        <span class="n">nypix</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">getOptimumSize</span><span class="p">(</span><span class="n">nypix</span><span class="p">)</span>
        <span class="n">csu</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">nxpix</span><span class="p">,</span> <span class="n">nypix</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.imagename">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.imagename">[docs]</a>
    <span class="k">def</span> <span class="nf">imagename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imagename_prefix</span>
            <span class="k">if</span> <span class="n">nameroot</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">:</span>
                <span class="n">nameroot</span> <span class="o">=</span> <span class="s1">&#39;oussid&#39;</span>
            <span class="c1"># need to sanitize the nameroot here because when it&#39;s added</span>
            <span class="c1"># to filenamer as an asdm, os.path.basename is run on it with</span>
            <span class="c1"># undesirable results.</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">nameroot</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nameroot</span> <span class="o">=</span> <span class="s1">&#39;oussid&#39;</span>
        <span class="n">namer</span> <span class="o">=</span> <span class="n">filenamer</span><span class="o">.</span><span class="n">Image</span><span class="p">()</span>
        <span class="n">namer</span><span class="o">.</span><span class="n">_associations</span><span class="o">.</span><span class="n">asdm</span><span class="p">(</span><span class="n">nameroot</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">output_dir</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">output_dir</span><span class="p">(</span><span class="n">output_dir</span><span class="p">)</span>

        <span class="n">namer</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="s1">&#39;STAGENUMBER&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intent</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">intent</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spwspec</span><span class="p">:</span>
            <span class="c1"># find all the spwids present in the list</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[ ,]+(\d+)&quot;</span><span class="p">)</span>
            <span class="n">spwids</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spwspec</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">set</span><span class="p">(</span><span class="n">spwids</span><span class="p">)))))</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">spectral_window</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">specmode</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">specmode</span><span class="p">(</span><span class="n">specmode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">:</span>
            <span class="n">namer</span><span class="o">.</span><span class="n">datatype</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>

        <span class="c1"># filenamer returns a sanitized filename (i.e. one with</span>
        <span class="c1"># illegal characters replace by &#39;_&#39;), no need to check</span>
        <span class="c1"># the name components individually.</span>
        <span class="n">imagename</span> <span class="o">=</span> <span class="n">namer</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">imagename</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.width">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.width">[docs]</a>
    <span class="k">def</span> <span class="nf">width</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwid</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
            <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>

            <span class="c1"># negative widths appear to confuse clean,</span>
            <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">&gt;</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">high</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">high</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">high</span>
            <span class="c1"># increase width slightly to try to avoid the error:</span>
            <span class="c1"># WARN SubMS::convertGridPars *** Requested new channel width is</span>
            <span class="c1"># smaller than smallest original channel width.</span>
            <span class="c1"># This should no longer be necessary (CASA &gt;=4.7) and this width</span>
            <span class="c1"># method does not seem to be used anywhere anyways.</span>
            <span class="c1"># width = decimal.Decimal(&#39;1.0001&#39;) * width</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine width for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">width</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">width</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.ncorr">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.ncorr">[docs]</a>
    <span class="k">def</span> <span class="nf">ncorr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwid</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
            <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>

            <span class="c1"># Get the data description for this spw</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Missing data description for spw </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">spwid</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="c1"># Determine the number of correlations</span>
            <span class="c1">#   Check that they are between 1 and 4</span>
            <span class="n">ncorr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dd</span><span class="o">.</span><span class="n">corr_axis</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ncorr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">}:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Wrong number of correlations </span><span class="si">%s</span><span class="s1"> for spw </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ncorr</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
                <span class="n">ncorr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine ncorr for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ncorr</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">ncorr</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.pblimits">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.pblimits">[docs]</a>
    <span class="k">def</span> <span class="nf">pblimits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pb</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">specmode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="n">pblimit_image</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">pblimit_cleanmask</span> <span class="o">=</span> <span class="mf">0.3</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pb</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">image</span>
                <span class="n">iaTool</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
                <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">nf</span> <span class="o">=</span> <span class="n">iaTool</span><span class="o">.</span><span class="n">shape</span><span class="p">()</span>

                <span class="c1"># First check if the center edge is masked. If so, then the</span>
                <span class="c1"># default pb level of 0.2 is fully within the image and no</span>
                <span class="c1"># adjustment is needed.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">iaTool</span><span class="o">.</span><span class="n">getchunk</span><span class="p">([</span><span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">nx</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">getmask</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="n">pblimit_image</span><span class="p">,</span> <span class="n">pblimit_cleanmask</span>

                <span class="n">pb_edge</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">i_pb_edge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="c1"># There are cases with zero edged PBs (due to masking),</span>
                <span class="c1"># check for first unmasked value.</span>
                <span class="c1"># Should no longer encounter the mask here due to the</span>
                <span class="c1"># above check, but keep code around for now.</span>
                <span class="k">while</span> <span class="n">pb_edge</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">i_pb_edge</span> <span class="o">&lt;</span> <span class="n">ny</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">i_pb_edge</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">pb_edge</span> <span class="o">=</span> <span class="n">iaTool</span><span class="o">.</span><span class="n">getchunk</span><span class="p">([</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_edge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_edge</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pb_edge</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">):</span>
                    <span class="n">i_pb_image</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">i_pb_edge</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">ny</span><span class="p">))</span>
                    <span class="n">pblimit_image</span> <span class="o">=</span> <span class="n">iaTool</span><span class="o">.</span><span class="n">getchunk</span><span class="p">([</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">i_pb_cleanmask</span> <span class="o">=</span> <span class="n">i_pb_image</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">ny</span><span class="p">)</span>
                    <span class="n">pblimit_cleanmask</span> <span class="o">=</span> <span class="n">iaTool</span><span class="o">.</span><span class="n">getchunk</span><span class="p">([</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_cleanmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">i_pb_cleanmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nf</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not analyze PB: </span><span class="si">%s</span><span class="s1">. Using default pblimit values.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">iaTool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">pblimit_image</span><span class="p">,</span> <span class="n">pblimit_cleanmask</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.deconvolver">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.deconvolver">[docs]</a>
    <span class="k">def</span> <span class="nf">deconvolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">stokes</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;POLARIZATION&#39;</span> <span class="ow">and</span> <span class="n">stokes</span> <span class="o">==</span> <span class="s1">&#39;IQUV&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;clarkstokes&#39;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span>
            <span class="n">fr_bandwidth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fractional_bandwidth</span><span class="p">(</span><span class="n">spwspec</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fr_bandwidth</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">):</span>
                <span class="k">return</span> <span class="s1">&#39;mtmfs&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;hogbom&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;hogbom&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_min_max_freq">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_min_max_freq">[docs]</a>
    <span class="k">def</span> <span class="nf">get_min_max_freq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a comma separated string list of spectral windows, determines the minimum and maximum</span>
<span class="sd">        frequencies in spectral window list and the corresponding spectral window indexes.</span>

<span class="sd">        :param spwspec: comma separated string list of spectral windows.</span>
<span class="sd">        :return: dictionary min. and max. frequencies (in Hz) and corresponding spw indexes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">abs_min_frequency</span> <span class="o">=</span> <span class="mf">1.0e15</span>
        <span class="n">abs_max_frequency</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">min_freq_spwid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">max_freq_spwid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
                <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
                <span class="n">min_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">min_frequency</span> <span class="o">&lt;</span> <span class="n">abs_min_frequency</span><span class="p">):</span>
                    <span class="n">abs_min_frequency</span> <span class="o">=</span> <span class="n">min_frequency</span>
                    <span class="n">min_freq_spwid</span> <span class="o">=</span> <span class="n">spwid</span>
                <span class="n">max_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">))</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">max_frequency</span> <span class="o">&gt;</span> <span class="n">abs_max_frequency</span><span class="p">):</span>
                    <span class="n">abs_max_frequency</span> <span class="o">=</span> <span class="n">max_frequency</span>
                    <span class="n">max_freq_spwid</span> <span class="o">=</span> <span class="n">spwid</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine min/max frequency for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;abs_min_freq&#39;</span><span class="p">:</span> <span class="n">abs_min_frequency</span><span class="p">,</span> <span class="s1">&#39;abs_max_freq&#39;</span><span class="p">:</span> <span class="n">abs_max_frequency</span><span class="p">,</span>
                <span class="s1">&#39;min_freq_spwid&#39;</span><span class="p">:</span> <span class="n">min_freq_spwid</span><span class="p">,</span> <span class="s1">&#39;max_freq_spwid&#39;</span><span class="p">:</span> <span class="n">max_freq_spwid</span><span class="p">}</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_fractional_bandwidth">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_fractional_bandwidth">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fractional_bandwidth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns fractional bandwidth for selected spectral windows&quot;&quot;&quot;</span>

        <span class="n">freq_limits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_min_max_freq</span><span class="p">(</span><span class="n">spwspec</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">freq_limits</span><span class="p">[</span><span class="s1">&#39;abs_max_freq&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq_limits</span><span class="p">[</span><span class="s1">&#39;abs_min_freq&#39;</span><span class="p">])</span> <span class="o">/</span> \
               <span class="p">(</span><span class="n">freq_limits</span><span class="p">[</span><span class="s1">&#39;abs_min_freq&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">freq_limits</span><span class="p">[</span><span class="s1">&#39;abs_max_freq&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.robust">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.robust">[docs]</a>
    <span class="k">def</span> <span class="nf">robust</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default robust value.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="mf">0.5</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.center_field_ids">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.center_field_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">center_field_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msnames</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">phasecenter</span><span class="p">,</span> <span class="n">exclude_intent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get per-MS IDs of field closest to the phase center.&quot;&quot;&quot;</span>

        <span class="n">meTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">ref_field_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Phase center coordinates</span>
        <span class="n">pc_direc</span> <span class="o">=</span> <span class="n">meTool</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">phasecenter</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">msnames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ms_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">exclude_intent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms_obj</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">intent</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">intents</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms_obj</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">intent</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">exclude_intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">intents</span><span class="p">)]</span>
                <span class="n">separations</span> <span class="o">=</span> <span class="p">[</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">meTool</span><span class="o">.</span><span class="n">separation</span><span class="p">(</span><span class="n">pc_direc</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">mdirection</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms_obj</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">]</span>
                <span class="n">ref_field_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_ids</span><span class="p">[</span><span class="n">separations</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">separations</span><span class="p">))])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ref_field_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ref_field_ids</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.calc_topo_ranges">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.calc_topo_ranges">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_topo_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate TOPO ranges for hif_tclean inputs.</span>

<span class="sd">        Note: we might consider consolidating this with the similar code in contfilehelper.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spw_topo_freq_param_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spw_topo_chan_param_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spw_topo_freq_param_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">spw_topo_chan_param_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([\d.]*)(~)([\d.]*)(\D*)&#39;</span><span class="p">)</span>
        <span class="n">total_topo_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">topo_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">num_channels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">meTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># Phase center coordinates</span>
        <span class="n">pc_direc</span> <span class="o">=</span> <span class="n">meTool</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">)</span>

        <span class="c1"># Get per-MS IDs of field closest to the phase center</span>
        <span class="n">ref_field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_field_ids</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span> <span class="n">pc_direc</span><span class="p">)</span>

        <span class="c1"># Get a cont file handler for the conversion to TOPO</span>
        <span class="n">contfile_handler</span> <span class="o">=</span> <span class="n">contfilehandler</span><span class="o">.</span><span class="n">ContFileHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contfile</span><span class="p">)</span>

        <span class="n">aggregate_lsrk_bw</span> <span class="o">=</span> <span class="s1">&#39;0.0GHz&#39;</span>

        <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
                <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
                <span class="n">spw_info</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>

                <span class="n">num_channels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw_info</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>

                <span class="n">min_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_info</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">GIGAHERTZ</span><span class="p">))</span>
                <span class="n">max_frequency</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_info</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">GIGAHERTZ</span><span class="p">))</span>

                <span class="c1"># Save spw width</span>
                <span class="n">total_topo_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">min_frequency</span><span class="p">,</span> <span class="n">max_frequency</span><span class="p">))</span>

                <span class="k">if</span> <span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">spwsel_lsrk</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">spwsel_lsrk</span><span class="p">[</span><span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALLCONT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">)):</span>
                        <span class="n">freq_selection</span><span class="p">,</span> <span class="n">refer</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">spwsel_lsrk</span><span class="p">[</span><span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">refer</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">,</span> <span class="s1">&#39;REST&#39;</span><span class="p">)):</span>
                            <span class="c1"># Convert to TOPO</span>
                            <span class="n">spw_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spwid</span><span class="p">)]</span>
                            <span class="n">topo_freq_selections</span><span class="p">,</span> <span class="n">topo_chan_selections</span><span class="p">,</span> <span class="n">aggregate_spw_lsrk_bw</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">to_topo</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">spwsel_lsrk</span><span class="p">[</span><span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">ref_field_ids</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">)</span>
                            <span class="n">spw_topo_freq_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">topo_freq_selection</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">topo_freq_selection</span> <span class="ow">in</span> <span class="n">topo_freq_selections</span><span class="p">])</span>
                            <span class="n">spw_topo_chan_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">topo_chan_selection</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">topo_chan_selection</span> <span class="ow">in</span> <span class="n">topo_chan_selections</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)):</span>
                                <span class="n">spw_topo_freq_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">topo_freq_selections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">topo_chan_selections</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Count only one selection !</span>
                            <span class="k">for</span> <span class="n">topo_freq_range</span> <span class="ow">in</span> <span class="n">topo_freq_selections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                                <span class="n">f1</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">topo_freq_range</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">topo_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Cannot convert </span><span class="si">{!s}</span><span class="s1"> frequency selection properly to TOPO. Using plain ranges for all MSs.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">refer</span><span class="p">))</span>
                            <span class="n">spw_topo_freq_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">freq_selection</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                            <span class="c1"># TODO: Need to derive real channel ranges</span>
                            <span class="n">spw_topo_chan_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:0~</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">spw_info</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)):</span>
                                <span class="n">spw_topo_freq_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">freq_selection</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="c1"># TODO: Need to derive real channel ranges</span>
                                <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="n">i</span><span class="p">])][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw_info</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="c1"># Count only one selection !</span>
                            <span class="n">aggregate_spw_lsrk_bw</span> <span class="o">=</span> <span class="s1">&#39;0.0GHz&#39;</span>
                            <span class="k">for</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="n">freq_selection</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>
                                <span class="n">f1</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">f2</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">topo_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">f1</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">f2</span><span class="p">)))</span>
                                <span class="n">delta_f</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">unit</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">unit</span><span class="p">))</span>
                                <span class="n">aggregate_spw_lsrk_bw</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aggregate_spw_lsrk_bw</span><span class="p">,</span> <span class="n">delta_f</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spw_topo_freq_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                        <span class="n">spw_topo_chan_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">:</span>
                            <span class="n">spw_topo_freq_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">topo_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">min_frequency</span><span class="p">,</span> <span class="n">max_frequency</span><span class="p">))</span>
                        <span class="n">aggregate_spw_lsrk_bw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_frequency</span> <span class="o">-</span> <span class="n">min_frequency</span><span class="p">)</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">spwsel_lsrk</span><span class="p">[</span><span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALLCONT&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_missing_cont_ranges</span><span class="p">()):</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No continuum frequency selection for Target Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spw_topo_freq_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                    <span class="n">spw_topo_chan_param_lists</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">:</span>
                        <span class="n">spw_topo_freq_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="n">topo_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">min_frequency</span><span class="p">,</span> <span class="n">max_frequency</span><span class="p">))</span>
                    <span class="n">aggregate_spw_lsrk_bw</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_frequency</span> <span class="o">-</span> <span class="n">min_frequency</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_missing_cont_ranges</span><span class="p">()):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No continuum frequency selection for Target Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spwid</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine min/max frequency for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">aggregate_lsrk_bw</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aggregate_lsrk_bw</span><span class="p">,</span> <span class="n">aggregate_spw_lsrk_bw</span><span class="p">)</span>

        <span class="n">spw_topo_freq_param</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spwsel_per_ms</span><span class="p">)</span> <span class="k">for</span> <span class="n">spwsel_per_ms</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">spw_topo_freq_param_list_per_ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">spw_topo_freq_param_list_per_ms</span> <span class="ow">in</span> <span class="n">spw_topo_freq_param_lists</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))]]</span>
        <span class="n">spw_topo_chan_param</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spwsel_per_ms</span><span class="p">)</span> <span class="k">for</span> <span class="n">spwsel_per_ms</span> <span class="ow">in</span> <span class="p">[[</span><span class="n">spw_topo_chan_param_list_per_ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">spw_topo_chan_param_list_per_ms</span> <span class="ow">in</span> <span class="n">spw_topo_chan_param_lists</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">))]]</span>

        <span class="c1"># Calculate total bandwidth</span>
        <span class="n">total_topo_bw</span> <span class="o">=</span> <span class="s1">&#39;0.0GHz&#39;</span>
        <span class="k">for</span> <span class="n">total_topo_freq_range</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_ranges</span><span class="p">(</span><span class="n">total_topo_freq_ranges</span><span class="p">):</span>
            <span class="n">total_topo_bw</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">total_topo_bw</span><span class="p">,</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_topo_freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_topo_freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>

        <span class="c1"># Calculate aggregate selected bandwidth</span>
        <span class="n">aggregate_topo_bw</span> <span class="o">=</span> <span class="s1">&#39;0.0GHz&#39;</span>
        <span class="k">for</span> <span class="n">topo_freq_range</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_ranges</span><span class="p">(</span><span class="n">topo_freq_ranges</span><span class="p">):</span>
            <span class="n">aggregate_topo_bw</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aggregate_topo_bw</span><span class="p">,</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">topo_freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">topo_freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))))</span>

        <span class="k">return</span> <span class="n">spw_topo_freq_param</span><span class="p">,</span> <span class="n">spw_topo_chan_param</span><span class="p">,</span> <span class="n">spw_topo_freq_param_dict</span><span class="p">,</span> <span class="n">spw_topo_chan_param_dict</span><span class="p">,</span> <span class="n">total_topo_bw</span><span class="p">,</span> <span class="n">aggregate_topo_bw</span><span class="p">,</span> <span class="n">aggregate_lsrk_bw</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_channel_flags">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_channel_flags">[docs]</a>
    <span class="k">def</span> <span class="nf">get_channel_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine channel flags for a given field and spw selection in one MS.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># CAS-8997</span>
        <span class="c1">#</span>
        <span class="c1"># ms.selectinit(datadescid=x) is required to avoid the &#39;Data shape</span>
        <span class="c1"># varies...&#39; warning message. There&#39;s no guarantee that a single</span>
        <span class="c1"># spectral window will resolve to a single data description, e.g.</span>
        <span class="c1"># the polarisation setup may change. There&#39;s not enough</span>
        <span class="c1"># information passed into this function to consistently identify the</span>
        <span class="c1"># data description that should be specified so on occasion the</span>
        <span class="c1"># warning message will reoccur.</span>
        <span class="c1">#</span>
        <span class="c1"># TODO refactor method signature to include data description ID</span>
        <span class="c1">#</span>
        <span class="n">msDO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
        <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
        <span class="n">spwDO</span> <span class="o">=</span> <span class="n">msDO</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
        <span class="n">data_description_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">dd</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">msDO</span><span class="o">.</span><span class="n">data_descriptions</span> <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">spw</span> <span class="ow">is</span> <span class="n">spwDO</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_description_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dd_id</span> <span class="o">=</span> <span class="n">data_description_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Could not resolve </span><span class="si">{!s}</span><span class="s1"> spw </span><span class="si">{!s}</span><span class="s1"> to a single data description&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">spwDO</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">dd_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span> <span class="k">as</span> <span class="n">msTool</span><span class="p">:</span>
                <span class="c1"># CAS-8997 selectinit is required to avoid the &#39;Data shape varies...&#39; warning message</span>
                <span class="n">msTool</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="n">dd_id</span><span class="p">)</span>
                <span class="c1"># Antenna selection does not work (CAS-8757)</span>
                <span class="c1"># staql={&#39;field&#39;: field, &#39;spw&#39;: real_spwid, &#39;antenna&#39;: &#39;*&amp;*&#39;}</span>
                <span class="n">staql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)}</span>
                <span class="n">msTool</span><span class="o">.</span><span class="n">msselect</span><span class="p">(</span><span class="n">staql</span><span class="p">)</span>
                <span class="n">msTool</span><span class="o">.</span><span class="n">iterinit</span><span class="p">(</span><span class="n">maxrows</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
                <span class="n">msTool</span><span class="o">.</span><span class="n">iterorigin</span><span class="p">()</span>

                <span class="n">channel_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="n">spwDO</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>

                <span class="n">iterating</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">while</span> <span class="n">iterating</span><span class="p">:</span>
                    <span class="n">flag_ants</span> <span class="o">=</span> <span class="n">msTool</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s1">&#39;flag&#39;</span><span class="p">,</span> <span class="s1">&#39;antenna1&#39;</span><span class="p">,</span> <span class="s1">&#39;antenna2&#39;</span><span class="p">])</span>

                    <span class="c1"># Calculate averaged flagging vector keeping all unflagged</span>
                    <span class="c1"># channels from any baseline.</span>
                    <span class="k">if</span> <span class="n">flag_ants</span> <span class="o">!=</span> <span class="p">{}:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flag_ants</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                            <span class="c1"># Antenna selection does not work (CAS-8757)</span>
                            <span class="k">if</span> <span class="n">flag_ants</span><span class="p">[</span><span class="s1">&#39;antenna1&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">flag_ants</span><span class="p">[</span><span class="s1">&#39;antenna2&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flag_ants</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                    <span class="n">channel_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">channel_flags</span><span class="p">,</span> <span class="n">flag_ants</span><span class="p">[</span><span class="s1">&#39;flag&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>

                    <span class="n">iterating</span> <span class="o">=</span> <span class="n">msTool</span><span class="o">.</span><span class="n">iternext</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Exception while determining flags: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">channel_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">return</span> <span class="n">channel_flags</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_first_unflagged_channel_from_center">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_first_unflagged_channel_from_center">[docs]</a>
    <span class="k">def</span> <span class="nf">get_first_unflagged_channel_from_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel_flags</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find first unflagged channel from center channel.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">i_low</span> <span class="o">=</span> <span class="n">i_high</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">num_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channel_flags</span><span class="p">)</span>
        <span class="n">center_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">center_channel</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">channel_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">i_low</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">center_channel</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">channel_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">i_high</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">i_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i_high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i_high</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">i_high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i_low</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">center_channel</span> <span class="o">-</span> <span class="n">i_low</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">i_high</span> <span class="o">-</span> <span class="n">center_channel</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">i_low</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">i_high</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.freq_intersection">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.freq_intersection">[docs]</a>
    <span class="k">def</span> <span class="nf">freq_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate LSRK frequency intersection of a list of MSs for a</span>
<span class="sd">        given field and spw. Exclude flagged channels.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">csu</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">synthesisutils</span>

        <span class="n">per_eb_flagged_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">per_eb_full_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">channel_widths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="n">vis</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">real_spw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">ms</span><span class="p">))</span>

            <span class="c1"># Loop over mosaic fields and determine the channel flags per field.</span>
            <span class="c1"># Skip channels that have only partial pointing coverage.</span>
            <span class="n">field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="p">[</span><span class="n">msname</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">per_field_flagged_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">per_field_full_freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">:</span>

                <span class="c1"># For multi-tuning EBs, a field may be observed in just a subset of</span>
                <span class="c1"># science spws. Filter out spws not applicable to this field.</span>
                <span class="n">spw_do</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spw</span><span class="p">)</span>
                <span class="n">field_dos</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                <span class="c1"># field(s) not in MS</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_dos</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># spw not observed for the field(s)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_dos</span> <span class="k">if</span> <span class="n">spw_do</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">]:</span>
                    <span class="k">continue</span>

                <span class="c1"># Get the channel flags (uses virtual spw ID !)</span>
                <span class="n">channel_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_flags</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field_id</span><span class="p">,</span> <span class="n">spw</span><span class="p">)</span>

                <span class="c1"># Get indices of unflagged channels</span>
                <span class="n">nfi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channel_flags</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># Use unflagged edge channels to determine LSRK frequency range</span>
                <span class="k">if</span> <span class="n">nfi</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,):</span>
                    <span class="c1"># Use the edges. Another heuristic will skip one extra channel later in the final frequency range.</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;REST&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">field_id</span><span class="p">),</span> <span class="n">spwselection</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spw</span><span class="p">,</span> <span class="n">nfi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nfi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">,</span> <span class="n">ephemtable</span><span class="o">=</span><span class="s1">&#39;TRACKFIELD&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">field_id</span><span class="p">),</span> <span class="n">spwselection</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spw</span><span class="p">,</span> <span class="n">nfi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nfi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">csu</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

                    <span class="n">f0_flagged</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqstart&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)))</span>
                    <span class="n">f1_flagged</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqend&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)))</span>

                    <span class="n">per_field_flagged_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f0_flagged</span><span class="p">,</span> <span class="n">f1_flagged</span><span class="p">))</span>
                    <span class="c1"># The frequency range from advisechansel is from channel edge</span>
                    <span class="c1"># to channel edge. To get the width, one needs to divide by the</span>
                    <span class="c1"># number of channels in the selection.</span>
                    <span class="n">channel_widths</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f1_flagged</span> <span class="o">-</span> <span class="n">f0_flagged</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nfi</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">nfi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

                    <span class="c1"># Also get the full ranges to trim the final LSRK range for</span>
                    <span class="c1"># odd tunings near the LO range edges (PIPE-526).</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;REST&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">):</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">field_id</span><span class="p">),</span> <span class="n">spwselection</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spw</span><span class="p">),</span> <span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">,</span> <span class="n">ephemtable</span><span class="o">=</span><span class="s1">&#39;TRACKFIELD&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">csu</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">field_id</span><span class="p">),</span> <span class="n">spwselection</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spw</span><span class="p">),</span> <span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="n">frame</span><span class="p">)</span>
                    <span class="n">csu</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

                    <span class="n">f0_full</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqstart&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)))</span>
                    <span class="n">f1_full</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqend&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)))</span>

                    <span class="n">per_field_full_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">f0_full</span><span class="p">,</span> <span class="n">f1_full</span><span class="p">))</span>

            <span class="c1"># Calculate weighted intersection with threshold of 1.0 to avoid</span>
            <span class="c1"># edge channels that have drifted too much in LSRK or REST during</span>
            <span class="c1"># the EB.</span>
            <span class="k">if</span> <span class="n">per_field_flagged_freq_ranges</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">per_eb_flagged_intersect_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">intersect_ranges_by_weight</span><span class="p">(</span><span class="n">per_field_flagged_freq_ranges</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="n">per_eb_full_intersect_range</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">intersect_ranges_by_weight</span><span class="p">(</span><span class="n">per_field_full_freq_ranges</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">per_eb_flagged_intersect_range</span> <span class="o">!=</span> <span class="p">()</span> <span class="ow">and</span> <span class="n">per_eb_full_intersect_range</span> <span class="o">!=</span> <span class="p">():</span>
                    <span class="n">per_eb_flagged_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_eb_flagged_intersect_range</span><span class="p">)</span>
                    <span class="n">per_eb_full_freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">per_eb_full_intersect_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">per_eb_flagged_freq_ranges</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>

        <span class="c1"># Calculate weighted intersection with threshold of 0.6 to avoid</span>
        <span class="c1"># partially flagged spws of individual EBs restricting the frequency</span>
        <span class="c1"># axis (PIPE-180).</span>
        <span class="n">intersect_range_flagged</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">intersect_ranges_by_weight</span><span class="p">(</span><span class="n">per_eb_flagged_freq_ranges</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">),</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="c1"># Calculate the weighted intersection of all ranges with threshold</span>
        <span class="c1"># of 1.0 to get the maximum possible range with contributions from</span>
        <span class="c1"># all EBs (PIPE-526).</span>
        <span class="n">intersect_range_full</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">intersect_ranges_by_weight</span><span class="p">(</span><span class="n">per_eb_full_freq_ranges</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intersect_range_flagged</span> <span class="o">!=</span> <span class="p">()</span> <span class="ow">and</span> <span class="n">intersect_range_full</span> <span class="o">!=</span> <span class="p">():</span>
            <span class="n">intersect_range_final</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">intersect_ranges_by_weight</span><span class="p">([</span><span class="n">intersect_range_flagged</span><span class="p">,</span> <span class="n">intersect_range_full</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="n">if0</span><span class="p">,</span> <span class="n">if1</span> <span class="o">=</span> <span class="n">intersect_range_final</span>
            <span class="k">return</span> <span class="n">if0</span><span class="p">,</span> <span class="n">if1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">channel_widths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.warn_missing_cont_ranges">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.warn_missing_cont_ranges">[docs]</a>
    <span class="k">def</span> <span class="nf">warn_missing_cont_ranges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_bw_corr_factor">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_bw_corr_factor">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bw_corr_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_do</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate effective bandwidth correction factor.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">ms_do</span><span class="p">)</span>
        <span class="n">spw_do</span> <span class="o">=</span> <span class="n">ms_do</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>
        <span class="n">spwchan</span> <span class="o">=</span> <span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span>
        <span class="n">physicalBW_of_1chan</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">effectiveBW_of_1chan</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">effective_bw</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="n">BW_ratio</span> <span class="o">=</span> <span class="n">effectiveBW_of_1chan</span> <span class="o">/</span> <span class="n">physicalBW_of_1chan</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">BW_ratio</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">equal_to_n_digits</span><span class="p">(</span><span class="n">BW_ratio</span><span class="p">,</span> <span class="mf">2.667</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">equal_to_n_digits</span><span class="p">(</span><span class="n">BW_ratio</span><span class="p">,</span> <span class="mf">1.600</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">equal_to_n_digits</span><span class="p">(</span><span class="n">BW_ratio</span><span class="p">,</span> <span class="mf">1.231</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">equal_to_n_digits</span><span class="p">(</span><span class="n">BW_ratio</span><span class="p">,</span> <span class="mf">1.104</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">equal_to_n_digits</span><span class="p">(</span><span class="n">BW_ratio</span><span class="p">,</span> <span class="mf">1.049</span><span class="p">,</span> <span class="mi">4</span><span class="p">)):</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not evaluate channel bandwidths ratio. Physical: </span><span class="si">%s</span><span class="s1"> Effective: </span><span class="si">%s</span><span class="s1"> Ratio: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">physicalBW_of_1chan</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">,</span> <span class="n">BW_ratio</span><span class="p">))</span>
            <span class="n">N_smooth</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">N_smooth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">nchan</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">optimisticBW</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">effectiveBW_of_1chan</span><span class="p">)</span>
            <span class="n">approximateEffectiveBW</span> <span class="o">=</span> <span class="p">(</span><span class="n">nchan</span> <span class="o">+</span> <span class="mf">1.12</span> <span class="o">*</span> <span class="p">(</span><span class="n">spwchan</span> <span class="o">-</span> <span class="n">nchan</span><span class="p">)</span> <span class="o">/</span> <span class="n">spwchan</span> <span class="o">/</span> <span class="n">N_smooth</span><span class="p">)</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">physicalBW_of_1chan</span><span class="p">)</span>
            <span class="n">SCF</span> <span class="o">=</span> <span class="p">(</span><span class="n">optimisticBW</span> <span class="o">/</span> <span class="n">approximateEffectiveBW</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">approximateEffectiveBW</span> <span class="o">=</span> <span class="n">nchan</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">physicalBW_of_1chan</span><span class="p">)</span>
            <span class="n">SCF</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">return</span> <span class="n">SCF</span><span class="p">,</span> <span class="n">physicalBW_of_1chan</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">,</span> <span class="n">approximateEffectiveBW</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.calc_sensitivities">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.calc_sensitivities">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_sensitivities</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">nbin</span><span class="p">,</span> <span class="n">spw_topo_chan_param_dict</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">gridder</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">,</span>
            <span class="n">center_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">known_sensitivities</span><span class="o">=</span><span class="p">{},</span>
            <span class="n">force_calc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">calc_reffreq</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute sensitivity estimate using CASA.</span>
<span class="sd">        </span>
<span class="sd">        Note: calc_reffreq is defaulted to False for backwards compatibility uses in imageprecheck.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># Need to work on a local copy of known_sensitivities to avoid setting the</span>
        <span class="c1"># method default value inadvertently</span>
        <span class="n">local_known_sensitivities</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">known_sensitivities</span><span class="p">)</span>

        <span class="c1"># The imTool knows only &#39;briggs&#39; weighting</span>
        <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;briggsbwtaper&#39;</span><span class="p">:</span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="s1">&#39;briggs&#39;</span>

        <span class="n">sensitivities</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># a list of sensitivity per spw / per EB</span>
        <span class="n">sens_freqs</span> <span class="o">=</span> <span class="p">[]</span>     <span class="c1"># a list of effective freq per spw / per EB</span>
        <span class="n">eff_ch_bw</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">sens_bws</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>  <span class="c1"># list of strings with comma separated IDs per MS</span>
        <span class="n">phasecenter</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vis</span><span class="p">)</span>  <span class="c1"># string</span>
        <span class="n">center_field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_field_ids</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">phasecenter</span><span class="p">)</span>  <span class="c1"># list of integer IDs per MS</span>

        <span class="k">for</span> <span class="n">ms_index</span><span class="p">,</span> <span class="n">msname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">msname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">intSpw</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">intSpw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
                    <span class="n">spw_do</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span>

                    <span class="c1"># For multi-tuning EBs, a field may be observed in just a subset of</span>
                    <span class="c1"># science spws. Filter out spws not applicable to this field.</span>
                    <span class="n">field_dos</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                    <span class="c1"># field(s) not in MS</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">field_dos</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># spw not observed for the field(s)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field_dos</span> <span class="k">if</span> <span class="n">spw_do</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cube&#39;</span><span class="p">):</span>
                        <span class="c1"># Use the center channel selection</span>
                        <span class="k">if</span> <span class="n">nbin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">chansel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="n">nbin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span> <span class="nb">int</span><span class="p">((</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">+</span> <span class="n">nbin</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">nchan_sel</span> <span class="o">=</span> <span class="n">nbin</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">chansel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                            <span class="n">nchan_sel</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">spw_topo_chan_param_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span> <span class="kc">False</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="c1"># Use continuum frequency selection</span>
                                <span class="n">chansel</span> <span class="o">=</span> <span class="n">spw_topo_chan_param_dict</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">)]</span>
                                <span class="n">nchan_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)))</span>
                                                                          <span class="k">for</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">chansel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)]])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Use full spw (unflagged channels)</span>
                                <span class="n">channel_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_flags</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">)</span>
                                <span class="n">nchan_unflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channel_flags</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="c1"># Dummy selection</span>
                                <span class="n">chansel</span> <span class="o">=</span> <span class="s1">&#39;0~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan_unflagged</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="n">nchan_sel</span> <span class="o">=</span> <span class="n">nchan_unflagged</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Use full spw (unflagged channels)</span>
                            <span class="n">channel_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_flags</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">)</span>
                            <span class="n">nchan_unflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channel_flags</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="c1"># Dummy selection</span>
                            <span class="n">chansel</span> <span class="o">=</span> <span class="s1">&#39;0~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">nchan_unflagged</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="n">nchan_sel</span> <span class="o">=</span> <span class="n">nchan_unflagged</span>

                    <span class="n">chansel_full</span> <span class="o">=</span> <span class="s1">&#39;0~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c1"># If necessary, calculate center field full spw sensitivity</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">calc_sens</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">force_calc</span><span class="p">:</span>
                            <span class="c1"># Reset flag to avoid clearing the dictionary several times</span>
                            <span class="n">force_calc</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">local_known_sensitivities</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Got manual request to recalculate sensitivities.&#39;</span><span class="p">)</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Got manual request to recalculate sensitivities.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">robust</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;robust value changed (old: </span><span class="si">%.1f</span><span class="s1">, new: </span><span class="si">%.1f</span><span class="s1">). Re-calculating sensitivities.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">],</span> <span class="n">robust</span><span class="p">))</span>
                            <span class="n">local_known_sensitivities</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;robust value changed (old: </span><span class="si">%.1f</span><span class="s1">, new: </span><span class="si">%.1f</span><span class="s1">). Re-calculating sensitivities.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">],</span> <span class="n">robust</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">uvtaper</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;uvtaper value changed (old: </span><span class="si">%s</span><span class="s1">, new: </span><span class="si">%s</span><span class="s1">). Re-calculating sensitivities.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)))</span>
                            <span class="n">local_known_sensitivities</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;uvtaper value changed (old: </span><span class="si">%s</span><span class="s1">, new: </span><span class="si">%s</span><span class="s1">). Re-calculating sensitivities.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)))</span>
                        <span class="n">center_field_full_spw_sensitivity</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="n">intSpw</span><span class="p">][</span><span class="s1">&#39;sensitivityAllChans&#39;</span><span class="p">],</span> <span class="s1">&#39;Jy/beam&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">nchan_unflagged</span> <span class="o">=</span> <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="n">intSpw</span><span class="p">][</span><span class="s1">&#39;nchanUnflagged&#39;</span><span class="p">]</span>
                        <span class="n">eff_ch_bw</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="n">intSpw</span><span class="p">][</span><span class="s1">&#39;effChanBW&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">]</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="n">intSpw</span><span class="p">][</span><span class="s1">&#39;sensBW&#39;</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">sens_freq</span> <span class="o">=</span> <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)][</span><span class="n">field</span><span class="p">][</span><span class="n">intent</span><span class="p">][</span><span class="n">intSpw</span><span class="p">][</span><span class="s1">&#39;sensfreq&#39;</span><span class="p">]</span>  <span class="c1"># float, in Hz</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Using previously calculated full SPW apparentsens value of </span><span class="si">%.3g</span><span class="s1"> Jy/beam&#39;</span>
                                 <span class="s1">&#39; for EB </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> Intent </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">center_field_full_spw_sensitivity</span><span class="p">,</span>
                                                                           <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                                           <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">)))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">calc_sens</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">center_field_full_spw_sensitivity</span><span class="p">,</span> <span class="n">eff_ch_bw</span><span class="p">,</span> <span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">],</span> <span class="n">sens_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">(</span>
                            <span class="n">ms</span><span class="p">,</span> <span class="n">center_field_ids</span><span class="p">[</span><span class="n">ms_index</span><span class="p">],</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="n">chansel_full</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">)</span>
                        <span class="n">channel_flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_channel_flags</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">)</span>
                        <span class="n">nchan_unflagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">channel_flags</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;recalc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">robust</span>
                        <span class="n">local_known_sensitivities</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uvtaper</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span>
                                              <span class="n">intSpw</span><span class="p">,</span> <span class="s1">&#39;sensitivityAllChans&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%.3g</span><span class="s1"> Jy/beam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">center_field_full_spw_sensitivity</span><span class="p">))</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                            <span class="n">msname</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="s1">&#39;nchanUnflagged&#39;</span><span class="p">),</span> <span class="n">nchan_unflagged</span><span class="p">)</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                            <span class="n">msname</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="s1">&#39;effChanBW&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Hz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">eff_ch_bw</span><span class="p">))</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span>
                                              <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="s1">&#39;sensBW&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> Hz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">]))</span>
                        <span class="n">utils</span><span class="o">.</span><span class="n">set_nested_dict</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">,</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">),</span>
                                              <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="s1">&#39;sensfreq&#39;</span><span class="p">),</span> <span class="n">sens_freq</span><span class="p">)</span>

                    <span class="c1"># Correct from full spw to channel selection</span>
                    <span class="k">if</span> <span class="n">nchan_sel</span> <span class="o">!=</span> <span class="n">nchan_unflagged</span><span class="p">:</span>
                        <span class="n">chansel_corrected_center_field_sensitivity</span> <span class="o">=</span> <span class="n">center_field_full_spw_sensitivity</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nchan_unflagged</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan_sel</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
                        <span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">]</span> <span class="o">=</span> <span class="n">sens_bws</span><span class="p">[</span><span class="n">intSpw</span><span class="p">]</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan_sel</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_do</span><span class="o">.</span><span class="n">num_channels</span><span class="p">)</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Channel selection bandwidth heuristic (nbin or findcont; (spw BW / nchan_sel BW) ** 0.5):&#39;</span>
                                 <span class="s1">&#39; Correcting sensitivity for EB </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%.3g</span><span class="s1"> from </span><span class="si">%.3g</span><span class="s1"> Jy/beam to&#39;</span>
                                 <span class="s1">&#39; </span><span class="si">%.3g</span><span class="s1"> Jy/beam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">),</span>
                                                    <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">nchan_unflagged</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan_sel</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">,</span>
                                                    <span class="n">center_field_full_spw_sensitivity</span><span class="p">,</span>
                                                    <span class="n">chansel_corrected_center_field_sensitivity</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">chansel_corrected_center_field_sensitivity</span> <span class="o">=</span> <span class="n">center_field_full_spw_sensitivity</span>

                    <span class="c1"># Correct for effective bandwidth effects</span>
                    <span class="n">bw_corr_factor</span><span class="p">,</span> <span class="n">physicalBW_of_1chan</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bw_corr_factor</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="n">nchan_sel</span><span class="p">)</span>
                    <span class="n">center_field_sensitivity</span> <span class="o">=</span> <span class="n">chansel_corrected_center_field_sensitivity</span> <span class="o">*</span> <span class="n">bw_corr_factor</span>
                    <span class="k">if</span> <span class="n">bw_corr_factor</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Effective BW heuristic: Correcting sensitivity for EB </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> by </span><span class="si">%.3g</span><span class="s1"> from </span><span class="si">%.3g</span><span class="s1"> Jy/beam to </span><span class="si">%.3g</span><span class="s1"> Jy/beam&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">),</span> <span class="n">bw_corr_factor</span><span class="p">,</span> <span class="n">chansel_corrected_center_field_sensitivity</span><span class="p">,</span> <span class="n">center_field_sensitivity</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">gridder</span> <span class="o">==</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">:</span>
                        <span class="c1"># Correct for mosaic overlap factor</span>
                        <span class="n">source_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">and</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">intents</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># PIPE-1708: &quot;Integer&quot; source names consisting of just</span>
                        <span class="c1"># digits cause confusion in the mosaic overlap factor</span>
                        <span class="c1"># calculation. Adopting the &quot;solution&quot; of enquoting</span>
                        <span class="c1"># such names.</span>
                        <span class="k">if</span> <span class="n">source_name</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                            <span class="n">source_name</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span>
                        <span class="n">diameter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">diameter</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">])</span>
                        <span class="n">overlap_factor</span> <span class="o">=</span> <span class="n">mosaicoverlap</span><span class="o">.</span><span class="n">mosaicOverlapFactorMS</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">source_name</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Dividing by mosaic overlap improvement factor of </span><span class="si">%s</span><span class="s1"> corrects sensitivity for EB </span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="s1">&#39; Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%.3g</span><span class="s1"> Jy/beam to </span><span class="si">%.3g</span><span class="s1"> Jy/beam.&#39;</span>
                                 <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">overlap_factor</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">intSpw</span><span class="p">),</span>
                                       <span class="n">center_field_sensitivity</span><span class="p">,</span> <span class="n">center_field_sensitivity</span> <span class="o">/</span> <span class="n">overlap_factor</span><span class="p">))</span>
                        <span class="n">center_field_sensitivity</span> <span class="o">=</span> <span class="n">center_field_sensitivity</span> <span class="o">/</span> <span class="n">overlap_factor</span>

                        <span class="k">if</span> <span class="n">calc_sens</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">center_only</span><span class="p">:</span>
                            <span class="c1"># Calculate diagnostic sensitivities for first and last field</span>
                            <span class="n">first_field_id</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">[</span><span class="n">ms_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                            <span class="n">first_field_full_spw_sensitivity</span><span class="p">,</span> <span class="n">first_field_eff_ch_bw</span><span class="p">,</span> <span class="n">first_field_sens_bw</span><span class="p">,</span> <span class="n">first_field_sens_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">(</span>
                                <span class="n">ms</span><span class="p">,</span> <span class="n">first_field_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="n">chansel_full</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">)</span>
                            <span class="n">first_field_sensitivity</span> <span class="o">=</span> <span class="n">first_field_full_spw_sensitivity</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">nchan_unflagged</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan_sel</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bw_corr_factor</span> <span class="o">/</span> <span class="n">overlap_factor</span>
                            <span class="n">last_field_id</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">[</span><span class="n">ms_index</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                            <span class="n">last_field_full_spw_sensitivity</span><span class="p">,</span> <span class="n">last_field_eff_ch_bw</span><span class="p">,</span> <span class="n">last_field_sens_bw</span><span class="p">,</span> <span class="n">last_field_sens_freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">(</span>
                                <span class="n">ms</span><span class="p">,</span> <span class="n">last_field_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">intSpw</span><span class="p">,</span> <span class="n">chansel_full</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">)</span>
                            <span class="n">last_field_sensitivity</span> <span class="o">=</span> <span class="n">last_field_full_spw_sensitivity</span> <span class="o">*</span> <span class="p">(</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">nchan_unflagged</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nchan_sel</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bw_corr_factor</span> <span class="o">/</span> <span class="n">overlap_factor</span>

                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Corrected sensitivities for EB </span><span class="si">%s</span><span class="s1">, Field </span><span class="si">%s</span><span class="s1">, SPW </span><span class="si">%s</span><span class="s1"> for the first, central, and&#39;</span>
                                     <span class="s1">&#39; last pointings are: </span><span class="si">%.3g</span><span class="s1"> / </span><span class="si">%.3g</span><span class="s1"> / </span><span class="si">%.3g</span><span class="s1"> Jy/beam&#39;</span>
                                     <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">),</span>
                                           <span class="n">first_field_sensitivity</span><span class="p">,</span> <span class="n">center_field_sensitivity</span><span class="p">,</span> <span class="n">last_field_sensitivity</span><span class="p">))</span>

                    <span class="n">sensitivities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">center_field_sensitivity</span><span class="p">)</span>
                    <span class="n">sens_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sens_freq</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Simply pass as this could be a case of a source not</span>
                    <span class="c1"># being present in the MS.</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sensitivities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>

            <span class="n">sensitivity</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sensitivities</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

            <span class="c1"># Calculate total bandwidth for this selection</span>
            <span class="n">sens_bw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sens_bws</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

            <span class="c1"># Calculate the &quot;effective/weighted&quot; frequency for this selection</span>
            <span class="n">eb_spw_weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sensitivities</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">sens_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sens_freqs</span><span class="p">)</span><span class="o">*</span><span class="n">eb_spw_weights</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eb_spw_weights</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">and</span> <span class="n">spw_topo_chan_param_dict</span> <span class="o">==</span> <span class="p">{}:</span>
                <span class="c1"># Correct for spw frequency overlaps</span>
                <span class="n">agg_bw</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aggregate_bandwidth</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">))</span>
                <span class="c1"># because agg_bw is a one-element Numpy array from the output of quanta tools calls, both</span>
                <span class="c1"># sensitivity and sens_bw here get converted to one element Numpy array here.</span>
                <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span> <span class="o">*</span> <span class="p">(</span><span class="n">sens_bw</span> <span class="o">/</span> <span class="n">agg_bw</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
                <span class="n">sens_bw</span> <span class="o">=</span> <span class="n">agg_bw</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final sensitivity estimate for Field </span><span class="si">%s</span><span class="s1">, SPW </span><span class="si">%s</span><span class="s1"> specmode </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> mJy/beam&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final effective channel bandwidth for Field </span><span class="si">%s</span><span class="s1">, SPW </span><span class="si">%s</span><span class="s1"> specmode </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> Hz&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Final effective frequency for Field </span><span class="si">%s</span><span class="s1">, SPW </span><span class="si">%s</span><span class="s1"> specmode </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> GHz&#39;</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">sens_freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defaultSensitivity</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Exception in calculating sensitivity.&#39;</span><span class="p">)</span>
            <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">defaultSensitivity</span>
            <span class="n">sens_bw</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sens_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">calc_reffreq</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">eff_ch_bw</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">sens_freq</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">eff_ch_bw</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">local_known_sensitivities</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_sensitivity">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_sensitivity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ms_do</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chansel</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get sensitivity for a field / spw / chansel combination from CASA&#39;s</span>
<span class="sd">        apparentsens method and a correction for effective channel widths</span>
<span class="sd">        in case of online smoothing.</span>

<span class="sd">        This heuristic is currently optimized for ALMA data only.</span>

<span class="sd">        Note: the input &#39;field&#39; is a field id as an integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">real_spwid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">ms_do</span><span class="p">)</span>
        <span class="n">chansel_sensitivities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">chansel_centerfreqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sens_bw</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">effectiveBW_of_1chan</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">sens_freq</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">chanrange</span> <span class="ow">in</span> <span class="n">chansel</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">):</span>

            <span class="n">scanids</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms_do</span><span class="o">.</span><span class="n">scans</span>
                       <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span>
                       <span class="ow">and</span> <span class="n">field</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fld</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]]</span>
            <span class="n">scanids</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scanids</span><span class="p">)</span>
            <span class="n">antenna_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_ids</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">)])</span>
            <span class="n">taql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA1==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&amp;&amp;&quot;</span> \
                   <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;||&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;ANTENNA2==</span><span class="si">%d</span><span class="s1">&#39;</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">)]])</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">SelectvisReader</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spwid</span><span class="p">,</span> <span class="n">chanrange</span><span class="p">),</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                                                <span class="n">scan</span><span class="o">=</span><span class="n">scanids</span><span class="p">,</span> <span class="n">taql</span><span class="o">=</span><span class="n">taql</span><span class="p">)</span> <span class="k">as</span> <span class="n">imTool</span><span class="p">:</span>
                    <span class="n">imTool</span><span class="o">.</span><span class="n">defineimage</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">specmode</span> <span class="k">if</span> <span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cube&#39;</span> <span class="k">else</span> <span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">real_spwid</span><span class="p">,</span> <span class="n">cellx</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">celly</span><span class="o">=</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nx</span><span class="o">=</span><span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny</span><span class="o">=</span><span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">imTool</span><span class="o">.</span><span class="n">weight</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">weighting</span><span class="p">,</span> <span class="n">rmode</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">uvtaper</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">bmaj</span> <span class="o">=</span> <span class="n">bmin</span> <span class="o">=</span> <span class="n">uvtaper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">bpa</span> <span class="o">=</span> <span class="s1">&#39;0.0deg&#39;</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span> <span class="o">=</span> <span class="n">uvtaper</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown uvtaper format: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uvtaper</span><span class="p">)))</span>
                        <span class="n">imTool</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">bmaj</span><span class="o">=</span><span class="n">bmaj</span><span class="p">,</span> <span class="n">bmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">bpa</span><span class="o">=</span><span class="n">bpa</span><span class="p">)</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">imTool</span><span class="o">.</span><span class="n">apparentsens</span><span class="p">()</span>
                    <span class="n">freq_range</span> <span class="o">=</span> <span class="n">imTool</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
                    <span class="n">freq_center</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;freqstart&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;freqend&#39;</span><span class="p">])</span><span class="o">/</span><span class="mf">2.0</span>  <span class="c1"># in Hz</span>

                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Empty selection&#39;</span><span class="p">)</span>

                <span class="n">apparentsens_value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;apparentsens result for EB </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> ChanRange </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1"> Jy/beam&#39;</span>
                         <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">real_spwid</span><span class="p">,</span> <span class="n">chanrange</span><span class="p">,</span>
                               <span class="n">apparentsens_value</span><span class="p">))</span>

                <span class="n">cstart</span><span class="p">,</span> <span class="n">cstop</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">chanrange</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)))</span>
                <span class="n">nchan</span> <span class="o">=</span> <span class="n">cstop</span> <span class="o">-</span> <span class="n">cstart</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">SCF</span><span class="p">,</span> <span class="n">physicalBW_of_1chan</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bw_corr_factor</span><span class="p">(</span><span class="n">ms_do</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">nchan</span><span class="p">)</span>
                <span class="n">sens_bw</span> <span class="o">+=</span> <span class="n">nchan</span> <span class="o">*</span> <span class="n">physicalBW_of_1chan</span>

                <span class="n">chansel_sensitivities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">apparentsens_value</span><span class="p">)</span>
                <span class="n">chansel_centerfreqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq_center</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;Empty selection&#39;</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not calculate sensitivity for EB </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> ChanRange </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.ms&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span> <span class="n">field</span><span class="p">,</span> <span class="n">real_spwid</span><span class="p">,</span> <span class="n">chanrange</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chansel_sensitivities</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">chansel_weights</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chansel_sensitivities</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">sens_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chansel_centerfreqs</span><span class="p">)</span><span class="o">*</span><span class="n">chansel_weights</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">chansel_weights</span><span class="p">)</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chansel_sensitivities</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sens</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Calculated the theoretical sensitivty for &#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">11</span><span class="p">),</span>
            <span class="n">ms_do</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">chansel</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">weighting</span><span class="p">,</span> <span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  theoretical sensitivity: </span><span class="si">%s</span><span class="s1"> mJy/beam&#39;</span><span class="p">,</span> <span class="n">sens</span><span class="o">*</span><span class="mf">1e3</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  effective channel bandwidth: </span><span class="si">%s</span><span class="s1"> Hz&#39;</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  sensitivity bandwidth: </span><span class="si">%s</span><span class="s1"> Hz&#39;</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  sensitivity frequency: </span><span class="si">%s</span><span class="s1"> GHz&#39;</span><span class="p">,</span> <span class="n">sens_freq</span><span class="o">/</span><span class="mf">1e9</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sens</span><span class="p">,</span> <span class="n">effectiveBW_of_1chan</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">sens_freq</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.dr_correction">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.dr_correction">[docs]</a>
    <span class="k">def</span> <span class="nf">dr_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">dirty_dynamic_range</span><span class="p">,</span> <span class="n">residual_max</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">tlimit</span><span class="p">,</span> <span class="n">drcorrect</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjustment of cleaning threshold due to dynamic range limitations.&quot;&quot;&quot;</span>

        <span class="n">DR_correction_factor</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">maxEDR_used</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">DR_correction_factor</span><span class="p">,</span> <span class="n">maxEDR_used</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.niter_correction">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.niter_correction">[docs]</a>
    <span class="k">def</span> <span class="nf">niter_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">imsize</span><span class="p">,</span> <span class="n">residual_max</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">residual_robust_rms</span><span class="p">,</span> <span class="n">mask_frac_rad</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adjustment of number of cleaning iterations due to mask size.</span>

<span class="sd">        Circular mask is assumed with a radius equal to mask_frac_rad times the longest image dimension</span>
<span class="sd">        in arcsec. If mask_frac_rad=0.0, then no new cleaning iteration step number is estimate and the</span>
<span class="sd">        input niter value is returned.</span>

<span class="sd">        Note that the method assumes synthesized_beam = 5 * cell. This might lead to underestimated new</span>
<span class="sd">        niter value if the beam is sampled by less than 5 pixels (e.g. when hif_checkproductsize() task</span>
<span class="sd">        was called earlier.</span>

<span class="sd">        :param niter: User or heuristics set number of cleaning iterations</span>
<span class="sd">        :param cell: Image cell size in arcsec</span>
<span class="sd">        :param imsize: Two element list or array of image pixel count along x and y axis</span>
<span class="sd">        :param residual_max: Dirty image residual maximum [Jy].</span>
<span class="sd">        :param threshold: Cleaning threshold value [Jy].</span>
<span class="sd">        :param residual_robust_rms: Residual scaled MAD [Jy] (not used in base method).</span>
<span class="sd">        :param mask_frac_rad: Mask radius is given by mask_frac_rad * max(imsize) * cell [arcsec]</span>
<span class="sd">        :return: Modified niter value based on mask and beam size heuristic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default case: do not estimate new niter</span>
        <span class="k">if</span> <span class="n">mask_frac_rad</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">niter</span>

        <span class="c1"># Estimate new niter based on circular mask</span>
        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">threshold_value</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="s1">&#39;Jy&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># Compute automatic niter estimate</span>
        <span class="n">old_niter</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">loop_gain</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="c1"># TODO: Replace with actual pixel counting rather than assumption about geometry</span>
        <span class="n">r_mask</span> <span class="o">=</span> <span class="n">mask_frac_rad</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">imsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

        <span class="c1"># Assume that the beam is 5 pixels wide, this might be incorrect in some cases (see docstring).</span>
        <span class="c1"># TODO: Pass synthesized beam size explicitly rather than assuming a</span>
        <span class="c1">#       certain ratio of beam to cell size (which can be different</span>
        <span class="c1">#       if the product size is being mitigated or if a different</span>
        <span class="c1">#       imaging_mode uses different heuristics).</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">5.0</span>

        <span class="n">new_niter_f</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kappa</span> <span class="o">/</span> <span class="n">loop_gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_mask</span> <span class="o">/</span> <span class="n">beam</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">residual_max</span> <span class="o">/</span> <span class="n">threshold_value</span><span class="p">)</span>
        <span class="n">new_niter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">round_half_up</span><span class="p">(</span><span class="n">new_niter_f</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">new_niter_f</span><span class="p">))))</span>
        <span class="c1"># Prevent int overflow in tclean CASA task (see CAS-11847)</span>
        <span class="n">new_niter</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">new_niter</span><span class="p">,</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">31</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">new_niter</span> <span class="o">!=</span> <span class="n">old_niter</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;niter heuristic: Modified niter from </span><span class="si">%d</span><span class="s1"> to </span><span class="si">%d</span><span class="s1"> based on mask vs. beam size heuristic&#39;</span>
                     <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">old_niter</span><span class="p">,</span> <span class="n">new_niter</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">new_niter</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.calc_percentile_baseline_length">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.calc_percentile_baseline_length">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_percentile_baseline_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percentile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate percentile baseline length for the vis list used in this heuristics instance.&quot;&quot;&quot;</span>

        <span class="n">min_diameter</span> <span class="o">=</span> <span class="mf">1.e9</span>
        <span class="n">percentileBaselineLengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">msname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">:</span>
            <span class="n">ms_do</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">)</span>
            <span class="n">min_diameter</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">min_diameter</span><span class="p">,</span> <span class="nb">min</span><span class="p">([</span><span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span> <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="n">ms_do</span><span class="o">.</span><span class="n">antennas</span><span class="p">]))</span>
            <span class="n">percentileBaselineLengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ms_do</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baselines_m</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">percentileBaselineLengths</span><span class="p">),</span> <span class="n">min_diameter</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.niter_by_iteration">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.niter_by_iteration">[docs]</a>
    <span class="k">def</span> <span class="nf">niter_by_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">hm_masking</span><span class="p">,</span> <span class="n">niter</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean niter heuristic at each iteration.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">niter</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.niter">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.niter">[docs]</a>
    <span class="k">def</span> <span class="nf">niter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_autobox_params">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_autobox_params">[docs]</a>
    <span class="k">def</span> <span class="nf">get_autobox_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">robust</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Default auto-boxing parameters.&quot;&quot;&quot;</span>

        <span class="n">sidelobethreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">noisethreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">lownoisethreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">negativethreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">minbeamfrac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">growiterations</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dogrowprune</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">minpercentchange</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fastnoise</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">sidelobethreshold</span><span class="p">,</span> <span class="n">noisethreshold</span><span class="p">,</span> <span class="n">lownoisethreshold</span><span class="p">,</span> <span class="n">negativethreshold</span><span class="p">,</span> <span class="n">minbeamfrac</span><span class="p">,</span> <span class="n">growiterations</span><span class="p">,</span>
                <span class="n">dogrowprune</span><span class="p">,</span> <span class="n">minpercentchange</span><span class="p">,</span> <span class="n">fastnoise</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.nterms">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.nterms">[docs]</a>
    <span class="k">def</span> <span class="nf">nterms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwspec</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.tlimit">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.tlimit">[docs]</a>
    <span class="k">def</span> <span class="nf">tlimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iter0_dirty_dynamic_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">2.0</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.cyclefactor">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.cyclefactor">[docs]</a>
    <span class="k">def</span> <span class="nf">cyclefactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iter0_dirty_dynamic_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.cycleniter">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.cycleniter">[docs]</a>
    <span class="k">def</span> <span class="nf">cycleniter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.nmajor">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.nmajor">[docs]</a>
    <span class="k">def</span> <span class="nf">nmajor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.scales">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.scales">[docs]</a>
    <span class="k">def</span> <span class="nf">scales</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.uvtaper">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.uvtaper">[docs]</a>
    <span class="k">def</span> <span class="nf">uvtaper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beam_natural</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">protect_long</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beam_user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tapering_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repr_freq</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.uvrange">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.uvrange">[docs]</a>
    <span class="k">def</span> <span class="nf">uvrange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.reffreq">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.reffreq">[docs]</a>
    <span class="k">def</span> <span class="nf">reffreq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deconvolver</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spwsel</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.restfreq">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.restfreq">[docs]</a>
    <span class="k">def</span> <span class="nf">restfreq</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">specmode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nchan</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">width</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.conjbeams">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.conjbeams">[docs]</a>
    <span class="k">def</span> <span class="nf">conjbeams</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.pb_correction">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.pb_correction">[docs]</a>
    <span class="k">def</span> <span class="nf">pb_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.antenna_diameters">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.antenna_diameters">[docs]</a>
    <span class="k">def</span> <span class="nf">antenna_diameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Count the antennas of given diameters per MS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="n">vislist</span>

        <span class="n">antenna_diameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">local_vislist</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">antennas</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">antenna_diameters</span><span class="p">:</span>
                    <span class="n">antenna_diameters</span><span class="p">[</span><span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">antenna_diameters</span><span class="p">[</span><span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">antenna_diameters</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.majority_antenna_ids">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.majority_antenna_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">majority_antenna_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the IDs of the majority (by diameter) antennas per MS.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="n">vislist</span>

        <span class="c1"># Determine majority diameter</span>
        <span class="n">antenna_diameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_diameters</span><span class="p">(</span><span class="n">local_vislist</span><span class="p">)</span>
        <span class="n">majority_diameter</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">antenna_diameters</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">majority_antenna_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">local_vislist</span><span class="p">:</span>
            <span class="n">majority_antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">antenna</span><span class="o">.</span><span class="n">id</span>
                                                           <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">antennas</span>
                                                           <span class="k">if</span> <span class="n">antenna</span><span class="o">.</span><span class="n">diameter</span> <span class="o">==</span> <span class="n">majority_diameter</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">majority_antenna_ids</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.arrays">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.arrays">[docs]</a>
    <span class="k">def</span> <span class="nf">arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vislist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the array descriptions.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.antenna_ids">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.antenna_ids">[docs]</a>
    <span class="k">def</span> <span class="nf">antenna_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the antenna IDs to be used for imaging.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vislist</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">local_vislist</span> <span class="o">=</span> <span class="n">vislist</span>

        <span class="k">if</span> <span class="n">intent</span> <span class="o">!=</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">:</span>
            <span class="c1"># For calibrators use all antennas</span>
            <span class="n">antenna_ids</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">local_vislist</span><span class="p">:</span>
                <span class="n">antenna_ids</span><span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">antenna</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">antennas</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">antenna_ids</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For science targets use majority antennas only</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">majority_antenna_ids</span><span class="p">(</span><span class="n">local_vislist</span><span class="p">)</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.check_psf">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.check_psf">[docs]</a>
    <span class="k">def</span> <span class="nf">check_psf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for bad psf fits.&quot;&quot;&quot;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">bad_psf_fit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">psf_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">beams</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()[</span><span class="s1">&#39;beams&#39;</span><span class="p">]</span>
                <span class="n">bmaj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cqa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;*0&#39;</span><span class="p">][</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beams</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

                <span class="c1"># Filter empty psf planes</span>
                <span class="n">bmaj</span> <span class="o">=</span> <span class="n">bmaj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bmaj</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">)]</span>

                <span class="n">bmaj_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bmaj</span><span class="p">)</span>
                <span class="n">cond1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">bmaj</span><span class="p">,</span> <span class="n">bmaj</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">bmaj_median</span><span class="p">)</span>
                <span class="n">cond2</span> <span class="o">=</span> <span class="n">bmaj</span> <span class="o">&gt;</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">bmaj_median</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">cond1</span><span class="p">,</span> <span class="n">cond2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">bad_psf_fit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The PSF fit for one or more channels for field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1"> failed, please check the&#39;</span>
                                <span class="s1">&#39; results for this cube carefully, there are likely data issues.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">bad_psf_fit</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.usepointing">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.usepointing">[docs]</a>
    <span class="k">def</span> <span class="nf">usepointing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;tclean flag to use pointing table.&quot;&quot;&quot;</span>

        <span class="c1"># Currently ALMA and VLA do not want to use the table (CAS-11840).</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.mosweight">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.mosweight">[docs]</a>
    <span class="k">def</span> <span class="nf">mosweight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;tclean flag to use mosaic weighting.&quot;&quot;&quot;</span>

        <span class="c1"># Currently only ALMA has decided to use this flag (CAS-11840). So</span>
        <span class="c1"># the default is set to False here.</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.tclean_stopcode_ignore">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.tclean_stopcode_ignore">[docs]</a>
    <span class="k">def</span> <span class="nf">tclean_stopcode_ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteraton</span><span class="p">,</span> <span class="n">hm_masking</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;tclean stop code(s) to be ignored for warning messages.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.keep_iterating">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.keep_iterating">[docs]</a>
    <span class="k">def</span> <span class="nf">keep_iterating</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">hm_masking</span><span class="p">,</span> <span class="n">tclean_stopcode</span><span class="p">,</span> <span class="n">dirty_dynamic_range</span><span class="p">,</span> <span class="n">residual_max</span><span class="p">,</span> <span class="n">residual_robust_rms</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">specmode</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if another tclean iteration is necessary.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">hm_masking</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">hm_masking</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.threshold">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.threshold">[docs]</a>
    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">threshold</span><span class="p">,</span> <span class="n">hm_masking</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;0.0mJy&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">threshold</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.nsigma">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.nsigma">[docs]</a>
    <span class="k">def</span> <span class="nf">nsigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">hm_nsigma</span><span class="p">,</span> <span class="n">hm_masking</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean nsigma parameter heuristics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">hm_nsigma</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.savemodel">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.savemodel">[docs]</a>
    <span class="k">def</span> <span class="nf">savemodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.stokes">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.stokes">[docs]</a>
    <span class="k">def</span> <span class="nf">stokes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">joint_intents</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;I&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.mask">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.mask">[docs]</a>
    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hm_masking</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rootname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">results_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clean_no_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.specmode">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.specmode">[docs]</a>
    <span class="k">def</span> <span class="nf">specmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;mfs&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.intent">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.intent">[docs]</a>
    <span class="k">def</span> <span class="nf">intent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;TARGET&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.datacolumn">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.datacolumn">[docs]</a>
    <span class="k">def</span> <span class="nf">datacolumn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.wprojplanes">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.wprojplanes">[docs]</a>
    <span class="k">def</span> <span class="nf">wprojplanes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gridder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.rotatepastep">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.rotatepastep">[docs]</a>
    <span class="k">def</span> <span class="nf">rotatepastep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.find_good_commonbeam">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.find_good_commonbeam">[docs]</a>
    <span class="k">def</span> <span class="nf">find_good_commonbeam</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_filename</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find and replace outlier beams to calculate a good common beam.</span>
<span class="sd">        Method from Urvashi Rao.</span>

<span class="sd">        Returns new common beam and array of channel numbers with invalid beams.</span>
<span class="sd">        Leaves old beams in the PSF as is.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cqa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">psf_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="n">allbeams</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">()</span>
            <span class="n">commonbeam</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">commonbeam</span><span class="p">()</span>
            <span class="n">nchan</span> <span class="o">=</span> <span class="n">allbeams</span><span class="p">[</span><span class="s1">&#39;nChannels&#39;</span><span class="p">]</span>
            <span class="n">areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
            <span class="n">axratio</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">)</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nchan</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
                <span class="n">axmajor</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">allbeams</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)][</span><span class="s1">&#39;*0&#39;</span><span class="p">][</span><span class="s1">&#39;major&#39;</span><span class="p">]),</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">axminor</span> <span class="o">=</span> <span class="n">cqa</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cqa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">allbeams</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)][</span><span class="s1">&#39;*0&#39;</span><span class="p">][</span><span class="s1">&#39;minor&#39;</span><span class="p">]),</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">areas</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">axmajor</span> <span class="o">*</span> <span class="n">axminor</span>
                <span class="n">axratio</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">axmajor</span><span class="o">/</span><span class="n">axminor</span>
                <span class="n">weight</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">axratio</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="p">)</span>

            <span class="c1">## Detect outliers based on axis ratio</span>
            <span class="c1">## The iterative loop is to get robust autoflagging</span>
            <span class="c1">## Add a linear fit instead of just a &#39;mean&#39; to account for slopes (useful for flagging on beam_area)</span>
            <span class="n">local_axratio</span> <span class="o">=</span> <span class="n">axratio</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">steps</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1">### Heuristic : how many iterations here ?</span>
                <span class="n">local_axratio</span><span class="p">[</span> <span class="n">weight</span><span class="o">==</span><span class="kc">False</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">mean_axrat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">local_axratio</span><span class="p">)</span>
                <span class="n">std_axrat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">local_axratio</span><span class="p">)</span>
                <span class="c1">## Flag all points deviating from the mean by 3 times stdev</span>
                <span class="n">weight</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">local_axratio</span><span class="o">-</span><span class="n">mean_axrat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">std_axrat</span> <span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1">## Find the first channel with a valid beam</span>
            <span class="n">validbeamchans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
            <span class="n">chanid</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">validbeamchans</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">chanid</span><span class="o">=</span><span class="n">validbeamchans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No valid beams in </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">psf_filename</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nchan</span><span class="p">)</span>

            <span class="c1">## Fill all flagged channels with the largest/first valid beam</span>
            <span class="n">dummybeam</span> <span class="o">=</span> <span class="n">allbeams</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chanid</span><span class="p">)][</span><span class="s1">&#39;*0&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">weight</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">setrestoringbeam</span><span class="p">(</span> <span class="n">major</span><span class="o">=</span><span class="n">dummybeam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="n">dummybeam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="n">pa</span><span class="o">=</span><span class="n">dummybeam</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">],</span> <span class="n">channel</span><span class="o">=</span><span class="n">ii</span><span class="p">)</span>

        <span class="c1">## Need to close and reopen for commonbeam() to see the new chan beams !</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">psf_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="c1">## Recalculate common beam</span>
            <span class="n">newcommonbeam</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">commonbeam</span><span class="p">()</span>

        <span class="c1">## Reinstate the old beam to get back to the original iter0 product</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">psf_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchan</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">weight</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                    <span class="n">beam</span> <span class="o">=</span> <span class="n">allbeams</span><span class="p">[</span><span class="s1">&#39;beams&#39;</span><span class="p">][</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)][</span><span class="s1">&#39;*0&#39;</span><span class="p">]</span>
                    <span class="n">image</span><span class="o">.</span><span class="n">setrestoringbeam</span><span class="p">(</span> <span class="n">major</span><span class="o">=</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">],</span> <span class="n">minor</span><span class="o">=</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">],</span> <span class="n">pa</span><span class="o">=</span><span class="n">beam</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">],</span> <span class="n">channel</span><span class="o">=</span><span class="n">ii</span> <span class="p">)</span>

        <span class="k">return</span> <span class="n">newcommonbeam</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">weight</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_cfcaches">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_cfcaches">[docs]</a>
    <span class="k">def</span> <span class="nf">get_cfcaches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfcache</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parses comma separated cfcache string</span>

<span class="sd">        Used to input wide band and non-wide band cfcaches at the same time in</span>
<span class="sd">        VLASS-SE-CONT imaging mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">cfcache</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.smallscalebias">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.smallscalebias">[docs]</a>
    <span class="k">def</span> <span class="nf">smallscalebias</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A numerical control to bias the scales when using multi-scale or mtmfs algorithms&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.restoringbeam">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.restoringbeam">[docs]</a>
    <span class="k">def</span> <span class="nf">restoringbeam</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean parameter&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.pointingoffsetsigdev">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.pointingoffsetsigdev">[docs]</a>
    <span class="k">def</span> <span class="nf">pointingoffsetsigdev</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean parameter&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.pbmask">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.pbmask">[docs]</a>
    <span class="k">def</span> <span class="nf">pbmask</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean pbmask parameter heuristics&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.get_outmaskratio">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.get_outmaskratio">[docs]</a>
    <span class="k">def</span> <span class="nf">get_outmaskratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>  <span class="n">image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">pbimage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cleanmask</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">pblimit</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">frac_lim</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine fractional flux in final image outside cleanmask&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.weighting">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.weighting">[docs]</a>
    <span class="k">def</span> <span class="nf">weighting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specmode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the weighting scheme.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;briggs&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;briggsbwtaper&#39;</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.perchanweightdensity">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.perchanweightdensity">[docs]</a>
    <span class="k">def</span> <span class="nf">perchanweightdensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">specmode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine the perchanweightdensity parameter.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ImageParamsHeuristics.psfcutoff">
<a class="viewcode-back" href="../../../../_apidoc/pipeline.hif.heuristics.html#pipeline.hif.heuristics.imageparams_base.ImageParamsHeuristics.psfcutoff">[docs]</a>
    <span class="k">def</span> <span class="nf">psfcutoff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tclean psfcutoff parameter heuristics.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>