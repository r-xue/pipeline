

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hif.tasks.makeimlist.makeimlist &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task (sphinx-autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Pipeline Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <cite>Pipeline</cite></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Task Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html">pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif.tasks">pipeline-l2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif">pipeline-l3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#pipeline-diagram">pipeline-diagram</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hif.tasks.makeimlist.makeimlist</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hif.tasks.makeimlist.makeimlist</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">pipeline.domain.measures</span> <span class="k">as</span> <span class="nn">measures</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.sessionutils</span> <span class="k">as</span> <span class="nn">sessionutils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.vdp</span> <span class="k">as</span> <span class="nn">vdp</span>
<span class="kn">from</span> <span class="nn">pipeline.domain</span> <span class="kn">import</span> <span class="n">DataType</span>
<span class="kn">from</span> <span class="nn">pipeline.hif.heuristics</span> <span class="kn">import</span> <span class="n">imageparams_factory</span>
<span class="kn">from</span> <span class="nn">pipeline.hif.tasks.makeimages.resultobjects</span> <span class="kn">import</span> <span class="n">MakeImagesResult</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">task_registry</span>

<span class="kn">from</span> <span class="nn">.cleantarget</span> <span class="kn">import</span> <span class="n">CleanTarget</span>
<span class="kn">from</span> <span class="nn">.resultobjects</span> <span class="kn">import</span> <span class="n">MakeImListResult</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="MakeImListInputs">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImListInputs">[docs]</a>
<span class="k">class</span> <span class="nc">MakeImListInputs</span><span class="p">(</span><span class="n">vdp</span><span class="o">.</span><span class="n">StandardInputs</span><span class="p">):</span>
    <span class="c1"># Must use empty data type list to allow for user override and</span>
    <span class="c1"># automatic determination depending on specmode, field and spw.</span>
    <span class="n">processing_data_type</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># simple properties with no logic ----------------------------------------------------------------------------------</span>
    <span class="n">calmaxpix</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="n">imagename</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">intent</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">)</span>
    <span class="n">nchan</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">outframe</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
    <span class="n">phasecenter</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">psf_phasecenter</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">uvrange</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">width</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">clearlist</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">per_eb</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">per_session</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">calcsb</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">datatype</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">datacolumn</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">parallel</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;automatic&#39;</span><span class="p">)</span>
    <span class="n">robust</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">uvtaper</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># properties requiring some processing or MS-dependent logic -------------------------------------------------------</span>

    <span class="n">contfile</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;cont.dat&#39;</span><span class="p">)</span>

    <span class="nd">@contfile</span><span class="o">.</span><span class="n">postprocess</span>
    <span class="k">def</span> <span class="nf">contfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unprocessed</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">unprocessed</span><span class="p">)</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="ow">and</span> <span class="s1">&#39;field&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@field</span><span class="o">.</span><span class="n">convert</span>
    <span class="k">def</span> <span class="nf">field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
            <span class="c1"># PIPE-1881: allow field names that mistakenly get casted into non-string datatype by</span>
            <span class="c1"># recipereducer (utils.string_to_val) and executeppr (XmlObjectifier.castType)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The field selection input </span><span class="si">%r</span><span class="s1"> is not a string and will be converted.&#39;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">hm_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="ow">and</span> <span class="s1">&#39;hm_cell&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;hm_cell&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@hm_cell</span><span class="o">.</span><span class="n">convert</span>
    <span class="k">def</span> <span class="nf">hm_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Malformatted value for hm_cell: </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;ppb&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">item</span>

        <span class="k">return</span> <span class="n">val</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">hm_imsize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="ow">and</span> <span class="s1">&#39;hm_imsize&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;hm_imsize&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@hm_imsize</span><span class="o">.</span><span class="n">convert</span>
    <span class="k">def</span> <span class="nf">hm_imsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Malformatted value for hm_imsize: </span><span class="si">{!r}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;pb&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">item</span>

        <span class="k">return</span> <span class="n">val</span>

    <span class="n">linesfile</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;lines.dat&#39;</span><span class="p">)</span>

    <span class="nd">@linesfile</span><span class="o">.</span><span class="n">postprocess</span>
    <span class="k">def</span> <span class="nf">linesfile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unprocessed</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">unprocessed</span><span class="p">)</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">nbins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="ow">and</span> <span class="s1">&#39;nbins&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;nbins&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="ow">and</span> <span class="s1">&#39;spw&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">specmode</span><span class="o">==</span><span class="s1">&#39;cube&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@spw</span><span class="o">.</span><span class="n">convert</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="c1"># Use str() method to catch single spwid case via PPR which maps to int.</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">specmode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;cube&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;mfs&#39;</span>

<div class="viewcode-block" id="MakeImListInputs.get_spw_hm_cell">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImListInputs.get_spw_hm_cell">[docs]</a>
    <span class="k">def</span> <span class="nf">get_spw_hm_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If possible obtain spwlist specific hm_cell, otherwise return generic value.</span>

<span class="sd">        hif_checkproductsize() task determines the mitigation parameters. It does not know, however, about the</span>
<span class="sd">        set spwlist in the hif_makeimlist call and determines mitigation parameters per band (complete spw set).</span>
<span class="sd">        The band containing the set spwlist is determined by checking whether spwlist is a subset of the band</span>
<span class="sd">        spw list. The mitigation parameters found for the matching band are applied to the set spwlist.</span>

<span class="sd">        If no singluar band (spw set) is found that would contain spwlist, then the default hm_cell heuristics is</span>
<span class="sd">        returned.</span>

<span class="sd">        TODO: refactor and make hif_checkproductsize() (or a new task) spwlist aware.&quot;&quot;&quot;</span>
        <span class="n">mitigated_hm_cell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">multi_target_size_mitigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_target_size_mitigation&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">multi_target_size_mitigation</span><span class="p">:</span>
            <span class="n">multi_target_spwlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">spws</span> <span class="k">for</span> <span class="n">spws</span> <span class="ow">in</span> <span class="n">multi_target_size_mitigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">spwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spws</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_target_spwlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mitigated_hm_cell</span> <span class="o">=</span> <span class="n">multi_target_size_mitigation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">multi_target_spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hm_cell&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mitigated_hm_cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">{}]:</span>
            <span class="k">return</span> <span class="n">mitigated_hm_cell</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hm_cell</span></div>


<div class="viewcode-block" id="MakeImListInputs.get_spw_hm_imsize">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImListInputs.get_spw_hm_imsize">[docs]</a>
    <span class="k">def</span> <span class="nf">get_spw_hm_imsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If possible obtain spwlist specific hm_imsize, otherwise return generic value.</span>

<span class="sd">        TODO: refactor and make hif_checkproductsize() (or a new task) spwlist aware.&quot;&quot;&quot;</span>
        <span class="n">mitigated_hm_imsize</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">multi_target_size_mitigation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;multi_target_size_mitigation&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">multi_target_size_mitigation</span><span class="p">:</span>
            <span class="n">multi_target_spwlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">spws</span> <span class="k">for</span> <span class="n">spws</span> <span class="ow">in</span> <span class="n">multi_target_size_mitigation</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">spwlist</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spws</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">multi_target_spwlist</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mitigated_hm_imsize</span> <span class="o">=</span> <span class="n">multi_target_size_mitigation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">multi_target_spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hm_imsize&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mitigated_hm_imsize</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">{}]:</span>
            <span class="k">return</span> <span class="n">mitigated_hm_imsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">hm_imsize</span></div>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imagename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">contfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linesfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uvrange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hm_imsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">hm_cell</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calmaxpix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phasecenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psf_phasecenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nchan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">robust</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clearlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">per_eb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">per_session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">calcsb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">datacolumn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">known_synthesized_beams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scal</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">imagename</span> <span class="o">=</span> <span class="n">imagename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intent</span> <span class="o">=</span> <span class="n">intent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="n">contfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="n">linesfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvrange</span> <span class="o">=</span> <span class="n">uvrange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">specmode</span> <span class="o">=</span> <span class="n">specmode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outframe</span> <span class="o">=</span> <span class="n">outframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hm_imsize</span> <span class="o">=</span> <span class="n">hm_imsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hm_cell</span> <span class="o">=</span> <span class="n">hm_cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calmaxpix</span> <span class="o">=</span> <span class="n">calmaxpix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span> <span class="o">=</span> <span class="n">phasecenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_phasecenter</span> <span class="o">=</span> <span class="n">psf_phasecenter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nchan</span> <span class="o">=</span> <span class="n">nchan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robust</span> <span class="o">=</span> <span class="n">robust</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span> <span class="o">=</span> <span class="n">uvtaper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearlist</span> <span class="o">=</span> <span class="n">clearlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_eb</span> <span class="o">=</span> <span class="n">per_eb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">per_session</span> <span class="o">=</span> <span class="n">per_session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calcsb</span> <span class="o">=</span> <span class="n">calcsb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datatype</span> <span class="o">=</span> <span class="n">datatype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datacolumn</span> <span class="o">=</span> <span class="n">datacolumn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">parallel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">known_synthesized_beams</span> <span class="o">=</span> <span class="n">known_synthesized_beams</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scal</span> <span class="o">=</span> <span class="n">scal</span></div>



<div class="viewcode-block" id="MakeImList">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImList">[docs]</a>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_equivalent_casa_task</span><span class="p">(</span><span class="s1">&#39;hif_makeimlist&#39;</span><span class="p">)</span>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_casa_commands_comment</span><span class="p">(</span><span class="s1">&#39;A list of target sources to be imaged is constructed.&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MakeImList</span><span class="p">(</span><span class="n">basetask</span><span class="o">.</span><span class="n">StandardTaskTemplate</span><span class="p">):</span>
    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">MakeImListInputs</span>

    <span class="n">is_multi_vis_task</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="MakeImList.prepare">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImList.prepare">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># this python class will produce a list of images to be calculated.</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="n">calcsb</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">calcsb</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">parallel</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">known_synthesized_beams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">known_synthesized_beams</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">known_synthesized_beams</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">known_synthesized_beams</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">synthesized_beams</span>
        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">imaging_mode</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">scal</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imaging_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> <span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;JVLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">]:</span>
                <span class="n">imaging_mode</span> <span class="o">+=</span> <span class="s1">&#39;-SCAL&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;The self-cal imaging modes (*-SCAL) are only allowed for ALMA and VLA&#39;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">MakeImListResult</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">clearlist</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">clearlist</span>

        <span class="c1"># describe the function of this task by interpreting the inputs</span>
        <span class="c1"># parameters to give an execution context</span>
        <span class="n">long_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">_DESCRIPTIONS</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">intent</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;long description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Set-up parameters for </span><span class="si">%s</span><span class="s1"> imaging&#39;</span> <span class="o">%</span> <span class="s1">&#39; &amp; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">deduplicate</span><span class="p">(</span><span class="n">long_descriptions</span><span class="p">))</span>

        <span class="n">sidebar_suffixes</span> <span class="o">=</span> <span class="p">{</span><span class="n">_SIDEBAR_SUFFIX</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">intent</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">),</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span> <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)}</span>
        <span class="n">result</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sidebar suffix&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sidebar_suffixes</span><span class="p">)</span>

        <span class="c1"># Check if this stage has been disabled for vla (never set for ALMA)</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">vla_skip_mfs_and_cube_imaging</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cube&#39;</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Line imaging stages have been disabled for VLA due to no MS being produced for line imaging.&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span>
                                 <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>
            <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check for size mitigation errors.</span>
        <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">mitigation_error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Size mitigation had failed. No imaging targets were created.&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span>
                                 <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>
                <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># validate vis</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;vis&quot; must be a list of strings&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># validate specmode</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">,</span> <span class="s1">&#39;cube&#39;</span><span class="p">,</span> <span class="s1">&#39;repBW&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;specmode&quot; must be one of &quot;mfs&quot;, &quot;cont&quot;, &quot;cube&quot;, or &quot;repBW&quot;&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># datatype and datacolumn are mutually exclusive</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;datatype&quot; and &quot;datacolumn&quot; are mutually exclusive&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># validate datacolumn</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;CORRECTED&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;datacolumn&quot; must be &quot;data&quot; or &quot;corrected&quot;&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># make sure inputs.vis is a list, even it is one that contains a</span>
        <span class="c1"># single measurement set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">]</span>

        <span class="c1"># obtain the list of datatypes to consider in case that no datatype was explicitly requested</span>
        <span class="n">specmode_datatypes</span> <span class="o">=</span> <span class="n">DataType</span><span class="o">.</span><span class="n">get_specmode_datatypes</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>

        <span class="c1"># Check against any user input for datatype to make sure that the</span>
        <span class="c1"># correct initial vis list is chosen (e.g. for REGCAL_CONTLINE_ALL and RAW).</span>
        <span class="n">known_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">DataType</span><span class="p">]</span>
        <span class="n">explicit_user_datatypes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="c1"># Consider every comma separated user value just once</span>
            <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">datatype_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]))</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">datatype_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BEST&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;SELFCAL&#39;</span><span class="p">,</span> <span class="s1">&#39;REGCAL&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">):</span>
                <span class="n">datatype_checklist</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_datatypes_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">datatype_checklist</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Undefined data type(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_datatypes_str</span><span class="p">,</span> <span class="n">datatype_checklist</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="p">))</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="n">explicit_user_datatypes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Use only intersection of specmode and user data types</span>
                <span class="n">specmode_datatypes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specmode_datatypes</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DataType</span><span class="p">[</span><span class="n">datatype_str</span><span class="p">]</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">specmode_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">specmode_datatype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">specmode_datatype</span> <span class="ow">in</span> <span class="n">specmode_datatypes</span><span class="p">]</span>

        <span class="n">datacolumn</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span>

        <span class="c1"># Data type handling considers automatic and manual use cases. The automatic</span>
        <span class="c1"># use case tries to choose the best available data type by walking through the</span>
        <span class="c1"># predefined lists of data types per specmode. The first available data type</span>
        <span class="c1"># is used and if a fallback data type must be used, a warning is issued.</span>

        <span class="c1"># The manual use case is controlled by the &quot;datatype&quot; task parameter. It can</span>
        <span class="c1"># is a string that can contain comma separated explicit data type strings</span>
        <span class="c1"># (not DataType enums) or the special strings &quot;best&quot;, &quot;all&quot;, &quot;selfcal&quot;,</span>
        <span class="c1"># &quot;regcal&quot; or &quot;selfcal,regcal&quot;.</span>

        <span class="c1"># The following code block checks for any such task parameter input to override</span>
        <span class="c1"># the automatic scheme. Several variables are defined to pass the information</span>
        <span class="c1"># into the actual loop over imaging targets. The naming convention is such that</span>
        <span class="c1"># simple variable names like &quot;global_datatype&quot; or &quot;selected_datatype&quot; refer to</span>
        <span class="c1"># actual DataType enums. To compare these against the user input, one needs</span>
        <span class="c1"># stringified versions. The corresponding variables have &quot;_str&quot; appended. In</span>
        <span class="c1"># addition, there are variables aimed at rendering the data type information in</span>
        <span class="c1"># the weblog. These are not just simple data type strings, but can also be</span>
        <span class="c1"># something like &quot;&lt;actual data type&gt; instead of &lt;desired data type&gt;&quot; or &quot;N/A&quot;.</span>
        <span class="c1"># Those variables have the basename as above and then &quot;_info&quot; appended. For</span>
        <span class="c1"># the loops over several user data types, lists are needed. The list names</span>
        <span class="c1"># are using the plurals of the basenames and the corresponding &quot;_str&quot; or &quot;_info&quot;</span>
        <span class="c1"># appendices.</span>

        <span class="c1"># Select the correct vis list</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]):</span>
            <span class="p">(</span><span class="n">ms_objects_and_columns</span><span class="p">,</span> <span class="n">selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="n">specmode_datatypes</span><span class="p">,</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ms_objects_and_columns</span><span class="p">,</span> <span class="n">selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="n">specmode_datatypes</span><span class="p">,</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ms_objects_and_columns</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found. No imaging targets were created.&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span>
                             <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>
            <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># Check for changing vis lists.</span>
        <span class="k">if</span> <span class="n">explicit_user_datatypes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">user_datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]):</span>
                    <span class="p">(</span><span class="n">sub_ms_objects_and_columns</span><span class="p">,</span> <span class="n">sub_selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">DataType</span><span class="p">[</span><span class="n">user_datatype_str</span><span class="p">]],</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">sub_ms_objects_and_columns</span><span class="p">,</span> <span class="n">sub_selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">DataType</span><span class="p">[</span><span class="n">user_datatype_str</span><span class="p">]],</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">ms_objects_and_columns</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sub_ms_objects_and_columns</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Requested data types and specmode lead to multiple vis lists. Please run hif_makeimlist with data type selections per kind of MS (targets, targets_line, etc.).&#39;</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">return</span> <span class="n">result</span>

        <span class="n">global_datatype</span> <span class="o">=</span> <span class="n">selected_datatype</span>
        <span class="n">global_datatype_str</span> <span class="o">=</span> <span class="n">global_datatype</span><span class="o">.</span><span class="n">name</span>
        <span class="n">global_datatype_info</span> <span class="o">=</span> <span class="n">global_datatype_str</span>
        <span class="n">selected_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_str</span><span class="p">]</span>
        <span class="n">selected_datatypes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_info</span><span class="p">]</span>
        <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">global_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ms_objects_and_columns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="c1"># Log these messages only if there is no user data type</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using data type </span><span class="si">{</span><span class="n">selected_datatype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> for imaging.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">selected_datatype</span> <span class="o">==</span> <span class="n">DataType</span><span class="o">.</span><span class="n">RAW</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Falling back to raw data for imaging.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">global_column</span> <span class="o">==</span> <span class="n">global_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">global_column</span> <span class="ow">in</span> <span class="n">global_columns</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data type based column selection changes among MSes: </span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">ms_objects_and_columns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">ms_datacolumn</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="c1"># Handle difference in MS and tclean column naming schemes</span>
            <span class="k">if</span> <span class="n">ms_datacolumn</span> <span class="o">==</span> <span class="s1">&#39;CORRECTED&#39;</span><span class="p">:</span>
                <span class="n">ms_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span>
            <span class="n">ms_object</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ms_objects_and_columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ms_datacolumn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ms_object</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Data column </span><span class="si">{</span><span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span><span class="si">}</span><span class="s1"> not available.&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="n">global_datacolumn</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">global_datatype</span> <span class="o">=</span> <span class="n">ms_object</span><span class="o">.</span><span class="n">get_data_type</span><span class="p">(</span><span class="n">ms_datacolumn</span><span class="p">)</span>
            <span class="n">global_datatype_str</span> <span class="o">=</span> <span class="n">global_datatype</span><span class="o">.</span><span class="n">name</span>
            <span class="n">global_datatype_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">global_datatype_str</span><span class="si">}</span><span class="s1"> instead of </span><span class="si">{</span><span class="n">selected_datatype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> due to user datacolumn&#39;</span>
            <span class="n">selected_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_str</span><span class="p">]</span>
            <span class="n">selected_datatypes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_info</span><span class="p">]</span>
            <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Manual override of datacolumn to </span><span class="si">{</span><span class="n">global_datacolumn</span><span class="si">}</span><span class="s1">. Automatic data type (</span><span class="si">{</span><span class="n">selected_datatype</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">) based datacolumn would have been &quot;</span><span class="si">{</span><span class="s2">&quot;DATA&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">global_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;DATA&quot;</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;CORRECTED&quot;</span><span class="si">}</span><span class="s1">&quot;. Data type of </span><span class="si">{</span><span class="n">global_datacolumn</span><span class="si">}</span><span class="s1"> column is </span><span class="si">{</span><span class="n">global_datatype_str</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">global_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DATA&#39;</span><span class="p">:</span>
                <span class="n">global_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
            <span class="k">elif</span> <span class="n">global_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">:</span>
                <span class="n">global_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;corrected&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown column name </span><span class="si">{</span><span class="n">global_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">global_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">datacolumn</span> <span class="o">=</span> <span class="n">global_datacolumn</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ms_objects_and_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

        <span class="c1"># Handle user supplied data type requests</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="c1"># Extract all available data types for the vis list</span>
            <span class="n">vislist_datatypes_str</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">:</span>
                <span class="n">ms_object</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                <span class="c1"># Collect the data types across the vis list</span>
                <span class="n">vislist_datatypes_str</span> <span class="o">=</span> <span class="n">vislist_datatypes_str</span> <span class="o">+</span> <span class="p">[</span><span class="n">ms_datatype</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ms_datatype</span> <span class="ow">in</span> <span class="n">ms_object</span><span class="o">.</span><span class="n">data_column</span><span class="p">]</span>
            <span class="c1"># Use just a set</span>
            <span class="n">vislist_datatypes_str</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">vislist_datatypes_str</span><span class="p">))</span>
            <span class="c1"># Intersection of specmode based and vis based datatypes gives</span>
            <span class="c1"># list of actually available data types for this call.</span>
            <span class="n">available_datatypes_str</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specmode_datatypes_str</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">vislist_datatypes_str</span><span class="p">))</span>

            <span class="k">if</span> <span class="s1">&#39;BEST&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user_datatypes_str</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;BEST&#39;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;BEST&quot; and all other options are mutually exclusive&#39;</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">return</span> <span class="n">result</span>

                <span class="c1"># Automatic choice with fallback per source/spw selection</span>
                <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_str</span><span class="p">]</span>
                <span class="n">user_datatypes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">global_datatype_info</span><span class="p">]</span>
                <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="n">global_datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using data type </span><span class="si">{</span><span class="n">global_datatype</span><span class="si">}</span><span class="s1"> for imaging.&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;ALL&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">user_datatypes_str</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;ALL&quot; and all other options are mutually exclusive&#39;</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                    <span class="k">return</span> <span class="n">result</span>

                <span class="c1"># All SELFCAL and REGCAL choices available for this vis list</span>
                <span class="c1"># List selfcal first, then regcal</span>
                <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">available_datatypes_str</span> <span class="k">if</span> <span class="s1">&#39;SELFCAL&#39;</span> <span class="ow">in</span> <span class="n">datatype_str</span><span class="p">]</span>
                <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="n">user_datatypes_str</span> <span class="o">+</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">available_datatypes_str</span> <span class="k">if</span> <span class="s1">&#39;REGCAL&#39;</span> <span class="ow">in</span> <span class="n">datatype_str</span><span class="p">]</span>
                <span class="n">user_datatypes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">]</span>
                <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datatype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
                <span class="k">if</span> <span class="s1">&#39;REGCAL&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span> <span class="ow">or</span> <span class="s1">&#39;SELFCAL&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                    <span class="c1"># Check if any explicit data types are given</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">specmode_datatypes</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;REGCAL&quot;/&quot;SELFCAL&quot; and explicit data types are mutually exclusive&#39;</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                        <span class="k">return</span> <span class="n">result</span>

                    <span class="c1"># Expand SELFCAL and REGCAL to explicit data types for this vis list</span>
                    <span class="n">expanded_user_datatypes_str</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># List selfcal first, then regcal</span>
                    <span class="k">if</span> <span class="s1">&#39;SELFCAL&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                        <span class="n">expanded_user_datatypes_str</span> <span class="o">=</span> <span class="n">expanded_user_datatypes_str</span> <span class="o">+</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">available_datatypes_str</span> <span class="k">if</span> <span class="s1">&#39;SELFCAL&#39;</span> <span class="ow">in</span> <span class="n">datatype_str</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;REGCAL&#39;</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">:</span>
                        <span class="n">expanded_user_datatypes_str</span> <span class="o">=</span> <span class="n">expanded_user_datatypes_str</span> <span class="o">+</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">available_datatypes_str</span> <span class="k">if</span> <span class="s1">&#39;REGCAL&#39;</span> <span class="ow">in</span> <span class="n">datatype_str</span><span class="p">]</span>
                    <span class="n">user_datatypes_str</span> <span class="o">=</span> <span class="n">expanded_user_datatypes_str</span>
                    <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Explicit individual data types</span>
                    <span class="n">datatype_checklist</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">known_datatypes_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">datatype_checklist</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Undefined data type(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_datatypes_str</span><span class="p">,</span> <span class="n">datatype_checklist</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span><span class="p">))</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
                        <span class="k">return</span> <span class="n">result</span>
                    <span class="n">automatic_datatype_choice</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">user_datatypes_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">datatype_str</span> <span class="k">for</span> <span class="n">datatype_str</span> <span class="ow">in</span> <span class="n">user_datatypes_str</span><span class="p">]</span>

            <span class="n">selected_datatypes_str</span> <span class="o">=</span> <span class="n">user_datatypes_str</span>
            <span class="n">selected_datatypes_info</span> <span class="o">=</span> <span class="n">user_datatypes_info</span>

        <span class="n">image_heuristics_factory</span> <span class="o">=</span> <span class="n">imageparams_factory</span><span class="o">.</span><span class="n">ImageParamsHeuristicsFactory</span><span class="p">()</span>

        <span class="c1"># Initial heuristics instance without spw information.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span> <span class="o">=</span> <span class="n">image_heuristics_factory</span><span class="o">.</span><span class="n">getHeuristics</span><span class="p">(</span>
            <span class="n">vislist</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span>
            <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">observing_run</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="p">,</span>
            <span class="n">imagename_prefix</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span><span class="p">,</span>
            <span class="n">proj_params</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project_performance_parameters</span><span class="p">,</span>
            <span class="n">contfile</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">contfile</span><span class="p">,</span>
            <span class="n">linesfile</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">linesfile</span><span class="p">,</span>
            <span class="n">imaging_params</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">,</span>
            <span class="n">imaging_mode</span><span class="o">=</span><span class="n">imaging_mode</span>
        <span class="p">)</span>

        <span class="c1"># Get representative target information</span>
        <span class="n">repr_target</span><span class="p">,</span> <span class="n">repr_source</span><span class="p">,</span> <span class="n">repr_spw</span><span class="p">,</span> <span class="n">repr_freq</span><span class="p">,</span> <span class="n">reprBW_mode</span><span class="p">,</span> <span class="n">real_repr_target</span><span class="p">,</span> <span class="n">minAcceptableAngResolution</span><span class="p">,</span> <span class="n">maxAcceptableAngResolution</span><span class="p">,</span> <span class="n">maxAllowedBeamAxialRatio</span><span class="p">,</span> <span class="n">sensitivityGoal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">representative_target</span><span class="p">()</span>

        <span class="c1"># representative target case</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;repBW&#39;</span><span class="p">:</span>
            <span class="n">repr_target_mode</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">image_repr_target</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># The PI cube shall only be created for real representative targets</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">real_repr_target</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No representative target found. No PI cube will be made.&#39;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;No representative target found. No PI cube will be made.&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="s1">&#39;repBW&#39;</span><span class="p">})</span>
                <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="c1"># The PI cube shall only be created for cube mode</span>
            <span class="k">elif</span> <span class="n">reprBW_mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;multi_spw&#39;</span><span class="p">,</span> <span class="s1">&#39;all_spw&#39;</span><span class="p">]:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Representative target bandwidth specifies aggregate continuum. No PI cube will be made since&quot;</span>
                         <span class="s2">&quot; specmode=&#39;cont&#39; already covers this case.&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s2">&quot;Representative target bandwidth specifies aggregate continuum. No PI cube will&quot;</span>
                                        <span class="s2">&quot; be made since specmode=&#39;cont&#39; already covers this case.&quot;</span><span class="p">,</span>
                                 <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="s1">&#39;repBW&#39;</span><span class="p">})</span>
                <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="n">reprBW_mode</span> <span class="o">==</span> <span class="s1">&#39;repr_spw&#39;</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Representative target bandwidth specifies per spw continuum. No PI cube will be made since&quot;</span>
                         <span class="s2">&quot; specmode=&#39;mfs&#39; already covers this case.&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s2">&quot;Representative target bandwidth specifies per spw continuum. No PI cube will&quot;</span>
                                        <span class="s2">&quot; be made since specmode=&#39;mfs&#39; already covers this case.&quot;</span><span class="p">,</span>
                                 <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="s1">&#39;repBW&#39;</span><span class="p">})</span>
                <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">repr_spw_nbin</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">size_mitigation_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nbins&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">nbin_items</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nbins</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">nbin_item</span> <span class="ow">in</span> <span class="n">nbin_items</span><span class="p">:</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">nbin_item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">repr_spw</span><span class="p">):</span>
                            <span class="n">repr_spw_nbin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># The PI cube shall only be created if the PI bandwidth is greater</span>
                <span class="c1"># than 4 times the nbin averaged bandwidth used in the default cube</span>
                <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">real_repr_spw</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">repr_spw</span><span class="p">,</span> <span class="n">ref_ms</span><span class="p">)</span>
                <span class="n">physicalBW_of_1chan_Hz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_repr_spw</span><span class="p">)</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">convert_to</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="n">repr_spw_nbin_bw_Hz</span> <span class="o">=</span> <span class="n">repr_spw_nbin</span> <span class="o">*</span> <span class="n">physicalBW_of_1chan_Hz</span>
                <span class="n">reprBW_Hz</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">repr_target</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;Hz&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">reprBW_Hz</span> <span class="o">&gt;</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">repr_spw_nbin_bw_Hz</span><span class="p">:</span>
                    <span class="n">repr_spw_nbin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">reprBW_Hz</span> <span class="o">/</span> <span class="n">physicalBW_of_1chan_Hz</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">repr_spw</span><span class="p">,</span> <span class="n">repr_spw_nbin</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Making PI cube at </span><span class="si">%.3g</span><span class="s1"> MHz channel width.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">physicalBW_of_1chan_Hz</span> <span class="o">*</span> <span class="n">repr_spw_nbin</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">))</span>
                    <span class="n">image_repr_target</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">repr_source</span>
                    <span class="n">inputs</span><span class="o">.</span><span class="n">spw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">repr_spw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Representative target bandwidth is less or equal than 4 times the nbin averaged default&#39;</span>
                             <span class="s1">&#39; cube channel width. No PI cube will be made since the default cube already covers this&#39;</span>
                             <span class="s1">&#39; case.&#39;</span><span class="p">)</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;Representative target bandwidth is less or equal than 4 times the nbin&#39;</span>
                                            <span class="s1">&#39; averaged default cube channel width. No PI cube will be made since the&#39;</span>
                                            <span class="s1">&#39; default cube already covers this case.&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="s1">&#39;repBW&#39;</span><span class="p">})</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">repr_target_mode</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">image_repr_target</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">repr_target_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">repr_target_mode</span> <span class="ow">and</span> <span class="n">image_repr_target</span><span class="p">):</span>
            <span class="c1"># read the spw, if none then set default</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">spw</span>

            <span class="k">if</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">spwids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_ids</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spwids</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)</span> <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">spw</span>

            <span class="n">spwlist</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">spwlist</span> <span class="o">=</span> <span class="n">spwlist</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;&#39;,&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;[]&#39;</span>
            <span class="n">spwlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_session</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&quot;per_eb&quot; and &quot;per_session&quot; are mutually exclusive&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span><span class="p">:</span>
            <span class="n">vislists</span> <span class="o">=</span> <span class="p">[[</span><span class="n">vis</span><span class="p">]</span> <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_session</span><span class="p">:</span>
            <span class="n">vislists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sessionutils</span><span class="o">.</span><span class="n">group_vislist_into_sessions</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vislists</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">imaging_mode</span><span class="p">:</span>
            <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">vla_band</span> <span class="o">=</span> <span class="n">ref_ms</span><span class="o">.</span><span class="n">get_vla_spw2band</span><span class="p">()</span>
            <span class="n">band_spws</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vla_band</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
                    <span class="n">band_spws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">imaging_mode</span><span class="p">:</span>
            <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">band_spws</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
                <span class="n">real_spw_id</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">spwid</span><span class="p">),</span> <span class="n">ref_ms</span><span class="p">)</span>
                <span class="n">real_spw_id_obj</span> <span class="o">=</span> <span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spw_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">real_spw_id_obj</span><span class="p">:</span>
                    <span class="n">band_name</span> <span class="o">=</span> <span class="n">real_spw_id_obj</span><span class="o">.</span><span class="n">band</span>
                    <span class="n">band_spws</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">band_name</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">band_spws</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

        <span class="c1"># Need to record if there are targets for a vislist</span>
        <span class="n">have_targets</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">expected_num_targets</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">selected_datatype_str</span><span class="p">,</span> <span class="n">selected_datatype_info</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">selected_datatypes_str</span><span class="p">,</span> <span class="n">selected_datatypes_info</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">band_spws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">band</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># The format of &quot;spw&quot; is &quot;[&#39;&lt;id1&gt;&#39;,&#39;&lt;id2&gt;&#39;,...,&#39;&lt;idN&gt;&#39;]&quot;, i.e. without any</span>
                    <span class="c1"># blanks (see also above where the default spw value is computed for the non</span>
                    <span class="c1"># band case).</span>
                    <span class="n">spw</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">band_spws</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span>
                    <span class="n">spwlist</span> <span class="o">=</span> <span class="n">band_spws</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">vislist</span> <span class="ow">in</span> <span class="n">vislists</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span><span class="p">:</span>
                        <span class="n">imagename_prefix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">remove_trailing_string</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;.ms&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_session</span><span class="p">:</span>
                        <span class="n">imagename_prefix</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">session</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">imagename_prefix</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span> <span class="o">=</span> <span class="n">image_heuristics_factory</span><span class="o">.</span><span class="n">getHeuristics</span><span class="p">(</span>
                        <span class="n">vislist</span><span class="o">=</span><span class="n">vislist</span><span class="p">,</span>
                        <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span>
                        <span class="n">observing_run</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="p">,</span>
                        <span class="n">imagename_prefix</span><span class="o">=</span><span class="n">imagename_prefix</span><span class="p">,</span>
                        <span class="n">proj_params</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">project_performance_parameters</span><span class="p">,</span>
                        <span class="n">contfile</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">contfile</span><span class="p">,</span>
                        <span class="n">linesfile</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">linesfile</span><span class="p">,</span>
                        <span class="n">imaging_params</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">,</span>
                        <span class="n">imaging_mode</span><span class="o">=</span><span class="n">imaging_mode</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                        <span class="c1"># Make sure the spw list is sorted numerically</span>
                        <span class="n">spwlist_local</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">))))]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spwlist_local</span> <span class="o">=</span> <span class="n">spwlist</span>

                    <span class="c1"># get list of field_ids/intents to be cleaned</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">repr_target_mode</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">repr_target_mode</span> <span class="ow">and</span> <span class="n">image_repr_target</span><span class="p">):</span>
                        <span class="n">field_intent_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">field_intent_list</span><span class="p">(</span>
                          <span class="n">intent</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">field</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Expand cont spws</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                        <span class="n">spwids</span> <span class="o">=</span> <span class="n">spwlist_local</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spwids</span> <span class="o">=</span> <span class="n">spwlist_local</span>

                    <span class="c1"># Generate list of observed vis/field/spw combinations</span>
                    <span class="n">vislist_field_intent_spw_combinations</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                        <span class="n">vislist_for_field</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">spwids_for_field</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                            <span class="n">ms_domain_obj</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                            <span class="c1"># Get the real spw IDs for this MS</span>
                            <span class="c1"># TODO: This is missing spws that got removed in hif_uvcontsub.</span>
                            <span class="c1">#       Need to involve the full spwlist from above.</span>
                            <span class="n">ms_science_spwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms_domain_obj</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()]</span>
                            <span class="k">if</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms_domain_obj</span><span class="o">.</span><span class="n">fields</span><span class="p">]:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># Get a field domain object. Make sure that it has the necessary intent. Otherwise the list of spw IDs</span>
                                    <span class="c1"># will not match with the available science spw IDs.</span>
                                    <span class="c1"># Using all intents (inputs.intent) here. Further filtering is performed in the next block.</span>
                                    <span class="n">field_domain_objs</span> <span class="o">=</span> <span class="n">ms_domain_obj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intent</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">field_domain_objs</span> <span class="o">!=</span> <span class="p">[]:</span>
                                        <span class="n">field_domain_obj</span> <span class="o">=</span> <span class="n">field_domain_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="c1"># Get all science spw IDs for this field and record the ones that are present in this MS</span>
                                        <span class="n">field_intent_science_spwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw_domain_obj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw_domain_obj</span> <span class="ow">in</span> <span class="n">field_domain_obj</span><span class="o">.</span><span class="n">valid_spws</span> <span class="k">if</span> <span class="n">spw_domain_obj</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">ms_science_spwids</span> <span class="ow">and</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">spw_domain_obj</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
                                        <span class="c1"># Record the virtual spwids</span>
                                        <span class="n">spwids_per_vis_and_field</span> <span class="o">=</span> <span class="p">[</span>
                                            <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ms_domain_obj</span><span class="p">)</span>
                                            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">field_intent_science_spwids</span>
                                            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">real2virtual_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ms_domain_obj</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">spwids</span><span class="p">))]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">spwids_per_vis_and_field</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                    <span class="n">spwids_per_vis_and_field</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">spwids_per_vis_and_field</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">spwids_per_vis_and_field</span> <span class="o">!=</span> <span class="p">[]:</span>
                                <span class="n">vislist_for_field</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                                <span class="n">spwids_for_field</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spwids_per_vis_and_field</span><span class="p">)</span>
                        <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vislist&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;spwids&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
                        <span class="k">if</span> <span class="n">vislist_for_field</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vislist_for_field</span>
                            <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;spwids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">spwids_for_field</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                            <span class="c1"># Count the observed field/spw combinations. If the selected data type</span>
                            <span class="c1"># is not available, the counter will be decremented later since that</span>
                            <span class="c1"># check happens further below.</span>
                            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                                <span class="n">expected_num_targets</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">expected_num_targets</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spwids_for_field</span><span class="p">)</span>

                    <span class="c1"># Save original vislist_field_intent_spw_combinations dictionary to be able to generate</span>
                    <span class="c1"># proper messages if the vis list changes when falling back to a different data</span>
                    <span class="c1"># type for a given source/spw combination later on. The vislist_field_intent_spw_combinations</span>
                    <span class="c1"># dictionary is possibly being modified on-the-fly below.</span>
                    <span class="n">original_vislist_field_intent_spw_combinations</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">)</span>

                    <span class="c1"># Remove bad spws and record actual vis/field/spw combinations containing data.</span>
                    <span class="c1"># Record all spws with actual data in a global list.</span>
                    <span class="c1"># Need all spw keys (individual and cont) to distribute the</span>
                    <span class="c1"># cell and imsize heuristic results which work on the</span>
                    <span class="c1"># highest/lowest frequency spw only.</span>
                    <span class="n">all_spw_keys</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_data</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">filtered_spwlist</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                        <span class="n">ms_domain_obj</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                        <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="n">field_intent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)]:</span>
                                <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="c1"># Check only possible field/spw combinations to speed up</span>
                            <span class="k">if</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_intent</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="c1"># Check if this field is present in the current MS and has the necessary intent.</span>
                                <span class="c1"># Using get_fields(name=...) since it does not throw an exception if the field is not found.</span>
                                <span class="k">if</span> <span class="n">ms_domain_obj</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="p">[]:</span>
                                    <span class="n">observed_vis_list</span> <span class="o">=</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_intent</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vislist&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="n">observed_spwids_list</span> <span class="o">=</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_intent</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spwids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">observed_vis_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">observed_spwids_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                        <span class="c1"># Save spws in main list</span>
                                        <span class="n">all_spw_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">observed_spwids_list</span><span class="p">))</span>
                                        <span class="c1"># Also save cont selection</span>
                                        <span class="n">all_spw_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">observed_spwids_list</span><span class="p">)))</span>
                                        <span class="k">for</span> <span class="n">observed_spwid</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">observed_spwids_list</span><span class="p">):</span>
                                            <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">has_data</span><span class="p">(</span><span class="n">field_intent_list</span><span class="o">=</span><span class="p">[</span><span class="n">field_intent</span><span class="p">],</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">observed_spwid</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="p">[</span><span class="n">vis</span><span class="p">])[</span><span class="n">field_intent</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span> <span class="ow">and</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">observed_vis_list</span><span class="p">:</span>
                                                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Data for EB </span><span class="si">{}</span><span class="s1">, field </span><span class="si">{}</span><span class="s1">, spw </span><span class="si">{}</span><span class="s1"> is completely flagged.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">observed_spwid</span><span class="p">))</span>
                                            <span class="c1"># Aggregated value per vislist (replace with lookup pattern later)</span>
                                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">]:</span>
                                                <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span> <span class="ow">or</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]</span>
                                            <span class="k">if</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)]:</span>
                                                <span class="n">filtered_spwlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observed_spwid</span><span class="p">)</span>
                    <span class="n">filtered_spwlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filtered_spwlist</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

                    <span class="c1"># Collapse cont spws</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                        <span class="n">filtered_spwlist_local</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_spwlist</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filtered_spwlist_local</span> <span class="o">=</span> <span class="n">filtered_spwlist</span>

                    <span class="k">if</span> <span class="n">filtered_spwlist_local</span> <span class="o">==</span> <span class="p">[]</span> <span class="ow">or</span> <span class="n">filtered_spwlist_local</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                        <span class="c1"># We can get here for example if a multiband observations does not feature</span>
                        <span class="c1"># LF or HF spws for a given field (PIPE-832). We should not log anything in</span>
                        <span class="c1"># that case. Before PIPE-832 there used to be a provisional error message for</span>
                        <span class="c1"># potential other cases, but this probably never happened. For now just</span>
                        <span class="c1"># continuing in the loop.</span>
                        <span class="c1">#LOG.error(&#39;No spws left for vis list {}&#39;.format(&#39;,&#39;.join(os.path.basename(vis) for vis in vislist)))</span>
                        <span class="k">continue</span>

                    <span class="c1"># Parse hm_cell to get optional pixperbeam setting</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get_spw_hm_cell</span><span class="p">(</span><span class="n">filtered_spwlist_local</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">pixperbeam</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;ppb&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pixperbeam</span> <span class="o">=</span> <span class="mf">5.0</span>

                    <span class="c1"># Add actual, possibly reduced cont spw combination to be able to properly populate the lookup tables later on</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                        <span class="n">all_spw_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_spwlist</span><span class="p">))</span>
                    <span class="c1"># Keep only unique entries</span>
                    <span class="n">all_spw_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_spw_keys</span><span class="p">))</span>

                    <span class="c1"># Select only the lowest / highest frequency spw to get the smallest (for cell size)</span>
                    <span class="c1"># and largest beam (for imsize)</span>
                    <span class="n">min_freq</span> <span class="o">=</span> <span class="mf">1e15</span>
                    <span class="n">max_freq</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">min_freq_spwid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="n">max_freq_spwid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">filtered_spwlist</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ref_msname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">get_ref_msname</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                            <span class="n">ref_ms</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">ref_msname</span><span class="p">)</span>
                            <span class="n">real_spwid</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">ref_ms</span><span class="p">)</span>
                            <span class="n">spwid_centre_freq</span> <span class="o">=</span> <span class="n">ref_ms</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">real_spwid</span><span class="p">)</span><span class="o">.</span><span class="n">centre_frequency</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">spwid_centre_freq</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">:</span>
                                <span class="n">min_freq</span> <span class="o">=</span> <span class="n">spwid_centre_freq</span>
                                <span class="n">min_freq_spwid</span> <span class="o">=</span> <span class="n">spwid</span>
                            <span class="k">if</span> <span class="n">spwid_centre_freq</span> <span class="o">&gt;</span> <span class="n">max_freq</span><span class="p">:</span>
                                <span class="n">max_freq</span> <span class="o">=</span> <span class="n">spwid_centre_freq</span>
                                <span class="n">max_freq_spwid</span> <span class="o">=</span> <span class="n">spwid</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not determine min/max frequency for spw </span><span class="si">{</span><span class="n">spwid</span><span class="si">}</span><span class="s1">. Exception: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">min_freq_spwid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">max_freq_spwid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not determine min/max frequency spw IDs for </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filtered_spwlist_local</span><span class="p">)))</span>
                        <span class="k">continue</span>

                    <span class="n">min_freq_spwlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">min_freq_spwid</span><span class="p">)]</span>
                    <span class="n">max_freq_spwlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">max_freq_spwid</span><span class="p">)]</span>

                    <span class="c1"># Get robust and uvtaper values</span>
                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">robust</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.0</span><span class="p">):</span>
                        <span class="n">robust</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">robust</span>
                    <span class="k">elif</span> <span class="s1">&#39;robust&#39;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">:</span>
                        <span class="n">robust</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">robust</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">robust</span><span class="p">(</span><span class="n">specmode</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">uvtaper</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[]):</span>
                        <span class="n">uvtaper</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">uvtaper</span>
                    <span class="k">elif</span> <span class="s1">&#39;uvtaper&#39;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">:</span>
                        <span class="n">uvtaper</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">imaging_parameters</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">uvtaper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">()</span>

                    <span class="c1"># cell is a list of form [cellx, celly]. If the list has form [cell]</span>
                    <span class="c1"># then that means the cell is the same size in x and y. If cell is</span>
                    <span class="c1"># empty then fill it with a heuristic result</span>
                    <span class="n">cells</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">cell</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="n">synthesized_beams</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="n">min_cell</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;3600arcsec&#39;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">max_freq_spwlist</span><span class="p">:</span>
                            <span class="c1"># Use only fields that were observed in spwspec</span>
                            <span class="n">actual_field_intent_list</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">vislist_field_intent_spw_combinations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_intent</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                        <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spwids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                                        <span class="n">spwspec</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;spwids&#39;</span><span class="p">]))):</span>
                                    <span class="n">actual_field_intent_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_intent</span><span class="p">)</span>

                            <span class="n">synthesized_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span> <span class="n">known_synthesized_beams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">synthesized_beam</span><span class="p">(</span>
                                <span class="n">field_intent_list</span><span class="o">=</span><span class="n">actual_field_intent_list</span><span class="p">,</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="n">uvtaper</span><span class="p">,</span>
                                <span class="n">pixperbeam</span><span class="o">=</span><span class="n">pixperbeam</span><span class="p">,</span> <span class="n">known_beams</span><span class="o">=</span><span class="n">known_synthesized_beams</span><span class="p">,</span> <span class="n">force_calc</span><span class="o">=</span><span class="n">calcsb</span><span class="p">,</span>
                                <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">synthesized_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Beam for virtual spw </span><span class="si">%s</span><span class="s1"> and robust value of </span><span class="si">%.1f</span><span class="s1"> is invalid. Cannot continue.&#39;</span>
                                          <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">robust</span><span class="p">))</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">result</span><span class="o">.</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid beam&#39;</span>
                                <span class="k">return</span> <span class="n">result</span>

                            <span class="c1"># Avoid recalculating every time since the dictionary will be cleared with the first recalculation request.</span>
                            <span class="n">calcsb</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># the heuristic cell is always the same for x and y as</span>
                            <span class="c1"># the value derives from the single value returned by</span>
                            <span class="c1"># imager.advise</span>
                            <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">beam</span><span class="o">=</span><span class="n">synthesized_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span> <span class="n">pixperbeam</span><span class="o">=</span><span class="n">pixperbeam</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;invalid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]):</span>
                                <span class="n">min_cell</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="k">if</span> <span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">min_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;arcsec&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="n">min_cell</span>
                        <span class="c1"># Rounding to two significant figures</span>
                        <span class="n">min_cell</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">%.2g%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">min_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="n">min_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
                        <span class="c1"># Need to populate all spw keys because the imsize heuristic picks</span>
                        <span class="c1"># up the lowest frequency spw.</span>
                        <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">all_spw_keys</span><span class="p">:</span>
                            <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cell</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">all_spw_keys</span><span class="p">:</span>
                            <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span>

                    <span class="c1"># get primary beams</span>
                    <span class="n">largest_primary_beams</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">min_freq_spwlist</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">)</span> <span class="o">!=</span> <span class="p">[]:</span>
                            <span class="n">largest_primary_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">largest_primary_beam_size</span><span class="p">(</span><span class="n">spwspec</span><span class="o">=</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">largest_primary_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">largest_primary_beam_size</span><span class="p">(</span><span class="n">spwspec</span><span class="o">=</span><span class="n">spwspec</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">)</span>

                    <span class="c1"># if phase center not set then use heuristic code to calculate the</span>
                    <span class="c1"># centers for each field</span>
                    <span class="n">phasecenter</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">phasecenter</span>
                    <span class="n">psf_phasecenter</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">psf_phasecenter</span>
                    <span class="n">phasecenters</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">psf_phasecenters</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">phasecenter</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">])</span>
                                <span class="n">phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">psf_phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">],</span> <span class="n">intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">primary_beam</span><span class="o">=</span><span class="n">largest_primary_beams</span><span class="p">[</span><span class="n">min_freq_spwlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">shift_to_nearest_field</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                <span class="c1"># problem defining center</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="n">phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">phasecenter</span>
                            <span class="n">psf_phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psf_phasecenter</span>

                    <span class="c1"># if imsize not set then use heuristic code to calculate the</span>
                    <span class="c1"># centers for each field/spwspec</span>
                    <span class="n">imsize</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">get_spw_hm_imsize</span><span class="p">(</span><span class="n">filtered_spwlist_local</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imsize</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">sfpblimit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imsize</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;pb&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">imsize</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sfpblimit</span> <span class="o">=</span> <span class="mf">0.2</span>
                    <span class="n">imsizes</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">imsize</span> <span class="o">==</span> <span class="p">[]:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="n">max_x_size</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="n">max_y_size</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">min_freq_spwlist</span><span class="p">:</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">field_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vislist</span><span class="o">=</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">])</span>
                                    <span class="c1"># Image size (FOV) may be determined depending on the fractional bandwidth of the</span>
                                    <span class="c1"># selected spectral windows. In continuum spectral mode pass the spw list string</span>
                                    <span class="c1"># to imsize heuristics (used only for VLA), otherwise pass None to disable the feature.</span>
                                    <span class="n">imsize_spwlist</span> <span class="o">=</span> <span class="n">filtered_spwlist_local</span> <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span> <span class="k">else</span> <span class="kc">None</span>
                                    <span class="n">h_imsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">imsize</span><span class="p">(</span>
                                        <span class="n">fields</span><span class="o">=</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">cell</span><span class="o">=</span><span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span>
                                        <span class="n">primary_beam</span><span class="o">=</span><span class="n">largest_primary_beams</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span>
                                        <span class="n">sfpblimit</span><span class="o">=</span><span class="n">sfpblimit</span><span class="p">,</span> <span class="n">centreonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                        <span class="n">vislist</span><span class="o">=</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">],</span>
                                        <span class="n">spwspec</span><span class="o">=</span><span class="n">imsize_spwlist</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                        <span class="n">joint_intents</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span> <span class="n">specmode</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                                            <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;FLUX&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">,</span>
                                            <span class="p">]:</span>
                                        <span class="n">h_imsize</span> <span class="o">=</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">calmaxpix</span><span class="p">)</span> <span class="k">for</span> <span class="n">npix</span> <span class="ow">in</span> <span class="n">h_imsize</span><span class="p">]</span>
                                    <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> <span class="n">h_imsize</span>
                                    <span class="k">if</span> <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_x_size</span><span class="p">:</span>
                                        <span class="n">max_x_size</span> <span class="o">=</span> <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_y_size</span><span class="p">:</span>
                                        <span class="n">max_y_size</span> <span class="o">=</span> <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="c1"># problem defining imsize</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                    <span class="k">pass</span>

                            <span class="k">if</span> <span class="n">max_x_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">max_y_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;imsize of [</span><span class="si">{:d}</span><span class="s1">, </span><span class="si">{:d}</span><span class="s1">] for field </span><span class="si">{!s}</span><span class="s1"> intent </span><span class="si">{!s}</span><span class="s1"> spw </span><span class="si">{!s}</span><span class="s1"> is degenerate.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_x_size</span><span class="p">,</span> <span class="n">max_y_size</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">min_freq_spwlist</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># Need to populate all spw keys because the imsize for the cont</span>
                                <span class="c1"># target is taken from this dictionary.</span>
                                <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">all_spw_keys</span><span class="p">:</span>
                                    <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_x_size</span><span class="p">,</span> <span class="n">max_y_size</span><span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">all_spw_keys</span><span class="p">:</span>
                                <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> <span class="n">imsize</span>

                    <span class="c1"># if nchan is not set then use heuristic code to calculate it</span>
                    <span class="c1"># for each field/spwspec. The channel width needs to be calculated</span>
                    <span class="c1"># at the same time.</span>
                    <span class="n">specmode</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span>
                    <span class="n">nchan</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nchan</span>
                    <span class="n">nchans</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">width</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">width</span>
                    <span class="n">widths</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="n">specmode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">width</span> <span class="o">==</span> <span class="s1">&#39;pilotimage&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">filtered_spwlist_local</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">nchans</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)],</span> <span class="n">widths</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> \
                                      <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">nchan_and_width</span><span class="p">(</span><span class="n">field_intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">spwspec</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                    <span class="c1"># problem defining nchan and width</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                                    <span class="k">pass</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">field_intent_list</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">all_spw_keys</span><span class="p">:</span>
                                <span class="n">nchans</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> <span class="n">nchan</span>
                                <span class="n">widths</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)]</span> <span class="o">=</span> <span class="n">width</span>

                    <span class="n">usepointing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">usepointing</span><span class="p">()</span>

                    <span class="c1"># now construct the list of imaging command parameter lists that must</span>
                    <span class="c1"># be run to obtain the required images</span>

                    <span class="c1"># Remember if there are targets for this vislist</span>
                    <span class="n">have_targets</span><span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vislist</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

                    <span class="c1"># Sort field/intent list alphabetically considering the intent as the first</span>
                    <span class="c1"># and the source name as the second key.</span>
                    <span class="n">sorted_field_intent_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">field_intent_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>

                    <span class="c1"># In case of TARGET intent place representative source first in the list.</span>
                    <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">:</span>
                        <span class="n">sorted_field_intent_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">place_repr_source_first</span><span class="p">(</span><span class="n">sorted_field_intent_list</span><span class="p">,</span> <span class="n">repr_source</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">field_intent</span> <span class="ow">in</span> <span class="n">sorted_field_intent_list</span><span class="p">:</span>
                        <span class="n">mosweight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">mosweight</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">spwspec</span> <span class="ow">in</span> <span class="n">filtered_spwlist_local</span><span class="p">:</span>
                            <span class="c1"># Start with original vis list</span>
                            <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span>

                            <span class="c1"># The field/intent and spwspec loops still cover the full parameter</span>
                            <span class="c1"># space. Here we filter the actual combinations.</span>
                            <span class="n">valid_field_spwspec_combination</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">actual_spwids</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;spwids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_intent</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                                        <span class="k">if</span> <span class="n">valid_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">vislist</span><span class="p">)][</span><span class="n">field_intent</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spwid</span><span class="p">),</span> <span class="kc">None</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span> <span class="ow">in</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;spwids&#39;</span><span class="p">]:</span>
                                                <span class="n">valid_field_spwspec_combination</span> <span class="o">=</span> <span class="kc">True</span>
                                                <span class="n">actual_spwids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_field_spwspec_combination</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="c1"># For &#39;cont&#39; mode we still need to restrict the virtual spw ID list to just</span>
                            <span class="c1"># the ones that were actually observed for this field.</span>
                            <span class="n">adjusted_spwspec</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">actual_spwids</span><span class="p">))</span>

                            <span class="n">spwspec_ok</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">actual_spwspec_list</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">spwsel</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">all_continuum</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">low_bandwidth</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">low_spread</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">cont_ranges_spwsel_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">all_continuum_spwsel_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">low_bandwidth_spwsel_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">low_spread_spwsel_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">spwsel_spwid_dict</span> <span class="o">=</span> <span class="p">{}</span>

                            <span class="c1"># Check if the globally selected data type is available for this field/spw combination.</span>
                            <span class="k">if</span> <span class="n">selected_datatype_str</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">datacolumn</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">automatic_datatype_choice</span><span class="p">:</span>
                                    <span class="c1"># In automatic mode check for source/spw specific fall back to next available data type.</span>
                                    <span class="p">(</span><span class="n">local_ms_objects_and_columns</span><span class="p">,</span> <span class="n">local_selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="n">specmode_datatypes</span><span class="p">,</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spw</span><span class="o">=</span><span class="n">adjusted_spwspec</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vislist</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># In manual mode check determine the data column for the current data type.</span>
                                    <span class="p">(</span><span class="n">local_ms_objects_and_columns</span><span class="p">,</span> <span class="n">local_selected_datatype</span><span class="p">)</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_measurement_sets_of_type</span><span class="p">(</span><span class="n">dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">DataType</span><span class="p">[</span><span class="n">selected_datatype_str</span><span class="p">]],</span> <span class="n">msonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spw</span><span class="o">=</span><span class="n">adjusted_spwspec</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">vislist</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">local_selected_datatype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">expected_num_targets</span> <span class="o">-=</span> <span class="mi">1</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data type </span><span class="si">{</span><span class="n">selected_datatype_str</span><span class="si">}</span><span class="s1"> is not available for field </span><span class="si">{</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> SPW </span><span class="si">{</span><span class="n">adjusted_spwspec</span><span class="si">}</span><span class="s1"> in the chosen vis list. Skipping imaging target.&#39;</span><span class="p">)</span>
                                    <span class="k">continue</span>

                                <span class="n">local_selected_datatype_str</span> <span class="o">=</span> <span class="n">local_selected_datatype</span><span class="o">.</span><span class="n">name</span>
                                <span class="n">local_selected_datatype_info</span> <span class="o">=</span> <span class="n">local_selected_datatype_str</span>
                                <span class="n">local_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">local_ms_objects_and_columns</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

                                <span class="k">if</span> <span class="n">local_selected_datatype_str</span> <span class="o">!=</span> <span class="n">selected_datatype_str</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">automatic_datatype_choice</span><span class="p">:</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data type </span><span class="si">{</span><span class="n">selected_datatype_str</span><span class="si">}</span><span class="s1"> is not available for field </span><span class="si">{</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> SPW </span><span class="si">{</span><span class="n">adjusted_spwspec</span><span class="si">}</span><span class="s1">. Falling back to data type </span><span class="si">{</span><span class="n">local_selected_datatype_str</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                                        <span class="n">local_selected_datatype_info</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">local_selected_datatype_str</span><span class="si">}</span><span class="s1"> instead of </span><span class="si">{</span><span class="n">selected_datatype_str</span><span class="si">}</span><span class="s1"> due to source/spw selection&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># Manually selected data type unavailable -&gt; skip making an imaging target</span>
                                        <span class="n">expected_num_targets</span> <span class="o">-=</span> <span class="mi">1</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data type </span><span class="si">{</span><span class="n">selected_datatype_str</span><span class="si">}</span><span class="s1"> is not available for field </span><span class="si">{</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> SPW </span><span class="si">{</span><span class="n">adjusted_spwspec</span><span class="si">}</span><span class="s1"> in the chosen vis list. Skipping imaging target.&#39;</span><span class="p">)</span>
                                        <span class="k">continue</span>

                                <span class="k">if</span> <span class="n">local_columns</span> <span class="o">!=</span> <span class="p">[]:</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">local_column</span> <span class="o">==</span> <span class="n">local_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">local_column</span> <span class="ow">in</span> <span class="n">local_columns</span><span class="p">):</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data type based column selection changes among MSes: </span><span class="si">{</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">local_ms_objects_and_columns</span><span class="o">.</span><span class="n">items</span><span class="p">())</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">local_columns</span> <span class="o">!=</span> <span class="p">[]:</span>
                                    <span class="k">if</span> <span class="n">local_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DATA&#39;</span><span class="p">:</span>
                                        <span class="n">local_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
                                    <span class="k">elif</span> <span class="n">local_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">:</span>
                                        <span class="n">local_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;corrected&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Unknown column name </span><span class="si">{</span><span class="n">local_columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                        <span class="n">local_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Empty list of columns&#39;</span><span class="p">)</span>
                                    <span class="n">local_datacolumn</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

                                <span class="n">datacolumn</span> <span class="o">=</span> <span class="n">local_datacolumn</span>

                                <span class="k">if</span> <span class="ow">not</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span> <span class="ow">and</span> <span class="n">original_vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">local_ms_objects_and_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]:</span>
                                    <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">local_ms_objects_and_columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
                                    <span class="k">if</span> <span class="n">automatic_datatype_choice</span> <span class="ow">and</span> <span class="n">local_selected_datatype_str</span> <span class="o">!=</span> <span class="n">selected_datatype_str</span><span class="p">:</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;Modifying vis list from </span><span class="si">{</span><span class="n">original_vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> for fallback data type </span><span class="si">{</span><span class="n">local_selected_datatype_str</span><span class="si">}</span><span class="s1">.&#39;&#39;&#39;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;Modifying vis list from </span><span class="si">{</span><span class="n">original_vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="si">}</span><span class="s1"> for data type </span><span class="si">{</span><span class="n">local_selected_datatype_str</span><span class="si">}</span><span class="s1">.&#39;&#39;&#39;</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Empty vis list for field </span><span class="si">{</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> specmode </span><span class="si">{</span><span class="n">specmode</span><span class="si">}</span><span class="s1"> data type </span><span class="si">{</span><span class="n">local_selected_datatype_str</span><span class="si">}</span><span class="s1">. Skipping imaging target.&#39;</span><span class="p">)</span>
                                        <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">datacolumn</span> <span class="o">=</span> <span class="n">global_datacolumn</span>
                                <span class="n">local_selected_datatype</span> <span class="o">=</span> <span class="n">global_datatype</span>
                                <span class="n">local_selected_datatype_str</span> <span class="o">=</span> <span class="n">global_datatype_str</span>
                                <span class="n">local_selected_datatype_info</span> <span class="o">=</span> <span class="n">global_datatype_info</span>

                            <span class="c1"># PIPE-1710: add a suffix to image file name depending on datatype</span>
                            <span class="k">if</span> <span class="n">local_selected_datatype_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;regcal&#39;</span><span class="p">):</span>
                                <span class="n">datatype_suffix</span> <span class="o">=</span> <span class="s1">&#39;regcal&#39;</span>
                            <span class="k">elif</span> <span class="n">local_selected_datatype_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;selfcal&#39;</span><span class="p">):</span>
                                <span class="n">datatype_suffix</span> <span class="o">=</span> <span class="s1">&#39;selfcal&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">datatype_suffix</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># Save the specific vislist in a copy of the heuristics object tailored to the</span>
                            <span class="c1"># current imaging target</span>
                            <span class="n">target_heuristics</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="p">)</span>
                            <span class="n">target_heuristics</span><span class="o">.</span><span class="n">vislist</span> <span class="o">=</span> <span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span>

                            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">adjusted_spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                                <span class="n">cont_ranges_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">all_continuum_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">low_bandwidth_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">],</span> <span class="n">low_spread_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">cont_ranges_spwsel</span><span class="p">()</span>
                                <span class="n">spwsel_spwid_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">cont_ranges_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">)</span>

                            <span class="n">no_cont_ranges</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">and</span> <span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">and</span>
                                    <span class="nb">all</span><span class="p">([</span><span class="n">v</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">spwsel_spwid_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])):</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No valid continuum ranges were found for any spw. Creating an aggregate continuum&#39;</span>
                                            <span class="s1">&#39; image from the full bandwidth from all spws, but this should be used with&#39;</span>
                                            <span class="s1">&#39; caution.&#39;</span><span class="p">)</span>
                                <span class="n">no_cont_ranges</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">adjusted_spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                                <span class="n">spwsel_spwid</span> <span class="o">=</span> <span class="n">spwsel_spwid_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">imaging_mode</span> <span class="ow">and</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">and</span> <span class="n">specmode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;mfs&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">no_cont_ranges</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">spwsel_spwid</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                                            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Spw </span><span class="si">{!s}</span><span class="s1"> will not be used in creating the aggregate continuum image&#39;</span>
                                                        <span class="s1">&#39; of </span><span class="si">{!s}</span><span class="s1"> because no continuum range was found.&#39;</span>
                                                        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Spw </span><span class="si">{!s}</span><span class="s1"> will not be used for </span><span class="si">{!s}</span><span class="s1"> because no continuum range was&#39;</span>
                                                        <span class="s1">&#39; found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                            <span class="n">spwspec_ok</span> <span class="o">=</span> <span class="kc">False</span>
                                        <span class="k">continue</span>
                                    <span class="c1">#elif (spwsel_spwid == &#39;&#39;):</span>
                                    <span class="c1">#    LOG.warning(&#39;Empty continuum frequency range for %s, spw %s. Run hif_findcont ?&#39; % (field_intent[0], spwid))</span>

                                <span class="n">all_continuum</span> <span class="o">=</span> <span class="n">all_continuum</span> <span class="ow">and</span> <span class="n">all_continuum_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">low_bandwidth</span> <span class="o">=</span> <span class="n">low_bandwidth</span> <span class="ow">and</span> <span class="n">low_bandwidth_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                                <span class="n">low_spread</span> <span class="o">=</span> <span class="n">low_spread</span> <span class="ow">and</span> <span class="n">low_spread_spwsel_dict</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">spwsel_spwid</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALLCONT&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">):</span>
                                    <span class="n">spwsel_spwid_freqs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                                    <span class="k">if</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">is_eph_obj</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                        <span class="n">spwsel_spwid_refer</span> <span class="o">=</span> <span class="s1">&#39;SOURCE&#39;</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">spwsel_spwid_refer</span> <span class="o">=</span> <span class="s1">&#39;LSRK&#39;</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">spwsel_spwid_freqs</span><span class="p">,</span> <span class="n">spwsel_spwid_refer</span> <span class="o">=</span> <span class="n">spwsel_spwid</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                                <span class="k">if</span> <span class="n">spwsel_spwid_refer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">):</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Frequency selection is specified in </span><span class="si">%s</span><span class="s1"> but must be in LSRK or SOURCE&#39;</span>
                                                <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="n">spwsel_spwid_refer</span><span class="p">)</span>
                                    <span class="c1"># TODO: skip this field and/or spw ?</span>

                                <span class="n">actual_spwspec_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwid</span><span class="p">)</span>
                                <span class="n">spwsel</span><span class="p">[</span><span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">spwid</span><span class="p">)]</span> <span class="o">=</span> <span class="n">spwsel_spwid</span>

                            <span class="n">actual_spwspec</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">actual_spwspec_list</span><span class="p">)</span>

                            <span class="n">num_all_spws</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adjusted_spwspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                            <span class="n">num_good_spws</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">no_cont_ranges</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">actual_spwspec_list</span><span class="p">)</span>

                            <span class="c1"># construct imagename</span>
                            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="n">imagename</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">imagename</span><span class="p">(</span><span class="n">output_dir</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                        <span class="n">field</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">actual_spwspec</span><span class="p">,</span>
                                                                        <span class="n">specmode</span><span class="o">=</span><span class="n">specmode</span><span class="p">,</span> <span class="n">band</span><span class="o">=</span><span class="n">band</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">datatype_suffix</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">imagename</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">imagename</span>

                            <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nbins</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">!=</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                                <span class="n">nbin_items</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">nbins</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="n">nbins_dict</span> <span class="o">=</span> <span class="p">{}</span>
                                <span class="k">for</span> <span class="n">nbin_item</span> <span class="ow">in</span> <span class="n">nbin_items</span><span class="p">:</span>
                                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">nbin_item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                                    <span class="n">nbins_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">nbins_dict</span><span class="p">:</span>
                                        <span class="n">nbin</span> <span class="o">=</span> <span class="n">nbins_dict</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">nbin</span> <span class="o">=</span> <span class="n">nbins_dict</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not determine binning factor for spw </span><span class="si">%s</span><span class="s1">. Using default channel width.&#39;</span>
                                                <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="n">adjusted_spwspec</span><span class="p">)</span>
                                    <span class="n">nbin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">nbin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                            <span class="c1"># Get stokes value. Note that the full list of intents</span>
                            <span class="c1"># (inputs.intent) is used to decide whether to do IQUV</span>
                            <span class="c1"># for ALMA as PIPE-1829 asked for Stokes I only if other</span>
                            <span class="c1"># calibration intents are done together with POLARIZATION.</span>
                            <span class="n">stokes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">stokes</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">spwspec_ok</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)</span> <span class="ow">in</span> <span class="n">imsizes</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;invalid&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">]):</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                  <span class="s1">&#39;field:</span><span class="si">%s</span><span class="s1"> intent:</span><span class="si">%s</span><span class="s1"> spw:</span><span class="si">%s</span><span class="s1"> cell:</span><span class="si">%s</span><span class="s1"> imsize:</span><span class="si">%s</span><span class="s1"> phasecenter:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">adjusted_spwspec</span><span class="p">,</span>
                                   <span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span> <span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)],</span>
                                   <span class="n">phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

                                <span class="c1"># Remove MSs that do not contain data for the given field/intent combination</span>
                                <span class="c1"># FIXME: This should already have been filtered above. This filter is just from the domain objects.</span>
                                <span class="n">scanidlist</span><span class="p">,</span> <span class="n">visindexlist</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">get_scanidlist</span><span class="p">(</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">],</span>
                                                                                            <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="n">domain_filtered_vislist</span> <span class="o">=</span> <span class="p">[</span><span class="n">vislist_field_intent_spw_combinations</span><span class="p">[</span><span class="n">field_intent</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">visindexlist</span><span class="p">]</span>
                                <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
                                    <span class="n">filtered_vislist</span> <span class="o">=</span> <span class="n">domain_filtered_vislist</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># Filter MSs with fully flagged field/spw selections</span>
                                    <span class="n">filtered_vislist</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">domain_filtered_vislist</span> <span class="k">if</span> <span class="n">valid_data</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="n">field_intent</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">adjusted_spwspec</span><span class="p">)]]</span>

                                <span class="c1"># Save the filtered vislist</span>
                                <span class="k">if</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">vislist</span> <span class="o">!=</span> <span class="n">filtered_vislist</span><span class="p">:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;Modifying vis list from </span><span class="si">{</span><span class="n">target_heuristics</span><span class="o">.</span><span class="n">vislist</span><span class="si">}</span><span class="s1"> to </span><span class="si">{</span><span class="n">filtered_vislist</span><span class="si">}</span><span class="s1">&#39;&#39;&#39;</span><span class="p">)</span>
                                    <span class="n">target_heuristics</span><span class="o">.</span><span class="n">vislist</span> <span class="o">=</span> <span class="n">filtered_vislist</span>

                                <span class="c1"># Get list of antenna IDs</span>
                                <span class="n">antenna_ids</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">antenna_ids</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">)</span>
                                <span class="c1"># PIPE-964: The &#39;&amp;&#39; at the end of the antenna input was added to not to consider the cross</span>
                                <span class="c1">#  baselines by default. The cross baselines with antennas not listed (for TARGET images</span>
                                <span class="c1">#  the antennas with the minority antenna sizes are not listed) could be added in some</span>
                                <span class="c1">#  future configurations by removing this character.</span>
                                <span class="n">antenna</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">antenna_ids</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span><span class="o">+</span><span class="s1">&#39;&amp;&#39;</span>
                                           <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filtered_vislist</span><span class="p">]</span>

                                <span class="n">drcorrect</span><span class="p">,</span> <span class="n">maxthreshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_drcorrect_maxthreshold</span><span class="p">(</span>
                                    <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">actual_spwspec</span><span class="p">,</span> <span class="n">local_selected_datatype_str</span><span class="p">)</span>
                                <span class="n">target_heuristics</span><span class="o">.</span><span class="n">imaging_params</span><span class="p">[</span><span class="s1">&#39;maxthreshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxthreshold</span>

                                <span class="n">deconvolver</span><span class="p">,</span> <span class="n">nterms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_deconvolver_nterms</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                                                   <span class="n">actual_spwspec</span><span class="p">,</span> <span class="n">stokes</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                                                                   <span class="n">local_selected_datatype_str</span><span class="p">,</span> <span class="n">target_heuristics</span><span class="p">)</span>

                                <span class="n">reffreq</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">reffreq</span><span class="p">(</span><span class="n">deconvolver</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span> <span class="n">spwsel</span><span class="p">)</span>
                                <span class="n">gridder</span> <span class="o">=</span> <span class="n">target_heuristics</span><span class="o">.</span><span class="n">gridder</span><span class="p">(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">actual_spwspec</span><span class="p">)</span>

                                <span class="c1"># Get field-specific uvrange value</span>
                                <span class="n">uvrange</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">uvrange</span> <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">uvrange</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                                <span class="n">bl_ratio</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">if</span> <span class="n">uvrange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="n">uvrange</span><span class="p">,</span> <span class="n">bl_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">heuristics</span><span class="o">.</span><span class="n">uvrange</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="o">=</span><span class="n">actual_spwspec</span><span class="p">)</span>
                                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                                        <span class="c1"># After PIPE-2266, an exception is unlikely to occur because a null-selection condition has been excluded.</span>
                                        <span class="c1"># Nevertheless, we retain this exception handler as an extra precaution.</span>
                                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Error calculating the heuristics uvrange value for field </span><span class="si">%s</span><span class="s2"> spw </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                                                    <span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">actual_spwspec</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
                                              
                                <span class="n">target</span> <span class="o">=</span> <span class="n">CleanTarget</span><span class="p">(</span>
                                    <span class="n">antenna</span><span class="o">=</span><span class="n">antenna</span><span class="p">,</span>
                                    <span class="n">field</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                    <span class="n">intent</span><span class="o">=</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">spw</span><span class="o">=</span><span class="n">actual_spwspec</span><span class="p">,</span>
                                    <span class="n">spwsel_lsrk</span><span class="o">=</span><span class="n">spwsel</span><span class="p">,</span>
                                    <span class="n">spwsel_all_cont</span><span class="o">=</span><span class="n">all_continuum</span><span class="p">,</span>
                                    <span class="n">spwsel_low_bandwidth</span><span class="o">=</span><span class="n">low_bandwidth</span><span class="p">,</span>
                                    <span class="n">spwsel_low_spread</span><span class="o">=</span><span class="n">low_spread</span><span class="p">,</span>
                                    <span class="n">num_all_spws</span><span class="o">=</span><span class="n">num_all_spws</span><span class="p">,</span>
                                    <span class="n">num_good_spws</span><span class="o">=</span><span class="n">num_good_spws</span><span class="p">,</span>
                                    <span class="n">cell</span><span class="o">=</span><span class="n">cells</span><span class="p">[</span><span class="n">spwspec</span><span class="p">],</span>
                                    <span class="n">imsize</span><span class="o">=</span><span class="n">imsizes</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)],</span>
                                    <span class="n">phasecenter</span><span class="o">=</span><span class="n">phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                    <span class="n">psf_phasecenter</span><span class="o">=</span><span class="n">psf_phasecenters</span><span class="p">[</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                    <span class="n">specmode</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">,</span>
                                    <span class="n">gridder</span><span class="o">=</span><span class="n">gridder</span><span class="p">,</span>
                                    <span class="n">imagename</span><span class="o">=</span><span class="n">imagename</span><span class="p">,</span>
                                    <span class="n">start</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                    <span class="n">width</span><span class="o">=</span><span class="n">widths</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)],</span>
                                    <span class="n">nbin</span><span class="o">=</span><span class="n">nbin</span><span class="p">,</span>
                                    <span class="n">nchan</span><span class="o">=</span><span class="n">nchans</span><span class="p">[(</span><span class="n">field_intent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">spwspec</span><span class="p">)],</span>
                                    <span class="n">robust</span><span class="o">=</span><span class="n">robust</span><span class="p">,</span>
                                    <span class="n">uvrange</span><span class="o">=</span><span class="n">uvrange</span><span class="p">,</span>
                                    <span class="n">bl_ratio</span><span class="o">=</span><span class="n">bl_ratio</span><span class="p">,</span>
                                    <span class="n">uvtaper</span><span class="o">=</span><span class="n">uvtaper</span><span class="p">,</span>
                                    <span class="n">stokes</span><span class="o">=</span><span class="n">stokes</span><span class="p">,</span>
                                    <span class="n">heuristics</span><span class="o">=</span><span class="n">target_heuristics</span><span class="p">,</span>
                                    <span class="n">vis</span><span class="o">=</span><span class="n">filtered_vislist</span><span class="p">,</span>
                                    <span class="n">datacolumn</span><span class="o">=</span><span class="n">datacolumn</span><span class="p">,</span>
                                    <span class="n">datatype</span><span class="o">=</span><span class="n">local_selected_datatype_str</span><span class="p">,</span>
                                    <span class="n">datatype_info</span><span class="o">=</span><span class="n">local_selected_datatype_info</span><span class="p">,</span>
                                    <span class="n">is_per_eb</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span> <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                                    <span class="n">usepointing</span><span class="o">=</span><span class="n">usepointing</span><span class="p">,</span>
                                    <span class="n">mosweight</span><span class="o">=</span><span class="n">mosweight</span><span class="p">,</span>
                                    <span class="n">drcorrect</span><span class="o">=</span><span class="n">drcorrect</span><span class="p">,</span>
                                    <span class="n">deconvolver</span><span class="o">=</span><span class="n">deconvolver</span><span class="p">,</span>
                                    <span class="n">nterms</span><span class="o">=</span><span class="n">nterms</span><span class="p">,</span>
                                    <span class="n">reffreq</span><span class="o">=</span><span class="n">reffreq</span><span class="p">)</span>

                                <span class="n">result</span><span class="o">.</span><span class="n">add_target</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">and</span> <span class="n">result</span><span class="o">.</span><span class="n">num_targets</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">clean_list_info</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found. No imaging targets were created.&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span><span class="p">,</span>
                             <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">have_targets</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
                <span class="n">info_msg</span> <span class="o">=</span> <span class="s1">&#39;No check source found.&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">info_msg</span><span class="p">,</span> <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">inputs</span><span class="o">.</span><span class="n">per_eb</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">have_targets</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                <span class="n">info_msg</span> <span class="o">=</span> <span class="s1">&#39;No check source data found in EBs </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                                                                                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">have_targets</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                                                                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="p">]))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">info_msg</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">set_info</span><span class="p">({</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="n">info_msg</span><span class="p">,</span> <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span><span class="p">})</span>

        <span class="c1"># Record total number of expected clean targets</span>
        <span class="n">result</span><span class="o">.</span><span class="n">set_expected_num_targets</span><span class="p">(</span><span class="n">expected_num_targets</span><span class="p">)</span>

        <span class="c1"># Pass contfile and linefile names to context (via resultobjects)</span>
        <span class="c1"># for hif_findcont and hif_makeimages</span>
        <span class="n">result</span><span class="o">.</span><span class="n">contfile</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">contfile</span>
        <span class="n">result</span><span class="o">.</span><span class="n">linesfile</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">linesfile</span>

        <span class="n">result</span><span class="o">.</span><span class="n">synthesized_beams</span> <span class="o">=</span> <span class="n">known_synthesized_beams</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="MakeImList.analyse">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.hif.tasks.makeimlist.html#pipeline.hif.tasks.makeimlist.makeimlist.MakeImList.analyse">[docs]</a>
    <span class="k">def</span> <span class="nf">analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_get_deconvolver_nterms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">stokes</span><span class="p">,</span> <span class="n">specmode</span><span class="p">,</span> <span class="n">datatype_str</span><span class="p">,</span> <span class="n">image_heuristics</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get deconvolver and nterms. First check for any modified parameters based</span>
<span class="sd">        on existing selfcal results. Otherwise use the heuristics methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">deconvolver</span><span class="p">,</span> <span class="n">nterms</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;selfcal_targets&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">datatype_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SELFCAL_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sc_target</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">selfcal_targets</span><span class="p">:</span>
                <span class="n">sc_spw</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">im_spw</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">im_spw</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">sc_spw</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;sc_success&#39;</span><span class="p">]:</span>
                    <span class="n">nterms_sc</span> <span class="o">=</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;sc_lib&#39;</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nterms_sc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nterms_sc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">nterms</span> <span class="o">=</span> <span class="n">nterms_sc</span>
                        <span class="n">deconvolver</span> <span class="o">=</span> <span class="s1">&#39;mtmfs&#39;</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using deconvolver=&#39;mtmfs&#39;, nterms=</span><span class="si">{</span><span class="n">nterms</span><span class="si">}</span><span class="s2"> for field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> and spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> based &quot;</span>
                                 <span class="s2">&quot;on previous selfcal aggregate continuum imaging results.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">deconvolver</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nterms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deconvolver</span> <span class="o">=</span> <span class="n">image_heuristics</span><span class="o">.</span><span class="n">deconvolver</span><span class="p">(</span><span class="n">specmode</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">stokes</span><span class="p">)</span>
            <span class="n">nterms</span> <span class="o">=</span> <span class="n">image_heuristics</span><span class="o">.</span><span class="n">nterms</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deconvolver</span><span class="p">,</span> <span class="n">nterms</span>

    <span class="k">def</span> <span class="nf">_get_drcorrect_maxthreshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">datatype_str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the modified drcorrect parameter based on existing selfcal results.&quot;&quot;&quot;</span>

        <span class="n">drcorrect</span> <span class="o">=</span> <span class="n">maxthreshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;JVLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">drcorrect</span><span class="p">,</span> <span class="n">maxthreshold</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s1">&#39;selfcal_targets&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">datatype_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;SELFCAL_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">sc_target</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">selfcal_targets</span><span class="p">:</span>
                <span class="n">sc_spw</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="n">im_spw</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">im_spw</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">sc_spw</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;sc_success&#39;</span><span class="p">]:</span>

                    <span class="c1"># PIPE-1452: use previous succesfully selfcal results to modify DR correction values</span>
                    <span class="n">drcorrect</span> <span class="o">=</span> <span class="n">sc_target</span><span class="p">[</span><span class="s1">&#39;sc_rms_scale&#39;</span><span class="p">]</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using drcorrect=</span><span class="si">{</span><span class="n">drcorrect</span><span class="si">}</span><span class="s2"> for field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> and spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> based &quot;</span>
                             <span class="s2">&quot;on previous selfcal aggregate continuum imaging results.&quot;</span><span class="p">)</span>

                    <span class="c1"># PIPE-2117: use previous regcal reuslts to set the cleaning threshold upper limit</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">MakeImagesResult</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">tclean_result</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">tclean_result</span><span class="o">.</span><span class="n">datatype_info</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;REGCAL_CONTLINE&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                                        <span class="n">tclean_result</span><span class="o">.</span><span class="n">specmode</span> <span class="o">==</span> <span class="s1">&#39;cont&#39;</span> <span class="ow">and</span> \
                                        <span class="n">tclean_result</span><span class="o">.</span><span class="n">sourcename</span> <span class="o">==</span> <span class="n">field</span> <span class="ow">and</span> \
                                        <span class="n">im_spw</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tclean_result</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))):</span>
                                    <span class="n">maxthreshold</span> <span class="o">=</span> <span class="n">tclean_result</span><span class="o">.</span><span class="n">threshold</span>
                    <span class="k">if</span> <span class="n">maxthreshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Define an imaging threshold upper limit of </span><span class="si">{</span><span class="n">maxthreshold</span><span class="si">}</span><span class="s2"> for self-calibrated field </span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2"> and spw </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;based on previous regular aggregate continuum imaging results.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="k">return</span> <span class="n">drcorrect</span><span class="p">,</span> <span class="n">maxthreshold</span></div>



<span class="c1"># maps intent and specmode Inputs parameters to textual description of execution context.</span>
<span class="n">_DESCRIPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;phase calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;phase calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;bandpass calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;bandpass calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;flux calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;flux calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;polarization calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;diffgain calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;diffgain calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;diffgain calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;diffgain calibrator&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;check source&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;check source&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;target per-spw continuum&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;target aggregate continuum&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;cube&#39;</span><span class="p">):</span> <span class="s1">&#39;target cube&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;repBW&#39;</span><span class="p">):</span> <span class="s1">&#39;representative bandwidth target cube&#39;</span>
<span class="p">}</span>

<span class="n">_SIDEBAR_SUFFIX</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">(</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cals&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;pol&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;checksrc&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;checksrc&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;mfs&#39;</span><span class="p">):</span> <span class="s1">&#39;mfs&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;cont&#39;</span><span class="p">):</span> <span class="s1">&#39;cont&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;cube&#39;</span><span class="p">):</span> <span class="s1">&#39;cube&#39;</span><span class="p">,</span>
    <span class="p">(</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;repBW&#39;</span><span class="p">):</span> <span class="s1">&#39;cube_repBW&#39;</span>
<span class="p">}</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>