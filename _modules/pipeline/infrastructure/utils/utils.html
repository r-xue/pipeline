

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.infrastructure.utils.utils &mdash; Pipeline 
 (2025.1.1.56) 2025.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom_theme.css?v=047bd54c" />

  
    <link rel="shortcut icon" href="../../../../_static/favicon-16x16.png"/>
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=e72a64b0"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../../_static/copybutton.js?v=0729d509"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.2.0/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.12.1/dist/mermaid.esm.min.mjs";

const defaultStyle = document.createElement('style');
defaultStyle.textContent = `pre.mermaid {
    /* Same as .mermaid-container > pre */
    display: block;
    width: 100%;
}

pre.mermaid > svg {
    /* Same as .mermaid-container > pre > svg */
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}
`;
document.head.appendChild(defaultStyle);

const fullscreenStyle = document.createElement('style');
fullscreenStyle.textContent = `.mermaid-container {
    display: flex;
    flex-direction: row;
    width: 100%;
}

.mermaid-container > pre {
    display: block;
    width: 100%;
}

.mermaid-container > pre > svg {
    height: 500px;
    width: 100%;
    max-width: 100% !important;
}

.mermaid-fullscreen-btn {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    font-size: 14px;
    line-height: 1;
    padding: 0;
    color: #333;
}

.mermaid-fullscreen-btn:hover {
    opacity: 100% !important;
    background: rgba(255, 255, 255, 1);
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transform: scale(1.1);
}

.mermaid-fullscreen-btn.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: #e0e0e0;
}

.mermaid-fullscreen-btn.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 3px 10px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 95vw;
    height: 100vh;
    background: rgba(255, 255, 255, 0.98);
    z-index: 9999;
    padding: 20px;
    overflow: auto;
}

.mermaid-fullscreen-modal.dark-theme {
    background: rgba(0, 0, 0, 0.98);
}

.mermaid-fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen {
    position: relative;
    width: 95vw;
    height: 90vh;
    max-width: 95vw;
    max-height: 90vh;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen.dark-theme {
    background: #1a1a1a;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
}

.mermaid-container-fullscreen pre.mermaid {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mermaid-container-fullscreen .mermaid svg {
    height: 100% !important;
    width: 100% !important;
    cursor: grab;
}

.mermaid-fullscreen-close {
    position: fixed !important;
    top: 20px !important;
    right: 20px !important;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 50%;
    cursor: pointer;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    font-size: 24px;
    line-height: 1;
    color: #333;
}

.mermaid-fullscreen-close:hover {
    background: white;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    transform: scale(1.1);
}

.mermaid-fullscreen-close.dark-theme {
    background: rgba(50, 50, 50, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #e0e0e0;
}

.mermaid-fullscreen-close.dark-theme:hover {
    background: rgba(60, 60, 60, 1);
    box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
}

.mermaid-fullscreen-modal .mermaid-fullscreen-btn {
    display: none !important;
}`;
document.head.appendChild(fullscreenStyle);

// Detect if page has dark background
const isDarkTheme = () => {
    const bgColor = window.getComputedStyle(document.body).backgroundColor;
    const match = bgColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)/);
    if (match) {
        const r = parseInt(match[1]);
        const g = parseInt(match[2]);
        const b = parseInt(match[3]);
        const brightness = (r * 299 + g * 587 + b * 114) / 1000;
        return brightness < 128;
    }
    return false;
};

const load = async () => {
    await mermaid.run();

    const all_mermaids = document.querySelectorAll(".mermaid");
    const mermaids_processed = document.querySelectorAll(".mermaid[data-processed='true']");

    if ("True" === "True") {
        const mermaids_to_add_zoom = -1 === -1 ? all_mermaids.length : -1;
        if(mermaids_to_add_zoom > 0) {
            var svgs = d3.selectAll(".mermaid svg");
            if(all_mermaids.length !== mermaids_processed.length) {
                setTimeout(load, 200);
                return;
            } else if(svgs.size() !== mermaids_to_add_zoom) {
                setTimeout(load, 200);
                return;
            } else {
                svgs.each(function() {
                    var svg = d3.select(this);
                    svg.html("<g class='wrapper'>" + svg.html() + "</g>");
                    var inner = svg.select("g");
                    var zoom = d3.zoom().on("zoom", function(event) {
                        inner.attr("transform", event.transform);
                    });
                    svg.call(zoom);
                });
            }
        }
    } else if(all_mermaids.length !== mermaids_processed.length) {
        // Wait for mermaid to process all diagrams
        setTimeout(load, 200);
        return;
    }

    const darkTheme = isDarkTheme();

    // Stop here if not adding fullscreen capability
    if ("True" !== "True") return;

    const modal = document.createElement('div');
    modal.className = 'mermaid-fullscreen-modal' + (darkTheme ? ' dark-theme' : '');
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');
    modal.setAttribute('aria-label', 'Fullscreen diagram viewer');
    modal.innerHTML = `
        <button class="mermaid-fullscreen-close${darkTheme ? ' dark-theme' : ''}" aria-label="Close fullscreen">✕</button>
        <div class="mermaid-container-fullscreen${darkTheme ? ' dark-theme' : ''}"></div>
    `;
    document.body.appendChild(modal);

    const modalContent = modal.querySelector('.mermaid-container-fullscreen');
    const closeBtn = modal.querySelector('.mermaid-fullscreen-close');

    let previousScrollOffset = [window.scrollX, window.scrollY];

    const closeModal = () => {
        modal.classList.remove('active');
        modalContent.innerHTML = '';
        document.body.style.overflow = ''
        window.scrollTo({left: previousScrollOffset[0], top: previousScrollOffset[1], behavior: 'instant'});
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeModal();
        }
    });

    const allButtons = [];

    document.querySelectorAll('.mermaid').forEach((mermaidDiv) => {
        if (mermaidDiv.parentNode.classList.contains('mermaid-container') ||
            mermaidDiv.closest('.mermaid-fullscreen-modal')) {
            return;
        }

        const container = document.createElement('div');
        container.className = 'mermaid-container';
        mermaidDiv.parentNode.insertBefore(container, mermaidDiv);
        container.appendChild(mermaidDiv);

        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.className = 'mermaid-fullscreen-btn' + (darkTheme ? ' dark-theme' : '');
        fullscreenBtn.setAttribute('aria-label', 'View diagram in fullscreen');
        fullscreenBtn.textContent = '⛶';
        fullscreenBtn.style.opacity = '50%';

        // Calculate dynamic position based on diagram's margin and padding
        const diagramStyle = window.getComputedStyle(mermaidDiv);
        const marginTop = parseFloat(diagramStyle.marginTop) || 0;
        const marginRight = parseFloat(diagramStyle.marginRight) || 0;
        const paddingTop = parseFloat(diagramStyle.paddingTop) || 0;
        const paddingRight = parseFloat(diagramStyle.paddingRight) || 0;
        fullscreenBtn.style.top = `${marginTop + paddingTop + 4}px`;
        fullscreenBtn.style.right = `${marginRight + paddingRight + 4}px`;

        fullscreenBtn.addEventListener('click', () => {
            previousScrollOffset = [window.scroll, window.scrollY];
            const clone = mermaidDiv.cloneNode(true);
            modalContent.innerHTML = '';
            modalContent.appendChild(clone);

            const svg = clone.querySelector('svg');
            if (svg) {
                svg.removeAttribute('width');
                svg.removeAttribute('height');
                svg.style.width = '100%';
                svg.style.height = 'auto';
                svg.style.maxWidth = '100%';
                svg.style.sdisplay = 'block';

                if ("True" === "True") {
                    setTimeout(() => {
                        const g = svg.querySelector('g');
                        if (g) {
                            var svgD3 = d3.select(svg);
                            svgD3.html("<g class='wrapper'>" + svgD3.html() + "</g>");
                            var inner = svgD3.select("g");
                            var zoom = d3.zoom().on("zoom", function(event) {
                                inner.attr("transform", event.transform);
                            });
                            svgD3.call(zoom);
                        }
                    }, 100);
                }
            }

            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        });

        container.appendChild(fullscreenBtn);
        allButtons.push(fullscreenBtn);
    });

    // Update theme classes when theme changes
    const updateTheme = () => {
        const dark = isDarkTheme();
        allButtons.forEach(btn => {
            if (dark) {
                btn.classList.add('dark-theme');
            } else {
                btn.classList.remove('dark-theme');
            }
        });
        if (dark) {
            modal.classList.add('dark-theme');
            modalContent.classList.add('dark-theme');
            closeBtn.classList.add('dark-theme');
        } else {
            modal.classList.remove('dark-theme');
            modalContent.classList.remove('dark-theme');
            closeBtn.classList.remove('dark-theme');
        }
    };

    // Watch for theme changes
    const observer = new MutationObserver(updateTheme);
    observer.observe(document.documentElement, {
        attributes: true,
        attributeFilter: ['class', 'style', 'data-theme']
    });
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['class', 'style']
    });
};

window.addEventListener("load", load);
</script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Pipeline 
 (2025.1.1.56)
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timeline.html">Roadmap &amp; Branching Strategy</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/context.html">Pipeline Context and Domain Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pipeline 
 (2025.1.1.56)</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.infrastructure.utils.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.infrastructure.utils.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;general-purpose uncategorised utility functions and classes.&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bisect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">collections</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">errno</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">fcntl</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">glob</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">string</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tarfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span>
                    <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">TextIO</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.typing</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..</span><span class="w"> </span><span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.conversion</span><span class="w"> </span><span class="kn">import</span> <span class="n">commafy</span><span class="p">,</span> <span class="n">dequote</span><span class="p">,</span> <span class="n">range_to_list</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">pipeline.domain</span><span class="w"> </span><span class="kn">import</span> <span class="n">MeasurementSet</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;absolute_path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;approx_equal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;are_equal&#39;</span><span class="p">,</span>
    <span class="s1">&#39;deduplicate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dict_merge&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ensure_products_dir_exists&#39;</span><span class="p">,</span>
    <span class="s1">&#39;export_weblog_as_tar&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fieldname_clean&#39;</span><span class="p">,</span>
    <span class="s1">&#39;fieldname_for_casa&#39;</span><span class="p">,</span>
    <span class="s1">&#39;filter_intents_for_ms&#39;</span><span class="p">,</span>
    <span class="s1">&#39;find_ranges&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flagged_intervals&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_casa_quantity&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_field_identifiers&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_obj_size&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_products_dir&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_receiver_type_for_spws&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_row_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_si_prefix&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_spectralspec_to_spwid_map&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_stokes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_task_result_count&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_taskhistory_fromimage&#39;</span><span class="p">,</span>
    <span class="s1">&#39;get_valid_url&#39;</span><span class="p">,</span>
    <span class="s1">&#39;glob_ordered&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ignore_pointing&#39;</span><span class="p">,</span>
    <span class="s1">&#39;imstat_items&#39;</span><span class="p">,</span>
    <span class="s1">&#39;list_to_str&#39;</span><span class="p">,</span>
    <span class="s1">&#39;nested_dict&#39;</span><span class="p">,</span>
    <span class="s1">&#39;open_with_lock&#39;</span><span class="p">,</span>
    <span class="s1">&#39;place_repr_source_first&#39;</span><span class="p">,</span>
    <span class="s1">&#39;relative_path&#39;</span><span class="p">,</span>
    <span class="s1">&#39;remove_trailing_string&#39;</span><span class="p">,</span>
    <span class="s1">&#39;string_to_val&#39;</span><span class="p">,</span>
    <span class="s1">&#39;validate_url&#39;</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">find_ranges</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify numeric ranges in string or list.</span>

<span class="sd">    This utility function takes a string or a list of integers (e.g. spectral</span>
<span class="sd">    window lists) and returns a string containing identified ranges.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; find_ranges([1,2,3])</span>
<span class="sd">    &#39;1~3&#39;</span>
<span class="sd">    &gt;&gt;&gt; find_ranges(&#39;1,2,3,5~12&#39;)</span>
<span class="sd">    &#39;1~3,5~12&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># barf if channel ranges are also in data, eg. 23:1~10,24</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">range_to_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">integers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">integers</span><span class="p">)</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">i_x</span><span class="p">:</span> <span class="n">i_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">i_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">g</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">~</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rng</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dict_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively merge dictionaries.</span>

<span class="sd">    This utility function recursively merges dictionaries. If second argument</span>
<span class="sd">    (b) is a dictionary, then a copy of first argument (dictionary a) is created</span>
<span class="sd">    and the elements of b are merged into the new dictionary. Otherwise return</span>
<span class="sd">    argument b.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; dict_merge({&#39;a&#39;: {&#39;b&#39;: 1}}, {&#39;c&#39;: 2})</span>
<span class="sd">    {&#39;a&#39;: {&#39;b&#39;: 1}, &#39;c&#39;: 2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span><span class="w"> </span><span class="nf">are_equal</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the contents of the given arrays are equal.</span>

<span class="sd">    This utility function check the equivalence of array like objects. Two arrays</span>
<span class="sd">    are equal if they have the same number of elements and elements of the same</span>
<span class="sd">    index are equal.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; are_equal([1, 2, 3], [1, 2, 3])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; are_equal([1, 2, 3], [1, 2, 3, 4])</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">approx_equal</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if two numbers are equal within the given tolerance.</span>

<span class="sd">    This utility function returns True if two numbers are equal within the</span>
<span class="sd">    given tolerance.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; approx_equal(1.0e-2, 1.2e-2, 1e-2)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; approx_equal(1.0e-2, 1.2e-2, 1e-3)</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">flagged_intervals</span><span class="p">(</span><span class="n">vec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Idendity isnads of ones in input array or list.</span>

<span class="sd">    This utility function finds islands of ones in array or list provided in argument.</span>
<span class="sd">    Used to find contiguous flagged channels in a given spw.  Returns a list of</span>
<span class="sd">    tuples with the start and end channels.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; flagged_intervals([0, 1, 0, 1, 1])</span>
<span class="sd">    [(1, 1), (3, 4)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="n">edges</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">((</span><span class="n">vec</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">edge_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">edges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edge_vec</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edge_vec</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)])</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">edge_vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fieldname_for_casa</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare field string to be used as CASA argument.</span>

<span class="sd">    This utility function ensures that field string can be used as CASA argument.</span>

<span class="sd">    If field contains special characters, then return field string enclose in</span>
<span class="sd">    quotation marks, otherwise return unchanged string.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; fieldname_for_casa(&#39;helm=30&#39;)</span>
<span class="sd">    &#39;&quot;helm=30&quot;&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">field</span> <span class="o">!=</span> <span class="n">fieldname_clean</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">field</span>


<span class="k">def</span><span class="w"> </span><span class="nf">fieldname_clean</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indicate if the fieldname is allowed as-is.</span>

<span class="sd">    This utility function replaces special characters in string with underscore.</span>
<span class="sd">    The return string is used in fieldname_for_casa() function to determine</span>
<span class="sd">    whether the field name, when given as a CASA argument, should be enclosed</span>
<span class="sd">    in quotes.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; fieldname_clean(&#39;helm=30&#39;)</span>
<span class="sd">    &#39;helm_30&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;+-&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allowed</span> <span class="k">else</span> <span class="s1">&#39;_&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">field</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">filter_intents_for_ms</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">,</span> <span class="n">intents</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter string of comma-separated intents to keep only those that are present</span>
<span class="sd">    in the given MS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">intents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">intents</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span>
    <span class="n">removed_intents</span> <span class="o">=</span> <span class="n">intents</span> <span class="o">-</span> <span class="n">ms</span><span class="o">.</span><span class="n">intents</span>
    <span class="k">if</span> <span class="n">removed_intents</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The following intents are not present in the MS </span><span class="si">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s2"> and will be skipped:&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">commafy</span><span class="p">(</span><span class="n">removed_intents</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">intents</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">intents</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_field_accessor</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns accessor to field name or field ID, if field name is ambiguous.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">accessor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">accessor</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_field_identifiers</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps numeric field IDs to field names.</span>

<span class="sd">    Get a dict of numeric field ID to unambiguous field identifier, using the</span>
<span class="sd">    field name where possible and falling back to numeric field ID where the</span>
<span class="sd">    name is duplicated, for instance in mosaic pointings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_name_accessors</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">get_field_accessor</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">field_name_accessors</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">](</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_receiver_type_for_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return dictionary of receiver types for requested spectral window IDs.</span>

<span class="sd">    If spwid is not found in MeasurementSet instance, then detector type is</span>
<span class="sd">    set to &quot;N/A&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        ms: MeasurementSet to query for receiver types.</span>
<span class="sd">        spwids: list of spw ids (integers) to query for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary assigning receiver types as values to spwid keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rxmap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">:</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">science_windows_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spw</span><span class="p">:</span>
            <span class="n">rxmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rxmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">receiver</span>
    <span class="k">return</span> <span class="n">rxmap</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_spectralspec_to_spwid_map</span><span class="p">(</span><span class="n">spws</span><span class="p">:</span> <span class="n">Collection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of spectral specs mapped to corresponding spectral</span>
<span class="sd">    window IDs for requested list of spectral window objects.</span>

<span class="sd">    :param spws: list of spectral window objects</span>
<span class="sd">    :return: dictionary with spectral spec as keys, and corresponding</span>
<span class="sd">    list of spectral window IDs as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spwmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">spwmap</span><span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">spectralspec</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spwmap</span>


<span class="k">def</span><span class="w"> </span><span class="nf">imstat_items</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract desired stats properties (per Stokes) using ia.statistics().</span>

<span class="sd">    Beside the standard output, some additional stats property keys are supported.</span>
<span class="sd">    Note: &#39;image&#39; is expected to an instance of CASA ia tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">imstats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;madrms&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;max/madrms&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max/madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;maxabs&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;maxabs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="s1">&#39;pct&lt;&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;pct&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">imstats_threshold</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">includepix</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if no pixel is selected from the restricted pixel value range, the return of ia.statitics() would be empty.</span>
                <span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pct_masked&#39;</span><span class="p">:</span>
            <span class="n">im_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;trc&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;blc&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;peak&#39;</span><span class="p">:</span>  <span class="c1"># Here &#39;peak&#39; means the pixel value with largest deviation from zero.</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]),</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;peak/madrms&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]),</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
            <span class="n">madrms</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;peak/madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">/</span><span class="n">madrms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">stats</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_stokes</span><span class="p">(</span><span class="n">imagename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the labels of all stokes planes present in a CASA image.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
        <span class="n">stokes_labels</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">stokes</span><span class="p">()</span>
        <span class="n">stokes_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">stokes_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stokes_present</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_casa_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper around quanta.quantity() that handles None input.</span>

<span class="sd">    Starting with CASA 6, quanta.quantity() no longer accepts None as input. This</span>
<span class="sd">    utility function handles None values when calling CASA quanta.quantity() tool</span>
<span class="sd">    method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A CASA quanta.quantity (dictionary)</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; get_casa_quantity(None)</span>
<span class="sd">    {&#39;unit&#39;: &#39;&#39;, &#39;value&#39;: 0.0}</span>
<span class="sd">    &gt;&gt;&gt; get_casa_quantity(&#39;10klambda&#39;)</span>
<span class="sd">    {&#39;unit&#39;: &#39;klambda&#39;, &#39;value&#39;: 10.0}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_si_prefix</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">lztol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtain the best SI unit prefix option for a numeric value.</span>

<span class="sd">    A &quot;best&quot; SI prefix from a specified prefix collection is defined by minimizing :</span>
<span class="sd">        * leading zeros (possibly to a specified tolerance limit, see `lztol`)</span>
<span class="sd">        * significant digits before the decimal point</span>
<span class="sd">    , after the prefix is applied.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): the numerical value for picking the prefix.</span>
<span class="sd">        select (str, optional): SI prefix candidates, a substring of &quot;yzafpnum kMGTPEZY&quot;).</span>
<span class="sd">            Defaults to &#39;mu&#39;.</span>
<span class="sd">        lztol (int, optional): leading zeros tolerance.</span>
<span class="sd">            Defaults to 0 (avoid any leading zeros when possible).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (prefix_string, prefix_scale)</span>

<span class="sd">    Examples:</span>

<span class="sd">    e.g. for frequency value in Hz</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(10**7,select=&#39;kMGT&#39;)</span>
<span class="sd">    (&#39;M&#39;, 1000000.0)</span>

<span class="sd">    e.g. for flux value in Jy</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1.0,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(0.0,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(-0.9,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;m&#39;, 0.001)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(0.9,select=&#39;um&#39;,lztol=1)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1e-7,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;u&#39;, 1e-06)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1e3,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sp_tab</span> <span class="o">=</span> <span class="s2">&quot;yzafpnum kMGTPEZY&quot;</span>
        <span class="n">sp_list</span><span class="p">,</span> <span class="n">sp_pow</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mf">3.0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sp_tab</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">select</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">sp_pow</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">+</span><span class="n">lztol</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sp_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mf">10.</span><span class="o">**</span><span class="n">sp_pow</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>


<div class="viewcode-block" id="absolute_path">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.domain.datatable.absolute_path.html#pipeline.domain.datatable.absolute_path">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an absolute path of a given file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">relative_path</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retun a relative path of a given file with respect a given origin.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: A path to file.</span>
<span class="sd">        start: An origin of relative path. If the start is not given, the</span>
<span class="sd">            current directory is used as the origin of relative path.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; relative_path(&#39;/root/a/b.txt&#39;, &#39;/root/c&#39;)</span>
<span class="sd">    &#39;../a/b.txt&#39;</span>
<span class="sd">    &gt;&gt;&gt; relative_path(&#39;../a/b.txt&#39;, &#39;./c&#39;)</span>
<span class="sd">    &#39;../../a/b.txt&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">start</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_task_result_count</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">taskname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;hif_makeimages&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count occurrences of a task result in the context.results list.</span>

<span class="sd">    Loop over the content of the context.results list and compare taskname to the pipeline_casa_task</span>
<span class="sd">    attribute of each result object. Increase counter if taskname substring is found in the attribute.</span>

<span class="sd">    The order number is determined by counting the number of previous execution of</span>
<span class="sd">    the task, based on the content of the context.results list. The introduction</span>
<span class="sd">    of this method is necessary because VLASS-SE-CONT imaging happens in multiple</span>
<span class="sd">    stages (hif_makeimages calls). Imaging parameters change from stage to stage,</span>
<span class="sd">    therefore it is necessary to know what is the current stage ordinal number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
        <span class="c1"># Work around the fact that r has read() method in some cases (e.g. editimlist)</span>
        <span class="c1"># but not in others (e.g. in tclean renderer)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">taskname</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">pipeline_casa_task</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">taskname</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">pipeline_casa_task</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span>


<span class="k">def</span><span class="w"> </span><span class="nf">place_repr_source_first</span><span class="p">(</span><span class="n">itemlist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]],</span> <span class="n">repr_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Place representative source first in a list of source names</span>
<span class="sd">    or tuples with source name as first tuple element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">itemtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">itemlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">repr_source_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">dequote</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dequote</span><span class="p">(</span><span class="n">repr_source</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">repr_source_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">dequote</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dequote</span><span class="p">(</span><span class="n">repr_source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot handle items of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itemtype</span><span class="p">))</span>
        <span class="n">repr_source_entry</span> <span class="o">=</span> <span class="n">itemlist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">repr_source_index</span><span class="p">)</span>
        <span class="n">itemlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">repr_source_entry</span><span class="p">]</span> <span class="o">+</span> <span class="n">itemlist</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not reorder field list to place representative source first&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">itemlist</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_taskhistory_fromimage</span><span class="p">(</span><span class="n">imagename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve past CASA/tclean() call parameters from the image history.</span>

<span class="sd">    Note: the tclean history is only added to images/logtable in CASA ver&gt;=6.2 (see CAS-13247)</span>
<span class="sd">    For tclean products generated by earlier CASA versions, an empty list will be returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taskhistory_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">history_list</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">history_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;taskname&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">taskhistory_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;taskname&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;taskversion&#39;</span><span class="p">,</span> <span class="s1">&#39;unkown&#39;</span><span class="p">)]))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;version:&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;CASAtools:&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">is_fromtask</span><span class="p">:</span>
                <span class="n">taskhistory_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;taskversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">is_fromtask</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">taskhistory_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taskhistory_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> task history entry/entries from </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">taskhistory_list</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_obj_size</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">serialize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the size of a Python object.</span>

<span class="sd">    If serialize is True, returns the size of the serialized object. Note that this is NOT</span>
<span class="sd">    the same as the object size in memory.</span>

<span class="sd">    When serialize is False, returns the memory consumption of the object via the asizeof</span>
<span class="sd">    method of Pympler (https://pypi.org/project/Pympler).</span>
<span class="sd">    An alternative is the get_deep_size() function from objsize (https://pypi.org/project/objsize).</span>

<span class="sd">    The serialization-based approach was a fallback solution for the issues described in PIPE-1698/PIPE-2877.</span>
<span class="sd">    The `asize.py` bug described in PIPE-2877 remain unresolved as of Pympler ver 1.1.</span>

<span class="sd">    See the GH issues for details and PIPE-1698 and PIPE-2877 for background:</span>
<span class="sd">        https://github.com/pympler/pympler/issues/155</span>
<span class="sd">        https://github.com/pympler/pympler/issues/151</span>

<span class="sd">    Args:</span>
<span class="sd">        obj: The Python object to measure.</span>
<span class="sd">        serialize: If True, measure serialized size; if False, measure memory size using Pympler.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The size of the object in bytes.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: If serialize is False and Pympler is not installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">serialize</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pympler.asizeof</span><span class="w"> </span><span class="kn">import</span> <span class="n">asizeof</span>
        <span class="k">return</span> <span class="n">asizeof</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Pympler import failed: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span>
            <span class="s1">&#39;Pympler is required for in-memory size calculation. Please install it with: pip install pympler&#39;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>


<span class="k">def</span><span class="w"> </span><span class="nf">glob_ordered</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a sorted list of paths matching a pathname pattern.&quot;&quot;&quot;</span>
    <span class="n">path_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;mtime&#39;</span><span class="p">:</span>
        <span class="n">path_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ctime&#39;</span><span class="p">:</span>
        <span class="n">path_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown sorting order requested: order=</span><span class="si">%r</span><span class="s2">. Only &#39;mtime&#39;, &#39;ctime&#39;, or None is allowed.&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;We will use the default alphabetically/numerically ascending order (order=None) instead.&quot;</span><span class="p">)</span>
        <span class="n">path_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path_list</span>


<span class="k">def</span><span class="w"> </span><span class="nf">deduplicate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove duplicate entries from a list, but preserve the order.</span>

<span class="sd">    Note that the use of list(set(x)) can cause random order in the output.</span>
<span class="sd">    The return of this function is guaranteed to be in the order that unique items show up in the input, unlike</span>
<span class="sd">    a deduplicate-resorting solution like sorted(set(x).</span>
<span class="sd">    Ref: https://stackoverflow.com/questions/480214/how-do-i-remove-duplicates-from-a-list-while-preserving-order</span>
<span class="sd">    This solution only works for Python 3.7+.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deduplicated_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deduplicated_items</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ignore_pointing</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A context manager to ignore pointing tables of MSes during I/O operations.</span>

<span class="sd">    The original pointing table will be temperarily renamed to POINTING_ORIGIN, and a new empty pointing table</span>
<span class="sd">    is created. When the context manager exits, the original table is restored.</span>

<span class="sd">    For example, to ignore the pointing table of a MS during mstransform() calls, use:</span>

<span class="sd">        with ignore_pointing(&#39;test.ms&#39;):</span>
<span class="sd">            casatasks.mstransform(vis=&#39;test.ms&#39;,outputvis=&#39;test_output.ms&#39;,scan=&#39;16&#39;,datacolumn=&#39;data&#39;)</span>

<span class="sd">    The pointing table of the output MS should be empty.</span>

<span class="sd">    On the other hand, if the pointing table is needed in the output vis, e.g. for imaging with tclean(usepointing=True),</span>
<span class="sd">    we can manually create hardlinks of pointing table afterwards while minimizing the disk space usage:</span>

<span class="sd">        import shutil, os</span>
<span class="sd">        shutil.rmtree(&#39;test_small.ms/POINTING&#39;)</span>
<span class="sd">        shutil.copytree(&#39;test.ms/POINTING&#39;, &#39;test_output.ms/POINTING&#39;, copy_function=os.link)</span>

<span class="sd">    One can verify the inodes of the pointing table files, which should be the same:</span>

<span class="sd">        ls -lih test.ms/POINTING</span>
<span class="sd">        ls -lih test_small.ms/POINTING</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
        <span class="n">vis_list</span> <span class="o">=</span> <span class="n">vis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vis_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vis</span><span class="p">]</span>

    <span class="n">vis_list_ignore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">vis_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No pointing table found in </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">vis_list_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;backup the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">tabdesc</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getdesc</span><span class="p">()</span>
                <span class="n">dminfo</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getdminfo</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;empty the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">table</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">,</span> <span class="n">tabdesc</span><span class="p">,</span> <span class="n">dminfo</span><span class="o">=</span><span class="n">dminfo</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">vis_list_ignore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;restore the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">open_with_lock</span><span class="p">(</span><span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">TextIO</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open a file with an exclusive lock.</span>

<span class="sd">    This context manager attempts to acquire an exclusive lock on the file upon opening.</span>
<span class="sd">    Other processes using `open_with_lock` will wait until the lock is automatically released</span>
<span class="sd">    when exiting the context.</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        filename: Path to the file to open and lock.</span>
<span class="sd">        mode: File open mode (e.g., &#39;rt&#39;, &#39;wt&#39;, &#39;a&#39;, &#39;rb&#39;).</span>
<span class="sd">        *args: Additional positional arguments to the built-in `open()` function.</span>
<span class="sd">        **kwargs: Additional keyword arguments to the built-in `open()` function.</span>

<span class="sd">    Yields:</span>
<span class="sd">        The opened file object with an exclusive lock acquired (if supported by the filesystem).</span>

<span class="sd">    Notes:</span>
<span class="sd">        All file open calls with `open_with_lock` will block other `open_with_lock` usages</span>
<span class="sd">        (even from different processes/Lustre clients) from read/write until the lock is</span>
<span class="sd">        released. However, this locking/blocking mechanism does not prevent file access</span>
<span class="sd">        (which could potentially cause IO errors) from other file openers (e.g., the</span>
<span class="sd">        built-in `open()` function).</span>

<span class="sd">        **Filesystem Support:**</span>
<span class="sd">        The Python `fcntl` API&#39;s behavior depends on the underlying OS/storage</span>
<span class="sd">        implementation: https://docs.python.org/3/library/fcntl.html. Not all</span>
<span class="sd">        OS/file systems fully support file locking.        </span>
<span class="sd">        - **Lustre**: Requires mount option `-o flock`. Check with: `mount -l | grep lustre`</span>
<span class="sd">            e.g. : `192.168.1.30@o2ib:/aoclst03 on /.lustre/aoc type lustre (rw,flock,user_xattr,lazystatfs)`</span>
<span class="sd">        - **NFS**: Support varies by configuration (see PIPE-2051 for details)</span>
<span class="sd">        - **Local filesystems**: Generally well-supported on Unix-like systems        </span>

<span class="sd">        **Testing Lock Behavior:**</span>
<span class="sd">        To verify exclusive locking works on your system, run this from multiple processes:</span>

<span class="sd">        ```python</span>
<span class="sd">        import fcntl</span>
<span class="sd">        with open(filename, &#39;w&#39;) as fd:</span>
<span class="sd">            fcntl.flock(fd, fcntl.LOCK_EX | fcntl.LOCK_NB)  # Should block/fail on second process</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">needs_truncate</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span> <span class="ow">in</span> <span class="n">mode</span>
    <span class="n">is_binary</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">mode</span>
    <span class="n">base_mode</span> <span class="o">=</span> <span class="s1">&#39;r+b&#39;</span> <span class="k">if</span> <span class="n">is_binary</span> <span class="k">else</span> <span class="s1">&#39;r+&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">base_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">base_mode</span> <span class="o">=</span> <span class="s1">&#39;w+b&#39;</span> <span class="k">if</span> <span class="n">is_binary</span> <span class="k">else</span> <span class="s1">&#39;w+&#39;</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">base_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to acquire lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="n">lock_acquired</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Acquire an exclusive lock on the file</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span><span class="p">)</span>
            <span class="n">lock_acquired</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Successfully acquired lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to acquire file lock for </span><span class="si">%s</span><span class="s1"> due to filesystem limitation, &#39;</span>
                        <span class="s1">&#39;which might cause racing conditions if multiple processes access &#39;</span>
                        <span class="s1">&#39;the file simultaneously: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lock_acquired</span> <span class="ow">and</span> <span class="n">needs_truncate</span><span class="p">:</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">fd</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Truncated file after acquiring lock: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">fd</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lock_acquired</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Successfully released lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Failed to release file lock for </span><span class="si">%s</span><span class="s1"> due to filesystem limitation, &#39;</span>
                            <span class="s1">&#39;which might cause racing conditions if multiple processes access &#39;</span>
                            <span class="s1">&#39;the file simultaneously: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
        <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ensure_products_dir_exists</span><span class="p">(</span><span class="n">products_dir</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating products directory: </span><span class="si">{</span><span class="n">products_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">products_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="k">raise</span>


<span class="k">def</span><span class="w"> </span><span class="nf">export_weblog_as_tar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">products_dir</span><span class="p">,</span> <span class="n">name_builder</span><span class="p">):</span>
    <span class="c1"># Construct filename prefix from oussid and recipe name if available.</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_oussid</span><span class="p">()</span>
    <span class="n">recipe_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_recipe_name</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">recipe_name</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">recipe_name</span>

    <span class="c1"># Construct filename for weblog output tar archive.</span>
    <span class="n">tarfilename</span> <span class="o">=</span> <span class="n">name_builder</span><span class="o">.</span><span class="n">weblog</span><span class="p">(</span><span class="n">project_structure</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="p">,</span>
                                      <span class="n">ousstatus_entity_id</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

    <span class="c1"># Save weblog directory to tar archive.</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving weblog in </span><span class="si">{</span><span class="n">tarfilename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_dir</span><span class="p">,</span> <span class="n">tarfilename</span><span class="p">),</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)),</span> <span class="s1">&#39;html&#39;</span><span class="p">))</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tarfilename</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_products_dir</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">products_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">products_dir</span>


<span class="k">class</span><span class="w"> </span><span class="nc">pl_defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_plain_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">to_plain_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">nested_dict</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pl_defaultdict</span><span class="p">(</span><span class="n">nested_dict</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">to_plain_dict</span><span class="p">(</span><span class="n">default_dict</span><span class="p">):</span>
    <span class="n">plain_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">):</span>
            <span class="n">plain_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_plain_dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plain_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">plain_dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">string_to_val</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string to a Python data type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pyobj</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># PIPE-1030: prevent a string like &quot;1,2,3&quot; from being unexpectedly translated into tuple</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">pyobj</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">pyobj</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span><span class="w"> </span><span class="nf">remove_trailing_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove a trailing string if it exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>

<span class="n">ConditionType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">function_io_dumper</span><span class="p">(</span><span class="n">to_pickle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">to_json</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">json_max_depth</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">condition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ConditionType</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dump arguments and return-objects of a function implement the decolator into pickle files and/or JSON(-like) file.</span>
<span class="sd">    </span>
<span class="sd">    This function is a helper method for development. It should not be used in production codes.</span>
<span class="sd">    </span>
<span class="sd">    Usage:</span>
<span class="sd">    @function_io_dumper()</span>
<span class="sd">    def foobar(self, bar):</span>
<span class="sd">        ...</span>
<span class="sd">        return ret</span>
<span class="sd">    </span>
<span class="sd">    When foobar() is executed, the decolator makes a directory &#39;foobar.[timestamp]&#39;, then it dumps</span>
<span class="sd">    all objects of arguments and return values of foobar() as pickle files and|or JSON files.</span>
<span class="sd">    We can get the same behavior of foobar() with the pickles as when they were dumped:</span>
<span class="sd">    </span>
<span class="sd">    with open(&#39;bar.pickle&#39;, &#39;rb&#39;) as f:</span>
<span class="sd">        bar = pickle.load(f)</span>
<span class="sd">    foobar(bar)</span>
<span class="sd">    </span>
<span class="sd">    or, understand input/result of the function by JSON-like output. To avoid recursive or tremendous output,</span>
<span class="sd">    it sets max depth of recursive (default to 5).</span>

<span class="sd">    Args:</span>
<span class="sd">        to_pickle (bool, optional): Dump pickle or not. Defaults to True.</span>
<span class="sd">        to_json (bool, optional): Dump JSON-like file or not. Defaults to False.</span>
<span class="sd">        json_max_depth (int, optional): Set depth of dumping JSON tree. Defaults to 5.</span>
<span class="sd">        condition (ConditionType): Set callable function user defined, or conditions of</span>
<span class="sd">            argument dumping. Defaults to None.</span>
<span class="sd">            ex1) Callable condition</span>
<span class="sd">                condition = my_condition</span>
<span class="sd">                And, a function my_condition() must be defined as:</span>
<span class="sd">                    def my_condition(kwargs) -&gt; bool:</span>
<span class="sd">                        # Serialize only if the keyword argument &#39;spw&#39; is 10 or True.</span>
<span class="sd">                        return kwargs.get(&quot;spw&quot;) in (10, True)</span>
<span class="sd">            ex2) Dict condition</span>
<span class="sd">                condition = {&#39;self&#39;, {&#39;spw&#39;:10}}</span>
<span class="sd">        timestamp (bool, optional): Add timestamp to the names of output directories. If not and the same function was</span>
<span class="sd">            executed multiple times, the output directory will be overwritten. Defaults to True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            
            <span class="c1"># create timestamp</span>
            <span class="n">epoch_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">epoch_time</span><span class="p">)</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">epoch_time</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">epoch_time</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1_000_000_000</span><span class="p">)</span>
            <span class="n">_timestamp</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;%Y%m%d-%H%M%S.</span><span class="si">{</span><span class="n">ns</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="c1"># make signatures of args</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="n">bound_args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">bound_args</span><span class="o">.</span><span class="n">apply_defaults</span><span class="p">()</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
                    <span class="n">exec_dumpargs</span> <span class="o">=</span> <span class="n">condition</span><span class="p">(</span><span class="n">bound_args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">exec_dumpargs</span> <span class="o">=</span> <span class="n">_eval_condition</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">bound_args</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error evaluating condition callable: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">exec_dumpargs</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">extention</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">timestamp</span><span class="p">:</span>
                <span class="n">extention</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">_timestamp</span><span class="si">}</span><span class="s1">&#39;</span>
                
            <span class="n">output_folder_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}{</span><span class="n">extention</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">json_dict</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">to_json</span><span class="p">:</span>
                <span class="n">json_dict</span> <span class="o">=</span> <span class="n">object_to_dict</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">json_max_depth</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_folder_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function &#39;</span><span class="si">{</span><span class="n">_get_full_method_path</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39; called at </span><span class="si">{</span><span class="n">_timestamp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_value</span> <span class="ow">in</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_dump</span><span class="p">(</span><span class="n">arg_value</span><span class="p">,</span> <span class="n">output_folder_name</span><span class="p">,</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">dump_pickle</span><span class="o">=</span><span class="n">to_pickle</span><span class="p">,</span> <span class="n">dump_json</span><span class="o">=</span><span class="n">to_json</span><span class="p">,</span> <span class="n">json_dict</span><span class="o">=</span><span class="n">json_dict</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exec_dumpargs</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contained unpickleable object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">exec_dumpargs</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exception occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exec_dumpargs</span> <span class="ow">and</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">output_folder_name</span><span class="si">}</span><span class="s1">.result&#39;</span>
                    <span class="k">if</span> <span class="n">to_json</span><span class="p">:</span>
                        <span class="n">json_dict</span> <span class="o">=</span> <span class="n">object_to_dict</span><span class="p">({</span><span class="n">_name</span><span class="p">:</span><span class="n">result</span><span class="p">},</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">json_max_depth</span><span class="p">)</span>
                    <span class="n">_dump</span><span class="p">({</span><span class="n">_name</span><span class="p">:</span><span class="n">result</span><span class="p">},</span> <span class="n">output_folder_name</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">dump_pickle</span><span class="o">=</span><span class="n">to_pickle</span><span class="p">,</span> <span class="n">dump_json</span><span class="o">=</span><span class="n">to_json</span><span class="p">,</span> <span class="n">json_dict</span><span class="o">=</span><span class="n">json_dict</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Contained unpickleable object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Exception occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">wrapper</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_dump</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dump_pickle</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dump_json</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">json_dict</span><span class="o">=</span><span class="p">{}):</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">dump_pickle</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="o">+</span><span class="s1">&#39;.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dump_json</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">json_dict</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="nb">str</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_full_method_path</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="n">module_name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__qualname__&#39;</span><span class="p">):</span>
        <span class="n">qualname</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qualname</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">module_name</span><span class="si">}</span><span class="s1">.</span><span class="si">{</span><span class="n">qualname</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_eval_condition</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="c1"># {&#39;self&#39;, {&#39;spw&#39;:10}}, need unittest</span>
    <span class="k">if</span> <span class="n">condition</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;condition: </span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">propname</span><span class="p">,</span> <span class="n">propval</span> <span class="ow">in</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">propname</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">getattr</span><span class="p">(</span><span class="n">propname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">propval</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">object_to_dict</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">current_depth</span> <span class="o">&gt;</span> <span class="n">max_depth</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">=</span><span class="n">current_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">object_to_dict</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">=</span><span class="n">current_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;__dict__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">current_depth</span><span class="o">=</span><span class="n">current_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">decorate_io_dumper</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">functions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply function_io_dumper dynamically.</span>

<span class="sd">    Usage:</span>
<span class="sd">    ...</span>
<span class="sd">    import pipeline.infrastructure.utils.utils as ut</span>
<span class="sd">    </span>
<span class="sd">    ut.decorate_io_dumper(SDInspection, [&#39;execute&#39;])</span>
<span class="sd">    </span>
<span class="sd">    ...</span>
<span class="sd">    hsd_importdata()  # -&gt; dump args of SDInspection.execute()</span>

<span class="sd">    Args:</span>
<span class="sd">        cls (object): the class has functions to be decorated.</span>
<span class="sd">        functions (List[str], optional): Function names to decodate. If not specified or</span>
<span class="sd">            set empty list, then all functions of the class are decorated. Defaults to [].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">functions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_functions</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">predicate</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_functions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">functions</span><span class="p">:</span>
            <span class="n">_c</span> <span class="o">=</span> <span class="n">_str_to_func</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_c</span><span class="p">:</span>
                <span class="n">_functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_c</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_func</span> <span class="ow">in</span> <span class="n">_functions</span><span class="p">:</span>
        <span class="n">_name</span> <span class="o">=</span> <span class="n">_func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">decorated_func</span> <span class="o">=</span> <span class="n">function_io_dumper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)(</span><span class="n">_func</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_name</span><span class="p">,</span> <span class="n">decorated_func</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_str_to_func</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_name</span><span class="p">):</span>
        <span class="n">_c</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">_c</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_c</span>
    <span class="k">return</span> <span class="kc">False</span>


<div class="viewcode-block" id="list_to_str">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.domain.datatable.list_to_str.html#pipeline.domain.datatable.list_to_str">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">list_to_str</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert list or numpy.ndarray into string.</span>

<span class="sd">    The list/ndarray should be 1-dimensional. In that case, the function</span>
<span class="sd">    returns comma-separated sequence of its elements. Otherwise it just</span>
<span class="sd">    returns default string representation of the value, str(value).</span>

<span class="sd">    Args:</span>
<span class="sd">        value: 1-dimensional list or numpy array</span>

<span class="sd">    Returns:</span>
<span class="sd">        String representation of the value. If input value is in</span>
<span class="sd">        compliance with the requirement, it will be comma-separated</span>
<span class="sd">        sequence of elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> \
       <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># use np.ndarray.tolist to ensure all the elements</span>
        <span class="c1"># have Python builtin types</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validates whether a given URL is properly formatted.</span>

<span class="sd">    This function checks if the URL follows a valid format using a regular expression.</span>
<span class="sd">    It also ensures that the parsed URL contains both a scheme (e.g., &quot;http&quot; or &quot;https&quot;)</span>
<span class="sd">    and a network location (netloc), which are required components for a valid URL.</span>

<span class="sd">    Args:</span>
<span class="sd">        url (str): The URL to validate.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if the URL is valid, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">url_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^(https?:\/\/)?&#39;</span>  <span class="c1"># HTTP or HTTPS</span>
        <span class="sa">r</span><span class="s1">&#39;([\w.-]+)&#39;</span>        <span class="c1"># Domain name or IP address</span>
        <span class="sa">r</span><span class="s1">&#39;(:\d+)?&#39;</span>          <span class="c1"># Optional port</span>
        <span class="sa">r</span><span class="s1">&#39;(\/[^\s]*)?$&#39;</span><span class="p">,</span>    <span class="c1"># Optional path</span>
        <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_row_count</span><span class="p">(</span><span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">taql</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the number of rows in the specified table that match the given TaQL query.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        table_name: Path to the CASA table.</span>
<span class="sd">        taql: The TaQL query string used to filter the table rows.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of rows matching the query, or 0 if an error occurs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">subtb</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">taql</span><span class="p">)</span>
            <span class="n">nrows</span> <span class="o">=</span> <span class="n">subtb</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>
            <span class="n">subtb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">nrows</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nrows</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_valid_url</span><span class="p">(</span><span class="n">env_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches one or more URLs from an environment variable. If a comma-delimited string is provided,</span>
<span class="sd">    it is split and each URL is validated. Falls back to the default if any URL is invalid or not set.</span>

<span class="sd">    Args:</span>
<span class="sd">        env_var: The name of the environment variable.</span>
<span class="sd">        default: A single default URL or a list of default URLs.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A valid URL string or a list of valid URL strings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">envvar_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_var</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">envvar_value</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Environment variable </span><span class="si">%s</span><span class="s1"> not defined. Switching to default </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">envvar_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">urls</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Environment variable </span><span class="si">%s</span><span class="s1"> is empty after parsing. Switching to default </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">validate_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Environment variable </span><span class="si">%s</span><span class="s1"> URL was set to </span><span class="si">%s</span><span class="s1"> but is misconfigured.&#39;</span><span class="p">,</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Switching to default </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">default</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Environment variable </span><span class="si">%s</span><span class="s1"> set to URL </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">urls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Environment variable </span><span class="si">%s</span><span class="s1"> set to list of URLs </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">env_var</span><span class="p">,</span> <span class="n">urls</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">urls</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2025, Pipeline Dev. Team, build: 2025.1.1.56+247-g51f7e999a3-update-docs-build-and-packaging-setup.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>