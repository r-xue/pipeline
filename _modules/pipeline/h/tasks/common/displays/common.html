

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.h.tasks.common.displays.common &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">TaskRef (create_docs.py)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../_taskdocs/taskdocs.html">List of Heuristics Tasks (Pipeline 2023)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.h.tasks.common.displays.common</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.h.tasks.common.displays.common</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">cachetools</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.callibrary</span> <span class="k">as</span> <span class="nn">callibrary</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.renderer.logger</span> <span class="k">as</span> <span class="nn">logger</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">pipeline.domain</span> <span class="kn">import</span> <span class="n">MeasurementSet</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tasks</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">COLSHAPE_FORMAT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[(?P&lt;num_pols&gt;\d+), (?P&lt;num_rows&gt;\d+)\]&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="PlotbandpassDetailBase">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassDetailBase.html#pipeline.h.tasks.common.displays.common.PlotbandpassDetailBase">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassDetailBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># identify the bandpass solution for the target</span>
        <span class="n">calapps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">final</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">intent</span><span class="p">)]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">({</span><span class="n">c</span><span class="o">.</span><span class="n">gaintable</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">calapps</span><span class="p">})</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Target solutions != 1&#39;</span><span class="p">)</span>
        <span class="n">calapp</span> <span class="o">=</span> <span class="n">calapps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">vis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vis_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span> <span class="o">=</span> <span class="n">xaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span> <span class="o">=</span> <span class="n">yaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">)</span>

        <span class="c1"># we should only request plots for the antennas and spws in the</span>
        <span class="c1"># caltable, which may be a subset of those in the measurement set</span>
        <span class="n">caltable_wrapper</span> <span class="o">=</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">from_caltable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">)</span>
        <span class="n">antenna_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span>
        <span class="n">spw_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">spw</span><span class="p">)</span>

        <span class="c1"># use antenna name rather than ID where possible</span>
        <span class="n">antenna_arg</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">])</span>
        <span class="n">antennas</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">antenna_arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_antmap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">antennas</span><span class="p">)</span>

        <span class="c1"># the number of polarisations for a spw may not be equal to the number</span>
        <span class="c1"># of shape of the column. For example, X403 has XX,YY for some spws</span>
        <span class="c1"># but XX for the science data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spw_ids</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">))</span>
            <span class="n">num_pols</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">num_polarizations</span>
            <span class="n">pols</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">dd</span><span class="o">.</span><span class="n">get_polarization_label</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pols</span><span class="p">)])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pols</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">pols</span>

        <span class="c1"># Get mapping from spw to receiver type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rxmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_receiver_type_for_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spw_ids</span><span class="p">)</span>

        <span class="c1"># Get base name of figure file(s).</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;overlay&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">fileparts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">),</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
            <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="s1">&#39;-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">overlay</span> <span class="k">if</span> <span class="n">overlay</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="p">}</span>
        <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{caltable}</span><span class="s1">-</span><span class="si">{y}</span><span class="s1">_vs_</span><span class="si">{x}{overlay}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fileparts</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_figroot</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                                     <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">,</span>
                                     <span class="n">png</span><span class="p">)</span>

        <span class="c1"># plotbandpass injects spw ID and antenna name into every plot filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figroot</span><span class="p">)</span>

        <span class="n">scan_ids_in_caltable</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">scan</span><span class="p">)))</span>
        <span class="n">scan_to_suffix</span> <span class="o">=</span> <span class="p">{</span><span class="n">scan_id</span><span class="p">:</span> <span class="s1">&#39;.t</span><span class="si">%02d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span>
                          <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scan_ids_in_caltable</span><span class="p">)}</span>

        <span class="c1"># Get prediction of final name of figure file for each spw and ant,</span>
        <span class="c1"># assuming plotbandpass injects spw ID and ant into every plot</span>
        <span class="c1"># filename.</span>
        <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">ant_id</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">spw_ids</span><span class="p">,</span> <span class="n">antenna_ids</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">overlay</span><span class="p">:</span>
                <span class="c1"># filter the caltable down to the data containing the spw and</span>
                <span class="c1"># antenna. From this we can read the scan, and thus derive what</span>
                <span class="c1"># suffix plotbandpass will add to the png.</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="p">[</span><span class="n">spw_id</span><span class="p">],</span> <span class="n">antenna</span><span class="o">=</span><span class="p">[</span><span class="n">ant_id</span><span class="p">])</span>

                <span class="n">scan_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span>
                <span class="c1"># TODO this breaks if the spw is present in more than one scan!</span>
                <span class="c1"># We&#39;re having to reverse engineer plotbandpass&#39; naming scheme.</span>
                <span class="c1"># Perhaps we should glob for files created somehow?</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="s1">&#39;.t00&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">scan_to_suffix</span><span class="p">[</span><span class="n">scan_ids</span><span class="o">.</span><span class="n">pop</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="n">ant_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_antmap</span><span class="p">[</span><span class="n">ant_id</span><span class="p">]</span>
            <span class="n">real_figfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.spw</span><span class="si">%0.2d%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">ant_name</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span>
                                                   <span class="n">time</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">[</span><span class="n">spw_id</span><span class="p">][</span><span class="n">ant_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_figfile</span>

    <span class="k">def</span> <span class="nf">create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw_arg</span><span class="p">,</span> <span class="n">antenna_arg</span><span class="p">,</span> <span class="n">showimage</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">task_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">,</span>
                     <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">,</span>
                     <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
                     <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
                     <span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="n">spw_arg</span><span class="p">,</span>
                     <span class="s1">&#39;antenna&#39;</span><span class="p">:</span> <span class="n">antenna_arg</span><span class="p">,</span>
                     <span class="s1">&#39;subplot&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
                     <span class="s1">&#39;figfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figroot</span><span class="p">,</span>
                     <span class="s1">&#39;showimage&#39;</span><span class="p">:</span> <span class="n">showimage</span><span class="p">,</span>
                     <span class="p">}</span>
        <span class="n">task_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">casa_tasks</span><span class="o">.</span><span class="n">plotbandpass</span><span class="p">(</span><span class="o">**</span><span class="n">task_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="PlotmsCalLeaf">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotmsCalLeaf.html#pipeline.h.tasks.common.displays.common.PlotmsCalLeaf">[docs]</a>
<span class="k">class</span> <span class="nc">PlotmsCalLeaf</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to execute plotms and return a plot wrapper. It passes the spw and</span>
<span class="sd">    ant arguments through to plotms without further manipulation, creating</span>
<span class="sd">    exactly one plot.</span>

<span class="sd">    If a list of calapps is provided as input, the caltables from each calapp</span>
<span class="sd">    will be overplotted on the same plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span>
                 <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">correlation</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">plotrange</span><span class="o">=</span><span class="p">[],</span> <span class="n">coloraxis</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span> <span class="o">=</span> <span class="n">xaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span> <span class="o">=</span> <span class="n">yaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_correlation</span> <span class="o">=</span> <span class="n">correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotrange</span> <span class="o">=</span> <span class="n">plotrange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coloraxis</span> <span class="o">=</span> <span class="n">coloraxis</span>

        <span class="c1"># Make calapp a list if it isn&#39;t already, as the rest of the code assumes this is a list</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">calapp</span> <span class="o">=</span> <span class="p">[</span><span class="n">calapp</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span> <span class="o">=</span> <span class="n">calapp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span> <span class="o">=</span> <span class="p">[</span><span class="n">cal</span><span class="o">.</span><span class="n">gaintable</span> <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">calapp</span><span class="p">]</span>

        <span class="c1"># Assume that there is one vis for all calapps (may need to be modififed in the future)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">vis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">cal</span><span class="o">.</span><span class="n">intent</span> <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span><span class="p">])</span>

        <span class="c1"># Use antenna name rather than ID if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ant_ids</span> <span class="o">=</span> <span class="n">ant</span>
        <span class="k">if</span> <span class="n">ant</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">)</span>
            <span class="n">domain_antennas</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
            <span class="n">idents</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">domain_antennas</span><span class="p">]</span>
            <span class="n">ant</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span> <span class="o">=</span> <span class="n">ant</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_figfile</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">spw</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">+=</span> <span class="s1">&#39; spw </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ant</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">+=</span> <span class="s1">&#39; ant </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ant</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>

        <span class="c1"># These task_args are the same whether one caltable is plotted</span>
        <span class="c1"># on its own, or multiple caltables are overplotted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
            <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
            <span class="s1">&#39;showgui&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spw</span><span class="p">),</span>
            <span class="s1">&#39;antenna&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span><span class="p">,</span>
            <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correlation</span><span class="p">,</span>
            <span class="s1">&#39;plotrange&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotrange</span><span class="p">,</span>
            <span class="s1">&#39;coloraxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coloraxis</span><span class="p">,</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="p">,</span>
            <span class="s1">&#39;clearplots&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_wrapper</span><span class="p">()]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plots</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_figfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">caltable_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span>

        <span class="n">fileparts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="n">caltable_name</span><span class="p">,</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
            <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;spw</span><span class="si">%0.2d</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spw</span><span class="p">),</span>
            <span class="s1">&#39;ant&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;ant</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
            <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
            <span class="s1">&#39;correlation&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correlation</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_correlation</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;ratio&#39;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{caltable}</span><span class="s1">-</span><span class="si">{spw}{ant}{intent}{correlation}{y}</span><span class="s1">_vs_</span><span class="si">{x}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fileparts</span><span class="p">)</span>

        <span class="c1"># Maximum filename size for Lustre filesystems is 255 bytes. These</span>
        <span class="c1"># plots can exceed this limit due to including the names of all</span>
        <span class="c1"># antennas. Truncate over-long filename while keeping it unique by</span>
        <span class="c1"># replacing it with the hash.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">png</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">251</span><span class="p">:</span>  <span class="c1"># 255 - &#39;.png&#39;</span>
            <span class="n">new_png</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{!s}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">png</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Renaming plot to avoid exceeding filesystem limit on filename length.</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Old: </span><span class="si">{!s}</span><span class="se">\n</span><span class="s1">New: </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">png</span><span class="p">,</span> <span class="n">new_png</span><span class="p">))</span>
            <span class="n">png</span> <span class="o">=</span> <span class="n">new_png</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">,</span> <span class="n">png</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_plot_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_tasks</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Creating new plot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not create plot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">),</span>
                      <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">)}</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">,</span> <span class="s1">&#39;ant&#39;</span><span class="p">,</span> <span class="s1">&#39;intent&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">,</span>
                              <span class="n">x_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
                              <span class="n">y_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
                              <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                              <span class="n">command</span><span class="o">=</span><span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">tasks</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">def</span> <span class="nf">_create_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">symbol_array</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;autoscaling&#39;</span><span class="p">,</span> <span class="s1">&#39;diamond&#39;</span><span class="p">,</span> <span class="s1">&#39;square&#39;</span><span class="p">]</span> <span class="c1"># Note: autoscaling can be &#39;pixel (cross)&#39; or &#39;circle&#39; depending on number of points.</span>
        <span class="n">task_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Create a plotms task for each caltable. See PIPE-1377 and PIPE-1409.</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">caltable</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">):</span>
            <span class="c1"># plotms uses the &#39;vis&#39; input parameter to specify caltables to plot</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">caltable</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;plotindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>

            <span class="c1"># If there are multiple caltables to overplot, clearplots must be False for all</span>
            <span class="c1"># but the first plot.</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;clearplots&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Alter plot symbols by cycling through the list of available symbols for each subsequent over-plot.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;symbolshape&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">symbol_array</span><span class="p">[</span><span class="n">n</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbol_array</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;customsymbol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># The plotfile must be specified for only the last plotms command</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">[</span><span class="s1">&#39;plotfile&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span>

            <span class="n">task_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">casa_tasks</span><span class="o">.</span><span class="n">plotms</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">task_args</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">task_list</span></div>



<div class="viewcode-block" id="PlotbandpassLeaf">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassLeaf.html#pipeline.h.tasks.common.displays.common.PlotbandpassLeaf">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassLeaf</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to execute plotbandpass and return a plot wrapper. It passes the spw</span>
<span class="sd">    and ant arguments through to plotbandpass without further manipulation. More</span>
<span class="sd">    than one plot may be created though not necessarily returned, as</span>
<span class="sd">    plotbandpass may create many plots depending on the input arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">overlay</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">showatm</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_result</span> <span class="o">=</span> <span class="n">result</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span> <span class="o">=</span> <span class="n">calapp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">vis</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span> <span class="o">=</span> <span class="n">xaxis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span> <span class="o">=</span> <span class="n">yaxis</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">intent</span>

        <span class="c1"># use antenna name rather than ID if possible</span>
        <span class="k">if</span> <span class="n">ant</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">domain_antennas</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
            <span class="n">idents</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">domain_antennas</span><span class="p">]</span>
            <span class="n">ant</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">idents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span> <span class="o">=</span> <span class="n">ant</span>

        <span class="c1"># convert pol ID from integer to string, eg. 0 to XX</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">dd</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">))</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">get_polarization_label</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pol</span> <span class="o">=</span> <span class="n">pol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_figfile</span><span class="p">()</span>

        <span class="c1"># plotbandpass injects antenna name, spw ID and t0 into every plot filename</span>
        <span class="n">root</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">)</span>
        <span class="c1"># if spw is &#39;&#39;, the spw component will be set to the first spw</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">caltable_spws</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">))</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">caltable_spws</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pb_figfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s%s</span><span class="s1">.t00</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">root</span><span class="p">,</span>
                                             <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ant</span> <span class="k">if</span> <span class="n">ant</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;.spw</span><span class="si">%0.2d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">spw</span> <span class="k">if</span> <span class="n">spw</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                             <span class="n">ext</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_overlay</span> <span class="o">=</span> <span class="n">overlay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_showatm</span> <span class="o">=</span> <span class="n">showatm</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_task</span><span class="p">()</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_wrapper</span><span class="p">(</span><span class="n">task</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plots</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">abspath</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_figfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fileparts</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">),</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
            <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;spw</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span><span class="p">,</span>
            <span class="s1">&#39;ant&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;ant</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
            <span class="s1">&#39;intent&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">),</span>
            <span class="s1">&#39;pol&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pol</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pol</span>
        <span class="p">}</span>
        <span class="n">png</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{caltable}</span><span class="s1">-</span><span class="si">{spw}{pol}{ant}{intent}{y}</span><span class="s1">_vs_</span><span class="si">{x}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">fileparts</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                            <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">,</span>
                            <span class="n">png</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_plot_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pb_figfile</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Creating new plot: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pb_figfile</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Could not create plot </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pb_figfile</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">,</span>
                      <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">,</span> <span class="s1">&#39;ant&#39;</span><span class="p">,</span> <span class="s1">&#39;intent&#39;</span><span class="p">,</span> <span class="s1">&#39;pol&#39;</span><span class="p">]:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">parameters</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="n">wrapper</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pb_figfile</span><span class="p">,</span>
                              <span class="n">x_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
                              <span class="n">y_axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
                              <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
                              <span class="n">command</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">def</span> <span class="nf">_create_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">task_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vis</span><span class="p">,</span>
                     <span class="s1">&#39;caltable&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_caltable</span><span class="p">,</span>
                     <span class="s1">&#39;xaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xaxis</span><span class="p">,</span>
                     <span class="s1">&#39;yaxis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_yaxis</span><span class="p">,</span>
                     <span class="s1">&#39;antenna&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ant</span><span class="p">,</span>
                     <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw</span><span class="p">,</span>
                     <span class="s1">&#39;poln&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pol</span><span class="p">,</span>
                     <span class="s1">&#39;overlay&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overlay</span><span class="p">,</span>
                     <span class="s1">&#39;figfile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_figfile</span><span class="p">,</span>
                     <span class="s1">&#39;showatm&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_showatm</span><span class="p">,</span>
                     <span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="s1">&#39;subplot&#39;</span><span class="p">:</span> <span class="mi">11</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">casa_tasks</span><span class="o">.</span><span class="n">plotbandpass</span><span class="p">(</span><span class="o">**</span><span class="n">task_args</span><span class="p">)</span></div>



<div class="viewcode-block" id="LeafComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.LeafComposite.html#pipeline.h.tasks.common.displays.common.LeafComposite">[docs]</a>
<span class="k">class</span> <span class="nc">LeafComposite</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class to hold multiple PlotLeafs, thus generating multiple plots when</span>
<span class="sd">    plot() is called.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_children</span> <span class="o">=</span> <span class="n">children</span>

    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_children</span><span class="p">:</span>
            <span class="n">plots</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">plot</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plots</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_create_calapp_contents_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calapps</span> <span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and returns a dictionary mapping some element (e.g. spw, ant) specified by the input</span>
<span class="sd">        column_name to lists of the input calapps that have that element present in their caltables.</span>

<span class="sd">        e.g if the column_name is &#39;ANTENNA1&#39;, this funtion will return a dict where the keys are</span>
<span class="sd">        all antenna numbers present in any of the input calapps&#39; caltables. For each antenna number key,</span>
<span class="sd">        the value is a list of all the input calapps with caltables with that antenna.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dict_calapp</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">calapps</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="n">column_name</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">cal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_calapp</span><span class="p">[</span><span class="n">elt</span><span class="p">]:</span>
                        <span class="n">dict_calapp</span><span class="p">[</span><span class="n">elt</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cal</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dict_calapp</span></div>



<div class="viewcode-block" id="PolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PolComposite.html#pipeline.h.tasks.common.displays.common.PolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PolComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each polarization in the caltable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reference to the PlotLeaf class to call</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># the number of polarisations for a spw may not be equal to the number</span>
        <span class="c1"># of shape of the column. For example, X403 has XX,YY for some spws</span>
        <span class="c1"># but XX for the science data. If we&#39;re given a spw argument we can</span>
        <span class="c1"># bypass the calls for the missing polarisation.</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">calapp</span><span class="o">.</span><span class="n">vis</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>

            <span class="n">dd</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">))</span>
            <span class="n">num_pols</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">num_polarizations</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_pols</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_num_caltable_polarizations</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                                    <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_pols</span><span class="p">)]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PolComposite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="SpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.SpwComposite.html#pipeline.h.tasks.common.displays.common.SpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">SpwComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each spw in the caltable or caltables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reference to the PlotLeaf class to call</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span>
                <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Create a dictionary to keep track of which caltables have which spws.</span>
            <span class="n">dict_calapp_spws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calapp_contents_dict</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">table_spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dict_calapp_spws</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># In the following call, dict_calapp_spw[spw] is a list of calapps with that spw present</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dict_calapp_spws</span><span class="p">[</span><span class="n">spw</span><span class="p">],</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                        <span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">table_spws</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Identify spws in caltable</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">table_spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)))</span>

            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                                <span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">table_spws</span><span class="p">]</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="SpwAntComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.SpwAntComposite.html#pipeline.h.tasks.common.displays.common.SpwAntComposite">[docs]</a>
<span class="k">class</span> <span class="nc">SpwAntComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each spw and antenna in the caltable or caltables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reference to the PlotLeaf class to call</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span>
                <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">ysamescale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Support for lists of calapps was added for PIPE-1409 and PIPE-1377.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Create a dictionary to keep track of which caltables have which spws.</span>
            <span class="n">dict_calapp_spws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calapp_contents_dict</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">table_spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dict_calapp_spws</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># PIPE-66: if requested, and no explicit (non-empty) plotrange was</span>
            <span class="c1"># set, then use the same y-scale for plots of the same spw.</span>
            <span class="c1"># TODO: in the future, this could potentially be refactored to use</span>
            <span class="c1"># the yselfscale parameter in PlotMS together with &quot;iteraxis&quot;, so as</span>
            <span class="c1"># to let PlotMS take care of setting the same y-range for a set of</span>
            <span class="c1"># plots. Would also need infrastructure.utils.framework.plotms_iterate.</span>
            <span class="n">update_yscale</span> <span class="o">=</span> <span class="n">ysamescale</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plotrange&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">table_spws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">update_yscale</span><span class="p">:</span>
                <span class="c1"># If a list of calapps is input, get the ymin and ymax for all the caltables with this spw.</span>
                    <span class="n">ymins</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">ymaxes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">cal</span> <span class="ow">in</span> <span class="n">dict_calapp_spws</span><span class="p">[</span><span class="n">spw</span><span class="p">]:</span>
                        <span class="n">caltable_wrapper</span> <span class="o">=</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">from_caltable</span><span class="p">(</span><span class="n">cal</span><span class="o">.</span><span class="n">gaintable</span><span class="p">,</span> <span class="n">gaincalamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">filtered</span> <span class="o">=</span> <span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)])</span>
                        <span class="c1"># Save the ymin and ymax values rather than the full filtered.data as that could get large</span>
                        <span class="n">ymins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>
                        <span class="n">ymaxes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">data</span><span class="p">)))</span>

                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ymins</span><span class="p">)</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ymaxes</span><span class="p">)</span>

                    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">yrange</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">yrange</span>

                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;plotrange&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]})</span>

                <span class="c1"># In the following call, dict_calapp_spw[spw] is the list of calapps with that spw</span>
                <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dict_calapp_spws</span><span class="p">[</span><span class="n">spw</span><span class="p">],</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">),</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Identify spws in caltable</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">table_spws</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">))</span>

            <span class="n">caltable_spws</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">table_spws</span><span class="p">])</span>

            <span class="c1"># PIPE-66: if requested, and no explicit (non-empty) plotrange was</span>
            <span class="c1"># set, then use the same y-scale for plots of the same spw.</span>
            <span class="c1"># TODO: in the future, this could potentially be refactored to use</span>
            <span class="c1"># the yselfscale parameter in PlotMS together with &quot;iteraxis&quot;, so as</span>
            <span class="c1"># to let PlotMS take care of setting the same y-range for a set of</span>
            <span class="c1"># plots. Would also need infrastructure.utils.framework.plotms_iterate.</span>
            <span class="n">update_yscale</span> <span class="o">=</span> <span class="n">ysamescale</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plotrange&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">caltable_spws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">update_yscale</span><span class="p">:</span>
                    <span class="n">caltable_wrapper</span> <span class="o">=</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">from_caltable</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">,</span> <span class="n">gaincalamp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">filtered</span> <span class="o">=</span> <span class="n">caltable_wrapper</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="p">[</span><span class="n">spw</span><span class="p">])</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                    <span class="n">yrange</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span>
                    <span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">yrange</span>
                    <span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span> <span class="o">+</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">yrange</span>

                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;plotrange&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]})</span>

                <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="AntComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.AntComposite.html#pipeline.h.tasks.common.displays.common.AntComposite">[docs]</a>
<span class="k">class</span> <span class="nc">AntComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each antenna in the caltable or caltables.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reference to the PlotLeaf class to call</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span> <span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">],</span>
                <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># Create a dictionary to keep track of which caltables have which ants.</span>
            <span class="n">dict_calapp_ants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_calapp_contents_dict</span><span class="p">(</span><span class="n">calapp</span><span class="p">,</span> <span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
            <span class="n">table_ants</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dict_calapp_ants</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="c1"># In the following call dict_calapp_ants[ant] is the list of calapps with antenna=ant present</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">dict_calapp_ants</span><span class="p">[</span><span class="n">ant</span><span class="p">],</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                        <span class="n">ant</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ant</span><span class="p">),</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">table_ants</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Identify ants in caltable</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">table_ants</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)))</span>

            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                        <span class="n">ant</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">ant</span><span class="p">),</span> <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">table_ants</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="AntSpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.AntSpwComposite.html#pipeline.h.tasks.common.displays.common.AntSpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">AntSpwComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each spw and antenna in the caltable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">table_ants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">))</span>

        <span class="n">caltable_antennas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span> <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">table_ants</span><span class="p">]</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                                    <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">caltable_antennas</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AntSpwComposite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="SpwPolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.SpwPolComposite.html#pipeline.h.tasks.common.displays.common.SpwPolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">SpwPolComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each spw and polarization in the caltable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">table_spws</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">))</span>

        <span class="n">caltable_spws</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">table_spws</span><span class="p">]</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                                    <span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">,</span> <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">caltable_spws</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpwPolComposite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="AntSpwPolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.AntSpwPolComposite.html#pipeline.h.tasks.common.displays.common.AntSpwPolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">AntSpwPolComposite</span><span class="p">(</span><span class="n">LeafComposite</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a PlotLeaf for each antenna, spw, and polarization in the caltable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">calapp</span><span class="o">.</span><span class="n">gaintable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">table_ants</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">))</span>

        <span class="n">caltable_antennas</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span> <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">table_ants</span><span class="p">]</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">leaf_class</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">calapp</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span>
                                    <span class="n">ant</span><span class="o">=</span><span class="n">ant</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">caltable_antennas</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AntSpwPolComposite</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">children</span><span class="p">)</span></div>



<div class="viewcode-block" id="PlotmsCalAntComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotmsCalAntComposite.html#pipeline.h.tasks.common.displays.common.PlotmsCalAntComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotmsCalAntComposite</span><span class="p">(</span><span class="n">AntComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotmsCalLeaf</span></div>



<div class="viewcode-block" id="PlotmsCalSpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotmsCalSpwComposite.html#pipeline.h.tasks.common.displays.common.PlotmsCalSpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotmsCalSpwComposite</span><span class="p">(</span><span class="n">SpwComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotmsCalLeaf</span></div>



<div class="viewcode-block" id="PlotmsCalAntSpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotmsCalAntSpwComposite.html#pipeline.h.tasks.common.displays.common.PlotmsCalAntSpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotmsCalAntSpwComposite</span><span class="p">(</span><span class="n">AntSpwComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotmsCalSpwComposite</span></div>



<div class="viewcode-block" id="PlotmsCalSpwAntComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotmsCalSpwAntComposite.html#pipeline.h.tasks.common.displays.common.PlotmsCalSpwAntComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotmsCalSpwAntComposite</span><span class="p">(</span><span class="n">SpwAntComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotmsCalAntComposite</span></div>



<div class="viewcode-block" id="PlotbandpassAntComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassAntComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassAntComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassAntComposite</span><span class="p">(</span><span class="n">AntComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassLeaf</span></div>



<div class="viewcode-block" id="PlotbandpassSpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassSpwComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassSpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassSpwComposite</span><span class="p">(</span><span class="n">SpwComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassLeaf</span></div>



<div class="viewcode-block" id="PlotbandpassPolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassPolComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassPolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassPolComposite</span><span class="p">(</span><span class="n">PolComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassLeaf</span></div>



<div class="viewcode-block" id="PlotbandpassAntSpwComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassAntSpwComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassAntSpwComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassAntSpwComposite</span><span class="p">(</span><span class="n">AntSpwComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassSpwComposite</span></div>



<div class="viewcode-block" id="PlotbandpassSpwPolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassSpwPolComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassSpwPolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassSpwPolComposite</span><span class="p">(</span><span class="n">SpwPolComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassPolComposite</span></div>



<div class="viewcode-block" id="PlotbandpassAntSpwPolComposite">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PlotbandpassAntSpwPolComposite.html#pipeline.h.tasks.common.displays.common.PlotbandpassAntSpwPolComposite">[docs]</a>
<span class="k">class</span> <span class="nc">PlotbandpassAntSpwPolComposite</span><span class="p">(</span><span class="n">AntSpwPolComposite</span><span class="p">):</span>
    <span class="n">leaf_class</span> <span class="o">=</span> <span class="n">PlotbandpassSpwPolComposite</span></div>



<div class="viewcode-block" id="CaltableWrapperFactory">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.CaltableWrapperFactory.html#pipeline.h.tasks.common.displays.common.CaltableWrapperFactory">[docs]</a>
<span class="k">class</span> <span class="nc">CaltableWrapperFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_caltable</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gaincalamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;CaltableWrapperFactory.from_caltable(</span><span class="si">%r</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">viscal</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getkeyword</span><span class="p">(</span><span class="s1">&#39;VisCal&#39;</span><span class="p">)</span>
            <span class="n">caltype</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalFrom</span><span class="o">.</span><span class="n">get_caltype_for_viscal</span><span class="p">(</span><span class="n">viscal</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caltype</span> <span class="o">==</span> <span class="s1">&#39;gaincal&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">create_gaincal_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">gaincalamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caltype</span> <span class="o">==</span> <span class="s1">&#39;tsys&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">create_param_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;FPARAM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caltype</span> <span class="o">==</span> <span class="s1">&#39;bandpass&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">create_param_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caltype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ps&#39;</span><span class="p">,</span> <span class="s1">&#39;otf&#39;</span><span class="p">,</span> <span class="s1">&#39;otfraster&#39;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">create_param_wrapper</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;FPARAM&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unhandled caltype: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">viscal</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_gaincal_wrapper</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">gaincalamp</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">time_mjd</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="n">antenna1</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SCAN_NUMBER&#39;</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># convert MJD times stored in caltable to matplotlib equivalent</span>
            <span class="n">time_unix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mjd_seconds_to_datetime</span><span class="p">(</span><span class="n">time_mjd</span><span class="p">)</span>
            <span class="n">time_matplotlib</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">time_unix</span><span class="p">)</span>

            <span class="c1"># If requested, return the gain amplitudes rather than the phases.</span>
            <span class="k">if</span> <span class="n">gaincalamp</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">gain</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phase</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">gain</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">gain</span><span class="p">))</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">flag</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">CaltableWrapper</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time_matplotlib</span><span class="p">,</span> <span class="n">antenna1</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">scan</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_param_wrapper</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
            <span class="n">time_mjd</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="n">antenna1</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SCAN_NUMBER&#39;</span><span class="p">)</span>

            <span class="c1"># convert MJD times stored in caltable to matplotlib equivalent</span>
            <span class="n">time_unix</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">mjd_seconds_to_datetime</span><span class="p">(</span><span class="n">time_mjd</span><span class="p">)</span>
            <span class="n">time_matplotlib</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">time_unix</span><span class="p">)</span>

            <span class="c1"># results in a list of numpy arrays, one for each row in the</span>
            <span class="c1"># caltable. The shape of each numpy array is number of</span>
            <span class="c1"># correlations, number of channels, number of values for that</span>
            <span class="c1"># correlation/channel combination - which is always 1. Squeeze out</span>
            <span class="c1"># the unnecessary dimension and swap the channel and correlation</span>
            <span class="c1"># axes.</span>
            <span class="n">data_col</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getvarcol</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">row_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_col</span><span class="p">[</span><span class="s1">&#39;r</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_col</span><span class="p">))]</span>

            <span class="n">flag_col</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getvarcol</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)</span>
            <span class="n">row_flag</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag_col</span><span class="p">[</span><span class="s1">&#39;r</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flag_col</span><span class="p">))]</span>

            <span class="c1"># PIPE-1706: explicitly pass dtype=object to create &quot;object&quot; array and allow</span>
            <span class="c1"># individual elements to have different shapes.</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">row_flag</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">CaltableWrapper</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time_matplotlib</span><span class="p">,</span> <span class="n">antenna1</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span>
                                   <span class="n">scan</span><span class="p">)</span></div>



<div class="viewcode-block" id="CaltableWrapper">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.CaltableWrapper.html#pipeline.h.tasks.common.displays.common.CaltableWrapper">[docs]</a>
<span class="k">class</span> <span class="nc">CaltableWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_caltable</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CaltableWrapperFactory</span><span class="o">.</span><span class="n">from_caltable</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">antenna</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">scan</span><span class="p">):</span>
        <span class="c1"># tag the extra metadata columns onto our data array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">antenna</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">scan</span>

        <span class="c1"># get list of which spws, antennas and scans we have data for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spws</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_antennas</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">antenna</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scans</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">allowed</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not in caltable data&#39;</span> <span class="o">%</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mask</span>

    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">antenna</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scan</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># LOG.trace(&#39;filter(spw=%s, antenna=%s, scan=%s)&#39; % (spw, antenna, scan))</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spws</span>
        <span class="k">if</span> <span class="n">antenna</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">antenna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_antennas</span>
        <span class="k">if</span> <span class="n">scan</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scans</span>

        <span class="c1"># get data selection mask for each selection parameter</span>
        <span class="n">antenna_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span>
        <span class="n">spw_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw</span><span class="p">)</span>
        <span class="n">scan_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_mask</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span>

        <span class="c1"># combine masks to create final data selection mask</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">antenna_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spw_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">scan_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># find data for the selection mask</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">antenna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scan</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># create new object for the filtered data</span>
        <span class="k">return</span> <span class="n">CaltableWrapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">antenna</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">scan</span><span class="p">)</span></div>



<div class="viewcode-block" id="PhaseVsBaselineData">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.PhaseVsBaselineData.html#pipeline.h.tasks.common.displays.common.PhaseVsBaselineData">[docs]</a>
<span class="k">class</span> <span class="nc">PhaseVsBaselineData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">,</span> <span class="n">corr_id</span><span class="p">,</span> <span class="n">refant_id</span><span class="p">):</span>
        <span class="c1"># While it is possible to do so, we shouldn&#39;t calculate statistics for</span>
        <span class="c1"># mixed antennas/spws/scans.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No antennas defined in data selection&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No spw defined in data selection&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slice contains multiple antennas. Got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slice contains multiple spws. Got </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">)</span>
        <span class="c1">#        assert len(set(data.scan)) is 1, &#39;Data slice contains multiple scans&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_for_corr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="n">corr_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_for_corr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No data for spw </span><span class="si">%s</span><span class="s1"> ant </span><span class="si">%s</span><span class="s1"> scan </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                                    <span class="n">data</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr</span> <span class="o">=</span> <span class="n">corr_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refant</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">refant_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">baselines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baselines_for_antennas</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median_baseline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baselines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_baseline</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baselines</span><span class="p">)</span>

        <span class="n">this_antenna_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_to_refant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_lookup</span><span class="p">[</span><span class="n">refant_id</span><span class="p">][</span><span class="n">this_antenna_id</span><span class="p">]</span>

        <span class="c1"># backing for on-demand properties. It is very likely that these could be</span>
        <span class="c1"># made simple instance properties but they are kept on-demand to avoid</span>
        <span class="c1"># introducing additional risk into PIPE-1823.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_offsets_from_median</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rms_offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_rms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_median_offset</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_safe_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">calculation</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely calculate the RMS of a numpy masked array, logging any</span>
<span class="sd">        error and skipping to the next value if an error occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">rms</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">err_handler</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="n">ant</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">scan</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Floating point error (</span><span class="si">%s</span><span class="s1">) calculating </span><span class="si">%s</span><span class="s1"> for&#39;</span>
                        <span class="s1">&#39; Scan </span><span class="si">%s</span><span class="s1"> Spw </span><span class="si">%s</span><span class="s1"> Ant </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">calculation</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">ant</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rms</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
            <span class="n">saved_handler</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">seterrcall</span><span class="p">(</span><span class="n">err_handler</span><span class="p">(</span><span class="n">calculation</span><span class="p">))</span>
            <span class="n">saved_err</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s1">&#39;call&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rms</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterrcall</span><span class="p">(</span><span class="n">saved_handler</span><span class="p">)</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="o">**</span><span class="n">saved_err</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">scan</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_corr_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unwrapped_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rads</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_for_corr</span><span class="p">)</span>
            <span class="n">unwrapped_rads</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">rads</span><span class="p">)</span>
            <span class="n">unwrapped_degs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">unwrapped_rads</span><span class="p">)</span>
            <span class="c1"># the operation above removed the mask, so add it back.</span>
            <span class="n">remasked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">unwrapped_degs</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_for_corr</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_data</span> <span class="o">=</span> <span class="n">remasked</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">offsets_from_median</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets_from_median</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">unwrapped_degs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unwrapped_data</span>
            <span class="n">deg_offsets</span> <span class="o">=</span> <span class="n">unwrapped_degs</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">unwrapped_degs</span><span class="p">)</span>
            <span class="c1"># the operation above removed the mask, so add it back.</span>
            <span class="n">remasked</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">(</span><span class="n">deg_offsets</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_for_corr</span><span class="o">.</span><span class="n">mask</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_offsets_from_median</span> <span class="o">=</span> <span class="n">remasked</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offsets_from_median</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rms_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rms_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rms_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_rms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets_from_median</span><span class="p">,</span> <span class="s2">&quot;RMS offset&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rms_offset</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">unwrapped_rms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_rms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_rms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unwrapped_data</span><span class="p">,</span> <span class="s2">&quot;unwrapped RMS&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unwrapped_rms</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">median_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_median_offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abs_offset</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offsets_from_median</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_median_offset</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">abs_offset</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_median_offset</span></div>



<div class="viewcode-block" id="XYData">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.XYData.html#pipeline.h.tasks.common.displays.common.XYData">[docs]</a>
<span class="k">class</span> <span class="nc">XYData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delegate</span><span class="p">,</span> <span class="n">x_axis</span><span class="p">,</span> <span class="n">y_axis</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span> <span class="o">=</span> <span class="n">delegate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__x_axis</span> <span class="o">=</span> <span class="n">x_axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__y_axis</span> <span class="o">=</span> <span class="n">y_axis</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">antenna</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">corr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">ratio</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">scan</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="o">.</span><span class="n">spw</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__x_axis</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__delegate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__y_axis</span><span class="p">)</span></div>



<div class="viewcode-block" id="DataRatio">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.DataRatio.html#pipeline.h.tasks.common.displays.common.DataRatio">[docs]</a>
<span class="k">class</span> <span class="nc">DataRatio</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
        <span class="c1"># test symmetric differences to find data selection errors</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">antenna</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slices are for different antennas&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span> <span class="o">^</span> <span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">scan</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slices are for different scans&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">before</span><span class="o">.</span><span class="n">spw</span> <span class="o">!=</span> <span class="n">after</span><span class="o">.</span><span class="n">spw</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slices are for different spws&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">before</span><span class="o">.</span><span class="n">corr</span> <span class="o">!=</span> <span class="n">after</span><span class="o">.</span><span class="n">corr</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data slices are for different correlations&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__before</span> <span class="o">=</span> <span class="n">before</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__after</span> <span class="o">=</span> <span class="n">after</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__antennas</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">antenna</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__spws</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">spw</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__scans</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">scan</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">after</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">scan</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__corr</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">((</span><span class="n">before</span><span class="o">.</span><span class="n">corr</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">corr</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="n">cachetools</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__after</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antennas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__antennas</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__before</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">corr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__corr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__scans</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spws</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__before</span><span class="o">.</span><span class="n">x</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">__after</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__before</span><span class="o">.</span><span class="n">x</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">num_corr_axes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># having ensured the before/after data are for the same scan and spw,</span>
        <span class="c1"># they should have the same number of correlations</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__before</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="nd">@cachetools</span><span class="o">.</span><span class="n">cachedmethod</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;_cache&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">y</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">before</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__before</span><span class="o">.</span><span class="n">y</span>
        <span class="n">after</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__after</span><span class="o">.</span><span class="n">y</span>

        <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># avoid divide by zero</span>
        <span class="k">if</span> <span class="n">after</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">before</span> <span class="o">/</span> <span class="n">after</span></div>



<div class="viewcode-block" id="NullScoreFinder">
<a class="viewcode-back" href="../../../../../../_autosummary/pipeline.h.tasks.common.displays.common.NullScoreFinder.html#pipeline.h.tasks.common.displays.common.NullScoreFinder">[docs]</a>
<span class="k">class</span> <span class="nc">NullScoreFinder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>