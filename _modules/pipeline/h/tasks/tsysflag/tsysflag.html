

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.h.tasks.tsysflag.tsysflag &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Pipeline Tasks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../pipeline_tasks/pipeline_tasks.html">Pipeline Heuristics Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task (sphinx-autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.h.cli.html">pipeline.h.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hif.cli.html">pipeline.hif.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifa.cli.html">pipeline.hifa.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hifv.cli.html">pipeline.hifv.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsd.cli.html">pipeline.hsd.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.hsdn.cli.html">pipeline.hsdn.cli</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Task Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html"><code class="docutils literal notranslate"><span class="pre">pipeline.hifa.tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif.tasks"><code class="docutils literal notranslate"><span class="pre">pipeline.hif.tasks</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#module-pipeline.hif"><code class="docutils literal notranslate"><span class="pre">pipeline.hif</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../task_classes.html#pipeline-inheritance-diagrams">Pipeline Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.h.tasks.tsysflag.tsysflag</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.h.tasks.tsysflag.tsysflag</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">casatasks.private</span> <span class="kn">import</span> <span class="n">flaghelper</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.callibrary</span> <span class="k">as</span> <span class="nn">callibrary</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.vdp</span> <span class="k">as</span> <span class="nn">vdp</span>
<span class="kn">from</span> <span class="nn">pipeline.h.heuristics.tsysnormalize</span> <span class="kn">import</span> <span class="n">tsysNormalize</span>
<span class="kn">from</span> <span class="nn">pipeline.h.tasks.common</span> <span class="kn">import</span> <span class="n">calibrationtableaccess</span> <span class="k">as</span> <span class="n">caltableaccess</span><span class="p">,</span> \
    <span class="n">commonhelpermethods</span><span class="p">,</span> <span class="n">commonresultobjects</span><span class="p">,</span> <span class="n">viewflaggers</span>
<span class="kn">from</span> <span class="nn">pipeline.h.tasks.flagging.flagdatasetter</span> <span class="kn">import</span> <span class="n">FlagdataSetter</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">task_registry</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.refantflag</span> <span class="kn">import</span> <span class="n">identify_fully_flagged_antennas_from_flagview</span><span class="p">,</span> \
    <span class="n">mark_antennas_for_refant_update</span><span class="p">,</span> <span class="n">aggregate_fully_flagged_antenna_notifications</span>
<span class="kn">from</span> <span class="nn">.resultobjects</span> <span class="kn">import</span> <span class="n">TsysflagResults</span><span class="p">,</span> <span class="n">TsysflagspectraResults</span><span class="p">,</span> <span class="n">TsysflagDataResults</span><span class="p">,</span> <span class="n">TsysflagViewResults</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Tsysflag&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TsysflagInputs&#39;</span>
<span class="p">]</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_normalized_caltable</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">caltable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create normalized Tsys caltable and return filename.&quot;&quot;&quot;</span>
    <span class="n">norm_caltable</span> <span class="o">=</span> <span class="n">caltable</span> <span class="o">+</span> <span class="s1">&#39;_normalized&#39;</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating normalized Tsys table </span><span class="si">{}</span><span class="s2"> to use for assessing new flags.</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="s2">&quot;Newly found flags will also be applied to Tsys table </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">norm_caltable</span><span class="p">,</span> <span class="n">caltable</span><span class="p">))</span>

    <span class="c1"># Run the tsys normalization script.</span>
    <span class="n">tsysNormalize</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">tsysTable</span><span class="o">=</span><span class="n">caltable</span><span class="p">,</span> <span class="n">newTsysTable</span><span class="o">=</span><span class="n">norm_caltable</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">norm_caltable</span>


<span class="k">def</span> <span class="nf">_identify_testable_metrics</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">testable_metrics</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">testable_metrics_completed</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">metric_order</span>
                                      <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">testable_metrics</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="n">testable_metrics_completed</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">testable_metrics_completed</span>


<span class="k">def</span> <span class="nf">_read_tsystemplate</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return flag commands read in from manual Tsys flag template file.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">flagcmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - manual Tsys flagtemplate file &#39;</span><span class="si">{}</span><span class="s2">&#39; not found; no manual flags applied for this MS.&quot;</span>
                    <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flagcmds</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span> <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="n">flaghelper</span><span class="o">.</span><span class="n">readFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cmd</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">whitespace</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">)]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - found manual Tsys flagtemplate file &#39;</span><span class="si">{}</span><span class="s2">&#39;, with </span><span class="si">{}</span><span class="s2"> flag(s) to apply.&quot;</span>
                 <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagcmds</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">flagcmds</span>


<div class="viewcode-block" id="TsysflagInputs">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.h.tasks.tsysflag.html#pipeline.h.tasks.tsysflag.tsysflag.TsysflagInputs">[docs]</a>
<span class="k">class</span> <span class="nc">TsysflagInputs</span><span class="p">(</span><span class="n">vdp</span><span class="o">.</span><span class="n">StandardInputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TsysflagInputs defines the inputs for the Tsysflag pipeline task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">caltable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">caltables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">callibrary</span><span class="o">.</span><span class="n">active</span><span class="o">.</span><span class="n">get_caltable</span><span class="p">(</span>
            <span class="n">caltypes</span><span class="o">=</span><span class="s1">&#39;tsys&#39;</span><span class="p">)</span>

        <span class="c1"># return just the tsys table that matches the vis being handled</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">caltables</span><span class="p">:</span>
            <span class="c1"># Get the tsys table name</span>
            <span class="n">tsystable_vis</span> <span class="o">=</span> \
                <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">_readvis</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tsystable_vis</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">fb_sharps_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="n">fd_max_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">fe_edge_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
    <span class="n">ff_max_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
    <span class="n">ff_refintent</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">)</span>

    <span class="nd">@vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span>
    <span class="k">def</span> <span class="nf">filetemplate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">vis_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">vis_root</span> <span class="o">+</span> <span class="s1">&#39;.flagtsystemplate.txt&#39;</span>

    <span class="n">flag_birdies</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flag_derivative</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flag_edgechans</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flag_fieldshape</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flag_nmedian</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">flag_toomany</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fnm_byfield</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fnm_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="n">metric_order</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;nmedian, derivative, edgechans, fieldshape, birdies, toomany&#39;</span><span class="p">)</span>
    <span class="n">normalize_tsys</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">tmf1_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.666</span><span class="p">)</span>
    <span class="n">tmef1_limit</span> <span class="o">=</span> <span class="n">vdp</span><span class="o">.</span><span class="n">VisDependentProperty</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.666</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">caltable</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_nmedian</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fnm_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fnm_byfield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_derivative</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fd_max_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_edgechans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fe_edge_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_fieldshape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ff_refintent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ff_max_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_birdies</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fb_sharps_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flag_toomany</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmf1_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tmef1_limit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">metric_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">normalize_tsys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filetemplate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TsysflagInputs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># pipeline inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="c1"># vis must be set first, as other properties may depend on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

        <span class="c1"># data selection arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caltable</span> <span class="o">=</span> <span class="n">caltable</span>

        <span class="c1"># solution parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalize_tsys</span> <span class="o">=</span> <span class="n">normalize_tsys</span>

        <span class="c1"># flagging parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filetemplate</span> <span class="o">=</span> <span class="n">filetemplate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_nmedian</span> <span class="o">=</span> <span class="n">flag_nmedian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnm_limit</span> <span class="o">=</span> <span class="n">fnm_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnm_byfield</span> <span class="o">=</span> <span class="n">fnm_byfield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_derivative</span> <span class="o">=</span> <span class="n">flag_derivative</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_nmedian</span> <span class="o">=</span> <span class="n">flag_nmedian</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd_max_limit</span> <span class="o">=</span> <span class="n">fd_max_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_edgechans</span> <span class="o">=</span> <span class="n">flag_edgechans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_edge_limit</span> <span class="o">=</span> <span class="n">fe_edge_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_fieldshape</span> <span class="o">=</span> <span class="n">flag_fieldshape</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_refintent</span> <span class="o">=</span> <span class="n">ff_refintent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ff_max_limit</span> <span class="o">=</span> <span class="n">ff_max_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_birdies</span> <span class="o">=</span> <span class="n">flag_birdies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fb_sharps_limit</span> <span class="o">=</span> <span class="n">fb_sharps_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flag_toomany</span> <span class="o">=</span> <span class="n">flag_toomany</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmf1_limit</span> <span class="o">=</span> <span class="n">tmf1_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmef1_limit</span> <span class="o">=</span> <span class="n">tmef1_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric_order</span> <span class="o">=</span> <span class="n">metric_order</span></div>



<div class="viewcode-block" id="Tsysflag">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.h.tasks.tsysflag.html#pipeline.h.tasks.tsysflag.tsysflag.Tsysflag">[docs]</a>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_equivalent_casa_task</span><span class="p">(</span><span class="s1">&#39;h_tsysflag&#39;</span><span class="p">)</span>
<span class="nd">@task_registry</span><span class="o">.</span><span class="n">set_casa_commands_comment</span><span class="p">(</span><span class="s1">&#39;The Tsys calibration and spectral window map is computed.&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Tsysflag</span><span class="p">(</span><span class="n">basetask</span><span class="o">.</span><span class="n">StandardTaskTemplate</span><span class="p">):</span>
    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">TsysflagInputs</span>

<div class="viewcode-block" id="Tsysflag.prepare">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.h.tasks.tsysflag.html#pipeline.h.tasks.tsysflag.tsysflag.Tsysflag.prepare">[docs]</a>
    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Initialize the final result and store caltable to flag and its</span>
        <span class="c1"># associated vis in result.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TsysflagResults</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">caltable</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span>
        <span class="n">result</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">_readvis</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">metric_order</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Assess Tsys caltable to warn in case any scans were fully flagged</span>
        <span class="c1"># prior to evaluation of Tsysflag heuristics.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_about_prior_flags</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">)</span>

        <span class="c1"># If requested, create a normalized Tsys caltable and mark this as the</span>
        <span class="c1"># table to use for determining flags.</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">normalize_tsys</span><span class="p">:</span>
            <span class="n">caltable_to_assess</span> <span class="o">=</span> <span class="n">_create_normalized_caltable</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">caltable_to_assess</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span>
        <span class="n">result</span><span class="o">.</span><span class="n">caltable_assessed</span> <span class="o">=</span> <span class="n">caltable_to_assess</span>

        <span class="c1"># Run manual flagging.</span>
        <span class="k">if</span> <span class="n">inputs</span><span class="o">.</span><span class="n">filetemplate</span><span class="p">:</span>
            <span class="n">mresults</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_manual_flagging</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">metric_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;manual&#39;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="n">mresults</span><span class="p">)</span>

        <span class="c1"># Run flagging heuristics.</span>
        <span class="n">hresults</span><span class="p">,</span> <span class="n">metric_order</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_flagging_heuristics</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">)</span>
        <span class="c1"># Return early if an error message was returned.</span>
        <span class="k">if</span> <span class="n">errmsg</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">task_incomplete_reason</span> <span class="o">=</span> <span class="n">errmsg</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Store each metric result in final result.</span>
            <span class="k">for</span> <span class="n">metric</span><span class="p">,</span> <span class="n">metric_result</span> <span class="ow">in</span> <span class="n">hresults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_result</span><span class="p">)</span>
            <span class="c1"># Store order of metrics in result.</span>
            <span class="n">result</span><span class="o">.</span><span class="n">metric_order</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">metric_order</span><span class="p">)</span>

        <span class="c1"># handle use as a child task where all flags are calculated externally</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_order</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s1">&#39;manual&#39;</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">metric_order</span><span class="p">:</span>
            <span class="n">metric_order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;manual&#39;</span><span class="p">]</span>

        <span class="c1"># Extract before and after flagging summaries from first and last metric:</span>
        <span class="n">stats_before</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">metric_order</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">summaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stats_after</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">metric_order</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">summaries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Add the &quot;before&quot; and &quot;after&quot; flagging summaries to the final result</span>
        <span class="n">result</span><span class="o">.</span><span class="n">summaries</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats_before</span><span class="p">,</span> <span class="n">stats_after</span><span class="p">]</span>

        <span class="c1"># If the caltable to apply differs from the caltable that was used</span>
        <span class="c1"># to assess flagging, then apply the newly found flags to the caltable</span>
        <span class="c1"># to apply.</span>
        <span class="k">if</span> <span class="n">caltable_to_assess</span> <span class="o">!=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying flags found for </span><span class="si">{}</span><span class="s2"> to the original caltable </span><span class="si">{}</span><span class="s2">&quot;</span>
                     <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_flags_orig_caltable</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="Tsysflag.analyse">
<a class="viewcode-back" href="../../../../../_apidoc/pipeline.h.tasks.tsysflag.html#pipeline.h.tasks.tsysflag.tsysflag.Tsysflag.analyse">[docs]</a>
    <span class="k">def</span> <span class="nf">analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyses the Tsysflag result.</span>

<span class="sd">        :param result: TsysflagResults object</span>
<span class="sd">        :return: TsysflagResults object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the task ended prematurely, then no need to analyse the result</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">task_incomplete_reason</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_identify_refants_to_update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


    <span class="k">def</span> <span class="nf">_apply_flags_orig_caltable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">components</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Create list of all flagging commands.</span>
        <span class="n">flagcmds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="n">components</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">flagcmds</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">flagging</span><span class="p">)</span>

        <span class="c1"># Create and execute flagsetter task for original caltable.</span>
        <span class="n">flagsetterinputs</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">,</span> <span class="n">inpfile</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">flagsettertask</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="p">(</span><span class="n">flagsetterinputs</span><span class="p">)</span>
        <span class="n">flagsettertask</span><span class="o">.</span><span class="n">flags_to_set</span><span class="p">(</span><span class="n">flagcmds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flagsettertask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_identify_refants_to_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the Tsysflag result with lists of antennas to remove from the</span>
<span class="sd">        reference antenna list, or to demote to end of the reference antenna list,</span>
<span class="sd">        due to being fully flagged in any or all Tsys spws.</span>

<span class="sd">        :param result: TsysflagResults object</span>
<span class="sd">        :return: TsysflagResults object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># List of 2D metrics that may be used to identify flagged antennas.</span>
        <span class="n">testable_metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nmedian&#39;</span><span class="p">,</span> <span class="s1">&#39;derivative&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldshape&#39;</span><span class="p">,</span> <span class="s1">&#39;toomany&#39;</span><span class="p">]</span>

        <span class="c1"># Identify whether any testable metrics were completed.</span>
        <span class="n">testable_metrics_completed</span> <span class="o">=</span> <span class="n">_identify_testable_metrics</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">testable_metrics</span><span class="p">)</span>

        <span class="c1"># If any of the testable metrics were completed...</span>
        <span class="k">if</span> <span class="n">testable_metrics_completed</span><span class="p">:</span>
            <span class="c1"># Get the MS object</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>

            <span class="c1"># Pick the testable metric that ran last.</span>
            <span class="n">metric_to_test</span> <span class="o">=</span> <span class="n">testable_metrics_completed</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Using metric &#39;</span><span class="si">{0}</span><span class="s2">&#39; to evaluate if any antennas were&quot;</span>
                      <span class="s2">&quot; entirely flagged.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_to_test</span><span class="p">))</span>

            <span class="c1"># Get the science spw ids from the MS.</span>
            <span class="n">science_spw_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>

            <span class="c1"># Using the CalTo object in the TsysflagspectraResults from the</span>
            <span class="c1"># last-ran testable metric, identify which are the Tsys spectral windows.</span>
            <span class="n">calto</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">metric_to_test</span><span class="p">]</span><span class="o">.</span><span class="n">final</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tsys_spw_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tsys</span> <span class="k">for</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">tsys</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">calto</span><span class="o">.</span><span class="n">spwmap</span><span class="p">)</span>
                               <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">science_spw_ids</span> <span class="ow">and</span> <span class="n">spw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">unmappedspws</span><span class="p">)</span>

            <span class="c1"># Create field ID to name translation.</span>
            <span class="n">field_id_to_name</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>

            <span class="c1"># Create the translation between scan times (which enumerate scans) and field names.</span>
            <span class="n">tsystable</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">getcal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span><span class="p">)</span>
            <span class="n">scan_time_to_field_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">):</span> <span class="n">field_id_to_name</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FIELD_ID&#39;</span><span class="p">)]</span>
                                                          <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">rows</span><span class="p">}</span>

            <span class="c1"># Identify antennas that are fully flagged in all scans in any combination of field/intent/spw.</span>
            <span class="n">fully_flagged_antennas</span> <span class="o">=</span> <span class="n">identify_fully_flagged_antennas_from_flagview</span><span class="p">(</span>
                <span class="n">ms</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">components</span><span class="p">[</span><span class="n">metric_to_test</span><span class="p">],</span> <span class="n">scan_time_to_field_names</span><span class="p">,</span>
                <span class="n">intents_of_interest</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">))</span>

            <span class="c1"># Update result to mark antennas for demotion/removal as refant.</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">mark_antennas_for_refant_update</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">fully_flagged_antennas</span><span class="p">,</span> <span class="n">tsys_spw_ids</span><span class="p">)</span>

            <span class="c1"># Aggregate the list of fully flagged antennas by intent, field and spw for subsequent QA scoring</span>
            <span class="n">result</span><span class="o">.</span><span class="n">fully_flagged_antenna_notifications</span> <span class="o">=</span> <span class="n">aggregate_fully_flagged_antenna_notifications</span><span class="p">(</span>
                <span class="n">fully_flagged_antennas</span><span class="p">,</span> <span class="n">tsys_spw_ids</span><span class="p">)</span>

        <span class="c1"># If no testable metrics were completed, then log a trace warning that</span>
        <span class="c1"># no evaluation of fully flagged antennas was performed.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s2">&quot;Cannot test if any antennas were entirely flagged&quot;</span>
                      <span class="s2">&quot; since none of the following flagging metrics were&quot;</span>
                      <span class="s2">&quot; evaluated: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">testable_metrics</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_run_manual_flagging</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">caltable_to_assess</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Initialize results object, and add caltable from inputs.</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">caltable</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span>
        <span class="n">result</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">caltable_to_assess</span>

        <span class="c1"># Save a snapshot of the inputs of the datatask. These are required for the renderer.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">task_counter</span>

        <span class="c1"># Load the tsys caltable to assess.</span>
        <span class="n">tsystable</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">getcal</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">)</span>

        <span class="c1"># Store the vis from the tsystable in the result</span>
        <span class="n">result</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">vis</span>

        <span class="c1"># Get the Tsys spw map by retrieving it from the first tsys CalFrom</span>
        <span class="c1"># that is present in the callibrary.</span>
        <span class="n">spwmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_calfroms</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s1">&#39;tsys&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spwmap</span>

        <span class="c1"># Construct a callibrary entry, and store in result. This entry was</span>
        <span class="c1"># already created and merged into the context by tsyscal, but we</span>
        <span class="c1"># recreate it here since it is needed by the weblog renderer to create</span>
        <span class="c1"># a Tsys summary chart.</span>
        <span class="n">calto</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalTo</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">calfrom</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalFrom</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">,</span> <span class="n">caltype</span><span class="o">=</span><span class="s1">&#39;tsys&#39;</span><span class="p">,</span> <span class="n">spwmap</span><span class="o">=</span><span class="n">spwmap</span><span class="p">)</span>
        <span class="n">calapp</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">(</span><span class="n">calto</span><span class="p">,</span> <span class="n">calfrom</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="p">[</span><span class="n">calapp</span><span class="p">]</span>

        <span class="c1"># Read in manual Tsys flags and add to result.</span>
        <span class="n">flagcmds</span> <span class="o">=</span> <span class="n">_read_tsystemplate</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">filetemplate</span><span class="p">,</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">addflags</span><span class="p">(</span><span class="n">flagcmds</span><span class="p">)</span>

        <span class="c1"># Apply manual Tsys flags, and add flagging summaries to result.</span>
        <span class="n">summaries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_manual_tsysflags</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">,</span> <span class="n">flagcmds</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">summaries</span> <span class="o">=</span> <span class="n">summaries</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">_apply_manual_tsysflags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">flagcmds</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Initialize flagging summaries.</span>
        <span class="n">stats_before</span><span class="p">,</span> <span class="n">stats_after</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

        <span class="c1"># Add before and after summary to flag commands.</span>
        <span class="n">flagcmds</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;mode=&#39;summary&#39; name=&#39;before&#39;&quot;</span><span class="p">)</span>
        <span class="n">flagcmds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;mode=&#39;summary&#39; name=&#39;after&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># Create and execute flagdata command.</span>
        <span class="n">flagsetterinputs</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">inpfile</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">flagsettertask</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="p">(</span><span class="n">flagsetterinputs</span><span class="p">)</span>
        <span class="n">flagsettertask</span><span class="o">.</span><span class="n">flags_to_set</span><span class="p">(</span><span class="n">flagcmds</span><span class="p">)</span>
        <span class="n">fsresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flagsettertask</span><span class="p">)</span>

        <span class="c1"># If no reports are found, then the flagdata call went wrong somehow, e.g. due</span>
        <span class="c1"># to a typo in the flagtsystemplate file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">(</span><span class="n">fsresult</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - Unexpected empty result from &#39;flagdata&#39; while applying manual flags. Manual flags may not&quot;</span>
                      <span class="s2">&quot; (all) have been applied. Please check template file </span><span class="si">{}</span><span class="s2"> for typos.&quot;</span>
                      <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">filetemplate</span><span class="p">)))</span>

            <span class="c1"># Run separate flagdata call to create the before/after summary required by weblog rendering.</span>
            <span class="n">flagsetterinputs</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">tsystable</span><span class="p">,</span>
                                                     <span class="n">inpfile</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mode=&#39;summary&#39; name=&#39;before&#39;&quot;</span><span class="p">,</span>
                                                              <span class="s2">&quot;mode=&#39;summary&#39; name=&#39;after&#39;&quot;</span><span class="p">])</span>
            <span class="n">flagsettertask</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="p">(</span><span class="n">flagsetterinputs</span><span class="p">)</span>
            <span class="n">fsresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flagsettertask</span><span class="p">)</span>

        <span class="c1"># Extract &quot;before&quot; and/or &quot;after&quot; summary</span>
        <span class="c1"># Go through dictionary of reports...</span>
        <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">fsresult</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;before&#39;</span><span class="p">:</span>
                <span class="n">stats_before</span> <span class="o">=</span> <span class="n">report</span>
            <span class="k">if</span> <span class="n">report</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;after&#39;</span><span class="p">:</span>
                <span class="n">stats_after</span> <span class="o">=</span> <span class="n">report</span>

        <span class="k">return</span> <span class="n">stats_before</span><span class="p">,</span> <span class="n">stats_after</span>

    <span class="k">def</span> <span class="nf">_run_flagging_heuristics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">):</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Initialize output.</span>
        <span class="n">errmsg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">ordered_list_metrics_to_evaluate</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Collect requested flag metrics from inputs into a dictionary.</span>
        <span class="c1"># NOTE: each key in the dictionary below should have been added to</span>
        <span class="c1"># the default value for the &quot;metric_order&quot; property in TsysflagInputs,</span>
        <span class="c1"># or otherwise the Tsysflag task will always end prematurely for</span>
        <span class="c1"># automatic pipeline runs.</span>
        <span class="n">metrics_from_inputs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;nmedian&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_nmedian</span><span class="p">,</span>
                               <span class="s1">&#39;derivative&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_derivative</span><span class="p">,</span>
                               <span class="s1">&#39;edgechans&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_edgechans</span><span class="p">,</span>
                               <span class="s1">&#39;fieldshape&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_fieldshape</span><span class="p">,</span>
                               <span class="s1">&#39;birdies&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_birdies</span><span class="p">,</span>
                               <span class="s1">&#39;toomany&#39;</span><span class="p">:</span> <span class="n">inputs</span><span class="o">.</span><span class="n">flag_toomany</span><span class="p">}</span>

        <span class="c1"># Convert metric order string to list of strings</span>
        <span class="n">metric_order_as_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">metric_order</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="c1"># If the input metric order list contains illegal values, then log</span>
        <span class="c1"># an error and stop further evaluation of Tsysflag.</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_order_as_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metrics_from_inputs</span><span class="p">:</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Input parameter &#39;metric_order&#39; contains illegal value:&quot;</span>
                    <span class="s2">&quot; &#39;</span><span class="si">{0}</span><span class="s2">&#39;. Accepted values are: </span><span class="si">{1}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">metrics_from_inputs</span><span class="p">)))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">ordered_list_metrics_to_evaluate</span><span class="p">,</span> <span class="n">errmsg</span>

        <span class="c1"># If any of the requested metrics are not defined in the metric order,</span>
        <span class="c1"># then log an error and stop further evaluation of Tsysflag.</span>
        <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">metric_enabled</span> <span class="ow">in</span> <span class="n">metrics_from_inputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">metric_enabled</span> <span class="ow">and</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metric_order_as_list</span><span class="p">:</span>
                <span class="n">errmsg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;Flagging metric &#39;</span><span class="si">{0}</span><span class="s2">&#39; is enabled, but not specified in&quot;</span>
                    <span class="s2">&quot; &#39;metric_order&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric_name</span><span class="p">))</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">ordered_list_metrics_to_evaluate</span><span class="p">,</span> <span class="n">errmsg</span>

        <span class="c1"># Convert requested flagging metrics to ordered list.</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_order_as_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics_from_inputs</span><span class="p">[</span><span class="n">metric</span><span class="p">]:</span>
                <span class="n">ordered_list_metrics_to_evaluate</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>

        <span class="c1"># Run flagger for each metric.</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">ordered_list_metrics_to_evaluate</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_flagger</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">ordered_list_metrics_to_evaluate</span><span class="p">,</span> <span class="n">errmsg</span>

    <span class="k">def</span> <span class="nf">_run_flagger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">caltable_to_assess</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the Tsys spectra for a specified flagging metric.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        metric      -- string : represents the flagging metric to evaluate. </span>
<span class="sd">                       Valid values: &#39;nmedian&#39;, &#39;derivative&#39;, &#39;edgechans&#39;, </span>
<span class="sd">                       &#39;fieldshape&#39;, &#39;birdies&#39;, &#39;toomany&#39;.</span>
<span class="sd">        caltable_to_assess -- string : represents the caltable that is to </span>
<span class="sd">                              used for assessing required flagging. </span>

<span class="sd">        Returns:</span>
<span class="sd">        TsysflagspectraResults object containing the flagging views and flagging</span>
<span class="sd">        results for the requested metric.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flag &#39;</span><span class="o">+</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span>

        <span class="c1"># Initialize results object</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">view_by_field</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Load the tsys caltable to assess.</span>
        <span class="n">tsystable</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">getcal</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">)</span>

        <span class="c1"># Store the vis from the tsystable in the result</span>
        <span class="n">result</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">vis</span>

        <span class="c1"># Get the Tsys spw map by retrieving it from the first tsys CalFrom </span>
        <span class="c1"># that is present in the callibrary. </span>
        <span class="n">spwmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_calfroms</span><span class="p">(</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s1">&#39;tsys&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spwmap</span>

        <span class="c1"># Construct a callibrary entry, and store in result. This entry was</span>
        <span class="c1"># already created and merged into the context by tsyscal, but we</span>
        <span class="c1"># recreate it here since it is needed by the weblog renderer to create</span>
        <span class="c1"># a Tsys summary chart.</span>
        <span class="n">calto</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalTo</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>
        <span class="n">calfrom</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalFrom</span><span class="p">(</span><span class="n">caltable_to_assess</span><span class="p">,</span> <span class="n">caltype</span><span class="o">=</span><span class="s1">&#39;tsys&#39;</span><span class="p">,</span> <span class="n">spwmap</span><span class="o">=</span><span class="n">spwmap</span><span class="p">)</span>
        <span class="n">calapp</span> <span class="o">=</span> <span class="n">callibrary</span><span class="o">.</span><span class="n">CalApplication</span><span class="p">(</span><span class="n">calto</span><span class="p">,</span> <span class="n">calfrom</span><span class="p">)</span>
        <span class="n">result</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="p">[</span><span class="n">calapp</span><span class="p">]</span>

        <span class="c1"># Construct the task that will read the data and create the</span>
        <span class="c1"># view of the data that is the basis for flagging.</span>
        <span class="n">datainputs</span> <span class="o">=</span> <span class="n">TsysflagDataInputs</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span>
                                        <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span>
                                        <span class="n">caltable</span><span class="o">=</span><span class="n">caltable_to_assess</span><span class="p">)</span>
        <span class="n">datatask</span> <span class="o">=</span> <span class="n">TsysflagData</span><span class="p">(</span><span class="n">datainputs</span><span class="p">)</span>

        <span class="c1"># Construct the generator that will create the view of the data</span>
        <span class="c1"># that is the basis for flagging. Update result to indicate whether</span>
        <span class="c1"># separate views are created per field.</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;fieldshape&#39;</span><span class="p">:</span>
            <span class="n">viewtask</span> <span class="o">=</span> <span class="n">TsysflagView</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span>
                                    <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                    <span class="n">refintent</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">ff_refintent</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;nmedian&#39;</span><span class="p">:</span>
            <span class="n">viewtask</span> <span class="o">=</span> <span class="n">TsysflagView</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span>
                                    <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
                                    <span class="n">split_by_field</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">fnm_byfield</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">view_by_field</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">fnm_byfield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">viewtask</span> <span class="o">=</span> <span class="n">TsysflagView</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span>
                                    <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>

        <span class="c1"># Construct the task that will set any flags raised in the</span>
        <span class="c1"># underlying data.</span>
        <span class="n">flagsetterinputs</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">caltable_to_assess</span><span class="p">,</span>
            <span class="n">inpfile</span><span class="o">=</span><span class="p">[])</span>
        <span class="n">flagsettertask</span> <span class="o">=</span> <span class="n">FlagdataSetter</span><span class="p">(</span><span class="n">flagsetterinputs</span><span class="p">)</span>

        <span class="c1"># Depending on the flagging metric, select the appropriate type of </span>
        <span class="c1"># flagger task (Vector vs. Matrix)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nmedian&#39;</span><span class="p">,</span> <span class="s1">&#39;derivative&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldshape&#39;</span><span class="p">,</span> <span class="s1">&#39;toomany&#39;</span><span class="p">]:</span>
            <span class="n">flagger</span> <span class="o">=</span> <span class="n">viewflaggers</span><span class="o">.</span><span class="n">MatrixFlagger</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;birdies&#39;</span><span class="p">,</span> <span class="s1">&#39;edgechans&#39;</span><span class="p">]:</span>
            <span class="n">flagger</span> <span class="o">=</span> <span class="n">viewflaggers</span><span class="o">.</span><span class="n">VectorFlagger</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown metric in TsysFlagger&#39;</span><span class="p">)</span>

        <span class="c1"># Depending on the flagging metric, translate the appropriate input</span>
        <span class="c1"># flagging parameters to a more compact list of flagging rules.</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;nmedian&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_nmedian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fnm_hi_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">fnm_limit</span><span class="p">,</span>
                <span class="n">fnm_lo_limit</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_maxabs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmax_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">fd_max_limit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;fieldshape&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_maxabs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmax_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">ff_max_limit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;birdies&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_sharps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharps_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">fb_sharps_limit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;edgechans&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_edges</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">edge_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">fe_edge_limit</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;toomany&#39;</span><span class="p">:</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">make_flag_rules</span><span class="p">(</span>
                <span class="n">flag_tmf1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tmf1_axis</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span>
                <span class="n">tmf1_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">tmf1_limit</span><span class="p">,</span>
                <span class="n">flag_tmef1</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tmef1_axis</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span>
                <span class="n">tmef1_limit</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">tmef1_limit</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unknown metric in TsysFlagger&#39;</span><span class="p">)</span>

        <span class="c1"># Construct the flagger task around the data view task and the</span>
        <span class="c1"># flagsetter task.</span>
        <span class="n">flaggerinputs</span> <span class="o">=</span> <span class="n">flagger</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="n">output_dir</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_dir</span><span class="p">,</span>
            <span class="n">vis</span><span class="o">=</span><span class="n">inputs</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="n">datatask</span><span class="o">=</span><span class="n">datatask</span><span class="p">,</span> <span class="n">viewtask</span><span class="o">=</span><span class="n">viewtask</span><span class="p">,</span>
            <span class="n">flagsettertask</span><span class="o">=</span><span class="n">flagsettertask</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="n">rules</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">prepend</span><span class="o">=</span><span class="s1">&#39;flag </span><span class="si">{0}</span><span class="s1"> - &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="n">flaggertask</span> <span class="o">=</span> <span class="n">flagger</span><span class="p">(</span><span class="n">flaggerinputs</span><span class="p">)</span>

        <span class="c1"># Execute the flagger task.</span>
        <span class="n">flaggerresult</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">flaggertask</span><span class="p">)</span>

        <span class="c1"># Import views, flags, and &quot;measurement set or caltable to flag&quot;</span>
        <span class="c1"># into final result.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">importfrom</span><span class="p">(</span><span class="n">flaggerresult</span><span class="p">)</span>

        <span class="c1"># Save a snapshot of the inputs of the datatask.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">datainputs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">caltable</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span>
        <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">task_counter</span>

        <span class="c1"># Copy flagging summaries to final result.</span>
        <span class="n">result</span><span class="o">.</span><span class="n">summaries</span> <span class="o">=</span> <span class="n">flaggerresult</span><span class="o">.</span><span class="n">summaries</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_warn_about_prior_flags</span><span class="p">(</span><span class="n">caltable</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluates Tsys caltable for existence of fully flagged scans and</span>
<span class="sd">        raises a warning if any exist.</span>

<span class="sd">        :param caltable: path to Tsys table to read data from.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">allflags</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Open table, step through each row, store whether the spectrum for</span>
        <span class="c1"># any polarisation (axis=1) was fully flagged.</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">getcal</span><span class="p">(</span><span class="n">caltable</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="n">allflags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># Count fully flagged spectra, raise warning if there were any.</span>
        <span class="n">nflagged</span> <span class="o">=</span> <span class="n">allflags</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nflagged</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> out of </span><span class="si">{}</span><span class="s2"> spectra were fully flagged in all channels (for any polarisation) prior to&quot;</span>
                          <span class="s2">&quot; evaluation of flagging heuristics.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">caltable</span><span class="p">),</span> <span class="n">nflagged</span><span class="p">,</span>
                                                                     <span class="nb">len</span><span class="p">(</span><span class="n">allflags</span><span class="p">)))</span></div>



<span class="k">class</span> <span class="nc">TsysflagDataInputs</span><span class="p">(</span><span class="n">vdp</span><span class="o">.</span><span class="n">StandardInputs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    TsysflagDataInputs defines the inputs for the TsysflagData pipeline task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">caltable</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TsysflagDataInputs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># pipeline inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="c1"># vis must be set first, as other properties may depend on it</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>

        <span class="c1"># data selection arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caltable</span> <span class="o">=</span> <span class="n">caltable</span>


<span class="k">class</span> <span class="nc">TsysflagData</span><span class="p">(</span><span class="n">basetask</span><span class="o">.</span><span class="n">StandardTaskTemplate</span><span class="p">):</span>
    <span class="n">Inputs</span> <span class="o">=</span> <span class="n">TsysflagDataInputs</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TsysflagData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">TsysflagDataResults</span><span class="p">()</span>
        <span class="n">result</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">caltable</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">analyse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span> <span class="nc">TsysflagView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refintent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">split_by_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an TsysflagView instance for specified metric.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        metric         -- the name of the view metric:</span>
<span class="sd">                            &#39;nmedian&#39; gives an image where each pixel is the</span>
<span class="sd">                              tsys median for that antenna/scan.</span>
<span class="sd">                            &#39;derivative&#39; gives an image where each pixel is</span>
<span class="sd">                              the MAD of the channel to channel derivative</span>
<span class="sd">                              across the spectrum for that antenna/scan.</span>
<span class="sd">                            &#39;fieldshape&#39; gives an image where each pixel is a</span>
<span class="sd">                              measure of the departure of the shape for that </span>
<span class="sd">                              antenna/scan from the median over all</span>
<span class="sd">                              scans for that antenna in the selected fields</span>
<span class="sd">                              in the SpW.</span>
<span class="sd">                            &#39;edgechans&#39; gives median Tsys spectra for each</span>
<span class="sd">                              spw.</span>
<span class="sd">                            &#39;birdies&#39; gives difference spectra between</span>
<span class="sd">                              the antenna median spectra and spw median.</span>
<span class="sd">        refintent      -- data with this intent will be used to</span>
<span class="sd">                          calculate the &#39;reference&#39; Tsys shape to which</span>
<span class="sd">                          other data will be compared, in some views.</span>
<span class="sd">        split_by_field -- if True and if the &#39;metric&#39; supports it, then create </span>
<span class="sd">                          separate flagging views for each field.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refintent</span> <span class="o">=</span> <span class="n">refintent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_by_field</span> <span class="o">=</span> <span class="n">split_by_field</span>

        <span class="c1"># Set intents-of-interest based on flagging metric:</span>
        <span class="c1">#  - for all metrics, always include ATMOSPHERE</span>
        <span class="c1">#  - PIPE-760: for the edge-channel flagging metric, when the dataset</span>
        <span class="c1">#    is not single-dish, include AMPLITUDE and BANDPASS intents.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;edgechans&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">utils</span><span class="o">.</span><span class="n">contains_single_dish</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intentgroup</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">,</span> <span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intentgroup</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When called, the TsysflagView object calculates flagging views</span>
<span class="sd">        for the TsysflagDataResults that are provided, based on the </span>
<span class="sd">        metric that TsysflagView was initialized for.</span>

<span class="sd">        data     -- TsysflagDataResults object giving access to the </span>
<span class="sd">                    tsys caltable.</span>

<span class="sd">        Returns:</span>
<span class="sd">        TsysflagViewResults object containing the flagging view.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialize result structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">TsysflagViewResults</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_views</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">intent_ids</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the fieldids associated with the given intents.</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="c1"># translate intents to regex form, i.e. &#39;*PHASE*+*TARGET*&#39; or</span>
        <span class="c1"># &#39;*PHASE*,*TARGET*&#39; to &#39;.*PHASE.*|.*TARGET.*&#39;</span>
        <span class="n">re_intent</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">re_intent</span> <span class="o">=</span> <span class="n">re_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span>
        <span class="n">re_intent</span> <span class="o">=</span> <span class="n">re_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="n">re_intent</span> <span class="o">=</span> <span class="n">re_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="n">re_intent</span> <span class="o">=</span> <span class="n">re_intent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># translate intents to fieldids - have to be careful that</span>
        <span class="c1"># PHASE ids have PHASE intent and no other</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>
                    <span class="k">if</span> <span class="s1">&#39;AMPLITUDE&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>
                    <span class="k">if</span> <span class="s1">&#39;BANDPASS&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;PHASE&#39;</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>
                    <span class="k">if</span> <span class="s1">&#39;PHASE&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span>
                    <span class="ow">and</span> <span class="s1">&#39;BANDPASS&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span>
                    <span class="ow">and</span> <span class="s1">&#39;AMPLITUDE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>
                    <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">re_intent</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span>
                    <span class="k">if</span> <span class="s1">&#39;ATMOSPHERE&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ids</span>

    <span class="k">def</span> <span class="nf">calculate_views</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates a flagging view for the specified table, based on </span>
<span class="sd">        metric that TsysflagView was initialized with.</span>

<span class="sd">        table     -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                     caltable.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Load the tsystable from file into memory, store vis in result</span>
        <span class="n">tsystable</span> <span class="o">=</span> <span class="n">caltableaccess</span><span class="o">.</span><span class="n">CalibrationTableDataFiller</span><span class="o">.</span><span class="n">getcal</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">vis</span>

        <span class="c1"># Get the MS object from the context</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span>

        <span class="c1"># Get the spws from the tsystable.</span>
        <span class="n">tsysspws</span> <span class="o">=</span> <span class="p">{</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">rows</span><span class="p">}</span>

        <span class="c1"># Get the Tsys spw map by retrieving it from the first tsys CalFrom</span>
        <span class="c1"># that is present in the callibrary. We need to know the Tsys mapping</span>
        <span class="c1"># for multi-tuning EBs, where fields may only be observed with a</span>
        <span class="c1"># subset of science spws, and we need to know which Tsys spws those</span>
        <span class="c1"># science spws map to.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spwmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_calfroms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">,</span> <span class="s1">&#39;tsys&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spwmap</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No spwmap found for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vis</span><span class="p">))</span>
            <span class="c1"># proceed with 1:1 mapping</span>
            <span class="n">spwmap</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">)))</span>

        <span class="c1"># holds dict of Tsys spw -&gt; intent -&gt; field ids that use the Tsys spw</span>
        <span class="n">tsys_spw_to_intent_to_field_ids</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">tsys_spw</span> <span class="ow">in</span> <span class="n">tsysspws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">intent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intentgroup</span><span class="p">:</span>
                <span class="c1"># which fields were observed with this intent?</span>
                <span class="n">fields_for_intent</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_ids</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="n">ms</span><span class="p">)]</span>

                <span class="c1"># which science spws map to this Tsys spw?</span>
                <span class="k">if</span> <span class="n">intent</span> <span class="o">==</span> <span class="s1">&#39;ATMOSPHERE&#39;</span><span class="p">:</span>
                    <span class="c1"># .. bearing in mind that Tsys spws map to themselves</span>
                    <span class="n">science_spws</span> <span class="o">=</span> <span class="p">{</span><span class="n">tsys_spw</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">science_spws</span> <span class="o">=</span> <span class="p">{</span><span class="n">science_id</span> <span class="k">for</span> <span class="n">science_id</span><span class="p">,</span> <span class="n">mapped_tsys</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spwmap</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">tsys_spw</span> <span class="o">==</span> <span class="n">mapped_tsys</span><span class="p">}</span>

                <span class="c1"># now which of the fields were observed using these science</span>
                <span class="c1"># spws, and hence the Tsys spw currently in context?</span>
                <span class="n">domain_spws</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">}</span>
                <span class="n">field_ids_for_tsys_spw</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fields_for_intent</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">domain_spws</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">)}</span>

                <span class="c1"># these are the fields to analyse for this Tsys spw and intent</span>
                <span class="n">tsys_spw_to_intent_to_field_ids</span><span class="p">[</span><span class="n">tsys_spw</span><span class="p">][</span><span class="n">intent</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_ids_for_tsys_spw</span>

        <span class="c1"># Compute the flagging view for every spw and every intent</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Computing flagging metrics for caltable </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent_to_field_ids</span> <span class="ow">in</span> <span class="n">tsys_spw_to_intent_to_field_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span> <span class="ow">in</span> <span class="n">intent_to_field_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Warn if no fields were found for this Tsys spw and intent.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_ids</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> - no valid fields found for Tsys spw </span><span class="si">{}</span><span class="s2"> and intent </span><span class="si">{}</span><span class="s2">, unable to create&quot;</span>
                                <span class="s2">&quot; corresponding flagging views.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">))</span>

                <span class="c1"># Otherwise, continue with calculating the flagging view.</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;nmedian&#39;</span><span class="p">,</span> <span class="s1">&#39;toomany&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_median_spectra_view</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span><span class="p">,</span>
                                                       <span class="n">split_by_field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_by_field</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;derivative&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_derivative_view</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;fieldshape&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fieldshape_view</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">refintent</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;birdies&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_antenna_diff_channel_view</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;edgechans&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">calculate_median_channel_view</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">tsys_spw_id</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">field_ids</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_tsystable_data</span><span class="p">(</span><span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span>
                           <span class="n">corr_type</span><span class="p">,</span> <span class="n">normalise</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in specified Tsys table, selects data for the specified </span>
<span class="sd">        spw and field(s) and returns the Tsys spectra data, timestamps, </span>
<span class="sd">        and number of channels per spectra.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable      -- Tsys table to read data from.</span>
<span class="sd">        spwid          -- Data is selected for this Spectral window id.</span>
<span class="sd">        fieldids       -- Data are selected for these field ids.</span>
<span class="sd">        antenna_names  -- List of strings containing the names of the antennas,</span>
<span class="sd">                          which are used in the SpectrumResult.</span>
<span class="sd">        corr_type      -- List containing the names of the polarizations,</span>
<span class="sd">                          which are used in the SpectrumResult.</span>
<span class="sd">        normalise      -- bool : if set to True, the SpectrumResult objects are normalised.</span>

<span class="sd">        Returns:</span>
<span class="sd">        Tuple containing 2 elements:</span>
<span class="sd">          tsysspectra: dictionary of TsysflagspectraResults</span>
<span class="sd">          times: set of unique timestamps</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize a dictionary of Tsys spectra results and corresponding times</span>
        <span class="n">tsysspectra</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="n">TsysflagspectraResults</span><span class="p">)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">normalise</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;Normalised Tsys&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">datatype</span> <span class="o">=</span> <span class="s1">&#39;Tsys&#39;</span>

        <span class="c1"># Select rows from tsystable that match the specified spw and fields,</span>
        <span class="c1"># store a Tsys spectrum for each polarisation in the tsysspectra results</span>
        <span class="c1"># and store the corresponding time.</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tsystable</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">spwid</span> <span class="ow">and</span> \
              <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FIELD_ID&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">fieldids</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)):</span>
                    <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FPARAM&#39;</span><span class="p">)[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">flag</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FLAG&#39;</span><span class="p">)[</span><span class="n">pol</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">field_id</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FIELD_ID&#39;</span><span class="p">),</span>
                        <span class="n">spw</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">),</span>
                        <span class="n">ant</span><span class="o">=</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">),</span> <span class="n">antenna_names</span><span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)]),</span>
                        <span class="n">units</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span>
                        <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">time</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">),</span> <span class="n">normalise</span><span class="o">=</span><span class="n">normalise</span><span class="p">)</span>

                    <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">tsysspectrum</span><span class="p">)</span>
                    <span class="n">times</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">times</span>

    <span class="k">def</span> <span class="nf">calculate_median_spectra_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">split_by_field</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data of the specified spwid, intent and range of fieldids are</span>
<span class="sd">        read from the given tsystable object. Two data &#39;views&#39; will be</span>
<span class="sd">        created, one for each polarization. Each &#39;view&#39; is a matrix with</span>
<span class="sd">        axes antenna_id v time. Each point in the matrix is the median</span>
<span class="sd">        value of the tsys spectrum for that antenna/time. </span>

<span class="sd">        Results are added to self.result.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable      -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                          caltable.</span>
<span class="sd">        spwid          -- view will be calculated using data for this spw id.</span>
<span class="sd">        intent         -- view will be calculated using data for this intent.</span>
<span class="sd">        fieldids       -- view will be calculated using data for all field_ids in</span>
<span class="sd">                          this list.</span>
<span class="sd">        split_by_field -- if True, separate views will be calculated for each</span>
<span class="sd">                          field_id.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get antenna names, ids</span>
        <span class="n">antenna_names</span><span class="p">,</span> <span class="n">antenna_ids</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_antenna_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Get names of polarisations, and create polarisation index </span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_corr_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)))</span>

        <span class="c1"># If splitting views by field...</span>
        <span class="k">if</span> <span class="n">split_by_field</span><span class="p">:</span>

            <span class="c1"># Create translation of field ID to field name</span>
            <span class="n">field_name_for_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>

            <span class="c1"># Create separate flagging views for each field id.</span>
            <span class="k">for</span> <span class="n">fieldid</span> <span class="ow">in</span> <span class="n">fieldids</span><span class="p">:</span>

                <span class="c1"># Select Tsysspectra and corresponding times for specified</span>
                <span class="c1"># spwid and fieldids</span>
                <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
                    <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="p">[</span><span class="n">fieldid</span><span class="p">],</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
                    <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Create separate flagging views for each polarisation</span>
                <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>

                    <span class="c1"># Initialize the median Tsys spectra results and spectrum</span>
                    <span class="c1"># stack</span>
                    <span class="n">tsysmedians</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>
                    <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">flagstack</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># Create a stack of all Tsys spectra for specified spw,</span>
                    <span class="c1"># pol, and field id.</span>
                    <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                        <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,))</span>
                                <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                           <span class="n">spectrumstack</span><span class="p">))</span>
                                <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                                       <span class="n">flagstack</span><span class="p">))</span>

                    <span class="c1"># From the stack of all Tsys spectra for the specified spw</span>
                    <span class="c1"># and pol, create a median Tsys spectrum and corresponding</span>
                    <span class="c1"># flagging state, convert to a SpectrumResult, and store</span>
                    <span class="c1"># this as a view in tsysmedians:</span>
                    <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                        <span class="c1"># Initialize median spectrum and corresponding flag list</span>
                        <span class="c1"># and populate with valid data</span>
                        <span class="n">stackmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">stackmedianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                                <span class="n">stackmedian</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                                <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="n">tsysmedian</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                          <span class="n">data</span><span class="o">=</span><span class="n">stackmedian</span><span class="p">,</span> 
                          <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Normalised Tsys&#39;</span><span class="p">,</span>
                          <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> 
                          <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">,</span>
                          <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                        <span class="n">tsysmedians</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">tsysmedian</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">tsysmedian</span><span class="p">)</span>

                        <span class="c1"># Initialize the data and flagging state for the flagging</span>
                        <span class="c1"># view, and get values for the &#39;times&#39; axis.</span>
                        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)])</span>
                        <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)],</span> <span class="nb">bool</span><span class="p">)</span>

                        <span class="c1"># Populate the flagging view based on the flagging metric</span>
                        <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                            <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                            <span class="n">metric</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">median</span>
                            <span class="n">metricflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>

                            <span class="n">ant</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span>
                            <span class="n">caltime</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">time</span>

                            <span class="n">data</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                            <span class="n">flag</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metricflag</span>

                        <span class="c1"># Create axes for flagging view</span>
                        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span>
                            <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
                        <span class="p">]</span>

                        <span class="c1"># Convert flagging view into an ImageResult</span>
                        <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ImageResult</span><span class="p">(</span>
                            <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span>
                            <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Tsys&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span>
                            <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">field_id</span><span class="o">=</span><span class="n">fieldid</span><span class="p">,</span>
                            <span class="n">field_name</span><span class="o">=</span><span class="n">field_name_for_id</span><span class="p">[</span><span class="n">fieldid</span><span class="p">])</span>

                        <span class="c1"># Store the spectra contributing to this view as &#39;children&#39;</span>
                        <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysmedians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysmedians</span>
                        <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysspectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>

                        <span class="c1"># Add the view results to the class result structure</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: no data found for field </span><span class="si">{}</span><span class="s2">, spw </span><span class="si">{}</span><span class="s2">, pol </span><span class="si">{}</span><span class="s2">, no &quot;</span>
                                    <span class="s2">&quot;flagging view created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">fieldid</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span>
                                                                    <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># If not splitting by field...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Select Tsysspectra and corresponding times for specified spwid</span>
            <span class="c1"># and fieldids</span>
            <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
                <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
                <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Create separate flagging views for each polarisation</span>
            <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>

                <span class="c1"># Initialize the median Tsys spectra results, and spectrum stack</span>
                <span class="n">tsysmedians</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>
                <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">flagstack</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Create a stack of all Tsys spectra for specified spw and pol;</span>
                <span class="c1"># this will stack together spectra from all &quot;fieldids&quot;.</span>
                <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                    <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,))</span>
                            <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                       <span class="n">spectrumstack</span><span class="p">))</span>
                            <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                                   <span class="n">flagstack</span><span class="p">))</span>

                <span class="c1"># From the stack of all Tsys spectra for the specified spw and pol,</span>
                <span class="c1"># create a median Tsys spectrum and corresponding flagging state,</span>
                <span class="c1"># convert to a SpectrumResult, and store this as a view in tsysmedians:</span>
                <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="c1"># Initialize median spectrum and corresponding flag list</span>
                    <span class="c1"># and populate with valid data</span>
                    <span class="n">stackmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">stackmedianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                            <span class="n">stackmedian</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                            <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">tsysmedian</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                      <span class="n">data</span><span class="o">=</span><span class="n">stackmedian</span><span class="p">,</span> 
                      <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Normalised Tsys&#39;</span><span class="p">,</span>
                      <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> 
                      <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                    <span class="n">tsysmedians</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">tsysmedian</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">tsysmedian</span><span class="p">)</span>

                    <span class="c1"># Initialize the data and flagging state for the flagging view,</span>
                    <span class="c1"># and get values for the &#39;times&#39; axis.</span>
                    <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)])</span>
                    <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)],</span> <span class="nb">bool</span><span class="p">)</span>

                    <span class="c1"># Populate the flagging view based on the flagging metric</span>
                    <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                        <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">median</span>
                        <span class="n">metricflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>

                        <span class="n">ant</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span>
                        <span class="n">caltime</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">time</span>

                        <span class="n">data</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                        <span class="n">flag</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metricflag</span>

                    <span class="c1"># Create axes for flagging view</span>
                    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span>
                        <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
                    <span class="p">]</span>

                    <span class="c1"># Convert flagging view into an ImageResult</span>
                    <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ImageResult</span><span class="p">(</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                        <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Tsys&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span>
                        <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

                    <span class="c1"># Store the spectra contributing to this view as &#39;children&#39;</span>
                    <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysmedians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysmedians</span>
                    <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysspectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>

                    <span class="c1"># Add the view results to the class result structure</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: no data found for spw </span><span class="si">{}</span><span class="s2">, pol </span><span class="si">{}</span><span class="s2">, no &quot;</span>
                                <span class="s2">&quot;flagging view created.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">spwid</span><span class="p">,</span>
                                                                <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">calculate_derivative_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data of the specified spwid, intent and range of fieldids are</span>
<span class="sd">        read from the given tsystable object. Two data &#39;views&#39; will be</span>
<span class="sd">        created, one for each polarization. Each &#39;view&#39; is a matrix with</span>
<span class="sd">        axes antenna_id v time. Each point in the matrix is the median</span>
<span class="sd">        absolute deviation (MAD) of the channel to channel derivative</span>
<span class="sd">        across the Tsys spectrum for that antenna/time.</span>

<span class="sd">        Results are added to self.result.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                     caltable.</span>
<span class="sd">        spwid     -- view will be calculated using data for this spw id.</span>
<span class="sd">        intent    -- view will be calculated using data for this intent.</span>
<span class="sd">        fieldids  -- view will be calculated using data for all field_ids in</span>
<span class="sd">                     this list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get antenna names, ids</span>
        <span class="n">antenna_names</span><span class="p">,</span> <span class="n">antenna_ids</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_antenna_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Get names of polarisations, and create polarisation index </span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_corr_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)))</span>

        <span class="c1"># Select Tsysspectra and corresponding times for specified spwid and</span>
        <span class="c1"># fieldids</span>
        <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
            <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
            <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Create separate flagging views for each polarisation</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>

            <span class="c1"># Initialize the median Tsys spectra results, and spectrum stack</span>
            <span class="n">tsysmedians</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>
            <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">flagstack</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Create a stack of all Tsys spectra for specified spw and pol;</span>
            <span class="c1"># this will stack together spectra from all &quot;fieldids&quot;.</span>
            <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,))</span>
                        <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">spectrumstack</span><span class="p">))</span>
                        <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                               <span class="n">flagstack</span><span class="p">))</span>

            <span class="c1"># From the stack of all Tsys spectra for the specified spw and pol,</span>
            <span class="c1"># create a median Tsys spectrum and corresponding flagging state,</span>
            <span class="c1"># convert to a SpectrumResult, and store this as a view in</span>
            <span class="c1"># tsysmedians:</span>
            <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Initialize median spectrum and corresponding flag list</span>
                <span class="c1"># and populate with valid data</span>
                <span class="n">stackmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">stackmedianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                        <span class="n">stackmedian</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                        <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">tsysmedian</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">stackmedian</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Normalised Tsys&#39;</span><span class="p">,</span>
                    <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                <span class="n">tsysmedians</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">tsysmedian</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">tsysmedian</span><span class="p">)</span>

            <span class="c1"># Initialize the data and flagging state for the flagging view,</span>
            <span class="c1"># and get values for the &#39;times&#39; axis.</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)])</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)],</span> <span class="nb">bool</span><span class="p">)</span>

            <span class="c1"># Populate the flagging view based on the flagging metric:</span>
            <span class="c1"># Get MAD of channel by channel derivative of Tsys</span>
            <span class="c1"># for each antenna, time/scan.</span>
            <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>

                <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

                <span class="n">tsysdata</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span>
                <span class="n">tsysflag</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span>

                <span class="n">deriv</span> <span class="o">=</span> <span class="n">tsysdata</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">tsysdata</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">deriv_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">tsysflag</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">tsysflag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">valid</span> <span class="o">=</span> <span class="n">deriv</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">deriv_flag</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">valid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>

                    <span class="n">ant</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span>
                    <span class="n">caltime</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                    <span class="n">flag</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Create axes for flagging view</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Convert flagging view into an ImageResult</span>
            <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ImageResult</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;100 * MAD of normalised derivative&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span>
                <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Store the spectra contributing to this view as &#39;children&#39;</span>
            <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysmedians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysmedians</span>
            <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysspectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>

            <span class="c1"># Add the view results to the class result structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_fieldshape_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span>
                                  <span class="n">refintent</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data of the specified spwid, intent and range of fieldids are</span>
<span class="sd">        read from the given tsystable object. Two data &#39;views&#39; will be</span>
<span class="sd">        created, one for each polarization. Each &#39;view&#39; is a matrix with</span>
<span class="sd">        axes antenna_id v time. Each point in the matrix is a measure of</span>
<span class="sd">        the difference of the tsys spectrum there from the median of all</span>
<span class="sd">        the tsys spectra for that antenna/spw in the &#39;reference&#39; fields</span>
<span class="sd">        (those with refintent). The shape metric is calculated</span>
<span class="sd">        using the formula:</span>

<span class="sd">        metric = 100 * mean(abs(normalised tsys - reference normalised tsys))</span>

<span class="sd">        where a &#39;normalised&#39; array is defined as:</span>

<span class="sd">                         array</span>
<span class="sd">        normalised = -------------</span>
<span class="sd">                     median(array)</span>

<span class="sd">        Results are added to self.result.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                     caltable.</span>
<span class="sd">        spwid     -- view will be calculated using data for this spw id.</span>
<span class="sd">        intent    -- view will be calculated using data for this intent.</span>
<span class="sd">        fieldids  -- view will be calculated using data for all field_ids in</span>
<span class="sd">                     this list.</span>
<span class="sd">        refintent -- data with this intent will be used to</span>
<span class="sd">                     calculate the &#39;reference&#39; Tsys shape to which</span>
<span class="sd">                     other data will be compared.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get antenna names, ids</span>
        <span class="n">antenna_names</span><span class="p">,</span> <span class="n">antenna_ids</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_antenna_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Get names of polarisations, and create polarisation index </span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_corr_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)))</span>

        <span class="c1"># Select Tsysspectra and corresponding times for specified spwid and</span>
        <span class="c1"># fieldids</span>
        <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
            <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
            <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Get ids of fields for reference spectra</span>
        <span class="n">referencefieldids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intent_ids</span><span class="p">(</span><span class="n">refintent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Create separate flagging views for each polarisation</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>

            <span class="c1"># Initialize results object to hold the reference Tsys spectra</span>
            <span class="n">tsysrefs</span> <span class="o">=</span> <span class="n">TsysflagspectraResults</span><span class="p">()</span>

            <span class="c1"># For each antenna, create a &quot;reference&quot; Tsys spectrum, </span>
            <span class="c1"># by creating a stack of Tsys spectra that belong to the </span>
            <span class="c1"># reference field ids, and calculating the median Tsys</span>
            <span class="c1"># spectrum for this spectrum stack:</span>

            <span class="k">for</span> <span class="n">antenna_id</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">:</span>

                <span class="c1"># Create a single stack of spectra, and corresponding flags, </span>
                <span class="c1"># for all fields that are listed as reference field.</span>
                <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">flagstack</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                    <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">pol</span> <span class="o">==</span> <span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="ow">and</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">antenna_id</span>
                            <span class="ow">and</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">field_id</span> <span class="ow">in</span> <span class="n">referencefieldids</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span>
                            <span class="n">flagstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                       <span class="n">spectrumstack</span><span class="p">))</span>
                            <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                                   <span class="n">flagstack</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="c1"># From the stack of Tsys spectra, derive a median Tsys &quot;reference&quot;</span>
                    <span class="c1"># spectrum and corresponding flag list.</span>

                    <span class="c1"># Ensure that the spectrum stack is 2D</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># need to reshape to 2d array</span>
                        <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
                        <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flagstack</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>

                    <span class="c1"># Initialize median spectrum and corresponding flag list</span>
                    <span class="n">stackmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">stackmedianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>

                    <span class="c1"># Calculate median Tsys spectrum from spectrum stack</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                            <span class="n">stackmedian</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                            <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># In the median Tsys reference spectrum, look for channels</span>
                    <span class="c1"># that may cover lines, and flag these channels:</span>

                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;looking for atmospheric lines&#39;</span><span class="p">)</span>

                    <span class="c1"># Calculate first derivative and propagate flags</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">stackmedian</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">stackmedian</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">diff_flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">stackmedianflag</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
                                              <span class="n">stackmedianflag</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

                    <span class="c1"># Determine where first derivative is larger 0.05</span>
                    <span class="c1"># and not flagged, and create a new list of flags </span>
                    <span class="c1"># that include these channels</span>
                    <span class="n">newflag</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">diff_flag</span><span class="p">)</span>
                    <span class="n">flag_chan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">newflag</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                    <span class="n">flag_chan</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">newflag</span>
                    <span class="n">flag_chan</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">flag_chan</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">newflag</span><span class="p">)</span>
                    <span class="n">channels_flagged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">newflag</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="n">flag_chan</span><span class="p">]</span>

                    <span class="c1"># Flag lines in the median Tsys reference spectrum</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_chan</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;possible lines flagged in channels:&#39;</span>
                                  <span class="s1">&#39; </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">channels_flagged</span><span class="p">))</span>
                        <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">flag_chan</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Create a SpectrumResult from the median Tsys reference</span>
                    <span class="c1"># spectrum, and add it as a view to tsysrefs</span>
                    <span class="n">tsysref</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">stackmedian</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">stackmedianflag</span><span class="p">,</span>
                        <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Normalised Tsys&#39;</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span>
                        <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">ant</span><span class="o">=</span><span class="p">(</span><span class="n">antenna_id</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]),</span>
                        <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
                    <span class="n">tsysrefs</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">tsysref</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">tsysref</span><span class="p">)</span>

            <span class="c1"># Initialize the data and flagging state for the flagging view,</span>
            <span class="c1"># and get values for the &#39;times&#39; axis.</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">times</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)])</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)],</span> <span class="nb">bool</span><span class="p">)</span>

            <span class="c1"># Populate the flagging view based on the flagging metric</span>
            <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>

                <span class="c1"># Get Tsys spectrum</span>
                <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

                <span class="c1"># Get the &#39;reference&#39; median Tsys spectrum for this antenna</span>
                <span class="k">for</span> <span class="n">ref_description</span> <span class="ow">in</span> <span class="n">tsysrefs</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                    <span class="n">tsysref</span> <span class="o">=</span> <span class="n">tsysrefs</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">ref_description</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tsysref</span><span class="o">.</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="k">continue</span>

                    <span class="c1"># Calculate the metric</span>
                    <span class="c1"># (100 * mean absolute deviation from reference)</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">tsysref</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                    <span class="n">diff_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span> <span class="o">|</span> <span class="n">tsysref</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">diff_flag</span><span class="p">):</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">diff</span><span class="p">[</span><span class="n">diff_flag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
                        <span class="n">metricflag</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">metricflag</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="n">ant</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span>
                    <span class="n">caltime</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">time</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
                    <span class="n">flag</span><span class="p">[</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">caltime</span> <span class="o">==</span> <span class="n">times</span><span class="p">]</span> <span class="o">=</span> <span class="n">metricflag</span>

            <span class="c1"># Create axes for flagging view</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Antenna1&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">antenna_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span>
                <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ResultAxis</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">times</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="c1"># Convert flagging view into an ImageResult</span>
            <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">ImageResult</span><span class="p">(</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">flag</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span>
                <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Shape Metric * 100&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span>
                <span class="n">pol</span><span class="o">=</span><span class="n">corr_type</span><span class="p">[</span><span class="n">pol</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1"># Store the spectra contributing to this view as &#39;children&#39;</span>
            <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysmedians&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysrefs</span>
            <span class="n">viewresult</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="s1">&#39;tsysspectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>

            <span class="c1"># Add the view results to the class result structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_median_channel_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data of the specified spwid, intent and range of fieldids are</span>
<span class="sd">        read from the given tsystable object. From all this one data &#39;view&#39; </span>
<span class="sd">        is created; a &#39;median&#39; Tsys spectrum where for each channel the </span>
<span class="sd">        value is the median of all the tsys spectra selected.</span>

<span class="sd">        Results are added to self.result.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                     caltable.</span>
<span class="sd">        spwid     -- view will be calculated using data for this spw id.</span>
<span class="sd">        intent    -- view will be calculated using data for this intent.</span>
<span class="sd">        fieldids  -- view will be calculated using data for all field_ids in</span>
<span class="sd">                     this list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get antenna names</span>
        <span class="n">antenna_names</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_antenna_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Get names of polarisations, and create polarisation index </span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_corr_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)))</span>

        <span class="c1"># Select Tsysspectra for specified spwid and fieldids</span>
        <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
            <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
            <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize a stack of all Tsys spectra</span>
        <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">flagstack</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Create a stack of all Tsys spectra for the specified spwid; this will</span>
        <span class="c1"># stack together spectra from all &quot;fieldids&quot; and both polarisations.</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">flagstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">spectrumstack</span><span class="p">))</span>
                    <span class="n">flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="n">flagstack</span><span class="p">))</span>

        <span class="c1"># From the stack of Tsys spectra, create a median Tsys </span>
        <span class="c1"># spectrum and corresponding flagging state, convert to a</span>
        <span class="c1"># SpectrumResult, and store this as a view in the </span>
        <span class="c1"># final class result structure:</span>
        <span class="k">if</span> <span class="n">spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Initialize median spectrum and corresponding flag list</span>
            <span class="n">stackmedian</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">stackmedianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>

            <span class="c1"># Calculate median Tsys spectrum from spectrum stack</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                    <span class="n">stackmedian</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                    <span class="n">stackmedianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Create a view result from the median Tsys spectrum,</span>
            <span class="c1"># and store it in the final result.</span>
            <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="n">stackmedian</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">stackmedianflag</span><span class="p">,</span>
                <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Median Normalised Tsys&#39;</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">calculate_antenna_diff_channel_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">intent</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Data of the specified spwid, intent and range of fieldids are</span>
<span class="sd">        read from the given tsystable object. From all this a series</span>
<span class="sd">        of &#39;views&#39; are created, one for each antenna. Each &#39;view&#39;</span>
<span class="sd">        is the difference spectrum resulting from the subtraction</span>
<span class="sd">        of the &#39;spw median&#39; Tsys spectrum from the &#39;antenna/spw median&#39;</span>
<span class="sd">        spectrum.</span>

<span class="sd">        Results are added to self.result.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        tsystable -- CalibrationTableData object giving access to the tsys</span>
<span class="sd">                     caltable.</span>
<span class="sd">        spwid     -- view will be calculated using data for this spw id.</span>
<span class="sd">        intent    -- view will be calculated using data for this intent.</span>
<span class="sd">        fieldids  -- view will be calculated using data for all field_ids in</span>
<span class="sd">                     this list.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get antenna names, ids</span>
        <span class="n">antenna_names</span><span class="p">,</span> <span class="n">antenna_ids</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_antenna_names</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Get names of polarisations, and create polarisation index </span>
        <span class="n">corr_type</span> <span class="o">=</span> <span class="n">commonhelpermethods</span><span class="o">.</span><span class="n">get_corr_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwid</span><span class="p">)</span>
        <span class="n">pols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">corr_type</span><span class="p">)))</span>

        <span class="c1"># Select Tsysspectra for specified spwid and fieldids</span>
        <span class="n">tsysspectra</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_tsystable_data</span><span class="p">(</span>
            <span class="n">tsystable</span><span class="p">,</span> <span class="n">spwid</span><span class="p">,</span> <span class="n">fieldids</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span>
            <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize spectrum stacks for antennas and for spw</span>
        <span class="n">spw_spectrumstack</span> <span class="o">=</span> <span class="n">spw_flagstack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ant_spectrumstack</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ant_flagstack</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Create a stack of all Tsys spectra for specified &quot;spwid&quot;,</span>
        <span class="c1"># as well as separate stacks for each antenna. This will stack</span>
        <span class="c1"># together spectra from all &quot;fieldids&quot; and both polarisations.</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="n">pols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">description</span> <span class="ow">in</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">descriptions</span><span class="p">():</span>
                <span class="n">tsysspectrum</span> <span class="o">=</span> <span class="n">tsysspectra</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

                <span class="c1"># Update full stack of all Tsys spectra</span>
                <span class="k">if</span> <span class="n">spw_spectrumstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spw_spectrumstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span>
                    <span class="n">spw_flagstack</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spw_spectrumstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                   <span class="n">spw_spectrumstack</span><span class="p">))</span>
                    <span class="n">spw_flagstack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span>
                                               <span class="n">spw_flagstack</span><span class="p">))</span>

                <span class="c1"># Update antenna-specific stacks</span>
                <span class="k">for</span> <span class="n">antenna_id</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">ant</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">antenna_id</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">antenna_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ant_spectrumstack</span><span class="p">:</span>
                        <span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span>
                        <span class="n">ant_flagstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]))</span>
                        <span class="n">ant_flagstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">tsysspectrum</span><span class="o">.</span><span class="n">flag</span><span class="p">,</span> <span class="n">ant_flagstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]))</span>

        <span class="c1"># From the stack of all Tsys spectra for the specified spw, </span>
        <span class="c1"># create a median Tsys spectrum and corresponding flagging state</span>
        <span class="k">if</span> <span class="n">spw_spectrumstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="c1"># Initialize median spectrum and corresponding flag list</span>
            <span class="c1"># and populate with valid data</span>
            <span class="n">spw_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spw_spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">spw_medianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spw_spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">spw_spectrumstack</span><span class="p">)[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">valid_data</span> <span class="o">=</span> <span class="n">spw_spectrumstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">spw_flagstack</span><span class="p">[:,</span> <span class="n">j</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                    <span class="n">spw_median</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                    <span class="n">spw_medianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spw_median</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">spw_medianflag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Create separate flagging views for each antenna</span>
        <span class="k">for</span> <span class="n">antenna_id</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="c1"># Initialize the data and flagging state for the flagging view</span>
                <span class="n">ant_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">ant_medianflag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>

                <span class="c1"># Populate the flagging view based on the flagging metric:</span>
                <span class="c1"># Calculate diff between median for spw/antenna and median for spw</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">])[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">ant_spectrumstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">][:,</span> <span class="n">j</span><span class="p">][</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">ant_flagstack</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">][:,</span> <span class="n">j</span><span class="p">])]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">):</span>
                        <span class="n">ant_median</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span>
                        <span class="n">ant_medianflag</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">ant_median</span> <span class="o">-=</span> <span class="n">spw_median</span>
                <span class="n">ant_medianflag</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant_medianflag</span> <span class="o">|</span> <span class="n">spw_medianflag</span><span class="p">)</span>

                <span class="c1"># Convert flagging view into an SpectrumResult</span>
                <span class="n">viewresult</span> <span class="o">=</span> <span class="n">commonresultobjects</span><span class="o">.</span><span class="n">SpectrumResult</span><span class="p">(</span>
                  <span class="n">data</span><span class="o">=</span><span class="n">ant_median</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="n">ant_medianflag</span><span class="p">,</span>
                  <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;Normalised Tsys Difference&#39;</span><span class="p">,</span>
                  <span class="n">filename</span><span class="o">=</span><span class="n">tsystable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwid</span><span class="p">,</span>
                  <span class="n">intent</span><span class="o">=</span><span class="n">intent</span><span class="p">,</span>
                  <span class="n">ant</span><span class="o">=</span><span class="p">(</span><span class="n">antenna_id</span><span class="p">,</span> <span class="n">antenna_names</span><span class="p">[</span><span class="n">antenna_id</span><span class="p">]))</span>

                <span class="c1"># Add the view result to the class result structure</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">addview</span><span class="p">(</span><span class="n">viewresult</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">viewresult</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 20202024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>