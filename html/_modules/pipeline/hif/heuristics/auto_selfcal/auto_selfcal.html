

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.hif.heuristics.auto_selfcal.auto_selfcal &mdash; Pipeline 2024.2.0.4+148-g793ad1aab-PIPE-1669-run-dev-pipeline-with-modular-casa6 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/custom_theme.css?v=30144f19" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=1eabddb0"></script>
      <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../releases.html">Past Releases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.hif.heuristics.auto_selfcal.auto_selfcal</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.hif.heuristics.auto_selfcal.auto_selfcal</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This module is an adaptation from the original auto_selfcal prototype.</span>

<span class="sd">see: https://github.com/jjtobin/auto_selfcal</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.observingrun</span> <span class="kn">import</span> <span class="n">ObservingRun</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.casa_tasks</span> <span class="kn">import</span> <span class="n">CasaTasks</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.tablereader</span> <span class="kn">import</span> <span class="n">MeasurementSetReader</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">filenamer</span>

<span class="kn">from</span> <span class="nn">.selfcal_helpers</span> <span class="kn">import</span> <span class="p">(</span><span class="n">analyze_inf_EB_flagging</span><span class="p">,</span> <span class="n">checkmask</span><span class="p">,</span>
                              <span class="n">compare_beams</span><span class="p">,</span> <span class="n">estimate_near_field_SNR</span><span class="p">,</span>
                              <span class="n">estimate_SNR</span><span class="p">,</span> <span class="n">fetch_targets</span><span class="p">,</span>
                              <span class="n">get_dr_correction</span><span class="p">,</span> <span class="n">get_intflux</span><span class="p">,</span> <span class="n">get_n_ants</span><span class="p">,</span>
                              <span class="n">get_nterms</span><span class="p">,</span> <span class="n">get_SNR_self</span><span class="p">,</span>
                              <span class="n">get_SNR_self_update</span><span class="p">,</span> <span class="n">get_solints_simple</span><span class="p">,</span> <span class="n">get_spw_map</span><span class="p">,</span>
                              <span class="n">get_spw_bandwidth</span><span class="p">,</span> <span class="n">get_uv_range</span><span class="p">,</span> <span class="n">importdata</span><span class="p">,</span>
                              <span class="n">copy_products</span><span class="p">,</span> <span class="n">rank_refants</span><span class="p">)</span>

<span class="c1"># from pipeline.infrastructure.utils import request_omp_threading</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="SelfcalHeuristics">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics">[docs]</a>
<span class="k">class</span> <span class="nc">SelfcalHeuristics</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class to hold the heuristics for selfcal.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scal_target</span><span class="p">,</span>
                 <span class="n">gaincal_minsnr</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">minsnr_to_proceed</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">delta_beam_thresh</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                 <span class="n">apply_cal_mode_default</span><span class="o">=</span><span class="s1">&#39;calflag&#39;</span><span class="p">,</span>
                 <span class="n">rel_thresh_scaling</span><span class="o">=</span><span class="s1">&#39;log10&#39;</span><span class="p">,</span>
                 <span class="n">dividing_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">check_all_spws</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">n_solints</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                 <span class="n">do_amp_selfcal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">inf_EB_gaincal_combine</span><span class="o">=</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span>
                 <span class="n">refantignore</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                 <span class="n">executor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the class.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cts</span> <span class="o">=</span> <span class="n">CasaTasks</span><span class="p">(</span><span class="n">executor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaltarget</span> <span class="o">=</span> <span class="n">scal_target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;heuristics&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;cell&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;imsize&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;phasecenter&#39;</span><span class="p">]</span>  <span class="c1"># explictly set phasecenter for now</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spw_virtual</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gridder</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;gridder&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;sc_vislist&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;sc_parallel&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;sc_telescope&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;uvtaper&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robust</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;robust&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uvrange</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;uvrange&#39;</span><span class="p">]</span>
        <span class="c1"># Note: scal_target[&#39;reffreq&#39;] is either None or a frequency (in GHz) string representation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reffreq</span> <span class="o">=</span> <span class="n">scal_target</span><span class="p">[</span><span class="s1">&#39;reffreq&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_solints</span> <span class="o">=</span> <span class="n">n_solints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_amp_selfcal</span> <span class="o">=</span> <span class="n">do_amp_selfcal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gaincal_minsnr</span> <span class="o">=</span> <span class="n">gaincal_minsnr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minsnr_to_proceed</span> <span class="o">=</span> <span class="n">minsnr_to_proceed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span> <span class="o">=</span> <span class="n">delta_beam_thresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_cal_mode_default</span> <span class="o">=</span> <span class="n">apply_cal_mode_default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rel_thresh_scaling</span> <span class="o">=</span> <span class="n">rel_thresh_scaling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dividing_factor</span> <span class="o">=</span> <span class="n">dividing_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_all_spws</span> <span class="o">=</span> <span class="n">check_all_spws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refantignore</span> <span class="o">=</span> <span class="n">refantignore</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaincal_combine</span> <span class="o">=</span> <span class="n">inf_EB_gaincal_combine</span>    <span class="c1"># Options: &#39;spw,scan&#39; or &#39;scan&#39; or &#39;spw&#39; or &#39;none&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaintype</span> <span class="o">=</span> <span class="s1">&#39;G&#39;</span>                              <span class="c1"># Options: &#39;G&#39; or &#39;T&#39; or &#39;G,T&#39;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;recreating observing run from per-selfcal-target MS(es): </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span><span class="o">.</span><span class="n">observing_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_observing_run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_observing_run</span><span class="p">(</span><span class="n">ms_files</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ms_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms_files</span><span class="p">]</span>

        <span class="n">observing_run</span> <span class="o">=</span> <span class="n">ObservingRun</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ms_file</span> <span class="ow">in</span> <span class="n">ms_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">logging</span><span class="o">.</span><span class="n">log_level</span><span class="p">(</span><span class="s1">&#39;pipeline.infrastructure.tablereader&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="c1"># avoid trigger warnings from MeasurementSetReader</span>
                <span class="n">ms</span> <span class="o">=</span> <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">get_measurement_set</span><span class="p">(</span><span class="n">ms_file</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">exclude_num_chans</span> <span class="o">=</span> <span class="p">()</span>
            <span class="n">observing_run</span><span class="o">.</span><span class="n">add_measurement_set</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">observing_run</span>

<div class="viewcode-block" id="SelfcalHeuristics.tclean_wrapper">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.tclean_wrapper">[docs]</a>
    <span class="k">def</span> <span class="nf">tclean_wrapper</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">imagename</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="s1">&#39;undefined&#39;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">smallscalebias</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">imsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
            <span class="n">cycleniter</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">uvtaper</span><span class="o">=</span><span class="p">[],</span>
            <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">sidelobethreshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">smoothfactor</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>  <span class="n">noisethreshold</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">lownoisethreshold</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nterms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cyclefactor</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">uvrange</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;0.0Jy&#39;</span><span class="p">,</span> <span class="n">startmodel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">pblimit</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pbmask</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">obstype</span><span class="o">=</span><span class="s1">&#39;single-point&#39;</span><span class="p">,</span> <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">savemodel_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">resume</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for tclean with keywords set to values desired for the Large Program imaging</span>
<span class="sd">        See the CASA 6.1.1 documentation for tclean to get the definitions of all the parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NF RMS Multiplier: </span><span class="si">%r</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nfrms_multiplier</span><span class="p">)</span>
        <span class="c1"># Minimize out the nfrms_multiplier at 1.</span>
        <span class="n">nfrms_multiplier</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nfrms_multiplier</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mask</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">usemask</span> <span class="o">=</span> <span class="s1">&#39;auto-multithresh&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usemask</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="o">!=</span> <span class="s1">&#39;0.0Jy&#39;</span><span class="p">:</span>
            <span class="n">nsigma</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">nsigma</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nsigma</span><span class="o">*</span><span class="n">nfrms_multiplier</span><span class="o">*</span><span class="mf">0.66</span> <span class="o">&gt;</span> <span class="n">nsigma</span><span class="p">:</span>
                <span class="n">nsigma</span> <span class="o">=</span> <span class="n">nsigma</span><span class="o">*</span><span class="n">nfrms_multiplier</span><span class="o">*</span><span class="mf">0.66</span>

        <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
            <span class="n">sidelobethreshold</span> <span class="o">=</span> <span class="mf">2.5</span>
            <span class="n">smoothfactor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">noisethreshold</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">lownoisethreshold</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">cycleniter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">cyclefactor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">band_properties</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;75thpct_uv&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2000.0</span><span class="p">:</span>
                <span class="n">sidelobethreshold</span> <span class="o">=</span> <span class="mf">2.0</span>

        <span class="k">if</span> <span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
            <span class="n">sidelobethreshold</span> <span class="o">=</span> <span class="mf">1.25</span>
            <span class="n">smoothfactor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">noisethreshold</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">lownoisethreshold</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">cycleniter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">cyclefactor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">elif</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">telescope</span><span class="p">:</span>
            <span class="n">sidelobethreshold</span> <span class="o">=</span> <span class="mf">2.0</span>
            <span class="n">smoothfactor</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">noisethreshold</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">lownoisethreshold</span> <span class="o">=</span> <span class="mf">1.5</span><span class="o">*</span><span class="n">nfrms_multiplier</span>
            <span class="n">pblimit</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.1</span>
            <span class="n">cycleniter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">cyclefactor</span> <span class="o">=</span> <span class="mf">3.0</span>
            <span class="n">pbmask</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">tclean_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vis&#39;</span><span class="p">:</span> <span class="n">vis</span><span class="p">,</span>
                       <span class="s1">&#39;imagename&#39;</span><span class="p">:</span> <span class="n">imagename</span><span class="p">,</span>
                       <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span>
                       <span class="s1">&#39;specmode&#39;</span><span class="p">:</span> <span class="s1">&#39;mfs&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;deconvolver&#39;</span><span class="p">:</span> <span class="s1">&#39;mtmfs&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;scales&#39;</span><span class="p">:</span> <span class="n">scales</span><span class="p">,</span>
                       <span class="s1">&#39;gridder&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridder</span><span class="p">,</span>
                       <span class="s1">&#39;weighting&#39;</span><span class="p">:</span> <span class="s1">&#39;briggs&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;robust&#39;</span><span class="p">:</span> <span class="n">robust</span><span class="p">,</span>
                       <span class="s1">&#39;gain&#39;</span><span class="p">:</span> <span class="n">gain</span><span class="p">,</span>
                       <span class="s1">&#39;imsize&#39;</span><span class="p">:</span> <span class="n">imsize</span><span class="p">,</span>
                       <span class="s1">&#39;cell&#39;</span><span class="p">:</span> <span class="n">cellsize</span><span class="p">,</span>
                       <span class="s1">&#39;smallscalebias&#39;</span><span class="p">:</span> <span class="n">smallscalebias</span><span class="p">,</span>  <span class="c1"># set to CASA&#39;s default of 0.6 unless manually changed</span>
                       <span class="s1">&#39;niter&#39;</span><span class="p">:</span> <span class="n">niter</span><span class="p">,</span>  <span class="c1"># we want to end on the threshold</span>
                       <span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="n">interactive</span><span class="p">,</span>
                       <span class="s1">&#39;nsigma&#39;</span><span class="p">:</span> <span class="n">nsigma</span><span class="p">,</span>
                       <span class="s1">&#39;cycleniter&#39;</span><span class="p">:</span> <span class="n">cycleniter</span><span class="p">,</span>
                       <span class="s1">&#39;cyclefactor&#39;</span><span class="p">:</span> <span class="n">cyclefactor</span><span class="p">,</span>
                       <span class="s1">&#39;uvtaper&#39;</span><span class="p">:</span> <span class="n">uvtaper</span><span class="p">,</span>
                       <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
                       <span class="s1">&#39;usemask&#39;</span><span class="p">:</span> <span class="n">usemask</span><span class="p">,</span>
                       <span class="s1">&#39;savemodel&#39;</span><span class="p">:</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;sidelobethreshold&#39;</span><span class="p">:</span> <span class="n">sidelobethreshold</span><span class="p">,</span>
                       <span class="s1">&#39;noisethreshold&#39;</span><span class="p">:</span> <span class="n">noisethreshold</span><span class="p">,</span>
                       <span class="s1">&#39;lownoisethreshold&#39;</span><span class="p">:</span> <span class="n">lownoisethreshold</span><span class="p">,</span>
                       <span class="s1">&#39;smoothfactor&#39;</span><span class="p">:</span> <span class="n">smoothfactor</span><span class="p">,</span>
                       <span class="s1">&#39;pbmask&#39;</span><span class="p">:</span> <span class="n">pbmask</span><span class="p">,</span>
                       <span class="s1">&#39;pblimit&#39;</span><span class="p">:</span> <span class="n">pblimit</span><span class="p">,</span>
                       <span class="s1">&#39;nterms&#39;</span><span class="p">:</span> <span class="n">nterms</span><span class="p">,</span>
                       <span class="s1">&#39;uvrange&#39;</span><span class="p">:</span> <span class="n">uvrange</span><span class="p">,</span>
                       <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
                       <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="n">parallel</span><span class="p">,</span>
                       <span class="s1">&#39;phasecenter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">,</span>
                       <span class="s1">&#39;reffreq&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reffreq</span><span class="p">,</span>
                       <span class="s1">&#39;startmodel&#39;</span><span class="p">:</span> <span class="n">startmodel</span><span class="p">,</span>
                       <span class="s1">&#39;datacolumn&#39;</span><span class="p">:</span> <span class="n">datacolumn</span><span class="p">,</span>
                       <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="n">spw</span><span class="p">,</span>
                       <span class="s1">&#39;fullsummary&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
        <span class="c1"># PIPE-2173: only use the Pipeline heuristics reffreq in hif_selfcal() when:</span>
        <span class="c1">#     * deconvolver: &#39;mtmfs&#39;, and</span>
        <span class="c1">#     * nterms = None (casa default to 2) or nterms &gt;=2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">tclean_args</span><span class="p">[</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">tclean_args</span><span class="p">[</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">tclean_args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;reffreq&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">tc_ret</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">savemodel_only</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resume</span><span class="p">:</span>
                <span class="n">image_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.image*&#39;</span><span class="p">,</span> <span class="s1">&#39;.mask&#39;</span><span class="p">,</span> <span class="s1">&#39;.model*&#39;</span><span class="p">,</span> <span class="s1">&#39;.pb*&#39;</span><span class="p">,</span> <span class="s1">&#39;.psf*&#39;</span><span class="p">,</span> <span class="s1">&#39;.residual*&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;.sumwt*&#39;</span><span class="p">,</span> <span class="s1">&#39;.gridwt*&#39;</span><span class="p">,</span> <span class="s1">&#39;.weight&#39;</span>
                              <span class="s1">&#39;.alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;.alpha.error&#39;</span><span class="p">,</span> <span class="s1">&#39;.beta&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">([</span><span class="n">imagename</span><span class="o">+</span><span class="n">ext</span> <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">image_exts</span><span class="p">])</span>
            <span class="n">tc_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">tclean</span><span class="p">(</span><span class="o">**</span><span class="n">tclean_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">savemodel</span> <span class="o">==</span> <span class="s1">&#39;modelcolumn&#39;</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running tclean in the prediction-only setting to fill the MS model column.&quot;</span><span class="p">)</span>
            <span class="c1"># A workaround for CAS-14386</span>
            <span class="n">parallel_predict</span> <span class="o">=</span> <span class="n">parallel</span>
            <span class="k">if</span> <span class="n">parallel_predict</span> <span class="ow">and</span> <span class="s1">&#39;mosaic&#39;</span> <span class="ow">in</span> <span class="n">tclean_args</span><span class="p">[</span><span class="s1">&#39;gridder&#39;</span><span class="p">]:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;A parallel model write operation does not work with gridder=&#39;mosaic&#39;: enforcing parallel=False.&quot;</span><span class="p">)</span>
                <span class="n">parallel_predict</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">tclean_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;niter&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s1">&#39;interactive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">&#39;nsigma&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                                <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;usemask&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;savemodel&#39;</span><span class="p">:</span> <span class="s1">&#39;modelcolumn&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;calcres&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">&#39;calcpsf&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">&#39;restoration&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0mJy&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;parallel&#39;</span><span class="p">:</span> <span class="n">parallel_predict</span><span class="p">,</span>
                                <span class="s1">&#39;startmodel&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">})</span>
            <span class="n">tc_ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">tclean</span><span class="p">(</span><span class="o">**</span><span class="n">tclean_args</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tc_ret</span></div>


<div class="viewcode-block" id="SelfcalHeuristics.remove_dirs">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.remove_dirs">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_dirs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dir_names</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove dirs based on a list of glob pattern.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dir_names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">dir_name_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dir_names</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dir_name_list</span> <span class="o">=</span> <span class="n">dir_names</span>
        <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dir_name_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dir_select</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">dir_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dir_select</span><span class="p">)</span></div>


<div class="viewcode-block" id="SelfcalHeuristics.move_dir">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.move_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">move_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_dirname</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Move a directory to a new location.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already exists. Will remove it first.&quot;</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_dirname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">old_dirname</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not exist&quot;</span><span class="p">,</span> <span class="n">old_dirname</span><span class="p">)</span></div>


<div class="viewcode-block" id="SelfcalHeuristics.copy_dir">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.copy_dir">[docs]</a>
    <span class="k">def</span> <span class="nf">copy_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_dirname</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Copy a directory to a new location.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> already exists. Will remove it first.&quot;</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">new_dirname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">old_dirname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">old_dirname</span><span class="p">,</span> <span class="n">new_dirname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not exist&quot;</span><span class="p">,</span> <span class="n">old_dirname</span><span class="p">)</span></div>


<div class="viewcode-block" id="SelfcalHeuristics.get_sensitivity">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.get_sensitivity">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sensitivity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate sensitivty from the Pipeline standard imaging heuristics.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw_virtual</span>

        <span class="k">def</span> <span class="nf">custom_filter</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">getMessage</span><span class="p">(),</span> <span class="s1">&#39;*channel bandwidths ratio*&#39;</span><span class="p">)</span>

        <span class="c1"># PIPE-1827: filter out the &quot;channel bandwidths ratio&quot; warning messages during sensitivity calculations.</span>
        <span class="k">with</span> <span class="n">logging</span><span class="o">.</span><span class="n">log_level</span><span class="p">(</span><span class="s1">&#39;pipeline.hif.heuristics.imageparams_base&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">custom_filter</span><span class="p">):</span>
            <span class="n">sensitivity</span><span class="p">,</span> <span class="n">eff_ch_bw</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">sens_reffreq</span><span class="p">,</span> <span class="n">known_per_spw_cont_sensitivities_all_chan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span><span class="o">.</span><span class="n">calc_sensitivities</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">{},</span>
                <span class="s1">&#39;cont&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gridder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span><span class="p">,</span> <span class="s1">&#39;briggs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">robust</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvtaper</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="p">{},</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">calc_reffreq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Note: sensitivity and sens_bw are expected to be one-elements Numpy arrays.</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sens_bw</span> <span class="o">=</span> <span class="n">sens_bw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sens_reffreq</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">sens_reffreq</span><span class="o">/</span><span class="mf">1e9</span><span class="si">}</span><span class="s1">GHz&#39;</span>

        <span class="k">return</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">sens_reffreq</span></div>


    <span class="k">def</span> <span class="nf">get_dr_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">.get_dr_correction() is not implemented yet!&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SelfcalHeuristics.__call__">
<a class="viewcode-back" href="../../../../../_autosummary/pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.html#pipeline.hif.heuristics.auto_selfcal.auto_selfcal.SelfcalHeuristics.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute auto_selfcal on a set of per-targets MSes.</span>

<span class="sd">        cleantarget: a list of CleanTarget objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">all_targets</span><span class="p">,</span> <span class="n">n_ants</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">applycal_interp</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> \
            <span class="n">solints</span><span class="p">,</span> <span class="n">gaincal_combine</span><span class="p">,</span> <span class="n">solmode</span><span class="p">,</span> <span class="n">applycal_mode</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">spectral_scan</span><span class="p">,</span> <span class="n">spws_set</span><span class="p">,</span> <span class="n">spwsarray_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prep_selfcal</span><span class="p">()</span>

        <span class="c1"># Currently, we are still using a modified version of the prototype selfcal preparation scheme to prepare &quot;selfcal_library&quot;.</span>
        <span class="c1"># Then we override a subset of selfcal input parameters using PL-heuristics-based values.</span>
        <span class="c1"># Eventually, we will retire the prototype selfcal preparation function entirely.</span>

        <span class="n">cellsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsize</span>
        <span class="n">imsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imsize</span>

        <span class="n">vislist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vislist</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parallel</span>

        <span class="n">vis</span> <span class="o">=</span> <span class="n">vislist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">##</span>
        <span class="c1"># create initial images for each target to evaluate SNR and beam</span>
        <span class="c1"># replicates what a preceding hif_makeimages would do</span>
        <span class="c1"># Enables before/after comparison and thresholds to be calculated</span>
        <span class="c1"># based on the achieved S/N in the real data</span>
        <span class="c1">##</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="c1"># note: sensitivity here is numpy.float64 and .copy() is allowed.</span>
                    <span class="n">sensitivity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">()</span>
                    <span class="n">sensitivity_nomod</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sensitivity_vla</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reffreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">()</span>

                <span class="c1"># make images using the appropriate tclean heuristics for each telescope</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">)</span>
                <span class="c1"># Because tclean doesn&#39;t deal in NF masks, the automask from the initial image is likely to contain a lot of noise unless</span>
                <span class="c1"># we can get an estimate of the NF modifier for the auto-masking thresholds. To do this, we need to create a very basic mask</span>
                <span class="c1"># with the dirty image. So we just use one iteration with a tiny gain so that nothing is really subtracted off.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                    <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_dirty&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                    <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;0.0Jy&#39;</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gain</span><span class="o">=</span><span class="mf">0.00001</span><span class="p">,</span>
                    <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                    <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                    <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                    <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                    <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                    <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">])</span>

                <span class="n">dirty_SNR</span><span class="p">,</span> <span class="n">dirty_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">dirty_NF_SNR</span><span class="p">,</span> <span class="n">dirty_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dirty_NF_SNR</span><span class="p">,</span> <span class="n">dirty_NF_RMS</span> <span class="o">=</span> <span class="n">dirty_SNR</span><span class="p">,</span> <span class="n">dirty_RMS</span>
                
                <span class="n">dr_mod</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">dr_mod</span> <span class="o">=</span> <span class="n">get_dr_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">dirty_SNR</span><span class="o">*</span><span class="n">dirty_RMS</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">vislist</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DR modifier: </span><span class="si">{</span><span class="n">dr_mod</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="n">dr_mod</span>   <span class="c1"># apply DR modifier</span>
                    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_9&#39;</span> <span class="ow">or</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_10&#39;</span><span class="p">:</span>   <span class="c1"># adjust for DSB noise increase</span>
                        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span>  <span class="c1"># *4.0  might be unnecessary with DR mods</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">initial_tclean_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                    <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_initial&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span>
                    <span class="n">nsigma</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sensitivity</span> <span class="o">*</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                    <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span> <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                    <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                    <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                    <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                    <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">dirty_NF_RMS</span> <span class="o">/</span> <span class="n">dirty_RMS</span><span class="p">)</span>
                <span class="n">initial_SNR</span><span class="p">,</span> <span class="n">initial_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">initial_NF_SNR</span><span class="p">,</span> <span class="n">initial_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">initial_NF_SNR</span><span class="p">,</span> <span class="n">initial_NF_RMS</span> <span class="o">=</span> <span class="n">initial_SNR</span><span class="p">,</span> <span class="n">initial_RMS</span>
                <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                    <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;theoretical_sensitivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitivity_nomod</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;clean_threshold_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">4.0</span>
                <span class="k">if</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">:</span>
                    <span class="c1"># selfcal_library[target][band][&#39;theoretical_sensitivity&#39;] = -99.0</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;theoretical_sensitivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sensitivity_vla</span>
                    <span class="k">if</span> <span class="n">initial_tclean_return</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">initial_tclean_return</span><span class="p">[</span><span class="s1">&#39;iterdone&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;clean_threshold_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_tclean_return</span><span class="p">[</span><span class="s1">&#39;summaryminor&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;peakRes&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;clean_threshold_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">*</span><span class="n">initial_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_SNR</span>
                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># updated nterms if needed based on S/N and fracbw</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_nterms</span><span class="p">(</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">],</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">])</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_NF_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_NF_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_NF_RMS</span> <span class="k">if</span> <span class="n">initial_NF_RMS</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">initial_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_dirty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirty_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_dirty&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dirty_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_major_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_minor_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_PA_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">goodMask</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;intflux_orig&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;e_intflux_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">initial_RMS</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;intflux_orig&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;e_intflux_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.0</span>

        <span class="c1"># MAKE DIRTY PER SPW IMAGES TO PROPERLY ASSESS DR MODIFIERS</span>
        <span class="c1">##</span>
        <span class="c1"># Make a initial image per spw images to assess overall improvement</span>
        <span class="c1">##</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spw_map&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_spw_map</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">,</span>
                                                                       <span class="n">target</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">)</span>

                <span class="c1"># code to work around some VLA data not having the same number of spws due to missing BlBPs</span>
                <span class="c1"># selects spwlist from the visibilities with the greates number of spws</span>
                <span class="c1"># PS: We now track spws on an EB by EB basis soI have removed much of the maxspwvis code.</span>
                <span class="n">spw_bandwidths_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">spw_effective_bandwidths_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_spw_bandwidth</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">vislist</span><span class="p">)</span>

                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;total_bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cont.dat does not contain all spws; falling back to total bandwidth&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">spw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]:</span>
                        <span class="n">keylist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">spw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;total_bandwidth&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spw_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;total_effective_bandwidth&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">spw_effective_bandwidths_dict</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_all_spws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
                <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1"># potential place where diff spws for different VLA EBs could cause problems</span>
                    <span class="n">spwlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw_virtual</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
                        <span class="n">keylist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">spw</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keylist</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">):</span>
                            <span class="n">spws_per_vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_real_spwsel</span><span class="p">([</span><span class="n">spw</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">),</span> <span class="n">vislist</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                                <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_dirty&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                                <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;0.0Jy&#39;</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                                <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                                <span class="n">nterms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spws_per_vis</span><span class="p">,</span> <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span>
                                <span class="p">[</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                                <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">])</span>
                        <span class="n">dirty_per_spw_SNR</span><span class="p">,</span> <span class="n">dirty_per_spw_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">dirty_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">dirty_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_dirty.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dirty_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">dirty_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">dirty_per_spw_SNR</span><span class="p">,</span> <span class="n">dirty_per_spw_RMS</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                                <span class="n">sensitivity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                                <span class="n">dr_mod</span> <span class="o">=</span> <span class="n">get_dr_correction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">dirty_per_spw_SNR</span><span class="o">*</span><span class="n">dirty_per_spw_RMS</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">vislist</span><span class="p">)</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DR modifier: </span><span class="si">{</span><span class="n">dr_mod</span><span class="si">}</span><span class="s1">  SPW: </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="n">dr_mod</span>
                                <span class="k">if</span> <span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_9&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_10&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">dr_mod</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>   <span class="c1"># adjust for DSB noise increase</span>
                                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">4.0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sensitivity</span> <span class="o">=</span> <span class="mf">0.0</span>
                            <span class="n">spws_per_vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_real_spwsel</span><span class="p">([</span><span class="n">spw</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">),</span> <span class="n">vislist</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                                <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_initial&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                                <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sensitivity</span> <span class="o">*</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                                <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                                <span class="n">nterms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spws_per_vis</span><span class="p">,</span>
                                <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                                <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                                <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">dirty_per_spw_NF_RMS</span><span class="o">/</span><span class="n">dirty_RMS</span><span class="p">)</span>

                        <span class="n">per_spw_SNR</span><span class="p">,</span> <span class="n">per_spw_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">initial_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">initial_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">initial_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">initial_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">per_spw_SNR</span><span class="p">,</span> <span class="n">per_spw_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_spw_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">per_spw_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_per_spw_NF_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_per_spw_NF_RMS</span>
                        <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">goodMask</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;intflux_orig&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                <span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;e_intflux_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">per_spw_RMS</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;intflux_orig&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                <span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;e_intflux_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.0</span>

        <span class="c1">##</span>
        <span class="c1"># estimate per scan/EB S/N using time on source and median scan times</span>
        <span class="c1">##</span>
        <span class="n">inf_EB_gaincal_combine_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;scan&#39;</span>
        <span class="n">inf_EB_gaintype_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;G&#39;</span>
        <span class="n">inf_EB_fallback_mode_dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;scan&#39;</span>

        <span class="n">solint_snr</span><span class="p">,</span> <span class="n">solint_snr_per_spw</span> <span class="o">=</span> <span class="n">get_SNR_self</span><span class="p">(</span>
            <span class="n">all_targets</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">n_ants</span><span class="p">,</span> <span class="n">solints</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaincal_combine</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaintype</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;scan&#39;</span>
            <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;scan&#39;</span>
            <span class="n">inf_EB_gaintype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &#39;G&#39;</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">inf_EB_gaintype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                    <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaincal_combine</span>  <span class="c1"># &#39;scan&#39;</span>
                    <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">:</span>
                        <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,field&#39;</span>
                    <span class="n">inf_EB_gaintype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaintype</span>  <span class="c1"># G</span>
                    <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># &#39;scan&#39;</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Estimated SNR per solint:&#39;</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">solint</span> <span class="ow">in</span> <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:0.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solint</span><span class="p">,</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">: </span><span class="si">{:0.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solint</span><span class="p">,</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]))</span>

        <span class="c1">##</span>
        <span class="c1"># Set clean selfcal thresholds</span>
        <span class="c1"># Open question about determining the starting and progression of clean threshold for</span>
        <span class="c1"># each iteration</span>
        <span class="c1"># Peak S/N &gt; 100; SNR/15 for first, successivly reduce to 3.0 sigma through each iteration?</span>
        <span class="c1"># Peak S/N &lt; 100; SNR/10.0</span>
        <span class="c1">##</span>
        <span class="c1"># Switch to a sensitivity for low frequency that is based on the residuals of the initial image for the</span>
        <span class="c1"># first couple rounds and then switch to straight nsigma? Determine based on fraction of pixels that the # initial mask covers to judge very extended sources?</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dividing_factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">8.0e9</span><span class="p">:</span>
                        <span class="n">dividing_factor_band</span> <span class="o">=</span> <span class="mf">40.0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dividing_factor_band</span> <span class="o">=</span> <span class="mf">15.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dividing_factor_band</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dividing_factor</span>
                <span class="n">nsigma_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">dividing_factor_band</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]</span>
                                     <span class="p">)</span>  <span class="c1"># restricts initial nsigma to be at least 5</span>

                <span class="c1"># count number of amplitude selfcal solints, repeat final clean depth of phase-only for amplitude selfcal</span>
                <span class="n">n_ap_solints</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">solint</span> <span class="ow">in</span> <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;ap&#39;</span> <span class="ow">in</span> <span class="n">solint</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_thresh_scaling</span> <span class="o">==</span> <span class="s1">&#39;loge&#39;</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nsigma_init</span><span class="p">),</span>
                                           <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">-</span> <span class="n">n_ap_solints</span><span class="p">)),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">3.0</span><span class="p">))]</span> <span class="o">*</span> <span class="n">n_ap_solints</span><span class="p">))</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">rel_thresh_scaling</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">nsigma_init</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">-</span> <span class="n">n_ap_solints</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_ap_solints</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># implicitly making log10 the default</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="mi">10</span> <span class="o">**</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">nsigma_init</span><span class="p">),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">3.0</span><span class="p">),</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">-</span> <span class="n">n_ap_solints</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">3.0</span><span class="p">))]</span> <span class="o">*</span> <span class="n">n_ap_solints</span><span class="p">))</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>  <span class="c1"># or (&#39;VLA&#39; in telescope)</span>
                    <span class="n">sensitivity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_9&#39;</span> <span class="ow">or</span> <span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_10&#39;</span><span class="p">:</span>   <span class="c1"># adjust for DSB noise increase</span>
                        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">4.0</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">):</span>
                        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">0.0</span>  <span class="c1"># empirical correction, VLA estimates for sensitivity have tended to be a factor of ~3 low</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">sensitivity</span>

        <span class="c1">##</span>
        <span class="c1"># Save self-cal library</span>
        <span class="c1">##</span>
        <span class="c1"># with open(&#39;selfcal_library.pickle&#39;, &#39;wb&#39;) as handle:</span>
        <span class="c1">#     pickle.dump(selfcal_library, handle, protocol=pickle.HIGHEST_PROTOCOL)</span>

        <span class="c1">##</span>
        <span class="c1"># Begin Self-cal loops</span>
        <span class="c1">##</span>
        <span class="n">iterjump</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>   <span class="c1"># useful if we want to jump iterations</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting selfcal procedure on: &#39;</span><span class="o">+</span><span class="n">target</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">band</span><span class="p">)</span>

                <span class="n">gaincal_preapply_gaintable</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">gaincal_spwmap</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">gaincal_interpolate</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">applycal_gaintable</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">applycal_spwmap</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">fallback</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">applycal_interpolate</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">for</span> <span class="n">iteration</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">iterjump</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">iterjump</span><span class="p">):</span>  <span class="c1"># allow jumping to amplitude selfcal and not need to use a while loop</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">iteration</span> <span class="o">==</span> <span class="n">iterjump</span><span class="p">:</span>
                        <span class="n">iterjump</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsnr_to_proceed</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="s1">&#39;*********** estimated SNR for solint=&#39;</span> <span class="o">+</span> <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; too low, measured: &#39;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;, Min SNR Required: &#39;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minsnr_to_proceed</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; **************&#39;</span><span class="p">)</span>
                        <span class="c1"># if a solution interval shorter than inf for phase-only SC has passed, attempt amplitude selfcal</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ap&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_amp_selfcal</span><span class="p">:</span>
                            <span class="n">iterjump</span> <span class="o">=</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ap&#39;</span><span class="p">)</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Attempting amplitude selfcal*************&#39;</span><span class="p">)</span>
                            <span class="k">continue</span>

                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Stop_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Estimated SNR too low for solint=&#39;</span><span class="o">+</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">solint</span> <span class="o">=</span> <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Starting with solint: &#39;</span><span class="o">+</span><span class="n">solint</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Continuing with solint: &#39;</span><span class="o">+</span><span class="n">solint</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
                        <span class="c1">##</span>
                        <span class="c1"># make images using the appropriate tclean heuristics for each telescope</span>
                        <span class="c1"># set threshold based on RMS of initial image and lower if value becomes lower</span>
                        <span class="c1"># during selfcal by resetting &#39;RMS_curr&#39; after the post-applycal evaluation</span>
                        <span class="c1">##</span>

                        <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                            <span class="n">prev_solint</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span>
                            <span class="n">prev_iteration</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">prev_solint</span><span class="p">][</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span>

                            <span class="n">nterms_changed</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
                                <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">prev_solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prev_iteration</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_post.model.tt*&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span>

                            <span class="k">if</span> <span class="n">nterms_changed</span><span class="p">:</span>
                                <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">resume</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">prev_solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prev_iteration</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_post.*&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="s1">&#39;nearfield&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                                        <span class="k">continue</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">copy_dir</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">prev_solint</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">prev_iteration</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;_post&quot;</span><span class="p">,</span> <span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resume</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="n">nfsnr_modifier</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                            <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span>
                            <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span>
                            <span class="n">nsigma</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span>
                            <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">*</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                            <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                            <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                            <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                            <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                            <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                            <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                            <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">nfsnr_modifier</span><span class="p">,</span>
                            <span class="n">resume</span><span class="o">=</span><span class="n">resume</span><span class="p">)</span>

                        <span class="c1"># Check if a mask was actually created: if not, the model will be empty and gaincal will fail.</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.image.tt0&#39;</span><span class="p">):</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Stop_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Empty model for solint &#39;</span><span class="o">+</span><span class="n">solint</span>
                            <span class="k">break</span>  <span class="c1"># breakout of loop because the model is empty and gaincal will therefore fail</span>

                        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.image.tt0&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                            <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                            <span class="c1">##</span>
                            <span class="c1"># Restore original flagging state each time before applying a new gaintable</span>
                            <span class="c1">##</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s2">&quot;.flagversions/flags.selfcal_starting_flags_&quot;</span><span class="o">+</span><span class="n">sani_target</span><span class="p">):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span>
                                    <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;restore&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags_&#39;</span> <span class="o">+</span> <span class="n">sani_target</span><span class="p">,</span>
                                    <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Flag states at start of reduction&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags_&#39;</span><span class="o">+</span><span class="n">sani_target</span><span class="p">)</span>

                        <span class="c1"># We need to redo saving the model now that we have potentially unflagged some data.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                            <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span>
                            <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span>
                            <span class="n">nsigma</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span>
                            <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">*</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;modelcolumn&#39;</span><span class="p">,</span>
                            <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span>
                            <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                            <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                            <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                            <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                            <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                            <span class="n">savemodel_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                            <span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">gaincal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="c1">##</span>
                            <span class="c1"># Solve gain solutions per MS, target, solint, and band</span>
                            <span class="c1">##</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">)</span>
                            <span class="c1">##</span>
                            <span class="c1"># Set gaincal parameters depending on which iteration and whether to use combine=spw for inf_EB or not</span>
                            <span class="c1"># Defaults should assume combine=&#39;scan&#39; and gaintpe=&#39;G&#39; will fallback to combine=&#39;scan,spw&#39; if too much flagging</span>
                            <span class="c1"># At some point remove the conditional for use_inf_EB_preapply, since there isn&#39;t a reason not to do it</span>
                            <span class="c1">##</span>

                            <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                                <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gaincal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gaincal_gaintype</span> <span class="o">=</span> <span class="n">inf_EB_gaintype_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span>
                                <span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span>
                                <span class="k">if</span> <span class="s1">&#39;spw&#39;</span> <span class="ow">in</span> <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]]</span>
                                <span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                    <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                    <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                                <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_inf_EB_0_p.g&#39;</span><span class="p">]</span>
                                <span class="n">gaincal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]]</span>
                                <span class="n">gaincal_gaintype</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
                                <span class="k">if</span> <span class="s1">&#39;spw&#39;</span> <span class="ow">in</span> <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span>
                                                            <span class="p">[</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                <span class="k">elif</span> <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spwmap&#39;</span><span class="p">:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">]</span>
                                                            <span class="p">[</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]]</span>
                                <span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_inf_EB_0&#39;</span><span class="o">+</span><span class="s1">&#39;_p.g&#39;</span><span class="p">,</span>
                                                           <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_p.g&#39;</span><span class="p">]</span>
                            <span class="k">elif</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ap&#39;</span><span class="p">:</span>
                                <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_phase_solint&#39;</span><span class="p">]][</span><span class="s1">&#39;gaintable&#39;</span><span class="p">]</span>
                                <span class="n">gaincal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span>
                                <span class="n">gaincal_gaintype</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
                                <span class="k">if</span> <span class="s1">&#39;spw&#39;</span> <span class="ow">in</span> <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span>
                                                           <span class="p">[</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                <span class="k">elif</span> <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spwmap&#39;</span><span class="p">:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span>
                                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">]</span>
                                                           <span class="p">[</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span>
                                                            <span class="p">[</span><span class="s1">&#39;spwmap&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                    <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                <span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]</span>
                                                             <span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">])</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;linearPD&#39;</span><span class="p">]</span>
                                <span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_phase_solint&#39;</span><span class="p">]][</span><span class="s1">&#39;gaintable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                                    <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_ap.g&#39;</span><span class="p">]</span>
                            <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                            <span class="k">if</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ap&#39;</span><span class="p">:</span>
                                <span class="n">solnorm</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">solnorm</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">nspw_sets</span> <span class="o">=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">nspw_sets</span> <span class="o">=</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># only necessary to loop over gain cal when in inf_EB to avoid inf_EB solving for all spws</span>
                                <span class="n">nspw_sets</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspw_sets</span><span class="p">):</span>  <span class="c1"># run gaincal on each spw set to handle spectral scans (one run one time if not inf_EB)</span>
                                <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">nspw_sets</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">spwselect</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">spwselect</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">spwselect</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">]</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;Running gaincal on &#39;</span><span class="o">+</span><span class="n">spwselect</span><span class="o">+</span><span class="s1">&#39; for &#39;</span><span class="o">+</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">gaincal</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span>
                                                 <span class="n">caltable</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                                 <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;.g&#39;</span><span class="p">,</span>
                                                 <span class="n">gaintype</span><span class="o">=</span><span class="n">gaincal_gaintype</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwselect</span><span class="p">,</span>
                                                 <span class="n">refant</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;refant&#39;</span><span class="p">],</span>
                                                 <span class="n">calmode</span><span class="o">=</span><span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span> <span class="n">solnorm</span><span class="o">=</span><span class="n">solnorm</span><span class="p">,</span>
                                                 <span class="n">solint</span><span class="o">=</span><span class="n">solint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_EB&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_ap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                                 <span class="n">minsnr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaincal_minsnr</span><span class="p">,</span> <span class="n">minblperant</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span>
                                                 <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">gaintable</span><span class="o">=</span><span class="n">gaincal_preapply_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span>
                                                 <span class="n">spwmap</span><span class="o">=</span><span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                                                 <span class="n">interp</span><span class="o">=</span><span class="n">gaincal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span>
                                                 <span class="n">append</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
                                                     <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                                     <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">))</span>
                            <span class="c1">##</span>
                            <span class="c1"># default is to run without combine=spw for inf_EB, here we explicitly run a test inf_EB with combine=&#39;scan,spw&#39; to determine</span>
                            <span class="c1"># the number of flagged antennas when combine=&#39;spw&#39; then determine if it needs spwmapping or to use the gaintable with spwcombine.</span>
                            <span class="c1">##</span>
                            <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span> <span class="ow">and</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">(</span><span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">)</span>
                                <span class="n">test_gaincal_combine</span> <span class="o">=</span> <span class="s1">&#39;scan,spw&#39;</span>
                                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;mosaic&#39;</span><span class="p">:</span>
                                    <span class="n">test_gaincal_combine</span> <span class="o">+=</span> <span class="s1">&#39;,field&#39;</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                                    <span class="c1"># run gaincal on each spw set to handle spectral scans</span>
                                    <span class="k">if</span> <span class="n">nspw_sets</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">spwselect</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">spwselect</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Running gaincal on &#39;</span><span class="o">+</span><span class="n">spwselect</span><span class="o">+</span><span class="s1">&#39; for test_inf_EB.g&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">gaincal</span><span class="p">(</span>
                                        <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">caltable</span><span class="o">=</span><span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">,</span> <span class="n">gaintype</span><span class="o">=</span><span class="n">gaincal_gaintype</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spwselect</span><span class="p">,</span>
                                        <span class="n">refant</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;refant&#39;</span><span class="p">],</span>
                                        <span class="n">calmode</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="n">solint</span><span class="o">=</span><span class="n">solint</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_EB&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_ap&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                        <span class="n">minsnr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gaincal_minsnr</span><span class="p">,</span> <span class="n">minblperant</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="n">test_gaincal_combine</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span>
                                        <span class="n">gaintable</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">spwmap</span><span class="o">=</span><span class="p">[],</span>
                                        <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                                        <span class="n">append</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">))</span>

                                <span class="n">spwlist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;spws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="n">map_index</span><span class="p">,</span> <span class="n">spwmap</span><span class="p">,</span> <span class="n">applycal_spwmap_inf_EB</span> <span class="o">=</span> <span class="n">analyze_inf_EB_flagging</span><span class="p">(</span>
                                    <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">spwlist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                    <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">,</span>
                                    <span class="n">spectral_scan</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">)</span>

                                <span class="n">inf_EB_fallback_mode_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;inf_EB </span><span class="si">{</span><span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">applycal_spwmap_inf_EB</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;combinespw&#39;</span><span class="p">:</span>
                                        <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>
                                        <span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scan,spw&#39;</span>
                                        <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scan,spw&#39;</span>
                                        <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]]</span>

                                        <span class="bp">self</span><span class="o">.</span><span class="n">move_dir</span><span class="p">(</span>
                                            <span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">vis</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span>
                                            <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.g&#39;</span><span class="p">)</span>

                                    <span class="k">if</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;spwmap&#39;</span><span class="p">:</span>
                                        <span class="n">gaincal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_spwmap_inf_EB</span>
                                        <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scan&#39;</span>
                                        <span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scan&#39;</span>
                                        <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_spwmap_inf_EB</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">(</span><span class="s1">&#39;test_inf_EB.g&#39;</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                            <span class="c1">##</span>
                            <span class="c1"># Apply gain solutions per MS, target, solint, and band</span>
                            <span class="c1">##</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">applycal</span><span class="p">(</span>
                                <span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">gaintable</span><span class="o">=</span><span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span>
                                <span class="n">interp</span><span class="o">=</span><span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span>
                                <span class="n">calwt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spwmap</span><span class="o">=</span><span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">],</span>
                                <span class="n">applymode</span><span class="o">=</span><span class="n">applycal_mode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span>
                                <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">])</span>

                        <span class="c1"># Create post self-cal image using the model as a startmodel to evaluate how much selfcal helped</span>
                        <span class="c1">##</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">remove_dirs</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_post*&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                            <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_post&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                            <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">],</span>
                            <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">*</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">])</span> <span class="o">+</span>
                            <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                            <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                            <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                            <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                            <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                            <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">nfsnr_modifier</span><span class="p">)</span>

                        <span class="c1">##</span>
                        <span class="c1"># Do the assessment of the post- (and pre-) selfcal images.</span>
                        <span class="c1">##</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Pre selfcal assessemnt: &#39;</span><span class="o">+</span><span class="n">target</span><span class="p">)</span>

                        <span class="n">SNR</span><span class="p">,</span> <span class="n">RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.image.tt0&#39;</span><span class="p">,</span>
                                                <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_post.mask&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">SNR_NF</span><span class="p">,</span> <span class="n">RMS_NF</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.image.tt0&#39;</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span>
                                <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_post.mask&#39;</span><span class="p">,</span>  <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">SNR_NF</span><span class="p">,</span> <span class="n">RMS_NF</span> <span class="o">=</span> <span class="n">SNR</span><span class="p">,</span> <span class="n">RMS</span>

                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Post selfcal assessemnt: &#39;</span><span class="o">+</span><span class="n">target</span><span class="p">)</span>

                        <span class="n">post_SNR</span><span class="p">,</span> <span class="n">post_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span>
                            <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_post.image.tt0&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">post_SNR_NF</span><span class="p">,</span> <span class="n">post_RMS_NF</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_post.image.tt0&#39;</span><span class="p">,</span>
                                <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">post_SNR_NF</span><span class="p">,</span> <span class="n">post_RMS_NF</span> <span class="o">=</span> <span class="n">post_SNR</span><span class="p">,</span> <span class="n">post_RMS</span>

                        <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="c1"># Change nterms to 2 if needed based on fracbw and SNR</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_nterms</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">],</span> <span class="n">post_SNR</span><span class="p">)</span>

                        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                            <span class="c1">##</span>
                            <span class="c1"># record self cal results/details for this solint</span>
                            <span class="c1">##</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;SNR_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNR</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;SNR_NF_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNR_NF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_NF_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RMS_NF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_major_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_minor_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_PA_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;gaintable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_gaintable</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">+</span><span class="mi">0</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_spwmap</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;applycal_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_mode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;applycal_interpolate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">applycal_interpolate</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;gaincal_combine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inf_EB_gaincal_combine_dict</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                <span class="n">vis</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span> <span class="k">else</span> <span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;clean_threshold&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nsigma&#39;</span><span class="p">][</span>
                                <span class="n">iteration</span><span class="p">]</span> <span class="o">*</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;intflux_pre&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span>
                                <span class="s1">&#39;e_intflux_pre&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.image.tt0&#39;</span><span class="p">,</span> <span class="n">RMS</span><span class="p">)</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;fallback&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback</span><span class="p">[</span><span class="n">vis</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;solmode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;&#39;</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_SNR</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_RMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;SNR_NF_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_SNR_NF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_NF_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">post_RMS_NF</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            
                            <span class="c1"># Update RMS value if necessary</span>
                            <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_post&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">vis</span> <span class="o">==</span> <span class="n">vislist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span>
                                    <span class="s1">&#39;RMS_post&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_NF_post&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;RMS_NF_post&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">vis</span> <span class="o">==</span> <span class="n">vislist</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span>
                                    <span class="s1">&#39;RMS_NF_post&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">solint</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_post.image.tt0&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                                <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_major_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_minor_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_PA_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;intflux_post&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                <span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;e_intflux_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">solint</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_post.image.tt0&#39;</span><span class="p">,</span> <span class="n">post_RMS</span><span class="p">)</span>

                        <span class="c1">##</span>
                        <span class="c1"># compare beam relative to original image to ensure we are not incrementally changing the beam in each iteration</span>
                        <span class="c1">##</span>
                        <span class="n">beamarea_orig</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_major_orig&#39;</span><span class="p">]</span> <span class="o">*</span> \
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_minor_orig&#39;</span><span class="p">]</span>
                        <span class="n">beamarea_post</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                            <span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_major_post&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                            <span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Beam_minor_post&#39;</span><span class="p">]</span>
                        <span class="n">delta_beamarea</span> <span class="o">=</span> <span class="p">(</span><span class="n">beamarea_post</span><span class="o">-</span><span class="n">beamarea_orig</span><span class="p">)</span><span class="o">/</span><span class="n">beamarea_orig</span>

                        <span class="c1"># PIPE-2192: use the updated self-calibration succeeding criteria.</span>

                        <span class="c1"># Check if a marginal inf_EB result will attempt inf next; otherwise, fail a marginal inf_EB</span>
                        <span class="n">marginal_inf_EB_will_attempt_next_solint</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span>
                            <span class="ow">and</span> <span class="n">delta_beamarea</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span>
                            <span class="ow">and</span> <span class="p">(</span>
                                <span class="p">(</span><span class="o">-</span><span class="mf">0.02</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">post_SNR</span> <span class="o">-</span> <span class="n">SNR</span><span class="p">)</span> <span class="o">/</span> <span class="n">SNR</span> <span class="o">&lt;</span> <span class="mf">0.00</span><span class="p">)</span>
                                <span class="ow">or</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.02</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">post_SNR_NF</span> <span class="o">-</span> <span class="n">SNR_NF</span><span class="p">)</span> <span class="o">/</span> <span class="n">SNR_NF</span> <span class="o">&lt;</span> <span class="mf">0.00</span><span class="p">)</span>
                            <span class="p">)</span>
                            <span class="ow">and</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minsnr_to_proceed</span>
                        <span class="p">)</span>

                        <span class="c1"># Check if RMS change is acceptable</span>
                        <span class="n">RMS_change_acceptable</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">post_RMS</span> <span class="o">/</span> <span class="n">RMS</span> <span class="o">&lt;</span> <span class="mf">1.05</span> <span class="ow">and</span> <span class="n">post_RMS_NF</span> <span class="o">/</span> <span class="n">RMS_NF</span> <span class="o">&lt;</span> <span class="mf">1.05</span>
                        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">post_RMS</span> <span class="o">/</span> <span class="n">RMS</span> <span class="o">&gt;</span> <span class="mf">1.05</span> <span class="ow">or</span> <span class="n">post_RMS_NF</span> <span class="o">/</span> <span class="n">RMS_NF</span> <span class="o">&gt;</span> <span class="mf">1.05</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span>
                        <span class="p">)</span>

                        <span class="c1"># Check overall conditions for self-calibration success</span>
                        <span class="k">if</span> <span class="n">RMS_change_acceptable</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="p">(</span><span class="n">post_SNR</span> <span class="o">&gt;=</span> <span class="n">SNR</span> <span class="ow">and</span> <span class="n">post_SNR_NF</span> <span class="o">&gt;=</span> <span class="n">SNR_NF</span> <span class="ow">and</span> <span class="n">delta_beamarea</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span><span class="p">)</span>
                            <span class="ow">or</span> <span class="p">(</span>
                                <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span>
                                <span class="ow">and</span> <span class="n">marginal_inf_EB_will_attempt_next_solint</span>
                                <span class="ow">and</span> <span class="p">(</span><span class="n">post_SNR</span> <span class="o">-</span> <span class="n">SNR</span><span class="p">)</span> <span class="o">/</span> <span class="n">SNR</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.02</span>
                                <span class="ow">and</span> <span class="p">(</span><span class="n">post_SNR_NF</span> <span class="o">-</span> <span class="n">SNR_NF</span><span class="p">)</span> <span class="o">/</span> <span class="n">SNR_NF</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">0.02</span>
                                <span class="ow">and</span> <span class="n">delta_beamarea</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span>
                            <span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Stop_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>

                            <span class="c1"># keep track of whether inf_EB had a S/N decrease</span>
                            <span class="k">if</span> <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="p">(</span><span class="n">post_SNR</span><span class="o">-</span><span class="n">SNR</span><span class="p">)</span><span class="o">/</span><span class="n">SNR</span> <span class="o">&gt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">post_SNR_NF</span> <span class="o">-</span> <span class="n">SNR_NF</span><span class="p">)</span><span class="o">/</span><span class="n">SNR_NF</span> <span class="o">&gt;=</span> <span class="mf">0.0</span><span class="p">:</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;inf_EB_SNR_decrease&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;inf_EB_SNR_decrease&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;gaintable_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                    <span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;gaintable&#39;</span><span class="p">]</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span>
                                    <span class="n">solint</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;applycal_mode_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                    <span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;applycal_mode&#39;</span><span class="p">]</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;applycal_interpolate_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                    <span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;applycal_interpolate&#39;</span><span class="p">]</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;gaincal_combine_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                    <span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;gaincal_combine&#39;</span><span class="p">]</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Fail_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                            <span class="k">if</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_phase_solint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solint</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solint</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint_mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;iteration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">iteration</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1">##</span>
                        <span class="c1"># if S/N worsens, and/or beam area increases reject current solutions and reapply previous (or revert to origional data)</span>
                        <span class="c1">##</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                <span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">(</span>
                                <span class="n">solint</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span> <span class="ow">and</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;inf_EB_SNR_decrease&#39;</span><span class="p">]):</span>
                            <span class="n">reasons</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="n">post_SNR</span> <span class="o">&lt;=</span> <span class="n">SNR</span><span class="p">:</span>
                                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;S/N decrease&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">post_SNR_NF</span> <span class="o">&lt;</span> <span class="n">SNR_NF</span><span class="p">:</span>
                                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NF S/N decrease&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">delta_beamarea</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span><span class="p">:</span>
                                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Beam change beyond </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_beam_thresh</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">post_RMS</span> <span class="o">/</span> <span class="n">RMS</span> <span class="o">&gt;</span> <span class="mf">1.05</span> <span class="ow">and</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;RMS increase beyond 5%&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">post_RMS_NF</span> <span class="o">/</span> <span class="n">RMS_NF</span> <span class="o">&gt;</span> <span class="mf">1.05</span> <span class="ow">and</span> <span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solint</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">:</span>
                                <span class="n">reasons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;NF RMS increase beyond 5%&#39;</span><span class="p">)</span>
                            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reasons</span><span class="p">)</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Stop_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
                            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                                <span class="c1"># selfcal_library[target][band][vis][solint][&#39;Pass&#39;] = False</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Fail_Reason&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Reapplying previous solint solutions where available*************&#39;</span><span class="p">)</span>
                            <span class="c1"># if the final successful solint was inf_EB but inf_EB had a S/N decrease, don&#39;t count it as a success and revert to no selfcal</span>
                            <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;inf_EB&#39;</span> <span class="ow">and</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                    <span class="s1">&#39;inf_EB_SNR_decrease&#39;</span><span class="p">]:</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># remove the success from inf_EB</span>
                                    <span class="c1"># remove the success from inf_EB</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;inf_EB&#39;</span><span class="p">][</span><span class="s1">&#39;Fail_Reason&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39; with no successful solints later&#39;</span>
                            <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                                <span class="c1"># reapply only the previous gain tables, to get rid of solutions from this selfcal round</span>
                                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                        <span class="s1">&#39;****************Applying &#39;</span> <span class="o">+</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;gaintable_final&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                        <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;*************&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;restore&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags_&#39;</span><span class="o">+</span><span class="n">sani_target</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">applycal</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span>
                                                      <span class="n">gaintable</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;gaintable_final&#39;</span><span class="p">],</span>
                                                      <span class="n">interp</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;applycal_interpolate_final&#39;</span><span class="p">],</span>
                                                      <span class="n">calwt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spwmap</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap_final&#39;</span><span class="p">],</span>
                                                      <span class="n">applymode</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;applycal_mode_final&#39;</span><span class="p">],</span>
                                                      <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Removing all calibrations for &#39;</span><span class="o">+</span><span class="n">target</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;**************&#39;</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;restore&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags_&#39;</span><span class="o">+</span><span class="n">sani_target</span><span class="p">)</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">clearcal</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">])</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                        <span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_post&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                                        <span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                        <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;Pass&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">iteration</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">solint</span><span class="p">][</span><span class="s1">&#39;SNR_post&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]):</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updating solint = &#39;</span><span class="o">+</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; SNR&#39;</span><span class="p">)</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Was: </span><span class="si">{</span><span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="n">get_SNR_self_update</span><span class="p">([</span><span class="n">target</span><span class="p">],</span> <span class="n">band</span><span class="p">,</span> <span class="n">vislist</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">n_ants</span><span class="p">,</span> <span class="n">solint</span><span class="p">,</span>
                                                    <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">solint_snr</span><span class="p">)</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now: </span><span class="si">{</span><span class="n">solint_snr</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Selfcal passed, shortening solint*************&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Selfcal passed for Minimum solint*************&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Selfcal failed*************&#39;</span><span class="p">)</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;REASON: &#39;</span><span class="o">+</span><span class="n">reason</span><span class="p">)</span>
                            <span class="c1"># if a solution interval shorter than inf for phase-only SC has passed, attempt amplitude selfcal</span>
                            <span class="k">if</span> <span class="n">iteration</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">iteration</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;ap&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_amp_selfcal</span><span class="p">:</span>
                                <span class="n">iterjump</span> <span class="o">=</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ap&#39;</span><span class="p">)</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;****************Selfcal halted for phase, attempting amplitude*************&#39;</span><span class="p">)</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                    <span class="s1">&#39;****************Aborting further self-calibration attempts for &#39;</span> <span class="o">+</span> <span class="n">target</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span>
                                    <span class="s1">&#39;**************&#39;</span><span class="p">)</span>
                                <span class="k">break</span>  <span class="c1"># breakout of loops of successive solints since solutions are getting worse</span>

        <span class="c1">##</span>
        <span class="c1"># If we want to try amplitude selfcal, should we do it as a function out of the main loop or a separate loop?</span>
        <span class="c1"># Mechanics are likely to be a bit more simple since I expect we&#39;d only try a single solint=inf solution</span>
        <span class="c1">##</span>

        <span class="c1">##</span>
        <span class="c1"># Make a final image per target to assess overall improvement</span>
        <span class="c1">##</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">nfsnr_modifier</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span>
                <span class="n">clean_threshold</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;clean_threshold_orig&#39;</span><span class="p">],</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;clean_threshold_orig&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                        <span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">3.0</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;The clean threshold used for the initial image was less than 3*RMS_NF_curr; &#39;</span>
                             <span class="s1">&#39;the final image will use the same threshold as the initial image&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span>
                        <span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_final&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span>
                        <span class="n">nsigma</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">clean_threshold</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span>
                        <span class="n">nterms</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">],</span>
                        <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">],</span>
                        <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                        <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                        <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">nfsnr_modifier</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">copy_products</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_initial&#39;</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_final&#39;</span><span class="p">)</span>
                <span class="n">final_SNR</span><span class="p">,</span> <span class="n">final_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">final_NF_SNR</span><span class="p">,</span> <span class="n">final_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_NF_SNR</span><span class="p">,</span> <span class="n">final_NF_RMS</span> <span class="o">=</span> <span class="n">final_SNR</span><span class="p">,</span> <span class="n">final_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_NF_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_NF_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_NF_RMS</span>
                <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
                    <span class="n">bm</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">restoringbeam</span><span class="p">(</span><span class="n">polarization</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_major_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;major&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_minor_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;minor&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Beam_PA_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bm</span><span class="p">[</span><span class="s1">&#39;positionangle&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="c1"># recalc inital stats using final mask</span>
                <span class="n">final_SNR</span><span class="p">,</span> <span class="n">final_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span>
                                                    <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.mask&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                    <span class="n">final_NF_SNR</span><span class="p">,</span> <span class="n">final_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                        <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_final.mask&#39;</span><span class="p">,</span>
                        <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">final_NF_SNR</span><span class="p">,</span> <span class="n">final_NF_RMS</span> <span class="o">=</span> <span class="n">final_SNR</span><span class="p">,</span> <span class="n">final_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_RMS</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_NF_SNR</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_NF_RMS</span>
                <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">imagename</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">goodMask</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;intflux_final&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;e_intflux_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">,</span> <span class="n">final_RMS</span><span class="p">)</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;intflux_orig&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;e_intflux_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                        <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">],</span> <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_final.mask&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;intflux_final&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;e_intflux_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.0</span>

        <span class="c1">##</span>
        <span class="c1"># Make a final image per spw images to assess overall improvement</span>
        <span class="c1">##</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_all_spws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
                <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">spwlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spw_virtual</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generating final per-SPW images for &#39;</span><span class="o">+</span><span class="n">target</span><span class="o">+</span><span class="s1">&#39; in &#39;</span><span class="o">+</span><span class="n">band</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spw_map&#39;</span><span class="p">]:</span>
                        <span class="c1"># omit DR modifiers here since we should have increased DR significantly</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                        <span class="n">vlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">vis</span> <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span> <span class="k">if</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spw_map&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">]]</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">==</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">sensitivity</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">(</span><span class="n">spw</span><span class="o">=</span><span class="n">spw</span><span class="p">)</span>
                            <span class="n">dr_mod</span> <span class="o">=</span> <span class="mf">1.0</span>
                            <span class="c1"># fetch the DR modifier if selfcal failed on source</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]:</span>
                                <span class="n">dr_mod</span> <span class="o">=</span> <span class="n">get_dr_correction</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_dirty&#39;</span><span class="p">]</span> <span class="o">*</span>
                                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_dirty&#39;</span><span class="p">],</span>
                                    <span class="n">sensitivity</span><span class="p">,</span> <span class="n">vlist</span><span class="p">)</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DR modifier:  </span><span class="si">{</span><span class="n">dr_mod</span><span class="si">}</span><span class="s1"> SPW:  </span><span class="si">{</span><span class="n">spw</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                            <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="n">dr_mod</span>
                            <span class="k">if</span> <span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_9&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="s1">&#39;Band_10&#39;</span><span class="p">))</span> <span class="ow">and</span> <span class="n">dr_mod</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>   <span class="c1"># adjust for DSB noise increase</span>
                                <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="o">*</span><span class="mf">4.0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sensitivity</span> <span class="o">=</span> <span class="mf">0.0</span>
                        <span class="n">spws_per_vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_heuristics</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_real_spwsel</span><span class="p">([</span><span class="n">spw</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vislist</span><span class="p">),</span> <span class="n">vislist</span><span class="p">)</span>
                        <span class="n">nfsnr_modifier</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_curr&#39;</span><span class="p">]</span>
                        <span class="n">sensitivity_agg</span><span class="p">,</span> <span class="n">sens_bw</span><span class="p">,</span> <span class="n">sens_reffreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sensitivity</span><span class="p">()</span>
                        <span class="n">sensitivity_scale_factor</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_NF_curr&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sensitivity_agg</span>

                        <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">tclean_wrapper</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final&#39;</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
                                                <span class="n">telescope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">telescope</span><span class="p">,</span> <span class="n">nsigma</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                                                <span class="n">threshold</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">sensitivity</span> <span class="o">*</span> <span class="n">sensitivity_scale_factor</span> <span class="o">*</span> <span class="mf">4.0</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="n">scales</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">savemodel</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span> <span class="n">cellsize</span><span class="o">=</span><span class="n">cellsize</span><span class="p">,</span> <span class="n">imsize</span><span class="o">=</span><span class="n">imsize</span><span class="p">,</span> <span class="n">nterms</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">field</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">,</span> <span class="n">datacolumn</span><span class="o">=</span><span class="s1">&#39;corrected&#39;</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">spws_per_vis</span><span class="p">,</span>
                                                <span class="n">uvrange</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">],</span>
                                                <span class="n">obstype</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">],</span>
                                                <span class="n">nfrms_multiplier</span><span class="o">=</span><span class="n">nfsnr_modifier</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">copy_products</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_initial&#39;</span><span class="p">,</span> <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final&#39;</span><span class="p">)</span>

                        <span class="n">final_per_spw_SNR</span><span class="p">,</span> <span class="n">final_per_spw_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">final_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">final_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">final_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">final_per_spw_SNR</span><span class="p">,</span> <span class="n">final_per_spw_RMS</span>

                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_NF_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_NF_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_NF_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_NF_RMS</span>
                        <span class="c1"># reccalc initial stats with final mask</span>
                        <span class="n">final_per_spw_SNR</span><span class="p">,</span> <span class="n">final_per_spw_RMS</span> <span class="o">=</span> <span class="n">estimate_SNR</span><span class="p">(</span>
                            <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_final.mask&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">telescope</span> <span class="o">!=</span> <span class="s1">&#39;ACA&#39;</span><span class="p">:</span>
                            <span class="n">final_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">final_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">estimate_near_field_SNR</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span> <span class="n">maskname</span><span class="o">=</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span>
                                <span class="s1">&#39;_final.mask&#39;</span><span class="p">,</span> <span class="n">las</span><span class="o">=</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">final_per_spw_NF_SNR</span><span class="p">,</span> <span class="n">final_per_spw_NF_RMS</span> <span class="o">=</span> <span class="n">final_per_spw_SNR</span><span class="p">,</span> <span class="n">final_per_spw_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_NF_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_NF_orig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_per_spw_NF_RMS</span>

                        <span class="n">goodMask</span> <span class="o">=</span> <span class="n">checkmask</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">goodMask</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;intflux_final&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                <span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;e_intflux_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_intflux</span><span class="p">(</span>
                                <span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span> <span class="o">+</span> <span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">,</span> <span class="n">final_per_spw_RMS</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;intflux_final&#39;</span><span class="p">],</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span>
                                <span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;e_intflux_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">99.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">99.0</span>

        <span class="c1">##</span>
        <span class="c1"># Print final results</span>
        <span class="c1">##</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">target</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39; Summary&#39;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At least 1 successful selfcal iteration?:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final solint:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original SNR:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final SNR:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SNR_final&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Original RMS:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final RMS:  </span><span class="si">{</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;RMS_final&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1">#   for vis in vislist:</span>
                <span class="c1">#      LOG.info(&#39;Final gaintables: &#39;+selfcal_library[target][band][vis][&#39;gaintable&#39;])</span>
                <span class="c1">#      LOG.info(&#39;Final spwmap: &#39;,selfcal_library[target][band][vis][&#39;spwmap&#39;])</span>
                <span class="c1"># else:</span>
                <span class="c1">#   LOG.info(&#39;Selfcal failed on &#39;+target+&#39;. No solutions applied.&#39;)</span>

        <span class="c1">#</span>
        <span class="c1"># Perform a check on the per-spw images to ensure they didn&#39;t lose quality in self-calibration</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_all_spws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
                <span class="n">sani_target</span> <span class="o">=</span> <span class="s1">&#39;sc.&#39;</span><span class="o">+</span><span class="n">filenamer</span><span class="o">.</span><span class="n">sanitize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">vislist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">spwlist</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">:</span>
                        <span class="n">delta_beamarea</span> <span class="o">=</span> <span class="n">compare_beams</span><span class="p">(</span><span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_initial.image.tt0&#39;</span><span class="p">,</span>
                                                       <span class="n">sani_target</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39;_final.image.tt0&#39;</span><span class="p">)</span>
                        <span class="n">delta_SNR</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_final&#39;</span><span class="p">]</span> <span class="o">-</span>\
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">]</span>
                        <span class="n">delta_RMS</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_final&#39;</span><span class="p">]</span> <span class="o">-</span>\
                            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;delta_SNR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_SNR</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;delta_RMS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_RMS</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;delta_beamarea&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">delta_beamarea</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">sani_target</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">band</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">spw</span><span class="o">+</span><span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;Pre SNR: </span><span class="si">{:0.2f}</span><span class="s1">, Post SNR: </span><span class="si">{:0.2f}</span><span class="s1"> Pre RMS: </span><span class="si">{:0.3f}</span><span class="s1">, Post RMS: </span><span class="si">{:0.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_orig&#39;</span><span class="p">],</span>
                                     <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;SNR_final&#39;</span><span class="p">],</span>
                                     <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_orig&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">,</span>
                                     <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;per_spw_stats&#39;</span><span class="p">][</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;RMS_final&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1000.0</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">delta_SNR</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;WARNING SPW &#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39; HAS LOWER SNR POST SELFCAL&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">delta_RMS</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;WARNING SPW &#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39; HAS HIGHER RMS POST SELFCAL&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">delta_beamarea</span> <span class="o">&gt;</span> <span class="mf">0.05</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;WARNING SPW &#39;</span><span class="o">+</span><span class="n">spw</span><span class="o">+</span><span class="s1">&#39; HAS A &gt;0.05 CHANGE IN BEAM AREA POST SELFCAL&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">solints</span><span class="p">,</span> <span class="n">bands</span></div>


    <span class="k">def</span> <span class="nf">_prep_selfcal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare the selfcal heuristics.&quot;&quot;&quot;</span>

        <span class="n">scaltarget</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaltarget</span>
        <span class="n">vislist</span> <span class="o">=</span> <span class="n">scaltarget</span><span class="p">[</span><span class="s1">&#39;sc_vislist&#39;</span><span class="p">]</span>
        <span class="n">telescope</span> <span class="o">=</span> <span class="n">scaltarget</span><span class="p">[</span><span class="s1">&#39;sc_telescope&#39;</span><span class="p">]</span>
        <span class="c1">##</span>
        <span class="c1"># Find targets, assumes all targets are in all ms files for simplicity and only science targets, will fail otherwise</span>
        <span class="c1">##</span>
        <span class="n">all_targets</span> <span class="o">=</span> <span class="n">fetch_targets</span><span class="p">(</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1">##</span>
        <span class="c1"># Global environment variables for control of selfcal</span>
        <span class="c1">##</span>

        <span class="n">n_ants</span> <span class="o">=</span> <span class="n">get_n_ants</span><span class="p">(</span><span class="n">vislist</span><span class="p">)</span>

        <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">,</span> <span class="n">scanstartsdict</span><span class="p">,</span> <span class="n">scanendsdict</span><span class="p">,</span> \
            <span class="n">integrationtimesdict</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">spwsarray_dict</span><span class="p">,</span> <span class="n">mosaic_field</span><span class="p">,</span> <span class="n">spectral_scan</span><span class="p">,</span> <span class="n">spws_set</span> <span class="o">=</span> <span class="n">importdata</span><span class="p">(</span><span class="n">vislist</span><span class="p">,</span> <span class="n">all_targets</span><span class="p">,</span> <span class="n">telescope</span><span class="p">)</span>

        <span class="c1">##</span>
        <span class="c1"># Save/restore starting flags</span>
        <span class="c1">##</span>

        <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;.flagversions/flags.selfcal_starting_flags&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;restore&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cts</span><span class="o">.</span><span class="n">flagmanager</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">vis</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;save&#39;</span><span class="p">,</span> <span class="n">versionname</span><span class="o">=</span><span class="s1">&#39;selfcal_starting_flags&#39;</span><span class="p">)</span>

        <span class="c1">##</span>
        <span class="c1"># set image parameters based on the visibility data properties and frequency</span>
        <span class="c1">##</span>

        <span class="n">applycal_interp</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="n">nterms</span> <span class="o">=</span> <span class="n">get_nterms</span><span class="p">(</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;meanfreq&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">12.0e9</span><span class="p">:</span>
                <span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;linearPD&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">applycal_interp</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;linear&#39;</span>

        <span class="c1">##</span>
        <span class="c1"># begin setting up a selfcal_library with all relevant metadata to keep track of during selfcal</span>
        <span class="c1">##</span>
        <span class="n">selfcal_library</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">##</span>
        <span class="c1"># finds solints, starting with inf, ending with int, and tries to align</span>
        <span class="c1"># solints with number of integrations</span>
        <span class="c1"># solints reduce by factor of 2 in each self-cal interation</span>
        <span class="c1"># e.g., inf, max_scan_time/2.0, prev_solint/2.0, ..., int</span>
        <span class="c1"># starting solints will have solint the length of the entire EB to correct bulk offsets</span>
        <span class="c1">##</span>
        <span class="n">solints</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">gaincal_combine</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">solmode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">applycal_mode</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">bands</span><span class="p">:</span>
            <span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">gaincal_combine</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">solmode</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_solints_simple</span><span class="p">(</span>
                <span class="n">vislist</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
                <span class="n">scanstartsdict</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
                <span class="n">scanendsdict</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
                <span class="n">integrationtimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inf_EB_gaincal_combine</span><span class="p">,</span>
                <span class="n">n_solints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_solints</span><span class="p">,</span>
                <span class="n">do_amp_selfcal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">do_amp_selfcal</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">applycal_mode</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_cal_mode_default</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">solints</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>

        <span class="c1">##</span>
        <span class="c1"># puts stuff in right place from other MS metadata to perform proper data selections</span>
        <span class="c1"># in tclean, gaincal, and applycal</span>
        <span class="c1"># Also gets relevant times on source to estimate SNR per EB/scan</span>
        <span class="c1">##</span>
        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">band</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;SC_success&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;final_solint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;nterms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nterms</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;vislist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vislist</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">mosaic_field</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;mosaic&#39;</span><span class="p">]:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mosaic&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;obstype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;single-point&#39;</span>
                <span class="n">allscantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vislist</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;gaintable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;TOS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;Median_scan_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
                    <span class="n">allscantimes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">,</span> <span class="n">scantimesdict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">target</span><span class="p">])</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;refant&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank_refants</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">refantignore</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">refantignore</span><span class="p">)</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwstring&#39;</span><span class="p">]</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwlist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwarray&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;n_spws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">])</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;minspw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">spectral_scan</span><span class="p">:</span>
                        <span class="n">spwmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
                        <span class="n">spwmap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">i</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                            <span class="n">spwmap</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">spws_set</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwmap</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span>
                            <span class="n">vis</span><span class="p">][</span><span class="s1">&#39;minspw&#39;</span><span class="p">]]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;spwsarray&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="n">vis</span><span class="p">][</span><span class="s1">&#39;TOS&#39;</span><span class="p">]</span> <span class="o">+</span> \
                        <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spws_per_vis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band_properties</span><span class="p">[</span><span class="n">vis</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;spwstring&#39;</span><span class="p">])</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Median_scan_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">allscantimes</span><span class="p">)</span>
                <span class="n">prototype_uvrange</span> <span class="o">=</span> <span class="n">get_uv_range</span><span class="p">(</span><span class="n">band</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">vislist</span><span class="p">)</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;uvrange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvrange</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;using the Pipeline standard heuristics uvrange: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uvrange</span><span class="si">}</span><span class="s1">, instead of the prototype uvrange: </span><span class="si">{</span><span class="n">prototype_uvrange</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;75thpct_uv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;75thpct_uv&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;LAS&#39;</span><span class="p">]</span>
                <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">band_properties</span><span class="p">[</span><span class="n">vislist</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;fracbw&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">all_targets</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="n">band</span><span class="p">][</span><span class="s1">&#39;Total_TOS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">selfcal_library</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">all_targets</span><span class="p">,</span> <span class="n">n_ants</span><span class="p">,</span> <span class="n">bands</span><span class="p">,</span> <span class="n">band_properties</span><span class="p">,</span> <span class="n">applycal_interp</span><span class="p">,</span> <span class="n">selfcal_library</span><span class="p">,</span> <span class="n">solints</span><span class="p">,</span> <span class="n">gaincal_combine</span><span class="p">,</span> <span class="n">solmode</span><span class="p">,</span> <span class="n">applycal_mode</span><span class="p">,</span> <span class="n">integration_time</span><span class="p">,</span> <span class="n">spectral_scan</span><span class="p">,</span> <span class="n">spws_set</span><span class="p">,</span> <span class="n">spwsarray_dict</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>