

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.domain.measurementset &mdash; Pipeline 0.0.dev0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=30144f19" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=51d40e3f"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
      <li class="breadcrumb-item active">pipeline.domain.measurementset</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.domain.measurementset</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provide a class to store logical representation of MeasurementSet.&quot;&quot;&quot;</span>
<span class="c1"># Do not evaluate type annotations at definition time.</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Sequence</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># Avoid circular import. Used only for type annotation.</span>
    <span class="kn">from</span> <span class="nn">pipeline.infrastructure.tablereader</span> <span class="kn">import</span> <span class="n">RetrieveByIndexContainer</span>
    <span class="kn">from</span> <span class="nn">.antenna</span> <span class="kn">import</span> <span class="n">Antenna</span>
    <span class="kn">from</span> <span class="nn">.datadescription</span> <span class="kn">import</span> <span class="n">DataDescription</span>
    <span class="kn">from</span> <span class="nn">.field</span> <span class="kn">import</span> <span class="n">Field</span>
    <span class="kn">from</span> <span class="nn">.scan</span> <span class="kn">import</span> <span class="n">Scan</span>
    <span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">State</span>

<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">logging</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">measures</span><span class="p">,</span> <span class="n">spectralwindow</span>
<span class="kn">from</span> <span class="nn">.antennaarray</span> <span class="kn">import</span> <span class="n">AntennaArray</span>
<span class="kn">from</span> <span class="nn">.datatype</span> <span class="kn">import</span> <span class="n">DataType</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="MeasurementSet">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet">[docs]</a>
<span class="k">class</span> <span class="nc">MeasurementSet</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to store logical representation of a MeasurementSet (MS).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name: Name of MeasurementSet, equivalent to file path to MeasurementSet.</span>
<span class="sd">        session: Name of session associated with MS.</span>

<span class="sd">        exclude_num_chans: Tuple containing spectral window sizes (in number of</span>
<span class="sd">            channels) used to filter out non-science-spectral-windows.</span>
<span class="sd">        filesize: Disk size of MS.</span>

<span class="sd">        acs_software_build_version: ALMA Common Software build version used to</span>
<span class="sd">            create this MS (None if not ALMA).</span>
<span class="sd">        acs_software_version: ALMA Common Software version used to create this</span>
<span class="sd">            MS (None if not ALMA).</span>
<span class="sd">        antenna_array: Antenna array information.</span>
<span class="sd">        array_name: Name of array configuration.</span>
<span class="sd">        correlator_name: The name of the correlator, populated from the</span>
<span class="sd">            PROCESSOR table. Example values: ALMA_ACA, ALMA_BASELINE.</span>
<span class="sd">        data_column: A dictionary to store data type (key) and corresponding</span>
<span class="sd">            data column (value).</span>
<span class="sd">        data_descriptions: A list of DataDescription objects associated with MS.</span>
<span class="sd">        data_types_per_source_and_spw: A dictionary to store a list of</span>
<span class="sd">            available data types (values) in this MS per (source,spw) tuples</span>
<span class="sd">            (keys).</span>
<span class="sd">        execblock_id: Execution Block ID for this MS (only for ALMA, VLA).</span>
<span class="sd">        fields: A list of Field objects associated with MS.</span>
<span class="sd">        observer: The name of the observer, as listed in the OBSERVATIONS table.</span>
<span class="sd">        observing_modes: The name(s) of the Observing Mode(s) used for this MS,</span>
<span class="sd">            populated from the ASDM_SBSUMMARY table (empty list if not ALMA).</span>
<span class="sd">        project_id: Project ID associated with this MS, as listed in the</span>
<span class="sd">            OBSERVATIONS table.</span>
<span class="sd">        representative_target: A tuple of the name of representative source,</span>
<span class="sd">            frequency and bandwidth.</span>
<span class="sd">        representative_window: A representative spectral window name.</span>
<span class="sd">        scans: A list of Scan objects associated with MS.</span>
<span class="sd">        schedblock_id: Scheduling Block ID for this MS (only for ALMA, VLA).</span>
<span class="sd">        science_goals: A science goal information consists of min/max acceptable</span>
<span class="sd">            angular resolution, max allowed beam ratio, sensitivity, dynamic</span>
<span class="sd">            range, spectral dynamic range bandwidth (Cycle 10+), and SB name.</span>
<span class="sd">        sources: A list of Source objects associated with MS.</span>
<span class="sd">        spectral_windows: A list of SpectralWindow objects associated with MS.</span>
<span class="sd">        spectralspec_spwmap: A dictionary to map each SpectralSpec to a list of</span>
<span class="sd">            corresponding spectral window IDs.</span>
<span class="sd">        states: A list of State objects associated with MS.</span>

<span class="sd">        derived_fluxes: Calibrated visibility based flux measurements derived</span>
<span class="sd">            during pipeline run, used in subsequent imaging stages.</span>
<span class="sd">        flagcmds: A list of flag commands, typically populated by hifa_fluxcalflag.</span>
<span class="sd">        fluxscale_fluxes: Flux measurements derived by CASA&#39;s fluxscale during</span>
<span class="sd">            the hifa_gfluxscale task, for use by a subsequent hifa_polcal task</span>
<span class="sd">            (ALMA interferometry polarisation calibration only).</span>
<span class="sd">        origin_ms: A path to the first generation MeasurementSet from which</span>
<span class="sd">            the current MS is generated. This is typically set by tasks such as</span>
<span class="sd">            h_mssplit, hif_mstransform, hifv_mstransform, hif_transformimagedata.</span>
<span class="sd">        phase_calapps_for_check_sources: List of CalApplications for the phase</span>
<span class="sd">            calibration of the check source(s) generated during hifa_gfluxscale.</span>
<span class="sd">            These are used in a subsequent hifa_timegaincal task to overplot</span>
<span class="sd">            the phase calibration for check source in its Diagnostic Phase Vs.</span>
<span class="sd">            Time plots.</span>
<span class="sd">        phasecal_mapping: A dictionary mapping phase calibrator fields to</span>
<span class="sd">            corresponding fields with TARGET or CHECK intent; typically</span>
<span class="sd">            populated by the hifa_spwphaseup task (ALMA-only).</span>
<span class="sd">        phaseup_caltable_for_phase_rms: The bandpass phase-up caltable created</span>
<span class="sd">            during the hifa_bandpass task (prior to deriving the bandpass</span>
<span class="sd">            solution), for use in subsequent phase RMS stability assessment</span>
<span class="sd">            during the hifa_spwphaseup task (ALMA-interferometry-only).</span>
<span class="sd">        reference_antenna_locked: If True, reference antenna is locked to</span>
<span class="sd">            prevent modification. Typically used in polarization calibration</span>
<span class="sd">            stages / recipes.</span>
<span class="sd">        reference_spwmap: Vector of spectral window IDs, enabling flux scaling</span>
<span class="sd">            across spectral windows. Typically populated by the hifa_fluxcalflag</span>
<span class="sd">            task, and used by a subsequent hifa_gfluxscale task in its call to</span>
<span class="sd">            CASA `fluxscale` task (ALMA-interferometry-only).</span>
<span class="sd">        spwmaps: Dictionary mapping (intent, field) keys to corresponding</span>
<span class="sd">            phase-up spectral window mapping to use for combining/mapping</span>
<span class="sd">            spectral windows; used in subsequent calibration tasks</span>
<span class="sd">            (ALMA-interferometry-only).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a MeasurementSet object.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: A path to MS.</span>
<span class="sd">            session: Name of session associated with MS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Attributes based on input arguments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">session</span>

        <span class="c1"># Other attributes populated at init.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_num_chans</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filesize</span><span class="p">:</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_filesize</span><span class="p">()</span>

        <span class="c1"># Attributes expected to be populated during import of MS (see</span>
        <span class="c1"># infrastructure.tablereader.MeasurementSetReader.get_measurement_set).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="p">:</span> <span class="n">AntennaArray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acs_software_build_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># PIPE-132</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acs_software_version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># PIPE-132</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">correlator_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># PIPE-1062</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_descriptions</span><span class="p">:</span> <span class="n">RetrieveByIndexContainer</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># PIPE-1246</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execblock_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span> <span class="n">RetrieveByIndexContainer</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">observing_modes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># PIPE-2084</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">representative_window</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedblock_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">science_goals</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span> <span class="n">RetrieveByIndexContainer</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">:</span> <span class="n">RetrieveByIndexContainer</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectralspec_spwmap</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># PIPE-1132</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span> <span class="n">RetrieveByIndexContainer</span> <span class="o">|</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Attributes expected to be populated during the Pipeline run, to store</span>
        <span class="c1"># information derived by stages that is used in subsequent stages.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">derived_fluxes</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># PIPE-644, PIPE-660</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flagcmds</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># TODO: updated by hifa_fluxcalflag, but appear unused; remove?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxscale_fluxes</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># PIPE-1776</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin_ms</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>  <span class="c1"># PIPE-1062</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phase_calapps_for_check_sources</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># PIPE-1377</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phasecal_mapping</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># PIPE-1154</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phaseup_caltable_for_phase_rms</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># PIPE-1624</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_spwmap</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spwmaps</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># PIPE-1154</span>

        <span class="c1"># Polarisation calibration requires the refant list be frozen, after</span>
        <span class="c1"># which subsequent gaincal calls are executed with</span>
        <span class="c1"># refantmode=&#39;strict&#39;.</span>
        <span class="c1">#</span>
        <span class="c1"># To meet this requirement we make the MS refant list lockable. When</span>
        <span class="c1"># locked, the refant list cannot be changed. Additionally, gaincal</span>
        <span class="c1"># checks the lock status to know whether to set refantmode to strict.</span>
        <span class="c1">#</span>
        <span class="c1"># The backing property for the refant list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_antenna</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># The refant lock. Setting reference_antenna_locked to True prevents</span>
        <span class="c1"># the reference antenna list from being modified. I would have liked</span>
        <span class="c1"># to put the lock on a custom refant list class, but some tasks check</span>
        <span class="c1"># the type of reference_antenna directly which prevents that approach.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna_locked</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_calc_filesize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the disk usage of this measurement set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">total_bytes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">fp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="n">total_bytes</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">,</span>
                                 <span class="n">measures</span><span class="o">.</span><span class="n">FileSizeUnits</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;MeasurementSet(</span><span class="si">{0}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">intents</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return unique intents in the measurement set.&quot;&quot;&quot;</span>
        <span class="n">intents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># we look to field rather than state as VLA datasets don&#39;t have state</span>
        <span class="c1"># entries</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">intents</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">intents</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">antennas</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Antenna</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of Antenna objects for all antennas in the measurement set.&quot;&quot;&quot;</span>
        <span class="c1"># return a copy rather than the underlying list</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">antennas</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">basename</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return base path to the measurement set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_band_to_band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return whether this MS is for band-to-band interferometry.</span>

<span class="sd">        Criteria adopted from PIPE-2084: an MS is deemed to be for band-to-band</span>
<span class="sd">        interferometry if either the observing mode declares it as band-to-band,</span>
<span class="sd">        or if the diffgain intent + SpW setup are consistent with band-to-band.</span>
<span class="sd">        The latter covers datasets that don&#39;t have correct observing mode set in</span>
<span class="sd">        their metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;BandToBand Interferometry&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">observing_modes</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_diffgain_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;B2B&quot;</span>

<div class="viewcode-block" id="MeasurementSet.get_antenna">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_antenna">[docs]</a>
    <span class="k">def</span> <span class="nf">get_antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">search_term</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Antenna</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Antenna(s) for given antenna selection in CASA format.</span>

<span class="sd">        If the ``search_term`` is omitted or an empty string, this will return</span>
<span class="sd">        all antennas in the measurement set.</span>

<span class="sd">        Args:</span>
<span class="sd">            search_term: Antenna selection string in CASA format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Antenna objects matching search term.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">search_term</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennas</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennas</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">ant_arg_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">search_term</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennas</span><span class="p">)]</span></div>


<div class="viewcode-block" id="MeasurementSet.get_state">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_state">[docs]</a>
    <span class="k">def</span> <span class="nf">get_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return State in MeasurementSet matching the given identifier.</span>

<span class="sd">        Args:</span>
<span class="sd">            state_id: Numerical identifier of state to search for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            State object associated with matched identifier, or None if no match</span>
<span class="sd">            was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">state_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MeasurementSet.get_scans">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_scans">[docs]</a>
    <span class="k">def</span> <span class="nf">get_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">scan_intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">field</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Scan</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return Scan(s) in MeasurementSet matching the given criteria (ID,</span>
<span class="sd">        intent, field, and/or spectral window). If no criteria are given, all</span>
<span class="sd">        Scans in the MeasurementSet will be returned.</span>

<span class="sd">        Criteria arguments can be given as either single items of the expected</span>
<span class="sd">        type, sequences of the expected type, or in the case of intent or spw,</span>
<span class="sd">        as a comma-separated values string. For example, intent could be</span>
<span class="sd">        &#39;ATMOSPHERE&#39;, &#39;ATMOSPHERE,BANDPASS&#39;, or (&#39;ATMOSPHERE&#39;, &#39;BANDPASS&#39;).</span>

<span class="sd">        Args:</span>
<span class="sd">            scan_id: Scan ID(s) to match.</span>
<span class="sd">            scan_intent: Intent(s) to match.</span>
<span class="sd">            field: Field(s) to match, as field selection in CASA format.</span>
<span class="sd">            spw: Spectral window(s) to match.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Scan objects for scans in MS matching the given criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span>

        <span class="k">if</span> <span class="n">scan_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># encase raw numbers in a tuple</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_id</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                <span class="n">scan_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan_id</span><span class="p">,)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">scan_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">scan_intent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_intent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">scan_intent</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="c1"># empty string equals all intents for CASA</span>
                    <span class="n">scan_intent</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
                <span class="n">scan_intent</span> <span class="o">=</span> <span class="n">scan_intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">scan_intent</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">scan_intent</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">scan_intent</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields_with_name</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">task_arg</span><span class="o">=</span><span class="n">field</span><span class="p">))</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">fields_with_name</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fields</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                <span class="n">spw</span> <span class="o">=</span> <span class="p">(</span><span class="n">spw</span><span class="p">,)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="n">spw</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;~&#39;</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">:</span>
                    <span class="n">spw</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">range_to_list</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spw</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">spw</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">}</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">{</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">for</span> <span class="n">scan_spw</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">spws</span> <span class="k">if</span> <span class="n">scan_spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">spw</span><span class="p">}</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pool</span></div>


<div class="viewcode-block" id="MeasurementSet.get_data_description">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_data_description">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindow</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">DataDescription</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the DataDescription in the MeasurementSet that matches the given</span>
<span class="sd">        criteria (spectral window or ID). If no criteria are given, this will</span>
<span class="sd">        return None. If both `spw` and `id` are given, this will match by `id`</span>
<span class="sd">        only.</span>

<span class="sd">        Args:</span>
<span class="sd">            spw: Spectral window to match (as ID or SpectralWindow object).</span>
<span class="sd">            id: Data description numerical identifier to match.</span>

<span class="sd">        Returns:</span>
<span class="sd">            DataDescription matching the given criteria, or None if no match was found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindow</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_descriptions</span>
                         <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">spw</span> <span class="ow">is</span> <span class="n">spw</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_descriptions</span>
                         <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">spw</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_descriptions</span> <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MeasurementSet.get_representative_source_spw">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_representative_source_spw">[docs]</a>
    <span class="k">def</span> <span class="nf">get_representative_source_spw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">source_spwid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the representative target source object:</span>

<span class="sd">        * Use user name if ``source_name`` is supplied by user and it has TARGET intent.</span>
<span class="sd">        * Otherwise, use the source defined in the ASDM SBSummary table if it has TARGET intent.</span>
<span class="sd">        * Otherwise, use the first source in the source list with TARGET intent.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_name: A string with the source name, or None for an automatic selection.</span>
<span class="sd">            source_spwid: An int with the spw id, or None for an automatic selection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            a tuple with representative source name and spw id;</span>
<span class="sd">            if such a source cannot be identified, return (None, None),</span>
<span class="sd">            and if a spw cannot be determined, return (name, None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">cme</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>

        <span class="c1"># PIPE-1504: only issue certain messages at the WARNING level if they are executed by hifa_imageprecheck</span>
        <span class="k">if</span> <span class="s1">&#39;hifa_imageprecheck&#39;</span> <span class="ow">in</span> <span class="p">[</span><span class="n">fn_name</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fn_name</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()]:</span>
            <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span>

        <span class="k">if</span> <span class="n">source_name</span><span class="p">:</span>
            <span class="c1"># Use the first target source that matches the user defined name</span>
            <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
                              <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">source_name</span>
                              <span class="ow">and</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting user defined representative target source </span><span class="si">%s</span><span class="s1"> for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;User defined representative target source </span><span class="si">%s</span><span class="s1"> not found in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Use the first target source that matches the representative source name in the ASDM</span>
            <span class="c1"># SBSummary table</span>
            <span class="n">source_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
                              <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">source_name</span>
                              <span class="ow">and</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting representative target source </span><span class="si">%s</span><span class="s1"> for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Representative target source </span><span class="si">%s</span><span class="s1"> not found in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="c1"># Try to fall back first target source</span>
                <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
                                  <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Falling back to first target source (</span><span class="si">%s</span><span class="s1">) for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">target_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No target sources observed for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                    <span class="n">target_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Use first target source no matter what it is</span>
            <span class="n">target_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span>
                              <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_sources</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="n">target_sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Undefined representative target source, defaulting to first target source (</span><span class="si">%s</span><span class="s1">) for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="n">target_source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No target sources observed for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="n">target_source</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Target source not found</span>
        <span class="k">if</span> <span class="n">target_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Target source name</span>
        <span class="n">target_source_name</span> <span class="o">=</span> <span class="n">target_source</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Check the user defined spw and return it if it was observed for the</span>
        <span class="c1"># representative source. If it was not observed quit.</span>
        <span class="k">if</span> <span class="n">source_spwid</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">target_source</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">valid_spwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">valid_spws</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">source_spwid</span> <span class="ow">in</span> <span class="n">valid_spwids</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting user defined representative spw </span><span class="si">%s</span><span class="s1"> for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_spwid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="n">source_spwid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No target source data for representative spw </span><span class="si">%s</span><span class="s1"> in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">source_spwid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">target_spwid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check for representative spw from ASDM (&gt;= Cycle 7)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">target_spwid</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_window</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="s1">&#39;Could not translate spw name </span><span class="si">%s</span><span class="s1"> to ID. Trying frequency matching heuristics.&#39;</span> <span class="o">%</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">representative_window</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target_spwid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="n">target_spwid</span>

        <span class="c1"># Get the representative bandwidth</span>
        <span class="c1">#     Return if there isn&#39;t one</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Undefined representative bandwidth for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="n">target_bw</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="s1">&#39;TOPO&#39;</span><span class="p">,</span>
            <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">qa</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>

        <span class="c1"># Get the representative frequency</span>
        <span class="c1">#     Return if there isn&#39;t one</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Undefined representative frequency for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">target_frequency</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">frequency</span><span class="p">(</span><span class="s1">&#39;BARY&#39;</span><span class="p">,</span>
            <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">qa</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">qa</span><span class="o">.</span><span class="n">getunit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">representative_target</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span>

        <span class="c1"># Convert BARY frequency to TOPO</span>
        <span class="c1">#    Use the start time of the first target source scan</span>
        <span class="c1">#    Note some funny business with source and field names</span>
        <span class="n">cme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">cme</span><span class="o">.</span><span class="n">observatory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">cme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">target_source</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">target_scans</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">scan_intent</span><span class="o">=</span><span class="s1">&#39;TARGET&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_source</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">source_id</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_scans</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cme</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">target_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">target_frequency_topo</span> <span class="o">=</span> <span class="n">cme</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">target_frequency</span><span class="p">,</span> <span class="s1">&#39;TOPO&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to convert representative frequency to TOPO for data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="n">target_frequency_topo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cme</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

        <span class="c1"># No representative frequency</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_frequency_topo</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Find the science spw </span>

        <span class="c1"># Get the science spw ids</span>
        <span class="n">science_spw_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()]</span>

        <span class="c1"># Get the target science spws observed for the target source</span>
        <span class="n">target_spws</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">target_source</span><span class="o">.</span><span class="n">fields</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">valid_spws</span>
                       <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">science_spw_ids</span><span class="p">}</span>

        <span class="c1"># Now find all the target_spws that have a channel width less than</span>
        <span class="c1"># or equal to the representative bandwidth</span>
        <span class="c1"># Note that the representative bandwidth can be slightly smaller than the actual channel width.</span>
        <span class="c1"># This is due to the details of online Hanning smoothing and is technically correct. We thus</span>
        <span class="c1"># apply a 1% margin (see CAS-11710).</span>
        <span class="n">target_spws_bw</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws</span>
                          <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">target_bw</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_spws_bw</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No target spws have channel width &lt;= representative bandwidth in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

            <span class="c1"># Now find all the target spws that contain the representative frequency.</span>
            <span class="n">target_spws_freq</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws</span>
                                <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">target_frequency_topo</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_spws_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No target spws overlap the representative frequency in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

                <span class="c1"># Now find the closest match to the center frequency</span>
                <span class="n">max_freqdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">max</span>
                <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws</span><span class="p">:</span>
                    <span class="n">freqdiff</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">centre_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">target_frequency_topo</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">freqdiff</span> <span class="o">&lt;</span> <span class="n">max_freqdiff</span><span class="p">:</span>
                        <span class="n">target_spwid</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span>
                        <span class="n">max_freqdiff</span> <span class="o">=</span> <span class="n">freqdiff</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting spw </span><span class="si">%s</span><span class="s1"> which is closest to the representative frequency in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_spwid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">min_chanwidth</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws_freq</span><span class="p">:</span>
                    <span class="n">chanwidth</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">min_chanwidth</span> <span class="ow">or</span> <span class="n">chanwidth</span> <span class="o">&lt;</span> <span class="n">min_chanwidth</span><span class="p">:</span>
                        <span class="n">target_spwid</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting the narrowest chanwidth spw id </span><span class="si">%s</span><span class="s1"> which overlaps the representative frequency in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                         <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_spwid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="n">target_spwid</span>

        <span class="c1"># Now find all the spw that contain the representative frequency</span>
        <span class="n">target_spws_freq</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws_bw</span>
                            <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span><span class="o">.</span><span class="n">value</span> <span class="o">&lt;=</span> <span class="n">target_frequency_topo</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_spws_freq</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span>
                    <span class="s1">&#39;No target spws with channel spacing &lt;= representative bandwith overlap the representative frequency in data set </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="n">max_chanwidth</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">target_spws_bw</span><span class="p">:</span>
                <span class="n">chanwidth</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span><span class="o">.</span><span class="n">to_units</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FrequencyUnits</span><span class="o">.</span><span class="n">HERTZ</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">max_chanwidth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">chanwidth</span> <span class="o">&gt;</span> <span class="n">max_chanwidth</span><span class="p">):</span>
                    <span class="n">target_spwid</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Selecting widest channel width spw id </span><span class="si">{}</span><span class="s1"> with channel width &lt;= representative bandwidth in data&#39;</span>
                     <span class="s1">&#39; set </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target_spwid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="n">target_spwid</span>

        <span class="c1"># For all the spws with channel width less than or equal</span>
        <span class="c1"># to the representative bandwidth which contain the</span>
        <span class="c1"># representative frequency select the one with the spw</span>
        <span class="c1"># with the greatest bandwidth.</span>
        <span class="n">bestspw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">target_spws_freq</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bestspw</span><span class="p">:</span>
                <span class="n">bestspw</span> <span class="o">=</span> <span class="n">spw</span>
            <span class="k">elif</span> <span class="n">spw</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">bestspw</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                <span class="n">bestspw</span> <span class="o">=</span> <span class="n">spw</span>
        <span class="n">target_spwid</span> <span class="o">=</span> <span class="n">bestspw</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="n">target_source_name</span><span class="p">,</span> <span class="n">target_spwid</span></div>


<div class="viewcode-block" id="MeasurementSet.get_fields">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_fields">[docs]</a>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_arg</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">field_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Field</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get Fields from this MeasurementSet matching the given criteria. If no</span>
<span class="sd">        criteria are given, all Fields in the MeasurementSet will be returned.</span>

<span class="sd">        Arguments can be given as either single items of the expected type,</span>
<span class="sd">        sequences of the expected type, or as comma separated strings in the</span>
<span class="sd">        case of name and/or intent. For instance, name could be &#39;HOIX&#39;,</span>
<span class="sd">        &#39;HOIX,0841+708&#39; or (&#39;HOIX&#39;,&#39;0841+708&#39;).</span>

<span class="sd">        Args:</span>
<span class="sd">            task_arg: A field selection in CASA format to match.</span>
<span class="sd">            field_id: Field ID(s) to match.</span>
<span class="sd">            name: Field name(s) to match.</span>
<span class="sd">            intent: Select fields that are associated with these intents. If</span>
<span class="sd">                set to an empty string or &#39;*&#39;, this is the equivalent to all</span>
<span class="sd">                intents in the measurement set.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of Field objects for fields in MS matching the given criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>

        <span class="k">if</span> <span class="n">task_arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">field_id_for_task_arg</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">field_arg_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task_arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_id_for_task_arg</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># encase raw numbers in a tuple</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_id</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Sequence</span><span class="p">):</span>
                <span class="n">field_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_id</span><span class="p">,)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_id</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">intent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">intent</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                    <span class="c1"># empty string equals all intents for CASA</span>
                    <span class="n">intent</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
                <span class="n">intent</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">intent</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pool</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">intent</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">pool</span></div>


<div class="viewcode-block" id="MeasurementSet.get_spectral_window">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_spectral_window">[docs]</a>
    <span class="k">def</span> <span class="nf">get_spectral_window</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindow</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the SpectralWindow object matching the given identifier.</span>
<span class="sd">        The identifier can be provided as an integer or string of integer.</span>

<span class="sd">        Args:</span>
<span class="sd">            spw_id: Numerical identifier of spectral window to match.</span>

<span class="sd">        Returns:</span>
<span class="sd">            SpectralWindow object for spectral window matching the identifier.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError if no matching spectral window is found for given identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spw_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spw_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)</span>
            <span class="n">match</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span>
                     <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">spw_id</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No spectral window with ID </span><span class="se">\&#39;</span><span class="si">{0}</span><span class="se">\&#39;</span><span class="s1"> found in &#39;</span>
                               <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spw_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span></div>


<div class="viewcode-block" id="MeasurementSet.get_spectral_windows">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_spectral_windows">[docs]</a>
    <span class="k">def</span> <span class="nf">get_spectral_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_arg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">with_channels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                             <span class="n">num_channels</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">science_windows_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">spectralspecs</span><span class="p">:</span> <span class="nb">list</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindow</span> <span class="o">|</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindowWithChannelSelection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return spectral windows matching given criteria.</span>

<span class="sd">        This returns spectral windows that correspond to the given CASA-style</span>
<span class="sd">        spw argument (specified as ``task_arg``), filtering out windows for a</span>
<span class="sd">        number of criteria: number of channels, science spectral windows,</span>
<span class="sd">        spectral specs, intents.</span>

<span class="sd">        By default, this returns a list of SpectralWindow objects; if</span>
<span class="sd">        ``with_channels`` is True, this will instead return the spectral windows</span>
<span class="sd">        as a list of SpectralWindowWithChannelSelection objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            task_arg: Spectral window selection in CASA format to match.</span>
<span class="sd">            with_channels: If True, return spectral window with channel selection.</span>
<span class="sd">            num_channels: Optional list of spectral window sizes in number of</span>
<span class="sd">                channels; if set, only return spectral windows whose number of</span>
<span class="sd">                channels matches any of the given sizes.</span>
<span class="sd">            science_windows_only: If True, only return &quot;science&quot; spectral</span>
<span class="sd">                windows, aka spectral windows associated with science intents.</span>
<span class="sd">            spectralspecs: Optional list of spectral specs; if set, only return</span>
<span class="sd">                spectral windows associated with given spectral specs.</span>
<span class="sd">            intent: Optional string of comma-separated intents; if set, only</span>
<span class="sd">                return spectral windows that observed given intent(s).</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of SpectralWindow or SpectralWindowWithChannelSelection objects</span>
<span class="sd">            for given search criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_spectral_windows</span><span class="p">(</span><span class="n">task_arg</span><span class="p">,</span> <span class="n">with_channels</span><span class="p">)</span>

        <span class="c1"># if requested, filter spws by number of channels</span>
        <span class="k">if</span> <span class="n">num_channels</span><span class="p">:</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">num_channels</span> <span class="ow">in</span> <span class="n">num_channels</span><span class="p">]</span>

        <span class="c1"># If requested, filter spws by spectral specs.</span>
        <span class="k">if</span> <span class="n">spectralspecs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">spectralspec</span> <span class="ow">in</span> <span class="n">spectralspecs</span><span class="p">]</span>

        <span class="c1"># If requested, filter spws by intent.</span>
        <span class="k">if</span> <span class="n">intent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">intent</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">intents</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">science_windows_only</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">spws</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
            <span class="n">science_intents</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;CHECK&#39;</span><span class="p">,</span> <span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">,</span> <span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">num_channels</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_num_chans</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">science_intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">intents</span><span class="p">)]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">):</span>
            <span class="n">science_intents</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">,</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;POLARIZATION&#39;</span><span class="p">,</span> <span class="s1">&#39;POLANGLE&#39;</span><span class="p">,</span> <span class="s1">&#39;POLLEAKAGE&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;CHECK&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">num_channels</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_num_chans</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">science_intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;POINTING&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;NRO&#39;</span><span class="p">:</span>
            <span class="n">science_intents</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TARGET&#39;</span><span class="p">}</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">science_intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">intents</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">spws</span></div>


<div class="viewcode-block" id="MeasurementSet.get_spectral_specs">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_spectral_specs">[docs]</a>
    <span class="k">def</span> <span class="nf">get_spectral_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return list of all spectral specs used in the MS.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectralspec_spwmap</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


<div class="viewcode-block" id="MeasurementSet.get_all_spectral_windows">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_all_spectral_windows">[docs]</a>
    <span class="k">def</span> <span class="nf">get_all_spectral_windows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_arg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">with_channels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindow</span> <span class="o">|</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindowWithChannelSelection</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return spectral windows corresponding to the given CASA-style spw</span>
<span class="sd">        argument.</span>

<span class="sd">        By default, this returns a list of SpectralWindow objects; if</span>
<span class="sd">        ``with_channels`` is True, this will instead return the spectral windows</span>
<span class="sd">        as a list of SpectralWindowWithChannelSelection objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            task_arg: Spectral window selection in CASA format to match.</span>
<span class="sd">            with_channels: If True, return spectral window with channel selection.</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of SpectralWindow or SpectralWindowWithChannelSelection objects</span>
<span class="sd">            for given CASA-style search criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we may have more spectral windows in our MeasurementSet than have</span>
        <span class="c1"># data in the measurement set on disk. Ask for all </span>
        <span class="k">if</span> <span class="n">task_arg</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
            <span class="n">task_arg</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>

        <span class="c1"># expand spw tuples into a range per spw, eg. spw9 : 1,2,3,4,5</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span> <span class="ow">in</span> <span class="n">utils</span><span class="o">.</span><span class="n">spw_arg_to_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">task_arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">):</span>
            <span class="n">selected</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_channels</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span> <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">selected</span><span class="p">]</span>

        <span class="n">spws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">channels</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">spw_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_window</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)</span>
            <span class="n">proxy</span> <span class="o">=</span> <span class="n">spectralwindow</span><span class="o">.</span><span class="n">SpectralWindowWithChannelSelection</span><span class="p">(</span><span class="n">spw_obj</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
            <span class="n">spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">proxy</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">spws</span></div>


<div class="viewcode-block" id="MeasurementSet.get_diffgain_mode">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_diffgain_mode">[docs]</a>
    <span class="k">def</span> <span class="nf">get_diffgain_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the intents and SpW setup in this measurement set are</span>
<span class="sd">        consistent with an observing mode that uses a differential gain</span>
<span class="sd">        calibrator: BandToBand (B2B) or BandwidthSwitching (BWSW).</span>

<span class="sd">        Returns:</span>
<span class="sd">            - &#39;B2B&#39; if the ratio of frequencies between on-source and reference spws is above 1.661;</span>
<span class="sd">            - &#39;BWSW&#39; if the ratio of bandwidths between reference and on-source is above 1.5;</span>
<span class="sd">            - None if there are no DIFFGAIN* intents in this MS.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError if the DIFFGAIN* intents are present in the MS, but either</span>
<span class="sd">            a. the MS is missing diffgain reference or on-source SpWs, or</span>
<span class="sd">            b. the SpW setup does not match either BandToBand or BandwidthSwitching.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;DIFFGAINREF&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intents</span> <span class="ow">or</span> <span class="s1">&#39;DIFFGAINSRC&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">intents</span><span class="p">:</span>
            <span class="c1"># Retrieve diffgain reference and diffgain on-source SpWs.</span>
            <span class="n">dg_refspws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;DIFFGAINREF&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dg_refspws</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DIFFGAINREF intent missing in calibration sources for dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dg_srcspws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;DIFFGAINSRC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dg_srcspws</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DIFFGAINSRC intent missing in science sources for dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># Retrieve the center frequency and bandwidth from the first</span>
            <span class="c1"># diffgain on-source SpW and first diffgain reference SpW. The setup</span>
            <span class="c1"># is expected to be the same for all SpWs.</span>
            <span class="n">refcent</span> <span class="o">=</span> <span class="n">dg_refspws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centre_frequency</span><span class="o">.</span><span class="n">value</span>
            <span class="n">scicent</span> <span class="o">=</span> <span class="n">dg_srcspws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">centre_frequency</span><span class="o">.</span><span class="n">value</span>
            <span class="n">refwidth</span> <span class="o">=</span> <span class="n">dg_refspws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">value</span>
            <span class="n">sciwidth</span> <span class="o">=</span> <span class="n">dg_srcspws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bandwidth</span><span class="o">.</span><span class="n">value</span>

            <span class="c1"># [at least] one of the above conditions has to be satisfied</span>
            <span class="k">if</span> <span class="n">scicent</span><span class="o">/</span><span class="n">refcent</span> <span class="o">&gt;</span> <span class="mf">1.661</span><span class="p">:</span>  <span class="c1"># simple ratio to be out of band Cycle 10</span>
                <span class="k">return</span> <span class="s1">&#39;B2B&#39;</span>
            <span class="k">elif</span> <span class="n">refwidth</span><span class="o">/</span><span class="n">sciwidth</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;BWSW&#39;</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;DIFFGAIN intent with an unsupported spectral setup for dataset </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MeasurementSet.get_original_intent">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_original_intent">[docs]</a>
    <span class="k">def</span> <span class="nf">get_original_intent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the original obs_modes that correspond to the given pipeline</span>
<span class="sd">        observing intent(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            intent: Pipeline intent(s) to convert.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Set of original CASA intent(s) (obs_modes) corresponding to given</span>
<span class="sd">            Pipeline intent(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs_modes</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">get_obs_mode_for_intent</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">obs_modes</span><span class="p">))</span></div>


<div class="viewcode-block" id="MeasurementSet.get_alma_cycle_number">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_alma_cycle_number">[docs]</a>
    <span class="k">def</span> <span class="nf">get_alma_cycle_number</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the ALMA cycle number from the ALMA control software version that</span>
<span class="sd">        this MeasurementSet was acquired with.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int cycle_number or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;CYCLE(\d+)&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acs_software_build_version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="n">cycle_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">cycle_number</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">start_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return start time for this measurement set as CASA &#39;epoch&#39; measure dictionary.&quot;&quot;&quot;</span>
        <span class="n">earliest</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([(</span><span class="n">scan</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">],</span>
                          <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">earliest</span><span class="o">.</span><span class="n">start_time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">end_time</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return end time for this measurement set as CASA &#39;epoch&#39; measure dictionary.&quot;&quot;&quot;</span>
        <span class="n">latest</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([(</span><span class="n">scan</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">end_time</span><span class="p">))</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">],</span>
                        <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">latest</span><span class="o">.</span><span class="n">end_time</span>

<div class="viewcode-block" id="MeasurementSet.get_vla_max_integration_time">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_max_integration_time">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_max_integration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the integration time used by the original VLA scripts.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int_time: int value of the max integration time used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># with casa_tools.TableReader(vis + &#39;/FIELD&#39;) as table:</span>
        <span class="c1">#     numFields = table.nrows()</span>
        <span class="c1">#     field_positions = table.getcol(&#39;PHASE_DIR&#39;)</span>
        <span class="c1">#     field_ids = range(numFields)</span>
        <span class="c1">#     field_names = table.getcol(&#39;NAME&#39;)</span>

        <span class="c1"># with casa_tools.TableReader(vis) as table:</span>
        <span class="c1">#     scanNums = sorted(np.unique(table.getcol(&#39;SCAN_NUMBER&#39;)))</span>
        <span class="c1">#     field_scans = []</span>
        <span class="c1">#     for ii in range(0,numFields):</span>
        <span class="c1">#         subtable = table.query(&#39;FIELD_ID==%s&#39;%ii)</span>
        <span class="c1">#         field_scans.append(list(np.unique(subtable.getcol(&#39;SCAN_NUMBER&#39;))))</span>
        <span class="c1">#         subtable.close()</span>

        <span class="c1"># field_scans is now a list of lists containing the scans for each field.</span>
        <span class="c1"># so, to access all the scans for the fields, you&#39;d:</span>
        <span class="c1">#</span>
        <span class="c1"># for ii in range(0,len(field_scans)):</span>
        <span class="c1">#    for jj in range(0,len(field_scans[ii]))</span>
        <span class="c1">#</span>
        <span class="c1"># the jj&#39;th scan of the ii&#39;th field is in field_scans[ii][jj]</span>

        <span class="c1"># Figure out integration time used</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">ms</span><span class="p">:</span>
            <span class="n">scan_summary</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">getscansummary</span><span class="p">()</span>
        <span class="c1"># startdate=float(ms_summary[&#39;BeginTime&#39;])</span>

        <span class="n">integ_scan_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_summary</span><span class="p">:</span>
            <span class="n">integ_scan_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>
        <span class="n">sorted_scan_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">integ_scan_list</span><span class="p">)</span>

        <span class="c1"># find max and median integration times</span>
        <span class="c1">#</span>
        <span class="n">integration_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">sorted_scan_list</span><span class="p">:</span>
            <span class="n">integration_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan_summary</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)][</span><span class="s1">&#39;0&#39;</span><span class="p">][</span><span class="s1">&#39;IntegrationTime&#39;</span><span class="p">])</span>

        <span class="n">maximum_integration_time</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">integration_times</span><span class="p">)</span>
        <span class="n">median_integration_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">integration_times</span><span class="p">)</span>

        <span class="n">int_time</span> <span class="o">=</span> <span class="n">maximum_integration_time</span>

        <span class="k">return</span> <span class="n">int_time</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_datadesc">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_datadesc">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_datadesc</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate VLA data description index</span>
<span class="sd">            Use the original VLA buildscans function to return a dd index</span>

<span class="sd">        Returns:</span>
<span class="sd">            ddindex: indexed list of dictionaries with VLA metadata</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cordesclist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Undefined&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;RR&#39;</span><span class="p">,</span> <span class="s1">&#39;RL&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;XX&#39;</span><span class="p">,</span> <span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;YX&#39;</span><span class="p">,</span> <span class="s1">&#39;YY&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;RX&#39;</span><span class="p">,</span> <span class="s1">&#39;RY&#39;</span><span class="p">,</span> <span class="s1">&#39;LX&#39;</span><span class="p">,</span> <span class="s1">&#39;LY&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;XR&#39;</span><span class="p">,</span> <span class="s1">&#39;XL&#39;</span><span class="p">,</span> <span class="s1">&#39;YR&#39;</span><span class="p">,</span> <span class="s1">&#39;YL&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;PP&#39;</span><span class="p">,</span> <span class="s1">&#39;PQ&#39;</span><span class="p">,</span> <span class="s1">&#39;QP&#39;</span><span class="p">,</span> <span class="s1">&#39;QQ&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;RCircular&#39;</span><span class="p">,</span> <span class="s1">&#39;LCircular&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Ptotal&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;Plinear&#39;</span><span class="p">,</span> <span class="s1">&#39;PFtotal&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;PFlinear&#39;</span><span class="p">,</span> <span class="s1">&#39;Pangle&#39;</span><span class="p">]</span>

        <span class="c1"># From Steve Myers buildscans function</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/DATA_DESCRIPTION&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">ddspwarr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;SPECTRAL_WINDOW_ID&quot;</span><span class="p">)</span>
            <span class="n">ddpolarr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;POLARIZATION_ID&quot;</span><span class="p">)</span>

        <span class="n">ddspwlist</span> <span class="o">=</span> <span class="n">ddspwarr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">ddpollist</span> <span class="o">=</span> <span class="n">ddpolarr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">ndd</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddspwlist</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">nchanarr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NUM_CHAN&quot;</span><span class="p">)</span>
            <span class="n">spwnamearr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NAME&quot;</span><span class="p">)</span>
            <span class="n">reffreqarr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;REF_FREQUENCY&quot;</span><span class="p">)</span>

        <span class="n">nspw</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nchanarr</span><span class="p">)</span>
        <span class="n">spwlookup</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">isp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nspw</span><span class="p">):</span>
            <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nchanarr</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>
            <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spwnamearr</span><span class="p">[</span><span class="n">isp</span><span class="p">])</span>
            <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;reffreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reffreqarr</span><span class="p">[</span><span class="n">isp</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/POLARIZATION&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">ncorarr</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;NUM_CORR&quot;</span><span class="p">)</span>
            <span class="n">npols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ncorarr</span><span class="p">)</span>
            <span class="n">polindex</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">poldescr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npols</span><span class="p">):</span>
                <span class="n">cort</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s2">&quot;CORR_TYPE&quot;</span><span class="p">,</span> <span class="n">startrow</span><span class="o">=</span><span class="n">ip</span><span class="p">,</span> <span class="n">nrow</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">(</span><span class="n">nct</span><span class="p">,</span> <span class="n">nr</span><span class="p">)</span> <span class="o">=</span> <span class="n">cort</span><span class="o">.</span><span class="n">shape</span>
                <span class="n">cortypes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">cordescs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ict</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nct</span><span class="p">):</span>
                    <span class="n">cct</span> <span class="o">=</span> <span class="n">cort</span><span class="p">[</span><span class="n">ict</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">cde</span> <span class="o">=</span> <span class="n">cordesclist</span><span class="p">[</span><span class="n">cct</span><span class="p">]</span>
                    <span class="n">cortypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cct</span><span class="p">)</span>
                    <span class="n">cordescs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cde</span><span class="p">)</span>
                <span class="n">polindex</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">cortypes</span>
                <span class="n">poldescr</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">cordescs</span>

        <span class="n">ddindex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ncorlist</span> <span class="o">=</span> <span class="n">ncorarr</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">idd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndd</span><span class="p">):</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">isp</span> <span class="o">=</span> <span class="n">ddspwlist</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isp</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;spwname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;nchan&#39;</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;reffreq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwlookup</span><span class="p">[</span><span class="n">isp</span><span class="p">][</span><span class="s1">&#39;reffreq&#39;</span><span class="p">]</span>
            <span class="c1">#</span>
            <span class="n">ipol</span> <span class="o">=</span> <span class="n">ddpollist</span><span class="p">[</span><span class="n">idd</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;ipol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipol</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;npol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ncorlist</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;corrtype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polindex</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>
            <span class="n">ddindex</span><span class="p">[</span><span class="n">idd</span><span class="p">][</span><span class="s1">&#39;corrdesc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poldescr</span><span class="p">[</span><span class="n">ipol</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ddindex</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_corrstring">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_corrstring">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_corrstring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get correlation string for VLA</span>

<span class="sd">        Returns:</span>
<span class="sd">            corrstring: string value of correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Prep string listing of correlations from dictionary created by method buildscans</span>
        <span class="c1"># For now, only use the parallel hands.  Cross hands will be implemented later.</span>

        <span class="n">ddindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vla_datadesc</span><span class="p">()</span>

        <span class="n">corrstring_list</span> <span class="o">=</span> <span class="n">ddindex</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;corrdesc&#39;</span><span class="p">]</span>
        <span class="n">removal_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RL&#39;</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="s1">&#39;XY&#39;</span><span class="p">,</span> <span class="s1">&#39;YX&#39;</span><span class="p">]</span>
        <span class="n">corrstring_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">corrstring_list</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">removal_list</span><span class="p">)))</span>
        <span class="n">corrstring</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">corrstring_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">corrstring</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_corrlist_from_spw">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_corrlist_from_spw">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_corrlist_from_spw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all VLA correlation labels as a list of string from selected spw(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            spw: a spw selection string or None. Defaults to None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: a list of correlation labels.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vla_datadesc</span><span class="p">()</span>
        <span class="n">corrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ddindex</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">spw</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)):</span>
                <span class="n">corrs</span> <span class="o">=</span> <span class="n">corrs</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;corrdesc&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">corrs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MeasurementSet.get_alma_corrstring">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_alma_corrstring">[docs]</a>
    <span class="k">def</span> <span class="nf">get_alma_corrstring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get correlation string for ALMA for the science spectral windows.</span>

<span class="sd">        Returns:</span>
<span class="sd">            corrstring: string value of correlation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sci_spwlist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">sci_spwids</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">sci_spwlist</span><span class="p">]</span>

        <span class="n">datadescs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dd</span> <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_descriptions</span> <span class="k">if</span> <span class="n">dd</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">sci_spwids</span><span class="p">]</span>

        <span class="n">numpols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">datadescs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">polarizations</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">numpols</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">corrstring</span> <span class="o">=</span> <span class="s1">&#39;XX&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">corrstring</span> <span class="o">=</span> <span class="s1">&#39;XX,YY&#39;</span>

        <span class="k">return</span> <span class="n">corrstring</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_spw2band">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_spw2band">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_spw2band</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find field spws for VLA</span>

<span class="sd">        Returns:</span>
<span class="sd">            spw2band: dictionary with each string key spw index giving a single letter string value of the band</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddindex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vla_datadesc</span><span class="p">()</span>

        <span class="n">spw2band</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ddindex</span><span class="p">:</span>

            <span class="n">strelems</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ddindex</span><span class="p">[</span><span class="n">spw</span><span class="p">][</span><span class="s1">&#39;spwname&#39;</span><span class="p">])</span>
            <span class="n">bandname</span> <span class="o">=</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bandname</span> <span class="ow">in</span> <span class="s1">&#39;4PLSCXUKAQ&#39;</span><span class="p">:</span>
                <span class="n">spw2band</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            <span class="c1"># Check for U / KU</span>
            <span class="k">if</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span> <span class="ow">and</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="n">spw2band</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
            <span class="k">if</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;K&#39;</span> <span class="ow">and</span> <span class="n">strelems</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                <span class="n">spw2band</span><span class="p">[</span><span class="n">spw</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>

        <span class="k">return</span> <span class="n">spw2band</span></div>


<div class="viewcode-block" id="MeasurementSet.vla_minbaselineforcal">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.vla_minbaselineforcal">[docs]</a>
    <span class="k">def</span> <span class="nf">vla_minbaselineforcal</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Min baseline for cal</span>

<span class="sd">        Returns:</span>
<span class="sd">            Constant value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Old determination before it was changed to a constant value of 4</span>
        <span class="c1"># return max(4, int(len(self.antennas) / 2.0))</span>
        <span class="k">return</span> <span class="mi">4</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_field_spws">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_field_spws">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_field_spws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwlist</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find field spws for VLA</span>

<span class="sd">        Args:</span>
<span class="sd">            spwlist (List, optional): list of string spws   [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            field_spws: List of dictionaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Map field IDs to spws</span>
        <span class="n">field_spws</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">spwlistint</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSMDReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">msmd</span><span class="p">:</span>
            <span class="n">spwsforfieldsall</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforfields</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">spwlist</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">spwsforfields</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">spws</span> <span class="ow">in</span> <span class="n">spwsforfieldsall</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">spwsforfields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlistint</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">spwsforfields</span> <span class="o">=</span> <span class="n">spwsforfieldsall</span>

            <span class="n">spwfieldkeys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spwsforfields</span><span class="p">])</span>
            <span class="n">spwfieldkeys</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spwfieldkeys</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">spwfieldkeys</span><span class="p">:</span>
                <span class="n">field_spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwsforfields</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">field_spws</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_numchan">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_numchan">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_numchan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get number of channels for VLA</span>

<span class="sd">        Args:</span>
<span class="sd">            None</span>

<span class="sd">        Returns:</span>
<span class="sd">            channels:  NUM_CHAN column from spectral window table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NUM_CHAN&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">channels</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_tst_bpass_spw">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_tst_bpass_spw">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_tst_bpass_spw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spwlist</span><span class="o">=</span><span class="p">[]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get VLA test bandpass or delay spws</span>
<span class="sd">            This function replaced functionality for get_vla_tst_delay_spw - PIPE-1325</span>

<span class="sd">        Args:</span>
<span class="sd">            spwlist (List, optional): list of string spws   [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;]</span>

<span class="sd">        Returns:</span>
<span class="sd">            tst_bpass_spws: CASA argument format of spws:channels    &#39;0:10~80, 1:15~60, 2:30~70&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tst_delay_spw</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vla_numchan</span><span class="p">()</span>

        <span class="n">ispwlist</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spwlist</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ispw</span> <span class="ow">in</span> <span class="n">ispwlist</span><span class="p">:</span>
            <span class="n">endch1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">channels</span><span class="p">[</span><span class="n">ispw</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span>
            <span class="n">endch2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">channels</span><span class="p">[</span><span class="n">ispw</span><span class="p">]</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">ispw</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">ispwlist</span><span class="p">):</span>
                <span class="n">tst_delay_spw</span> <span class="o">=</span> <span class="n">tst_delay_spw</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ispw</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">endch1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">endch2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tst_delay_spw</span> <span class="o">=</span> <span class="n">tst_delay_spw</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ispw</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">endch1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">endch2</span><span class="p">)</span>

        <span class="n">tst_bpass_spw</span> <span class="o">=</span> <span class="n">tst_delay_spw</span>

        <span class="k">return</span> <span class="n">tst_bpass_spw</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_critfrac">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_critfrac">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_critfrac</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Identify bands/basebands/spws</span>

<span class="sd">        Returns:</span>
<span class="sd">            critical fraction</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">spw_names</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;NAME&#39;</span><span class="p">)</span>

        <span class="c1"># If the dataset is too old to have the bandname in it, assume that</span>
        <span class="c1"># either there are 8 spws per baseband (and allow for one or two for</span>
        <span class="c1"># pointing), or that this is a dataset with one spw per baseband</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_names</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
            <span class="n">critfrac</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spw_names</span><span class="p">)</span><span class="o">/</span><span class="mf">8.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">critfrac</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spw_names</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">spw_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1">#</span>
            <span class="c1"># i assume that if any of the spw_names have &#39;#&#39;, they all do...</span>
            <span class="c1">#</span>
            <span class="n">bands_basebands_subbands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">spw_name</span> <span class="ow">in</span> <span class="n">spw_names</span><span class="p">:</span>
                <span class="n">receiver_name</span><span class="p">,</span> <span class="n">baseband</span><span class="p">,</span> <span class="n">subband</span> <span class="o">=</span> <span class="n">spw_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="n">receiver_band</span> <span class="o">=</span> <span class="p">(</span><span class="n">receiver_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">bands_basebands_subbands</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">receiver_band</span><span class="p">,</span> <span class="n">baseband</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">subband</span><span class="p">)])</span>
            <span class="n">spws_info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">bands_basebands_subbands</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">bands_basebands_subbands</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[]]]</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="p">[</span><span class="n">bands_basebands_subbands</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bands_basebands_subbands</span><span class="p">)):</span>
                <span class="n">band</span><span class="p">,</span> <span class="n">baseband</span><span class="p">,</span> <span class="n">subband</span> <span class="o">=</span> <span class="n">bands_basebands_subbands</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">found</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_info</span><span class="p">)):</span>
                    <span class="n">oband</span><span class="p">,</span> <span class="n">obaseband</span><span class="p">,</span> <span class="n">osubband</span><span class="p">,</span> <span class="n">ospw_list</span> <span class="o">=</span> <span class="n">spws_info</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">band</span> <span class="o">==</span> <span class="n">oband</span> <span class="ow">and</span> <span class="n">baseband</span> <span class="o">==</span> <span class="n">obaseband</span><span class="p">:</span>
                        <span class="n">osubband</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subband</span><span class="p">)</span>
                        <span class="n">ospw_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                        <span class="n">found</span> <span class="o">=</span> <span class="n">jj</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">found</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">spws_info</span><span class="p">[</span><span class="n">found</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">oband</span><span class="p">,</span> <span class="n">obaseband</span><span class="p">,</span> <span class="n">osubband</span><span class="p">,</span> <span class="n">ospw_list</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spws_info</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">band</span><span class="p">,</span> <span class="n">baseband</span><span class="p">,</span> <span class="p">[</span><span class="n">subband</span><span class="p">],</span> <span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
                    <span class="n">bands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="p">)</span>
            <span class="c1"># logprint(&quot;Bands/basebands/spws are:&quot;, logfileout=&#39;logs/msinfo.log&#39;)</span>
            <span class="k">for</span> <span class="n">spw_info</span> <span class="ow">in</span> <span class="n">spws_info</span><span class="p">:</span>
                <span class="n">spw_info_string</span> <span class="o">=</span> <span class="n">spw_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   &#39;</span> <span class="o">+</span> <span class="n">spw_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;   [&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">spw_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;]   [&#39;</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">spw_info</span><span class="p">[</span><span class="mi">3</span><span class="p">]])</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span>
                <span class="c1"># logprint(spw_info_string, logfileout=&#39;logs/msinfo.log&#39;)</span>

            <span class="c1"># Critical fraction of flagged solutions in delay cal to avoid an</span>
            <span class="c1"># entire baseband being flagged on all antennas</span>
            <span class="n">critfrac</span> <span class="o">=</span> <span class="mf">0.9</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spws_info</span><span class="p">))</span>
        <span class="k">elif</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">spw_names</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;old spw names with :&quot;</span><span class="p">)</span>
            <span class="c1"># logprint(&quot;old spw names with :&quot;, logfileout=&#39;logs/msinfo.log&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;unknown spw names&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">critfrac</span></div>


<div class="viewcode-block" id="MeasurementSet.get_vla_baseband_spws">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_vla_baseband_spws">[docs]</a>
    <span class="k">def</span> <span class="nf">get_vla_baseband_spws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">science_windows_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">return_select_list</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                              <span class="n">warning</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the SPW information from individual VLA band/baseband.</span>

<span class="sd">        Args:</span>
<span class="sd">            science_windows_only (bool, optional): Defaults to True.</span>
<span class="sd">            return_select_list (bool, optional): return spw list of each baseband. Defaults to True.</span>
<span class="sd">            warning (bool, optional): Defaults to True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            baseband_spws: spws info of individual basebands as baseband_spws[band][baseband]</span>
<span class="sd">            baseband_spws_list: spw_list of individual basebands</span>
<span class="sd">                e.g., [[0,1,2,3],[4,5,6,7]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">baseband_spws</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="n">science_windows_only</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">band</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">baseband</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">min_freq</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">min_frequency</span>
                <span class="n">max_freq</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">max_frequency</span>
                <span class="n">mean_freq</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">mean_frequency</span>
                <span class="n">chan_width</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getWidth</span><span class="p">()</span>
                <span class="n">baseband_spws</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">baseband</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">,</span> <span class="n">mean_freq</span><span class="p">,</span> <span class="n">chan_width</span><span class="p">)})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">warning</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Exception: Baseband name cannot be parsed. </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">return_select_list</span><span class="p">:</span>
            <span class="n">baseband_spws_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">baseband_spws</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">baseband</span> <span class="ow">in</span> <span class="n">band</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">baseband_spws_list</span><span class="o">.</span><span class="n">append</span><span class="p">([[</span><span class="o">*</span><span class="n">spw_info</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">spw_info</span> <span class="ow">in</span> <span class="n">baseband</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">baseband_spws</span><span class="p">,</span> <span class="n">baseband_spws_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">baseband_spws</span></div>


<div class="viewcode-block" id="MeasurementSet.get_median_integration_time">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_median_integration_time">[docs]</a>
    <span class="k">def</span> <span class="nf">get_median_integration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the median integration time used to get data for the given</span>
<span class="sd">        intent.</span>

<span class="sd">        Args:</span>
<span class="sd">            intent: The intent of the data of interest.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The median integration time used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;inefficiency - MSFlagger reading file to get integration &#39;</span>
                  <span class="s1">&#39;time&#39;</span><span class="p">)</span>

        <span class="c1"># get the field IDs and state IDs for fields in the measurement set,</span>
        <span class="c1"># filtering by intent if necessary</span>
        <span class="k">if</span> <span class="n">intent</span><span class="p">:</span>
            <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
                         <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span>
                         <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
<span class="c1">#        if intent:</span>
<span class="c1">#            re_intent = intent.replace(&#39;*&#39;, &#39;.*&#39;)</span>
<span class="c1">#            re_intent = re.compile(re_intent)</span>
<span class="c1">#            field_ids = [field.id for field in self.fields</span>
<span class="c1">#                         if re_intent.match(str(field.intents))]</span>
<span class="c1">#            state_ids = [state.id for state in self.states</span>
<span class="c1">#                         if re_intent.match(str(state.intents))]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">]</span>

        <span class="c1"># VLA datasets have an empty STATE table; in the main table such rows</span>
        <span class="c1"># have a state ID of -1.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">state_ids</span><span class="p">:</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">taql</span> <span class="o">=</span> <span class="s1">&#39;(STATE_ID IN </span><span class="si">%s</span><span class="s1"> AND FIELD_ID IN </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">state_ids</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">field_ids</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">taql</span><span class="p">))</span> <span class="k">as</span> <span class="n">subtable</span><span class="p">:</span>
                <span class="n">integration</span> <span class="o">=</span> <span class="n">subtable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span></div>


    <span class="c1"># FiXME: Investigate usage: intent argument unused, but method is called</span>
    <span class="c1"># with specific values for intent.</span>
<div class="viewcode-block" id="MeasurementSet.get_median_science_integration_time">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_median_science_integration_time">[docs]</a>
    <span class="k">def</span> <span class="nf">get_median_science_integration_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">intent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the median integration time for science targets used to get data for the given</span>
<span class="sd">        intent.</span>

<span class="sd">        Keyword arguments:</span>
<span class="sd">        intent  -- The intent of the data of interest.</span>
<span class="sd">        spw     -- spw string list - &#39;1,7,11,18&#39;</span>

<span class="sd">        Returns -- The median integration time used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;inefficiency - MSFlagger reading file to get median integration &#39;</span>
                  <span class="s1">&#39;time for science targets&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">spw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Put csv string of spws into a list</span>
                <span class="n">spw_string_list</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

                <span class="c1"># Get all spw objects</span>
                <span class="n">all_spws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span>

                <span class="c1"># Filter out the science spw objects</span>
                <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">ispw</span> <span class="k">for</span> <span class="n">ispw</span> <span class="ow">in</span> <span class="n">all_spws</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">ispw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spw_string_list</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Incorrect spw string format.&quot;</span><span class="p">)</span>

        <span class="c1"># now get the science spws, those used for scientific intent</span>
        <span class="n">science_spws</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">ispw</span> <span class="k">for</span> <span class="n">ispw</span> <span class="ow">in</span> <span class="n">spws</span>
            <span class="k">if</span> <span class="n">ispw</span><span class="o">.</span><span class="n">num_channels</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_num_chans</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">ispw</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">([</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span> <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;TARGET&#39;</span><span class="p">])]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;science spws are: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">[</span><span class="n">ispw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">ispw</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">])</span>

        <span class="c1"># and the science fields/states</span>
        <span class="n">science_field_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">([</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">])]</span>
        <span class="n">science_state_ids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">([</span><span class="s1">&#39;BANDPASS&#39;</span><span class="p">,</span> <span class="s1">&#39;AMPLITUDE&#39;</span><span class="p">,</span>
                                                  <span class="s1">&#39;PHASE&#39;</span><span class="p">,</span> <span class="s1">&#39;TARGET&#39;</span><span class="p">])]</span>

        <span class="n">science_spw_dd_ids</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">]</span>

        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">taql</span> <span class="o">=</span> <span class="s1">&#39;(STATE_ID IN </span><span class="si">%s</span><span class="s1"> AND FIELD_ID IN </span><span class="si">%s</span><span class="s1"> AND DATA_DESC_ID in </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">science_state_ids</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">science_field_ids</span><span class="p">),</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">science_spw_dd_ids</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">taql</span><span class="p">))</span> <span class="k">as</span> <span class="n">subtable</span><span class="p">:</span>
                <span class="n">integration</span> <span class="o">=</span> <span class="n">subtable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span></div>


<div class="viewcode-block" id="MeasurementSet.get_times_on_source_per_field_id">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_times_on_source_per_field_id">[docs]</a>
    <span class="k">def</span> <span class="nf">get_times_on_source_per_field_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">intent</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return on-source time for given field ID(s) and intent(s).</span>

<span class="sd">        Args:</span>
<span class="sd">            field: Field name(s) to return times for.</span>
<span class="sd">            intent: Intent(s) to filter for.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of on-source times for selected field ID(s) and intent(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="n">scan_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">scan_intent</span><span class="o">=</span><span class="n">intent</span><span class="p">)]</span>
        <span class="c1"># Need to select just one cross correlation row between antenna 1 and 2</span>
        <span class="n">ant1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="n">ant2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="c1"># Just a single spw since all spws are observed together</span>
        <span class="n">first_science_spw_dd_id</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_data_description</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()]][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">times_on_source_per_field_id</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">taql</span> <span class="o">=</span> <span class="s1">&#39;(STATE_ID IN </span><span class="si">%s</span><span class="s1"> AND FIELD_ID IN [</span><span class="si">%s</span><span class="s1">] AND DATA_DESC_ID in [</span><span class="si">%s</span><span class="s1">] AND SCAN_NUMBER in </span><span class="si">%s</span><span class="s1"> AND ANTENNA1=</span><span class="si">%s</span><span class="s1"> AND ANTENNA2=</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">state_ids</span><span class="p">),</span> <span class="n">field_id</span><span class="p">,</span> <span class="n">first_science_spw_dd_id</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">list_to_str</span><span class="p">(</span><span class="n">scan_ids</span><span class="p">),</span> <span class="n">ant1</span><span class="p">,</span> <span class="n">ant2</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">taql</span><span class="p">))</span> <span class="k">as</span> <span class="n">subtable</span><span class="p">:</span>
                    <span class="n">integration</span> <span class="o">=</span> <span class="n">subtable</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;INTERVAL&#39;</span><span class="p">)</span>
                <span class="n">times_on_source_per_field_id</span><span class="p">[</span><span class="n">field_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">integration</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">times_on_source_per_field_id</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reference_antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the reference antenna list for this MS. The refant value is</span>
<span class="sd">        a comma-separated string.</span>

<span class="sd">        Example: &#39;DV01,DV02,DV03&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reference_antenna</span>

    <span class="nd">@reference_antenna</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">reference_antenna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the reference antenna list for this MS.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: Antenna names to set as reference antennas.</span>

<span class="sd">        Raises:</span>
<span class="sd">            AttributeError if the reference antenna list is in read-only mode,</span>
<span class="sd">            as set by the reference_antenna_locked property.</span>

<span class="sd">        Example: ms.reference_antenna = &#39;DV01,DV02,DV03&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna_locked</span><span class="p">:</span>
            <span class="c1"># AttributeError is raised for R/O properties, which seems</span>
            <span class="c1"># appropriate for this scenario</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Refant list for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="si">}</span><span class="s1"> is locked&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reference_antenna</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="MeasurementSet.update_reference_antennas">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.update_reference_antennas">[docs]</a>
    <span class="k">def</span> <span class="nf">update_reference_antennas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ants_to_demote</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ants_to_remove</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>\
            <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the reference antenna list for this MS to demote/remove specified antennas.</span>

<span class="sd">        Args:</span>
<span class="sd">            ants_to_demote: Set of antenna names to demote.</span>
<span class="sd">            ants_to_remove: Set of antenna names to remove.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Return early if no refants are registered (None, or empty string).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No reference antennas registered set for MS </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">), &#39;</span>
                        <span class="s1">&#39;cannot update its reference antenna list.&#39;</span><span class="o">.</span>
                        <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))))</span>
            <span class="k">return</span>

        <span class="n">previous_reference_antenna</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span>

        <span class="c1"># Create updated refant list.</span>
        <span class="n">refants_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">refants_to_move</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ant</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ants_to_remove</span> <span class="ow">or</span> <span class="n">ant</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ants_to_remove</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ants_to_demote</span> <span class="ow">and</span> <span class="n">ant</span> <span class="ow">in</span> <span class="n">ants_to_demote</span><span class="p">:</span>
                    <span class="n">refants_to_move</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">refants_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ant</span><span class="p">)</span>
        <span class="n">refants_to_keep</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">refants_to_move</span><span class="p">)</span>

        <span class="c1"># Update refant list.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refants_to_keep</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ms.update_reference_antennas for MS </span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">): previous list=</span><span class="si">{}</span><span class="s1">, removed=</span><span class="si">{}</span><span class="s1">, demoted=</span><span class="si">{}</span><span class="s1">, new list=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span>
                 <span class="nb">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)),</span> <span class="n">previous_reference_antenna</span><span class="p">,</span>
                        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ants_to_remove</span><span class="p">))</span> <span class="k">if</span> <span class="n">ants_to_remove</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ants_to_demote</span><span class="p">))</span> <span class="k">if</span> <span class="n">ants_to_remove</span> <span class="k">else</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">reference_antenna</span><span class="p">))</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return name of session associated with this measurement set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_session</span>

    <span class="nd">@session</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set name of session associated with this measurement set.</span>

<span class="sd">        Args:</span>
<span class="sd">            value: Name of session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;session_1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_session</span> <span class="o">=</span> <span class="n">value</span>

<div class="viewcode-block" id="MeasurementSet.all_colnames">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.all_colnames">[docs]</a>
    <span class="k">def</span> <span class="nf">all_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all available column names for this MS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">colnames</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">colnames</span></div>


<div class="viewcode-block" id="MeasurementSet.data_colnames">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.data_colnames">[docs]</a>
    <span class="k">def</span> <span class="nf">data_colnames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return all data column names for this MS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">colname</span> <span class="k">for</span> <span class="n">colname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_colnames</span><span class="p">()</span> <span class="k">if</span> <span class="n">colname</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;FLOAT_DATA&#39;</span><span class="p">,</span> <span class="s1">&#39;CORRECTED_DATA&#39;</span><span class="p">)]</span></div>


<div class="viewcode-block" id="MeasurementSet.set_data_column">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.set_data_column">[docs]</a>
    <span class="k">def</span> <span class="nf">set_data_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set data type and column.</span>

<span class="sd">        Set data type and column to MS domain object and record the available</span>
<span class="sd">        data types per (source,spw) tuple. If source or spw are unset, they</span>
<span class="sd">        will be expanded to all available values.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtype: data type to set</span>
<span class="sd">            column: name of column in MS associated with the data type</span>
<span class="sd">            source: source name selection string (comma separated names). If</span>
<span class="sd">                unset, all sources will be used.</span>
<span class="sd">            spw: real spectral window selection string (string of comma</span>
<span class="sd">                separated IDs). If unset, all real spw IDs will be used.</span>
<span class="sd">            overwrite: if True existing data colum is overwritten by the new</span>
<span class="sd">                column. If False and if type is already associated with other</span>
<span class="sd">                column, the function raises ValueError.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: An error raised when the column does not exist</span>
<span class="sd">                or the type is already associated with a column or the</span>
<span class="sd">                column is already assigned to a type and would not</span>
<span class="sd">                be overwritten.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check existence of the column</span>
        <span class="n">colnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_colnames</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">colnames</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column </span><span class="si">{}</span><span class="s1"> does not exist in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

        <span class="c1"># Check if data type is already associated with another column</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_column</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Data type </span><span class="si">{}</span><span class="s1"> is already associated with column </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">dtype</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_column</span><span class="p">(</span><span class="n">dtype</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

        <span class="c1"># Check if column is already assigned to another data type</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">column</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_data_column</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span> <span class="o">!=</span> <span class="n">column</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Column </span><span class="si">{}</span><span class="s1"> is already associated with data type </span><span class="si">{}</span><span class="s1"> in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">column</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">column</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">))</span>

        <span class="n">source_name_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_select_to_list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">spw_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw_select_to_list</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>

        <span class="c1"># Update data types per (source,spw) selection</span>
        <span class="k">for</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="n">source_name_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">spw_id_list</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

        <span class="c1"># Check for existing column registration and remove it</span>
        <span class="n">column_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">column</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">column_keys</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">column_keys</span><span class="p">:</span>
                <span class="k">del</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="c1"># Update MS domain object</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">column</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Updated data column information of </span><span class="si">{}</span><span class="s1">. Set </span><span class="si">{}</span><span class="s1"> to column </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">column</span><span class="p">))</span></div>


<div class="viewcode-block" id="MeasurementSet.get_data_column">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_data_column">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the column name associated with a DataType in an MS domain</span>
<span class="sd">        object for given source and spectral window.</span>

<span class="sd">        If ``source`` and ``spw`` are both unset, the method will just look</span>
<span class="sd">        at the MS data type and column information. If one or both parameters</span>
<span class="sd">        are set, it will require all (source,spw) combinations to have data of</span>
<span class="sd">        the requested data type.</span>

<span class="sd">        Args:</span>
<span class="sd">            dtype: DataType to fetch column name for</span>
<span class="sd">            source: Source names (comma separated name selection string) to</span>
<span class="sd">                filter for. If unset, all sources will be used.</span>
<span class="sd">            spw: Spectral windows (comma separated real spw ID selection string)</span>
<span class="sd">                to filter for. If unset, all real spw IDs will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A name of column of a dtype. Returns None if dtype is not defined</span>
<span class="sd">            in the MS.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>

        <span class="n">source_name_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_select_to_list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">spw_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw_select_to_list</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>

        <span class="c1"># Check all (source,spw) combinations</span>
        <span class="n">data_exists_for_all_source_spw_combinations</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="n">source_name_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">spw_id_list</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">data_exists_for_all_source_spw_combinations</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">data_exists_for_all_source_spw_combinations</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="p">[</span><span class="n">dtype</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="MeasurementSet.get_data_type">
<a class="viewcode-back" href="../../../_autosummary/pipeline.domain.MeasurementSet.html#pipeline.domain.MeasurementSet.get_data_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_data_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spw</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataType</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the DataType associated with a column in an MS domain object for</span>
<span class="sd">        given source and spectral window.</span>

<span class="sd">        If ``source`` and ``spw`` are both unset, the method will just look at</span>
<span class="sd">        the MS data type and column information. If one or both parameters are</span>
<span class="sd">        set, it will require all (source,spw) combinations to have data of the</span>
<span class="sd">        requested data type.</span>

<span class="sd">        Args:</span>
<span class="sd">            column: Name of column in MS</span>
<span class="sd">            source: Source names (comma separated name selection string) to</span>
<span class="sd">                filter for. If unset, all sources will be used.</span>
<span class="sd">            spw: Spectral windows (comma separated real spw ID selection string)</span>
<span class="sd">                to filter for. If unset, all real spw IDs will be used.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The DataType associated with the column name. Returns None</span>
<span class="sd">            if dtype is not defined in the MS or in the source/spw</span>
<span class="sd">            selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Invert dictionary. This should not lead to wrong mappings</span>
        <span class="c1"># because data types and columns have a 1:1 relation.</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_column</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">spw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_type</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>

        <span class="n">source_name_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_select_to_list</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">spw_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spw_select_to_list</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>

        <span class="c1"># Check all (source,spw) combinations</span>
        <span class="n">data_exists_for_all_source_spw_combinations</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">column_dtype</span> <span class="o">=</span> <span class="n">data_type</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">source_name</span> <span class="ow">in</span> <span class="n">source_name_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">spw_id_list</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">column_dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_types_per_source_and_spw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">data_exists_for_all_source_spw_combinations</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">data_exists_for_all_source_spw_combinations</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">column_dtype</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="nf">_source_select_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a CASA-style source selection string to a list of source names.</span>

<span class="sd">        Args:</span>
<span class="sd">            source_select: source string to convert</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of source names (as strings)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">source_select</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">source_select</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># if None or empty or blank selection string, use all sources</span>
            <span class="n">source_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">source_select</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">source_list</span>

    <span class="k">def</span> <span class="nf">_spw_select_to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw_select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a CASA-style spw selection string to a list of spw IDs.</span>

<span class="sd">        Args:</span>
<span class="sd">            spw_select: spw selection string to convert</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of spw IDs (as integers)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spw_select</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">spw_select</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="c1"># if None or empty or blank selection string, use all spws</span>
            <span class="n">spw_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spw_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">range_to_list</span><span class="p">(</span><span class="n">spw_select</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spw_list</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>