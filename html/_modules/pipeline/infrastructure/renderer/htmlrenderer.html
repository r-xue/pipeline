

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.infrastructure.renderer.htmlrenderer &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context/etc. (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.callibrary"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.project</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#pipeline-infrastructure-callibrary-module"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.callibrary</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#pipeline-infrastructure-imagelibrary-module"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.imagelibrary</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.vdp"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.vdp</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../pipeline.html">pipeline</a></li>
          <li class="breadcrumb-item"><a href="../../infrastructure.html">pipeline.infrastructure</a></li>
      <li class="breadcrumb-item active">pipeline.infrastructure.renderer.htmlrenderer</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.infrastructure.renderer.htmlrenderer</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pydoc</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">mako</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>

<span class="kn">import</span> <span class="nn">pipeline</span> <span class="k">as</span> <span class="nn">pipeline</span>
<span class="kn">import</span> <span class="nn">pipeline.domain.measures</span> <span class="k">as</span> <span class="nn">measures</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure</span> <span class="k">as</span> <span class="nn">infrastructure</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.basetask</span> <span class="k">as</span> <span class="nn">basetask</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.displays.pointing</span> <span class="k">as</span> <span class="nn">pointing</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.displays.summary</span> <span class="k">as</span> <span class="nn">summary</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.logging</span> <span class="k">as</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pipeline</span> <span class="kn">import</span> <span class="n">environment</span>
<span class="kn">from</span> <span class="nn">pipeline.domain.measurementset</span> <span class="kn">import</span> <span class="n">MeasurementSet</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">mpihelpers</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">task_registry</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.launcher</span> <span class="kn">import</span> <span class="n">Context</span>
<span class="kn">from</span> <span class="nn">pipeline.infrastructure.renderer.templates</span> <span class="kn">import</span> <span class="n">resources</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">qaadapter</span><span class="p">,</span> <span class="n">weblog</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">eventbus</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">pipelineqa</span>
<span class="kn">from</span> <span class="nn">..eventbus</span> <span class="kn">import</span> <span class="n">WebLogStageRenderingStartedEvent</span><span class="p">,</span> <span class="n">WebLogStageRenderingCompleteEvent</span><span class="p">,</span> \
    <span class="n">WebLogStageRenderingAbnormalExitEvent</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_task_description">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_task_description.html#pipeline.infrastructure.renderer.htmlrenderer.get_task_description">[docs]</a>
<span class="k">def</span> <span class="nf">get_task_description</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">include_stage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">get_task_description</span><span class="p">([</span><span class="n">result_obj</span><span class="p">,</span> <span class="p">],</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cannot get description for zero-length results list&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="n">description</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Check if any of the results in the list are FailedTaskResults, handle as</span>
    <span class="c1"># special case:</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">]):</span>
        <span class="c1"># Find failed task result</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">):</span>
                <span class="c1"># Extract original task class from failed result.</span>
                <span class="n">task_cls</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">origtask_cls</span>

                <span class="c1"># Try to extract task description from renderer belonging to</span>
                <span class="c1"># original task.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">renderer</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">(</span><span class="n">task_cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No renderer registered for task </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                    <span class="k">raise</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">description</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># If there was no FailedResult, then use first result to represent the</span>
        <span class="c1"># the task.</span>
        <span class="n">task_cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;task&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task registered on results of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">results_cls</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;metadata&#39;</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;No metadata property found on result for task </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;long description&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;long description&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">description</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># taking index 0 should be safe as entry to function ensures</span>
                <span class="c1"># result_obj is a list</span>
                <span class="n">renderer</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">(</span><span class="n">task_cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No renderer registered for task </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">_get_task_description_for_class</span><span class="p">(</span><span class="n">task_cls</span><span class="p">)</span>

    <span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">. &#39;</span> <span class="o">%</span> <span class="n">get_stage_number</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_stage</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
         <span class="s1">&#39;task_name&#39;</span><span class="p">:</span> <span class="n">get_task_name</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">include_stage</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
         <span class="s1">&#39;stage&#39;</span><span class="p">:</span> <span class="n">stage</span><span class="p">}</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{stage}</span><span class="s1">&lt;strong&gt;</span><span class="si">{task_name}</span><span class="s1">&lt;/strong&gt;: </span><span class="si">{description}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">d</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_get_task_description_for_class</span><span class="p">(</span><span class="n">task_cls</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">LOG</span><span class="o">.</span><span class="n">isEnabledFor</span><span class="p">(</span><span class="n">LOG</span><span class="o">.</span><span class="n">todo</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">todo</span><span class="p">(</span><span class="s1">&#39;No task description for </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1"> (developers should add a task description)&#39;</span>
                <span class="s1">&#39;&#39;</span> <span class="o">%</span> <span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span>


<div class="viewcode-block" id="get_task_name">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_task_name.html#pipeline.infrastructure.renderer.htmlrenderer.get_task_name">[docs]</a>
<span class="k">def</span> <span class="nf">get_task_name</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">include_stage</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">. &#39;</span> <span class="o">%</span> <span class="n">get_stage_number</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_stage</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="s1">&#39;task&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">):</span>
            <span class="n">task_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">origtask_cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">task</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">casa_task</span> <span class="o">=</span> <span class="n">task_registry</span><span class="o">.</span><span class="n">get_casa_task</span><span class="p">(</span><span class="n">task_cls</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">casa_task</span> <span class="o">=</span> <span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Prepend stage number to task name.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">casa_task</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;sidebar suffix&#39;</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sidebar suffix&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; (failed)&#39;</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">]):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; (failed)&#39;</span>

        <span class="k">return</span> <span class="n">s</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">get_task_name</span><span class="p">([</span><span class="n">result_obj</span><span class="p">,</span> <span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cannot get task name for zero-length results list&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="c1"># Take task class from first result in result list.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">):</span>
            <span class="n">task_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">origtask_cls</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task</span>

        <span class="k">if</span> <span class="n">task_cls</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">results_cls</span> <span class="o">=</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task registered on results of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">results_cls</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">msg</span>

        <span class="c1"># Get the task name from the task registry, otherwise use the CASA</span>
        <span class="c1"># class name.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">casa_task</span> <span class="o">=</span> <span class="n">task_registry</span><span class="o">.</span><span class="n">get_casa_task</span><span class="p">(</span><span class="n">task_cls</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">casa_task</span> <span class="o">=</span> <span class="n">task_cls</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Prepend stage number to task name.</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="n">casa_task</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;sidebar suffix&#39;</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> (</span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">result_obj</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;sidebar suffix&#39;</span><span class="p">])</span>

        <span class="c1"># Append a label to task name if any of the results in the task result</span>
        <span class="c1"># list indicates that the task encountered a failure.</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_obj</span><span class="p">]):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s1">&#39; (failed)&#39;</span>

        <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="get_stage_number">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_stage_number.html#pipeline.infrastructure.renderer.htmlrenderer.get_stage_number">[docs]</a>
<span class="k">def</span> <span class="nf">get_stage_number</span><span class="p">(</span><span class="n">result_obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result_obj</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">get_stage_number</span><span class="p">([</span><span class="n">result_obj</span><span class="p">,</span> <span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cannot get stage number for zero-length results list&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">msg</span>

    <span class="k">return</span> <span class="n">result_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stage_number</span></div>



<div class="viewcode-block" id="get_plot_dir">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_plot_dir.html#pipeline.infrastructure.renderer.htmlrenderer.get_plot_dir">[docs]</a>
<span class="k">def</span> <span class="nf">get_plot_dir</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">stage_number</span><span class="p">):</span>
    <span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;stage</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">stage_number</span><span class="p">)</span>
    <span class="n">plots_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage_dir</span><span class="p">,</span> <span class="s1">&#39;plots&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plots_dir</span></div>



<div class="viewcode-block" id="is_singledish_ms">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.is_singledish_ms.html#pipeline.infrastructure.renderer.htmlrenderer.is_singledish_ms">[docs]</a>
<span class="k">def</span> <span class="nf">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="c1"># importdata results</span>
    <span class="n">result0</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># if ResultsProxy, read pickled result</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result0</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsProxy</span><span class="p">):</span>
        <span class="n">result0</span> <span class="o">=</span> <span class="n">result0</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># if RestoreDataResults, get importdata_results</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">result0</span><span class="p">,</span> <span class="s1">&#39;importdata_results&#39;</span><span class="p">):</span>
        <span class="n">result0</span> <span class="o">=</span> <span class="n">result0</span><span class="o">.</span><span class="n">importdata_results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">result_repr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result_repr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SDImportDataResults&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span></div>


<div class="viewcode-block" id="scan_has_intent">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.scan_has_intent.html#pipeline.infrastructure.renderer.htmlrenderer.scan_has_intent">[docs]</a>
<span class="k">def</span> <span class="nf">scan_has_intent</span><span class="p">(</span><span class="n">scans</span><span class="p">,</span> <span class="n">intent</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the list of scans includes a specified intent&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">intent</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="Session">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.Session.html#pipeline.infrastructure.renderer.htmlrenderer.Session">[docs]</a>
<span class="k">class</span> <span class="nc">Session</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Unnamed Session&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mses</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">mses</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">mses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_sessions</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="c1"># eventually we will need to sort by OUS ID too, but at the moment data</span>
        <span class="c1"># is all registered against a single OUS ID.</span>

        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">get_mses_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="n">d</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="n">session_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">session_name</span><span class="p">,</span> <span class="n">session_mses</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">oldest_ms</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">session_mses</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>
            <span class="n">session_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">oldest_ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">),</span> <span class="n">session_name</span><span class="p">,</span> <span class="n">session_mses</span><span class="p">))</span>

        <span class="c1"># primary sort sessions by their start time then by session name</span>
        <span class="k">def</span> <span class="nf">mycmp</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">cmp</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="c1"># natural sort so that session9 comes before session10</span>
                <span class="n">name_sorted</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">natural_sort</span><span class="p">((</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">name_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">Session</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mses</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">session_names</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">mycmp</span><span class="p">))]</span></div>



<div class="viewcode-block" id="RendererBase">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.RendererBase.html#pipeline.infrastructure.renderer.htmlrenderer.RendererBase">[docs]</a>
<span class="k">class</span> <span class="nc">RendererBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base renderer class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rerender</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">todo</span><span class="p">(</span><span class="s1">&#39;RendererBase: I think I</span><span class="se">\&#39;</span><span class="s1">m rerendering all pages!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># give the implementing class a chance to bypass rendering. This is</span>
        <span class="c1"># useful when the page has not changed, eg. MS description pages when</span>
        <span class="c1"># no subsequent ImportData has been performed</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rerender</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">path_to_resources_pkg</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">path_to_js</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_resources_pkg</span><span class="p">,</span> <span class="s1">&#39;js&#39;</span><span class="p">,</span> <span class="s1">&#39;pipeline_common.min.js&#39;</span><span class="p">)</span>
        <span class="n">use_minified_js</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path_to_js</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">TEMPLATE_LOOKUP</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
            <span class="n">display_context</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">display_context</span><span class="p">[</span><span class="s1">&#39;use_minified_js&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_minified_js</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">display_context</span><span class="p">))</span></div>



<div class="viewcode-block" id="T1_1Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T1_1Renderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T1-1 OUS Splash Page renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t1-1.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t1-1.mako&#39;</span>

    <span class="c1"># named tuple holding values for each row in the main summary table</span>
    <span class="n">TableRow</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
                <span class="s1">&#39;Tablerow&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;ousstatus_entity_id schedblock_id schedblock_name session &#39;</span>
                <span class="s1">&#39;execblock_id ms acs_software_version acs_software_build_version observing_modes href filesize &#39;</span> 
                <span class="s1">&#39;receivers &#39;</span>
                <span class="s1">&#39;num_antennas beamsize_min beamsize_max &#39;</span>
                <span class="s1">&#39;time_start time_end time_on_source &#39;</span>
                <span class="s1">&#39;baseline_min baseline_max baseline_rms&#39;</span><span class="p">)</span>
    <span class="n">TableRowNRO</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
                <span class="s1">&#39;TablerowNRO&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;ousstatus_entity_id schedblock_id schedblock_name session &#39;</span>
                <span class="s1">&#39;execblock_id ms href filesize &#39;</span> 
                <span class="s1">&#39;receivers &#39;</span>
                <span class="s1">&#39;num_antennas beamsize_min beamsize_max &#39;</span>
                <span class="s1">&#39;time_start time_end time_on_source &#39;</span>
                <span class="s1">&#39;baseline_min baseline_max baseline_rms &#39;</span>
                <span class="s1">&#39;merge2_version&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="T1_1Renderer.EnvironmentProperty">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer.EnvironmentProperty">[docs]</a>
    <span class="k">class</span> <span class="nc">EnvironmentProperty</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enumeration of environment properties that describe the host</span>
<span class="sd">        execution environment and resource limits.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">HOSTNAME</span> <span class="o">=</span> <span class="s1">&#39;Hostname&#39;</span>
        <span class="n">CPU_TYPE</span> <span class="o">=</span> <span class="s1">&#39;CPU&#39;</span>
        <span class="n">LOGICAL_CPU_CORES</span> <span class="o">=</span> <span class="s1">&#39;Logical CPU cores&#39;</span>
        <span class="n">PHYSICAL_CPU_CORES</span> <span class="o">=</span> <span class="s1">&#39;Physical CPU cores&#39;</span>
        <span class="n">NUM_MPI_SERVERS</span> <span class="o">=</span> <span class="s2">&quot;Number of MPI servers&quot;</span>
        <span class="n">RAM</span> <span class="o">=</span> <span class="s2">&quot;RAM&quot;</span>
        <span class="n">SWAP</span> <span class="o">=</span> <span class="s2">&quot;Swap&quot;</span>
        <span class="n">OS</span> <span class="o">=</span> <span class="s2">&quot;OS&quot;</span>
        <span class="n">ULIMIT_FILES</span> <span class="o">=</span> <span class="s2">&quot;Max open file descriptors&quot;</span>
        <span class="n">ULIMIT_MEM</span> <span class="o">=</span> <span class="s2">&quot;Memory usage ulimit&quot;</span>
        <span class="n">ULIMIT_CPU</span> <span class="o">=</span> <span class="s2">&quot;CPU time ulimit in seconds&quot;</span>
        <span class="n">CASA_CORES</span> <span class="o">=</span> <span class="s2">&quot;CASA-reported CPU cores availability&quot;</span>
        <span class="n">CASA_THREADS</span> <span class="o">=</span> <span class="s2">&quot;Max OpenMP threads per CASA instance&quot;</span>
        <span class="n">CASA_MEMORY</span> <span class="o">=</span> <span class="s2">&quot;Memory available to pipeline&quot;</span>
        <span class="n">CGROUP_NUM_CPUS</span> <span class="o">=</span> <span class="s2">&quot;Cgroup CPU allocation&quot;</span>
        <span class="n">CGROUP_CPU_BANDWIDTH</span> <span class="o">=</span> <span class="s2">&quot;Cgroup CPU bandwidth&quot;</span>
        <span class="n">CGROUP_CPU_WEIGHT</span> <span class="o">=</span> <span class="s2">&quot;CPU distribution within cgroup&quot;</span>
        <span class="n">CGROUP_MEM_LIMIT</span> <span class="o">=</span> <span class="s2">&quot;Cgroup memory limit&quot;</span>

        <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctx</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">CASA_MEMORY</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Memory available to </span><span class="si">{</span><span class="s2">&quot;pipeline&quot;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s2">&quot;tclean&quot;</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="T1_1Renderer.EnvironmentTable">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_1Renderer.EnvironmentTable">[docs]</a>
    <span class="k">class</span> <span class="nc">EnvironmentTable</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Representation of the resource limit table in the weblog.</span>

<span class="sd">        Rows in the output table will have the same order as the rows constructor</span>
<span class="sd">        argument.</span>

<span class="sd">        @param rows: properties to present in the table</span>
<span class="sd">        @param data: dict of environment properties per host</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
                <span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s2">&quot;T1_1Renderer.EnvironmentProperty&quot;</span><span class="p">],</span>
                <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="s2">&quot;T1_1Renderer.EnvironmentProperty&quot;</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span>
            <span class="p">):</span>

            <span class="c1"># &#39;memory available to pipeline&#39; should not be presented for SD data</span>
            <span class="k">if</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">ctx</span><span class="p">):</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentProperty</span><span class="o">.</span><span class="n">CASA_MEMORY</span><span class="p">]</span>

            <span class="c1"># getNumCPUs is confusing when run in an MPI context, giving the</span>
            <span class="c1"># number of cores that the process can migrate to rather than</span>
            <span class="c1"># number of cores used by CASA. To avoid confusion, we remove the</span>
            <span class="c1"># CASA cores row completely for MPI runs.</span>
            <span class="k">if</span> <span class="n">mpihelpers</span><span class="o">.</span><span class="n">is_mpi_ready</span><span class="p">():</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentProperty</span><span class="o">.</span><span class="n">CASA_CORES</span><span class="p">]</span>

            <span class="n">unmerged_rows</span> <span class="o">=</span> <span class="p">[(</span><span class="n">prop</span><span class="o">.</span><span class="n">description</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span> <span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span> <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
            <span class="n">merged_rows</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_td_rows</span><span class="p">(</span><span class="n">utils</span><span class="o">.</span><span class="n">merge_td_columns</span><span class="p">(</span><span class="n">unmerged_rows</span><span class="p">))</span>

            <span class="c1"># we want headings in column 1 so need to replace markup</span>
            <span class="c1"># we could also achieve this with CSS but it&#39;s easier just to modify the data</span>
            <span class="n">formatted</span> <span class="o">=</span> <span class="p">([</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;td&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;th scope=&quot;row&quot;&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;/td&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/th&gt;&#39;</span><span class="p">),</span> <span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">merged_rows</span>
            <span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">table_rows</span> <span class="o">=</span> <span class="n">formatted</span>
            <span class="c1"># required to set the colspan property of the table title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentProperty</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">obs_start</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">start_datetime</span>
        <span class="n">obs_end</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">end_datetime</span>

        <span class="n">project_uids</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">project_ids</span><span class="p">)</span>
        <span class="n">schedblock_uids</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">schedblock_ids</span><span class="p">)</span>
        <span class="n">execblock_uids</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">execblock_ids</span><span class="p">)</span>
        <span class="n">observers</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">observers</span><span class="p">)</span>

        <span class="n">array_names</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span>
                       <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">}</span>

        <span class="c1"># pipeline execution start, end and duration</span>
        <span class="n">exec_start</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">start</span>
        <span class="n">exec_end</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">end</span>
        <span class="c1"># IERS information (PIPE-734)</span>
        <span class="n">iers_eop_2000_version</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">iers_info</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="s2">&quot;IERSeop2000&quot;</span><span class="p">]</span>
        <span class="n">iers_predict_version</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">iers_info</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="s2">&quot;IERSpredict&quot;</span><span class="p">]</span>
        <span class="n">iers_eop_2000_last_date</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">iers_info</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;IERSeop2000_last&quot;</span><span class="p">]</span>
        <span class="n">iers_predict_last_date</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">iers_info</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;IERSpredict_last&quot;</span><span class="p">]</span>
        <span class="n">iers_info</span> <span class="o">=</span> <span class="n">environment</span><span class="o">.</span><span class="n">iers_info</span>
        <span class="c1"># remove unnecessary precision for execution duration</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">exec_end</span> <span class="o">-</span> <span class="n">exec_start</span>
        <span class="n">exec_duration</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>

<span class="c1">#         qaresults = qaadapter.ResultsToQAAdapter(context.results)</span>

        <span class="n">out_fmt</span> <span class="o">=</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span>

        <span class="c1"># Convert timestamps, if available:</span>
        <span class="n">obs_start_fmt</span> <span class="o">=</span> <span class="n">obs_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs_start</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span>
        <span class="n">obs_end_fmt</span> <span class="o">=</span> <span class="n">obs_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">obs_end</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span>
        <span class="n">exec_start_fmt</span> <span class="o">=</span> <span class="n">exec_start</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">exec_start</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span>
        <span class="n">exec_end_fmt</span> <span class="o">=</span> <span class="n">exec_end</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">out_fmt</span><span class="p">)</span> <span class="k">if</span> <span class="n">exec_end</span> <span class="k">else</span> <span class="s2">&quot;n/a&quot;</span>

        <span class="c1"># Set link to pipeline documentation depending on which observatory</span>
        <span class="c1"># this context is for.</span>
        <span class="n">observatory</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span>
        <span class="k">if</span> <span class="n">observatory</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
            <span class="n">pipeline_doclink</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">__pipeline_documentation_weblink_alma__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pipeline_doclink</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Observation Summary (formerly the T1-2 page)</span>
        <span class="n">ms_summary_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">get_mses_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="n">link</span> <span class="o">=</span> <span class="s1">&#39;sidebar_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;t2-1.html?sidebar=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">link</span><span class="p">)</span>

            <span class="n">num_antennas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">)</span>
            <span class="c1"># times should be passed as Python datetimes</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

            <span class="n">target_scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="n">is_single_dish_data</span> <span class="o">=</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">scan_has_intent</span><span class="p">(</span><span class="n">target_scans</span><span class="p">,</span> <span class="s1">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_single_dish_data</span><span class="p">:</span>
                <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_target_on_source</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">is_single_dish_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_source</span><span class="p">(</span><span class="n">target_scans</span><span class="p">)</span>
            <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="n">time_on_source</span><span class="p">)</span>

            <span class="n">baseline_min</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_min</span><span class="o">.</span><span class="n">length</span>
            <span class="n">baseline_max</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_max</span><span class="o">.</span><span class="n">length</span>

            <span class="n">baseline_rms</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">Distance</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baselines_m</span><span class="p">))),</span>
                <span class="n">units</span><span class="o">=</span><span class="n">measures</span><span class="o">.</span><span class="n">DistanceUnits</span><span class="o">.</span><span class="n">METRE</span>
            <span class="p">)</span>

            <span class="n">science_spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">receivers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="s1">&#39;science_goals&#39;</span><span class="p">):</span>
                <span class="n">sb_name</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sbName&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sb_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">observatory</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;NRO&#39;</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">TableRowNRO</span><span class="p">(</span><span class="n">ousstatus_entity_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span><span class="p">,</span>
                                            <span class="n">schedblock_id</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">schedblock_id</span><span class="p">,</span>
                                            <span class="n">schedblock_name</span><span class="o">=</span><span class="n">sb_name</span><span class="p">,</span>
                                            <span class="n">session</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                            <span class="n">execblock_id</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">execblock_id</span><span class="p">,</span>
                                            <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                            <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span>
                                            <span class="n">filesize</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span>
                                            <span class="n">receivers</span><span class="o">=</span><span class="n">receivers</span><span class="p">,</span>
                                            <span class="n">num_antennas</span><span class="o">=</span><span class="n">num_antennas</span><span class="p">,</span>
                                            <span class="n">beamsize_min</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                            <span class="n">beamsize_max</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                            <span class="n">time_start</span><span class="o">=</span><span class="n">time_start</span><span class="p">,</span>
                                            <span class="n">time_end</span><span class="o">=</span><span class="n">time_end</span><span class="p">,</span>
                                            <span class="n">time_on_source</span><span class="o">=</span><span class="n">time_on_source</span><span class="p">,</span>
                                            <span class="n">baseline_min</span><span class="o">=</span><span class="n">baseline_min</span><span class="p">,</span>
                                            <span class="n">baseline_max</span><span class="o">=</span><span class="n">baseline_max</span><span class="p">,</span>
                                            <span class="n">baseline_rms</span><span class="o">=</span><span class="n">baseline_rms</span><span class="p">,</span>
                                            <span class="n">merge2_version</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="s1">&#39;merge2_version&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">TableRow</span><span class="p">(</span><span class="n">ousstatus_entity_id</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span><span class="p">,</span>
                                            <span class="n">schedblock_id</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">schedblock_id</span><span class="p">,</span>
                                            <span class="n">schedblock_name</span><span class="o">=</span><span class="n">sb_name</span><span class="p">,</span>
                                            <span class="n">session</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                            <span class="n">execblock_id</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">execblock_id</span><span class="p">,</span>
                                            <span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                            <span class="n">acs_software_version</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">acs_software_version</span><span class="p">,</span>             <span class="c1"># None for VLA</span>
                                            <span class="n">acs_software_build_version</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">acs_software_build_version</span><span class="p">,</span> <span class="c1"># None for VLA</span>
                                            <span class="n">observing_modes</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span><span class="p">,</span>
                                            <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span>
                                            <span class="n">filesize</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span>
                                            <span class="n">receivers</span><span class="o">=</span><span class="n">receivers</span><span class="p">,</span>
                                            <span class="n">num_antennas</span><span class="o">=</span><span class="n">num_antennas</span><span class="p">,</span>
                                            <span class="n">beamsize_min</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                            <span class="n">beamsize_max</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                            <span class="n">time_start</span><span class="o">=</span><span class="n">time_start</span><span class="p">,</span>
                                            <span class="n">time_end</span><span class="o">=</span><span class="n">time_end</span><span class="p">,</span>
                                            <span class="n">time_on_source</span><span class="o">=</span><span class="n">time_on_source</span><span class="p">,</span>
                                            <span class="n">baseline_min</span><span class="o">=</span><span class="n">baseline_min</span><span class="p">,</span>
                                            <span class="n">baseline_max</span><span class="o">=</span><span class="n">baseline_max</span><span class="p">,</span>
                                            <span class="n">baseline_rms</span><span class="o">=</span><span class="n">baseline_rms</span><span class="p">)</span>

            <span class="n">ms_summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">execution_mode</span><span class="p">,</span> <span class="n">environment_tables</span> <span class="o">=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">get_environment_tables</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;casa_version&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="o">.</span><span class="n">casa_version_string</span><span class="p">,</span>
            <span class="s1">&#39;pipeline_revision&#39;</span><span class="p">:</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">revision</span><span class="p">,</span>
            <span class="s1">&#39;pipeline_doclink&#39;</span><span class="p">:</span> <span class="n">pipeline_doclink</span><span class="p">,</span>
            <span class="s1">&#39;obs_start&#39;</span><span class="p">:</span> <span class="n">obs_start_fmt</span><span class="p">,</span>
            <span class="s1">&#39;obs_end&#39;</span><span class="p">:</span> <span class="n">obs_end_fmt</span><span class="p">,</span>
            <span class="s1">&#39;iers_eop_2000_version&#39;</span><span class="p">:</span> <span class="n">iers_eop_2000_version</span><span class="p">,</span>
            <span class="s1">&#39;iers_eop_2000_last_date&#39;</span><span class="p">:</span> <span class="n">iers_eop_2000_last_date</span><span class="p">,</span>
            <span class="s1">&#39;iers_predict_version&#39;</span><span class="p">:</span> <span class="n">iers_predict_version</span><span class="p">,</span>
            <span class="s1">&#39;iers_predict_last_date&#39;</span><span class="p">:</span> <span class="n">iers_predict_last_date</span><span class="p">,</span>
            <span class="s1">&#39;iers_info&#39;</span><span class="p">:</span> <span class="n">iers_info</span><span class="p">,</span>
            <span class="s1">&#39;array_names&#39;</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">array_names</span><span class="p">),</span>
            <span class="s1">&#39;exec_start&#39;</span><span class="p">:</span> <span class="n">exec_start_fmt</span><span class="p">,</span>
            <span class="s1">&#39;exec_end&#39;</span><span class="p">:</span> <span class="n">exec_end_fmt</span><span class="p">,</span>
            <span class="s1">&#39;exec_duration&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">exec_duration</span><span class="p">),</span>
            <span class="s1">&#39;project_uids&#39;</span><span class="p">:</span> <span class="n">project_uids</span><span class="p">,</span>
            <span class="s1">&#39;schedblock_uids&#39;</span><span class="p">:</span> <span class="n">schedblock_uids</span><span class="p">,</span>
            <span class="s1">&#39;execblock_uids&#39;</span><span class="p">:</span> <span class="n">execblock_uids</span><span class="p">,</span>
            <span class="s1">&#39;number_of_execblocks&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">execblock_ids</span><span class="p">),</span>
            <span class="s1">&#39;ous_uid&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ous_entity_id</span><span class="p">,</span>
            <span class="s1">&#39;ousstatus_entity_id&#39;</span><span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ousstatus_entity_id</span><span class="p">,</span>
            <span class="s1">&#39;ppr_uid&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;observers&#39;</span><span class="p">:</span> <span class="n">observers</span><span class="p">,</span>
            <span class="s1">&#39;ms_summary_rows&#39;</span><span class="p">:</span> <span class="n">ms_summary_rows</span><span class="p">,</span>
            <span class="s1">&#39;environment_tables&#39;</span><span class="p">:</span> <span class="n">environment_tables</span><span class="p">,</span>
            <span class="s1">&#39;execution_mode&#39;</span><span class="p">:</span> <span class="n">execution_mode</span>
        <span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_environment_tables</span><span class="p">(</span><span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span>
        <span class="c1"># alias to make the following code more compact and easier to read</span>
        <span class="n">props</span> <span class="o">=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentProperty</span>

        <span class="n">node_environments</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">environment</span><span class="o">.</span><span class="n">Environment</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">cluster_details</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">)):</span>
            <span class="n">node_environments</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="n">data_rows</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">node_envs</span> <span class="ow">in</span> <span class="n">node_environments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">node_envs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># all hardware on a node has the same value so just take first</span>
            <span class="c1"># environment dict</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">node_envs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">mpi_server_envs</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node_envs</span> <span class="k">if</span> <span class="s1">&#39;MPI Server&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">role</span><span class="p">]</span>
            <span class="n">num_mpi_servers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mpi_server_envs</span><span class="p">)</span> <span class="k">if</span> <span class="n">mpi_server_envs</span> <span class="k">else</span> <span class="s1">&#39;N/A&#39;</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">NUM_MPI_SERVERS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">num_mpi_servers</span><span class="p">)</span>

            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CPU_TYPE</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cpu_type</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">LOGICAL_CPU_CORES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">logical_cpu_cores</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">PHYSICAL_CPU_CORES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">physical_cpu_cores</span><span class="p">)</span>

            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">RAM</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">ram</span><span class="p">,</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSizeUnits</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">SWAP</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">swap</span><span class="p">,</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSizeUnits</span><span class="o">.</span><span class="n">BYTES</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">decimal</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">:</span>
                <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">SWAP</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>

            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CGROUP_NUM_CPUS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cgroup_num_cpus</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CGROUP_CPU_BANDWIDTH</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cgroup_cpu_bandwidth</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CGROUP_CPU_WEIGHT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cgroup_cpu_weight</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CGROUP_MEM_LIMIT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">cgroup_mem_limit</span><span class="p">,</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSizeUnits</span><span class="o">.</span><span class="n">BYTES</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">decimal</span><span class="o">.</span><span class="n">InvalidOperation</span><span class="p">:</span>
                <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CGROUP_MEM_LIMIT</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span>

            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CASA_CORES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">casa_cores</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CASA_THREADS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">casa_threads</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">CASA_MEMORY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">FileSize</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">casa_memory</span><span class="p">,</span> <span class="n">measures</span><span class="o">.</span><span class="n">FileSizeUnits</span><span class="o">.</span><span class="n">BYTES</span><span class="p">)))</span>

            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">OS</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">host_distribution</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_FILES</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">ulimit_files</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_MEM</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">ulimit_mem</span><span class="p">)</span>
            <span class="n">data_rows</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_CPU</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">ulimit_cpu</span><span class="p">)</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Host information&quot;</span><span class="p">:</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentTable</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">OS</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">NUM_MPI_SERVERS</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_FILES</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_rows</span>
            <span class="p">),</span>
            <span class="s2">&quot;CPU resources and limits&quot;</span><span class="p">:</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentTable</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">CPU_TYPE</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">PHYSICAL_CPU_CORES</span><span class="p">,</span>
                      <span class="n">props</span><span class="o">.</span><span class="n">LOGICAL_CPU_CORES</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">CGROUP_NUM_CPUS</span><span class="p">,</span>
                      <span class="n">props</span><span class="o">.</span><span class="n">CGROUP_CPU_BANDWIDTH</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_CPU</span><span class="p">,</span>
                      <span class="n">props</span><span class="o">.</span><span class="n">CASA_CORES</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">CASA_THREADS</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_rows</span>
            <span class="p">),</span>
            <span class="s2">&quot;Available memory and limits&quot;</span><span class="p">:</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">EnvironmentTable</span><span class="p">(</span>
                <span class="n">ctx</span><span class="o">=</span><span class="n">ctx</span><span class="p">,</span>
                <span class="n">rows</span><span class="o">=</span><span class="p">[</span><span class="n">props</span><span class="o">.</span><span class="n">HOSTNAME</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">RAM</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">SWAP</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">CGROUP_MEM_LIMIT</span><span class="p">,</span>
                      <span class="n">props</span><span class="o">.</span><span class="n">ULIMIT_MEM</span><span class="p">,</span> <span class="n">props</span><span class="o">.</span><span class="n">CASA_MEMORY</span><span class="p">],</span>
                <span class="n">data</span><span class="o">=</span><span class="n">data_rows</span>
            <span class="p">)</span>
        <span class="p">}</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;Parallel&#39;</span> <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="s1">&#39;MPI Server&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">role</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">cluster_details</span><span class="p">()])</span> <span class="k">else</span> <span class="s1">&#39;Serial&#39;</span>

        <span class="k">return</span> <span class="n">mode</span><span class="p">,</span> <span class="n">tables</span></div>



<div class="viewcode-block" id="T1_2Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_2Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_2Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T1_2Renderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T1-2 Observation Summary renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t1-2.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t1-2.mako&#39;</span>

    <span class="c1"># named tuple holding values for each row in the main summary table</span>
    <span class="n">TableRow</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
                <span class="s1">&#39;Tablerow&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;ms href filesize &#39;</span> 
                <span class="s1">&#39;receivers &#39;</span>
                <span class="s1">&#39;num_antennas beamsize_min beamsize_max &#39;</span>
                <span class="s1">&#39;time_start time_end time_on_source &#39;</span>
                <span class="s1">&#39;baseline_min baseline_max baseline_rms&#39;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">ms_summary_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">get_mses_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;t2-1.html?ms=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

            <span class="n">num_antennas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">)</span>
            <span class="c1"># times should be passed as Python datetimes</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">time_start</span><span class="p">)</span>
            <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">time_end</span><span class="p">)</span>

            <span class="n">target_scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
            <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_source</span><span class="p">(</span><span class="n">target_scans</span><span class="p">)</span>
            <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="n">time_on_source</span><span class="p">)</span>

            <span class="n">baseline_min</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_min</span><span class="o">.</span><span class="n">length</span>
            <span class="n">baseline_max</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_max</span><span class="o">.</span><span class="n">length</span>

            <span class="n">baseline_rms</span> <span class="o">=</span> <span class="n">measures</span><span class="o">.</span><span class="n">Distance</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baselines_m</span><span class="p">))),</span>
                <span class="n">units</span><span class="o">=</span><span class="n">measures</span><span class="o">.</span><span class="n">DistanceUnits</span><span class="o">.</span><span class="n">METRE</span>
            <span class="p">)</span>

            <span class="n">science_spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">receivers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">))</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">T1_2Renderer</span><span class="o">.</span><span class="n">TableRow</span><span class="p">(</span><span class="n">ms</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                        <span class="n">href</span><span class="o">=</span><span class="n">href</span><span class="p">,</span>
                                        <span class="n">filesize</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">filesize</span><span class="p">,</span>
                                        <span class="n">receivers</span><span class="o">=</span><span class="n">receivers</span><span class="p">,</span>                           
                                        <span class="n">num_antennas</span><span class="o">=</span><span class="n">num_antennas</span><span class="p">,</span>
                                        <span class="n">beamsize_min</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                        <span class="n">beamsize_max</span><span class="o">=</span><span class="s1">&#39;TODO&#39;</span><span class="p">,</span>
                                        <span class="n">time_start</span><span class="o">=</span><span class="n">time_start</span><span class="p">,</span>
                                        <span class="n">time_end</span><span class="o">=</span><span class="n">time_end</span><span class="p">,</span>
                                        <span class="n">time_on_source</span><span class="o">=</span><span class="n">time_on_source</span><span class="p">,</span>
                                        <span class="n">baseline_min</span><span class="o">=</span><span class="n">baseline_min</span><span class="p">,</span>
                                        <span class="n">baseline_max</span><span class="o">=</span><span class="n">baseline_max</span><span class="p">,</span>
                                        <span class="n">baseline_rms</span><span class="o">=</span><span class="n">baseline_rms</span><span class="p">)</span>

            <span class="n">ms_summary_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms_summary_rows&#39;</span><span class="p">:</span> <span class="n">ms_summary_rows</span><span class="p">}</span></div>



<div class="viewcode-block" id="T1_3MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_3MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_3MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T1_3MRenderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T1-3M renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t1-3.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t1-3m.mako&#39;</span>

    <span class="n">MsgTableRow</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MsgTableRow&#39;</span><span class="p">,</span> <span class="s1">&#39;stage task type message target&#39;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">registry</span> <span class="o">=</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span>
        <span class="c1"># distribute results between topics</span>
        <span class="n">registry</span><span class="o">.</span><span class="n">assign_to_topics</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">tablerows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">flagtables</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">qa</span><span class="o">.</span><span class="n">representative</span>
            <span class="n">results_list</span> <span class="o">=</span> <span class="n">get_results_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

            <span class="n">error_msgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_logrecords</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
            <span class="n">tablerows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logrecords_to_tablerows</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">,</span> <span class="n">results_list</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">))</span>

            <span class="n">warning_msgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_logrecords</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
            <span class="n">tablerows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logrecords_to_tablerows</span><span class="p">(</span><span class="n">warning_msgs</span><span class="p">,</span> <span class="n">results_list</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">))</span>

        <span class="c1"># Update flag table (search from the last to the first task)</span>
        <span class="n">flag_update_tasks</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;applycal&#39;</span><span class="p">,</span> <span class="s1">&#39;hsd_blflag&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">task_description</span> <span class="o">=</span> <span class="n">get_task_description</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="n">update_flag_table</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">t</span> <span class="ow">in</span> <span class="n">task_description</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">flag_update_tasks</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">update_flag_table</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Updating flagging summary table by results in </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_description</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">resultitem</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                        <span class="n">vis</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">resultitem</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>
                        <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
                        <span class="n">flagtable</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">resultitem</span><span class="o">.</span><span class="n">flagsummary</span><span class="p">:</span>
                            <span class="c1"># Get the field intents, but only for those that</span>
                            <span class="c1"># the pipeline processes. This can be an empty</span>
                            <span class="c1"># list (PIPE-394: POINTING, WVR intents; PIPE-1806:</span>
                            <span class="c1"># DIFFGAIN* intents).</span>
                            <span class="n">intents_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">intents</span>
                                            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">intent</span><span class="o">=</span><span class="s1">&#39;BANDPASS,PHASE,AMPLITUDE,POLARIZATION,&#39;</span>
                                                                          <span class="s1">&#39;POLANGLE,POLLEAKAGE,CHECK,TARGET,&#39;</span>
                                                                          <span class="s1">&#39;DIFFGAINREF,DIFFGAINSRC&#39;</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">intents_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">intents</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">intents_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                            <span class="n">flagsummary</span> <span class="o">=</span> <span class="n">resultitem</span><span class="o">.</span><span class="n">flagsummary</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flagsummary</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">fieldtable</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flagsummary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">myname</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                                <span class="n">myspw</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span>
                                <span class="n">myant</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s1">&#39;antenna&#39;</span><span class="p">]</span>
                                <span class="c1"># TODO: review if this relies on order of keys.</span>
                                <span class="n">spwkey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">myspw</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

                                <span class="n">fieldtable</span><span class="p">[</span><span class="n">myname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">spwkey</span><span class="p">:</span> <span class="n">myant</span><span class="p">}</span>

                            <span class="n">flagtable</span><span class="p">[</span><span class="s1">&#39;Source name: &#39;</span><span class="o">+</span> <span class="n">field</span> <span class="o">+</span> <span class="s1">&#39;, Intents: &#39;</span> <span class="o">+</span> <span class="n">intents</span><span class="p">]</span> <span class="o">=</span> <span class="n">fieldtable</span>

                        <span class="n">flagtables</span><span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">]</span> <span class="o">=</span> <span class="n">flagtable</span>
                    <span class="k">break</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;No flag summary table available yet from applycal&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;registry&#39;</span><span class="p">:</span> <span class="n">registry</span><span class="p">,</span>
                <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
                <span class="s1">&#39;tablerows&#39;</span><span class="p">:</span> <span class="n">tablerows</span><span class="p">,</span>
                <span class="s1">&#39;flagtables&#39;</span><span class="p">:</span> <span class="n">flagtables</span><span class="p">}</span></div>



<div class="viewcode-block" id="T1_4MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T1_4MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T1_4MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T1_4MRenderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T1-4M renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t1-4.html&#39;</span>
    <span class="c1"># TODO get template at run-time</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t1-4m.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">qa</span><span class="o">.</span><span class="n">representative</span>

        <span class="c1">## Obtain time duration of tasks by the difference of start times successive tasks.</span>
        <span class="c1">## The end time of the last task is tentatively defined as the time of current time.</span>
        <span class="n">timestamps</span> <span class="o">=</span> <span class="p">[</span> <span class="n">r</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span> <span class="p">]</span>
        <span class="c1"># tentative task end time stamp for the last stage</span>
        <span class="n">timestamps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>
        <span class="n">task_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">)):</span>
            <span class="c1"># task execution duration</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">timestamps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># remove unnecessary precision for execution duration</span>
            <span class="n">task_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="o">.</span><span class="n">seconds</span><span class="p">))</span>

        <span class="c1"># copy PPR for weblog</span>
        <span class="n">pprfile</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="o">.</span><span class="n">ppr_file</span>
        <span class="k">if</span> <span class="n">pprfile</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pprfile</span><span class="p">):</span>
            <span class="n">dest_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pprfile</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pprfile</span><span class="p">,</span> <span class="n">dest_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;results&#39;</span>  <span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">,</span>
                <span class="s1">&#39;scores&#39;</span>   <span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
                <span class="s1">&#39;task_duration&#39;</span><span class="p">:</span> <span class="n">task_duration</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_1Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_1Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_1Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_1Renderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-4M renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-1.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-1.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">get_sessions</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;sessions&#39;</span> <span class="p">:</span> <span class="n">sessions</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_1DetailsRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_1DetailsRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_1DetailsRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_1DetailsRenderer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-1_details.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-1_details.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">ms_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ms_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ms_dir</span><span class="p">)</span>

        <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                            <span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">cls</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">write_listobs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">listfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> 
                                <span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                                <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                                <span class="s1">&#39;listobs.txt&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">listfile</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Writing listobs output to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">listfile</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">infrastructure</span><span class="o">.</span><span class="n">casa_tasks</span><span class="o">.</span><span class="n">listobs</span><span class="p">(</span><span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                     <span class="n">listfile</span><span class="o">=</span><span class="n">listfile</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">T2_1DetailsRenderer</span><span class="o">.</span><span class="n">write_listobs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">IntentVsTimeChart</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">IntentVsTimeChart</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">intent_vs_time</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">FieldVsTimeChart</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">FieldVsTimeChart</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="n">field_vs_time</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">inputs</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">SpwIdVsFreqChart</span><span class="o">.</span><span class="n">Inputs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">SpwIdVsFreqChart</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">spwid_vs_freq</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">science_spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">all_bands</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_all_spectral_windows</span><span class="p">()})</span>
        <span class="n">science_bands</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">science_spws</span><span class="p">})</span>

        <span class="n">science_sources</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">})</span>

        <span class="n">calibrators</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="n">source</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">source</span><span class="o">.</span><span class="n">intents</span><span class="p">})</span>

        <span class="n">baseline_min</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_min</span><span class="o">.</span><span class="n">length</span>
        <span class="n">baseline_max</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">baseline_max</span><span class="o">.</span><span class="n">length</span>

        <span class="n">num_antennas</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">)</span>
        <span class="n">num_baselines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_antennas</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_antennas</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">ant_diam_counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">diameter</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">])</span>
        <span class="n">ant_diam</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{:d}</span><span class="s2"> of </span><span class="si">{:d}</span><span class="s2"> m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_ant</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">diam</span><span class="p">))</span> <span class="k">for</span> <span class="n">diam</span><span class="p">,</span> <span class="n">n_ant</span> <span class="ow">in</span> <span class="n">ant_diam_counter</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>

        <span class="n">time_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
        <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>

        <span class="n">time_on_source</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_source</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span> 
        <span class="n">science_scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="s1">&#39;TARGET&#39;</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">intents</span><span class="p">]</span>
        <span class="n">is_single_dish_data</span> <span class="o">=</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scan_has_intent</span><span class="p">(</span><span class="n">science_scans</span><span class="p">,</span> <span class="s1">&#39;REFERENCE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_single_dish_data</span><span class="p">:</span>
            <span class="c1"># target scans have OFF-source integrations or Single Dish Data. Need to do harder way.</span>
            <span class="n">time_on_science</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_target_on_source</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">is_single_dish_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_on_science</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">total_time_on_source</span><span class="p">(</span><span class="n">science_scans</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">WeatherChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">weather_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">PWVChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">pwv_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">AzElChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">azel_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">ElVsTimeChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">el_vs_time_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="c1"># Get min, max elevation</span>
        <span class="n">observatory</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span>
        <span class="n">el_min</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">compute_az_el_for_ms</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="nb">min</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">el_max</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">compute_az_el_for_ms</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="nb">max</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="n">vla_basebands</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,</span> <span class="s1">&#39;NRO&#39;</span><span class="p">):</span>
            <span class="c1"># All VLA basebands</span>

            <span class="n">vla_basebands</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">banddict</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_vla_baseband_spws</span><span class="p">(</span><span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_select_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warning</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">banddict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Baseband name cannot be parsed and will not appear in the weblog.&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">band</span> <span class="ow">in</span> <span class="n">banddict</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">baseband</span> <span class="ow">in</span> <span class="n">banddict</span><span class="p">[</span><span class="n">band</span><span class="p">]:</span>
                    <span class="n">spws</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">minfreqs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">maxfreqs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">spwitem</span> <span class="ow">in</span> <span class="n">banddict</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">baseband</span><span class="p">]:</span>
                        <span class="c1"># TODO: review if this relies on order of keys.</span>
                        <span class="n">spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">([</span><span class="o">*</span><span class="n">spwitem</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">minfreqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwitem</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">spwitem</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">maxfreqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spwitem</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">spwitem</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">bbandminfreq</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minfreqs</span><span class="p">)</span>
                    <span class="n">bbandmaxfreq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxfreqs</span><span class="p">)</span>
                    <span class="n">vla_basebands</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">band</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="o">+</span><span class="n">baseband</span><span class="o">+</span><span class="s1">&#39;:  &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bbandminfreq</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; to &#39;</span> <span class="o">+</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="n">bbandmaxfreq</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;:   [&#39;</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;]   &#39;</span><span class="p">)</span>

            <span class="n">vla_basebands</span> <span class="o">=</span> <span class="s1">&#39;&lt;tr&gt;&lt;th&gt;VLA Bands: Basebands:  Freq range: [spws]&lt;/th&gt;&lt;td&gt;&#39;</span><span class="o">+</span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">vla_basebands</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span>

        <span class="k">if</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="c1"># Single dish specific </span>
            <span class="c1"># to get thumbnail for representative pointing plot</span>
            <span class="n">antenna</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field_strategy</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">calibration_strategy</span><span class="p">[</span><span class="s1">&#39;field_strategy&#39;</span><span class="p">]</span>
            <span class="c1"># TODO: review if this relies on order of keys.</span>
            <span class="n">target</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">field_strategy</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">reference</span> <span class="o">=</span> <span class="n">field_strategy</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;target field id </span><span class="si">%s</span><span class="s1"> / reference field id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">reference</span><span class="p">))</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">SingleDishPointingChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">pointing_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">antenna</span><span class="o">=</span><span class="n">antenna</span><span class="p">,</span> <span class="n">target_field_id</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                                      <span class="n">reference_field_id</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">target_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pointing_plot</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pcontext&#39;</span>        <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;ms&#39;</span>              <span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
            <span class="s1">&#39;science_sources&#39;</span> <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">science_sources</span><span class="p">),</span>
            <span class="s1">&#39;calibrators&#39;</span>     <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">calibrators</span><span class="p">),</span>
            <span class="s1">&#39;all_bands&#39;</span>       <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">all_bands</span><span class="p">),</span>
            <span class="s1">&#39;science_bands&#39;</span>   <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">science_bands</span><span class="p">),</span>
            <span class="s1">&#39;baseline_min&#39;</span>    <span class="p">:</span> <span class="n">baseline_min</span><span class="p">,</span>
            <span class="s1">&#39;baseline_max&#39;</span>    <span class="p">:</span> <span class="n">baseline_max</span><span class="p">,</span>
            <span class="s1">&#39;num_antennas&#39;</span>    <span class="p">:</span> <span class="n">num_antennas</span><span class="p">,</span>
            <span class="s1">&#39;ant_diameters&#39;</span>   <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="n">ant_diam</span><span class="p">,</span> <span class="n">quotes</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="s1">&#39;num_baselines&#39;</span>   <span class="p">:</span> <span class="n">num_baselines</span><span class="p">,</span>
            <span class="s1">&#39;time_start&#39;</span>      <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
            <span class="s1">&#39;time_end&#39;</span>        <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">time_end</span><span class="p">),</span>
            <span class="s1">&#39;time_on_source&#39;</span>  <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="n">time_on_source</span><span class="p">),</span>
            <span class="s1">&#39;time_on_science&#39;</span> <span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="n">time_on_science</span><span class="p">),</span>
            <span class="s1">&#39;intent_vs_time&#39;</span>  <span class="p">:</span> <span class="n">intent_vs_time</span><span class="p">,</span>
            <span class="s1">&#39;field_vs_time&#39;</span>   <span class="p">:</span> <span class="n">field_vs_time</span><span class="p">,</span>
            <span class="s1">&#39;spwid_vs_freq&#39;</span>   <span class="p">:</span> <span class="n">spwid_vs_freq</span><span class="p">,</span>
            <span class="s1">&#39;dirname&#39;</span>         <span class="p">:</span> <span class="n">dirname</span><span class="p">,</span>
            <span class="s1">&#39;weather_plot&#39;</span>    <span class="p">:</span> <span class="n">weather_plot</span><span class="p">,</span>
            <span class="s1">&#39;pwv_plot&#39;</span>        <span class="p">:</span> <span class="n">pwv_plot</span><span class="p">,</span>
            <span class="s1">&#39;azel_plot&#39;</span>       <span class="p">:</span> <span class="n">azel_plot</span><span class="p">,</span>
            <span class="s1">&#39;el_vs_time_plot&#39;</span> <span class="p">:</span> <span class="n">el_vs_time_plot</span><span class="p">,</span>
            <span class="s1">&#39;is_singledish&#39;</span>   <span class="p">:</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
            <span class="s1">&#39;pointing_plot&#39;</span>   <span class="p">:</span> <span class="n">pointing_plot</span><span class="p">,</span>
            <span class="s1">&#39;el_min&#39;</span>          <span class="p">:</span> <span class="n">el_min</span><span class="p">,</span>
            <span class="s1">&#39;el_max&#39;</span>          <span class="p">:</span> <span class="n">el_max</span><span class="p">,</span>
            <span class="s1">&#39;vla_basebands&#39;</span>   <span class="p">:</span> <span class="n">vla_basebands</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">get_sessions</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">mses</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                <span class="c1"># now that the details pages are written per MS rather than having</span>
                <span class="c1"># tabs for each MS, we don&#39;t need to write them each time as</span>
                <span class="c1"># importdata will not affect their content.</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">TEMPLATE_LOOKUP</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
                    <span class="n">display_context</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                    <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">display_context</span><span class="p">))</span></div>



<div class="viewcode-block" id="MetadataRendererBase">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.MetadataRendererBase.html#pipeline.infrastructure.renderer.htmlrenderer.MetadataRendererBase">[docs]</a>
<span class="k">class</span> <span class="nc">MetadataRendererBase</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">rerender</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># TODO: only rerender when a new ImportData result is queued</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">DEBUG_CLASSES</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Always rerendering </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>



<div class="viewcode-block" id="T2_2_XRendererBase">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_XRendererBase.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_XRendererBase">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_XRendererBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base renderer for T2-2-X series of pages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">ms_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ms_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">ms_dir</span><span class="p">)</span>

        <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                            <span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                            <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span>
                            <span class="bp">cls</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="c1"># now that the details pages are written per MS rather than having</span>
            <span class="c1"># tabs for each MS, we don&#39;t need to write them each time as</span>
            <span class="c1"># importdata will not affect their content.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
                    <span class="n">template</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">TEMPLATE_LOOKUP</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
                    <span class="n">display_context</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
                    <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">display_context</span><span class="p">))</span></div>



<div class="viewcode-block" id="T2_2_1Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_1Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_1Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_1Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-1 renderer - spatial setup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-1.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-1.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">mosaics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">num_pointings</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> 
                                 <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">source_id</span> <span class="o">==</span> <span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">num_pointings</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">MosaicChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
                <span class="n">mosaics</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()))</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span>       <span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;mosaics&#39;</span>  <span class="p">:</span> <span class="n">mosaics</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_2_2Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_2Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_2Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_2Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-2 renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-2.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-2.mako&#39;</span>

<div class="viewcode-block" id="T2_2_2Renderer.get_display_context">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_2Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_2Renderer.get_display_context">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine whether to show the Online Spec. Avg. column on the Spectral Setup Details page.&quot;&quot;&quot;</span>

        <span class="n">ShowColumn</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;ShowColumn&#39;</span><span class="p">,</span> <span class="s1">&#39;science_windows all_windows&#39;</span><span class="p">)</span>
        <span class="n">show_online_spec_avg_col</span> <span class="o">=</span> <span class="n">ShowColumn</span><span class="p">(</span><span class="n">science_windows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_windows</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">sdm_num_bin</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()]:</span>
            <span class="c1"># PIPE-1572: when None exists in spw.sdm_num_bin, the MS is likely imported by older</span>
            <span class="c1"># CASA/importasdm versions (ver&lt;=5.6.0). We won&#39;t modifiy the initialzed setup, which does</span>
            <span class="c1"># not display the Online Spec. Avg. column.</span>
            <span class="k">if</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
                <span class="c1"># PIPE-584: Always show the column for ALMA. If it&#39;s cycle 2 data, display a &#39;?&#39; in the table.</span>
                <span class="n">show_online_spec_avg_col</span> <span class="o">=</span> <span class="n">ShowColumn</span><span class="p">(</span><span class="n">science_windows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_windows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="c1"># PIPE-584: For VLA, only display the column if sdm_num_bin &gt; 1 is present for at least one</span>
                <span class="c1"># entry. It is possible for this to differ between the &quot;Science Windows&quot; and the &quot;All Windows&quot; tabs.</span>
                <span class="n">sdm_num_bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">()</span> <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">sdm_num_bin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sdm_num_bins</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">science_sdm_num_bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span>
                        <span class="n">science_windows_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">sdm_num_bin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">science_sdm_num_bins</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">show_online_spec_avg_col</span> <span class="o">=</span> <span class="n">ShowColumn</span><span class="p">(</span><span class="n">science_windows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">all_windows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">show_online_spec_avg_col</span> <span class="o">=</span> <span class="n">ShowColumn</span><span class="p">(</span><span class="n">science_windows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">all_windows</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span><span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;show_online_spec_avg_col&#39;</span><span class="p">:</span> <span class="n">show_online_spec_avg_col</span>
                <span class="p">}</span></div>
</div>



<div class="viewcode-block" id="T2_2_3Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_3Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_3Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_3Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-3 renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-3.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-3.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">project_summary</span><span class="o">.</span><span class="n">telescope</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NRO&#39;</span><span class="p">,):</span>
            <span class="c1"># antenna plots are useless for Nobeyama</span>
            <span class="n">plot_ants</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plot_ants_plog</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">plot_uv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create regular antenna positions plot.</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">PlotAntsChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">plot_ants</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

            <span class="c1"># Create polar-log antenna positions plot.</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">PlotAntsChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">polarlog</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plot_ants_plog</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

            <span class="c1"># Create U-V plot.</span>
            <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">contains_single_dish</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
                <span class="n">plot_uv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">UVChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s2">&quot;Initial &quot;</span><span class="p">)</span>
                <span class="n">plot_uv</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                               <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;plot_ants&#39;</span><span class="p">:</span> <span class="n">plot_ants</span><span class="p">,</span>
                <span class="s1">&#39;plot_ants_plog&#39;</span><span class="p">:</span> <span class="n">plot_ants_plog</span><span class="p">,</span>
                <span class="s1">&#39;plot_uv&#39;</span><span class="p">:</span> <span class="n">plot_uv</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span><span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;dirname&#39;</span><span class="p">:</span> <span class="n">dirname</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_2_4Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_4Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_4Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_4Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-4 renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-4.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-4.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">AzElChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">azel_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">SunTrackChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">suntrack_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">ElVsTimeChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">el_vs_time_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="c1"># Create U-V plot, if necessary.</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">contains_single_dish</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="n">plot_uv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">UVChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">title_prefix</span><span class="o">=</span><span class="s2">&quot;Initial &quot;</span><span class="p">)</span>
            <span class="n">plot_uv</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                               <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span><span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;azel_plot&#39;</span><span class="p">:</span> <span class="n">azel_plot</span><span class="p">,</span>
                <span class="s1">&#39;suntrack_plot&#39;</span><span class="p">:</span> <span class="n">suntrack_plot</span><span class="p">,</span>
                <span class="s1">&#39;el_vs_time_plot&#39;</span><span class="p">:</span> <span class="n">el_vs_time_plot</span><span class="p">,</span>
                <span class="s1">&#39;plot_uv&#39;</span><span class="p">:</span> <span class="n">plot_uv</span><span class="p">,</span>
                <span class="s1">&#39;dirname&#39;</span><span class="p">:</span> <span class="n">dirname</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_2_5Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_5Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_5Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_5Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-5 renderer - weather page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-5.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-5.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">WeatherChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="n">weather_plot</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                               <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span>     <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span>           <span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;weather_plot&#39;</span> <span class="p">:</span> <span class="n">weather_plot</span><span class="p">,</span>
                <span class="s1">&#39;dirname&#39;</span>      <span class="p">:</span> <span class="n">dirname</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_2_6Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_6Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_6Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_6Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-6 renderer - scans page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-6.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-6.mako&#39;</span>

    <span class="n">TableRow</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
        <span class="s1">&#39;TableRow&#39;</span><span class="p">,</span> 
        <span class="s1">&#39;id time_start time_end duration intents fields spws&#39;</span>
    <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">tablerows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span><span class="p">:</span>
            <span class="n">scan_id</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span>
            <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span>
            <span class="n">time_start</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">epoch_start</span><span class="p">)</span>
            <span class="n">epoch_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="n">time_end</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_datetime</span><span class="p">(</span><span class="n">epoch_end</span><span class="p">)</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">format_timedelta</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">time_on_source</span><span class="p">)</span>
            <span class="n">intents</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">commafy</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">]))</span>

            <span class="n">spw_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">spws</span><span class="p">])</span>
            <span class="n">spws</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)</span> <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">spw_ids</span><span class="p">])</span>

            <span class="n">row</span> <span class="o">=</span> <span class="n">T2_2_6Renderer</span><span class="o">.</span><span class="n">TableRow</span><span class="p">(</span>
                <span class="nb">id</span><span class="o">=</span><span class="n">scan_id</span><span class="p">,</span>
                <span class="n">time_start</span><span class="o">=</span><span class="n">time_start</span><span class="p">,</span>
                <span class="n">time_end</span><span class="o">=</span><span class="n">time_end</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="n">duration</span><span class="p">,</span>
                <span class="n">intents</span><span class="o">=</span><span class="n">intents</span><span class="p">,</span>
                <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span>
                <span class="n">spws</span><span class="o">=</span><span class="n">spws</span>
            <span class="p">)</span>

            <span class="n">tablerows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span>     <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span>           <span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;tablerows&#39;</span>    <span class="p">:</span> <span class="n">tablerows</span><span class="p">}</span></div>



<div class="viewcode-block" id="T2_2_7Renderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_7Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_7Renderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_2_7Renderer</span><span class="p">(</span><span class="n">T2_2_XRendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-2-7 renderer (single dish specific)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-2-7.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-2-7.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="nb">super</span><span class="p">(</span><span class="n">T2_2_7Renderer</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<div class="viewcode-block" id="T2_2_7Renderer.get_display_context">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_2_7Renderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_2_7Renderer.get_display_context">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="n">Context</span><span class="p">,</span> <span class="n">ms</span><span class="p">:</span> <span class="n">MeasurementSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get display context and plots points</span>

<span class="sd">        Args:</span>
<span class="sd">            context (Context): pipeline context state object</span>
<span class="sd">            ms (MeasurementSet): an object of Measurement Set</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[str, Any]: display context</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_pointings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">whole_pointings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">offset_pointings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">pointing</span><span class="o">.</span><span class="n">SingleDishPointingChart</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_singledish_ms</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">antenna</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">reference</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">calibration_strategy</span><span class="p">[</span><span class="s1">&#39;field_strategy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;target field id </span><span class="si">%s</span><span class="s1"> / reference field id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">reference</span><span class="p">))</span>
                    <span class="c1"># pointing pattern without OFF-SOURCE intents</span>
                    <span class="n">plotres</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">antenna</span><span class="o">=</span><span class="n">antenna</span><span class="p">,</span> <span class="n">target_field_id</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                                        <span class="n">reference_field_id</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">target_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># for missing antenna, spw, field combinations</span>
                    <span class="k">if</span> <span class="n">plotres</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">continue</span>
                    <span class="n">target_pointings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotres</span><span class="p">)</span>

                    <span class="c1"># pointing pattern with OFF-SOURCE intents</span>
                    <span class="n">plotres</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">antenna</span><span class="o">=</span><span class="n">antenna</span><span class="p">,</span> <span class="n">target_field_id</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
                                        <span class="n">reference_field_id</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span> <span class="n">target_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">plotres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">whole_pointings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotres</span><span class="p">)</span>

                    <span class="c1"># if the target is ephemeris, offset pointing pattern should also be plotted</span>
                    <span class="n">target_field</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
                    <span class="n">source_name</span> <span class="o">=</span> <span class="n">target_field</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">target_field</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">is_eph_obj</span> <span class="ow">or</span> <span class="n">target_field</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">is_known_eph_obj</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;generating offset pointing plot for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_name</span><span class="p">))</span>
                        <span class="n">plotres</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">antenna</span><span class="o">=</span><span class="n">antenna</span><span class="p">,</span> <span class="n">target_field_id</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">reference_field_id</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
                                            <span class="n">target_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ofs_coord</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">plotres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adding offset pointing plot for </span><span class="si">{}</span><span class="s1"> (antenna </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_name</span><span class="p">,</span> <span class="n">antenna</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="n">offset_pointings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotres</span><span class="p">)</span>

        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;session</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                               <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span>        <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;ms&#39;</span>              <span class="p">:</span> <span class="n">ms</span><span class="p">,</span>
                <span class="s1">&#39;target_pointing&#39;</span> <span class="p">:</span> <span class="n">target_pointings</span><span class="p">,</span>
                <span class="s1">&#39;whole_pointing&#39;</span>  <span class="p">:</span> <span class="n">whole_pointings</span><span class="p">,</span>
                <span class="s1">&#39;offset_pointing&#39;</span> <span class="p">:</span> <span class="n">offset_pointings</span><span class="p">,</span>
                <span class="s1">&#39;dirname&#39;</span>         <span class="p">:</span> <span class="n">dirname</span><span class="p">}</span></div>
</div>



<div class="viewcode-block" id="T2_3_XMBaseRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_XMBaseRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_XMBaseRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_XMBaseRenderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;overrideme&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;overrideme&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">topic</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_topic</span><span class="p">()</span>

        <span class="n">scores</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">qa</span><span class="o">.</span><span class="n">representative</span>

        <span class="n">tablerows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">list_of_results_lists</span> <span class="ow">in</span> <span class="n">topic</span><span class="o">.</span><span class="n">results_by_type</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">list_of_results_lists</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># CAS-11344: present results ordered by stage number</span>
            <span class="k">for</span> <span class="n">results_list</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_of_results_lists</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;stage_number&#39;</span><span class="p">)):</span>
                <span class="n">error_msgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_logrecords</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
                <span class="n">tablerows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logrecords_to_tablerows</span><span class="p">(</span><span class="n">error_msgs</span><span class="p">,</span> <span class="n">results_list</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">))</span>

                <span class="n">warning_msgs</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_logrecords</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
                <span class="n">tablerows</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logrecords_to_tablerows</span><span class="p">(</span><span class="n">warning_msgs</span><span class="p">,</span> <span class="n">results_list</span><span class="p">,</span> <span class="s1">&#39;Warning&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;pcontext&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">,</span>
            <span class="s1">&#39;scores&#39;</span><span class="p">:</span> <span class="n">scores</span><span class="p">,</span>
            <span class="s1">&#39;tablerows&#39;</span><span class="p">:</span> <span class="n">tablerows</span><span class="p">,</span>
            <span class="s1">&#39;topic&#39;</span><span class="p">:</span> <span class="n">topic</span>
        <span class="p">}</span></div>



<div class="viewcode-block" id="T2_3_1MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_1MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_1MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_1MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-1M, the data set topic.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-1m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-1m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_dataset_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_3_2MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_2MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_2MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_2MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-2M: the QA calibration section.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-2m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-2m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_calibration_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_3_3MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_3MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_3MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_3MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-3M: the QA flagging section.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-3m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-3m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_flagging_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_3_4MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_4MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_4MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_4MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-4M: the QA line finding section.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-4m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-4m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_linefinding_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_3_5MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_5MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_5MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_5MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-5M: the imaging topic</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-5m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-5m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_imaging_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_3_6MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_3_6MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_3_6MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_3_6MRenderer</span><span class="p">(</span><span class="n">T2_3_XMBaseRenderer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renderer for T2-3-6M: the miscellaneous topic</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the filename to which output will be directed</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-3-6m.html&#39;</span>
    <span class="c1"># the template file for this renderer</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-3-6m.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_topic</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">qaadapter</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_miscellaneous_topic</span><span class="p">()</span>        </div>



<div class="viewcode-block" id="T2_4MRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_4MRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_4MRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_4MRenderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    T2-4M renderer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-4m.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-4m.mako&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                <span class="s1">&#39;results&#39;</span>  <span class="p">:</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">}</span></div>


<span class="c1">#     @classmethod</span>
<span class="c1">#     def get_file(cls, context, root):</span>
<span class="c1">#         path = cls.get_path(context, root)</span>
<span class="c1"># </span>
<span class="c1">#         # to avoid any subsequent file not found errors, create the directory</span>
<span class="c1">#         # if a hard copy is requested and the directory is missing</span>
<span class="c1">#         session_dir = os.path.dirname(path)</span>
<span class="c1">#         if not os.path.exists(session_dir):</span>
<span class="c1">#             os.makedirs(session_dir)</span>
<span class="c1">#         </span>
<span class="c1">#         # create a file object that writes to a file</span>
<span class="c1">#         file_obj = open(path, &#39;w&#39;)</span>
<span class="c1">#         </span>
<span class="c1">#         # return the file object wrapped in a context manager, so we can use</span>
<span class="c1">#         # it with the autoclosing &#39;with fileobj as f:&#39; construct</span>
<span class="c1">#         return contextlib.closing(file_obj)</span>
<span class="c1"># </span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def get_path(cls, context, root):</span>
<span class="c1">#         path = os.path.join(context.report_dir, root)</span>
<span class="c1">#         return os.path.join(path, cls.output_file)</span>
<span class="c1"># </span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def render(cls, context):</span>
<span class="c1">#         # dict that will map session ID to session results</span>
<span class="c1">#         collated = collections.defaultdict(list)</span>
<span class="c1">#         for result in context.results:</span>
<span class="c1">#             # we only handle lists of results, so wrap single objects in a</span>
<span class="c1">#             # list if necessary</span>
<span class="c1">#             if not isinstance(result, collections.abc.Iterable):</span>
<span class="c1">#                 result = wrap_in_resultslist(result)</span>
<span class="c1">#             </span>
<span class="c1">#             # split the results in the list into streams, divided by session</span>
<span class="c1">#             d = group_by_root(context, result)</span>
<span class="c1">#             for root, session_results in d.items():</span>
<span class="c1">#                 collated[root].extend(session_results)</span>
<span class="c1"># </span>
<span class="c1">#         for root, session_results in collated.items():</span>
<span class="c1">#             cls.render_root(context, root, session_results)</span>
<span class="c1"># </span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def render_root(cls, context, root, results):                </span>
<span class="c1">#         template = weblog.TEMPLATE_LOOKUP.get_template(cls.template)</span>
<span class="c1"># </span>
<span class="c1">#         mako_context = {&#39;pcontext&#39; : context,</span>
<span class="c1">#                         &#39;root&#39;     : root,</span>
<span class="c1">#                         &#39;results&#39;  : results}</span>
<span class="c1">#         </span>
<span class="c1">#         with cls.get_file(context, root) as fileobj:</span>
<span class="c1">#             fileobj.write(template.render(**mako_context))</span>


<div class="viewcode-block" id="T2_4MDetailsDefaultRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsDefaultRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsDefaultRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_4MDetailsDefaultRenderer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s1">&#39;t2-4m_details-generic.mako&#39;</span><span class="p">,</span>
                 <span class="n">always_rerender</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">always_rerender</span> <span class="o">=</span> <span class="n">always_rerender</span>

    <span class="k">def</span> <span class="nf">get_display_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">mako_context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                        <span class="s1">&#39;result&#39;</span>   <span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                        <span class="s1">&#39;casalog_url&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_log_url</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">),</span>
                        <span class="s1">&#39;taskhelp&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_help</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">),</span>
                        <span class="s1">&#39;dirname&#39;</span>  <span class="p">:</span> <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_mako_context</span><span class="p">(</span><span class="n">mako_context</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mako_context</span>

    <span class="k">def</span> <span class="nf">update_mako_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mako_context</span><span class="p">,</span> <span class="n">pipeline_context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;No-op update_mako_context for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">display_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_display_context</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="c1"># TODO remove fallback access once all templates are converted </span>
        <span class="n">uri</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;uri&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
        <span class="n">template</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">TEMPLATE_LOOKUP</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">display_context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_log_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the URL of the stage log relative to the report directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stagelog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span>
                                     <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">,</span>
                                     <span class="s1">&#39;casapy.log&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stagelog_path</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">stagelog_path</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)</span>        

    <span class="k">def</span> <span class="nf">_get_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># get hif-prefixed taskname from the result from which we can</span>
            <span class="c1"># retrieve the XML documentation, otherwise fall back to the</span>
            <span class="c1"># Python class documentation              </span>
            <span class="n">taskname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="s1">&#39;taskname&#39;</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task</span><span class="p">)</span>

            <span class="n">obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pydoc</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">taskname</span><span class="p">,</span> <span class="n">forceload</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">page</span> <span class="o">=</span> <span class="n">pydoc</span><span class="o">.</span><span class="n">render_doc</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;pre&gt;</span><span class="si">%s</span><span class="s1">&lt;/pre&gt;&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\x08.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>



<span class="c1"># ----------------------------------------------------------------------</span>

<div class="viewcode-block" id="T2_4MDetailsContainerRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsContainerRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsContainerRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_4MDetailsContainerRenderer</span><span class="p">(</span><span class="n">RendererBase</span><span class="p">):</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-4m_details-container.html&#39;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;t2-4m_details-container.mako&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span>
        <span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage_dir</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">urls</span><span class="p">):</span>
        <span class="c1"># give the implementing class a chance to bypass rendering. This is</span>
        <span class="c1"># useful when the page has not changed, eg. MS description pages when</span>
        <span class="c1"># no subsequent ImportData has been performed</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="n">rerender</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">mako_context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;pcontext&#39;</span> <span class="p">:</span> <span class="n">context</span><span class="p">,</span>
                        <span class="s1">&#39;container_urls&#39;</span><span class="p">:</span> <span class="n">urls</span><span class="p">,</span>
                        <span class="s1">&#39;active_ms&#39;</span> <span class="p">:</span> <span class="s1">&#39;N/A&#39;</span><span class="p">}</span>

        <span class="n">template</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">TEMPLATE_LOOKUP</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">template</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">mako_context</span><span class="p">))</span></div>



<div class="viewcode-block" id="T2_4MDetailsRenderer">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsRenderer.html#pipeline.infrastructure.renderer.htmlrenderer.T2_4MDetailsRenderer">[docs]</a>
<span class="k">class</span> <span class="nc">T2_4MDetailsRenderer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># the filename component of the output file. While this is the same for</span>
    <span class="c1"># all results, the directory is stage-specific, so there&#39;s no risk of</span>
    <span class="c1"># collisions  </span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;t2-4m_details.html&#39;</span>

    <span class="c1"># the default renderer should the task:renderer mapping not specify a</span>
    <span class="c1"># specialised renderer</span>
    <span class="n">_default_renderer</span> <span class="o">=</span> <span class="n">T2_4MDetailsDefaultRenderer</span><span class="p">()</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the file object for this renderer.</span>

<span class="sd">    :param context: the pipeline Context</span>
<span class="sd">    :type context: :class:`~pipeline.infrastructure.launcher.Context`</span>
<span class="sd">    :param result: the task results object to render</span>
<span class="sd">    :type result: :class:`~pipeline.infrastructure.api.Result`</span>
<span class="sd">    :param root: filename component to insert</span>
<span class="sd">    :type root: string</span>
<span class="sd">    :rtype: a file object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
        <span class="c1"># construct the relative filename, eg. &#39;stageX/t2-4m_details.html&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>

        <span class="c1"># to avoid any subsequent file not found errors, create the directory</span>
        <span class="c1"># if a hard copy is requested and the directory is missing</span>
        <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

        <span class="c1"># create a file object that writes to a file if a hard copy is </span>
        <span class="c1"># requested, otherwise return a file object that flushes to stdout</span>
        <span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c1"># return the file object wrapped in a context manager, so we can use</span>
        <span class="c1"># it with the autoclosing &#39;with fileobj as f:&#39; construct</span>
        <span class="k">return</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the template output path.</span>
<span class="sd">    </span>
<span class="sd">    :param context: the pipeline Context</span>
<span class="sd">    :type context: :class:`~pipeline.infrastructure.launcher.Context`</span>
<span class="sd">    :param result: the task results object to render</span>
<span class="sd">    :type result: :class:`~pipeline.infrastructure.api.Result`</span>
<span class="sd">    :param root: the optional directory component to insert before the stage</span>
<span class="sd">    :type root: string</span>
<span class="sd">    :rtype: string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="c1"># HTML output will be written to the directory &#39;stageX&#39; </span>
        <span class="n">stage</span> <span class="o">=</span> <span class="s1">&#39;stage</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span>
        <span class="n">stage_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span>

        <span class="c1"># construct the relative filename, eg. &#39;stageX/t2-4m_details.html&#39;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">stage_dir</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render the detailed task-centric view of each Results in the given</span>
<span class="sd">    context.</span>
<span class="sd">    </span>
<span class="sd">    This renderer creates detailed, T2_4M output for each Results. Each</span>
<span class="sd">    Results in the context is passed to a specialised renderer, which </span>
<span class="sd">    generates customised output and plots for the Result in question.</span>
<span class="sd">    </span>
<span class="sd">    :param context: the pipeline Context</span>
<span class="sd">    :type context: :class:`~pipeline.infrastructure.launcher.Context`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># for each result accepted and stored in the context..</span>
        <span class="k">for</span> <span class="n">task_result</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
            <span class="c1"># we only handle lists of results, so wrap single objects in a</span>
            <span class="c1"># list if necessary</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_result</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Iterable</span><span class="p">):</span>
                <span class="n">task_result</span> <span class="o">=</span> <span class="n">wrap_in_resultslist</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>

            <span class="c1"># find the renderer appropriate to the task..</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTaskResults</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">task_result</span><span class="p">):</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">basetask</span><span class="o">.</span><span class="n">FailedTask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">renderer</span> <span class="o">=</span> <span class="n">weblog</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">get_renderer</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No renderer was registered for task </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
                <span class="n">renderer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_default_renderer</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%s</span><span class="s1"> to render </span><span class="si">%s</span><span class="s1"> result&#39;</span><span class="p">,</span>
                      <span class="n">renderer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

            <span class="n">container_urls</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">weblog</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">render_ungrouped</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">render_result</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">)</span>

                <span class="n">ms_weblog_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">ms_weblog_path</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)</span>
                <span class="n">container_urls</span><span class="p">[</span><span class="s1">&#39;combined session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;all&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">task_result</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="c1"># create new container</span>
                <span class="n">container</span> <span class="o">=</span> <span class="n">T2_4MDetailsContainerRenderer</span>
                <span class="n">container</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">,</span> <span class="n">container_urls</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">weblog</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">render_by_session</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
                <span class="n">session_grouped</span> <span class="o">=</span> <span class="n">group_into_sessions</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">session_results</span> <span class="ow">in</span> <span class="n">session_grouped</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">container_urls</span><span class="p">[</span><span class="n">session_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">ms_grouped</span> <span class="o">=</span> <span class="n">group_into_measurement_sets</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">session_results</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">ms_id</span><span class="p">,</span> <span class="n">ms_result</span> <span class="ow">in</span> <span class="n">ms_grouped</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="bp">cls</span><span class="o">.</span><span class="n">render_result</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ms_result</span><span class="p">,</span> <span class="n">ms_id</span><span class="p">)</span>

                        <span class="n">ms_weblog_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">ms_result</span><span class="p">,</span> <span class="n">ms_id</span><span class="p">)</span>
                        <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">ms_weblog_path</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)</span>
                        <span class="n">container_urls</span><span class="p">[</span><span class="n">session_id</span><span class="p">][</span><span class="n">ms_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">relpath</span><span class="p">,</span> <span class="n">ms_result</span><span class="p">)</span>

                <span class="c1"># create new container</span>
                <span class="n">container</span> <span class="o">=</span> <span class="n">T2_4MDetailsContainerRenderer</span>
                <span class="n">container</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_result</span><span class="p">,</span> <span class="n">container_urls</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Don</span><span class="se">\&#39;</span><span class="s1">t know how to group </span><span class="si">%s</span><span class="s1"> renderer&#39;</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">render_result</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>                
        <span class="c1"># details pages do not need to be updated once written unless the</span>
        <span class="c1"># renderer specifies that an update is required</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Path for </span><span class="si">%s</span><span class="s1"> is </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">force_rerender</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="s1">&#39;always_rerender&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">debug_cls</span> <span class="o">=</span> <span class="n">renderer</span><span class="o">.</span><span class="vm">__class__</span> <span class="ow">in</span> <span class="n">DEBUG_CLASSES</span>

        <span class="n">rerender_stages</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                           <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WEBLOG_RERENDER_STAGES&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                           <span class="k">if</span> <span class="n">s</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">force_rerender</span> <span class="o">=</span> <span class="n">force_rerender</span> <span class="ow">or</span> <span class="n">debug_cls</span> <span class="ow">or</span> <span class="n">result</span><span class="o">.</span><span class="n">stage_number</span> <span class="ow">in</span> <span class="n">rerender_stages</span>

        <span class="k">if</span> <span class="n">force_rerender</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Forcing rerendering for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_rerender</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># .. get the file object to which we&#39;ll render the result</span>
        <span class="k">with</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_file</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span> <span class="k">as</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="c1"># .. and write the renderer&#39;s interpretation of this result to</span>
            <span class="c1"># the file object  </span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%s</span><span class="s1"> output to </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                          <span class="n">path</span><span class="p">)</span>

                <span class="n">event</span> <span class="o">=</span> <span class="n">WebLogStageRenderingStartedEvent</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">)</span>
                <span class="n">eventbus</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">renderer</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>

                <span class="n">event</span> <span class="o">=</span> <span class="n">WebLogStageRenderingCompleteEvent</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">)</span>
                <span class="n">eventbus</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Template generation failed for </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">mako</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">text_error_template</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>
                <span class="n">fileobj</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">mako</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">html_error_template</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">))</span>

                <span class="n">event</span> <span class="o">=</span> <span class="n">WebLogStageRenderingAbnormalExitEvent</span><span class="p">(</span><span class="n">context_name</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">stage_number</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">stage_number</span><span class="p">)</span>
                <span class="n">eventbus</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">event</span><span class="p">)</span></div>



<div class="viewcode-block" id="wrap_in_resultslist">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.wrap_in_resultslist.html#pipeline.infrastructure.renderer.htmlrenderer.wrap_in_resultslist">[docs]</a>
<span class="k">def</span> <span class="nf">wrap_in_resultslist</span><span class="p">(</span><span class="n">task_result</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">()</span>
    <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_result</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">task_result</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="n">l</span><span class="o">.</span><span class="n">stage_number</span> <span class="o">=</span> <span class="n">task_result</span><span class="o">.</span><span class="n">stage_number</span>
    <span class="n">l</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">task_result</span><span class="o">.</span><span class="n">inputs</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_result</span><span class="p">,</span> <span class="s1">&#39;taskname&#39;</span><span class="p">):</span>
        <span class="n">l</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="n">task_result</span><span class="o">.</span><span class="n">taskname</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_result</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">):</span>
        <span class="n">l</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">task_result</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="c1"># the newly-created ResultsList wrapper is missing a QA pool. However,</span>
    <span class="c1"># as there is only ever one task added to the list we can safely assume</span>
    <span class="c1"># that the pool for the wrapper should equal that of the child. The same</span>
    <span class="c1"># holds for logrecords. The task name is required as the plot level </span>
    <span class="c1"># toggles work off the CASA task name.</span>
    <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;qa&#39;</span><span class="p">,</span> <span class="s1">&#39;pipeline_casa_task&#39;</span><span class="p">,</span> <span class="s1">&#39;logrecords&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_result</span><span class="p">,</span> <span class="s1">&#39;qa&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task_result</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">return</span> <span class="n">l</span></div>



<div class="viewcode-block" id="group_into_sessions">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.group_into_sessions.html#pipeline.infrastructure.renderer.htmlrenderer.group_into_sessions">[docs]</a>
<span class="k">def</span> <span class="nf">group_into_sessions</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return results grouped into lists by session. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">session</span> 
                   <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_session</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="c1"># return the session inputs argument if present, otherwise find</span>
        <span class="c1"># which session the measurement set is in</span>
        <span class="k">if</span> <span class="s1">&#39;session&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span>

        <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">session_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="s1">&#39;Shared&#39;</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">results_by_session</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">task_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_session</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">results_by_session</span><span class="p">,</span> <span class="n">get_session</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">timestamps</span>
        <span class="n">l</span><span class="o">.</span><span class="n">stage_number</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">stage_number</span>
        <span class="n">l</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">inputs</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_results</span><span class="p">,</span> <span class="s1">&#39;taskname&#39;</span><span class="p">):</span>
            <span class="n">l</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">taskname</span>
        <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="group_into_measurement_sets">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.group_into_measurement_sets.html#pipeline.infrastructure.renderer.htmlrenderer.group_into_measurement_sets">[docs]</a>
<span class="k">def</span> <span class="nf">group_into_measurement_sets</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_results</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_vis</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ImportDataResults&#39;</span><span class="p">,</span> <span class="s1">&#39;SDImportDataResults&#39;</span><span class="p">,</span> <span class="s1">&#39;NROImportDataResults&#39;</span><span class="p">):</span>
            <span class="c1"># in splitting by vis, there&#39;s only one MS in the mses array</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">mses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>

    <span class="n">vises</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_vis</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">task_results</span><span class="p">]</span>
    <span class="n">mses</span> <span class="o">=</span> <span class="p">[</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="k">for</span> <span class="n">vis</span> <span class="ow">in</span> <span class="n">vises</span><span class="p">]</span>
    <span class="n">ms_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">]</span>
    <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">mses</span><span class="p">]</span>

    <span class="c1"># sort MSes within session by execution time</span>
    <span class="n">decorated</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">ms_names</span><span class="p">,</span> <span class="n">task_results</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span> <span class="ow">in</span> <span class="n">decorated</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">wrap_in_resultslist</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="sort_by_time">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.sort_by_time.html#pipeline.infrastructure.renderer.htmlrenderer.sort_by_time">[docs]</a>
<span class="k">def</span> <span class="nf">sort_by_time</span><span class="p">(</span><span class="n">mses</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return measurement sets sorted by time order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">mses</span><span class="p">,</span> 
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_epoch_as_datetime</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">))</span>     </div>



<div class="viewcode-block" id="get_rootdir">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_rootdir.html#pipeline.infrastructure.renderer.htmlrenderer.get_rootdir">[docs]</a>
<span class="k">def</span> <span class="nf">get_rootdir</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ImportDataResults&#39;</span><span class="p">,</span> <span class="s1">&#39;SDImportDataResults&#39;</span><span class="p">,</span> <span class="s1">&#39;NROImportDataResults&#39;</span><span class="p">):</span>
            <span class="c1"># in splitting by vis, there&#39;s only one MS in the mses array</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">.</span><span class="n">mses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">basename</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">inputs</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;shared&#39;</span></div>



<div class="viewcode-block" id="group_by_root">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.group_by_root.html#pipeline.infrastructure.renderer.htmlrenderer.group_by_root">[docs]</a>
<span class="k">def</span> <span class="nf">group_by_root</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">task_results</span><span class="p">):</span>
    <span class="n">results_by_root</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">task_results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">get_rootdir</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">results_by_root</span><span class="p">,</span> <span class="n">get_rootdir</span><span class="p">):</span>        
        <span class="n">l</span> <span class="o">=</span> <span class="n">basetask</span><span class="o">.</span><span class="n">ResultsList</span><span class="p">()</span>
        <span class="n">l</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="n">l</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">timestamps</span>
        <span class="n">l</span><span class="o">.</span><span class="n">stage_number</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">stage_number</span>
        <span class="n">l</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">inputs</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_results</span><span class="p">,</span> <span class="s1">&#39;taskname&#39;</span><span class="p">):</span>
            <span class="n">l</span><span class="o">.</span><span class="n">taskname</span> <span class="o">=</span> <span class="n">task_results</span><span class="o">.</span><span class="n">taskname</span>
        <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span>

    <span class="k">return</span> <span class="n">d</span></div>



<div class="viewcode-block" id="WebLogGenerator">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.WebLogGenerator.html#pipeline.infrastructure.renderer.htmlrenderer.WebLogGenerator">[docs]</a>
<span class="k">class</span> <span class="nc">WebLogGenerator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">renderers</span> <span class="o">=</span> <span class="p">[</span><span class="n">T1_1Renderer</span><span class="p">,</span>         <span class="c1"># OUS splash page</span>
                 <span class="n">T1_2Renderer</span><span class="p">,</span>         <span class="c1"># observation summary</span>
                 <span class="n">T1_3MRenderer</span><span class="p">,</span>        <span class="c1"># by topic page</span>
                 <span class="n">T2_1Renderer</span><span class="p">,</span>         <span class="c1"># session tree</span>
                 <span class="n">T2_1DetailsRenderer</span><span class="p">,</span>  <span class="c1"># session details</span>
                 <span class="n">T2_2_1Renderer</span><span class="p">,</span>       <span class="c1"># spatial setup</span>
                 <span class="n">T2_2_2Renderer</span><span class="p">,</span>       <span class="c1"># spectral setup</span>
                 <span class="n">T2_2_3Renderer</span><span class="p">,</span>       <span class="c1"># antenna setup</span>
                 <span class="n">T2_2_4Renderer</span><span class="p">,</span>       <span class="c1"># sky setup</span>
<span class="c1">#                 T2_2_5Renderer,       # weather</span>
                 <span class="n">T2_2_6Renderer</span><span class="p">,</span>       <span class="c1"># scans</span>
                 <span class="n">T2_2_7Renderer</span><span class="p">,</span>       <span class="c1"># telescope pointing (single dish specific)</span>
                 <span class="n">T2_3_1MRenderer</span><span class="p">,</span>      <span class="c1"># data set topic</span>
                 <span class="n">T2_3_2MRenderer</span><span class="p">,</span>      <span class="c1"># calibration topic</span>
                 <span class="n">T2_3_3MRenderer</span><span class="p">,</span>      <span class="c1"># flagging topic</span>
        <span class="c1"># disable unused line finding topic for July 2014 release</span>
        <span class="c1"># T2_3_4MRenderer,             # line finding topic</span>
                 <span class="n">T2_3_5MRenderer</span><span class="p">,</span>      <span class="c1"># imaging topic</span>
                 <span class="n">T2_3_6MRenderer</span><span class="p">,</span>      <span class="c1"># miscellaneous topic</span>
                 <span class="n">T2_4MRenderer</span><span class="p">,</span>        <span class="c1"># task tree</span>
                 <span class="n">T2_4MDetailsRenderer</span><span class="p">,</span> <span class="c1"># task details</span>
        <span class="c1"># some summary renderers are placed last for access to scores</span>
                 <span class="n">T1_4MRenderer</span><span class="p">]</span>        <span class="c1"># task summary</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copy_resources</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">)</span>

        <span class="c1"># shutil.copytree complains if the output directory exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">outdir</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1"># copy all uncompressed non-python resources to output directory</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="n">resources</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">outdir</span>
        <span class="n">ignore_fn</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">ignore_patterns</span><span class="p">(</span><span class="s1">&#39;*.zip&#39;</span><span class="p">,</span> <span class="s1">&#39;*.py&#39;</span><span class="p">,</span> <span class="s1">&#39;*.pyc&#39;</span><span class="p">,</span> <span class="s1">&#39;CVS*&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;.svn&#39;</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> 
                        <span class="n">dst</span><span class="p">,</span> 
                        <span class="n">symlinks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                        <span class="n">ignore</span><span class="o">=</span><span class="n">ignore_fn</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="c1"># copy CSS, javascript etc. to weblog directory</span>
        <span class="n">WebLogGenerator</span><span class="o">.</span><span class="n">copy_resources</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># We could seriously optimise the rendering process by only unpickling</span>
        <span class="c1"># those objects that we need to render.  </span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">todo</span><span class="p">(</span><span class="s1">&#39;Add results argument to renderer interfaces!&#39;</span><span class="p">)</span>
        <span class="n">proxies</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># unpickle the results objects ready for rendering</span>
            <span class="n">context</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">proxy</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="k">for</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">renderer</span> <span class="ow">in</span> <span class="n">WebLogGenerator</span><span class="o">.</span><span class="n">renderers</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> rendering...&#39;</span> <span class="o">%</span> <span class="n">renderer</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
                    <span class="n">renderer</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Error generating weblog: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># create symlink to t1-1.html</span>
            <span class="n">link_relsrc</span> <span class="o">=</span> <span class="n">T1_1Renderer</span><span class="o">.</span><span class="n">output_file</span>
            <span class="n">link_abssrc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="n">link_relsrc</span><span class="p">)</span>
            <span class="n">link_dst</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;index.html&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">link_abssrc</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">link_dst</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">link_relsrc</span><span class="p">,</span> <span class="n">link_dst</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">context</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">proxies</span></div>



<div class="viewcode-block" id="LogCopier">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.LogCopier.html#pipeline.infrastructure.renderer.htmlrenderer.LogCopier">[docs]</a>
<span class="k">class</span> <span class="nc">LogCopier</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    LogCopier copies and handles the CASA logs so that they may be referenced</span>
<span class="sd">    by the pipeline web logs. </span>

<span class="sd">    Capturing the CASA log gives us a few problems:</span>
<span class="sd">    The previous log is renamed upon starting a new session. To be reliably</span>
<span class="sd">    referenced from the web log, we must give it an immutable name and copy it</span>
<span class="sd">    to a safe location within the web log directory.</span>

<span class="sd">    The user may want to view the web log at any time during a pipeline</span>
<span class="sd">    session. To avoid broken links to the CASA log, the log should be copied</span>
<span class="sd">    across to the web log location at the end of each task.</span>

<span class="sd">    Pipeline sessions may be interrupted and restored, resulting in multiple</span>
<span class="sd">    CASA logs for such sessions. These logs must be consolidated into one file</span>
<span class="sd">    alongside any previous log information.</span>

<span class="sd">    Adding HTML tags such as &#39;&lt;pre&gt;&#39; and HTML anchors causes the CASA log</span>
<span class="sd">    reader to render such entries as empty entries at the bottom of the log.</span>
<span class="sd">    The result is that you must scroll up to find the last log entry. To</span>
<span class="sd">    prevent this, we need to output anchors as CASA log comments, possibly</span>
<span class="sd">    timestamps, and then use javascript to navigate to the log location.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Thanks to the unique timestamps in the CASA log, the implementation</span>
    <span class="c1"># turns out to be quite simple. Is a class overkill?</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">output_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">,</span> <span class="s1">&#39;casapy.log&#39;</span><span class="p">)</span>

        <span class="n">existing_entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">weblog</span><span class="p">:</span>
                <span class="n">existing_entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">weblog</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>

        <span class="c1"># read existing log, appending any non-duplicate entries to our casapy</span>
        <span class="c1"># web log. This is Python 2.6 so we can&#39;t define the context managers</span>
        <span class="c1"># on the same line</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">weblog</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">casa_tools</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">logfile</span><span class="p">(),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">casalog</span><span class="p">:</span>
                <span class="n">to_append</span> <span class="o">=</span> <span class="p">[</span><span class="n">entry</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">casalog</span> 
                             <span class="k">if</span> <span class="n">entry</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_entries</span><span class="p">]</span>
            <span class="n">weblog</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">to_append</span><span class="p">)</span></div>


<span class="c1">#     @staticmethod    </span>
<span class="c1">#     def write_stage_logs(context):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Take the CASA log snippets attached to each result and write them to</span>
<span class="c1">#         the appropriate weblog directory. The log snippet is deleted from the</span>
<span class="c1">#         result after a successful write to keep the pickle size down. </span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         for result in context.results:</span>
<span class="c1">#             if not hasattr(result, &#39;casalog&#39;):</span>
<span class="c1">#                 continue</span>
<span class="c1"># </span>
<span class="c1">#             stage_dir = os.path.join(context.report_dir,</span>
<span class="c1">#                                      &#39;stage%s&#39; % result.stage_number)</span>
<span class="c1">#             if not os.path.exists(stage_dir):                </span>
<span class="c1">#                 os.makedirs(stage_dir)</span>
<span class="c1"># </span>
<span class="c1">#             stagelog_entries = result.casalog</span>
<span class="c1">#             start = result.timestamps.start</span>
<span class="c1">#             end = result.timestamps.end</span>
<span class="c1"># </span>
<span class="c1">#             stagelog_path = os.path.join(stage_dir, &#39;casapy.log&#39;)</span>
<span class="c1">#             with open(stagelog_path, &#39;w&#39;) as stagelog:</span>
<span class="c1">#                 LOG.debug(&#39;Writing CASA log entries for stage %s (%s -&gt; %s)&#39; %</span>
<span class="c1">#                           (result.stage_number, start, end))                          </span>
<span class="c1">#                 stagelog.write(stagelog_entries)</span>
<span class="c1">#                 </span>
<span class="c1">#             # having written the log entries, the CASA log entries have no </span>
<span class="c1">#             # further use. Remove them to keep the size of the pickle small</span>
<span class="c1">#             delattr(result, &#39;casalog&#39;)</span>
<span class="c1">#</span>
<span class="c1">#    @staticmethod    </span>
<span class="c1">#    def write_stage_logs(context):</span>
<span class="c1">#        casalog = os.path.join(context.report_dir, &#39;casapy.log&#39;)</span>
<span class="c1">#</span>
<span class="c1">#        for result in context.results:</span>
<span class="c1">#            stage_dir = os.path.join(context.report_dir,</span>
<span class="c1">#                                     &#39;stage%s&#39; % result.stage_number)</span>
<span class="c1">#            stagelog_path = os.path.join(stage_dir, &#39;casapy.log&#39;)</span>
<span class="c1">#            if os.path.exists(stagelog_path):</span>
<span class="c1">#                LOG.trace(&#39;CASA log exists for stage %s, continuing..&#39; </span>
<span class="c1">#                          % result.stage_number)</span>
<span class="c1">##                continue</span>
<span class="c1">#</span>
<span class="c1">#            if not os.path.exists(stage_dir):                </span>
<span class="c1">#                os.makedirs(stage_dir)</span>
<span class="c1">#</span>
<span class="c1">#            # CASA log timestamps have seconds resolution, whereas our task</span>
<span class="c1">#            # timestamps have microsecond resolution. Cast down to seconds </span>
<span class="c1">#            # resolution to make a comparison, taking care to leave the </span>
<span class="c1">#            # original timestamp unaltered</span>
<span class="c1">#            start = result.timestamps.start.replace(microsecond=0)</span>
<span class="c1">#            end = result.timestamps.end.replace(microsecond=0)</span>
<span class="c1">#            end += datetime.timedelta(seconds=1)</span>
<span class="c1">#            </span>
<span class="c1">#            # get the hif_XXX command from the task attribute if possible,</span>
<span class="c1">#            # otherwise fall back to the Python class name accessible at</span>
<span class="c1">#            # taskname</span>
<span class="c1">#            task = result.taskname</span>
<span class="c1">#             </span>
<span class="c1">#            stagelog_entries = LogCopier._extract(casalog, start, end, task)</span>
<span class="c1">#            with open(stagelog_path, &#39;w&#39;) as stagelog:</span>
<span class="c1">#                LOG.debug(&#39;Writing CASA log entries for stage %s (%s -&gt; %s)&#39; %</span>
<span class="c1">#                          (result.stage_number, start, end))                          </span>
<span class="c1">#                stagelog.writelines(stagelog_entries)</span>
<span class="c1">#</span>
<span class="c1">#    @staticmethod</span>
<span class="c1">#    def _extract(filename, start, end, task=None):</span>
<span class="c1">#        with open(filename, &#39;r&#39;) as logfile:</span>
<span class="c1">#            rows = logfile.readlines()</span>
<span class="c1">#</span>
<span class="c1">#        # find the indices of the log entries recorded just after and just </span>
<span class="c1">#        # before the end of task execution. We do this so that our subsequent</span>
<span class="c1">#        # search can begin these times, giving a more optimal search</span>
<span class="c1">#        pattern = re.compile(&#39;^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}&#39;)</span>
<span class="c1">#        timestamps = [pattern.match(r).group(0) for r in rows]</span>
<span class="c1">#        datetimes = [datetime.datetime.strptime(t, &#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="c1">#                     for t in timestamps]</span>
<span class="c1">#        within_timestamps = [n for n, elem in enumerate(datetimes) </span>
<span class="c1">#                             if elem &gt; start and elem &lt; end]            </span>
<span class="c1">#        start_idx, end_idx = within_timestamps[0], within_timestamps[-1]</span>
<span class="c1">#</span>
<span class="c1">#        # Task executions are bookended by statements log entries like this:</span>
<span class="c1">#        #</span>
<span class="c1">#        # 2013-02-15 13:55:47 INFO    hif_importdata::::casa+ ##########################################</span>
<span class="c1">#        #</span>
<span class="c1">#        # This regex matches this pattern, and therefore the start and end</span>
<span class="c1">#        # sections of the CASA log for this task </span>
<span class="c1">#        pattern = re.compile(&#39;^.*?%s::::casa\+\t\#{42}$&#39; % task)</span>
<span class="c1">#</span>
<span class="c1">#        # Rewinding from the starting timestamp, find the index of the task</span>
<span class="c1">#        # start log entry</span>
<span class="c1">#        for idx in range(within_timestamps[0], 0, -1):</span>
<span class="c1">#            if pattern.match(rows[idx]):</span>
<span class="c1">#                start_idx = idx</span>
<span class="c1">#                break</span>
<span class="c1">#</span>
<span class="c1">#        # looking forward from the end timestamp, find the index of the task</span>
<span class="c1">#        # end log entry</span>
<span class="c1">#        for idx in range(within_timestamps[-1], len(rows)-1):</span>
<span class="c1">#            if pattern.match(rows[idx]):</span>
<span class="c1">#                end_idx = min(idx+1, len(rows))</span>
<span class="c1">#                break</span>
<span class="c1">#</span>
<span class="c1">#        return rows[start_idx:end_idx]</span>


<span class="c1"># adding classes to this tuple always rerenders their content, bypassing the</span>
<span class="c1"># cache or &#39;existing file&#39; checks. This is useful for developing and debugging</span>
<span class="c1"># as you can just call WebLogGenerator.render(context) </span>
<span class="n">DEBUG_CLASSES</span> <span class="o">=</span> <span class="p">[]</span>


<div class="viewcode-block" id="get_mses_by_time">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_mses_by_time.html#pipeline.infrastructure.renderer.htmlrenderer.get_mses_by_time">[docs]</a>
<span class="k">def</span> <span class="nf">get_mses_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">measurement_sets</span><span class="p">,</span>
                  <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_results_by_time">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_results_by_time.html#pipeline.infrastructure.renderer.htmlrenderer.get_results_by_time">[docs]</a>
<span class="k">def</span> <span class="nf">get_results_by_time</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">resultslist</span><span class="p">):</span>
    <span class="c1"># as this is a ResultsList with important properties attached, results</span>
    <span class="c1"># should be sorted in place.</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">resultslist</span><span class="p">,</span> <span class="s1">&#39;sort&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">resultslist</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># sort the list of results by the MS start time</span>
                <span class="n">resultslist</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">get_ms_start_time_for_result</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Could not time sort results for stage </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">resultslist</span><span class="o">.</span><span class="n">stage_number</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resultslist</span></div>



<div class="viewcode-block" id="get_ms_start_time_for_result">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_ms_start_time_for_result.html#pipeline.infrastructure.renderer.htmlrenderer.get_ms_start_time_for_result">[docs]</a>
<span class="k">def</span> <span class="nf">get_ms_start_time_for_result</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
    <span class="c1"># single dish tasks do not attach Inputs to their component results, so</span>
    <span class="c1"># there&#39;s no reference or sort the results by.</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vis&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>
    <span class="k">return</span> <span class="n">get_ms_attr_for_result</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">ms</span><span class="p">:</span> <span class="n">ms</span><span class="o">.</span><span class="n">start_time</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_ms_attr_for_result">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.get_ms_attr_for_result.html#pipeline.infrastructure.renderer.htmlrenderer.get_ms_attr_for_result">[docs]</a>
<span class="k">def</span> <span class="nf">get_ms_attr_for_result</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">accessor</span><span class="p">):</span>
    <span class="n">ms_basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">ms_basename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">accessor</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span></div>



<div class="viewcode-block" id="compute_az_el_to_field">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.compute_az_el_to_field.html#pipeline.infrastructure.renderer.htmlrenderer.compute_az_el_to_field">[docs]</a>
<span class="k">def</span> <span class="nf">compute_az_el_to_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">observatory</span><span class="p">):</span>
    <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>

    <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
    <span class="n">me</span><span class="o">.</span><span class="n">doframe</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">observatory</span><span class="p">(</span><span class="n">observatory</span><span class="p">))</span>
    <span class="n">myazel</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">measure</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">mdirection</span><span class="p">,</span> <span class="s1">&#39;AZELGEO&#39;</span><span class="p">)</span>
    <span class="n">myaz</span> <span class="o">=</span> <span class="n">myazel</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">myel</span> <span class="o">=</span> <span class="n">myazel</span><span class="p">[</span><span class="s1">&#39;m1&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">myaz</span> <span class="o">=</span> <span class="p">(</span><span class="n">myaz</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">%</span> <span class="mi">360</span>
    <span class="n">myel</span> <span class="o">*=</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">myaz</span><span class="p">,</span> <span class="n">myel</span><span class="p">]</span></div>



<div class="viewcode-block" id="compute_az_el_for_ms">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.compute_az_el_for_ms.html#pipeline.infrastructure.renderer.htmlrenderer.compute_az_el_for_ms">[docs]</a>
<span class="k">def</span> <span class="nf">compute_az_el_for_ms</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">observatory</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="n">cal_scans</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">scan_intent</span><span class="o">=</span><span class="s1">&#39;POINTING,SIDEBAND,ATMOSPHERE&#39;</span><span class="p">)</span>
    <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cal_scans</span><span class="p">]</span>

    <span class="n">az</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">el</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scans</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">scan</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">az0</span><span class="p">,</span> <span class="n">el0</span> <span class="o">=</span> <span class="n">compute_az_el_to_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="n">observatory</span><span class="p">)</span>
            <span class="n">az1</span><span class="p">,</span> <span class="n">el1</span> <span class="o">=</span> <span class="n">compute_az_el_to_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">scan</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span> <span class="n">observatory</span><span class="p">)</span>
            <span class="n">az</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">([</span><span class="n">az0</span><span class="p">,</span> <span class="n">az1</span><span class="p">]))</span>
            <span class="n">el</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">([</span><span class="n">el0</span><span class="p">,</span> <span class="n">el1</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">az</span><span class="p">),</span> <span class="n">func</span><span class="p">(</span><span class="n">el</span><span class="p">)</span></div>



<div class="viewcode-block" id="cmp">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.cmp.html#pipeline.infrastructure.renderer.htmlrenderer.cmp">[docs]</a>
<span class="k">def</span> <span class="nf">cmp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span></div>



<span class="c1"># The four methods below were previously duplicated as class methods on</span>
<span class="c1"># T1_3Renderer and T2_3_XMBaseRenderer. I&#39;ve factored this out into a common</span>
<span class="c1"># function for now so at least the implementation is shared, but it is ripe</span>
<span class="c1"># for further refactoring. The functions are:</span>
<span class="c1">#</span>
<span class="c1">#   filter_qascores</span>
<span class="c1">#   create_tablerow</span>
<span class="c1">#   qascores_to_tablerow</span>
<span class="c1">#   logrecords_to_tablerows</span>
<span class="c1">#</span>
<div class="viewcode-block" id="filter_qascores">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.filter_qascores.html#pipeline.infrastructure.renderer.htmlrenderer.filter_qascores">[docs]</a>
<span class="k">def</span> <span class="nf">filter_qascores</span><span class="p">(</span><span class="n">results_list</span><span class="p">,</span> <span class="n">lo</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">hi</span><span class="p">:</span><span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]:</span>
    <span class="n">all_scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">]</span> <span class="o">=</span> <span class="n">results_list</span><span class="o">.</span><span class="n">qa</span><span class="o">.</span><span class="n">pool</span>
    <span class="c1"># suppress scores not intended for the weblog, taking care not to suppress</span>
    <span class="c1"># legacy scores with a default message destination (=UNSET) so that old</span>
    <span class="c1"># tasks continue to render as before</span>
    <span class="n">weblog_scores</span> <span class="o">=</span> <span class="n">pipelineqa</span><span class="o">.</span><span class="n">scores_with_location</span><span class="p">(</span>
        <span class="n">all_scores</span><span class="p">,</span> <span class="p">[</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">BANNER</span><span class="p">,</span> <span class="n">pipelineqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">ACCORDION</span><span class="p">,</span> <span class="n">pipelineqa</span><span class="o">.</span><span class="n">WebLogLocation</span><span class="o">.</span><span class="n">UNSET</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">with_score</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">weblog_scores</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">score</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">with_score</span> <span class="k">if</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">score</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">]</span></div>



<span class="c1"># struct used to summarise task warnings and errors in a table</span>
<span class="n">MsgTableRow</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;MsgTableRow&#39;</span><span class="p">,</span> <span class="s1">&#39;stage task type message target&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="create_tablerow">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.create_tablerow.html#pipeline.infrastructure.renderer.htmlrenderer.create_tablerow">[docs]</a>
<span class="k">def</span> <span class="nf">create_tablerow</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">msgtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MsgTableRow</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a table entry struct from a web log message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">MsgTableRow</span><span class="p">(</span><span class="n">stage</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">stage_number</span><span class="p">,</span>
                       <span class="n">task</span><span class="o">=</span><span class="n">get_task_name</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                       <span class="nb">type</span><span class="o">=</span><span class="n">msgtype</span><span class="p">,</span>
                       <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                       <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span></div>



<div class="viewcode-block" id="qascores_to_tablerows">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.qascores_to_tablerows.html#pipeline.infrastructure.renderer.htmlrenderer.qascores_to_tablerows">[docs]</a>
<span class="k">def</span> <span class="nf">qascores_to_tablerows</span><span class="p">(</span><span class="n">qascores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">pipelineqa</span><span class="o">.</span><span class="n">QAScore</span><span class="p">],</span>
                          <span class="n">results</span><span class="p">,</span>
                          <span class="n">msgtype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MsgTableRow</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of QAScores to a list of table entries, ready for</span>
<span class="sd">    insertion into a Mako template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="n">qascore</span><span class="p">):</span>
        <span class="n">target_mses</span> <span class="o">=</span> <span class="n">qascore</span><span class="o">.</span><span class="n">applies_to</span><span class="o">.</span><span class="n">vis</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_mses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">target_mses</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&amp;ms=</span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&amp;ms=&#39;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">create_tablerow</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">qascore</span><span class="o">.</span><span class="n">longmsg</span><span class="p">,</span> <span class="n">msgtype</span><span class="p">,</span> <span class="n">get_target</span><span class="p">(</span><span class="n">qascore</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">qascore</span> <span class="ow">in</span> <span class="n">qascores</span><span class="p">]</span></div>



<div class="viewcode-block" id="logrecords_to_tablerows">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.renderer.htmlrenderer.logrecords_to_tablerows.html#pipeline.infrastructure.renderer.htmlrenderer.logrecords_to_tablerows">[docs]</a>
<span class="k">def</span> <span class="nf">logrecords_to_tablerows</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">msgtype</span><span class="o">=</span><span class="s1">&#39;ERROR&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">MsgTableRow</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a list of LogRecords to a list of table entries, ready for</span>
<span class="sd">    insertion into a Mako template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="n">logrecord</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vis</span> <span class="o">=</span> <span class="n">logrecord</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="s1">&#39;&amp;ms=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">vis</span> <span class="k">if</span> <span class="n">vis</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">create_tablerow</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">record</span><span class="o">.</span><span class="n">msg</span><span class="p">,</span> <span class="n">msgtype</span><span class="p">,</span><span class="n">get_target</span><span class="p">(</span><span class="n">record</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>