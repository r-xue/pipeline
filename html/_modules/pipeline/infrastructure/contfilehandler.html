

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.infrastructure.contfilehandler &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=30144f19" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
          <li class="breadcrumb-item"><a href="../infrastructure.html">pipeline.infrastructure</a></li>
      <li class="breadcrumb-item active">pipeline.infrastructure.contfilehandler</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.infrastructure.contfilehandler</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Class to handle continuum frequency range files.</span>

<span class="sd">The text files contain ranges per source and spw using CASA syntax.</span>
<span class="sd">The keyword &quot;NONE&quot; can be written in case of non-detection of a continuum</span>
<span class="sd">frequency range.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">utils</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="ContFileHandler">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.contfilehandler.ContFileHandler.html#pipeline.infrastructure.contfilehandler.ContFileHandler">[docs]</a>
<span class="k">class</span> <span class="nc">ContFileHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">warn_nonexist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;([\d.]*)(~)([\d.]*)(\D*)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">warn_nonexist</span><span class="o">=</span><span class="n">warn_nonexist</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warn_nonexist</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">cont_ranges</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cont_region_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">cont_region_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">warn_nonexist</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not read file </span><span class="si">%s</span><span class="s1">. Using empty selection.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cont_region_data</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SpectralWindow:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPW&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPW&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Flags&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">item</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALLCONT&#39;</span><span class="p">))):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Field:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Field:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field_name</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SPW&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;SPW&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;SpectralWindow:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">spw_items</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
                        <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="n">spw_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">spw_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;spw</span><span class="si">{</span><span class="n">spw_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">spw_items</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                        <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="n">spw_items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">spw_name</span> <span class="o">=</span> <span class="n">spw_items</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;spwname&#39;</span><span class="p">:</span> <span class="n">spw_name</span><span class="p">,</span> <span class="s1">&#39;flags&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[]}</span>
                <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Flags:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">flags</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cont_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">cont_region</span> <span class="ow">in</span> <span class="n">cont_regions</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">unit</span> <span class="o">=</span> <span class="n">cont_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                            <span class="n">refer</span> <span class="o">=</span> <span class="s1">&#39;TOPO&#39;</span>
                        <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="n">unit</span><span class="p">,</span> <span class="n">refer</span> <span class="o">=</span> <span class="n">cont_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">fLow</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cont_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">unit</span><span class="p">),</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">fHigh</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cont_region</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">unit</span><span class="p">),</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                        <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;range&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">fLow</span><span class="p">,</span> <span class="n">fHigh</span><span class="p">),</span> <span class="s1">&#39;refer&#39;</span><span class="p">:</span> <span class="n">refer</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Could not read cont file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">e</span>

        <span class="k">for</span> <span class="n">fkey</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">skey</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fkey</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fkey</span><span class="p">][</span><span class="n">skey</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[]:</span>
                    <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">fkey</span><span class="p">][</span><span class="n">skey</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NONE&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">cont_ranges</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cont_ranges</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">cont_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cont_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cont_ranges</span> <span class="o">!=</span> <span class="p">{}:</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Field: </span><span class="si">%s</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
                    <span class="k">for</span> <span class="n">virt_spw_id</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SPW</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">virt_spw_id</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;SpectralWindow: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">virt_spw_id</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;spwname&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flags: </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">])</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">([],</span> <span class="p">[</span><span class="s1">&#39;NONE&#39;</span><span class="p">]):</span>
                            <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;NONE</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;ALL</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]:</span>
                                <span class="k">if</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;NONE&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                    <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">freq_range</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])))</span>
                                    <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                                                                    <span class="n">freq_range</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">]))</span>
                        <span class="n">fd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ContFileHandler.get_merged_selection">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.contfilehandler.ContFileHandler.html#pipeline.infrastructure.contfilehandler.ContFileHandler.get_merged_selection">[docs]</a>
    <span class="k">def</span> <span class="nf">get_merged_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cont_ranges</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inputs:</span>

<span class="sd">        field_name: field name</span>
<span class="sd">        spw_def: spw ID (digits) or spw name</span>
<span class="sd">        cont_ranges: Optional user supplied continuum ranges lookup dictionary</span>

<span class="sd">        Returns:</span>
<span class="sd">        merged continuum selection: string</span>
<span class="sd">        all continuum flag: boolean</span>
<span class="sd">        low bandwidth flag: boolean</span>
<span class="sd">        low spread flag: boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="n">spw_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">spw_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spw_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">spw_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cont_ranges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cont_ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span>

        <span class="n">all_continuum</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">low_bandwidth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">low_spread</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
            <span class="c1"># Internally the lookup dictionary still relies on virtual spw IDs.</span>
            <span class="c1"># But with PIPE-2128 we introduced writing spw names to cont.dat.</span>
            <span class="c1"># If the spw name is given, it is preferred for the lookup.</span>
            <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cont_dat_virt_spw_id</span><span class="p">(</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">virt_spw_id</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">([</span><span class="s1">&#39;ALL&#39;</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="s1">&#39;NONE&#39;</span><span class="p">]):</span>
                    <span class="n">merged_cont_ranges</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">merge_ranges</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">cont_range</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">cont_range</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)])</span>
                    <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spw_sel_interval</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw_sel_interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                                                   <span class="k">for</span> <span class="n">spw_sel_interval</span> <span class="ow">in</span> <span class="n">merged_cont_ranges</span><span class="p">])</span>
                    <span class="n">refers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cont_range</span><span class="p">[</span><span class="s1">&#39;refer&#39;</span><span class="p">]</span>
                                       <span class="k">for</span> <span class="n">cont_range</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cont_range</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)])</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">refers</span> <span class="o">==</span> <span class="s1">&#39;TOPO&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">refer</span> <span class="o">=</span> <span class="s1">&#39;TOPO&#39;</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">refers</span> <span class="o">==</span> <span class="s1">&#39;LSRK&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">refer</span> <span class="o">=</span> <span class="s1">&#39;LSRK&#39;</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">refers</span> <span class="o">==</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="n">refer</span> <span class="o">=</span> <span class="s1">&#39;SOURCE&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">refer</span> <span class="o">=</span> <span class="s1">&#39;UNDEFINED&#39;</span>
                    <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cont_ranges_spwsel</span><span class="p">,</span> <span class="n">refer</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;ALL&#39;</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;ALLCONT&#39;</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]:</span>
                        <span class="n">all_continuum</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;ALLCONT&#39;</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]:</span>
                    <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;ALLCONT&#39;</span>
                    <span class="n">all_continuum</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;NONE&#39;</span>
                <span class="n">low_bandwidth</span> <span class="o">=</span> <span class="s1">&#39;LOWBANDWIDTH&#39;</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span>
                <span class="n">low_spread</span> <span class="o">=</span> <span class="s1">&#39;LOWSPREAD&#39;</span> <span class="ow">in</span> <span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;flags&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;spw ID </span><span class="si">{</span><span class="n">virt_spw_id</span><span class="si">}</span><span class="s1"> not found in cont file.&#39;</span><span class="p">)</span>
                <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Field </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s1"> not found in cont file.&#39;</span><span class="p">)</span>
            <span class="n">cont_ranges_spwsel</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="n">cont_ranges_spwsel</span><span class="p">,</span> <span class="n">all_continuum</span><span class="p">,</span> <span class="n">low_bandwidth</span><span class="p">,</span> <span class="n">low_spread</span></div>


    <span class="k">def</span> <span class="nf">to_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">msnames</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">fields</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">spw_id</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">observing_run</span><span class="p">:</span><span class="n">Any</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ctrim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctrim_nchan</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Dict</span><span class="p">]:</span>

        <span class="n">frame_freq_selection</span><span class="p">,</span> <span class="n">refer</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">refer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Original reference frame must be LSRK or SOURCE, not </span><span class="si">{</span><span class="n">refer</span><span class="si">}</span><span class="s1">.&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">msnames</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;MS names and fields lists must match in length.&#39;</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cont_dat_virt_spw_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">spw_id</span><span class="p">),</span> <span class="n">spw_name</span><span class="p">))</span>

        <span class="n">qaTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">suTool</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">synthesisutils</span>

        <span class="n">freq_ranges</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">aggregate_frame_bw</span> <span class="o">=</span> <span class="s1">&#39;0.0GHz&#39;</span>
        <span class="n">cont_regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">frame_freq_selection</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">cont_region</span> <span class="ow">in</span> <span class="n">cont_regions</span><span class="p">:</span>
            <span class="n">fLow</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cont_region</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cont_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">fHigh</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cont_region</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cont_region</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="s1">&#39;Hz&#39;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
            <span class="n">freq_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fLow</span><span class="p">,</span> <span class="n">fHigh</span><span class="p">))</span>
            <span class="n">delta_f</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Hz&#39;</span> <span class="o">%</span> <span class="n">fHigh</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Hz&#39;</span> <span class="o">%</span> <span class="n">fLow</span><span class="p">)</span>
            <span class="n">aggregate_frame_bw</span> <span class="o">=</span> <span class="n">qaTool</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">aggregate_frame_bw</span><span class="p">,</span> <span class="n">delta_f</span><span class="p">)</span>

        <span class="n">topo_chan_selections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">topo_freq_selections</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msnames</span><span class="p">)):</span>
            <span class="n">msname</span> <span class="o">=</span> <span class="n">msnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">real_spw_id</span> <span class="o">=</span> <span class="n">observing_run</span><span class="o">.</span><span class="n">virtual2real_spw_id</span><span class="p">(</span><span class="n">virt_spw_id</span><span class="p">,</span> <span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">msname</span><span class="p">))</span>
            <span class="n">field</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">topo_chan_selection</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">topo_freq_selection</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">freq_range</span> <span class="ow">in</span> <span class="n">freq_ranges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">refer</span> <span class="o">==</span> <span class="s1">&#39;LSRK&#39;</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">suTool</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">spwselection</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">real_spw_id</span><span class="p">),</span>
                                                          <span class="n">freqstart</span><span class="o">=</span><span class="n">freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqend</span><span class="o">=</span><span class="n">freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">freqstep</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span>
                                                          <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;LSRK&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">suTool</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="n">field</span><span class="p">,</span> <span class="n">spwselection</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">real_spw_id</span><span class="p">),</span>
                                                          <span class="n">freqstart</span><span class="o">=</span><span class="n">freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqend</span><span class="o">=</span><span class="n">freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">freqstep</span><span class="o">=</span><span class="mf">100.</span><span class="p">,</span>
                                                          <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;SOURCE&#39;</span><span class="p">,</span> <span class="n">ephemtable</span><span class="o">=</span><span class="s1">&#39;TRACKFIELD&#39;</span><span class="p">)</span>
                        <span class="n">suTool</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>
                        <span class="n">spw_index</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">real_spw_id</span><span class="p">)</span>
                        <span class="n">start</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">][</span><span class="n">spw_index</span><span class="p">]</span>
                        <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;nchan&#39;</span><span class="p">][</span><span class="n">spw_index</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="c1"># Optionally skip edge channels</span>
                        <span class="k">if</span> <span class="n">ctrim_nchan</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="n">start</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">ctrim</span><span class="p">)</span> <span class="k">else</span> <span class="n">ctrim</span>
                            <span class="n">stop</span> <span class="o">=</span> <span class="n">stop</span> <span class="k">if</span> <span class="p">(</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ctrim_nchan</span><span class="o">-</span><span class="n">ctrim</span><span class="p">))</span> <span class="k">else</span> <span class="n">ctrim_nchan</span><span class="o">-</span><span class="n">ctrim</span><span class="o">-</span><span class="mi">1</span>
                        <span class="k">if</span> <span class="n">stop</span> <span class="o">&gt;=</span> <span class="n">start</span><span class="p">:</span>
                            <span class="n">topo_chan_selection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
                            <span class="n">result</span> <span class="o">=</span> <span class="n">suTool</span><span class="o">.</span><span class="n">advisechansel</span><span class="p">(</span><span class="n">msname</span><span class="o">=</span><span class="n">msname</span><span class="p">,</span> <span class="n">fieldid</span><span class="o">=</span><span class="n">field</span><span class="p">,</span>
                                                          <span class="n">spwselection</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_spw_id</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">),</span>
                                                          <span class="n">freqframe</span><span class="o">=</span><span class="s1">&#39;TOPO&#39;</span><span class="p">,</span> <span class="n">getfreqrange</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                            <span class="n">fLow</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqstart&#39;</span><span class="p">],</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)))</span>
                            <span class="n">fHigh</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">qaTool</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;freqend&#39;</span><span class="p">],</span> <span class="s1">&#39;GHz&#39;</span><span class="p">)))</span>
                            <span class="n">topo_freq_selection</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">fLow</span><span class="p">,</span> <span class="n">fHigh</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Cannot calculate TOPO range for MS </span><span class="si">%s</span><span class="s1"> Field </span><span class="si">%s</span><span class="s1"> SPW </span><span class="si">%s</span><span class="s1">. Exception: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">real_spw_id</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

            <span class="n">topo_chan_selections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">~</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">topo_chan_selection</span><span class="p">))</span>
            <span class="n">topo_freq_selections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> TOPO&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.10f</span><span class="s1">~</span><span class="si">%.10f</span><span class="s1">GHz&#39;</span> <span class="o">%</span>
                                                              <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">topo_freq_selection</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">topo_freq_selections</span><span class="p">,</span> <span class="n">topo_chan_selections</span><span class="p">,</span> <span class="n">aggregate_frame_bw</span>

    <span class="k">def</span> <span class="nf">get_cont_dat_virt_spw_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]):</span>

        <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">spw_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_ranges</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">f</span><span class="p">][</span><span class="n">s</span><span class="p">][</span><span class="s1">&#39;spwname&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">spw_name</span><span class="p">:</span>
                        <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="n">s</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">virt_spw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SPW name: </span><span class="si">{</span><span class="n">spw_name</span><span class="si">}</span><span class="s1"> not found. Falling back to SPW ID lookup.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">virt_spw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">spw_id</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SPW ID string must be an integer, not </span><span class="si">{</span><span class="n">spw_id</span><span class="si">}</span><span class="s1">.&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># &quot;Old&quot; style SPW ID lookup</span>
                <span class="n">virt_spw_id</span> <span class="o">=</span> <span class="n">spw_id</span>

        <span class="k">return</span> <span class="n">virt_spw_id</span></div>



<div class="viewcode-block" id="contfile_to_spwsel">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.contfilehandler.contfile_to_spwsel.html#pipeline.infrastructure.contfilehandler.contfile_to_spwsel">[docs]</a>
<span class="k">def</span> <span class="nf">contfile_to_spwsel</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">contfile</span><span class="o">=</span><span class="s1">&#39;cont.dat&#39;</span><span class="p">,</span> <span class="n">use_realspw</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate continuum ranges specified in contfile to frequency selection string.</span>

<span class="sd">    The return is a dictionary with field names with keys and spwsel as values, e.g.,</span>
<span class="sd">        {&#39;04287+1801&#39;: &#39;20:327.464~328.183GHz;328.402~329.136GHz,26:340.207~340.239GHz;340.280~340.313GHz&#39;}</span>
<span class="sd">    By default (use_realspw=True), the frequency selection string is in real SPWs of input vis, even though</span>
<span class="sd">    contfile is in virtual SPWs. If use_realspw=False, the output frequency selection string is in virtual SPWs.</span>
<span class="sd">    If the frequencies specified in the contfile are in LSRK, they will be converted to TOPO.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">contfile_handler</span> <span class="o">=</span> <span class="n">ContFileHandler</span><span class="p">(</span><span class="n">contfile</span><span class="p">)</span>
    <span class="n">contdict</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">warn_nonexist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_ms</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="n">fielddict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">contdict</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]:</span>

        <span class="c1"># Note that ContFileHandler and cont.dat use original field names from CASA tables, rather than </span>
        <span class="c1"># the &quot;CASA-safe&quot; names (see PIPE-1887 and heurtsics/field_parameter.md). So we need the dequotation</span>
        <span class="c1"># and then match.</span>
        <span class="n">fieldid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">fieldobj</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">dequote</span><span class="p">(</span><span class="n">fieldobj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="n">field</span><span class="p">]</span>

        <span class="c1"># If no field is found, skip it.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fieldid_list</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">spwstring</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">virt_spw_id</span> <span class="ow">in</span> <span class="n">contdict</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]:</span>
            <span class="n">spw_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">virtual_science_spw_ids</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">virt_spw_id</span><span class="p">)]</span>
            <span class="n">crange_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">crange</span> <span class="k">for</span> <span class="n">crange</span> <span class="ow">in</span> <span class="n">contdict</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span>
                           <span class="p">[</span><span class="n">virt_spw_id</span><span class="p">][</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">crange</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALLCONT&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">crange_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;refer&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;LSRK&#39;</span><span class="p">,</span> <span class="s1">&#39;SOURCE&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting from </span><span class="si">%s</span><span class="s2"> to TOPO...&quot;</span><span class="p">,</span> <span class="n">crange_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;refer&#39;</span><span class="p">])</span>
                <span class="n">sname</span> <span class="o">=</span> <span class="n">field</span>
                <span class="n">field_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fieldid_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="n">cranges_spwsel</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">cranges_spwsel</span><span class="p">[</span><span class="n">sname</span><span class="p">]</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">cranges_spwsel</span><span class="p">[</span><span class="n">sname</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">],</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">get_merged_selection</span><span class="p">(</span><span class="n">sname</span><span class="p">,</span> <span class="n">virt_spw_id</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">)</span>

                <span class="n">freq_ranges</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">contfile_handler</span><span class="o">.</span><span class="n">to_topo</span><span class="p">(</span>
                    <span class="n">cranges_spwsel</span><span class="p">[</span><span class="n">sname</span><span class="p">][</span><span class="n">virt_spw_id</span><span class="p">],</span> <span class="p">[</span><span class="n">vis</span><span class="p">],</span> <span class="p">[</span><span class="n">field_id</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">virt_spw_id</span><span class="p">),</span>
                    <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">)</span>
                <span class="n">freq_ranges_list</span> <span class="o">=</span> <span class="n">freq_ranges</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="n">virt_spw_id</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
                <span class="k">for</span> <span class="n">freqrange</span> <span class="ow">in</span> <span class="n">freq_ranges_list</span><span class="p">:</span>
                    <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="n">freqrange</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; TOPO&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

            <span class="k">if</span> <span class="n">crange_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;refer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;TOPO&#39;</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using TOPO frequency specified in </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contfile</span><span class="p">))</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="n">virt_spw_id</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span>
                <span class="k">for</span> <span class="n">freqrange</span> <span class="ow">in</span> <span class="n">crange_list</span><span class="p">:</span>
                    <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqrange</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;~&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">freqrange</span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;GHz;&#39;</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>

        <span class="c1"># remove appending semicolon</span>
        <span class="n">spwstring</span> <span class="o">=</span> <span class="n">spwstring</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_realspw</span><span class="p">:</span>
            <span class="n">spwstring</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">observing_run</span><span class="o">.</span><span class="n">get_real_spwsel</span><span class="p">([</span><span class="n">spwstring</span><span class="p">],</span> <span class="p">[</span><span class="n">vis</span><span class="p">])</span>
        <span class="n">fielddict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwstring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using frequencies in TOPO reference frame:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwsel</span> <span class="ow">in</span> <span class="n">fielddict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Field: </span><span class="si">{!s}</span><span class="s2">   SPW: </span><span class="si">{!s}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">spwsel</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">fielddict</span></div>



<div class="viewcode-block" id="contfile_to_chansel">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.contfilehandler.contfile_to_chansel.html#pipeline.infrastructure.contfilehandler.contfile_to_chansel">[docs]</a>
<span class="k">def</span> <span class="nf">contfile_to_chansel</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">contfile</span><span class="o">=</span><span class="s1">&#39;cont.dat&#39;</span><span class="p">,</span> <span class="n">excludechans</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Translate continuum ranges specified in contfile to channel selection string.</span>

<span class="sd">    The return is a dictionary with field names with keys and chansel as values, e.g.,</span>
<span class="sd">        {&#39;04287+1801&#39;: &#39;20:327~328,26:340~341&#39;}</span>
<span class="sd">    The channel selection string is in real SPWs of input vis.</span>
<span class="sd">    If excludechans=True, the returned string will select channels outside the continuum ranges instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">spwsel_dict</span> <span class="o">=</span> <span class="n">contfile_to_spwsel</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">contfile</span><span class="p">,</span> <span class="n">use_realspw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">chansel_dict</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwsel</span> <span class="ow">in</span> <span class="n">spwsel_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">chansel_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwsel2chansel</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">fieldname_for_casa</span><span class="p">(</span><span class="n">field</span><span class="p">),</span> <span class="n">spwsel</span><span class="p">,</span> <span class="n">excludechans</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chansel_dict</span></div>



<div class="viewcode-block" id="spwsel2chansel">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.contfilehandler.spwsel2chansel.html#pipeline.infrastructure.contfilehandler.spwsel2chansel">[docs]</a>
<span class="k">def</span> <span class="nf">spwsel2chansel</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">spwsel</span><span class="p">,</span> <span class="n">excludechans</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert selections of frequecy ranges to channel indexes.</span>

<span class="sd">    This function can convert selections of spws/chans in to channel indexes.</span>
<span class="sd">    If excludechans=True, it will select channels outside of the input selection.</span>

<span class="sd">    This function starts as a copy of a private helper function (_quantityRangesToChannels) from</span>
<span class="sd">        casatasks.private.task_uvcontsub_old._quantityRangesToChannels (ver6.5.2/6.5.3)</span>
<span class="sd">        casatasks.private.task_uvcontsub._quantityRangesToChannels (ver6.5.1)</span>
<span class="sd">    https://open-bitbucket.nrao.edu/projects/CASA/repos/casa6/browse/casatasks/src/private/task_uvcontsub_old.py?at=refs%2Ftags%2F6.5.3.28#316</span>
<span class="sd">    https://casadocs.readthedocs.io/en/v6.5.3/api/tt/casatasks.manipulation.uvcontsub_old.html (see the &quot;fitspw&quot; parameter)</span>

<span class="sd">    A refactoring work was later done via PIPE-1815.</span>

<span class="sd">    Also see the relevant disscussion on this action in JIRA:</span>
<span class="sd">    https://open-jira.nrao.edu/browse/CAS-13631?focusedCommentId=203983&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-203983</span>

<span class="sd">    Examples:</span>

<span class="sd">    CASA &lt;17&gt;: from pipeline.infrastructure.contfilehandler import spwsel2chansel</span>
<span class="sd">    CASA &lt;18&gt;: spwsel2chansel(&#39;uid___A002_Xc46ab2_X15ae_repSPW_spw16_17_small.ms&#39;,&#39;helms30&#39;,&#39;0:215369.8696MHz~215490.8696MHz&#39;,False)</span>
<span class="sd">    Out[18]: &#39;0:56~63&#39;</span>

<span class="sd">    CASA &lt;19&gt;: spwsel2chansel(&#39;uid___A002_Xc46ab2_X15ae_repSPW_spw16_17_small.ms&#39;,&#39;helms30&#39;,&#39;0:215369.8696MHz~215490.8696MHz&#39;,True)</span>
<span class="sd">    Out[19]: &#39;0:0~55,0:64~127&#39;</span>

<span class="sd">    Note: the field input value is a string in CASA/field selection syntax, e.g. a &quot;CASA-safe&quot; field name</span>
<span class="sd">    also see https://casacore.github.io/casacore-notes/263.html#x1-190004</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">vis</span><span class="o">+</span><span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
        <span class="n">nspw</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">()</span>

    <span class="n">fullspwids</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nspw</span><span class="p">)))</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;[,]&#39;</span><span class="p">)</span>
    <span class="n">tql</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s1">&#39;spw&#39;</span><span class="p">:</span> <span class="n">fullspwids</span><span class="p">}</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="k">as</span> <span class="n">ms</span><span class="p">:</span>

        <span class="n">ms</span><span class="o">.</span><span class="n">msselect</span><span class="p">(</span><span class="n">tql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">allsels</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">msselectedindices</span><span class="p">()</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="c1"># input fitspw selection</span>
        <span class="n">tql</span><span class="p">[</span><span class="s1">&#39;spw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spwsel</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">msselect</span><span class="p">(</span><span class="n">tql</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">usersels</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">msselectedindices</span><span class="p">()[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span>

    <span class="c1"># sort the arrays so that chan ranges are in order</span>
    <span class="n">usersels</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">lexsort</span><span class="p">((</span><span class="n">usersels</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">usersels</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))]</span>
    <span class="n">spwid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">prevspwid</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">newchanlist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nsels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">usersels</span><span class="p">)</span>
    <span class="c1"># casalog.post(&quot;Usersels=&quot;,usersels)</span>
    <span class="k">if</span> <span class="n">excludechans</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">isel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsels</span><span class="p">):</span>
            <span class="n">prevspwid</span> <span class="o">=</span> <span class="n">spwid</span>
            <span class="n">spwid</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lochan</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hichan</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">stp</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">maxchanid</span> <span class="o">=</span> <span class="n">allsels</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="n">spwid</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1"># find left and right side ranges of the selected range</span>
            <span class="k">if</span> <span class="n">spwid</span> <span class="o">!=</span> <span class="n">prevspwid</span><span class="p">:</span>
                <span class="c1"># first line in the selected spw</span>
                <span class="k">if</span> <span class="n">lochan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">outloL</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">outhiL</span> <span class="o">=</span> <span class="n">lochan</span><span class="o">-</span><span class="mi">1</span>
                    <span class="n">outloR</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">hichan</span><span class="o">+</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">maxchanid</span> <span class="k">else</span> <span class="n">hichan</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">outloR</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">isel</span> <span class="o">&lt;</span> <span class="n">nsels</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spwid</span><span class="p">:</span>
                            <span class="n">outhiR</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">outhiR</span> <span class="o">=</span> <span class="n">maxchanid</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># higher end of the user selected range reaches maxchanid</span>
                        <span class="c1"># so no right hand side range</span>
                    <span class="c1"># casalog.post(&quot;outloL,outhiL,outloR,outhiR==&quot;, outloL,outhiL,outloR,outhiR)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># no left hand side range</span>
                    <span class="n">outloL</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">outhiL</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">outloR</span> <span class="o">=</span> <span class="n">hichan</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">if</span> <span class="n">isel</span> <span class="o">&lt;</span> <span class="n">nsels</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spwid</span><span class="p">:</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="n">maxchanid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#expect the left side range is already taken care of</span>
                <span class="n">outloL</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">outhiL</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">outloR</span> <span class="o">=</span> <span class="n">hichan</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">outloR</span> <span class="o">&gt;=</span> <span class="n">maxchanid</span><span class="p">:</span>
                    <span class="c1">#No more boundaries to consider</span>
                    <span class="n">outloR</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">outhiR</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">isel</span> <span class="o">&lt;</span> <span class="n">nsels</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">spwid</span><span class="p">:</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">usersels</span><span class="p">[</span><span class="n">isel</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxchanid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="n">maxchanid</span>
                    <span class="k">if</span> <span class="n">outloR</span> <span class="o">&gt;</span> <span class="n">outhiR</span><span class="p">:</span>
                        <span class="n">outloR</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">outhiR</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">outloL</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outhiL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> <span class="n">outloL</span> <span class="o">&lt;=</span> <span class="n">outhiL</span><span class="p">:</span>
                <span class="n">newchanlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">,</span> <span class="n">outloL</span><span class="p">,</span> <span class="n">outhiL</span><span class="p">,</span> <span class="n">stp</span><span class="p">])</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span><span class="p">(</span><span class="n">outloR</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">outhiR</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="ow">and</span> <span class="n">outloR</span> <span class="o">&lt;=</span> <span class="n">outhiR</span><span class="p">:</span>
                <span class="n">newchanlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">spwid</span><span class="p">,</span> <span class="n">outloR</span><span class="p">,</span> <span class="n">outhiR</span><span class="p">,</span> <span class="n">stp</span><span class="p">])</span>
        <span class="c1"># casalog.post(&quot;newchanlist=&quot;,newchanlist)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># excludechans=False</span>
        <span class="n">newchanlist</span> <span class="o">=</span> <span class="n">usersels</span>

    <span class="c1"># return newchanlist</span>
    <span class="c1"># create spw selection string from newchanlist</span>
    <span class="n">spwstr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">irange</span><span class="p">,</span> <span class="n">chanrange</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newchanlist</span><span class="p">):</span>
        <span class="n">spwstr</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;:&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39;~&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">chanrange</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">irange</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">newchanlist</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spwstr</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span>

    <span class="k">return</span> <span class="n">spwstr</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>