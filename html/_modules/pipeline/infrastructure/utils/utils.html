

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.infrastructure.utils.utils &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/custom_theme.css?v=678032d9" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Releases etc.</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../releases.html">Past Releases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../modular.html">Run the Pipeline in a Conda environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html">Pipeline Tasks (from autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apisummary.html#full-list">Full List</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Heuristics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context/etc. (automodapi)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html"><code class="docutils literal notranslate"><span class="pre">pipeline.domain</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.launcher"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.launcher</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.callibrary"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.project</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#pipeline-infrastructure-callibrary-module"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.callibrary</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#pipeline-infrastructure-imagelibrary-module"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.imagelibrary</span></code> module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../basics.html#module-pipeline.infrastructure.vdp"><code class="docutils literal notranslate"><span class="pre">pipeline.infrastructure.vdp</span></code> module</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Domain/Context (autosummary)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.domain.html">pipeline.domain</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_autosummary/pipeline.infrastructure.launcher.html">pipeline.infrastructure.launcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Pipeline Task/Inputs/Results Classes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../classes.html">Classes in <code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../classes.html#inheritance-diagrams">Inheritance Diagrams</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples Notes (from Jupyter Notebooks)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test1.html">test</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Example Notes (from .rst)</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples/test2.html">Example 1</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../../pipeline.html">pipeline</a></li>
          <li class="breadcrumb-item"><a href="../../infrastructure.html">pipeline.infrastructure</a></li>
      <li class="breadcrumb-item active">pipeline.infrastructure.utils.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.infrastructure.utils.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The utils module contains general-purpose uncategorised utility functions and</span>
<span class="sd">classes.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">fcntl</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tarfile</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">casaplotms</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">casa_tools</span><span class="p">,</span> <span class="n">logging</span><span class="p">,</span> <span class="n">mpihelpers</span>
<span class="kn">from</span> <span class="nn">.conversion</span> <span class="kn">import</span> <span class="n">dequote</span><span class="p">,</span> <span class="n">range_to_list</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;find_ranges&#39;</span><span class="p">,</span> <span class="s1">&#39;dict_merge&#39;</span><span class="p">,</span> <span class="s1">&#39;are_equal&#39;</span><span class="p">,</span> <span class="s1">&#39;approx_equal&#39;</span><span class="p">,</span> <span class="s1">&#39;get_num_caltable_polarizations&#39;</span><span class="p">,</span> <span class="s1">&#39;fieldname_for_casa&#39;</span><span class="p">,</span>
           <span class="s1">&#39;flagged_intervals&#39;</span><span class="p">,</span> <span class="s1">&#39;get_field_identifiers&#39;</span><span class="p">,</span> <span class="s1">&#39;get_receiver_type_for_spws&#39;</span><span class="p">,</span> <span class="s1">&#39;get_spectralspec_to_spwid_map&#39;</span><span class="p">,</span>
           <span class="s1">&#39;imstat_items&#39;</span><span class="p">,</span> <span class="s1">&#39;get_stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;get_taskhistory_fromimage&#39;</span><span class="p">,</span> <span class="s1">&#39;glob_ordered&#39;</span><span class="p">,</span> <span class="s1">&#39;deduplicate&#39;</span><span class="p">,</span>
           <span class="s1">&#39;get_casa_quantity&#39;</span><span class="p">,</span> <span class="s1">&#39;get_si_prefix&#39;</span><span class="p">,</span> <span class="s1">&#39;absolute_path&#39;</span><span class="p">,</span> <span class="s1">&#39;relative_path&#39;</span><span class="p">,</span> <span class="s1">&#39;get_task_result_count&#39;</span><span class="p">,</span>
           <span class="s1">&#39;place_repr_source_first&#39;</span><span class="p">,</span> <span class="s1">&#39;shutdown_plotms&#39;</span><span class="p">,</span> <span class="s1">&#39;get_casa_session_details&#39;</span><span class="p">,</span> <span class="s1">&#39;get_obj_size&#39;</span><span class="p">,</span> <span class="s1">&#39;get_products_dir&#39;</span><span class="p">,</span>
           <span class="s1">&#39;export_weblog_as_tar&#39;</span><span class="p">,</span> <span class="s1">&#39;ensure_products_dir_exists&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore_pointing&#39;</span><span class="p">,</span> <span class="s1">&#39;request_omp_threading&#39;</span><span class="p">,</span>
           <span class="s1">&#39;open_with_lock&#39;</span><span class="p">,</span> <span class="s1">&#39;nested_dict&#39;</span><span class="p">,</span> <span class="s1">&#39;string_to_val&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_trailing_string&#39;</span><span class="p">,</span> <span class="s1">&#39;list_to_str&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="find_ranges">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.find_ranges.html#pipeline.domain.datatable.find_ranges">[docs]</a>
<span class="k">def</span> <span class="nf">find_ranges</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Identify numeric ranges in string or list.</span>

<span class="sd">    This utility function takes a string or a list of integers (e.g. spectral</span>
<span class="sd">    window lists) and returns a string containing identified ranges.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; find_ranges([1,2,3])</span>
<span class="sd">    &#39;1~3&#39;</span>
<span class="sd">    &gt;&gt;&gt; find_ranges(&#39;1,2,3,5~12&#39;)</span>
<span class="sd">    &#39;1~3,5~12&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="c1"># barf if channel ranges are also in data, eg. 23:1~10,24</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">range_to_list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">integers</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">s</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">integers</span><span class="p">)</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">i_x</span><span class="p">:</span> <span class="n">i_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">i_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">g</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rng</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">~</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rng</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rng</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ranges</span><span class="p">)</span></div>



<div class="viewcode-block" id="dict_merge">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.dict_merge.html#pipeline.domain.datatable.dict_merge">[docs]</a>
<span class="k">def</span> <span class="nf">dict_merge</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively merge dictionaries.</span>

<span class="sd">    This utility function recursively merges dictionaries. If second argument</span>
<span class="sd">    (b) is a dictionary, then a copy of first argument (dictionary a) is created</span>
<span class="sd">    and the elements of b are merged into the new dictionary. Otherwise return</span>
<span class="sd">    argument b.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; dict_merge({&#39;a&#39;: {&#39;b&#39;: 1}}, {&#39;c&#39;: 2})</span>
<span class="sd">    {&#39;a&#39;: {&#39;b&#39;: 1}, &#39;c&#39;: 2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">b</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">dict_merge</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>



<div class="viewcode-block" id="are_equal">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.are_equal.html#pipeline.domain.datatable.are_equal">[docs]</a>
<span class="k">def</span> <span class="nf">are_equal</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if the contents of the given arrays are equal.</span>

<span class="sd">    This utility function check the equivalence of array like objects. Two arrays</span>
<span class="sd">    are equal if they have the same number of elements and elements of the same</span>
<span class="sd">    index are equal.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; are_equal([1, 2, 3], [1, 2, 3])</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; are_equal([1, 2, 3], [1, 2, 3, 4])</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="nb">sum</span><span class="p">([</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">])</span></div>



<div class="viewcode-block" id="approx_equal">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.approx_equal.html#pipeline.domain.datatable.approx_equal">[docs]</a>
<span class="k">def</span> <span class="nf">approx_equal</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-15</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return True if two numbers are equal within the given tolerance.</span>

<span class="sd">    This utility function returns True if two numbers are equal within the</span>
<span class="sd">    given tolerance.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; approx_equal(1.0e-2, 1.2e-2, 1e-2)</span>
<span class="sd">    True</span>
<span class="sd">    &gt;&gt;&gt; approx_equal(1.0e-2, 1.2e-2, 1e-3)</span>
<span class="sd">    False</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lo</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">tol</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_num_caltable_polarizations">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_num_caltable_polarizations.html#pipeline.domain.datatable.get_num_caltable_polarizations">[docs]</a>
<span class="k">def</span> <span class="nf">get_num_caltable_polarizations</span><span class="p">(</span><span class="n">caltable</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtain number of polarisations from calibration table.</span>

<span class="sd">    Seemingly the number of QA ID does not map directly to the number of</span>
<span class="sd">    polarisations for the spw in the MS, but the number of polarisations for</span>
<span class="sd">    the spw as held in the caltable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">caltable</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
        <span class="n">col_shapes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcolshapestring</span><span class="p">(</span><span class="s1">&#39;CPARAM&#39;</span><span class="p">))</span>

    <span class="c1"># get the number of pols stored in the caltable, checking that this</span>
    <span class="c1"># is consistent across all rows</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\[(?P&lt;num_pols&gt;\d+), (?P&lt;num_rows&gt;\d+)\]&#39;</span><span class="p">)</span>
    <span class="n">col_pols</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">col_shapes</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">col_pols</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;num_pols&#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Could not find shape of polarisation from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">shape</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_pols</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Got </span><span class="si">%s</span><span class="s1"> polarisations from </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">col_pols</span><span class="p">),</span> <span class="n">col_shapes</span><span class="p">))</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_pols</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span></div>



<div class="viewcode-block" id="flagged_intervals">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.flagged_intervals.html#pipeline.domain.datatable.flagged_intervals">[docs]</a>
<span class="k">def</span> <span class="nf">flagged_intervals</span><span class="p">(</span><span class="n">vec</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Idendity isnads of ones in input array or list.</span>

<span class="sd">    This utility function finds islands of ones in array or list provided in argument.</span>
<span class="sd">    Used to find contiguous flagged channels in a given spw.  Returns a list of</span>
<span class="sd">    tuples with the start and end channels.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; flagged_intervals([0, 1, 0, 1, 1])</span>
<span class="sd">    [(1, 1), (3, 4)]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>

    <span class="n">edges</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">((</span><span class="n">vec</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">edge_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">edges</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edge_vec</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">edge_vec</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)])</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">edge_vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">edges</span><span class="p">[::</span><span class="mi">2</span><span class="p">],</span> <span class="n">edges</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span></div>



<div class="viewcode-block" id="fieldname_for_casa">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.fieldname_for_casa.html#pipeline.domain.datatable.fieldname_for_casa">[docs]</a>
<span class="k">def</span> <span class="nf">fieldname_for_casa</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Prepare field string to be used as CASA argument.</span>

<span class="sd">    This utility function ensures that field string can be used as CASA argument.</span>

<span class="sd">    If field contains special characters, then return field string enclose in</span>
<span class="sd">    quotation marks, otherwise return unchanged string.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; fieldname_for_casa(&#39;helm=30&#39;)</span>
<span class="sd">    &#39;&quot;helm=30&quot;&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()</span> <span class="ow">or</span> <span class="n">field</span> <span class="o">!=</span> <span class="n">fieldname_clean</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&quot;</span><span class="si">{0}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">field</span></div>



<div class="viewcode-block" id="fieldname_clean">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.fieldname_clean.html#pipeline.domain.datatable.fieldname_clean">[docs]</a>
<span class="k">def</span> <span class="nf">fieldname_clean</span><span class="p">(</span><span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Indicate if the fieldname is allowed as-is.</span>

<span class="sd">    This utility function replaces special characters in string with underscore.</span>
<span class="sd">    The return string is used in fieldname_for_casa() function to determine</span>
<span class="sd">    whether the field name, when given as a CASA argument, should be enclosed</span>
<span class="sd">    in quotes.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; fieldname_clean(&#39;helm=30&#39;)</span>
<span class="sd">    &#39;helm_30&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;+-&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allowed</span> <span class="k">else</span> <span class="s1">&#39;_&#39;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">field</span><span class="p">])</span></div>



<div class="viewcode-block" id="get_field_accessor">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_field_accessor.html#pipeline.domain.datatable.get_field_accessor">[docs]</a>
<span class="k">def</span> <span class="nf">get_field_accessor</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns accessor to field name or field ID, if field name is ambiguous.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">accessor</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">accessor</span></div>



<div class="viewcode-block" id="get_field_identifiers">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_field_identifiers.html#pipeline.domain.datatable.get_field_identifiers">[docs]</a>
<span class="k">def</span> <span class="nf">get_field_identifiers</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Maps numeric field IDs to field names.</span>

<span class="sd">    Get a dict of numeric field ID to unambiguous field identifier, using the</span>
<span class="sd">    field name where possible and falling back to numeric field ID where the</span>
<span class="sd">    name is duplicated, for instance in mosaic pointings.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">field_name_accessors</span> <span class="o">=</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">get_field_accessor</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">field_name_accessors</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">](</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">}</span></div>



<div class="viewcode-block" id="get_receiver_type_for_spws">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_receiver_type_for_spws.html#pipeline.domain.datatable.get_receiver_type_for_spws">[docs]</a>
<span class="k">def</span> <span class="nf">get_receiver_type_for_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">spwids</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return dictionary of receiver types for requested spectral window IDs.</span>

<span class="sd">    If spwid is not found in MeasurementSet instance, then detector type is</span>
<span class="sd">    set to &quot;N/A&quot;.</span>

<span class="sd">    Args:</span>
<span class="sd">        ms: MeasurementSet to query for receiver types.</span>
<span class="sd">        spwids: list of spw ids (integers) to query for.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary assigning receiver types as values to spwid keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rxmap</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="n">spwids</span><span class="p">:</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">spwid</span><span class="p">,</span> <span class="n">science_windows_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">spw</span><span class="p">:</span>
            <span class="n">rxmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;N/A&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rxmap</span><span class="p">[</span><span class="n">spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">spw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">receiver</span>
    <span class="k">return</span> <span class="n">rxmap</span></div>



<div class="viewcode-block" id="get_spectralspec_to_spwid_map">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_spectralspec_to_spwid_map.html#pipeline.domain.datatable.get_spectralspec_to_spwid_map">[docs]</a>
<span class="k">def</span> <span class="nf">get_spectralspec_to_spwid_map</span><span class="p">(</span><span class="n">spws</span><span class="p">:</span> <span class="n">Collection</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a dictionary of spectral specs mapped to corresponding spectral</span>
<span class="sd">    window IDs for requested list of spectral window objects.</span>

<span class="sd">    :param spws: list of spectral window objects</span>
<span class="sd">    :return: dictionary with spectral spec as keys, and corresponding</span>
<span class="sd">    list of spectral window IDs as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spwmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
        <span class="n">spwmap</span><span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">spectralspec</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">spwmap</span></div>



<div class="viewcode-block" id="imstat_items">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.imstat_items.html#pipeline.domain.datatable.imstat_items">[docs]</a>
<span class="k">def</span> <span class="nf">imstat_items</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract desired stats properties (per Stokes) using ia.statistics().</span>

<span class="sd">    Beside the standard output, some additional stats property keys are supported.</span>
<span class="sd">    Note: &#39;image&#39; is expected to an instance of CASA ia tool.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">imstats</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;madrms&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;max/madrms&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;max/madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;maxabs&#39;</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;maxabs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="s1">&#39;pct&lt;&#39;</span> <span class="ow">in</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;pct&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="n">imstats_threshold</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">statistics</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">includepix</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">threshold</span><span class="p">],</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># if no pixel is selected from the restricted pixel value range, the return of ia.statitics() would be empty.</span>
                <span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats_threshold</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;pct_masked&#39;</span><span class="p">:</span>
            <span class="n">im_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;trc&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;blc&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">im_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;peak&#39;</span><span class="p">:</span>  <span class="c1"># Here &#39;peak&#39; means the pixel value with largest deviation from zero.</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]),</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;peak/madrms&#39;</span><span class="p">:</span>
            <span class="n">peak</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">]),</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">],</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;min&#39;</span><span class="p">])</span>
            <span class="n">madrms</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="s1">&#39;medabsdevmed&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1.4826</span>  <span class="c1"># see CAS-9631</span>
            <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;peak/madrms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span><span class="o">/</span><span class="n">madrms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stats</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">imstats</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>

    <span class="k">return</span> <span class="n">stats</span></div>



<div class="viewcode-block" id="get_stokes">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_stokes.html#pipeline.domain.datatable.get_stokes">[docs]</a>
<span class="k">def</span> <span class="nf">get_stokes</span><span class="p">(</span><span class="n">imagename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the labels of all stokes planes present in a CASA image.&quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">coordsys</span><span class="p">()</span>
        <span class="n">stokes_labels</span> <span class="o">=</span> <span class="n">cs</span><span class="o">.</span><span class="n">stokes</span><span class="p">()</span>
        <span class="n">stokes_present</span> <span class="o">=</span> <span class="p">[</span><span class="n">stokes_labels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">()[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="n">cs</span><span class="o">.</span><span class="n">done</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stokes_present</span></div>



<div class="viewcode-block" id="get_casa_quantity">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_casa_quantity.html#pipeline.domain.datatable.get_casa_quantity">[docs]</a>
<span class="k">def</span> <span class="nf">get_casa_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper around quanta.quantity() that handles None input.</span>

<span class="sd">    Starting with CASA 6, quanta.quantity() no longer accepts None as input. This</span>
<span class="sd">    utility function handles None values when calling CASA quanta.quantity() tool</span>
<span class="sd">    method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A CASA quanta.quantity (dictionary)</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; get_casa_quantity(None)</span>
<span class="sd">    {&#39;unit&#39;: &#39;&#39;, &#39;value&#39;: 0.0}</span>
<span class="sd">    &gt;&gt;&gt; get_casa_quantity(&#39;10klambda&#39;)</span>
<span class="sd">    {&#39;unit&#39;: &#39;klambda&#39;, &#39;value&#39;: 10.0}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_si_prefix">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_si_prefix.html#pipeline.domain.datatable.get_si_prefix">[docs]</a>
<span class="k">def</span> <span class="nf">get_si_prefix</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">select</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">lztol</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Obtain the best SI unit prefix option for a numeric value.</span>

<span class="sd">    A &quot;best&quot; SI prefix from a specified prefix collection is defined by minimizing :</span>
<span class="sd">        * leading zeros (possibly to a specified tolerance limit, see `lztol`)</span>
<span class="sd">        * significant digits before the decimal point</span>
<span class="sd">    , after the prefix is applied.</span>

<span class="sd">    Args:</span>
<span class="sd">        value (float): the numerical value for picking the prefix.</span>
<span class="sd">        select (str, optional): SI prefix candidates, a substring of &quot;yzafpnum kMGTPEZY&quot;).</span>
<span class="sd">            Defaults to &#39;mu&#39;.</span>
<span class="sd">        lztol (int, optional): leading zeros tolerance.</span>
<span class="sd">            Defaults to 0 (avoid any leading zeros when possible).</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple: (prefix_string, prefix_scale)</span>

<span class="sd">    Examples:</span>

<span class="sd">    e.g. for frequency value in Hz</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(10**7,select=&#39;kMGT&#39;)</span>
<span class="sd">    (&#39;M&#39;, 1000000.0)</span>

<span class="sd">    e.g. for flux value in Jy</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1.0,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(0.0,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(-0.9,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;m&#39;, 0.001)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(0.9,select=&#39;um&#39;,lztol=1)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1e-7,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;u&#39;, 1e-06)</span>
<span class="sd">    &gt;&gt;&gt; get_si_prefix(1e3,select=&#39;um&#39;)</span>
<span class="sd">    (&#39;&#39;, 1.0)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mf">1.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sp_tab</span> <span class="o">=</span> <span class="s2">&quot;yzafpnum kMGTPEZY&quot;</span>
        <span class="n">sp_list</span><span class="p">,</span> <span class="n">sp_pow</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mf">3.0</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sp_tab</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">select</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="p">])</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">bisect</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">sp_pow</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="p">))</span><span class="o">+</span><span class="n">lztol</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">idx</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sp_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mf">10.</span><span class="o">**</span><span class="n">sp_pow</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>



<div class="viewcode-block" id="absolute_path">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.domain.datatable.absolute_path.html#pipeline.domain.datatable.absolute_path">[docs]</a>
<span class="k">def</span> <span class="nf">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return an absolute path of a given file.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span></div>



<div class="viewcode-block" id="relative_path">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.relative_path.html#pipeline.domain.datatable.relative_path">[docs]</a>
<span class="k">def</span> <span class="nf">relative_path</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">start</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retun a relative path of a given file with respect a given origin.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: A path to file.</span>
<span class="sd">        start: An origin of relative path. If the start is not given, the</span>
<span class="sd">            current directory is used as the origin of relative path.</span>

<span class="sd">    Examples:</span>
<span class="sd">    &gt;&gt;&gt; relative_path(&#39;/root/a/b.txt&#39;, &#39;/root/c&#39;)</span>
<span class="sd">    &#39;../a/b.txt&#39;</span>
<span class="sd">    &gt;&gt;&gt; relative_path(&#39;../a/b.txt&#39;, &#39;./c&#39;)</span>
<span class="sd">    &#39;../../a/b.txt&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">absolute_path</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">absolute_path</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">start</span><span class="p">)</span></div>



<div class="viewcode-block" id="get_task_result_count">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_task_result_count.html#pipeline.domain.datatable.get_task_result_count">[docs]</a>
<span class="k">def</span> <span class="nf">get_task_result_count</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">taskname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;hif_makeimages&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count occurrences of a task result in the context.results list.</span>

<span class="sd">    Loop over the content of the context.results list and compare taskname to the pipeline_casa_task</span>
<span class="sd">    attribute of each result object. Increase counter if taskname substring is found in the attribute.</span>

<span class="sd">    The order number is determined by counting the number of previous execution of</span>
<span class="sd">    the task, based on the content of the context.results list. The introduction</span>
<span class="sd">    of this method is necessary because VLASS-SE-CONT imaging happens in multiple</span>
<span class="sd">    stages (hif_makeimages calls). Imaging parameters change from stage to stage,</span>
<span class="sd">    therefore it is necessary to know what is the current stage ordinal number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">results</span><span class="p">:</span>
        <span class="c1"># Work around the fact that r has read() method in some cases (e.g. editimlist)</span>
        <span class="c1"># but not in others (e.g. in tclean renderer)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">taskname</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">pipeline_casa_task</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">taskname</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">pipeline_casa_task</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span></div>



<div class="viewcode-block" id="place_repr_source_first">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.place_repr_source_first.html#pipeline.domain.datatable.place_repr_source_first">[docs]</a>
<span class="k">def</span> <span class="nf">place_repr_source_first</span><span class="p">(</span><span class="n">itemlist</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]],</span> <span class="n">repr_source</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Place representative source first in a list of source names</span>
<span class="sd">    or tuples with source name as first tuple element.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">itemtype</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">itemlist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">repr_source_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">dequote</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dequote</span><span class="p">(</span><span class="n">repr_source</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">or</span> <span class="n">itemtype</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">repr_source_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">dequote</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">itemlist</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">dequote</span><span class="p">(</span><span class="n">repr_source</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Cannot handle items of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itemtype</span><span class="p">))</span>
        <span class="n">repr_source_entry</span> <span class="o">=</span> <span class="n">itemlist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">repr_source_index</span><span class="p">)</span>
        <span class="n">itemlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">repr_source_entry</span><span class="p">]</span> <span class="o">+</span> <span class="n">itemlist</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not reorder field list to place representative source first&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">itemlist</span></div>



<div class="viewcode-block" id="shutdown_plotms">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.shutdown_plotms.html#pipeline.domain.datatable.shutdown_plotms">[docs]</a>
<span class="k">def</span> <span class="nf">shutdown_plotms</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Shutdown the existing plotms process in the current CASA session.</span>

<span class="sd">    This utility function shuts down the persist plotms process in the current CASA session, so the next plotms call</span>
<span class="sd">    can start from a new proc. It&#39;s implemented as a short-term workaround for two plotms behaviors due to the persistent</span>
<span class="sd">    state of plotms once it&#39;s called in a CASA session.</span>
<span class="sd">        1. a plotms process always uses the initial working directory to construct the output plot path when the</span>
<span class="sd">           figure name is specified as a relative path (see CAS-13626), even after the working directory has changed</span>
<span class="sd">           in the Python perspective.</span>
<span class="sd">        2. a plotms process always uses the same casa logfile when it was started for its logging, even after</span>
<span class="sd">           the casa log file location has been altered.</span>

<span class="sd">    Note: This function follows the practice illustrated inside casaplotms.private.plotmstool.__stub_check()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plotmstool</span> <span class="o">=</span> <span class="n">casaplotms</span><span class="o">.</span><span class="n">plotmstool</span>

    <span class="k">if</span> <span class="n">plotmstool</span><span class="o">.</span><span class="n">__proc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotmstool</span><span class="o">.</span><span class="n">__proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">plotmstool</span><span class="o">.</span><span class="n">__proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">plotmstool</span><span class="o">.</span><span class="n">__proc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">plotmstool</span><span class="o">.</span><span class="n">__stub</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">plotmstool</span><span class="o">.</span><span class="n">__uri</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="get_casa_session_details">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_casa_session_details.html#pipeline.domain.datatable.get_casa_session_details">[docs]</a>
<span class="k">def</span> <span class="nf">get_casa_session_details</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the current CASA session details.</span>

<span class="sd">    return a dictionary including the following keys:</span>
<span class="sd">        casa_dir: the root directory of the monolithic CASA distribution.</span>
<span class="sd">        omp_num_threads: the number of OpenMP threads in the current parallel region.</span>
<span class="sd">        data_path: CASA data paths in-use.</span>
<span class="sd">        numa_mem: memory properties from the NUMA software perspective.</span>
<span class="sd">        numa_cpu: cpu properties from the NUMA software perspective.</span>
<span class="sd">            The above CPU/mem properties might be different from the hardware specs obtained from</span>
<span class="sd">            standard Python functions (e.g. os.cpu_count()) or pipeline.environment.</span>
<span class="sd">            On the difference between the &quot;software&quot; and hardware nodes, see</span>
<span class="sd">                https://www.kernel.org/doc/html/latest/vm/numa.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">casa_session_details</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">hostinfo</span><span class="p">()</span>
    <span class="n">casa_session_details</span><span class="p">[</span><span class="s1">&#39;casa_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">getrc</span><span class="p">()</span>
    <span class="n">casa_session_details</span><span class="p">[</span><span class="s1">&#39;omp_num_threads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">casalog</span><span class="o">.</span><span class="n">ompGetNumThreads</span><span class="p">()</span>
    <span class="n">casa_session_details</span><span class="p">[</span><span class="s1">&#39;data_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">defaultpath</span><span class="p">()</span>
    <span class="n">casa_session_details</span><span class="p">[</span><span class="s1">&#39;numa_cpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casa_session_details</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;cpus&#39;</span><span class="p">)</span>
    <span class="n">casa_session_details</span><span class="p">[</span><span class="s1">&#39;numa_mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">casa_session_details</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;memory&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">casa_session_details</span></div>



<div class="viewcode-block" id="get_taskhistory_fromimage">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_taskhistory_fromimage.html#pipeline.domain.datatable.get_taskhistory_fromimage">[docs]</a>
<span class="k">def</span> <span class="nf">get_taskhistory_fromimage</span><span class="p">(</span><span class="n">imagename</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve past CASA/tclean() call parameters from the image history.</span>

<span class="sd">    Note: the tclean history is only added to images/logtable in CASA ver&gt;=6.2 (see CAS-13247)</span>
<span class="sd">    For tclean products generated by earlier CASA versions, an empty list will be returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">taskhistory_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">ImageReader</span><span class="p">(</span><span class="n">imagename</span><span class="p">)</span> <span class="k">as</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">history_list</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">history</span><span class="p">(</span><span class="nb">list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">history_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;taskname&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">taskhistory_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="s1">&#39;taskname&#39;</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;taskversion&#39;</span><span class="p">,</span> <span class="s1">&#39;unkown&#39;</span><span class="p">)]))</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;version:&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="s1">&#39;CASAtools:&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">is_fromtask</span><span class="p">:</span>
                <span class="n">taskhistory_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;taskversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">is_fromtask</span><span class="p">:</span>
                <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">taskhistory_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">is_fromtask</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">taskhistory_list</span><span class="p">)</span><span class="si">}</span><span class="s1"> task history entry/entries from </span><span class="si">{</span><span class="n">imagename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">taskhistory_list</span></div>



<div class="viewcode-block" id="get_obj_size">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_obj_size.html#pipeline.domain.datatable.get_obj_size">[docs]</a>
<span class="k">def</span> <span class="nf">get_obj_size</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">serialize</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the size of a Python object.</span>

<span class="sd">    If serialize=True, the size of a serialized object is returned. Note that this is NOT the</span>
<span class="sd">    same as the object size in memory.</span>

<span class="sd">    When serialize=False, the memory consumption of the object is returned via</span>
<span class="sd">    the asizeof method of Pympler.:</span>
<span class="sd">        pympler.asizeof.asizeof(obj) # https://pypi.org/project/Pympler</span>
<span class="sd">    An alternative is the get_deep_size() function from objsize.</span>
<span class="sd">        objsize.get_deep_size(obj)   # https://pypi.org/project/objsize</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">serialize</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pympler.asizeof</span> <span class="kn">import</span> <span class="n">asizeof</span>
            <span class="c1"># PIPE-1698: a workaround for NumPy-related issues with the recent Pympler/asizeof versions</span>
            <span class="c1"># see https://github.com/pympler/pympler/issues/155</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">asizeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str_</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Import error: </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Pympler/asizeof is not installed, which is required to run get_obj_size(obj, serialize=False).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">asizeof</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></div>



<div class="viewcode-block" id="glob_ordered">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.glob_ordered.html#pipeline.domain.datatable.glob_ordered">[docs]</a>
<span class="k">def</span> <span class="nf">glob_ordered</span><span class="p">(</span><span class="n">pattern</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a sorted list of paths matching a pathname pattern.&quot;&quot;&quot;</span>

    <span class="n">path_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;mtime&#39;</span><span class="p">:</span>
        <span class="n">path_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ctime&#39;</span><span class="p">:</span>
        <span class="n">path_list</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown sorting order requested: order=</span><span class="si">%r</span><span class="s2">. Only &#39;mtime&#39;, &#39;ctime&#39;, or None is allowed.&quot;</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;We will use the default alphabetically/numerically ascending order (order=None) instead.&quot;</span><span class="p">)</span>
        <span class="n">path_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">path_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">path_list</span></div>



<div class="viewcode-block" id="deduplicate">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.deduplicate.html#pipeline.domain.datatable.deduplicate">[docs]</a>
<span class="k">def</span> <span class="nf">deduplicate</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove duplicate entries from a list, but preserve the order.</span>

<span class="sd">    Note that the use of list(set(x)) can cause random order in the output.</span>
<span class="sd">    The return of this function is guaranteed to be in the order that unique items show up in the input, unlike</span>
<span class="sd">    a deduplicate-resorting solution like sorted(set(x).</span>
<span class="sd">    Ref: https://stackoverflow.com/questions/480214/how-do-i-remove-duplicates-from-a-list-while-preserving-order</span>
<span class="sd">    This solution only works for Python 3.7+.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deduplicated_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deduplicated_items</span></div>



<div class="viewcode-block" id="ignore_pointing">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.ignore_pointing.html#pipeline.domain.datatable.ignore_pointing">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">ignore_pointing</span><span class="p">(</span><span class="n">vis</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A context manager to ignore pointing tables of MSes during I/O operations.</span>

<span class="sd">    The original pointing table will be temperarily renamed to POINTING_ORIGIN, and a new empty pointing table</span>
<span class="sd">    is created. When the context manager exits, the original table is restored.</span>

<span class="sd">    For example, to ignore the pointing table of a MS during mstransform() calls, use:</span>

<span class="sd">        with ignore_pointing(&#39;test.ms&#39;):</span>
<span class="sd">            casatasks.mstransform(vis=&#39;test.ms&#39;,outputvis=&#39;test_output.ms&#39;,scan=&#39;16&#39;,datacolumn=&#39;data&#39;)</span>

<span class="sd">    The pointing table of the output MS should be empty.</span>

<span class="sd">    On the other hand, if the pointing table is needed in the output vis, e.g. for imaging with tclean(usepointing=True),</span>
<span class="sd">    we can manually create hardlinks of pointing table afterwards while minimizing the disk space usage:</span>

<span class="sd">        import shutil, os</span>
<span class="sd">        shutil.rmtree(&#39;test_small.ms/POINTING&#39;)</span>
<span class="sd">        shutil.copytree(&#39;test.ms/POINTING&#39;, &#39;test_output.ms/POINTING&#39;, copy_function=os.link)</span>

<span class="sd">    One can verify the inodes of the pointing table files, which should be the same:</span>

<span class="sd">        ls -lih test.ms/POINTING</span>
<span class="sd">        ls -lih test_small.ms/POINTING</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
        <span class="n">vis_list</span> <span class="o">=</span> <span class="n">vis</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vis_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">vis</span><span class="p">]</span>

    <span class="n">vis_list_ignore</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">vis_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No pointing table found in </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">.&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">vis_list_ignore</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;backup the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">,</span> <span class="n">nomodify</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">tabdesc</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getdesc</span><span class="p">()</span>
                <span class="n">dminfo</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getdminfo</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;empty the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">tb</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">table</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">,</span> <span class="n">tabdesc</span><span class="p">,</span> <span class="n">dminfo</span><span class="o">=</span><span class="n">dminfo</span><span class="p">)</span>
            <span class="n">tb</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ms</span> <span class="ow">in</span> <span class="n">vis_list_ignore</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;restore the pointing table for </span><span class="si">{</span><span class="n">ms</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING_ORIGIN&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">+</span><span class="s1">&#39;/POINTING&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="request_omp_threading">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.request_omp_threading.html#pipeline.domain.datatable.request_omp_threading">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">request_omp_threading</span><span class="p">(</span><span class="n">num_threads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A context manager to override the session-wise OMP threading setting on CASA MPI client.</span>

<span class="sd">    This function is intended to improve certain CASAtask/tool call performance on the MPI client by</span>
<span class="sd">    temporarily turning on OpenMP threading while the MPI servers are idle. This feature will only</span>
<span class="sd">    take effect under restricted circumstances to avoid competing with the MPI server processes from</span>
<span class="sd">    the tier0 or tier1 parallelization.</span>

<span class="sd">    This function can be used as both a decorator and context manager. For example:</span>

<span class="sd">        @request_omp_threading(4)</span>
<span class="sd">        def do_something():</span>
<span class="sd">            ...</span>
<span class="sd">        or,</span>
<span class="sd">        with request_omp_threading(4):</span>
<span class="sd">            immoments(..)</span>

<span class="sd">    Note: </span>
<span class="sd">    * Please use it with caution and examine the computing resource allocation circumstance</span>
<span class="sd">    carefully at the execution point.</span>
<span class="sd">    * The casalog.ompGet/SetNumThreads() API doesn&#39;t work as expected on macOS as of CASA ver6.6.1 although</span>
<span class="sd">    runtime env var (i.e. OMP_NUM_THREADS) is respected. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">session_num_threads</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">casalog</span><span class="o">.</span><span class="n">ompGetNumThreads</span><span class="p">()</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;session_num_threads = </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_num_threads</span><span class="p">))</span>
    <span class="n">is_mpi_ready</span> <span class="o">=</span> <span class="n">mpihelpers</span><span class="o">.</span><span class="n">is_mpi_ready</span><span class="p">()</span>  <span class="c1"># return True if MPI is ready and we are on the MPI client.</span>

    <span class="n">num_threads_limits</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># this is generally inherited from cgroup, but might be sub-optimal (too large) for high core-count</span>
    <span class="c1"># workstations when cgroup limit is not applied.</span>
    <span class="n">casa_num_cpus</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">casalog</span><span class="o">.</span><span class="n">getNumCPUs</span><span class="p">()</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;casalog.getNumCPUs() = </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">casa_num_cpus</span><span class="p">))</span>
    <span class="n">num_threads_limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">casa_num_cpus</span><span class="p">)</span>

    <span class="c1"># check against MPI.UNIVERSE_SIZE, which is another way to limit the number of threads.</span>
    <span class="c1"># see https://www.mpi-forum.org/docs/mpi-4.0/mpi40-report.pdf (Sec. 11.10.1, Universe Size)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
        <span class="k">if</span> <span class="n">MPI</span><span class="o">.</span><span class="n">UNIVERSE_SIZE</span> <span class="o">!=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">KEYVAL_INVALID</span><span class="p">:</span>
            <span class="n">universe_size</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_attr</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">UNIVERSE_SIZE</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MPI.UNIVERSE_SIZE = </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">universe_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">universe_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">universe_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_threads_limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">universe_size</span><span class="p">)</span>
            <span class="n">world_size</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;MPI.COMM_WORLD.Get_size() = </span><span class="si">{!s}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">world_size</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">world_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">world_size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_threads_limits</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">world_size</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="n">max_num_threads</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">num_threads_limits</span><span class="p">)</span>

    <span class="n">context_num_threads</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">is_mpi_ready</span> <span class="ow">and</span> <span class="n">session_num_threads</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">max_num_threads</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">num_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">num_threads</span> <span class="o">&lt;=</span> <span class="n">max_num_threads</span><span class="p">:</span>
                <span class="n">max_num_threads</span> <span class="o">=</span> <span class="n">num_threads</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;The requested num_threads (</span><span class="si">{</span><span class="n">num_threads</span><span class="si">}</span><span class="s1">) is larger than the optimal number of logical CPUs (</span><span class="si">{</span><span class="n">max_num_threads</span><span class="si">}</span><span class="s1">) assigned for this CASA session. &#39;</span><span class="p">)</span>

        <span class="n">context_num_threads</span> <span class="o">=</span> <span class="n">max_num_threads</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context_num_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">casa_tools</span><span class="o">.</span><span class="n">casalog</span><span class="o">.</span><span class="n">ompSetNumThreads</span><span class="p">(</span><span class="n">context_num_threads</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;adjust openmp threads to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">context_num_threads</span><span class="p">))</span>
        <span class="k">yield</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context_num_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">casa_tools</span><span class="o">.</span><span class="n">casalog</span><span class="o">.</span><span class="n">ompSetNumThreads</span><span class="p">(</span><span class="n">session_num_threads</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;restore openmp threads to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session_num_threads</span><span class="p">))</span></div>



<div class="viewcode-block" id="open_with_lock">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.open_with_lock.html#pipeline.domain.datatable.open_with_lock">[docs]</a>
<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">open_with_lock</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Open file with a lock.</span>

<span class="sd">    The file open context manager function will try to lock the file upon opening </span>
<span class="sd">    so other processes using the same &quot;opener&quot; will wait for the file to unlock. </span>
<span class="sd">    The applied lock will be released when leaving the context.</span>

<span class="sd">    Notes: </span>
<span class="sd">    </span>
<span class="sd">    all file open calls with `open_with_lock` will block other `open_with_lock` usages </span>
<span class="sd">    (even from different processes/lustre-clients) from read/write until the lock is released.</span>
<span class="sd">    However, this locking/blocking mechanism will not prevent the file access (potentially </span>
<span class="sd">    causing IO error) from other file openers (e.g. the default open() function).</span>

<span class="sd">    Because the Python/fcntl API depends on the underlying OS/storage implementation: </span>
<span class="sd">        https://docs.python.org/3/library/fcntl.html</span>
<span class="sd">    Not all OS/fsys is fully supported. For Lustre, it seems to depend on fsys mount `-o flock` </span>
<span class="sd">    options, which is indeed used for cv/naasc/aoc lustre systems:</span>
<span class="sd">        $ mount -l | grep lustre</span>
<span class="sd">            192.168.1.30@o2ib:/aoclst03 on /.lustre/aoc type lustre (rw,flock,user_xattr,lazystatfs)</span>
<span class="sd">    For NFS, please see additional notes in PIPE-2051.</span>

<span class="sd">    For a practical test, try the code snippet below from different clients/processes to see </span>
<span class="sd">    if the fnctl blocking mechanism can prevent non-exclusive access to a file.</span>
<span class="sd">        import fcntl</span>
<span class="sd">        fd=open(filename,&#39;w&#39;)</span>
<span class="sd">        fcntl.flock(fd, fcntl.LOCK_EX | fcntl.LOCK_NB)</span>

<span class="sd">    Args:</span>
<span class="sd">        filename (str): the file name</span>
<span class="sd">        mode (str, optional): open mode. Defaults to &#39;r&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;acquiring lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;acquired lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to acquire file lock due to the filesystem limitation,&#39;</span>
                        <span class="s1">&#39;which might cause racing conditions if multiple processes access </span><span class="si">%s</span><span class="s1"> simultaneously.&#39;</span><span class="p">,</span>
                        <span class="n">filename</span><span class="p">)</span>

        <span class="k">yield</span> <span class="n">fd</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_UN</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;released lock on </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to acquire file lock due to the filesystem limitation,&#39;</span>
                        <span class="s1">&#39;which might cause racing conditions if multiple processes access </span><span class="si">%s</span><span class="s1"> simultaneously.&#39;</span><span class="p">,</span>
                        <span class="n">filename</span><span class="p">)</span></div>


<div class="viewcode-block" id="ensure_products_dir_exists">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.ensure_products_dir_exists.html#pipeline.domain.datatable.ensure_products_dir_exists">[docs]</a>
<span class="k">def</span> <span class="nf">ensure_products_dir_exists</span><span class="p">(</span><span class="n">products_dir</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating products directory: </span><span class="si">{</span><span class="n">products_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">products_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exc</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
            <span class="k">raise</span></div>



<div class="viewcode-block" id="export_weblog_as_tar">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.export_weblog_as_tar.html#pipeline.domain.datatable.export_weblog_as_tar">[docs]</a>
<span class="k">def</span> <span class="nf">export_weblog_as_tar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">products_dir</span><span class="p">,</span> <span class="n">name_builder</span><span class="p">):</span>
    <span class="c1"># Construct filename prefix from oussid and recipe name if available.</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_oussid</span><span class="p">()</span>
    <span class="n">recipe_name</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_recipe_name</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">recipe_name</span><span class="p">:</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">recipe_name</span>

    <span class="c1"># Construct filename for weblog output tar archive.</span>
    <span class="n">tarfilename</span> <span class="o">=</span> <span class="n">name_builder</span><span class="o">.</span><span class="n">weblog</span><span class="p">(</span><span class="n">project_structure</span><span class="o">=</span><span class="n">context</span><span class="o">.</span><span class="n">project_structure</span><span class="p">,</span>
                                      <span class="n">ousstatus_entity_id</span><span class="o">=</span><span class="n">prefix</span><span class="p">)</span>

    <span class="c1"># Save weblog directory to tar archive.</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving weblog in </span><span class="si">{</span><span class="n">tarfilename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">tar</span> <span class="o">=</span> <span class="n">tarfile</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">products_dir</span><span class="p">,</span> <span class="n">tarfilename</span><span class="p">),</span> <span class="s2">&quot;w:gz&quot;</span><span class="p">)</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">report_dir</span><span class="p">)),</span> <span class="s1">&#39;html&#39;</span><span class="p">))</span>
    <span class="n">tar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">tarfilename</span></div>



<div class="viewcode-block" id="get_products_dir">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.get_products_dir.html#pipeline.domain.datatable.get_products_dir">[docs]</a>
<span class="k">def</span> <span class="nf">get_products_dir</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">products_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;./&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">products_dir</span></div>



<div class="viewcode-block" id="pl_defaultdict">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.pl_defaultdict.html#pipeline.domain.datatable.pl_defaultdict">[docs]</a>
<span class="k">class</span> <span class="nc">pl_defaultdict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">as_plain_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">to_plain_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>



<div class="viewcode-block" id="nested_dict">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.nested_dict.html#pipeline.domain.datatable.nested_dict">[docs]</a>
<span class="k">def</span> <span class="nf">nested_dict</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">pl_defaultdict</span><span class="p">(</span><span class="n">nested_dict</span><span class="p">)</span></div>



<div class="viewcode-block" id="to_plain_dict">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.to_plain_dict.html#pipeline.domain.datatable.to_plain_dict">[docs]</a>
<span class="k">def</span> <span class="nf">to_plain_dict</span><span class="p">(</span><span class="n">default_dict</span><span class="p">):</span>
    <span class="n">plain_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">default_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">):</span>
            <span class="n">plain_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_plain_dict</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plain_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">return</span> <span class="n">plain_dict</span></div>



<div class="viewcode-block" id="string_to_val">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.string_to_val.html#pipeline.domain.datatable.string_to_val">[docs]</a>
<span class="k">def</span> <span class="nf">string_to_val</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a string to a Python data type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pyobj</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># PIPE-1030: prevent a string like &quot;1,2,3&quot; from being unexpectedly translated into tuple</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pyobj</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span> <span class="ow">and</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">pyobj</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">pyobj</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="remove_trailing_string">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.infrastructure.utils.utils.remove_trailing_string.html#pipeline.domain.datatable.remove_trailing_string">[docs]</a>
<span class="k">def</span> <span class="nf">remove_trailing_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove a trailing string if it exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span></div>



<div class="viewcode-block" id="list_to_str">
<a class="viewcode-back" href="../../../../_autosummary/pipeline.domain.datatable.list_to_str.html#pipeline.domain.datatable.list_to_str">[docs]</a>
<span class="k">def</span> <span class="nf">list_to_str</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span> <span class="n">npt</span><span class="o">.</span><span class="n">NDArray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert list or numpy.ndarray into string.</span>

<span class="sd">    The list/ndarray should be 1-dimensional. In that case, the function</span>
<span class="sd">    returns comma-separated sequence of its elements. Otherwise it just</span>
<span class="sd">    returns default string representation of the value, str(value).</span>

<span class="sd">    Args:</span>
<span class="sd">        value: 1-dimensional list or numpy array</span>

<span class="sd">    Returns:</span>
<span class="sd">        String representation of the value. If input value is in</span>
<span class="sd">        compliance with the requirement, it will be comma-separated</span>
<span class="sd">        sequence of elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> \
       <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">Number</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># use np.ndarray.tolist to ensure all the elements</span>
        <span class="c1"># have Python builtin types</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ret</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>