

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pipeline.infrastructure.tablereader &mdash; Pipeline unknown documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_astrorefs.css?v=4d4a2fdb" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom_theme.css?v=30144f19" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=3f1b9271"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: gray" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Pipeline
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Basics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ways_to_run_the_pipeline.html">Ways to run the Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/recipes.html">Pipeline Recipes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dependencies.html">Dependencies of <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases.html">Past Releases</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html">Full APIs (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-tasks-autosummary">Pipeline Tasks (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-context-autosummary">Pipeline domain/context (autosummary)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-domain-infrastructure-modules-automodapi">Pipeline domain/infrastructure modules (automodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#pipeline-h-tasks-modules-autmodapi"><code class="docutils literal notranslate"><span class="pre">pipeline.h*.tasks</span></code> modules (autmodapi)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../apisummary.html#inheritance-diagrams-for-pipeline-task-inputs-results-classes">Inheritance Diagrams for Pipeline <code class="docutils literal notranslate"><span class="pre">Task</span></code>/<code class="docutils literal notranslate"><span class="pre">Inputs</span></code>/<code class="docutils literal notranslate"><span class="pre">Results</span></code> Classes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/ALMA-Imaging-Workflow.html">ALMA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLA-Imaging-Workflow.html">VLA interferometry imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CONT-Imaging-Workflow.html">VLASS-SE-CONT imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/VLASS-SE-CUBE-Imaging-Workflow.html">VLASS-SE-CUBE imaging workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/selfcal_workflow.html">VLASS Selfcal &amp; Restore workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/comparing_pipeline_executions.html">Comparing pipeline executions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/building_the_pipeline.html">Building the pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modular.html">Run the Pipeline in a Conda environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/pipeline_tests.html">Pipeline testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DataType_Testing.html">DataType Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/QA_scores.html">Pipeline Quality Assurance (QA) Score Class Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/DeveloperDocumentation.html">Pipeline developer documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../develdocmd/python3_conversion_notes.html">Python 3 conversion notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/field_parameter.html">Field parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../heuristics/FlaggingTasks.html">Pipeline Flagging Tasks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/context.html">Pipeline Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/tier0dask.html">“Tier0” Parallelization with Dask/Futures</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: gray" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Pipeline</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
          <li class="breadcrumb-item"><a href="../../pipeline.html">pipeline</a></li>
          <li class="breadcrumb-item"><a href="../infrastructure.html">pipeline.infrastructure</a></li>
      <li class="breadcrumb-item active">pipeline.infrastructure.tablereader</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pipeline.infrastructure.tablereader</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ElementTree</span>
<span class="kn">from</span> <span class="nn">bisect</span> <span class="kn">import</span> <span class="n">bisect_left</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">cachetools</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">pipeline.domain</span> <span class="k">as</span> <span class="nn">domain</span>
<span class="kn">import</span> <span class="nn">pipeline.domain.measures</span> <span class="k">as</span> <span class="nn">measures</span>
<span class="kn">import</span> <span class="nn">pipeline.infrastructure.utils</span> <span class="k">as</span> <span class="nn">utils</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">casa_tools</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">.casa_tools</span> <span class="kn">import</span> <span class="n">MSMDReader</span>
<span class="kn">from</span> <span class="nn">..domain</span> <span class="kn">import</span> <span class="n">Antenna</span><span class="p">,</span> <span class="n">AntennaArray</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="find_EVLA_band">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.find_EVLA_band.html#pipeline.infrastructure.tablereader.find_EVLA_band">[docs]</a>
<span class="k">def</span> <span class="nf">find_EVLA_band</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">bandlimits</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">BBAND</span><span class="o">=</span><span class="s1">&#39;?4PLSCXUKAQ?&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;identify VLA band&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bandlimits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bandlimits</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0e6</span><span class="p">,</span> <span class="mf">150.0e6</span><span class="p">,</span> <span class="mf">700.0e6</span><span class="p">,</span> <span class="mf">2.0e9</span><span class="p">,</span> <span class="mf">4.0e9</span><span class="p">,</span> <span class="mf">8.0e9</span><span class="p">,</span> <span class="mf">12.0e9</span><span class="p">,</span> <span class="mf">18.0e9</span><span class="p">,</span> <span class="mf">26.5e9</span><span class="p">,</span> <span class="mf">40.0e9</span><span class="p">,</span> <span class="mf">56.0e9</span><span class="p">]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">bisect_left</span><span class="p">(</span><span class="n">bandlimits</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">BBAND</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>



<span class="k">def</span> <span class="nf">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">)</span> <span class="k">else</span> <span class="n">ms</span>


<span class="k">def</span> <span class="nf">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">)</span> <span class="k">else</span> <span class="n">ms</span>


<span class="k">def</span> <span class="nf">_get_science_goal_value</span><span class="p">(</span><span class="n">science_goals</span><span class="p">,</span> <span class="n">goal_keyword</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">science_goal</span> <span class="ow">in</span> <span class="n">science_goals</span><span class="p">:</span>
        <span class="n">keyword</span> <span class="o">=</span> <span class="n">science_goal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">!=</span> <span class="n">goal_keyword</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;representativeSource&#39;</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">science_goal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">science_goal</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">value</span>


<div class="viewcode-block" id="ObservingRunReader">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.ObservingRunReader.html#pipeline.infrastructure.tablereader.ObservingRunReader">[docs]</a>
<span class="k">class</span> <span class="nc">ObservingRunReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_observing_run</span><span class="p">(</span><span class="n">ms_files</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms_files</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">ms_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms_files</span><span class="p">]</span>

        <span class="n">observing_run</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">ObservingRun</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ms_file</span> <span class="ow">in</span> <span class="n">ms_files</span><span class="p">:</span>
            <span class="n">ms</span> <span class="o">=</span> <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">get_measurement_set</span><span class="p">(</span><span class="n">ms_file</span><span class="p">)</span>
            <span class="n">observing_run</span><span class="o">.</span><span class="n">add_measurement_set</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">observing_run</span></div>



<div class="viewcode-block" id="MeasurementSetReader">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.MeasurementSetReader.html#pipeline.infrastructure.tablereader.MeasurementSetReader">[docs]</a>
<span class="k">class</span> <span class="nc">MeasurementSetReader</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_scans</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analysing scans in </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">openms</span><span class="p">:</span>
            <span class="n">scan_number_col</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SCAN_NUMBER&#39;</span><span class="p">)</span>
            <span class="n">time_col</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="n">antenna1_col</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA1&#39;</span><span class="p">)</span>
            <span class="n">antenna2_col</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;ANTENNA2&#39;</span><span class="p">)</span>
            <span class="n">data_desc_id_col</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;DATA_DESC_ID&#39;</span><span class="p">)</span>
            <span class="n">time_colkeywords</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getcolkeywords</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>

        <span class="c1"># get columns and tools needed to create scan times</span>
        <span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_colkeywords</span><span class="p">[</span><span class="s1">&#39;QuantumUnits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">time_ref</span> <span class="o">=</span> <span class="n">time_colkeywords</span><span class="p">[</span><span class="s1">&#39;MEASINFO&#39;</span><span class="p">][</span><span class="s1">&#39;Ref&#39;</span><span class="p">]</span>
        <span class="n">mt</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
        <span class="n">qt</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="c1"># For each Observation ID, retrieve info on scans.</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">data_desc_mask_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">data_descriptions</span><span class="p">:</span>
            <span class="n">data_desc_mask_dict</span><span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_desc_id_col</span> <span class="o">==</span> <span class="n">dd</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">obs_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">nobservations</span><span class="p">()):</span>
            <span class="n">statesforscans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">statesforscans</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obs_id</span><span class="p">)</span>
            <span class="n">fieldsforscans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforscans</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obs_id</span><span class="p">,</span> <span class="n">arrayid</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">asmap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">spwsforscans</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforscans</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obs_id</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scannumbers</span><span class="p">(</span><span class="n">obsid</span><span class="o">=</span><span class="n">obs_id</span><span class="p">):</span>
                <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">states</span>
                          <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">statesforscans</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)]]</span>

                <span class="n">intents</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">intents</span><span class="p">),</span> <span class="n">states</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>

                <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">fieldsforscans</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)]]</span>

                <span class="c1"># can&#39;t use msmd.timesforscan as we need unique times grouped</span>
                <span class="c1"># by spw</span>
                <span class="c1"># scan_times = msmd.timesforscan(scan_id)</span>

                <span class="n">exposures</span> <span class="o">=</span> <span class="p">{</span><span class="n">spw_id</span><span class="p">:</span> <span class="n">msmd</span><span class="o">.</span><span class="n">exposuretime</span><span class="p">(</span><span class="n">scan</span><span class="o">=</span><span class="n">scan_id</span><span class="p">,</span> <span class="n">spwid</span><span class="o">=</span><span class="n">spw_id</span><span class="p">,</span> <span class="n">obsid</span><span class="o">=</span><span class="n">obs_id</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">spw_id</span> <span class="ow">in</span> <span class="n">spwsforscans</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)]}</span>

                <span class="n">scan_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan_number_col</span> <span class="o">==</span> <span class="n">scan_id</span><span class="p">)</span>

                <span class="c1"># get the antennas used for this scan </span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Calculating antennas used for scan </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">)</span>
                <span class="n">antenna_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">scan_antenna1</span> <span class="o">=</span> <span class="n">antenna1_col</span><span class="p">[</span><span class="n">scan_mask</span><span class="p">]</span>
                <span class="n">scan_antenna2</span> <span class="o">=</span> <span class="n">antenna2_col</span><span class="p">[</span><span class="n">scan_mask</span><span class="p">]</span> 
                <span class="n">antenna_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scan_antenna1</span><span class="p">)</span>
                <span class="n">antenna_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scan_antenna2</span><span class="p">)</span>
                <span class="n">antennas</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">antennas</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">antenna_ids</span><span class="p">]</span>

                <span class="c1"># get the data descriptions for this scan</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Calculating data descriptions used for scan </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">)</span>
                <span class="n">scan_data_desc_id</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">data_desc_id_col</span><span class="p">[</span><span class="n">scan_mask</span><span class="p">])</span>
                <span class="n">data_descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">data_descriptions</span> <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">scan_data_desc_id</span><span class="p">]</span>

                <span class="c1"># times are specified per data description, so we must</span>
                <span class="c1"># re-mask and calculate times per dd</span>
                <span class="n">scan_times</span> <span class="o">=</span> <span class="p">{}</span>  
                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Processing scan times for scan </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">data_descriptions</span><span class="p">:</span>
                    <span class="n">dd_mask</span> <span class="o">=</span> <span class="n">scan_mask</span> <span class="o">&amp;</span> <span class="n">data_desc_mask_dict</span><span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

                    <span class="n">raw_midpoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">time_col</span><span class="p">[</span><span class="n">dd_mask</span><span class="p">])</span>
                    <span class="n">epoch_midpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">mt</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="n">time_ref</span><span class="p">,</span> <span class="n">qt</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">))</span>
                                       <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">raw_midpoints</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">raw_midpoints</span><span class="p">))]</span>

                    <span class="n">scan_times</span><span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">epoch_midpoints</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">exposures</span><span class="p">[</span><span class="n">dd</span><span class="o">.</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">])))</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Creating domain object for scan </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">scan_id</span><span class="p">)</span>
                <span class="n">scan</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">Scan</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">scan_id</span><span class="p">,</span> <span class="n">states</span><span class="o">=</span><span class="n">states</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">data_descriptions</span><span class="o">=</span><span class="n">data_descriptions</span><span class="p">,</span>
                                   <span class="n">antennas</span><span class="o">=</span><span class="n">antennas</span><span class="p">,</span> <span class="n">scan_times</span><span class="o">=</span><span class="n">scan_times</span><span class="p">,</span> <span class="n">intents</span><span class="o">=</span><span class="n">intents</span><span class="p">)</span>
                <span class="n">scans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">scans</span>

<div class="viewcode-block" id="MeasurementSetReader.add_band_to_spws">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.MeasurementSetReader.html#pipeline.infrastructure.tablereader.MeasurementSetReader.add_band_to_spws">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_band_to_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets spw.band, which is a string describing a band. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">observatory</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        
        <span class="c1"># This dict is only populated if the spw&#39;s band number cannot be determined from its name for ALMA.</span>
        <span class="n">alma_receiver_band</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;WVR&#39;</span><span class="p">:</span>
                <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;WVR&#39;</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;For MS </span><span class="si">{}</span><span class="s2">, SpW </span><span class="si">{}</span><span class="s2">, setting band to WVR.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="k">continue</span>

            <span class="c1"># Determining the band number for ALMA data </span>
            <span class="c1">#</span>
            <span class="c1"># First, try to determine the band number from the spw name</span>
            <span class="c1"># The expected format is something like ALMA_RB_03#BB_1#SW-01#FULL_RES</span>
            <span class="c1"># If this doesn&#39;t work and this is ALMA data, try to get the band number from the ASDM_RECEIVER table</span>
            <span class="c1"># If this also fails, then set the band number using a look-up-table. </span>
            <span class="c1">#</span>
            <span class="c1"># See: PIPE-140 or PIPE-1078</span>
            <span class="c1">#</span>
            <span class="n">alma_band_regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;ALMA_RB_(?P&lt;band&gt;\d+)&#39;</span>
            <span class="n">match_found</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">alma_band_regex</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match_found</span><span class="p">:</span>
                <span class="n">band_str</span> <span class="o">=</span> <span class="n">match_found</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
                <span class="n">band_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">band_str</span><span class="p">)</span>
                <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;ALMA Band </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">band_num</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;For MS </span><span class="si">{}</span><span class="s2">, SpW </span><span class="si">{}</span><span class="s2">, setting band to </span><span class="si">{}</span><span class="s2">, based on the SPW name.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">band</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">observatory</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">alma_receiver_band</span><span class="p">:</span>
                    <span class="n">alma_receiver_band</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_receiver_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">get_band_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">alma_receiver_band</span><span class="p">:</span>
                    <span class="n">match_receiver_band</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">alma_band_regex</span><span class="p">,</span> <span class="n">alma_receiver_band</span><span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">match_receiver_band</span><span class="p">:</span>
                        <span class="n">band_str</span> <span class="o">=</span> <span class="n">match_receiver_band</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()[</span><span class="s1">&#39;band&#39;</span><span class="p">]</span>
                        <span class="n">band_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">band_str</span><span class="p">)</span>
                        <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="s1">&#39;ALMA Band </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">band_num</span> 
                        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;For MS </span><span class="si">{}</span><span class="s2">, SpW </span><span class="si">{}</span><span class="s2">, setting band to </span><span class="si">{}</span><span class="s2">, based on ASDM_RECEIVER table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">band</span><span class="p">))</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;For MS </span><span class="si">{}</span><span class="s2">, SpW </span><span class="si">{}</span><span class="s2">, could not find band number information in ALMA_RECEIVER table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

            <span class="c1"># If both fail for ALMA, set the band number as follows: </span>
            <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">BandDescriber</span><span class="o">.</span><span class="n">get_description</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">ref_frequency</span><span class="p">,</span> <span class="n">observatory</span><span class="o">=</span><span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;For MS </span><span class="si">{}</span><span class="s2">, SpW </span><span class="si">{}</span><span class="s2">, setting band to </span><span class="si">{}</span><span class="s2">, based on Pipeline internal look-up table.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">spw</span><span class="o">.</span><span class="n">band</span><span class="p">))</span>

            <span class="c1"># Used EVLA band name from spw instead of frequency range</span>

            <span class="k">if</span> <span class="n">observatory</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">):</span>
                <span class="n">spw2band</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_vla_spw2band</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">EVLA_band</span> <span class="o">=</span> <span class="n">spw2band</span><span class="p">[</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Unable to get band from spw id - using reference frequency instead&#39;</span><span class="p">)</span>
                    <span class="n">freqHz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">ref_frequency</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">EVLA_band</span> <span class="o">=</span> <span class="n">find_EVLA_band</span><span class="p">(</span><span class="n">freqHz</span><span class="p">)</span>

                <span class="n">EVLA_band_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;4&#39;</span><span class="p">:</span> <span class="s1">&#39;4m (4)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;P&#39;</span><span class="p">:</span> <span class="s1">&#39;90cm (P)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;L&#39;</span><span class="p">:</span> <span class="s1">&#39;20cm (L)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;S&#39;</span><span class="p">:</span> <span class="s1">&#39;13cm (S)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="s1">&#39;6cm (C)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;X&#39;</span><span class="p">:</span> <span class="s1">&#39;3cm (X)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="s1">&#39;2cm (Ku)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;K&#39;</span><span class="p">:</span> <span class="s1">&#39;1.3cm (K)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;A&#39;</span><span class="p">:</span> <span class="s1">&#39;1cm (Ka)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="s1">&#39;0.7cm (Q)&#39;</span><span class="p">}</span>

                <span class="n">spw</span><span class="o">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">EVLA_band_dict</span><span class="p">[</span><span class="n">EVLA_band</span><span class="p">]</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_spectralspec_spwmap</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">spectralspec_spwmap</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_spectralspec_to_spwid_map</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_spectralspec_to_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
        <span class="c1"># For ALMA, extract spectral spec from spw name.</span>
        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">spw</span><span class="o">.</span><span class="n">spectralspec</span> <span class="o">=</span> <span class="n">spw</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_intents_to_spws</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="c1"># we can&#39;t use msmd.intentsforspw directly as we may have a modified</span>
        <span class="c1"># obsmode mapping</span>

        <span class="n">scansforspws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforspws</span><span class="p">()</span>

        <span class="c1"># with one scan containing many spws, many of the statesforscan</span>
        <span class="c1"># arguments are repeated. This cache speeds up the subsequent</span>
        <span class="c1"># duplicate calls.</span>
        <span class="k">class</span> <span class="nc">StatesCache</span><span class="p">(</span><span class="n">cachetools</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">msmd</span><span class="o">.</span><span class="n">statesforscan</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">cached_states</span> <span class="o">=</span> <span class="n">StatesCache</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span><span class="p">:</span>
            <span class="n">scan_ids</span> <span class="o">=</span> <span class="n">scansforspws</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">)]</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cached_states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scan_ids</span><span class="p">]</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">state_ids</span><span class="p">))</span>
            <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">states</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">state_ids</span><span class="p">]</span> 

            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
                <span class="n">spw</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>

            <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Intents for spw #</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">spw</span><span class="o">.</span><span class="n">intents</span><span class="p">)))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_fields_to_states</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="c1"># for each field..</span>

        <span class="k">class</span> <span class="nc">StatesCache</span><span class="p">(</span><span class="n">cachetools</span><span class="o">.</span><span class="n">LRUCache</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__missing__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">msmd</span><span class="o">.</span><span class="n">statesforscan</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">cached_states</span> <span class="o">=</span> <span class="n">StatesCache</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="c1"># Find the state IDs for the field by first identifying the scans</span>
            <span class="c1"># for the field, then finding the state IDs for those scans</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">scan_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Field &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not in scansforfields dictionary.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">state_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">cached_states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">scan_ids</span><span class="p">]</span>
            <span class="c1"># flatten the state IDs to a 1D list</span>
            <span class="n">state_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">state_ids</span><span class="p">))</span>
            <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="n">ms</span><span class="o">.</span><span class="n">get_state</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">state_ids</span><span class="p">]</span>

            <span class="c1"># some scans may have multiple fields and/or intents so</span>
            <span class="c1"># it is necessary to distinguish which intents belong to</span>
            <span class="c1"># each field</span>
            <span class="n">obs_modes_for_field</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">intentsforfield</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">states_for_field</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">states</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">obs_modes_for_field</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">obs_mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">))]</span>

            <span class="n">field</span><span class="o">.</span><span class="n">states</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">states_for_field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states_for_field</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">intents</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">intents</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_fields_to_sources</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>        
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
            <span class="n">field_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforsource</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">]</span>

            <span class="n">source</span><span class="o">.</span><span class="n">fields</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">fields</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
                <span class="n">field</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">link_spws_to_fields</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">spwsforfields</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforfields</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span> <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">spwsforfields</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">)]]</span>
                <span class="n">field</span><span class="o">.</span><span class="n">valid_spws</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spws</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Field &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; not in spwsforfields dictionary.&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_measurement_set</span><span class="p">(</span><span class="n">ms_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Analysing </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms_file</span><span class="p">))</span>
        <span class="n">ms</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">(</span><span class="n">ms_file</span><span class="p">)</span>

        <span class="c1"># populate ms properties with results of table readers</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSMDReader</span><span class="p">(</span><span class="n">ms_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">msmd</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.antenna_array...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">antenna_array</span> <span class="o">=</span> <span class="n">AntennaTable</span><span class="o">.</span><span class="n">get_antenna_array</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.spectral_windows...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span> <span class="o">=</span> <span class="n">RetrieveByIndexContainer</span><span class="p">(</span><span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_spectral_windows</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.states...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="n">RetrieveByIndexContainer</span><span class="p">(</span><span class="n">StateTable</span><span class="o">.</span><span class="n">get_states</span><span class="p">(</span><span class="n">msmd</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.fields...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">RetrieveByIndexContainer</span><span class="p">(</span><span class="n">FieldTable</span><span class="o">.</span><span class="n">get_fields</span><span class="p">(</span><span class="n">msmd</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.sources...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">RetrieveByIndexContainer</span><span class="p">(</span><span class="n">SourceTable</span><span class="o">.</span><span class="n">get_sources</span><span class="p">(</span><span class="n">msmd</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.data_descriptions...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">data_descriptions</span> <span class="o">=</span> <span class="n">RetrieveByIndexContainer</span><span class="p">(</span><span class="n">DataDescriptionTable</span><span class="o">.</span><span class="n">get_descriptions</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.polarizations...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">polarizations</span> <span class="o">=</span> <span class="n">PolarizationTable</span><span class="o">.</span><span class="n">get_polarizations</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.correlator_name...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">correlator_name</span> <span class="o">=</span> <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">_get_correlator_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

            <span class="c1"># For now the SBSummary table is ALMA specific</span>
            <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">():</span>
                <span class="n">sbinfo</span> <span class="o">=</span> <span class="n">SBSummaryTable</span><span class="o">.</span><span class="n">get_sbsummary_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">())</span>

                <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">repSource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span><span class="s1">&#39;Unable to identify representative target for </span><span class="si">%s</span><span class="s1">. Will try to fall back to existing&#39;</span>
                                  <span class="s1">&#39; science target sources in the imaging tasks.&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">repSource</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Representative target for </span><span class="si">%s</span><span class="s1"> is set to &quot;none&quot;. Will try to fall back to existing&#39;</span>
                                    <span class="s1">&#39; science target sources or calibrators in the imaging tasks.&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.representative_target ...&#39;</span><span class="p">)</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">representative_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">sbinfo</span><span class="o">.</span><span class="n">repSource</span><span class="p">,</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">repFrequency</span><span class="p">,</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">repBandwidth</span><span class="p">)</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">representative_window</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">repWindow</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.observing_modes...&#39;</span><span class="p">)</span>
                <span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span> <span class="o">=</span> <span class="n">SBSummaryTable</span><span class="o">.</span><span class="n">get_observing_modes</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.science_goals...&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">minAngResolution</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">maxAngResolution</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Only warn if the number of 12m antennas is greater than the number of 7m antennas</span>
                    <span class="c1"># and if the observation is not single dish</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">diameter</span> <span class="o">==</span> <span class="mf">12.0</span><span class="p">])</span> <span class="o">&gt;</span> \
                            <span class="nb">len</span><span class="p">([</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">get_antenna</span><span class="p">()</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">diameter</span> <span class="o">==</span> <span class="mf">7.0</span><span class="p">])</span> \
                            <span class="ow">and</span> <span class="s1">&#39;Standard Single Dish&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">observing_modes</span><span class="p">:</span>
                        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Undefined angular resolution limits for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0arcsec&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">:</span> <span class="s1">&#39;0.0arcsec&#39;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">:</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">minAngResolution</span><span class="p">,</span>
                                        <span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">:</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">maxAngResolution</span><span class="p">}</span>

                <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">maxAllowedBeamAxialRatio</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.0&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">maxAllowedBeamAxialRatio</span>

                <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">sensitivity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0.0mJy&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">sensitivity</span>

                <span class="k">if</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">dynamicRange</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;dynamicRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;dynamicRange&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">dynamicRange</span>

                <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;spectralDynamicRangeBandWidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">spectralDynamicRangeBandWidth</span>

                <span class="n">ms</span><span class="o">.</span><span class="n">science_goals</span><span class="p">[</span><span class="s1">&#39;sbName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sbinfo</span><span class="o">.</span><span class="n">sbName</span>
            
                <span class="c1"># Populate the online ALMA Control Software names</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.acs_software_version and ms.acs_software_build_version...&#39;</span><span class="p">)</span>
                <span class="n">ms</span><span class="o">.</span><span class="n">acs_software_version</span><span class="p">,</span> <span class="n">ms</span><span class="o">.</span><span class="n">acs_software_build_version</span> <span class="o">=</span> \
                    <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">get_acs_software_version</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">msmd</span><span class="p">)</span>
                    
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.array_name...&#39;</span><span class="p">)</span>
            <span class="c1"># No MSMD functions to help populating the ASDM_EXECBLOCK table</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">array_name</span> <span class="o">=</span> <span class="n">ExecblockTable</span><span class="o">.</span><span class="n">get_execblock_info</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">openms</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">ms</span><span class="o">.</span><span class="n">data_descriptions</span><span class="p">:</span>
                    <span class="n">openms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">reset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># CAS-11207: from ~CASA 5.3pre89 onwards, getdata fails if</span>
                    <span class="c1"># the data selection does not select any datadd is</span>
                    <span class="c1"># missing. To compensate for this, selectinit now returns</span>
                    <span class="c1"># a boolean that indicates the status of data selection</span>
                    <span class="c1"># (True = selection contains data); this can be used to</span>
                    <span class="c1"># check that the subsequent getdata call will succeed.</span>
                    <span class="k">if</span> <span class="n">openms</span><span class="o">.</span><span class="n">selectinit</span><span class="p">(</span><span class="n">datadescid</span><span class="o">=</span><span class="n">dd</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
                        <span class="n">ms_info</span> <span class="o">=</span> <span class="n">openms</span><span class="o">.</span><span class="n">getdata</span><span class="p">([</span><span class="s1">&#39;axis_info&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>

                        <span class="n">dd</span><span class="o">.</span><span class="n">obs_time</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ms_info</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span>
                        <span class="n">dd</span><span class="o">.</span><span class="n">chan_freq</span> <span class="o">=</span> <span class="n">ms_info</span><span class="p">[</span><span class="s1">&#39;axis_info&#39;</span><span class="p">][</span><span class="s1">&#39;freq_axis&#39;</span><span class="p">][</span><span class="s1">&#39;chan_freq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                        <span class="n">dd</span><span class="o">.</span><span class="n">corr_axis</span> <span class="o">=</span> <span class="n">ms_info</span><span class="p">[</span><span class="s1">&#39;axis_info&#39;</span><span class="p">][</span><span class="s1">&#39;corr_axis&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="c1"># now back to pure MSMD calls</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Linking fields to states...&#39;</span><span class="p">)</span>
            <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">link_fields_to_states</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Linking fields to sources...&#39;</span><span class="p">)</span>
            <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">link_fields_to_sources</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Linking intents to spws...&#39;</span><span class="p">)</span>
            <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">link_intents_to_spws</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Linking spectral windows to fields...&#39;</span><span class="p">)</span>
            <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">link_spws_to_fields</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Populating ms.scans...&#39;</span><span class="p">)</span>
            <span class="n">ms</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">)</span>

            <span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">schedblock_id</span><span class="p">,</span> <span class="n">execblock_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">ObservationTable</span><span class="o">.</span><span class="n">get_project_info</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>

        <span class="c1"># Update spectral windows in ms with band and spectralspec.</span>
        <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">add_band_to_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">add_spectralspec_to_spws</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Populate mapping of spectralspecs to spws.</span>
        <span class="n">MeasurementSetReader</span><span class="o">.</span><span class="n">add_spectralspec_spwmap</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># work around NumPy bug with empty strings</span>
        <span class="c1"># http://projects.scipy.org/numpy/ticket/1239</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>

        <span class="n">ms</span><span class="o">.</span><span class="n">schedblock_id</span> <span class="o">=</span> <span class="n">schedblock_id</span>
        <span class="n">ms</span><span class="o">.</span><span class="n">execblock_id</span> <span class="o">=</span> <span class="n">execblock_id</span>

        <span class="k">return</span> <span class="n">ms</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_range</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">MSReader</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">ms</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">range</span><span class="p">([</span><span class="n">column</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_correlator_name</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get correlator name information from the PROCESSOR table in the MS. </span>
<span class="sd">        </span>
<span class="sd">        The name is set to the value of the SUB_TYPE for the first row with</span>
<span class="sd">        CORRELATOR for its TYPE value. </span>

<span class="sd">        :param ms: the measurements set to get the correlator name for</span>
<span class="sd">        :return: the correlator name</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">correlator_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/PROCESSOR&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">tb1</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;TYPE==&#39;CORRELATOR&#39;&quot;</span><span class="p">)</span>
                <span class="n">sub_types_col</span> <span class="o">=</span> <span class="n">tb1</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SUB_TYPE&#39;</span><span class="p">)</span>
                <span class="n">tb1</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_types_col</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">correlator_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">sub_types_col</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No correlator name could be found for </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">correlator_name</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Error while populating correlator name for </span><span class="si">{}</span><span class="s2">, error: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">correlator_name</span>

<div class="viewcode-block" id="MeasurementSetReader.get_acs_software_version">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.MeasurementSetReader.html#pipeline.infrastructure.tablereader.MeasurementSetReader.get_acs_software_version">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_acs_software_version</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">msmd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the ALMA Common Software version and build version from the ASDM_ANNOTATION table. </span>

<span class="sd">        Returns: </span>
<span class="sd">            A tuple containing a string with the ACS software version, then a string with </span>
<span class="sd">            the ACS software build version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">acs_software_version</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="n">acs_software_build_version</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>

        <span class="n">annotation_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;ASDM_ANNOTATION&#39;</span><span class="p">)</span> 
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">annotation_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="n">acs_software_details</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c1"># This value can be &quot;WARNING: No ACS_TAG available&quot; in the ASDM_ANNOTATION table.</span>
                <span class="k">if</span> <span class="s2">&quot;WARNING&quot;</span> <span class="ow">in</span> <span class="n">acs_software_details</span><span class="p">:</span> 
                    <span class="n">acs_software_version</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">acs_software_version</span> <span class="o">=</span> <span class="n">acs_software_details</span>

                <span class="n">acs_software_build_version</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;details&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to read Annotation table information for MS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">acs_software_version</span><span class="p">,</span> <span class="n">acs_software_build_version</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SpectralWindowTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable">[docs]</a>
<span class="k">class</span> <span class="nc">SpectralWindowTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_spectral_windows</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="c1"># map spw ID to spw type</span>
        <span class="n">spw_types</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="s1">&#39;FDM&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fdmspws</span><span class="p">()}</span>
        <span class="n">spw_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="s1">&#39;TDM&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">tdmspws</span><span class="p">()})</span>
        <span class="n">spw_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="s1">&#39;WVR&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">wvrspws</span><span class="p">()})</span>
        <span class="n">spw_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="s1">&#39;CHANAVG&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanavgspws</span><span class="p">()})</span>
        <span class="n">spw_types</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">i</span><span class="p">:</span> <span class="s1">&#39;SQLD&#39;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">almaspws</span><span class="p">(</span><span class="n">sqld</span><span class="o">=</span><span class="kc">True</span><span class="p">)})</span>

        <span class="c1"># these msmd functions don&#39;t need a spw argument. They return a list of</span>
        <span class="c1"># values, one for each spw</span>
        <span class="n">spw_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">namesforspws</span><span class="p">()</span>            
        <span class="n">bandwidths</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">bandwidths</span><span class="p">()</span>

        <span class="c1"># We need the first TARGET source ID to get the correct transitions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_target_field_id</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforintent</span><span class="p">(</span><span class="s1">&#39;*TARGET*&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">first_target_source_id</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">sourceidforfield</span><span class="p">(</span><span class="n">first_target_field_id</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">first_target_source_id</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">target_spw_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwsforintent</span><span class="p">(</span><span class="s1">&#39;*TARGET*&#39;</span><span class="p">)</span>

        <span class="c1"># Read in information on receiver for current MS.</span>
        <span class="n">receiver_info</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_receiver_info</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Read in information about the SDM_NUM_BIN column for the current ms</span>
        <span class="n">sdm_num_bins</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_sdm_num_bin_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">msmd</span><span class="p">)</span>

        <span class="c1"># PIPE-1538: Compute median feed receptor angle.</span>
        <span class="n">receptor_angle_info</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_receptor_angle</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="n">spws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spw_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spw_names</span><span class="p">):</span>
            <span class="c1"># get this spw&#39;s values from our precalculated lists and dicts</span>
            <span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">spw_type</span> <span class="o">=</span> <span class="n">spw_types</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;UNKNOWN&#39;</span><span class="p">)</span>

            <span class="c1"># the following msmd functions need a spw argument, so they have</span>
            <span class="c1"># to be contained within the spw loop</span>
            <span class="n">mean_freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">meanfreq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">chan_freqs</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanfreqs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">chan_widths</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chanwidths</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>         
            <span class="n">chan_effective_bws</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">chaneffbws</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">sideband</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">sideband</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># BBC_NO column is optional</span>
            <span class="k">if</span> <span class="s1">&#39;NRO&#39;</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">():</span>
                <span class="c1"># For Nobeyama (TODO: how to define BBC_NO for NRO)</span>
                <span class="n">baseband</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">baseband</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">baseband</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">ref_freq</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">reffreq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            
            <span class="c1"># Read transitions for target spws.</span>

            <span class="c1"># PIPE-2124: Missing of the TRANSITION column (e.g. old data) or lack of (sourceid, spwid) entries</span>
            <span class="c1"># in the SOURCE table might cause dubious &quot;SEVERE&quot; messages. Here we temporarily filter out them and</span>
            <span class="c1"># later replace with generic messages of missing the transition metadata in the MS subtable.</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">with</span> <span class="n">logging</span><span class="o">.</span><span class="n">log_filtermsg</span><span class="p">(</span><span class="s1">&#39;SOURCE table does not contain a row&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">target_spw_ids</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># The msmd.transitions(..) call below can return a boolean value of False or</span>
                        <span class="c1"># a Numpy array with dtype=numpy.str_ , e.g.,</span>
                        <span class="c1">#   CASA &lt;15&gt;: msmd.transitions(sourceid=2,spw=16)</span>
                        <span class="c1">#   Out[15]: array([&#39;N2H__v_0_J_1_0(ID=3925982)&#39;], dtype=&#39;&lt;U26&#39;)</span>
                        <span class="c1"># For invalid source/spw combinations, the call could also trigger an exception with a RuntimeError.</span>
                        <span class="c1"># Also see: https://casadocs.readthedocs.io/en/latest/api/tt/casatools.msmetadata.html#casatools.msmetadata.msmetadata.transitions</span>
                        <span class="n">transitions</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">transitions</span><span class="p">(</span><span class="n">sourceid</span><span class="o">=</span><span class="n">first_target_source_id</span><span class="p">,</span> <span class="n">spw</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="k">if</span> <span class="n">transitions</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No transition info available for SOURCE_ID=</span><span class="si">%s</span><span class="s1"> and SPECTRAL_WINDOW_ID=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">first_target_source_id</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Unknown&#39;</span><span class="p">]</span>

            <span class="c1"># Create simple name for spectral window if none was provided.</span>
            <span class="k">if</span> <span class="n">spw_name</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="n">spw_name</span> <span class="o">=</span> <span class="s1">&#39;spw_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="c1"># Extract receiver type and LO frequencies for current spw.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">receiver</span><span class="p">,</span> <span class="n">freq_lo</span> <span class="o">=</span> <span class="n">receiver_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No receiver info available for MS </span><span class="si">{}</span><span class="s2"> spw id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">receiver</span><span class="p">,</span> <span class="n">freq_lo</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Extract feed receptor angle for current spw.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">median_receptor_angle</span> <span class="o">=</span> <span class="n">receptor_angle_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No feed info available for MS </span><span class="si">{}</span><span class="s2"> spw id </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">),</span> <span class="n">i</span><span class="p">))</span>
                <span class="n">median_receptor_angle</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># If the earlier get_sdm_num_bin_info call returned None, need to set sdm_num_bin value to None for each spw</span>
            <span class="k">if</span> <span class="n">sdm_num_bins</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="n">sdm_num_bin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">sdm_num_bin</span> <span class="o">=</span> <span class="n">sdm_num_bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Fetch and add correlation bits information</span>
            <span class="n">correlation_bits</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">corrbit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">spw</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">SpectralWindow</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">spw_name</span><span class="p">,</span> <span class="n">spw_type</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">ref_freq</span><span class="p">,</span> <span class="n">mean_freq</span><span class="p">,</span> <span class="n">chan_freqs</span><span class="p">,</span> <span class="n">chan_widths</span><span class="p">,</span>
                                        <span class="n">chan_effective_bws</span><span class="p">,</span> <span class="n">sideband</span><span class="p">,</span> <span class="n">baseband</span><span class="p">,</span> <span class="n">receiver</span><span class="p">,</span> <span class="n">freq_lo</span><span class="p">,</span>
                                        <span class="n">transitions</span><span class="o">=</span><span class="n">transitions</span><span class="p">,</span> <span class="n">sdm_num_bin</span><span class="o">=</span><span class="n">sdm_num_bin</span><span class="p">,</span> <span class="n">correlation_bits</span><span class="o">=</span><span class="n">correlation_bits</span><span class="p">,</span>
                                        <span class="n">median_receptor_angle</span><span class="o">=</span><span class="n">median_receptor_angle</span><span class="p">)</span>
            <span class="n">spws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spws</span>

<div class="viewcode-block" id="SpectralWindowTable.get_receptor_angle">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_receptor_angle">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_receptor_angle</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract information about the feed receptor angle from the FEED table&#39;s</span>
<span class="sd">        RECEPTOR_ANGLE column, and compute an average value over all antennas</span>
<span class="sd">        for each SpW.</span>
<span class="sd">        Return: a dict in which each MS SpW corresponds to an array of angles,</span>
<span class="sd">        or an empty dict in case of error.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get mapping of ASDM spectral window id to MS spectral window id.</span>
        <span class="n">asdm_to_ms_spw_map</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_asdm_to_ms_spw_mapping</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Construct path to FEED table.</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">feed_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="s1">&#39;FEED&#39;</span><span class="p">)</span>

        <span class="n">angle_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">feed_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="c1"># Extract the ASDM spw ids column.</span>
                <span class="n">asdm_spwids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SPECTRAL_WINDOW_ID&#39;</span><span class="p">)))</span>

                <span class="c1"># Go through the table row-by-row, and extract info for each</span>
                <span class="c1"># ASDM spwid encountered:</span>
                <span class="k">for</span> <span class="n">asdm_spwid</span> <span class="ow">in</span> <span class="n">asdm_spwids</span><span class="p">:</span>
                    <span class="c1"># Get MS spwid corresponding to the current ASDM spwid.</span>
                    <span class="n">ms_spwid</span> <span class="o">=</span> <span class="n">asdm_to_ms_spw_map</span><span class="p">[</span><span class="n">asdm_spwid</span><span class="p">]</span>

                    <span class="c1"># Compute median feed angle, discarding non-linear polarizations.</span>
                    <span class="n">tsel</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SPECTRAL_WINDOW_ID == </span><span class="si">{</span><span class="n">ms_spwid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">angle</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;RECEPTOR_ANGLE&#39;</span><span class="p">)</span>
                    <span class="n">pol</span> <span class="o">=</span> <span class="n">tsel</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;POLARIZATION_TYPE&#39;</span><span class="p">)</span>
                    <span class="n">use</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Y&#39;</span><span class="p">)</span>
                    <span class="n">angle</span><span class="p">[</span><span class="o">~</span><span class="n">use</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">nan</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">angle</span><span class="p">)):</span>
                        <span class="n">angle_info</span><span class="p">[</span><span class="n">ms_spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">tsel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to read feed info for MS </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">),</span> <span class="n">ex</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">angle_info</span></div>


<div class="viewcode-block" id="SpectralWindowTable.get_sdm_num_bin_info">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_sdm_num_bin_info">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_sdm_num_bin_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">msmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract information about the online spectral averaging from the SPECTRAL_WINDOW</span>
<span class="sd">        table&#39;s SDM_NUM_BIN column.</span>
<span class="sd">        </span>
<span class="sd">        :param ms: measurement set to inspect</span>
<span class="sd">        :param msmd: msmetadata (casa_tools.MSMDReader) for the measurement set.</span>
<span class="sd">        :return: list of values for sdm_num_bin</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Read and return the online spectral averaging information if available</span>
        <span class="n">sdm_num_bin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">()</span> <span class="ow">or</span> <span class="s1">&#39;EVLA&#39;</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;/SPECTRAL_WINDOW&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SDM_NUM_BIN&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">():</span>
                    <span class="n">sdm_num_bin</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SDM_NUM_BIN&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SDM_NUM_BIN does not exist in the SPECTRAL_WINDOW Table of MS </span><span class="si">{</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sdm_num_bin</span></div>


<div class="viewcode-block" id="SpectralWindowTable.get_receiver_info">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_receiver_info">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_receiver_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">get_band_info</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract information about the receiver from the ASDM_RECEIVER table.</span>
<span class="sd">        The following properties are extracted by default:</span>
<span class="sd">        * receiver type (e.g.: TSB, DSB, NOSB)</span>
<span class="sd">        * local oscillator frequencies</span>

<span class="sd">        If get_band_info is set to True, instead, only the frequency </span>
<span class="sd">        band information is extracted. </span>

<span class="sd">        If multiple entries are present for the same ASDM spwid, then keep</span>

<span class="sd">        :param ms: measurement set to inspect</span>
<span class="sd">        :return: dict of MS spw: (receiver_type, freq_lo) or MS spw: frequency_band</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get mapping of ASDM spectral window id to MS spectral window id.</span>
        <span class="n">asdm_to_ms_spw_map</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_asdm_to_ms_spw_mapping</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>

        <span class="c1"># Construct path to ASDM_RECEIVER table.</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">receiver_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="s1">&#39;ASDM_RECEIVER&#39;</span><span class="p">)</span>

        <span class="n">receiver_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read in required columns from table.</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">receiver_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="c1"># Extract the ASDM spw ids column.</span>
                <span class="n">spwids</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;spectralWindowId&#39;</span><span class="p">)</span>

                <span class="c1"># Go through the table row-by-row, and extract info for each</span>
                <span class="c1"># ASDM spwid encountered:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spwid</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spwids</span><span class="p">):</span>
                    <span class="c1"># Assume that ASDM spectral windows are stored as a string</span>
                    <span class="c1"># such as &quot;SpectralWindow_&lt;nn&gt;&quot;, where &lt;nn&gt; is the ID integer.</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">asdm_spwid</span> <span class="o">=</span> <span class="n">spwid</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>

                    <span class="c1"># Get MS spwid corresponding to the current ASDM spwid.</span>
                    <span class="n">ms_spwid</span> <span class="o">=</span> <span class="n">asdm_to_ms_spw_map</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">asdm_spwid</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="n">get_band_info</span><span class="p">:</span> 
                        <span class="c1"># Add and return frequency band information stored in receiver table </span>
                        <span class="k">if</span> <span class="n">ms_spwid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">receiver_info</span><span class="p">:</span>
                            <span class="n">receiver_info</span><span class="p">[</span><span class="n">ms_spwid</span><span class="p">]</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s2">&quot;frequencyBand&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Add the information from the current row if either:</span>
                        <span class="c1">#  a.) no info for the current spwid was stored yet.</span>
                        <span class="c1">#  b.) info was already stored for the current spwid, but</span>
                        <span class="c1">#      this info was not for receiver type of &quot;TSB&quot; or &quot;DSB&quot;.</span>
                        <span class="c1"># This will store one entry for each ASDM spwid encountered,</span>
                        <span class="c1"># preferentially the first TSB/DSB row in the table</span>
                        <span class="c1"># corresponding to the spwid, but otherwise the first</span>
                        <span class="c1"># non-TSB/DSB row corresponding to the spwid.</span>
                        <span class="k">if</span> <span class="n">ms_spwid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">receiver_info</span> <span class="ow">or</span> <span class="n">receiver_info</span><span class="p">[</span><span class="n">ms_spwid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TSB&quot;</span><span class="p">,</span> <span class="s2">&quot;DSB&quot;</span><span class="p">]:</span>
                            <span class="n">receiver_info</span><span class="p">[</span><span class="n">ms_spwid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s2">&quot;receiverSideband&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcell</span><span class="p">(</span><span class="s2">&quot;freqLO&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Unable to read receiver info for MS </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">)))</span>
            <span class="n">receiver_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">receiver_info</span></div>


<div class="viewcode-block" id="SpectralWindowTable.parse_spectral_window_ids_from_xml">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.parse_spectral_window_ids_from_xml">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_spectral_window_ids_from_xml</span><span class="p">(</span><span class="n">xml_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the spectral window ID element from each row of an XML file.</span>

<span class="sd">        :param xml_path: path for XML file</span>
<span class="sd">        :return: list of integer spectral window IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">root_element</span> <span class="o">=</span> <span class="n">ElementTree</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">root_element</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;row&#39;</span><span class="p">):</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s1">&#39;spectralWindowId&#39;</span><span class="p">)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">str_id</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">str_id</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Could not parse XML at: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xml_path</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ids</span></div>


<div class="viewcode-block" id="SpectralWindowTable.get_data_description_spw_ids">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_data_description_spw_ids">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_data_description_spw_ids</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a list of spectral window IDs from the DataDescription XML for an</span>
<span class="sd">        ASDM.</span>

<span class="sd">        This function assumes the XML has been copied across to the measurement</span>
<span class="sd">        set directory.</span>

<span class="sd">        :param ms: measurement set to inspect</span>
<span class="sd">        :return: list of integers corresponding to ASDM spectral window IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;DataDescription.xml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml_path</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No DataDescription XML found at </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xml_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">parse_spectral_window_ids_from_xml</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SpectralWindowTable.get_spectral_window_spw_ids">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_spectral_window_spw_ids">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_spectral_window_spw_ids</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract a list of spectral window IDs from the SpectralWindow XML for an</span>
<span class="sd">        ASDM.</span>

<span class="sd">        This function assumes the XML has been copied across to the measurement</span>
<span class="sd">        set directory.</span>

<span class="sd">        :param ms: measurement set to inspect</span>
<span class="sd">        :return: list of integers corresponding to ASDM spectral window IDs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;SpectralWindow.xml&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xml_path</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No SpectralWindow XML found at </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xml_path</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">parse_spectral_window_ids_from_xml</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="SpectralWindowTable.get_asdm_to_ms_spw_mapping">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SpectralWindowTable.html#pipeline.infrastructure.tablereader.SpectralWindowTable.get_asdm_to_ms_spw_mapping">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_asdm_to_ms_spw_mapping</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the mapping of ASDM spectral window ID to Measurement Set spectral</span>
<span class="sd">        window ID.</span>

<span class="sd">        This function requires the SpectralWindow and DataDescription ASDM XML</span>
<span class="sd">        files to have been copied across to the measurement set directory.</span>

<span class="sd">        :param ms: measurement set to inspect</span>
<span class="sd">        :return: dict of ASDM spw: MS spw</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dd_spws</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_data_description_spw_ids</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">spw_spws</span> <span class="o">=</span> <span class="n">SpectralWindowTable</span><span class="o">.</span><span class="n">get_spectral_window_spw_ids</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">asdm_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spw_spws</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dd_spws</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">spw_spws</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dd_spws</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">asdm_ids</span><span class="p">,</span> <span class="n">spw_spws</span><span class="p">)}</span></div>
</div>



<div class="viewcode-block" id="ObservationTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.ObservationTable.html#pipeline.infrastructure.tablereader.ObservationTable">[docs]</a>
<span class="k">class</span> <span class="nc">ObservationTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_project_info</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">projects</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">observer</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observers</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">schedblock_id</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>
        <span class="n">execblock_id</span> <span class="o">=</span> <span class="s1">&#39;N/A&#39;</span>

        <span class="n">obsnames</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">obsnames</span> <span class="ow">or</span> <span class="s1">&#39;VLA&#39;</span> <span class="ow">in</span> <span class="n">obsnames</span> <span class="ow">or</span> <span class="s1">&#39;EVLA&#39;</span> <span class="ow">in</span> <span class="n">obsnames</span><span class="p">:</span>
            <span class="c1"># TODO this would break if &gt; 1 observation in an EB. Can that</span>
            <span class="c1"># ever happen?</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

            <span class="n">schedblock_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;SchedulingBlock&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
            <span class="n">execblock_id</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ExecBlock&#39;</span><span class="p">,</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">observer</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">schedblock_id</span><span class="p">,</span> <span class="n">execblock_id</span></div>



<div class="viewcode-block" id="AntennaTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.AntennaTable.html#pipeline.infrastructure.tablereader.AntennaTable">[docs]</a>
<span class="k">class</span> <span class="nc">AntennaTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_antenna_array</span><span class="p">(</span><span class="n">msmd</span><span class="p">:</span> <span class="n">MSMDReader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AntennaArray</span><span class="p">:</span>
        <span class="n">position</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">observatoryposition</span><span class="p">()</span>            
        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">antennas</span> <span class="o">=</span> <span class="n">AntennaTable</span><span class="o">.</span><span class="n">get_antennas</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">AntennaArray</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">antennas</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_antennas</span><span class="p">(</span><span class="n">msmd</span><span class="p">:</span> <span class="n">MSMDReader</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Antenna</span><span class="p">]:</span>
        <span class="n">antenna_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;ANTENNA&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Opening ANTENNA table to read ANTENNA.FLAG_ROW&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">antenna_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;FLAG_ROW&#39;</span><span class="p">)</span>

        <span class="n">antennas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">station</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">antennaids</span><span class="p">(),</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennanames</span><span class="p">(),</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennastations</span><span class="p">()):</span>
            <span class="c1"># omit this antenna if it has been flagged</span>
            <span class="k">if</span> <span class="n">flags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">continue</span>

            <span class="n">position</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennaposition</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">antennaoffset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">diameter_m</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">antennadiameter</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s1">&#39;m&#39;</span><span class="p">)</span>
            <span class="n">diameter</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="n">diameter_m</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">antenna</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">Antenna</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">station</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>
            <span class="n">antennas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">antenna</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">antennas</span></div>



<div class="viewcode-block" id="DataDescriptionTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.DataDescriptionTable.html#pipeline.infrastructure.tablereader.DataDescriptionTable">[docs]</a>
<span class="k">class</span> <span class="nc">DataDescriptionTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_descriptions</span><span class="p">(</span><span class="n">msmd</span><span class="p">,</span> <span class="n">ms</span><span class="p">):</span>
        <span class="n">spws</span> <span class="o">=</span> <span class="n">ms</span><span class="o">.</span><span class="n">spectral_windows</span>
        <span class="c1"># read the data descriptions table and create the objects</span>
        <span class="n">descriptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">DataDescriptionTable</span><span class="o">.</span><span class="n">_create_data_description</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="o">*</span><span class="n">row</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DataDescriptionTable</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">descriptions</span>            

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_data_description</span><span class="p">(</span><span class="n">spws</span><span class="p">,</span> <span class="n">dd_id</span><span class="p">,</span> <span class="n">spw_id</span><span class="p">,</span> <span class="n">pol_id</span><span class="p">):</span>
        <span class="c1"># find the SpectralWindow matching the given spectral window ID</span>
        <span class="n">matching_spws</span> <span class="o">=</span> <span class="p">[</span><span class="n">spw</span> <span class="k">for</span> <span class="n">spw</span> <span class="ow">in</span> <span class="n">spws</span> <span class="k">if</span> <span class="n">spw</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">spw_id</span><span class="p">]</span>
        <span class="n">spw</span> <span class="o">=</span> <span class="n">matching_spws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">DataDescription</span><span class="p">(</span><span class="n">dd_id</span><span class="p">,</span> <span class="n">spw</span><span class="p">,</span> <span class="n">pol_id</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the DATA_DESCRIPTION table of the given measurement set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analysing DATA_DESCRIPTION table&#39;</span><span class="p">)</span>

        <span class="n">dd_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">datadescids</span><span class="p">()</span>
        <span class="n">spw_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">spwfordatadesc</span><span class="p">()</span>
        <span class="n">pol_ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">polidfordatadesc</span><span class="p">()</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dd_ids</span><span class="p">,</span> <span class="n">spw_ids</span><span class="p">,</span> <span class="n">pol_ids</span><span class="p">))</span></div>



<span class="n">SBSummaryInfo</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span>
    <span class="s1">&#39;SBSummaryInfo&#39;</span><span class="p">,</span> <span class="s1">&#39;repSource repFrequency repBandwidth repWindow minAngResolution maxAngResolution &#39;</span>
                     <span class="s1">&#39;maxAllowedBeamAxialRatio sensitivity dynamicRange spectralDynamicRangeBandWidth sbName&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="SBSummaryTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SBSummaryTable.html#pipeline.infrastructure.tablereader.SBSummaryTable">[docs]</a>
<span class="k">class</span> <span class="nc">SBSummaryTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_sbsummary_info</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="n">obsnames</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sbsummary_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">SBSummaryTable</span><span class="o">.</span><span class="n">_create_sbsummary_info</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">SBSummaryTable</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">ms</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">sbsummary_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ALMA&#39;</span> <span class="ow">in</span> <span class="n">obsnames</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error reading science goals for </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">SBSummaryInfo</span><span class="p">(</span><span class="n">repSource</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repFrequency</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repBandwidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">repWindow</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">minAngResolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxAngResolution</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxAllowedBeamAxialRatio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="n">sensitivity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dynamicRange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sbName</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_observing_modes</span><span class="p">(</span><span class="n">ms</span><span class="p">:</span> <span class="n">domain</span><span class="o">.</span><span class="n">MeasurementSet</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">sbsummary_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="s1">&#39;ASDM_SBSUMMARY&#39;</span><span class="p">)</span>
        <span class="n">observing_modes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">sbsummary_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">observing_mode</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;observingMode&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tb</span><span class="o">.</span><span class="n">nrows</span><span class="p">()):</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">observing_mode</span><span class="p">[:,</span> <span class="n">irow</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">cell</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">observing_modes</span><span class="p">:</span>
                            <span class="n">observing_modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Error reading observing modes for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ms</span><span class="o">.</span><span class="n">basename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">observing_modes</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_sbsummary_info</span><span class="p">(</span><span class="n">repSource</span><span class="p">,</span> <span class="n">repFrequency</span><span class="p">,</span> <span class="n">repBandwidth</span><span class="p">,</span> <span class="n">repWindow</span><span class="p">,</span> <span class="n">minAngResolution</span><span class="p">,</span> <span class="n">maxAngResolution</span><span class="p">,</span>
                               <span class="n">maxAllowedBeamAxialRatio</span><span class="p">,</span> <span class="n">sensitivity</span><span class="p">,</span> <span class="n">dynamicRange</span><span class="p">,</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="p">,</span> <span class="n">sbName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SBSummaryInfo</span><span class="p">(</span><span class="n">repSource</span><span class="o">=</span><span class="n">repSource</span><span class="p">,</span> <span class="n">repFrequency</span><span class="o">=</span><span class="n">repFrequency</span><span class="p">,</span> <span class="n">repBandwidth</span><span class="o">=</span><span class="n">repBandwidth</span><span class="p">,</span>
                             <span class="n">repWindow</span><span class="o">=</span><span class="n">repWindow</span><span class="p">,</span> <span class="n">minAngResolution</span><span class="o">=</span><span class="n">minAngResolution</span><span class="p">,</span> <span class="n">maxAngResolution</span><span class="o">=</span><span class="n">maxAngResolution</span><span class="p">,</span>
                             <span class="n">maxAllowedBeamAxialRatio</span><span class="o">=</span><span class="n">maxAllowedBeamAxialRatio</span><span class="p">,</span> <span class="n">sensitivity</span><span class="o">=</span><span class="n">sensitivity</span><span class="p">,</span>
                             <span class="n">dynamicRange</span><span class="o">=</span><span class="n">dynamicRange</span><span class="p">,</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="o">=</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">,</span> <span class="n">sbName</span><span class="o">=</span><span class="n">sbName</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_table</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the ASDM_SBSummary table</span>
<span class="sd">        For all practical purposes this table consists of a single row</span>
<span class="sd">        but handle the more general case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analysing ASDM_SBSummary table&#39;</span><span class="p">)</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">sbsummary_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="s1">&#39;ASDM_SBSUMMARY&#39;</span><span class="p">)</span>        
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">sbsummary_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">scienceGoals</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;scienceGoal&#39;</span><span class="p">)</span>
            <span class="n">numScienceGoals</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;numScienceGoal&#39;</span><span class="p">)</span>

            <span class="c1"># shouldn&#39;t happen in a well-formed XML</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">)</span> <span class="o">!=</span> <span class="n">numScienceGoals</span><span class="p">:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">_get_ms_basename</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span><span class="si">}</span><span class="s1">: number of science goals found in the SB summary&#39;</span>
                            <span class="sa">f</span><span class="s1">&#39; (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">)</span><span class="si">}</span><span class="s1">) are fewer than the number that were declared (</span><span class="si">{</span><span class="n">numScienceGoals</span><span class="si">}</span><span class="s1">).&#39;</span><span class="p">)</span>

            <span class="n">repSources</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">repFrequencies</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">repBandWidths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">repWindows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">minAngResolutions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxAngResolutions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxAllowedBeamAxialRatios</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sensitivities</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">dynamicRanges</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">spectralDynamicRangeBandWidths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sbNames</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">nrows</span><span class="p">()):</span>

                <span class="c1"># Create source</span>
                <span class="n">repSource</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;representativeSource&#39;</span><span class="p">)</span>
                <span class="n">repSources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repSource</span><span class="p">)</span>

                <span class="c1"># Create frequency</span>
                <span class="n">repFrequencyGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;representativeFrequency&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repFrequencyGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">repFrequency</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">repFrequencyGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">repFrequency</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repFrequency</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">repFrequency</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">repFrequency</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">repFrequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repFrequency</span><span class="p">)</span>

                <span class="c1"># Create representative bandwidth</span>
                <span class="n">repBandWidthGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;representativeBandwidth&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repBandWidthGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">repBandWidth</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">repBandWidthGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">repBandWidth</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repBandWidth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">repBandWidth</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">repBandWidth</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">repBandWidths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repBandWidth</span><span class="p">)</span>

                <span class="c1"># Create window</span>
                <span class="n">repWindow</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;representativeWindow&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">repWindow</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                    <span class="n">repWindow</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">repWindows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">repWindow</span><span class="p">)</span>

                <span class="c1"># Create minimum and maximum angular resolution</span>
                <span class="n">minAngResolutionGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;minAcceptableAngResolution&#39;</span><span class="p">)</span>
                <span class="n">maxAngResolutionGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;maxAcceptableAngResolution&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">minAngResolutionGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">minAngResolution</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">minAngResolutionGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">minAngResolution</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">maxAngResolutionGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">maxAngResolution</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">maxAngResolutionGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">maxAngResolution</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

                <span class="c1"># There are cases with minAngResolutionGoal being set to 0 arcsec</span>
                <span class="c1"># while maxAngResolutionGoal has a non-zero value (PIPE-593).</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">minAngResolution</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">maxAngResolution</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">minAngResolution</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">minAngResolution</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">maxAngResolution</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">maxAngResolution</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">maxAngResolution</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">minAngResolutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">minAngResolution</span><span class="p">)</span>
                <span class="n">maxAngResolutions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxAngResolution</span><span class="p">)</span>

                <span class="c1"># Create maximum allowed beam axial ratio</span>
                <span class="n">maxAllowedBeamAxialRatioGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;maxAllowedBeamAxialRatio&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">maxAllowedBeamAxialRatioGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">maxAllowedBeamAxialRatioGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">maxAllowedBeamAxialRatio</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">maxAllowedBeamAxialRatio</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">999.</span><span class="p">:</span>
                    <span class="n">maxAllowedBeamAxialRatio</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">maxAllowedBeamAxialRatios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxAllowedBeamAxialRatio</span><span class="p">)</span>

                <span class="c1"># Create sensitivity goal</span>
                <span class="n">sensitivityGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;sensitivityGoal&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sensitivityGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">sensitivityGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sensitivity</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">sensitivity</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">sensitivity</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">sensitivities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">)</span>

                <span class="c1"># Create dynamic range goal</span>
                <span class="n">dynamicRangeGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;dynamicRange&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dynamicRangeGoal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">dynamicRange</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">dynamicRangeGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dynamicRange</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="n">dynamicRanges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dynamicRange</span><span class="p">)</span>

                <span class="c1"># Create spectral dynamic range bandwidth goal</span>
                <span class="n">spectralDynamicRangeBandWidthGoal</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;spectralDynamicRangeBandWidth&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spectralDynamicRangeBandWidthGoal</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">):</span>
                    <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidthGoal</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">spectralDynamicRangeBandWidth</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">spectralDynamicRangeBandWidth</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">spectralDynamicRangeBandWidths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spectralDynamicRangeBandWidth</span><span class="p">)</span>

                <span class="n">sbName</span> <span class="o">=</span> <span class="n">_get_science_goal_value</span><span class="p">(</span><span class="n">scienceGoals</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">numScienceGoals</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">],</span> <span class="s1">&#39;SBName&#39;</span><span class="p">)</span>
                <span class="n">sbNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sbName</span><span class="p">)</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">repSources</span><span class="p">,</span> <span class="n">repFrequencies</span><span class="p">,</span> <span class="n">repBandWidths</span><span class="p">,</span> <span class="n">repWindows</span><span class="p">,</span> <span class="n">minAngResolutions</span><span class="p">,</span> <span class="n">maxAngResolutions</span><span class="p">,</span>
                        <span class="n">maxAllowedBeamAxialRatios</span><span class="p">,</span> <span class="n">sensitivities</span><span class="p">,</span> <span class="n">dynamicRanges</span><span class="p">,</span> <span class="n">spectralDynamicRangeBandWidths</span><span class="p">,</span> <span class="n">sbNames</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span></div>



<div class="viewcode-block" id="ExecblockTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.ExecblockTable.html#pipeline.infrastructure.tablereader.ExecblockTable">[docs]</a>
<span class="k">class</span> <span class="nc">ExecblockTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_execblock_info</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">execblock_info</span> <span class="o">=</span> <span class="p">[</span><span class="n">ExecblockTable</span><span class="o">.</span><span class="n">_create_execblock_info</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">ExecblockTable</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">ms</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">execblock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ALMA&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">execblock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">execblock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>             
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">execblock_info</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>             
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_execblock_info</span><span class="p">(</span><span class="n">telescopeName</span><span class="p">,</span> <span class="n">configName</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">telescopeName</span><span class="p">,</span> <span class="n">configName</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_table</span><span class="p">(</span><span class="n">ms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the ASDM_EXECBLOCK table</span>
<span class="sd">        For all practical purposes this table consists of a single row</span>
<span class="sd">        but handle the more general case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analysing ASDM_EXECBLOCK table&#39;</span><span class="p">)</span>
        <span class="n">msname</span> <span class="o">=</span> <span class="n">_get_ms_name</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span>
        <span class="n">execblock_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msname</span><span class="p">,</span> <span class="s1">&#39;ASDM_EXECBLOCK&#39;</span><span class="p">)</span>        
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">execblock_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">telescope_names</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;telescopeName&#39;</span><span class="p">)</span>
            <span class="n">config_names</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;configName&#39;</span><span class="p">)</span>

        <span class="c1"># In case multiple columns are extracted at some point</span>
        <span class="c1"># in which case rows would be constructed from the zipped</span>
        <span class="c1"># columns</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">telescope_names</span><span class="p">,</span> <span class="n">config_names</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">rows</span></div>



<div class="viewcode-block" id="PolarizationTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.PolarizationTable.html#pipeline.infrastructure.tablereader.PolarizationTable">[docs]</a>
<span class="k">class</span> <span class="nc">PolarizationTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_polarizations</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">pol_ids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">({</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">msmd</span><span class="o">.</span><span class="n">polidfordatadesc</span><span class="p">()})</span>

        <span class="n">num_corrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">ncorrforpol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pol_ids</span><span class="p">]</span>
        <span class="n">corr_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">corrtypesforpol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pol_ids</span><span class="p">]</span>
        <span class="n">corr_products</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">corrprodsforpol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pol_ids</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">PolarizationTable</span><span class="o">.</span><span class="n">_create_pol_description</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pol_ids</span><span class="p">,</span> <span class="n">num_corrs</span><span class="p">,</span> <span class="n">corr_types</span><span class="p">,</span> <span class="n">corr_products</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_pol_description</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">num_corr</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span> <span class="n">corr_product</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">Polarization</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">num_corr</span><span class="p">,</span> <span class="n">corr_type</span><span class="p">,</span> <span class="n">corr_product</span><span class="p">)</span></div>



<div class="viewcode-block" id="SourceTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.SourceTable.html#pipeline.infrastructure.tablereader.SourceTable">[docs]</a>
<span class="k">class</span> <span class="nc">SourceTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_sources</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">SourceTable</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>

        <span class="c1"># duplicate source entries may be present due to duplicate entries</span>
        <span class="c1"># differing by non-essential columns, such as spw</span>
        <span class="n">key_fn</span> <span class="o">=</span> <span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_fn</span><span class="p">)</span>
        <span class="n">grouped_by_source_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key_fn</span><span class="p">):</span>
            <span class="n">grouped_by_source_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>

        <span class="n">no_dups</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">grouped_by_source_id</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">SourceTable</span><span class="o">.</span><span class="n">_create_source</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">no_dups</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_source</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">proper_motion</span><span class="p">,</span> <span class="n">is_eph_obj</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">avg_spacings</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">proper_motion</span><span class="p">,</span> <span class="n">is_eph_obj</span><span class="p">,</span> <span class="n">table_names</span><span class="p">,</span> <span class="n">avg_spacings</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the SOURCE table of the given measurement set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Analysing SOURCE table&#39;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">sourceidsfromsourcetable</span><span class="p">()</span>
        <span class="n">sourcenames</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">sourcenames</span><span class="p">()</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">sourcedirs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
        <span class="n">propermotions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">propermotions</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pm</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">pm</span><span class="p">[</span><span class="mi">0</span><span class="p">]))]</span>
        <span class="n">eph_sourcenames</span><span class="p">,</span> <span class="n">ephemeris_tables</span><span class="p">,</span> <span class="n">avg_spacings</span> <span class="o">=</span> <span class="n">SourceTable</span><span class="o">.</span><span class="n">_get_eph_sourcenames</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="n">is_eph_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sourcename</span> <span class="ow">in</span> <span class="n">eph_sourcenames</span> <span class="k">for</span> <span class="n">sourcename</span> <span class="ow">in</span> <span class="n">sourcenames</span><span class="p">]</span>

        <span class="n">table_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">spacings_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sourcename</span> <span class="ow">in</span> <span class="n">sourcenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sourcename</span> <span class="ow">in</span> <span class="n">eph_sourcenames</span><span class="p">:</span>
                <span class="n">table_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ephemeris_tables</span><span class="p">[</span><span class="n">sourcename</span><span class="p">])</span>
                <span class="n">spacings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_spacings</span><span class="p">[</span><span class="n">sourcename</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">table_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">spacings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">all_sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">sourcenames</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">propermotions</span><span class="p">,</span> <span class="n">is_eph_objs</span><span class="p">,</span> <span class="n">table_list</span><span class="p">,</span> <span class="n">spacings_list</span><span class="p">))</span>

        <span class="c1"># Only return sources for which scans are present.</span>
        <span class="c1"># Create a mapping of source id to a boolean of whether any</span>
        <span class="c1"># scans are present for that source, using fields to link</span>
        <span class="c1"># between sources and scans.</span>
        <span class="n">source_id_to_scans</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">sourceidsfromsourcetable</span><span class="p">()):</span>
            <span class="n">fields_for_source</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">fieldsforsource</span><span class="p">(</span><span class="n">source_id</span><span class="p">))</span>
            <span class="c1"># Fields do not necessarily have associated scans. If only the</span>
            <span class="c1"># first field is tested and gives a negative result, CAS-9499</span>
            <span class="c1"># results (AttributeError: &#39;Field&#39; object has no attribute</span>
            <span class="c1"># &#39;source&#39;). Prevent this by testing all fields for the</span>
            <span class="c1"># presence of scans.</span>
            <span class="n">source_id_to_scans</span><span class="p">[</span><span class="n">source_id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field_id</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
                                                 <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">fields_for_source</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_sources</span> <span class="k">if</span> <span class="n">source_id_to_scans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_eph_sourcenames</span><span class="p">(</span><span class="n">msname</span><span class="p">):</span>
        <span class="n">ephemeris_tables</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">glob_ordered</span><span class="p">(</span><span class="n">msname</span><span class="o">+</span><span class="s1">&#39;/FIELD/EPHEM*.tab&#39;</span><span class="p">)</span>

        <span class="n">eph_sourcenames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">avg_spacings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ephemeris_table_names</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ephemeris_table</span> <span class="ow">in</span> <span class="n">ephemeris_tables</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">ephemeris_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">tb</span><span class="p">:</span>
                <span class="n">keywords</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getkeywords</span><span class="p">()</span>
                <span class="n">eph_sourcename</span> <span class="o">=</span> <span class="n">keywords</span><span class="p">[</span><span class="s1">&#39;NAME&#39;</span><span class="p">]</span>
                <span class="n">eph_sourcenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eph_sourcename</span><span class="p">)</span>
                <span class="c1"># Add the average spacing in minutes of the MJD column of the ephemeris table (see PIPE-627).</span>
                <span class="k">if</span> <span class="s1">&#39;MJD&#39;</span> <span class="ow">in</span> <span class="n">tb</span><span class="o">.</span><span class="n">colnames</span><span class="p">():</span>
                    <span class="n">mjd</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;MJD&#39;</span><span class="p">)</span>
                    <span class="n">avg_spacings</span><span class="p">[</span><span class="n">eph_sourcename</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">*</span><span class="mi">1440</span> <span class="c1"># Convert fractional day to minutes</span>
                <span class="c1"># Return file names (not whole paths) for the ephemeris tables (see PIPE-627)</span>
                <span class="n">ephemeris_table_names</span><span class="p">[</span><span class="n">eph_sourcename</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ephemeris_table</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">eph_sourcenames</span><span class="p">,</span> <span class="n">ephemeris_table_names</span><span class="p">,</span> <span class="n">avg_spacings</span></div>



<div class="viewcode-block" id="StateTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.StateTable.html#pipeline.infrastructure.tablereader.StateTable">[docs]</a>
<span class="k">class</span> <span class="nc">StateTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_states</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">state_factory</span> <span class="o">=</span> <span class="n">StateTable</span><span class="o">.</span><span class="n">get_state_factory</span><span class="p">(</span><span class="n">msmd</span><span class="p">)</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Opening STATE table to read STATE.OBS_MODE&#39;</span><span class="p">)</span>
        <span class="n">state_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;STATE&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">state_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">obs_modes</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;OBS_MODE&#39;</span><span class="p">)</span>

        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">nstates</span><span class="p">()):</span>
            <span class="n">obs_mode</span> <span class="o">=</span> <span class="n">obs_modes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state_factory</span><span class="o">.</span><span class="n">create_state</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">obs_mode</span><span class="p">)</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">states</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_state_factory</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">observatorynames</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">facility</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="n">first_scan</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">scannumbers</span><span class="p">())</span>
        <span class="n">scan_start</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">timesforscan</span><span class="p">(</span><span class="n">first_scan</span><span class="p">))</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Opening MS to read TIME keyword to avoid &#39;</span>
                  <span class="s1">&#39;msmd.timesforscan() units ambiguity&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="n">time_colkeywords</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcolkeywords</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">)</span>
            <span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_colkeywords</span><span class="p">[</span><span class="s1">&#39;QuantumUnits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">time_ref</span> <span class="o">=</span> <span class="n">time_colkeywords</span><span class="p">[</span><span class="s1">&#39;MEASINFO&#39;</span><span class="p">][</span><span class="s1">&#39;Ref&#39;</span><span class="p">]</span>    

        <span class="n">me</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">measures</span>
        <span class="n">qa</span> <span class="o">=</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">quanta</span>

        <span class="n">epoch_start</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">epoch</span><span class="p">(</span><span class="n">time_ref</span><span class="p">,</span> <span class="n">qa</span><span class="o">.</span><span class="n">quantity</span><span class="p">(</span><span class="n">scan_start</span><span class="p">,</span> <span class="n">time_unit</span><span class="p">))</span>
        <span class="n">str_start</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">epoch_start</span><span class="p">[</span><span class="s1">&#39;m0&#39;</span><span class="p">],</span> <span class="n">form</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fits&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dt_start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">str_start</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">domain</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">StateFactory</span><span class="p">(</span><span class="n">facility</span><span class="p">,</span> <span class="n">dt_start</span><span class="p">)</span>        </div>



<div class="viewcode-block" id="FieldTable">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.FieldTable.html#pipeline.infrastructure.tablereader.FieldTable">[docs]</a>
<span class="k">class</span> <span class="nc">FieldTable</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="n">num_fields</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">nfields</span><span class="p">()</span>
        <span class="n">field_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_fields</span><span class="p">))</span>
        <span class="n">field_names</span> <span class="o">=</span> <span class="n">msmd</span><span class="o">.</span><span class="n">namesforfields</span><span class="p">()</span>
        <span class="n">times</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">timesforfield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">]</span>
        <span class="n">phase_centres</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">phasecenter</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">]</span>
        <span class="n">source_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">msmd</span><span class="o">.</span><span class="n">sourceidforfield</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">field_ids</span><span class="p">]</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="s1">&#39;Opening FIELD table to read FIELD.SOURCE_TYPE&#39;</span><span class="p">)</span>
        <span class="n">field_table</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="s1">&#39;FIELD&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">casa_tools</span><span class="o">.</span><span class="n">TableReader</span><span class="p">(</span><span class="n">field_table</span><span class="p">)</span> <span class="k">as</span> <span class="n">table</span><span class="p">:</span>
            <span class="c1"># TODO can this old code be removed? We&#39;ve not handled non-APDMs</span>
            <span class="c1"># for a *long* time!</span>
            <span class="c1">#</span>
            <span class="c1"># FIELD.SOURCE_TYPE contains the intents in non-APDM MS</span>
            <span class="k">if</span> <span class="s1">&#39;SOURCE_TYPE&#39;</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">colnames</span><span class="p">():</span>
                <span class="n">source_types</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">getcol</span><span class="p">(</span><span class="s1">&#39;SOURCE_TYPE&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source_types</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_fields</span>

        <span class="n">all_fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">field_ids</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">source_ids</span><span class="p">,</span> <span class="n">times</span><span class="p">,</span> <span class="n">source_types</span><span class="p">,</span> <span class="n">phase_centres</span><span class="p">))</span>

        <span class="c1"># only return sources for which scans are present</span>
        <span class="c1"># create a mapping of source id to a boolean of whether any scans are present for that source</span>
        <span class="n">field_id_to_scans</span> <span class="o">=</span> <span class="p">{</span><span class="n">field_id</span><span class="p">:</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">msmd</span><span class="o">.</span><span class="n">scansforfield</span><span class="p">(</span><span class="n">field_id</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">field_ids</span><span class="p">)}</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">all_fields</span> <span class="k">if</span> <span class="n">field_id_to_scans</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">False</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_fields</span><span class="p">(</span><span class="n">msmd</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">FieldTable</span><span class="o">.</span><span class="n">_create_field</span><span class="p">(</span><span class="o">*</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">FieldTable</span><span class="o">.</span><span class="n">_read_table</span><span class="p">(</span><span class="n">msmd</span><span class="p">)]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_create_field</span><span class="p">(</span><span class="n">field_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">source_type</span><span class="p">,</span> <span class="n">phase_centre</span><span class="p">):</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">field_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">phase_centre</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source_type</span><span class="p">:</span>
            <span class="n">field</span><span class="o">.</span><span class="n">set_source_type</span><span class="p">(</span><span class="n">source_type</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">field</span></div>



<span class="k">def</span> <span class="nf">_make_range</span><span class="p">(</span><span class="n">f_min</span><span class="p">,</span> <span class="n">f_max</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">measures</span><span class="o">.</span><span class="n">FrequencyRange</span><span class="p">(</span><span class="n">measures</span><span class="o">.</span><span class="n">Frequency</span><span class="p">(</span><span class="n">f_min</span><span class="p">),</span>
                                   <span class="n">measures</span><span class="o">.</span><span class="n">Frequency</span><span class="p">(</span><span class="n">f_max</span><span class="p">))</span>


<div class="viewcode-block" id="BandDescriber">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.BandDescriber.html#pipeline.infrastructure.tablereader.BandDescriber">[docs]</a>
<span class="k">class</span> <span class="nc">BandDescriber</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">alma_bands</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ALMA Band 1&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">35</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 2&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">67</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 3&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">116</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 4&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">125</span><span class="p">,</span> <span class="mi">163</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 5&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">163</span><span class="p">,</span> <span class="mi">211</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 6&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">211</span><span class="p">,</span> <span class="mi">275</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 7&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">275</span><span class="p">,</span> <span class="mi">373</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 8&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">385</span><span class="p">,</span> <span class="mi">500</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 9&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">602</span><span class="p">,</span> <span class="mi">720</span><span class="p">),</span>
                  <span class="s1">&#39;ALMA Band 10&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">787</span><span class="p">,</span> <span class="mi">950</span><span class="p">)}</span>

    <span class="c1"># From original EVLA pipeline script</span>
    <span class="c1"># FLOW = [ 0.0e6, 150.0e6, 700.0e6, 2.0e9, 4.0e9, 8.0e9, 12.0e9, 18.0e9, 26.5e9, 40.0e9 ]</span>
    <span class="c1"># FHIGH = [ 150.0e6, 700.0e6, 2.0e9, 4.0e9, 8.0e9, 12.0e9, 18.0e9, 26.5e9, 40.0e9, 56.0e9 ]</span>
    <span class="c1"># BBAND = [ &#39;4&#39;, &#39;P&#39;, &#39;L&#39;, &#39;S&#39;, &#39;C&#39;, &#39;X&#39;, &#39;U&#39;, &#39;K&#39;, &#39;A&#39;, &#39;Q&#39; ]</span>

    <span class="n">evla_bands</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;20cm (L)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                  <span class="s1">&#39;13cm (S)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">),</span>
                  <span class="s1">&#39;6cm (C)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
                  <span class="s1">&#39;3cm (X)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
                  <span class="s1">&#39;2cm (Ku)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>
                  <span class="s1">&#39;1.3cm (K)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mf">26.5</span><span class="p">),</span>
                  <span class="s1">&#39;1cm (Ka)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mf">26.5</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>
                  <span class="s1">&#39;0.7cm (Q)&#39;</span><span class="p">:</span> <span class="n">_make_range</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mf">56.0</span><span class="p">)}</span>

    <span class="n">unknown</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Unknown&#39;</span><span class="p">:</span> <span class="n">measures</span><span class="o">.</span><span class="n">FrequencyRange</span><span class="p">()}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_description</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">observatory</span><span class="o">=</span><span class="s1">&#39;ALMA&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">observatory</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;ALMA&#39;</span><span class="p">,):</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">BandDescriber</span><span class="o">.</span><span class="n">alma_bands</span>
        <span class="k">elif</span> <span class="n">observatory</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;VLA&#39;</span><span class="p">,</span> <span class="s1">&#39;EVLA&#39;</span><span class="p">):</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">BandDescriber</span><span class="o">.</span><span class="n">evla_bands</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bands</span> <span class="o">=</span> <span class="n">BandDescriber</span><span class="o">.</span><span class="n">unknown</span>

        <span class="k">for</span> <span class="n">description</span><span class="p">,</span> <span class="n">rng</span> <span class="ow">in</span> <span class="n">bands</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">rng</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">description</span>

        <span class="k">return</span> <span class="s1">&#39;Unknown&#39;</span></div>



<div class="viewcode-block" id="RetrieveByIndexContainer">
<a class="viewcode-back" href="../../../_autosummary/pipeline.infrastructure.tablereader.RetrieveByIndexContainer.html#pipeline.infrastructure.tablereader.RetrieveByIndexContainer">[docs]</a>
<span class="k">class</span> <span class="nc">RetrieveByIndexContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RetrieveByIndexContainer is a container for items whose numeric index or</span>
<span class="sd">    other unique identifier is stored in an instance attribute.</span>

<span class="sd">    Retrieving by index from this container matches and returns the item with</span>
<span class="sd">    matching index attribute, which may differ from the natural position of</span>
<span class="sd">    the item in the underlying list backing store. For instance, getting item</span>
<span class="sd">    3 with container[3] returns the item with index attribute == 3, not the</span>
<span class="sd">    item at position 3.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">index_fn</span><span class="o">=</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new RetrieveByIndexContainer.</span>

<span class="sd">        The list of items passed as the &#39;items&#39; argument is set as an instance</span>
<span class="sd">        attribute (i.e., a copy or deep copy is not made). No changes should be</span>
<span class="sd">        made to the list after passing it to this constructor.</span>

<span class="sd">        :param items: the list of indexable items to wrap</span>
<span class="sd">        :param index_fn: function that returns the index of an item instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__items</span> <span class="o">=</span> <span class="n">items</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__index_fn</span> <span class="o">=</span> <span class="n">index_fn</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__items</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s1">&#39;list indices must be integers, not </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>

        <span class="n">with_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__items</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__index_fn</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">with_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;list index out of range: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">with_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;more than one object found with ID </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">with_id</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;RetrieveByIndexContainer(</span><span class="si">{}</span><span class="s1">)&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__items</span><span class="p">))</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020–2024, Pipeline Dev. Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>