<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd file:///opt/casa/code/xmlcasa/xml/casa.xsd">

<task category="pipeline" name="h_restoredata" type="function">
<shortdescription>Restore flags and calibration state from a pipeline run</shortdescription>
<description>The h_restoredata task restores flagged and calibrated
             MeasurementSets from archived ASDMs and pipeline flagging and
             calibration date products.

             The h_restoredata restores flagged and calibrated data from
             archived ASDMs and pipeline flagging and calibration data
             products. Pending archive retrieval support h_restoredata assumes
             that the required products are available in the rawdata_dir in
             the format produced by the h_exportdata task.

             h_restoredata assumes that the following entities are available
             in the rawdata_dir directory

               o the ASDMs to be restored
               o for each ASDM in the input list
               o a compressed tar file of the final flagversions file, e.g.,
                 uid___A002_X30a93d_X43e.ms.flagversions.tar.gz
               o a text file containing the applycal instructions, e.g.,
                 uid___A002_X30a93d_X43e.ms.calapply.txt
               o a compressed tar file containing the caltables for the parent
                 session, e.g., uid___A001_X74_X29.session_3.caltables.tar.gz

             h_restore data performs the following operations:

               o imports the ASDM(s))
               o removes the default MS.flagversions directory created by the filler
               o restores the final MS.flagversions directory stored by the pipeline
               o restores the final set of pipeline flags to the MS
               o restores the final calibration state of the MS
               o restores the final calibration tables for each MS
               o applies the calibration tables to each MS
</description>

<input>
    <param name="vis" type="stringVec">
	<shortdescription>List of input visibility data</shortdescription>
    <description>List of raw visibility data files to be restored. Assumed to
                 be in the directory specified by rawdata_dir.

                 example: vis=['uid___A002_X30a93d_X43e']

                 Can only set when pipelinemode='interactive'
    </description>
	<value/>
    </param>

    <param name="session" type="stringVec">
	<shortdescription>List of sessions</shortdescription>
    <description>List of sessions, one per visibility file.

                 example: session=['session_3']

                 Can only set when pipelinemode='interactive'
    </description>
	<value/>
    </param>

    <param name="products_dir" type="string">
	<shortdescription>Path to archived pipeline data products</shortdescription>
	<description>Path to the data products directory, used to copy calibration
                 products from. The parameter is effective only when
                 copytoraw=True. When copytoraw=False, calibration products in
                 rawdata_dir will be used.

                 example: products_dir='/path/to/my/products'

                 Can only set when pipelinemode='interactive'
    </description>
    <value>../products</value>
    </param>

    <param name="copytoraw" type="bool">
	<shortdescription>Copy calibration and flagging tables to raw data directory</shortdescription>
    <description>Copy calibration and flagging tables from products_dir to
                 rawdata_dir directory.

                 example: copytoraw=False

                 Can only set when pipelinemode='interactive'
    </description>
	<value>True</value>
    </param>

    <param name="rawdata_dir" type="string">
	<shortdescription>Path to rawdata directory</shortdescription>
    <description>Path to the rawdata subdirectory.

                 example: rawdata_dir='/path/to/my/rawdata'

                 Can only set when pipelinemode='interactive'
    </description>
	<value>../rawdata</value>
    </param>

    <param name="lazy" type="bool">
	<shortdescription>Use lazy filler option</shortdescription>
    <description>Use the lazy filler option

                 example: lazy=True

                 Can only set when pipelinemode='interactive'
    </description>
	<value>False</value>
    </param>

    <param name="bdfflags" type="bool">
	<shortdescription>Set BDF flags</shortdescription>
    <description>Set the BDF flags

                 example: bdfflags=False

                 Can only set when pipelinemode='interactive'
    </description>

	<value>True</value>
    </param>

    <param name="ocorr_mode" type="string">
	<shortdescription>Correlation import mode</shortdescription>
    <description>Set correlation import mode

                 example: ocorr_mode='ca'

                 Can only set when pipelinemode='interactive'
    </description>
	<value>ca</value>
    </param>

    <param name="asis" type="string">
	<shortdescription>Tables to import as-is</shortdescription>
    <description>Set list of tables to import as-is into the Measurement Set

                 example: ocorr_mode='Source Receiver'

                 Can only set when pipelinemode='interactive'
    </description>
    <value/>
    </param>

    <param name="pipelinemode" type="string">
	<shortdescription>The pipeline operating mode</shortdescription>
	<description>The pipeline operating mode. In 'automatic' mode the pipeline
                 determines the values of all context defined pipeline inputs
                 automatically. In 'interactive' mode the user can set the
                 pipeline context defined parameters manually. In 'getinputs'
                 mode the user can check the settings of all pipeline
                 parameters without running the task.
    </description>
        <value>automatic</value>
	<allowed kind="enum">
	    <value>automatic</value>
	    <value>interactive</value>
	    <value>getinputs</value>
	</allowed>
    </param>

    <param name="dryrun" subparam="true" type="bool">
	<shortdescription>Run the task (False) or display task command (True)</shortdescription>
    <description>Run the commands (True) or generate the commands to be run
                 but do not execute (False).

                 Can only set when pipelinemode='interactive'
    </description>
	<value>False</value>
    </param>

    <param name="acceptresults" subparam="true" type="bool">
	<shortdescription>Add the results into the pipeline context</shortdescription>
	<description>Add the results into the pipeline context</description>
    <description>Add the results of the task to the pipeline context (True) or
                 reject them (False).
    </description>
	<value>True</value>
    </param>

    <constraints>
	<when param="pipelinemode">
	    <equals type="string" value="automatic">
	    </equals>
	    <equals type="string" value="interactive">
		<default param="dryrun"><value type="bool">False</value></default>
		<default param="acceptresults"><value type="bool">True</value></default>
	    </equals>
	    <equals type="string" value="getinputs">
	    </equals>
	</when>
    </constraints>

</input>

<returns>any</returns>

<example>
1. Restore the pipeline results for a single ASDM in a single session

    h_restoredata (vis=['uid___A002_X30a93d_X43e'], session=['session_1'], ocorr_mode='ca')
</example>
</task>
</casaxml>
