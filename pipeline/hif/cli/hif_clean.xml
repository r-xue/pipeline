<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" ?>
<casaxml xmlns="http://casa.nrao.edu/schema/psetTypes.html"
		 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		 xsi:schemaLocation="http://casa.nrao.edu/schema/casa.xsd file:///opt/casa/code/xmlcasa/xml/casa.xsd">

<task type="function" name="hif_clean" category="pipeline">
<shortdescription>Compute clean map</shortdescription>
<description>
Compute a clean map.  
</description>
<input>

  <param type="stringArray" name="vis" subparam="true">
    <description>List of input measurment sets</description>
    <value></value>
  </param>

  <param type="string" name="imagename" subparam="true">
     <description>Prefix for image filenames</description>
     <value></value>
  </param>

  <param type="string" name="intent" subparam="true">
    <description>Set of data selection intents</description>
    <value></value>
  </param>

  <param type="string" name="field" subparam="true">
    <description>Set of data selection field names or ids</description>
    <value></value>
  </param>

  <param type="string" name="spw" subparam="true">
    <description>Set of data selection spectral window/channels</description>
    <value></value>
  </param>

  <param type="any" name="uvrange" subparam="true">
    <description>Set of uv ranges</description>
    <any type="variant" limittypes="string stringArray"/>
    <value type="string"></value>
  </param>


  <param type="string" name="mode" subparam="true">
     <description>Spectral gridding type (mfs, frequency)</description>
     <value>mfs</value>
       <allowed kind="enum">
         <value>mfs</value>
         <value>frequency</value>
       </allowed>
  </param>

  <param type="string" name="imagermode" subparam="true">
     <description>Imaging mode ('' for default, csclean, mosaic)</description>
     <value></value>
       <allowed kind="enum">
         <value></value>
         <value>csclean</value>
         <value>mosaic</value>
       </allowed>
  </param>

  <param type="string" name="outframe" subparam="true">
     <description>velocity frame of output image</description>
     <value></value>
       <allowed kind="enum">
         <value></value>
         <value>LSRK</value>
       </allowed>
  </param>

  <param type="int" name="nchan" subparam="true">
    <description>Number of channels (planes) in output image, -1 = all</description>
    <value>-1</value>
  </param>

  <param type="any" name="start" subparam="true">
    <description>Start of output spectral dimension</description>
    <any type="variant"/>
    <value type="string">0</value>
  </param>

  <param type="any" name="width" subparam="true">
    <description>Width of output spectral channels</description>
    <any type="variant"/>
    <value type="string"></value>
  </param>

  <param type="intArray" name="imsize" subparam="true">
    <description>x and y image size in pixels, single value same for both.</description>
    <value></value>
  </param>

  <param type="stringArray" name="cell" subparam="true">
    <description>x and y cell size(s), single value same for both.</description>
    <value>1.0arcsec</value>
  </param>

  <param type="any" name="phasecenter" subparam="true">
    <description>Image center ('' for default, direction or field index)</description>
    <any type="variant"/>
    <value type="string"></value>
  </param>

  <param type="string" name="restfreq" subparam="true">>
    <description>The rest frequency</description>
    <value></value>
  </param>

  <param type="string" name="weighting" subparam="true">
     <description>Type of weighting</description>
     <value>natural</value>
       <allowed kind="enum">
         <value>natural</value>
         <value>uniform</value>
         <value>briggs</value>
         <value>superuniform</value>
         <value>briggsabs</value>
       </allowed>
  </param>

  <param type="double" name="robust" subparam="true">
     <description>Briggs weighting robustness parameter</description>
     <value>0.0</value>
  </param>

  <param type="any" name="noise" subparam="true">
    <description>Briggs weighting noise parameter</description>
    <any type="variant"/>
    <value type="string">1.0Jy</value>
  </param>

  <param type="int" name="npixels" subparam="true">
    <description>Weighting algorithm parameter</description>
    <value type="int">1</value>
  </param>

  <param type="string" name="hm_clean" subparam="true">
     <description>pipeline cleaning mode (autobox manual) </description>
       <value>autoboxc</value>
       <allowed kind="enum">
         <value>autoboxc</value>
         <value>manual</value>
       </allowed>
  </param>

  <param type="string" name="mask" subparam="true">
     <description>Clean  mask </description>
     <value>automatic</value>
  </param>

  <param type="double" name="threshold" units="mJy" subparam="true">
     <description>clean threshold</description>
     <value>0.0</value>
  </param>

  <param type="int" name="maxthreshiter" subparam="true">
    <description>Maximum number of autobox threshold iterations</description>
    <value>10</value>
  </param>

  <param type="string" name="pipelinemode">
    <description>The pipeline operating mode</description>
    <value>automatic</value>
    <allowed kind="enum">
      <value>automatic</value>
      <value>interactive</value>
      <value>getinputs</value>
    </allowed>
  </param>

  <param type="bool" name="dryrun" subparam="true">
    <description>Run the task (False) or display the command(True)</description>
    <value>False</value>
  </param>

  <param type="bool" name="acceptresults" subparam="true">
    <description>Add the results to the pipeline context</description>
   <value>True</value>
  </param>


  <constraints>

     <when param="mode">
          <equals value="mfs">
            <default param="nterms"><value>1</value></default>
            <default param="reffreq"><value type="string"></value></default>
          </equals>
          <equals value="frequency">
            <default param="nchan"><value>-1</value></default>
            <default param="start"><value type="string"></value></default>
            <default param="width"><value type="string"></value> </default>
            <default param="outframe"><value type="string"></value></default>
          </equals>
    </when>

  <when param="weighting">
       <equals value="natural"/>
       <equals value="uniform"/>
       <equals value="briggs">
            <default param="robust"><value>0.0</value></default>
            <default param="npixels"><value>0</value></default>
       </equals>
      <equals value="briggsabs">
            <default param="robust"><value>0.0</value></default>
            <default param="noise"><value type="string">1.0Jy</value></default>
            <default param="npixels"><value>0</value></default>
      </equals>
      <equals value="superuniform">
            <default param="npixels"><value>0</value></default>
      </equals>
    </when>

     <when param="hm_clean">
       <equals value="autobox">
            <default param="mask"><value>sidelobe</value></default>
            <default param="maxthreshiter"><value type="int" >10</value></default>
       </equals>
       <equals value="manual">
            <default param="mask"><value></value></default>
            <default param="threshold"><value type="double" units="mJy">0.0</value></default>
       </equals>
     </when>

    <when param="pipelinemode">
      <equals type="string" value="automatic"/>
      <equals type="string" value="interactive">
        <default param="vis"><value type="stringArray"></value></default>
        <default param="field"><value type="string"></value></default>
        <default param="intent"><value type="string"></value></default>
        <default param="spw"><value type="string"></value></default>
        <default param="uvrange"><value type="string"></value></default>
        <default param="imagename"><value type="string"></value></default>
        <default param="outframe"><value type="string"></value></default>
        <default param="imsize"><value type="intArray"></value></default>
        <default param="cell"><value type="stringArray"></value></default>
        <default param="restfreq"><value type="string"></value></default>
        <default param="phasecenter"><value type="string"></value></default>
        <default param="weighting"><value type="string">natural</value></default>
        <default param="robust"><value type="double">0.0</value></default>
        <default param="noise"><value type="string">1.0Jy</value></default>
        <default param="npixels"><value type="int">1</value></default>
        <default param="hm_clean"><value type="string">automatic</value></default>
        <default param="dryrun"><value type="bool">False</value></default>
        <default param="acceptresults"><value type="bool">True</value></default>
      </equals>
      <equals type="string" value="getinputs">
        <default param="vis"><value type="stringArray"></value></default>
        <default param="field"><value type="string"></value></default>
        <default param="intent"><value type="string"></value></default>
        <default param="spw"><value type="string"></value></default>
        <default param="uvrange"><value type="string"></value></default>
        <default param="imagename"><value type="string"></value></default>
        <default param="outframe"><value type="string"></value></default>
        <default param="imsize"><value type="intArray"></value></default>
        <default param="cell"><value type="stringArray"></value></default>
        <default param="restfreq"><value type="string"></value></default>
        <default param="phasecenter"><value type="string"></value></default>
        <default param="weighting"><value type="string">natural</value></default>
        <default param="robust"><value type="double">0.0</value></default>
        <default param="noise"><value type="string">1.0Jy</value></default>
        <default param="npixels"><value type="int">1</value></default>
        <default param="hm_clean"><value type="string">automatic</value></default>
      </equals>
    </when>

  </constraints>

</input>

<output>
    <param type="any" name="results">
        <description>The output results object</description>
        <any type="variant"/>
        <value></value>
    </param>
</output>
<returns type="void"/>


<example>

Compute a cleaned image for a particular target source/intent and spectral
window.

Keyword arguments:

--- pipeline parameter arguments which can be set in any pipeline mode

pipelinemode -- The pipeline operating mode. In 'automatic' mode the pipeline
       determines the values of all context defined pipeline inputs
       automatically.  In interactive mode the user can set the pipeline
       context defined parameters manually.  In 'getinputs' mode the user
       can check the settings of all pipeline parameters without running
       the task.
       default: 'automatic'.


---- pipeline context defined parameter arguments which can be set only in
'interactive mode'

vis -- The list of input measurement sets. Defaults to the list of measurment
    sets specified in the h_init or hif_importdata sets.
    example: vis='ngc5921.ms'
             vis=['ngc5921a.ms', ngc5921b.ms', 'ngc5921c.ms']
    default: use all measurement sets in the context 

field -- Select fields to image or mosaic. Use field id(s) or name(s).
    The specified fields will be selected in all measurement sets 
    derived from 'vis'.
    example: '3C279', 'Centaurus*'
    default: '' (No data selected)

intent -- An intent against which the selected fields are matched.
    example: '', 'TARGET'
    default: '' (Select all data from fields specified by 'field' parameter)

spw -- Select spectral window/channels.
    default: '' (No data selected)

mode -- Frequency specification:
        default: 'mfs'
          mode = 'mfs' means produce one image from all specified data.
          mode = 'channel'; Use with nchan, start, width to specify output
                 image cube.
          mode = 'velocity', channels are specified in velocity.
          mode = 'frequency', channels are specified in frequency.

imagename -- Pre-name of output images. This can be set by the user as for 
   the standard CASA clean task. Alternatively, if no value is set then it 
   will be derived as follows:
      1. Obtain the 'field', 'intent' and 'spw' parameter values. 
      2. Obtain the stage number from the context.
      3. Set the imagename to:-
         'multivis.{field}.[{intent}.]s{stage number}.spw{spw}'
   hif_clean proceeds through a number of iterations re-evaluating the
   cleanboxes and thresholds to use as it goes. For each iteration the
   output images are:
      {prename}.iter{n}.image; cleaned and restored image
      {prename}.iter{n}.psf; point spread function (dirty beam)
      {prename}.iter{n}.flux; relative sky sensitivity over field
      {prename}.iter{n}.flux.pbcoverage; relative pb coverage over field
                                        (only for mosaics)
      {prename}.iter{n}.model; image of clean components
      {prename}.iter{n}.residual; image of residuals
      {prename}.iter{n}.cleanmask; image of cleanmask used
  
imagermode -- Advanced imaging e.g. mosaic or Cotton-Schwab clean.
   This can NOT be set by the user as for the standard CASA 
   clean task. It will be derived as follows:
      1. The 'field' parameter is converted into a list of field_ids for
         each measurement set in 'vis'.
      2. If there is more than 1 field_id in the list for any measurement 
         set then imagermode is set to 'mosaic', otherwise it will be set
         to 'csclean'. 

imsize -- Image size in pixels (x, y). DOES NOT HAVE TO BE A POWER OF 2
          (but has to be even and have factors 2,3,5,7 only).
          Default is derived as follows:
             1. Determine 'phasecenter' value and spread of field centres
                around it. 
             2. Set size of image to cover spread of field centres plus
                a border of width 0.75 * beam radius (to first null).
             3. Divide x and y extents by 'cell' values to arrive at
                the numbers of pixels required. 

cell -- Cell size (x, y)
        default '1.0arcsec'
        example: cell = ['0.5arcsec', '0.5arcsec']

phasecenter -- Direction measure or field_id for the mosaic center.
        default: The phasecenter  will be derived as follows:
           1. Make an array containing all the field centres to be imaged together.
           2. Derive a 'mean' direction from the directions array.

weighting -- Weighting to apply to visibilities:
             default='natural'; example: weighting='uniform';
             Options: 'natural','uniform','briggs', 
                'superuniform','briggsabs','radial'

robust -- For weighting='briggs' and 'briggsabs'
          default=0.0; example: robust=0.5;
          Options: -2.0 to 2.0; -2 (uniform)/+2 (natural)
                 
noise -- For weighting='briggsabs'
         noise parameter to use for Briggs "abs" weighting
         example noise='1.0mJy'


--- pipeline task execution modes
dryrun -- Run the commands (True) or generate the commands to be run but
   do not execute (False).
   default: False

acceptresults -- Add the results of the task to the pipeline context (True) or
   reject them (False).
   default: True

Output:

results -- If pipeline mode is 'getinputs' then None is returned. Otherwise
    the results object for the pipeline task is returned.


Examples:

Make an 'mfs' image of calibrator 3c279 using data in spectral window 1. 
The cell size is set to 0.2 arcsec in RA and Dec. Other clean parameters
are derived from heuristics:

hif_clean(field='3c279', cell='0.2arcsec', spw='1', mode='mfs')

Make a cube of calibrator 3c279 using data in spectral window 1. The
cube planes will be evenly spaced in frequency in the LSRK frame. Other
clean parameters are derived from heuristics.
 
hif_clean(field='3c279', cell='0.2arcsec', spw='1', mode='frequency',
 outframe='LSRK')

hif_clean(field='3c279', cell='0.2arcsec', spw='1', mode='frequency',
 outframe='LSRK', width_multiplier=8)


</example>

</task>
</casaxml>

