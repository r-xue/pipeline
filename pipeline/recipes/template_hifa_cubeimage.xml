<ProcessingProcedure>
	<ProcedureTitle>hifa_cubeimage</ProcedureTitle>

    {{#importonly}}
    <!-- import MS: if importonly=True, no calibration shall be performed -->
    <ProcessingCommand>
        <Command xmlns="">hifa_importdata</Command>
        <ParameterSet/>
    </ProcessingCommand>
    {{/importonly}}
    {{^importonly}}
     <!-- Restore MS: if importonly!=True, restore ASDM and call hif_mstransform -->
    <ProcessingCommand>
        <Command xmlns="">hifa_restoredata</Command>
        <ParameterSet>
          <Parameter>
            <Keyword xmlns="">copytoraw</Keyword>
            <Value xmlns="">False</Value>
          </Parameter>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_mstransform</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>
    {{/importonly}}

    <ProcessingCommand>
        <Command xmlns="">hifas_imageprecheck</Command>
        <ParameterSet>
            <Parameter>
                <Keyword xmlns="">desired_angular_resolution</Keyword>
                <Value xmlns="">{{desired_angular_resolution}}</Value>
            </Parameter>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_makeimlist</Command>
        <ParameterSet>
            <Parameter>
                <Keyword xmlns="">specmode</Keyword>
                <Value xmlns="">mfs</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">pipelinemode</Keyword>
                <Value xmlns="">interactive</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">field</Keyword>
                <Value xmlns="">{{{field_list}}}</Value>
            </Parameter>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_findcont</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_uvcontfit</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_uvcontsub</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>


    <ProcessingCommand>
        <Command xmlns="">hif_makeimages</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>

<!-- create aggregate continuum image if cont_image=true -->
{{#cont_image}}
    <ProcessingCommand>
        <Command xmlns="">hif_makeimlist</Command>
        <ParameterSet>
            <Parameter>
                <Keyword xmlns="">specmode</Keyword>
                <Value xmlns="">cont</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">pipelinemode</Keyword>
                <Value xmlns="">interactive</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">field</Keyword>
                <Value xmlns="">{{{field_list}}}</Value>
            </Parameter>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_makeimages</Command>
        <ParameterSet>
        </ParameterSet>
    </ProcessingCommand>
{{/cont_image}}
<!-- end of the continuum imaging section -->

<!-- loop over list of cubes and create images -->
{{#cube_list}}

    <ProcessingCommand>
        <Command xmlns="">hif_editimlist</Command>
        <ParameterSet>
            <Parameter>
                <Keyword xmlns="">imaging_mode</Keyword>
                <Value xmlns="">ALMA</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">specmode</Keyword>
                <Value xmlns="">cube</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">field</Keyword>
                <Value xmlns="">{{{field}}}</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">spw</Keyword>
                <Value xmlns="">{{spw}}</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">restfreq</Keyword>
                <Value xmlns="">{{restfreq}}</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">start</Keyword>
                <Value xmlns="">{{start}}</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">width</Keyword>
                <Value xmlns="">{{width}}</Value>
            </Parameter>
            <Parameter>
                <Keyword xmlns="">nchan</Keyword>
                <Value xmlns="">{{nchan}}</Value>
            </Parameter>
        </ParameterSet>
    </ProcessingCommand>

    <ProcessingCommand>
        <Command xmlns="">hif_makeimages</Command>
        <ParameterSet>
          <Parameter>
            <Keyword xmlns="">overwrite_on_export</Keyword>
            <Value xmlns="">False</Value>
          </Parameter>
        </ParameterSet>
    </ProcessingCommand>

{{/cube_list}}
<!-- end loop -->

    <ProcessingCommand>
        <Command xmlns="">hifa_exportdata</Command>
        <ParameterSet>
          <Parameter>
            <Keyword xmlns="">imaging_products_only</Keyword>
            <Value xmlns="">True</Value>
          </Parameter>
        </ParameterSet>
    </ProcessingCommand>

</ProcessingProcedure>