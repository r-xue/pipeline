<%!
rsc_path = ""
import os
import pipeline.infrastructure.renderer.htmlrenderer as hr
%>
<%inherit file="t2-4m_details-base.html"/>

<%block name="title">Phased-up fluxscale</%block>

<h2>Results</h2>

<h4>Antennas Used for Flux Scaling</h4>

<p>The following antennas were used for flux scaling, entries for unresolved flux calibrators are blank</p>

<table class="table table-bordered table-striped" summary="Flux Scaling Antennas">
	<caption>Antennas for Flux Calibration</caption>
        <thead>
	    <tr>
	        <th scope="col">Measurement Set</th>
	        <th scope="col">Antennas</th>
	    </tr>
	</thead>
	<tbody>
%for single_result in result:
      <tr>
          <td>${os.path.basename(single_result.vis)}</td>
          <td>${single_result.resantenna.replace(',', ', ').replace('&', '')}</td>
      </tr>
%endfor
	</tbody>
</table>

<h4>Computed Flux Densities</h4>

<p>The following flux densities were set in the measurement set model column and recorded in the pipeline context:</p>

<table class="table table-bordered table-striped" summary="Flux density results">
	<caption>Phased-up Fluxscale Results</caption>
    <thead>
	    <tr>
	        <th scope="col" rowspan="2">Measurement Set</th>
	        <th scope="col" rowspan="2">Field</th>
	        <th scope="col" rowspan="2">SpW</th>
	        <th scope="col" colspan="4">Flux Density</th>
		</tr>
		<tr>
	        <th scope="col">I</th>
	        <th scope="col">Q</th>
	        <th scope="col">U</th>
	        <th scope="col">V</th>
	    </tr>
	</thead>
	<tbody>
% for single_result in result:
	% for field in single_result.measurements:
		% for flux in sorted(single_result.measurements[field], key=lambda m: m.spw_id):
<% 
try:
	unc = [m for m in single_result.uncertainties[field] if int(m.spw_id) == int(flux.spw_id)]
	if len(unc) is not 1:
		raise ValueError()
	u = {}
	u['I'] = ' &#177; %s' % str(unc[0].I)	
	u['Q'] = ' &#177; %s' % str(unc[0].Q)	
	u['U'] = ' &#177; %s' % str(unc[0].U)	
	u['V'] = ' &#177; %s' % str(unc[0].V)	
except:
	u = {}
	u['I'] = ''
	u['Q'] = ''
	u['U'] = ''
	u['V'] = ''	
%>

		<tr>
			<td>${os.path.basename(single_result.vis)}</td>
			<td>${field}</td>
			<td>${flux.spw_id}</td>
			<td>${str(flux.I) + u['I']}</td>
			<td>${str(flux.Q) + u['Q']}</td>
			<td>${str(flux.U) + u['U']}</td>
			<td>${str(flux.V) + u['V']}</td>
		</tr>
		%endfor
	%endfor
%endfor
	</tbody>
</table>
