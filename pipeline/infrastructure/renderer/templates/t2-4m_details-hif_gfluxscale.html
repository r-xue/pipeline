<%!
rsc_path = ""
import cgi
import decimal
import os
import string
import types

import pipeline.domain.measures as measures
import pipeline.infrastructure.renderer.htmlrenderer as hr
import pipeline.infrastructure.filenamer as filenamer
import pipeline.infrastructure.logging as logging
import pipeline.infrastructure.utils as utils

agent_description = {
	'before'   : 'Before',
	'applycal' : 'After',
}

total_keys = {
	'TOTAL'        : 'All Data',
	'SCIENCE SPWS' : 'Science Spectral Windows',
	'BANDPASS'     : 'Bandpass',
	'AMPLITUDE'    : 'Flux',
	'PHASE'        : 'Phase',
	'TARGET'       : 'Target'
}

def template_agent_header1(agent):
	span = 'col' if agent in ('online','template') else 'row'
	return '<th %sspan=2>%s</th>' % (span, agent_description[agent])

def template_agent_header2(agent):
	if agent in ('online', 'template'):
		return '<th>File</th><th>Number of Statements</th>'
	else:
		return ''		

def get_template_agents(agents):
	return [a for a in agents if a in ('online', 'template')]

def sanitise(url):
	return filenamer.sanitize(url)




%>
<%inherit file="t2-4m_details-base.html"/>

<script src="${self.attr.rsc_path}resources/js/pipeline.js"></script>

<script>
$(document).ready(function() {
    // return a function that sets the SPW text field to the given spw
    var createSpwSetter = function(spw) {
        return function() {
            // trigger a change event, otherwise the filters are not changed
            $("#select-spw").select2("val", [spw]).trigger("change");
        };
    };

    // create a callback function for each overview plot that will select the
    // appropriate spw once the page has loaded
    $(".thumbnail a").each(function (i, v) {
        var o = $(v);
        var spw = o.data("spw");
        o.data("callback", createSpwSetter(spw));
    });

    $(".fancybox").fancybox({
        type: 'image',
        prevEffect: 'none',
        nextEffect: 'none',
        loop: false,
        helpers: {
            title: {
                type: 'outside'
            },
            thumbs: {
                width: 50,
                height: 50,
            }
        }
    });
});
</script>


<%block name="title">Phased-up fluxscale</%block>




<h2>Results</h2>

<h4>Antennas Used for Flux Scaling</h4>

<p>The following antennas were used for flux scaling, entries for unresolved flux calibrators are blank</p>

<table class="table table-bordered table-striped" summary="Flux Scaling Antennas">
	<caption>Antennas for Flux Calibration</caption>
        <thead>
	    <tr>
	        <th scope="col">Measurement Set</th>
	        <th scope="col">Antennas</th>
	    </tr>
	</thead>
	<tbody>
%for single_result in result:
      <tr>
          <td>${os.path.basename(single_result.vis)}</td>
          <td>${single_result.resantenna.replace(',', ', ').replace('&', '')}</td>
      </tr>
%endfor
	</tbody>
</table>

<h4>Computed Flux Densities</h4>

<p>The following flux densities were set in the measurement set model column and recorded in the pipeline context:</p>

<table class="table table-bordered table-striped" summary="Flux density results">
	<caption>Phased-up Fluxscale Results</caption>
    <thead>
	    <tr>
	        <th scope="col" rowspan="2">Measurement Set</th>
	        <th scope="col" rowspan="2">Field</th>
	        <th scope="col" rowspan="2">SpW</th>
	        <th scope="col" colspan="4">Flux Density</th>
		</tr>
		<tr>
	        <th scope="col">I</th>
	        <th scope="col">Q</th>
	        <th scope="col">U</th>
	        <th scope="col">V</th>
	    </tr>
	</thead>
	<tbody>
% for single_result in result:
		<tr>
			<td rowspan="${reduce(lambda x, y: x + len(y), single_result.measurements.values(), 0)}">${os.path.basename(single_result.vis)}</td>
	% for field in single_result.measurements:
		<%
			ms = pcontext.observing_run.get_ms(single_result.vis)
			f = ms.get_fields(field)[0]
			field_name = f.name
			field_id = f.id
		%>
			<td rowspan="${len(single_result.measurements[field])}">${'%s (#%s)'%(field_name, field_id)}</td>
		% for flux in sorted(single_result.measurements[field], key=lambda m: int(m.spw_id)):
<% 
try:
	u = {}
	for stokes in ['I', 'Q', 'U', 'V']:
		flux_jy = getattr(flux, stokes).to_units(measures.FluxDensityUnits.JANSKY)
		unc = getattr(flux.uncertainty, stokes)
		unc_jy = unc.to_units(measures.FluxDensityUnits.JANSKY)

		if flux_jy != 0 and unc_jy != 0:
			u[stokes] = ' &#177; %s (%0.1f%%)' % (str(unc), decimal.Decimal('100')*(unc_jy/flux_jy))	
		else:
			u[stokes] = ''
except:
	raise
	u = {}
	u['I'] = ''
	u['Q'] = ''
	u['U'] = ''
	u['V'] = ''	
%>
			<td>${flux.spw_id}</td>
			<td>${str(flux.I) + u['I']}</td>
			<td>${str(flux.Q) + u['Q']}</td>
			<td>${str(flux.U) + u['U']}</td>
			<td>${str(flux.V) + u['V']}</td>
		</tr>
		%endfor
	%endfor
%endfor
	</tbody>
</table>




%if ampuv_allant_plots:
    <h3>Flux Calibrator Model Comparison</h3>
    Antenna selection used for flux transfer to the secondary calibrators.

	% for ms in ampuv_allant_plots:
	    <h4>
			<a class="replace"
	           href="${os.path.relpath(os.path.join(dirname, 'amp_vs_uv_%s.html' % sanitise(ms)), pcontext.report_dir)}">
	            ${ms}
	        </a>
		</h4>
		% for intent in ampuv_allant_plots[ms]:
		    <ul class="thumbnails">
		        % for i, plot in enumerate(ampuv_allant_plots[ms][intent]):
		        	<!--  Select on antenna -->
		            <%
		              antplot = ampuv_ant_plots[ms][intent][i]
		            %>
		            % if os.path.exists(plot.thumbnail):
		            <li class="span3">
		                <div class="thumbnail">
		                    <a href="${os.path.relpath(plot.abspath, pcontext.report_dir)}"
		                       class="fancybox"
		                       title="Baseband ${plot.parameters['baseband']}.  ${'All antennae.' if plot.parameters['ant'] == '' else 'Antennae: '+str(plot.parameters['ant'])+'.' }
                              Flux calibrator fields: ${plot.parameters['field']}."
		                       rel="amp_vs_uv-${ms}">
		                        <img src="${os.path.relpath(plot.thumbnail, pcontext.report_dir)}"
		                             title="Click to show amplitude vs UV plot for Baseband ${plot.parameters['baseband']}"
		                             data-thumbnail="${os.path.relpath(plot.thumbnail, pcontext.report_dir)}">
		                        </img>
		                    </a>
		
		                    <div class="caption">
                                            <h4>Baseband ${plot.parameters['baseband']}</h4>
					    <p>Amp vs. uvdist for 
					    <%
						antlist = plot.parameters['ant'].split(',')
						antdisp = ' '.join([','.join(antlist[i:i+4])+'<br>' for i in range(0,len(antlist),4)])
					    %>
					    ${'all antennae.' if plot.parameters['ant'] == '' else 'antennae: '+antdisp}
					    Color coded by spw.<br> Flux calibrator fields: ${plot.parameters['field']}.
					    </p>
					</div>
		                </div>

		            % endif

		            

		            % if os.path.exists(antplot.thumbnail):

		            
		            

		                <div class="thumbnail">
		                    <a href="${os.path.relpath(antplot.abspath, pcontext.report_dir)}"
		                       class="fancybox"
		                       title="Baseband ${antplot.parameters['baseband']}.  ${'All antennae.' if antplot.parameters['ant'] == '' else 'Antennae: '+str(antplot.parameters['ant'])+'.' }
                              Flux calibrator fields: ${antplot.parameters['field']}."
		                       rel="amp_vs_uv-${ms}">
		                        <img src="${os.path.relpath(antplot.thumbnail, pcontext.report_dir)}"
		                             title="Click to show amplitude vs UV plot for Baseband ${antplot.parameters['baseband']}"
		                             data-thumbnail="${os.path.relpath(antplot.thumbnail, pcontext.report_dir)}">
		                        </img>
		                    </a>
		
		                    <div class="caption">
                                            <h4>Baseband ${antplot.parameters['baseband']}</h4>
					    <p>Selection for 
					    <%
						antlist = antplot.parameters['ant'].split(',')
						antdisp = ' '.join([','.join(antlist[i:i+4])+'<br>' for i in range(0,len(antlist),4)])
					    %>
					    ${' all antennae.' if antplot.parameters['ant'] == '' else ' antennae: '+antdisp}
					    </p>
					</div>
		                </div>
		            </li>
		            % endif
		            

		            
		        % endfor
		    </ul>
		% endfor
	%endfor
%endif







