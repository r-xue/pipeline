<%!
rsc_path = "../"
import os

import itertools
import pipeline.infrastructure.renderer.htmlrenderer as hr
import pipeline.infrastructure.renderer.logger as logger
import pipeline.infrastructure.displays as displays
%>
<%inherit file="t2-4m_details-base.html"/>

<%block name="header" />

<%block name="title">Stage ${hr.get_stage_number(result)} Task Details</%block>

<h1>Stage ${hr.get_stage_number(result)}: ${hr.get_task_description(result)}</h1>

<%
try:
   stage_number = result.stage_number
   stage_dir = os.path.join(pcontext.report_dir,'stage%d'%(stage_number))
   if not os.path.exists(stage_dir):
       os.mkdir(stage_dir)

   plots = []
   #for image_item in result.outcome:
   for r in result:
       image_item = r.outcome['image']
       spwid = image_item.spwlist
       spw_type = pcontext.observing_run[0].spectral_window[spwid].type
       task_cls = displays.SDImageDisplayFactory(spw_type)
       inputs = task_cls.Inputs(pcontext,result=r)
       task = task_cls(inputs)
       plots.append(task.plot())

   plot_groups = logger.PlotGroup.create_plot_groups(plots)
   for plot_group in plot_groups:
       renderer = hr.PlotGroupRenderer(pcontext, result, plot_group)
       plot_group.filename = renderer.filename
       with renderer.get_file() as fileobj:
           fileobj.write(renderer.render())

except Exception, e:
   print 'hsd_imaging html template exception:', e
   raise e
%>

<ul>
	<li>Initial display: most important details</li>
	<ul>
		<li>Heuristics parameters</li>
		% if plot_groups:
		<li>Plots</li>
		<ul>
			% for plot_group in plot_groups:
				<li>
					<a href=${plot_group.filename}>${plot_group.title}</a>
				</li>
			% endfor
		</ul>
                % else:
                No Images
		% endif
		<li>Images</li>
		<li>Tables</li>
	</ul>
	<li>Display maximum detail in this panel, similar to previous incarnation of pipeline; use different background colour; back button will go back to initial display</li>
</ul>

<table class="one-column-emphasis" summary="Input parameters">
	<caption>Input parameters</caption>
    <colgroup>
    	<col class="oce-first" />
    </colgroup>
	<tbody>
		% for k, v in result.inputs.iteritems():
		<tr>
		  <td>${str(k)}</th>
		  <td>${str(v)}</td>
		</tr>
		% endfor
	</tbody>
</table>

<table class="one-column-emphasis" summary="Input parameters">
	<caption>Timing details</caption>
    <colgroup>
    	<col class="oce-first" />
    </colgroup>
	<tbody>
		<tr>
		  <td>Start time</th>
		  <td>${result.timestamps.start}</td>
		</tr>
		<tr>
		  <td>End</th>
		  <td>${result.timestamps.end}</td>
		</tr>
		<tr>
		  <td>Duration</th>
		  <td>${str(result.timestamps.end - result.timestamps.start)}</td>
		</tr>
	</tbody>
</table>
