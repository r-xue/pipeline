<%!
rsc_path = "../"
import os

import itertools
import pipeline.infrastructure.renderer.htmlrenderer as hr
import pipeline.infrastructure.renderer.logger as logger
import pipeline.infrastructure.displays as displays
%>
<%inherit file="t2-4m_details-base.html"/>

<%block name="header" />

<%block name="title">Stage ${hr.get_stage_number(result)}: ${hr.get_task_description(result)}</%block>

<script src="${self.attr.rsc_path}resources/js/pipeline.js"></script>

<script>
$(document).ready(function() {
    // return a function that sets the SPW text field to the given spw
    var createSpwSetter = function(spw) {
        return function() {
            // trigger a change event, otherwise the filters are not changed
            $("#select-spw").select2("val", [spw]).trigger("change");
        };
    };

    // return a function that sets the Antenna text field to the given spw
    var createAntennaSetter = function(ant) {
        return function() {
            // trigger a change event, otherwise the filters are not changed
            $("#select-ant").select2("val", [ant]).trigger("change");
        };
    };

    // return a function that sets the Polarization text field to the given spw
    var createPolarizationSetter = function(pol) {
        return function() {
            // trigger a change event, otherwise the filters are not changed
            $("#select-pol").select2("val", [pol]).trigger("change");
        };
    };

    // 
    var createMixedSetter = function(spw, ant, pol) {
        return function() {
            // trigger a change event, otherwise the filters are not changed
            $("#select-spw").select2("val", [spw]).trigger("change");
            $("#select-ant").select2("val", [ant]).trigger("change");
            $("#select-pol").select2("val", [pol]).trigger("change");
        };
    };    

    // create a callback function for each overview plot that will select the
    // appropriate spw once the page has loaded
    $(".thumbnail a").each(function (i, v) {
        var o = $(v);
        var spw = o.data("spw");
        var ant = o.data("ant");
        var pol = o.data("pol");
        o.data("callback", createMixedSetter(spw, ant, pol));
    });

    $(".fancybox").fancybox({
        type: 'image',
        prevEffect: 'none',
        nextEffect: 'none',
        loop: false,
        helpers: {
            title: {
                type: 'outside'
            },
            thumbs: {
                width: 50,
                height: 50,
            }
        }
    });
});
</script>

<%
plot_types = ['pointing', 'azel', 'weather', 'wvr']
plot_titles = {'pointing': 'Telescope Pointing', 
               'azel': 'Az/El Plots', 
               'weather': 'Weather Plots', 
               'wvr': 'WVR Plots'}
plot_desc = {'pointing': 'Telescope pointing on the sky', 
             'azel': 'Azimuth/Elevation vs Time', 
             'weather': 'Weather vs Time', 
             'wvr': 'WVR Reading vs Time'}
%>

This task inspects registered datasets all together.

% for ms in summary.keys():
    <h4>Overview plots for ${ms}</h4>
    
    <ul class="thumbnails">
        % for _type in plot_types:
            % if os.path.exists(summary[ms][_type].thumbnail):
            <li class="span3">
                <div class="thumbnail">
                    <a href="${os.path.relpath(summary[ms][_type].abspath, pcontext.report_dir)}"
                       class="fancybox"
                       rel="thumbs">
                        <img src="${os.path.relpath(summary[ms][_type].thumbnail, pcontext.report_dir)}"
                             title="${plot_titles[_type]}"
                             data-thumbnail="${os.path.relpath(summary[ms][_type].thumbnail, pcontext.report_dir)}">
                        </img>
                    </a>

                    <div class="caption">
                        <h4>
                            <a href="${os.path.relpath(os.path.join(dirname, subplot[ms][_type]), pcontext.report_dir)}"
                               class="replace">
                               ${plot_titles[_type]}
                            </a>
                        </h4>

                        <p>${plot_desc[_type]}</p>
                    </div>
                </div>
            </li>
            % endif
        % endfor
    </ul>
%endfor
