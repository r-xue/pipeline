<%!
rsc_path = "../"

import os.path
import pydoc
import numpy as np
import sys

import pipeline.infrastructure.displays as displays
import pipeline.infrastructure.filenamer as filenamer
import pipeline.infrastructure.renderer.logger as logger
import pipeline.infrastructure.renderer.htmlrenderer as hr
%>
<%inherit file="t2-4m_details-base.html"/>
<%block name="header" />

<%block name="title">Stage ${hr.get_stage_number(result)} Task Details</%block>

<h1>Stage ${hr.get_stage_number(result)}: ${hr.get_task_description(result)}</h1>

## generate the plots
<%
try:
    r = result[0]
    stage_dir = os.path.join(pcontext.report_dir, 'stage%d' % (r.stage_number))
    plots_dir = stage_dir
    if not os.path.exists(plots_dir):
        os.mkdir(plots_dir)

    plots = []
    flagops=[]
    for r in result:
        flagops += r.flagops()

        if r.view:
            # display the view first
            # plot() returns the list of Plots it has generated
            plots.append(displays.SliceDisplay().plot(context=pcontext,
              results=r, reportdir=plots_dir, plotbad=False))

    # Group the Plots by axes and plot types; each logical grouping will
    # be contained in a PlotGroup
    plot_groups = logger.PlotGroup.create_plot_groups(plots)
    # Write the thumbnail pages for each plot grouping to disk
    for plot_group in plot_groups:
        renderer = hr.PlotGroupRenderer(pcontext, r, plot_group)
        plot_group.filename = renderer.filename
        with renderer.get_file() as fileobj:
            fileobj.write(renderer.render())

    # extract the relevant data from the flagging operations, and sort
    # them
    temp = []
    for flagop in flagops:
        temp.append((os.path.basename(flagop.filename), flagop.spw, 
          list(flagop.flagchannels)))
    temp.sort()
    flagops = temp

except Exception, e:
    print 'hif_tsysflagedges html template exception:', e
    raise e
%>
 
% if plot_groups:
<h2>Plots</h2>
<ul>
    % for plot_group in plot_groups:
        % if 'Tsys vs Channel' in plot_group.title:
            <li><a href=${plot_group.filename}>${plot_group.title}</a>
            shows the Tsys spectra flagged in each image.</li>
        % endif
    % endfor
</ul>
% endif

% if flagops:
<h2>Flags</h2>
<table border="1">
    <tr>
        <td>File</td>
        <td>SpW</td>
        <td>Channels</td>
    </tr>
    % for flagop in flagops:
        <tr>
        <td>${flagop[0]}</td> <td>${flagop[1]}</td> <td>${flagop[2]}</td>
        </tr>
    % endfor
</table>
% endif
