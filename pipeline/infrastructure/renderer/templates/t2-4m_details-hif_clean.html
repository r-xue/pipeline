<%!
rsc_path = "../"
import os.path
import pydoc
import sys

import pipeline.infrastructure as infrastructure
import pipeline.infrastructure.displays as displays
import pipeline.infrastructure.renderer.logger as logger
import pipeline.infrastructure.renderer.htmlrenderer as hr

LOG = infrastructure.get_logger(__name__)
%>
<%inherit file="t2-4m_details-base.html"/>

<%block name="header" />

<%block name="title">Stage ${hr.get_stage_number(result)} Task Details</%block>

<h1>Stage ${hr.get_stage_number(result)}: ${hr.get_task_description(result)}</h1>

<%
try:
    stage_dir = os.path.join(pcontext.report_dir, 'stage%d' % (
      result[0].stage_number))
    plots_dir = stage_dir
    if (not os.path.exists(plots_dir)):
        os.mkdir(plots_dir)

    plots = []
    for r in result:
        if r.empty():
            continue

        LOG.info('Plotting')
        # psf and flux maps
        plots.append(displays.SkyDisplay().plot(pcontext, r.psf,
          reportdir=plots_dir))
        plots.append(displays.SkyDisplay().plot(pcontext, r.flux,
          reportdir=plots_dir))

        # image iterations
        iterations = r.iterations.keys()
        iterations.sort()
        for iter in iterations:
            # image for this iteration
            plots.append(displays.SkyDisplay().plot(pcontext,
              r.iterations[iter]['image'], reportdir=plots_dir))

            plots.append(displays.SkyDisplay().plot(pcontext,
              r.iterations[iter]['residual'], reportdir=plots_dir))

            if iter > 0:
                plots.append(displays.SkyDisplay().plot(pcontext,
                  r.iterations[iter]['cleanmask'], reportdir=plots_dir))

    # Group the Plots by axes and plot types; each logical grouping will
    # be contained in a PlotGroup
    plot_groups = logger.PlotGroup.create_plot_groups(plots)
    # Write the thumbnail pages for each plot grouping to disk
    for plot_group in plot_groups:
        renderer = hr.PlotGroupRenderer(pcontext, result[0], plot_group)
        plot_group.filename = renderer.filename
        with renderer.get_file() as fileobj:
            fileobj.write(renderer.render())

except Exception, e:
    print 'hif_clean html template exception:', e
%>

% if plot_groups:
<h2>Plots</h2>
<ul>
% for plot_group in plot_groups:
	<li><a href=${plot_group.filename}>${plot_group.title}</a></li>
% endfor
</ul>
%endif
