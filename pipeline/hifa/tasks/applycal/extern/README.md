######################## applycalQA ##########################
# Test Prototype QA scores for ALMA Interferometric Pipeline #
# version for ticket PIPE-1770                               #
##############################################################

#### Set-up: ####
applycalQA_pipe.py runs on python 3.6 and CASA 6, additionally, it makes use of libraries numpy v.1.18.4,
scipy v.1.4.1 and matplotlib v.3.2.1. If this requirements are not met, you can create a clean
virtual environment, as explained below, to assure that these dependencies are met and there are no conflicts
with other things installed in the current CASA+Python installation.

1) To install the package itself, download the main applycalQA package using the "Code" button and clicking
"Download ZIP" (~200Kb).

Alternatively, you can make a copy of the entire GIT repository (1.7Gb):

`git clone https://github.com/haroldfrancke/applycalQA.git`

2) Then, edit your PYTHONPATH and PATH environment variables to contain the folder where the applycalQA
package is.

3) In order to be able to avoid giving lengthy, full paths to the datasets, edit the following
variables hardcoded inside the "applycalQA_pipe.py" script:

def_input_path = "/mnt/NOF/QAscoresMOUSs"
def_output_path = "/mnt/NOF/QAscoresMOUSs/QAscoresResults"

The first variable, "def_input_path" defines the folder where the script will look for pipeline
execution folder. The second variable, "def_output_path" defines the default output folder. For
a given execution of the script, these folder can be overriden by the command line options (see below).

4) In order to be able to call the script directly, without explicitly calling python (this is optional),
one can edit the first line (shebang) of "applycalQA_pipe.py":

`#!/users/hfrancke/casa6/bin/python3`

and put the correct path to the python version that will be used. (you can do "which python" in the command
line to see the path to the active python installation).


#### To install in a virtual environment ####

To install dependencies, first create a virtual environment casa6:

`python3.6 -m venv casa6`

Activate it (you'll need to activate it for each new terminal window):

`source casa6/bin/activate`

And install CASA 6 standalone (only the first time):

`pip install --upgrade pip`

`pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatools`

`pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casatasks`

`pip install --index-url https://casa-pip.nrao.edu/repository/pypi-casa-release/simple casadata`

#### Usage: ####
To run applycalQA_pipe.py:

`python /path_to_applycalQA/applycalQA_pipe.py input_path -o output_path -p parameters -m memory_limit`

If the shebang (first line path reference to environment) inside applycalQA_pipe.py gets edited to point to the
python3 installation to be used, the file applycalQA_pipe.py is included in the PATH and is executable, then
the command line can be simplified to:

`applycalQA_pipe.py input_path -o output_path -p parameters -m memory_limit`

Where: 

- *input_path*: path to folder where .ms files are stored.
- *output_path*: path to folder where results will go. 
- *params*: list of parameters or textfile containing the. This is an optional parameter. (currently disabled)
- *memory_limit*: maximum allowed memory usage, in gigabytes. Default is 8.0

#### Script Output ####

The standard output of the script has the following set of files, written in a subfolder
created on "output_path" folder named after the input_path:

1) A subfolder named "databuffer", which has a number of files with the following name convention:
   - uid___A002_XNNN_XNNN.ms_spwsetup.v30.pkl
   - buf.uid___A002_XNNN_XNNN.ms.<scannumber>.<spw>.<field>.v31.pkl
   for every EB, calibrator scan number, science spw and calibrator field. These files contain
   buffers for speeding up the data reading for new executions of the script on the same data.

2) A set of pickle and text files containing the the final Pipeline's QAScore objects for every EB.
   - uid___A002_XNNN_XNNN.ms.<timestamp_script_execution>.final_scores.pipe.pickle
   - uid___A002_XNNN_XNNN.ms.<timestamp_script_execution>.final_scores.pipe.txt

3) A file mimicking pipeline's "PIPE356_outliers.txt" file:
   PIPE356_outliers.pipe.<timestamp_script_execution>.txt

4) A pickle file containing the dump of the QAScoreEvalFunc object used for numerically evaluating
the final QA scores generated by the script:
uid___A002_XNNN_XNNN.ms.<timestamp_script_execution>.qascoref.pipe.pickle