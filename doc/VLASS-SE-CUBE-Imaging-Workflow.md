VLASS-SE-CUBE imaging workflow
------------------------------

This documentation describes the VLASS [Coarse Cube Imaging Pipeline](https://open-confluence.nrao.edu/pages/viewpage.action?pageId=63897714) (CCIP) workflow.

In general, the CCIP workflow uses similar imaging heuristics as the VLASS-SE-CONT workflow, with two major differences:

1. The CCIP workflow skips several selfcal/masking-related stages in VLASS-SE-CONT, and replaces them with a single equivalent `hifv_restorepims()` stage that utilizes the products from VLASS-SE-CONT (e.g. reimaging_esource.tgz and tier1/tier2 masks).
   `hifv_restorepims()` restores the `flag`, `corrected`, and `weight` columns in a PIMS to the same state of the final imaging-ready MS in the VLASS-SE-CONT production run.
   
2. The imaging operation will go through individual specified SPW groups and generate/analyze/export full-Stokes images, using slightly less expensive algorithms (mosaic gridder, nterm=1). However, the per-iteration imaging masks and sequence of each spw group are the same as that used in the final imaging stage (`vlass_stage=3`) of VLASS-SE-CONT. 


## Task Changes

### hifv_restorepims

The task will perform the following operations:

 * Fill the model column in a PIMS using the selfcal model image from VLASS-SE-CONT

 * Restore flags from `${FSID}_split_split.ms.flagversions/statwt_1`

 * Re-run `statwt` using the same settings from the VLASS-SE-CONT production run

 * Reapply selfcal table

The task will try to extract ancillary files (e.g. selfcal table/model_image and flag backup table) required for the above operations from  `reimagig_resources.tgz` generated by VLASS-SE-CONT.
It will also extract/verify mask files needed for the VLASS-SE-CUBE imaging sequence.
If any required resource is missing, Pipeline will throw an exception and exit from the workflow.
In that case, the weblog of `hifv_restorepims` will still render and the exception message from the weblog can help identify the missing file(s).

### hif_editimlist

`hif_editimlist` will be executed twice in the VLASS Coarse Cube workflow.
At Stage 2, it will use `SEIP_parameter.list` from VLASS-SE-CONT to re-create the single-epoch continuum imaging heuristics/context for `hif_restorepims`.
At Stage 6, it will use `CCIP_parameter.list` to create the cube imaging target list used by `hif_makeimages` (one target per spectral plane). This is done with `editmode='replace'`, so the target list from stage2 will be reset.

For the "cube" mode of hif_editimlist, i.e. imaging_mode='VLASS-SE-CUBE' in the task input at Stage 6:

 * The `spw` parameter is expected to be a list of spw so that spws or spwgroups can be used for making cubes e.g., 
   * `spw=['2','3','4','5',...,'17']` 
   * `spw=['2,3,4','5,6,7']`
   Plese note that a channel-wise selection (e.g. `spw=['2:0~15','2:16~31']`) and a range-syntax selection (e.g. `spw=['1~4','5~7']` are not allowed.

 * the `reffreq` parameter for `tclean` will be expiciltly set to the mean frequency of  each spw/spwgroup.
 * If the spw-selected data is flagged above a percentage threshold (currently, hardcoded to 100%, i.e., completely flagged ), then that spw/spwgroup will not be added to the imaging target list, and a warning will be issued on the weblog.
 * The weblog is improved to show imagename/mask/spw/frereq of each imaging target in separate rows.
 

### hif_makeimages

### hif_makermsimages

### hif_makecutoutimages

### hifv_analyzestokescubes

### hifv_exportvlassdata


## Workflow Summary


